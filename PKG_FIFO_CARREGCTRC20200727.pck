CREATE OR REPLACE PACKAGE PKG_FIFO_CARREGCTRC IS
/***************************************************************************************************
 * ROTINA           :
 * PROGRAMA         :
 * ANALISTA         :
 * ATUALIZA         :
 * PARTICULARIDADES :                                           
 * DESENVOLVEDOR    :
 * DATA DE CRIACAO  : 
 * EXECUTADO POR    :  TYPE T_CURSOR IS REF CURSOR;  
 * ALIMENTA         :
 * FUNCINALIDADE    :
 * PARAM. OBRIGAT.  :
 *                                                                                                  *
 ****************************************************************************************************/

  type tpCurosr is REF CURSOR;
  BcoTDXAtivo   char(1) := 'N';

  STATUS_NORMAL         CONSTANT CHAR(1)      := 'N';
  STATUS_ERRO           CONSTANT CHAR(1)      := 'E';
  

  TpVCarreta    Constant char(3) := '1  ';
  TpVTruck      Constant char(3) := '3  ';
  TpToco        Constant char(3) := '4  ';
  TpFiorino     Constant char(3) := '5  ';
  TpV3_4        Constant char(3) := '7  ';
  TpVan         Constant char(3) := '8  ';
  TpVFracionado Constant char(3) := '9  ';
  TpVUtilitario Constant char(3) := '22 ';
  TpVUC         Constant char(3) := '30 ';
  TpCarretaLS   Constant char(3) := '13 ';
  

  QualquerContrato CONSTANT char(15) := '999999999999999';                                                                                         
  QualquerGrupo    CONSTANT char(4)  := '9999';
  QualquerCliente  CONSTANT char(20) := '99999999999999';

  SemTabelaCodigo  CONSTANT char(8)  := '00000000';  
  SemTabelaSaque   CONSTANT char(4)  := '0000';
  
  ProdutoQuimicoAguardRetorno CONSTANT char(2)  := '00'; 
  ProdutoNaoQuimico           CONSTANT char(2)  := '02'; 
  ProdutoQuimicoNPerigoso   CONSTANT char(2)  := '03'; 
  ProdutoQuimicoPerigoso      CONSTANT char(2)  := '04'; 
  
  Domingo constant integer := 1; 
  Segunda constant integer := 2;
  Terca   constant integer := 3;
  Quarta  constant integer := 4;
  Quinta  constant integer := 5;
  Sexta   constant integer := 6;
  Sabado  constant integer := 7;

 tpPercurso   tdvadm.t_Slf_Percurso%rowtype; 
 tpLogGeracao tdvadm.t_Con_Loggeracao%rowtype;
  

  Type TpSIMcabecalho is RECORD(titulo           varchar2(100),
                                codigoOrigem     varchar2(100),
                                descricaoOrigem  varchar2(100),
                                codigoDestino    varchar2(100),
                                descricaoDestino varchar2(100),
                                km               varchar2(100),
                                peso             varchar2(100));

  Type TpSIMsimulado is RECORD(titulo         varchar2(100),
                               kmDe           varchar2(100),
                               kmAte          varchar2(100),
                               pesoDe         varchar2(100),
                               pesoAte        varchar2(100),
                               tabTdv         varchar2(100),
                               saqTdv         varchar2(100),
                               tipo           varchar2(100),
                               veiculo        varchar2(100),
                               tipoCarga      varchar2(100),
                               valor          varchar2(100),
                               Desinencia     varchar2(100),
                               limite         varchar2(100),
                               valorExcedente varchar2(100),
                               valorFixo      varchar2(100),
                               valorCalculado varchar2(100),
                               codigoCliente  varchar2(100),
                               perctEx        varchar2(100),
                               perctQM        varchar2(100),
                               perctOutb      varchar2(100),
                               perctTrans     varchar2(100),
                               soTransf       varchar2(100));                     

Type tListaSIMcabecalho is Table Of TpSIMcabecalho Index By Binary_Integer; 
Type tListaSIMsimulado  is Table Of TpSIMsimulado  Index By Binary_Integer; 


 Type TpColetaEntrega Is RECORD(OrigemCodigo    tdvadm.t_glb_localidade.glb_localidade_codigo%type,
                                OrigemDescricao tdvadm.t_glb_localidade.glb_localidade_descricao%type,         
                                ColLocCodigo    tdvadm.t_glb_localidade.glb_localidade_codigo%type,
                                ColLocDescri    tdvadm.t_glb_localidade.glb_localidade_descricao%type,
                                ColIBGECodigo   v_glb_ibge.codmun%type,
                                ColIBGEDescri   varchar2(70),
                                ColCIDescri     varchar2(10),
                                ColMESOCodigo   v_glb_ibge.mesocod%type,
                                ColMESODescri   v_glb_ibge.mesonomex%type,
                                ColMICROCodigo  v_glb_ibge.microcod%type,
                                ColMICRODescri  v_glb_ibge.micronomex%type,
                                ColREGCodigo    v_glb_ibge.regcod%type,
                                ColREGDescri    varchar2(70),
                                ColREGVCodigo   v_glb_ibge.regcod%type,
                                ColREGVDescri   varchar2(70),
                                
                                DestinoCodigo    tdvadm.t_glb_localidade.glb_localidade_codigo%type,
                                DestinoDescricao tdvadm.t_glb_localidade.glb_localidade_descricao%type,
                                EntLocCodigo     tdvadm.t_glb_localidade.glb_localidade_codigo%type,
                                EntLocDescri     tdvadm.t_glb_localidade.glb_localidade_descricao%type,
                                EntIBGECodigo    v_glb_ibge.codmun%type,
                                EntIBGEDescri    varchar2(70),
                                EntCIDescri      varchar2(10),
                                EntMESOCodigo    v_glb_ibge.mesocod%type,
                                EntMESODescri    v_glb_ibge.mesonomex%type,
                                EntMICROCodigo   v_glb_ibge.microcod%type,
                                EntMICRODescri   v_glb_ibge.micronomex%type,
                                EntREGCodigo     v_glb_ibge.regcod%type,
                                EntREGDescri     varchar2(70),
                                EntREGVCodigo    v_glb_ibge.regcod%type,
                                EntREGVDescri    varchar2(70));


   
  Type TpParamBuscaVerba is RECORD (vLOCALIDADEORIGEM   TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_ORIGEM%TYPE,
                                    vLOCALIDADEDESTINO  TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_DESTINO%TYPE,
                                    vLOCALIDADEOUTRACOL TDVADM.T_SLF_CALCFRETEKM.SLF_CALCFRETEKM_OUTRACOLETAI%TYPE,
                                    vLOCALIDADEOUTRAENT TDVADM.T_SLF_CALCFRETEKM.SLF_CALCFRETEKM_OUTRAENTREGAI%TYPE,
                                    vTIPOFRETE          TDVADM.T_SLF_TABELA.SLF_TABELA_TIPO%TYPE, -- PAGO(CIF) OU A PAGAR (FOB/FOC)
                                    vTPCARGA            TDVADM.T_SLF_TABELA.FCF_TPCARGA_CODIGO%TYPE DEFAULT NULL,
                                    vRATEIA             TDVADM.v_slf_clientecargas2.SLF_CLIENTECARGAS_RATEIA%TYPE,
                                    vPESOMINIMO         TDVADM.v_slf_clientecargas2.SLF_CLIENTECARGAS_PMINIMO%TYPE,
                                    vCLIENTE            TDVADM.T_SLF_TABELA.GLB_CLIENTE_CGCCPFCODIGO%TYPE DEFAULT QualquerCliente,
                                    vGRUPO              TDVADM.T_SLF_TABELA.GLB_GRUPOECONOMICO_CODIGO%TYPE DEFAULT QualquerGrupo,
                                    vCONTRATO           TDVADM.T_SLF_TABELA.SLF_TABELA_CONTRATO%TYPE,
                                    vTPVEICULO          TDVADM.T_SLF_TABELA.FCF_TPVEICULO_CODIGO%TYPE DEFAULT '9',
                                    vKM                 NUMBER,
                                    vPESO               NUMBER,
                                    vPESOTOTAL          NUMBER,
                                    vVlrMerc            NUMBER,
                                    vVlrMercTOTAL       number,                                     
                                    vEntCol             tdvadm.t_slf_tabela.SLF_TABELA_COLETAENTREGA%type,
                                    vOrigem             varchar2(100),
                                    vPesqFRETECOLETA    char(1) := 'F');

  
  Type TpBuscaVerba is RECORD (SLF_TABELA_CODIGO             tdvadm.t_slf_calcfretekm.SLF_TABELA_CODIGO%type,
                               SLF_TABELA_SAQUE              tdvadm.t_slf_calcfretekm.SLF_TABELA_SAQUE%type,
                               SLF_CALCFRETEKM_KMDE          tdvadm.t_slf_calcfretekm.SLF_CALCFRETEKM_KMDE%type,
                               SLF_CALCFRETEKM_KMATE         tdvadm.t_slf_calcfretekm.SLF_CALCFRETEKM_KMATE%type,
                               SLF_CALCFRETEKM_PESODE        tdvadm.t_slf_calcfretekm.SLF_CALCFRETEKM_PESODE%type,
                               SLF_CALCFRETEKM_PESOATE       tdvadm.t_slf_calcfretekm.SLF_CALCFRETEKM_PESOATE%type,
                               SLF_TPCALCULO_CODIGO          tdvadm.t_slf_calcfretekm.SLF_TPCALCULO_CODIGO%type,
                               SLF_RECCUST_CODIGO            tdvadm.t_slf_calcfretekm.SLF_RECCUST_CODIGO%type,
                               SLF_CALCFRETEKM_VALOR         tdvadm.t_slf_calcfretekm.SLF_CALCFRETEKM_VALOR%type,
                               SLF_CALCFRETEKM_DESINENCIA    tdvadm.t_slf_calcfretekm.SLF_CALCFRETEKM_DESINENCIA%type,
                               SLF_CALCFRETEKM_CODCLI        tdvadm.t_slf_calcfretekm.SLF_CALCFRETEKM_CODCLI%type,
                               SLF_CALCFRETEKM_TPFRETE       tdvadm.v_slf_clientecargas2.slf_tpfrete_codigo%type,
                               SLF_CALCFRETEKM_ORIGEM        tdvadm.t_slf_calcfretekm.SLF_CALCFRETEKM_ORIGEM%type,
                               SLF_CALCFRETEKM_DESTINO       tdvadm.t_slf_calcfretekm.SLF_CALCFRETEKM_DESTINO%type,
                               SLF_CALCFRETEKM_ORIGEMI       tdvadm.t_slf_calcfretekm.SLF_CALCFRETEKM_ORIGEMI%type,
                               SLF_CALCFRETEKM_DESTINOI      tdvadm.t_slf_calcfretekm.SLF_CALCFRETEKM_DESTINOI%type,
                               SLF_CALCFRETEKM_LIMITE        tdvadm.t_slf_calcfretekm.SLF_CALCFRETEKM_LIMITE%type,
                               SLF_CALCFRETEKM_VALORE        tdvadm.t_slf_calcfretekm.SLF_CALCFRETEKM_VALORE%type,
                               SLF_CALCFRETEKM_DESINENCIAE   tdvadm.t_slf_calcfretekm.SLF_CALCFRETEKM_DESINENCIAE%type,
                               SLF_CALCFRETEKM_VALORF        tdvadm.t_slf_calcfretekm.SLF_CALCFRETEKM_VALORF%type,
                               SLF_CALCFRETEKM_DESINENCIAF   tdvadm.t_slf_calcfretekm.SLF_CALCFRETEKM_DESINENCIAF%type,
                               SLF_CALCFRETEKM_RAIOKMORIGEM  tdvadm.t_slf_calcfretekm.slf_calcfretekm_raiokmorigem%type,
                               SLF_CALCFRETEKM_RAIOKMDESTINO tdvadm.t_slf_calcfretekm.slf_calcfretekm_raiokmdestino%type,
                               SLF_CALCFRETEKM_IMPEMBUTIDO   tdvadm.t_slf_calcfretekm.slf_calcfretekm_impembutido%type, 
                               SLF_CALCFRETEKM_OUTRACOLETAI  tdvadm.t_slf_calcfretekm.slf_calcfretekm_outracoletai%type,
                               SLF_CALCFRETEKM_OUTRAENTREGAI tdvadm.t_slf_calcfretekm.slf_calcfretekm_outraentregai%type,
                               SLF_CALCFRETEKM_dtgravacao  tdvadm.t_slf_calcfretekm.slf_calcfretekm_dtgravacao%type,
                               GLB_MERCADORIA_CODIGO         tdvadm.t_slf_tabela.GLB_MERCADORIA_CODIGO%type,
                               SLF_TABELA_COLETAENTREGA      tdvadm.t_slf_tabela.SLF_TABELA_COLETAENTREGA%type,
                               SLF_TABELA_TIPO               tdvadm.t_slf_tabela.slf_tabela_tipo%type,
                               FCF_TPVEICULO_CODIGO          tdvadm.t_slf_tabela.fcf_tpveiculo_codigo%type,
                               FCF_TPCARGA_CODIGO            tdvadm.t_slf_tabela.fcf_tpcarga_codigo%type,
                               GLB_CLIENTE_CGCCPFCODIGO      tdvadm.t_slf_tabela.GLB_CLIENTE_CGCCPFCODIGO%TYPE,
                               GLB_GRUPOECONOMICO_CODIGO     tdvadm.t_slf_tabela.GLB_GRUPOECONOMICO_CODIGO%TYPE,
                               SLF_TABELA_CONTRATO           tdvadm.t_slf_tabela.SLF_TABELA_CONTRATO%TYPE,
                               vPESOCOBRADO                  number,
                               vFATORRATEIO                  number,
                               vRetorno                      varchar2(4),
                               vRowId                        rowid);


  Type TpCobraColeta is RECORD(pTpCobranca   tdvadm.v_slf_clientecargas2.SLF_CLIENTECARGAS_FORCOBCOLETA%type,
                               pNota         tdvadm.t_arm_nota.arm_nota_numero%type,
                               pRemetente    tdvadm.t_arm_nota.glb_cliente_cgccpfremetente%type,
                               pSerie        tdvadm.t_arm_nota.arm_nota_serie%type,
                               pSequencia    tdvadm.t_arm_nota.arm_nota_sequencia%type,
                               pColeta       tdvadm.t_arm_nota.arm_coleta_ncompra%type,
                               pCiclo        tdvadm.t_arm_nota.arm_coleta_ciclo%type,
                               pCteCod       tdvadm.t_arm_nota.con_conhecimento_codigo%type,
                               pCteRT        tdvadm.t_arm_nota.glb_rota_codigo%type,
                               pCteSr        tdvadm.t_arm_nota.con_conhecimento_serie%type,
                               pBuscaFrete   TpParamBuscaVerba,
                               pRetFrete     TpBuscaVerba,
                               pValor        number,
                               pPesoReal     number,
                               pPesoCobrado  number,
                               pValorMerc    number,
                               pValorMercSeg number);

 Type TpAgrupaCli is RECORD (acContrato          char(1),
                             acSacado            char(1),
                             acRemetente         char(1),
                             acDestinatario      char(1),
                             acTpEndRemetente    char(1),
                             acTpEndDestino      char(1),
                             acLocalidadeColeta  char(1),
                             acLocalidadeEntrega char(1),
                             acIBGEColeta        char(1),
                             acIBGEEntrega       char(1),
                             acColetaEntrega     char(1),
                             acTPCarga           char(1),
                             acNrColeta          char(1),
                             acNrNota            char(1),
                             acQuimico           char(1),
                             acExpresso          char(1));

 Type TpCargaCli is RECORD (ccTPCARGACLI        tdvadm.v_slf_clientecargas2.fcf_tpcarga_codigo%type, 
                            ccTPCARGACLIDESC    tdvadm.t_fcf_tpcarga.fcf_tpcargadescricao%type, 
                            ccTPCARGACLIPESQ    tdvadm.v_slf_clientecargas2.fcf_tpcarga_codigopesq%type,
                            ccTPCARGAAGRUPACTRC tdvadm.v_slf_clientecargas2.slf_clientecargas_agctrc%type,
                            ccTPCARGAQTDEAGCTRC tdvadm.v_slf_clientecargas2.slf_clientecargas_qtdectrc%type,
                            ccTPCARGAAGRUPANF   tdvadm.v_slf_clientecargas2.slf_clientecargas_agnf%type,
                            ccTPCARGAQTDEAGNF   tdvadm.v_slf_clientecargas2.slf_clientecargas_qtdenf%type,
                            ccPCOBRANCA         tdvadm.v_slf_clientecargas2.SLF_CLIENTEREGRAS_PCOBRANCA%type,
                            ccBASEOCUPACAO      tdvadm.v_slf_clientecargas2.slf_clienteREGRAS_baseocupacao%type,
                            ccVALORBASE         tdvadm.v_slf_clientecargas2.slf_clienteREGRAS_valorbase%type,
                            ccPESOMINIMO        tdvadm.v_slf_clientecargas2.slf_clientecargas_pminimo%type,
                            ccPROCEDURE         tdvadm.v_slf_clientecargas2.slf_clientecargas_procedure%type,
                            ccRATEIA            char(1), --tdvadm.v_slf_clientecargas2.slf_clientecargas_rateia%type,
                            ccTPRATEIO          tdvadm.v_slf_clientecargas2.slf_tprateio_codigo%type,
                            ccTPAGRUPA          tdvadm.v_slf_clientecargas2.slf_tpagrupa_codigo%type,
                            ccTPCARGAQPCOLCTRC  tdvadm.v_slf_clientecargas2.slf_clientecargas_qpcolctrc%type,
                            ccTPCARGAQPCOLNF    tdvadm.v_slf_clientecargas2.slf_clientecargas_qpcolnf%type,
                            ccPRIOREXQM         tdvadm.v_slf_clientecargas2.slf_clientecargas_priorexqm%type,
                            ccPERCTEX           tdvadm.v_slf_clientecargas2.slf_clientecargas_percntex%type,
                            ccPERCTQM           tdvadm.v_slf_clientecargas2.slf_clientecargas_percntqm%type,
                            ccPERCTOUT          tdvadm.v_slf_clientecargas2.slf_clientecargas_percntout%type,
                            ccPERCTRA           tdvadm.v_slf_clientecargas2.slf_clientecargas_percnttra%type,
                            ccPERCTREDUTOR      tdvadm.v_slf_clientecargas2.slf_clientecargas_redutor%type,
                            ccFORMULAFRTX       tdvadm.v_slf_clientecargas2.slf_clientecargas_formulafrtx%type,
                            ccFORMULAFRVL       tdvadm.v_slf_clientecargas2.slf_clientecargas_formulafrtvl%type,
                            ccFORMULAFRKM       tdvadm.v_slf_clientecargas2.slf_clientecargas_formulafrtkm%type,
                            ccFORMULAPDTX       tdvadm.v_slf_clientecargas2.slf_clientecargas_formulapdtx%type,
                            ccFORMULAPDVL       tdvadm.v_slf_clientecargas2.slf_clientecargas_formulapdvl%type,
                            ccTPFRETE           tdvadm.v_slf_clientecargas2.slf_tpfrete_codigo%type,
                            ccORIGEMFIXA        tdvadm.v_slf_clientecargas2.slf_clientecargas_fixaorigem%type,
                            ccDESTINOFIXO       tdvadm.v_slf_clientecargas2.slf_clientecargas_fixadestino%type,
                            ccEXIGEFORMQM       tdvadm.v_slf_clientecargas2.slf_clientecargas_formularioqm%type,
                            ccEXIGEFORMEX       tdvadm.v_slf_clientecargas2.slf_clientecargas_formularioex%type,
                            ccSOTRANSF          tdvadm.v_slf_clientecargas2.slf_clientecargas_sotransf%type,
                            ccTABKM             tdvadm.v_slf_clientecargas2.slf_clienteREGRAS_tabkm%type,
                            ccTPCARGA           tdvadm.t_fcf_tpcarga.fcf_tpcarga_codigo%type,
                            ccTPCARGADESC       tdvadm.t_slf_tpfrete.slf_tpfrete_descricao%type,
                            ccTPCODORIGEM       tdvadm.t_slf_tpfrete.slf_tpfrete_tpcodorigem%type,
                            ccTPCODDESTINO      tdvadm.t_slf_tpfrete.slf_tpfrete_tpcoddestino%type,
                            ccTPCODOCOUTRACOL   tdvadm.t_slf_tpfrete.slf_tpfrete_tpcodocoutracol%type,
                            ccTPCODOCOUTRAENTR  tdvadm.t_slf_tpfrete.slf_tpfrete_tpcodocoutraentr%type,
                            ccUSAFAIXAKM        tdvadm.v_slf_clientecargas2.slf_clientecargas_usafaixakm%type,
                            ccUSAFAIXAPS        tdvadm.v_slf_clientecargas2.slf_clientecargas_usafaixapeso%type,
                            ccUSAFAIXAVG        tdvadm.v_slf_clientecargas2.slf_clientecargas_usafaixavg%type,
                            ccUSAVEICULO        tdvadm.v_slf_clientecargas2.slf_clientecargas_usaveiculo%type,
                            ccPESQVEICULO        tdvadm.v_slf_clientecargas2.slf_clientecargas_pesqveiculo%type,
                            ccTPFRETEOBS        tdvadm.t_slf_tpfrete.slf_tpfrete_obs%type,
                            ccKMMinimo          tdvadm.v_slf_clientecargas2.SLF_CLIENTECARGAS_KMMINIMO%type,
                            ccColetaCobraTmp    tdvadm.v_slf_clientecargas2.SLF_CLIENTECARGAS_COBRACOLETA%type,
                            ccColetaCobra       tdvadm.v_slf_clientecargas2.SLF_CLIENTECARGAS_COBRACOLETA%type,
                            ccColetaTpCobranca  tdvadm.v_slf_clientecargas2.SLF_CLIENTECARGAS_FORCOBCOLETA%type,
                            ccTPFRETECOL        tdvadm.v_slf_clientecargas2.SLF_TPFRETE_CODIGOCOL%type,
                            ccTPCARGACLICOL     tdvadm.v_slf_clientecargas2.FCF_TPCARGA_CODIGOCOL%type,

                            ccFORMULACOLTX       tdvadm.v_slf_clientecargas2.slf_clientecargas_formulacoltx%type,
                            ccFORMULACOLVL       tdvadm.v_slf_clientecargas2.slf_clientecargas_formulacolvl%type,
                            ccFORMULACOLKM       tdvadm.v_slf_clientecargas2.slf_clientecargas_formulacolkm%type,

                            ccTPCARGADESCCOL    tdvadm.t_slf_tpfrete.slf_tpfrete_descricao%type,
                            ccTPCODORIGEMCOL    tdvadm.t_slf_tpfrete.slf_tpfrete_tpcodorigem%type,
                            ccTPCODDESTINOCOL   tdvadm.t_slf_tpfrete.slf_tpfrete_tpcoddestino%type,
                            ccUSAFAIXAKMCOL     tdvadm.v_slf_clientecargas2.slf_clientecargas_usafaixakmc%type,
                            ccUSAFAIXAPSCOL     tdvadm.v_slf_clientecargas2.slf_clientecargas_usafaixapsoc%type,
                            ccUSAFAIXAVGCOL     tdvadm.v_slf_clientecargas2.slf_clientecargas_usafaixavgc%type,
                            ccUSAVEICULOCOL     tdvadm.v_slf_clientecargas2.slf_clientecargas_usaveiculoc%type,
                            ccPESQVEICULOCOL    tdvadm.v_slf_clientecargas2.slf_clientecargas_pesqveiculoc%type,

                            ccAgrpPorColeta     tdvadm.v_slf_clientecargas2.SLF_CLIENTECARGAS_AGRPORCOLETA%type,
                            ccLimiteCTe         tdvadm.v_slf_clientecargas2.SLF_CLIENTECARGAS_LIMITECTE%type,
                            ccLimiteNFSe        tdvadm.v_slf_clientecargas2.SLF_CLIENTECARGAS_LIMITENFSE%type,
                            ccCteColeta         tdvadm.v_slf_clientecargas2.SLF_CLIENTECARGAS_CTEDECOLETA%type,
                            ccCteGlobalizado    tdvadm.v_slf_clientecargas2.slf_clienteREGRAS_globalizado%type,
                            ccLimitePesagem     tdvadm.v_slf_clientecargas2.slf_clientecargas_pesagemmax%type,
                            ccMudaOrigemCC      tdvadm.v_slf_clientecargas2.slf_clientecargas_mudaorigemcc%type,
                            ccParaSemPCC        tdvadm.v_slf_clientecargas2.slf_clientecargas_ParaSemPCC%type,
                            ccPagaValePedagio   tdvadm.v_slf_clientecargas2.slf_clienteREGRAS_valeped%type);



Type TlistaCargaCli  is Table Of TpCargaCli  Index By Binary_Integer; 




 Type TpJunta is RECORD (rCarregamento     tdvadm.t_arm_carregamento.ARM_CARREGAMENTO_CODIGO%type,
                         rMemoCalc         tdvadm.t_arm_carregamento.ARM_CARREGAMEMCALC_CODIGO%type,
                         rConhecimento     tdvadm.t_con_conhecimento.CON_CONHECIMENTO_CODIGO%type,
                         rSerie            tdvadm.t_con_conhecimento.CON_CONHECIMENTO_SERIE%type,
                         rRota             tdvadm.t_con_conhecimento.GLB_ROTA_CODIGO%type,
                         rEmbalagemCodigo  tdvadm.t_arm_embalagem.ARM_EMBALAGEM_NUMERO%type,
                         rEmbalagemFlag    tdvadm.t_arm_embalagem.ARM_EMBALAGEM_FLAG%type,
                         rEmbalagemSeq     tdvadm.t_arm_embalagem.ARM_EMBALAGEM_SEQUENCIA%type,
                         rNota             tdvadm.t_arm_nota.ARM_NOTA_NUMERO%type,
                         rRemetente        tdvadm.t_arm_nota.ARM_CARGA_CODIGO%type,
                         rNotaSequencia    tdvadm.t_arm_nota.ARM_NOTA_SEQUENCIA%type,
                         rColeta           tdvadm.t_arm_coleta.arm_coleta_ncompra%type,
                         rColetaCiclo      tdvadm.t_arm_coleta.arm_coleta_ciclo%type,
                         rDtFechamento     tdvadm.t_arm_carregamento.ARM_CARREGAMENTO_DTFECHAMENTO%type,
                         rArmazem          tdvadm.t_arm_carregamento.ARM_ARMAZEM_CODIGO%type,
                         rUsuCriou         tdvadm.t_arm_carregamento.USU_USUARIO_CRIOUCARREG%type,
                         rUsuFechou        tdvadm.t_arm_carregamento.USU_USUARIO_FECHOUCARREG%type,
                         rMobile           tdvadm.t_arm_carregamento.ARM_CARREGAMENTO_MOBILE%type,
                         rDtCriacao        tdvadm.t_arm_carregamento.ARM_CARREGAMENTO_DTCRIA%type,
                         rUsuConferiu      tdvadm.t_arm_carregamento.USU_USUARIO_CONFERIUCARREG%type,
                         rDtConferencia    tdvadm.t_arm_carregamento.ARM_CARREGAMENTO_DTCONFERENCIA%type,
                         rSacado           tdvadm.t_con_conhecimento.GLB_CLIENTE_CGCCPFSACADO%type);



 Type TpRecalculo is RECORD (rConhecCodigo  tdvadm.t_con_conhecimento.con_conhecimento_codigo%type,
                             rConhecSerie   tdvadm.t_con_conhecimento.con_conhecimento_serie%type,
                             rConhecRota    tdvadm.t_con_conhecimento.glb_rota_codigo%type,
                             rCarregamento  tdvadm.t_arm_carregamento.arm_carregamento_codigo%type,
                             rDataColeta    date,
                             rContrato      tdvadm.t_slf_tabela.slf_tabela_contrato%type,
                             rNrColeta      tdvadm.t_arm_coleta.arm_coleta_ncompra%type,
                             rNrColetaCiclo tdvadm.t_arm_coleta.arm_coleta_ciclo%type,
                             rRemetente     tdvadm.t_glb_cliente.glb_cliente_cgccpfcodigo%type,
                             rTpEndRemet    tdvadm.t_glb_cliend.glb_tpcliend_codigo%type,
                             rGrupoRemet    tdvadm.t_glb_grupoeconomico.glb_grupoeconomico_codigo%type,
                             rColeta        tdvadm.t_glb_localidade.glb_localidade_codigo%type,
                             rColetai       tdvadm.t_glb_localidade.glb_localidade_codigoibge%type,
                             rColetaR       tdvadm.t_glb_estado.glb_estado_codigoibge%type,
                             rColetaRV      tdvadm.t_glb_estado.glb_estado_codigoibge%type,
                             rDestinatario  tdvadm.t_glb_cliente.glb_cliente_cgccpfcodigo%type,
                             rTpEndDest     tdvadm.t_glb_cliend.glb_tpcliend_codigo%type,
                             rGrupoDest    tdvadm.t_glb_grupoeconomico.glb_grupoeconomico_codigo%type,
                             rEntrega       tdvadm.t_glb_localidade.glb_localidade_codigo%type,
                             rEntregai      tdvadm.t_glb_localidade.glb_localidade_codigoibge%type,
                             rEntregaR      tdvadm.t_glb_estado.glb_estado_codigoibge%type,
                             rEntregaRV     tdvadm.t_glb_estado.glb_estado_codigoibge%type,
                             rSacado        tdvadm.t_glb_cliente.glb_cliente_cgccpfcodigo%type,
                             rTpEndSacado   tdvadm.t_glb_cliend.glb_tpcliend_codigo%type,
                             rGrupoSacado   tdvadm.t_glb_grupoeconomico.glb_grupoeconomico_codigo%type,
                             rKm            number,
                             rPesoMinimo    number,
                             rPeso          number,
                             rLotacao       number,
                             rFatorRateio   number,
                             rPesoFaixa     number,
                             rPesoCobrad    number,
                             rPesoCobradC   number,
                             rTipoFrete     char(3), -- CIF / FOB / FOC
                             rTpTabSol      char(1), -- (T)abela Ou (S)olicitacao
                             rTabSolCodigo  tdvadm.t_slf_tabela.slf_tabela_codigo%type,
                             rTabSolSaque   tdvadm.t_slf_tabela.slf_tabela_saque%type,
                             rVeiculo       varchar2(30),
                             rCarga         varchar2(30),
                             rTpVeiculo     tdvadm.t_fcf_tpveiculo.fcf_tpveiculo_codigo%type,
                             rTpCarga       tdvadm.t_fcf_tpcarga.fcf_tpcarga_codigo%type,
                             rTpCargaC      tdvadm.t_glb_tpcarga.glb_tpcarga_codigo%type,
                             rEntrColeta    tdvadm.t_arm_coleta.arm_coleta_entcoleta%type,
--                             rTpVeicXML     tdvadm.t_xml_coleta.xml_coleta_tipotransporte%type,
--                             rTpCargaXML    tdvadm.t_xml_coleta.xml_coleta_tipocarga%type,
                             rTpVeicXML     tdvadm.T_ARM_COLETAPART.arm_coletapart_veiculo%type,
                             rTpCargaXML    tdvadm.T_ARM_COLETAPART.arm_coletapart_tipocarga%type,
                             rRateia        char(1),
                             rTpRetorno     TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_TPFRETE%TYPE, -- LO - LOCALIDADE - ME - MESO REGIAO MI - MICRO REGIAO NE - NAO ENCONTRADO
                             rCodOriCob     TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_ORIGEM%TYPE,
                             rCodDesCob     TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_ORIGEM%TYPE,
                             rTabSolCodigoC tdvadm.t_slf_tabela.slf_tabela_codigo%type,
                             rTabSolSaqueC  tdvadm.t_slf_tabela.slf_tabela_saque%type,
                             rFreteEmpresa  TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_VALOR%TYPE,
                             rDesinenciaFr  TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_DESINENCIA%TYPE,
                             rTpcalculo     TDVADM.T_SLF_TABELA.SLF_TPCALCULO_CODIGO%TYPE,
                             rMercadoria    TDVADM.T_SLF_TABELA.GLB_MERCADORIA_CODIGO%TYPE,
                             rCodCli        TDVADM.T_con_calcconhecimento.con_calcconhecimento_cocli%type,
                             rChines        char(1),
                             rGrandeFluxo   char(1),
                             rPorto         char(1),
                             rMensagem      clob,
                             rFormularioQ   tdvadm.t_arm_notafichaemerg.arm_notafichaemerg_codcli%type,
                             rFormularioE   tdvadm.t_arm_coletaformexp.arm_coleta_nrformulario%Type ,
                             
                             rSacadoP        tdvadm.t_glb_cliente.glb_cliente_cgccpfcodigo%type,
                             rContratoP      tdvadm.t_slf_tabela.slf_tabela_contrato%type,
                             rGrupoSacadoP   tdvadm.t_glb_grupoeconomico.glb_grupoeconomico_codigo%type

                           
                            );

                     
 Type TpAuxiliar is RECORD (/**/cnCLIREMANT     TDVADM.T_GLB_CLIEND.GLB_CLIENTE_CGCCPFCODIGO%TYPE,
                            /**/cnCLIDESTANT    TDVADM.T_GLB_CLIEND.GLB_CLIENTE_CGCCPFCODIGO%TYPE,
                            /**/cnCLIENDDESTANT TDVADM.T_GLB_CLIEND.GLB_TPCLIEND_CODIGO%TYPE,
                            /**/cnNRCOLETAANT   TDVADM.T_ARM_COLETA.ARM_COLETA_NCOMPRA%TYPE,
                            /**/cnCODIGOORIANT       TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_ORIGEM%TYPE,
                            /**/cnKM                 TDVADM.T_SLF_PERCURSO.SLF_PERCURSO_KM%TYPE,
                                cnColetaPlaca        TDVADM.T_arm_coleta.arm_coleta_placa%type,
                                cnColetaKM           TDVADM.T_slf_percurso.slf_percurso_km%type,
                                cnColetaPesoPlaca    TDVADM.T_arm_coleta.arm_coleta_pesocobrado%type,
                                cnColetaPesonrColeta TDVADM.T_arm_coleta.arm_coleta_pesocobrado%type, 
                                cnColetaPeso         TDVADM.T_arm_coleta.arm_coleta_pesocobrado%type,
                                cnColetaValor        number,
                                cnColetaRemetente    TDVADM.T_arm_coleta.glb_cliente_cgccpfcodigocoleta%type,
                                cnColetaData         TDVADM.T_arm_coleta.arm_coleta_dtprogramacao%type,
                            /**/cnCODIGOORI          TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_ORIGEM%TYPE,
                            /**/cnCODIGODES          TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_DESTINO%TYPE,
                            /**/cnCODIGOREGO         TDVADM.T_GLB_REGIAO.GLB_REGIAO_CODIGO%TYPE,
                            /**/cnCODIGOREGD         TDVADM.T_GLB_REGIAO.GLB_REGIAO_CODIGO%TYPE,
                            /**/cnCODIGODESANT       TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_DESTINO%TYPE,
                                cnTABSOLCODANT       TDVADM.T_ARM_NOTA.ARM_NOTA_TABSOLCOD%TYPE,
                                cnPercentEx          NUMBER,
                                cnPercentQP          NUMBER,
                                cnSomaPesoQP         number,
                                cnContaQuimico       number,
                                cnContaTodaNotas     number,
                                cnContaNotas         number,
                                cnContaFornec        number,
                                cnContaDestinatario  number,
                                cnTemQuimico         char(1),
                                cnTemExpresso        char(1),
                                cnTemCD              char(1),
                                cnEGrandeFluxo       char(1),
                                cnNomeSacado         TDVADM.T_glb_cliente.glb_cliente_razaosocial%type,
                                cnArmazem            TDVADM.T_arm_armazem.arm_armazem_codigo%type,
                                cnArmazemRota        TDVADM.T_arm_armazem.glb_rota_codigo%type,
                                cnArmazemNome        TDVADM.T_arm_armazem.arm_armazem_descricao%type,
                                cnArmazemLoc         TDVADM.T_arm_armazem.glb_localidade_codigo%type,
                                cnRemetenteLoc       TDVADM.T_glb_cliend.glb_localidade_codigo%type,
                                cnCONTRATO           TDVADM.T_slf_contrato.slf_contrato_codigo%TYPE,
                                cnGRUPOEC            TDVADM.T_GLB_GRUPOECONOMICO.GLB_GRUPOECONOMICO_CODIGO%TYPE,
                                cnTpVeiculo          TDVADM.T_fcf_tpveiculo.fcf_tpveiculo_codigo%type,
                                cnLocalColetaTmp     tdvadm.t_glb_localidade.glb_localidade_codigo%type); 


 Type TpQuebras is RECORD ( CLISAC    TDVADM.T_ARM_NOTA.GLB_CLIENTE_CGCCPFSACADO%TYPE,
                            /**/CNPJREM   TDVADM.T_ARM_NOTA.GLB_CLIENTE_CGCCPFREMETENTE%TYPE,
                            /**/CLIENDREM TDVADM.T_ARM_NOTA.GLB_TPCLIEND_CODREMETENTE%TYPE,
                            /**/ORIGEMNOTA TDVADM.T_GLB_LOCALIDADE.GLB_LOCALIDADE_CODIGOIBGE%TYPE,
                            CNPJDES      TDVADM.T_ARM_NOTA.GLB_CLIENTE_CGCCPFDESTINATARIO%TYPE,
                            CLIENDDES    TDVADM.T_ARM_NOTA.GLB_TPCLIEND_CODDESTINATARIO%TYPE,
                            /**/DESTINONOTA TDVADM.T_GLB_LOCALIDADE.GLB_LOCALIDADE_CODIGOIBGE%TYPE,
                            /**/ENTCOL   TDVADM.T_ARM_COLETA.ARM_COLETA_ENTCOLETA%TYPE,
                            CONTRATO     TDVADM.T_slf_contrato.slf_contrato_codigo%TYPE,
                            CONTRATODESC TDVADM.T_slf_contrato.slf_contrato_descricao%type,
                            FLAGPGTO     TDVADM.T_ARM_NOTA.ARM_NOTA_FLAGPGTO%TYPE,
                            GRUPOEC      TDVADM.T_GLB_GRUPOECONOMICO.GLB_GRUPOECONOMICO_CODIGO%TYPE,
                            TPTABSOL     TDVADM.T_ARM_NOTA.ARM_NOTA_TABSOL%Type,
                            TABSOLCOD    TDVADM.T_ARM_NOTA.ARM_NOTA_TABSOLCOD%Type,
                            TABSOLSQ     TDVADM.T_ARM_NOTA.ARM_NOTA_TABSOLSQ%Type,
                            NRCOLETA     TDVADM.T_ARM_COLETA.ARM_COLETA_NCOMPRA%TYPE,
                            ccTPRATEIO   TDVADM.v_slf_clientecargas2.SLF_TPRATEIO_CODIGO%TYPE,                          
                            ccTPAGRUPA   TDVADM.v_slf_clientecargas2.SLF_TPAGRUPA_CODIGO%TYPE,   
                            ccNOTA       tdvadm.t_arm_nota.arm_nota_numero%Type,    
                            ccQuimico    char(1),
                            ccExpresso   char(1),                  
                            CONTAADOR INTEGER
                          );  


 Type TpNota is RECORD (
                        cnCLIDEST            TDVADM.T_GLB_CLIEND.GLB_CLIENTE_CGCCPFCODIGO%TYPE,
                        cnCLIENDDEST         TDVADM.T_GLB_CLIEND.GLB_TPCLIEND_CODIGO%TYPE,
                        cnCLISAC             TDVADM.T_GLB_CLIEND.GLB_CLIENTE_CGCCPFCODIGO%TYPE,
                        cnCLIENDSAC          TDVADM.T_GLB_CLIEND.GLB_TPCLIEND_CODIGO%TYPE,
                        cnGRUPOECSAC         TDVADM.T_GLB_GRUPOECONOMICO.GLB_GRUPOECONOMICO_CODIGO%TYPE,
                        cnGRUPOECREM         TDVADM.T_GLB_GRUPOECONOMICO.GLB_GRUPOECONOMICO_CODIGO%TYPE,
                        cnGRUPOECDES         TDVADM.T_GLB_GRUPOECONOMICO.GLB_GRUPOECONOMICO_CODIGO%TYPE,
                        cnCLIREM             TDVADM.T_GLB_CLIEND.GLB_CLIENTE_CGCCPFCODIGO%TYPE,
                        cnCLIENDREM          TDVADM.T_GLB_CLIEND.GLB_TPCLIEND_CODIGO%TYPE,
                        cnCARRETEIRO         TDVADM.T_FCF_VEICULODISP.CAR_CARRETEIRO_CPFCODIGO%TYPE,
                        cnCARRETEIROSAQ      TDVADM.T_FCF_VEICULODISP.CAR_CARRETEIRO_SAQUE%TYPE,
                        cnCARRETEIROPLACA    TDVADM.T_FCF_VEICULODISP.CAR_VEICULO_PLACA%TYPE,
                        cnCARRETEIROPLACASAQ TDVADM.T_FCF_VEICULODISP.CAR_VEICULO_SAQUE%TYPE,
                        cnCONJFROTA          TDVADM.T_FCF_VEICULODISP.FRT_CONJVEICULO_CODIGO%TYPE,
                        cnVIRTUAL            TDVADM.T_FCF_VEICULODISP.FCF_VEICULODISP_FLAGVIRTUAL%TYPE,
                        cnROTA               TDVADM.T_GLB_ROTA.GLB_ROTA_CODIGO%TYPE,
                        cnORIGEMCli          TDVADM.T_GLB_CLIEND.GLB_LOCALIDADE_CODIGO%TYPE,
                        cnORIGEM             TDVADM.T_GLB_CLIEND.GLB_LOCALIDADE_CODIGO%TYPE,
                        cnDESTINO            TDVADM.T_GLB_CLIEND.GLB_LOCALIDADE_CODIGO%TYPE,
                        cnCOLETA             TDVADM.T_GLB_CLIEND.GLB_LOCALIDADE_CODIGO%TYPE,
                        cnENTREGA            TDVADM.T_GLB_CLIEND.GLB_LOCALIDADE_CODIGO%TYPE,
                        cnOUTRACOLETA        TDVADM.T_GLB_CLIEND.GLB_LOCALIDADE_CODIGO%TYPE,
                        cnOUTRAENTREGA       TDVADM.T_GLB_CLIEND.GLB_LOCALIDADE_CODIGO%TYPE,
                        cnNRCOLETA           TDVADM.T_ARM_NOTA.ARM_COLETA_NCOMPRA%TYPE,
                        cnNOTA               TDVADM.T_CON_NFTRANSPORTA.CON_NFTRANSPORTADA_NUMNFISCAL%TYPE,
                        cnEMBALAGEM1         TDVADM.T_ARM_CARGADET.ARM_EMBALAGEM_NUMERO%TYPE,
                        cnEMBALAGEM          TDVADM.T_ARM_NOTA.GLB_EMBALAGEM_CODIGO%TYPE,
                        cnVLRMERC            TDVADM.T_ARM_NOTA.ARM_COLETA_VLMERCADORIA%TYPE,
                        cnQTDVOLUME          TDVADM.T_ARM_NOTA.ARM_NOTA_QTDVOLUME%TYPE,
                        cnPESO               TDVADM.T_ARM_NOTA.ARM_NOTA_PESO%TYPE,
                        cnPESOBAL            TDVADM.T_ARM_NOTA.ARM_NOTA_PESOBALANCA%TYPE,
                        cnUNIDADE            CHAR(2),
                        cnNUMERO             NUMBER,
                        cnMERCADORIA         TDVADM.T_ARM_NOTA.ARM_NOTA_MERCADORIA%TYPE,
                        cnPESOCOBRADO        TDVADM.T_ARM_NOTA.ARM_COLETA_PESOCOBRADO%TYPE,
                        cnLARGURA            TDVADM.T_ARM_NOTA.ARM_NOTA_LARGURA%TYPE,
                        cnALTURA             TDVADM.T_ARM_NOTA.ARM_NOTA_ALTURA%TYPE,
                        cnCOMPRIMENTO        TDVADM.T_ARM_NOTA.ARM_NOTA_COMPRIMENTO%TYPE,
                        cnCUBAGEM            TDVADM.T_ARM_NOTA.ARM_NOTA_CUBAGEM%TYPE,
                        cnREMONTA            NUMBER,
                        cnPESOCUBADO         TDVADM.T_ARM_NOTA.ARM_MOVIMENTO_PESOCUBADO%TYPE,
                        cnDATANOTAR          TDVADM.T_ARM_NOTA.ARM_NOTA_DTRECEBIMENTO%TYPE,
                        cnDATANOTA           TDVADM.T_ARM_NOTA.ARM_MOVIMENTO_DATANFENTRADA%TYPE,
                        cnSERIENF            TDVADM.T_ARM_NOTA.ARM_NOTA_SERIE%TYPE,
                        cnONU                TDVADM.T_ARM_NOTA.ARM_NOTA_ONU%TYPE,
                        cnONUGRPEMB          TDVADM.T_ARM_NOTA.ARM_NOTA_GRPEMB%TYPE,
                        cnKGISENTO           TDVADM.T_GLB_ONU.GLB_ONU_KGISENTA%TYPE,
                        cnFLGPRODP           TDVADM.T_ARM_NOTA.ARM_NOTA_FLAGONU%TYPE,
                        cnSPOT               TDVADM.T_ARM_CARREGAMENTO.ARM_CARREGAMENTO_AUTORIZASPOT%TYPE,                        
                        cnROTANF             TDVADM.T_GLB_ROTA.GLB_ROTA_CODIGO%TYPE,
                        cnNOMESACADO         TDVADM.T_GLB_CLIENTE.GLB_CLIENTE_RAZAOSOCIAL%TYPE,
                        cnNOMEREMETENTE      TDVADM.T_GLB_CLIENTE.GLB_CLIENTE_RAZAOSOCIAL%TYPE,
                        cnPO                 TDVADM.T_ARM_NOTA.XML_NOTALINHA_NUMDOC%TYPE,
                        cnTABSOLCOD          TDVADM.T_ARM_NOTA.ARM_NOTA_TABSOLCOD%TYPE,
                        cnTABSOLSQ           TDVADM.T_ARM_NOTA.ARM_NOTA_TABSOLSQ%TYPE,
                        cnTABSOL             TDVADM.T_ARM_NOTA.ARM_NOTA_TABSOL%TYPE,
                        cnNOTADI             TDVADM.T_ARM_NOTA.ARM_NOTA_DI%TYPE,
                        cnCFOP               TDVADM.T_ARM_NOTA.GLB_CFOP_CODIGO%type,
                        cnCODCLIDEST         CHAR(25),
                        cnNOTARI             TDVADM.T_ARM_NOTA.ARM_NOTA_RI%TYPE,
                        cnTpDocumento        TDVADM.T_arm_nota.con_tpdoc_codigo%Type,
                        cnCHAVENFE           TDVADM.T_CON_NFTRANSPORTA.CON_NFTRANSPORTADA_CHAVENFE%TYPE,
                        cnNrColetaCiclo      TDVADM.T_ARM_NOTA.ARM_COLETA_CICLO%TYPE, --Codigo de Coleta
                        cnFLAGPGTO           TDVADM.T_ARM_NOTA.ARM_NOTA_FLAGPGTO%TYPE,
--                        cnASN                TDVADM.T_xml_coleta.xml_coleta_numero%type,
--                        cnTIPOTRANSP         TDVADM.T_xml_coleta.xml_coleta_tipotransporte%type,
                        cnASN                TDVADM.T_ARM_COLETAPART.ARM_COLETAPART_CODIGO%type,
                        cnTIPOTRANSP         TDVADM.T_fcf_tpveiculo.fcf_tpveiculo_descricao%type,
                        cnTIPOCARGA          TDVADM.T_fcf_tpcarga.fcf_tpcargadescricao%type,
                        cnEntregaCol         TDVADM.T_ARM_COLETA.ARM_COLETA_ENTCOLETA%TYPE, -- So uma letra pra identidicara a coleta
                        cnEntregaCol2        TDVADM.T_ARM_COLETA.ARM_COLETA_TIPO%TYPE, -- esta escrito coleta ou entrega
                        cnVeicCarreg         TDVADM.T_fcf_tpveiculo.fcf_tpveiculo_codigo%type,
                        cnSequencia          tdvadm.t_arm_nota.arm_nota_sequencia%type,
                        cnVideNota           tdvadm.t_arm_nota.arm_nota_vide%type,
                        cnQTDEColeta         number,
                        cnConhecimento       tdvadm.t_arm_nota.con_conhecimento_codigo%type,
                        cnRotaConhec         tdvadm.t_arm_nota.glb_rota_codigo%type,
                        cnTpCarga            tdvadm.t_glb_tpcarga.glb_tpcarga_codigo%type,
--                        cnINCOTERMS          tdvadm.t_xml_coleta.xml_coleta_incoterms%type,
                        cnINCOTERMS          tdvadm.T_ARM_COLETAPART.arm_coletapart_tipofrete%type,
                        cnPedido             tdvadm.t_arm_coleta.arm_coleta_pedido%type,
                        cnCodMercadoria      tdvadm.t_arm_nota.glb_mercadoria_codigo%type,
                        cnContrato           tdvadm.t_arm_nota.slf_contrato_codigo%type,
                        cnJanelaCons_Seq     tdvadm.t_arm_janelacons.arm_janelacons_sequencia%type,
                        cnPesoCons           tdvadm.t_arm_janelacons.arm_janelacons_pesocons%type,
                        cnMercCons           tdvadm.t_arm_janelacons.arm_janelacons_merccons%type,
                        cnFechamentoCol      tdvadm.t_arm_coleta.arm_coleta_dtfechamento%type,
                        cnTaraContainer      tdvadm.t_arm_coleta.arm_coleta_containertara%type,
                        cnDtClienteInf       tdvadm.t_arm_coletapart.arm_coletapart_dtenvcli%type,
                        cnPesoClienteInf     tdvadm.t_arm_coletapart.arm_coletapart_pesoinfcli%type); 


 Type TpSQL  is RECORD (TABWHERE      VARCHAR2(25000), -- TABELAS E WHERE PRINCIPAL
                        NOTAS         VARCHAR2(25000), -- SELECT DAS NOTAS
                        SACADOS       VARCHAR2(20000), -- SELECT PARA PEGAR OS SACADOS ENVOLVIDOS
                        SACADOSGB     VARCHAR2(20000), -- GROUP BY DOS SACADOS
                        NOTASWHERE    VARCHAR2(20000), -- WHERE COMPLEMENTAR PARA AS NOTAS
                        NOTASORDER    VARCHAR2(230) := ' ORDER BY N.SLF_CONTRATO_CODIGO,N.GLB_CLIENTE_CGCCPFREMETENTE,N.GLB_CLIENTE_CGCCPFDESTINATARIO,N.GLB_TPCLIEND_CODDESTINATARIO,nvl(N.ARM_NOTA_ONU,''9999''),C.ARM_COLETA_ENTCOLETA,N.ARM_COLETA_NCOMPRA ', -- ORDERNACAO DAS NOTAS
                        REEWHERE      VARCHAR2(350) := ' AND 0 < (SELECT COUNT(*) FROM TDVADM.T_ARM_NOTACTE NDOC WHERE NDOC.ARM_NOTA_NUMERO = N.ARM_NOTA_NUMERO AND NDOC.GLB_CLIENTE_CGCCPFREMETENTE = RPAD(N.GLB_CLIENTE_CGCCPFREMETENTE,20) AND NDOC.ARM_NOTA_SERIE = N.ARM_NOTA_SERIE AND NDOC.CON_CONHECIMENTO_CODIGO IS NULL AND NDOC.ARM_NOTACTE_CODIGO = ''RE'')', -- WHERE PARA CONTA REENTREGA
                        DEVWHERE      VARCHAR2(350) := ' AND 0 < (SELECT COUNT(*) FROM TDVADM.T_ARM_NOTACTE NDOC WHERE NDOC.ARM_NOTA_NUMERO = N.ARM_NOTA_NUMERO AND NDOC.GLB_CLIENTE_CGCCPFREMETENTE = RPAD(N.GLB_CLIENTE_CGCCPFREMETENTE,20) AND NDOC.ARM_NOTA_SERIE = N.ARM_NOTA_SERIE AND NDOC.CON_CONHECIMENTO_CODIGO IS NULL AND NDOC.ARM_NOTACTE_CODIGO = ''DE'')', -- WHERE PARA CONTA DEVOLUCAO
                        RRWHERE       VARCHAR2(350) := ' AND 0 < (SELECT COUNT(*) FROM TDVADM.T_ARM_NOTACTE NDOC WHERE NDOC.ARM_NOTA_NUMERO = N.ARM_NOTA_NUMERO AND NDOC.GLB_CLIENTE_CGCCPFREMETENTE = RPAD(N.GLB_CLIENTE_CGCCPFREMETENTE,20) AND NDOC.ARM_NOTA_SERIE = N.ARM_NOTA_SERIE AND NDOC.CON_CONHECIMENTO_CODIGO IS NULL AND NDOC.ARM_NOTACTE_CODIGO = ''RR'')', -- WHERE PARA CONTA REMOCAO
                        CCWHERE       VARCHAR2(350) := ' AND 0 < (SELECT COUNT(*) FROM TDVADM.T_ARM_NOTACTE NDOC WHERE NDOC.ARM_NOTA_NUMERO = N.ARM_NOTA_NUMERO AND NDOC.GLB_CLIENTE_CGCCPFREMETENTE = RPAD(N.GLB_CLIENTE_CGCCPFREMETENTE,20) AND NDOC.ARM_NOTA_SERIE = N.ARM_NOTA_SERIE AND NDOC.CON_CONHECIMENTO_CODIGO IS NULL AND NDOC.ARM_NOTACTE_CODIGO = ''CC'')', -- WHERE PARA CONTA COMPLEMENTO
                        SEMCTRC       VARCHAR2(50)  := ' AND N.CON_CONHECIMENTO_CODIGO IS NULL ',  -- WHERE COMPLEMENTAR SE TEM OU NAO CTRC
                        SEMCTRouDR    VARCHAR2(370) := ' AND ( N.CON_CONHECIMENTO_CODIGO IS NULL OR 0 < (SELECT COUNT(*) FROM TDVADM.T_ARM_NOTACTE NDOC WHERE NDOC.ARM_NOTA_NUMERO = N.ARM_NOTA_NUMERO AND NDOC.GLB_CLIENTE_CGCCPFREMETENTE = RPAD(N.GLB_CLIENTE_CGCCPFREMETENTE,20) AND NDOC.ARM_NOTA_SERIE = N.ARM_NOTA_SERIE AND NDOC.CON_CONHECIMENTO_CODIGO IS NULL AND NDOC.ARM_NOTACTE_CODIGO in (''DE'',''RE'',''CC'',''RR'')))',
                        SEMCTRCDR     VARCHAR2(420) := ' AND (/* N.CON_CONHECIMENTO_CODIGO IS NOT NULL AND */ 0 < (SELECT COUNT(*) FROM TDVADM.T_ARM_NOTACTE NDOC WHERE NDOC.ARM_NOTA_NUMERO = N.ARM_NOTA_NUMERO AND NDOC.GLB_CLIENTE_CGCCPFREMETENTE = RPAD(N.GLB_CLIENTE_CGCCPFREMETENTE,20) AND NDOC.ARM_NOTA_SERIE = N.ARM_NOTA_SERIE AND NDOC.CON_CONHECIMENTO_CODIGO IS NULL AND NDOC.ARM_NOTACTE_CODIGO in (''DE'',''RE'',''CC'',''RR'')))',
                        SEMCTRSDR     VARCHAR2(370) := ' AND ( N.CON_CONHECIMENTO_CODIGO IS NULL AND 0 = (SELECT COUNT(*) FROM TDVADM.T_ARM_NOTACTE NDOC WHERE NDOC.ARM_NOTA_NUMERO = N.ARM_NOTA_NUMERO AND NDOC.GLB_CLIENTE_CGCCPFREMETENTE = RPAD(N.GLB_CLIENTE_CGCCPFREMETENTE,20) AND NDOC.ARM_NOTA_SERIE = N.ARM_NOTA_SERIE AND NDOC.CON_CONHECIMENTO_CODIGO IS NULL AND NDOC.ARM_NOTACTE_CODIGO in (''DE'',''RE'',''CC'',''RR'')))',
                        SEMCTRCA1     VARCHAR2(60)  := ' AND nvl(N.CON_CONHECIMENTO_SERIE,' || ''''|| 'XXX' || '''' || ') = ' || '''' || 'XXX' || '''', -- WHERE COMPLEMENTAR SE TEM OU NAO CTRC
                        CONTAPQ       VARCHAR2(20000), -- SELECT PARA CONTAR PRODUTOS QUIMICOS
                        CONTAPQ2      VARCHAR2(20000), -- SELECT PARA CONTAR PRODUTOS QUIMICOS CONCEITO NOVO
                        PQWHERE       VARCHAR2(20000), -- WHERE COMPLEMENTAR PARA PRODUTOS QUIMICOS
                        PQWHERE2      VARCHAR2(20000), -- WHERE COMPLEMENTAR PARA PRODUTOS QUIMICOS CONCEITO NOVO
                        CONTAEX       VARCHAR2(20) := 'SELECT COUNT(*) ', -- SELECT PARA CONTAR CARGA EXPRESSA
                        SCWHERE       varchar2(20000), -- Where Generico sem carga
                        EXWHERE       VARCHAR2(20000), -- WHERE PARA PEGAR AS CARGAS EXPRESSA
                        LotWHERErat   VARCHAR2(20000), -- WHERE COMPLEMENTAR PARA PEGAGR O PESO TOTAL DE CARGA ORIGEM DESTINO
                        FraWHERErat   VARCHAR2(20000), -- WHERE COMPLEMENTAR PARA PEGAGR O PESO TOTAL DE CARGA ORIGEM DESTINO
                        EXWHERErat    VARCHAR2(20000), -- WHERE COMPLEMENTAR PARA PEGAGR O PESO TOTAL DE CARGA ORIGEM DESTINO
                        PQWHERErat    VARCHAR2(20000), -- WHERE COMPLEMENTAR PARA PEGAGR O PESO TOTAL DE CARGA ORIGEM DESTINO  
                        RMWHERErat    VARCHAR2(20000), -- WHERE COMPLEMENTAR PARA PEGAGR O PESO TOTAL DE CARGA ORIGEM DESTINO  
                        WHERECOL      VARCHAR2(20000), -- WHERE COMPLEMENTAR PARA PEGAGR O PESO TOTAL DE CARGA ORIGEM DESTINO  
                        CONTAPESO     VARCHAR2(20000), -- SELECT PARA CONTAR PESO TOTAL DAS NOTAS
                        CONTAPESO2    VARCHAR2(20000), -- SELECT PARA CONTAR PESO TOTAL DAS NOTAS INVERTIDO AO V_SQLCONTAPESO 
                        CONTAREPARO   VARCHAR2(100) := 'SELECT COUNT(*),nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) ', -- SELECT PARA CONTAR REPARO
                        RPWHERE       VARCHAR2(20000), -- WHERE PARA CONTA REPARO
                        CONTANOTA     VARCHAR2(150) := 'SELECT COUNT(DISTINCT N.GLB_CLIENTE_CGCCPFREMETENTE || lpad(N.ARM_NOTA_NUMERO , 9,''0'') ) ', -- WHERE PARA CONTAR SE SOBROU NOTA SEM CTRC
                        CTNOTAWHERESC VARCHAR2(50) := '      AND N.CON_CONHECIMENTO_CODIGO IS NULL ', -- WHERE PARA CONTAR SE SOBROU NOTA SEM CTRC
                        CTNOTAWHERECC VARCHAR2(50) := '      AND N.CON_CONHECIMENTO_CODIGO IS NOT NULL ', -- WHERE PARA CONTAR SE SOBROU NOTA SEM CTRC
                        FINALSAC      VARCHAR2(20000), -- JUNTA O SELECT DE SACADOS
                        FINALNOTA     clob, -- JUNTA O SELECT DAS NOTAS
                        TESTAPESO     clob, -- JUNTA O SELECT DAS NOTAS
                        FINALCARG     VARCHAR2(20000), -- JUNTA SELECT DE CARGAS
                        SPOT          VARCHAR2(20000) := ' AND FN_CON_VERIFICASPOT(N.GLB_LOCALIDADE_CODIGOORIGEM,ECD.GLB_LOCALIDADE_CODIGO,N.ARM_COLETA_NCOMPRA, n.arm_coleta_ciclo ) IS NOT NULL ', -- WHERE COMPLEMENTAR PARA FAZER SPOT
--                        SPOT          VARCHAR2(150) := ' AND FN_CON_VERIFICASPOT(N.GLB_LOCALIDADE_CODIGOORIGEM,ECD.GLB_LOCALIDADE_CODIGO,N.ARM_COLETA_NCOMPRA, n.arm_coleta_ciclo ) IS NOT NULL ', -- WHERE COMPLEMENTAR PARA FAZER SPOT
                        TABPED        varchar2(400),
            /*02*/      TSTFRA        VARCHAR2(100) := ' AND C.FCF_TPCARGA_CODIGO NOT IN (''04'',''31'',''32'',''33'',''34'',''35'',''36'',''37'',''38'') ', 
            /*37*/      TSTFRAEXD0    VARCHAR2(100) := ' AND C.FCF_TPCARGA_CODIGO NOT IN (''02'',''04'',''31'',''32'',''33'',''34'',''35'',''36'',''38'') ',
            /*32*/      TSTFRAEXD1    VARCHAR2(100) := ' AND C.FCF_TPCARGA_CODIGO NOT IN (''02'',''04'',''31'',''33'',''34'',''35'',''36'',''37'',''38'') ',
            /*31*/      TSTFRASEM     VARCHAR2(100) := ' AND C.FCF_TPCARGA_CODIGO NOT IN (''02'',''04'',''32'',''33'',''34'',''35'',''36'',''37'',''38'') ',
            /*01*/      TSTLOT01      VARCHAR2(100) := ' AND C.FCF_TPCARGA_CODIGO NOT IN (''02'',''04'',''11'',''31'',''32'',''33'',''34'',''35'',''36'',''37'') ',
            /*38*/      TSTLOT        VARCHAR2(100) := ' AND C.FCF_TPCARGA_CODIGO NOT IN (''02'',''04'',''31'',''32'',''33'',''34'',''35'',''36'',''37'') ',
            /*33*/      TSTLOTEX0     VARCHAR2(100) := ' AND C.FCF_TPCARGA_CODIGO NOT IN (''02'',''04'',''31'',''32'',''34'',''35'',''36'',''37'',''38'') ',
            /*34*/      TSTLOTEX1     VARCHAR2(100) := ' AND C.FCF_TPCARGA_CODIGO NOT IN (''02'',''04'',''31'',''32'',''33'',''35'',''36'',''37'',''38'') ',
            /*04*/      TSTQUI        VARCHAR2(100) := ' AND C.FCF_TPCARGA_CODIGO NOT IN (''02'',''31'',''32'',''33'',''34'',''35'',''36'',''37'',''38'') ',
            /*35*/      TSTQUIEX0     VARCHAR2(100) := ' AND C.FCF_TPCARGA_CODIGO NOT IN (''02'',''04'',''31'',''32'',''33'',''34'',''36'',''37'',''38'') ',
            /*36*/      TSTQUIEX1     VARCHAR2(100) := ' AND C.FCF_TPCARGA_CODIGO NOT IN (''02'',''04'',''31'',''32'',''33'',''34'',''35'',''37'',''38'') '
                        ); 
  Type TpTesteCarga is RECORD(vTPCARGACLI         tdvadm.v_slf_clientecargas2.fcf_tpcarga_codigo%type,
                              vRetorna            char(1),
                              vTestePeso          number,
                              vTesteVlrMerc       number,
                              vExcecute           varchar2(500),
                              vTpCArgaRodando     tdvadm.t_fcf_tpcarga.fcf_tpcarga_codigo%type,
                              FINALNOTA           clob,
                              TESTAPESO           clob, 
                              vLOCALIDADEORIGEM   TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_ORIGEM%TYPE,
                              vLOCALIDADEDESTINO  TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_DESTINO%TYPE,
                              vLOCALIDADEOUTRACOL TDVADM.T_SLF_CALCFRETEkm.SLF_CALCFRETEKM_OUTRACOLETAI%type,
                              vLOCALIDADEOUTRAENT TDVADM.T_SLF_CALCFRETEkm.SLF_CALCFRETEKM_OUTRAENTREGAI%type,
                              vTIPOFRETE          TDVADM.T_SLF_TABELA.SLF_TABELA_TIPO%TYPE,
                              vCLIENTE            TDVADM.T_SLF_TABELA.GLB_CLIENTE_CGCCPFCODIGO%TYPE DEFAULT QualquerCliente,
                              vGRUPO              TDVADM.T_SLF_TABELA.GLB_GRUPOECONOMICO_CODIGO%TYPE DEFAULT QualquerGrupo,
                              vCONTRATO           TDVADM.T_SLF_TABELA.SLF_TABELA_CONTRATO%TYPE,
                              vTPVEICULO          TDVADM.T_SLF_TABELA.FCF_TPVEICULO_CODIGO%TYPE DEFAULT '9',
                              vKM                 NUMBER,
                              vEntCol             tdvadm.t_slf_tabela.SLF_TABELA_COLETAENTREGA%type,
                              vCLISAC             TDVADM.T_ARM_NOTA.GLB_CLIENTE_CGCCPFSACADO%TYPE,
                              vGrupoSac           TDVADM.T_GLB_GRUPOECONOMICO.GLB_GRUPOECONOMICO_CODIGO%TYPE,
                              vCNPJREM            TDVADM.T_ARM_NOTA.GLB_CLIENTE_CGCCPFREMETENTE%TYPE,
                              vGrupoRem           TDVADM.T_GLB_GRUPOECONOMICO.GLB_GRUPOECONOMICO_CODIGO%TYPE,
                              vCLIENDREM          TDVADM.T_ARM_NOTA.GLB_TPCLIEND_CODREMETENTE%TYPE,
                              vORIGEMNOTA         TDVADM.T_GLB_LOCALIDADE.GLB_LOCALIDADE_CODIGOIBGE%TYPE,
                              vCNPJDES            TDVADM.T_ARM_NOTA.GLB_CLIENTE_CGCCPFDESTINATARIO%TYPE,
                              vGrupoDes           TDVADM.T_GLB_GRUPOECONOMICO.GLB_GRUPOECONOMICO_CODIGO%TYPE,
                              vCLIENDDES          TDVADM.T_ARM_NOTA.GLB_TPCLIEND_CODDESTINATARIO%TYPE,
                              vDESTINONOTA        TDVADM.T_GLB_LOCALIDADE.GLB_LOCALIDADE_CODIGOIBGE%TYPE,
                              vFLAGPGTO           TDVADM.T_ARM_NOTA.ARM_NOTA_FLAGPGTO%TYPE,
                              vTemCD              char(1),
                              vTemExpresso        char(1), 
                              vTemQuimico         char(1),
                              vSql                TpSQL,
                              vPeso               number,
                              vPesoTotal          number,
                              vTABSOLCOD          TDVADM.T_ARM_NOTA.ARM_NOTA_TABSOLCOD%TYPE,
                              vTABSOLSQ           TDVADM.T_ARM_NOTA.ARM_NOTA_TABSOLSQ%TYPE,
                              vTABSOL             TDVADM.T_ARM_NOTA.ARM_NOTA_TABSOL%TYPE);


 Type tListaCobraColeta  is Table Of TpCobraColeta  Index By Binary_Integer;

 vTesteCarga    TpTesteCarga;
 ListaCargaCli  TpCargaCli;
 BListaCargaCli TlistaCargaCli;

 vDescOrigem    TpColetaEntrega; 

 
 /* Typo utilizado como base para utilizac?o dos Paramentros                                                                 */
 Type TpMODELO  is RECORD (CAMPO1         char(10),
                           CAMPO2         number(6));

   
/*
BEGIN
   BLOCO DE INSTRU  WHEN TRANSACTION_BACKED_OUT  THEN -- ORA-00061 	The remote portion of a transaction has rolled back.
COES
EXCEPTION
  WHEN DUP_VAL_ON_INDEX  THEN       -- ORA-00001   You attempted to create a duplicate value in a field restricted by a unique index.
  WHEN TIMEOUT_ON_RESOURCE  THEN    -- ORA-00051 	A resource timed out, took too long.
  WHEN INVALID_CURSOR  THEN         -- ORA-01001 	The cursor does not yet exist. The cursor must be OPENed before any FETCH cursor or CLOSE cursor operation.
  WHEN NOT_LOGGED_ON  THEN          -- ORA-01012 	You are not logged on.
  WHEN LOGIN_DENIED  THEN           -- ORA-01017 	Invalid username/password.
  WHEN NO_DATA_FOUND  THEN          -- ORA-01403 	No data was returned
  WHEN TOO_MANY_ROWS  THEN          -- ORA-01422 	You tried to execute a SELECT INTO statement and more than one row was returned.
  WHEN ZERO_DIVIDE  THEN            -- ORA-01476 	Divide by zero error.
  WHEN INVALID_NUMBER  THEN         -- ORA-01722 	Converting a string to a number was unsuccessful.
  WHEN STORAGE_ERROR  THEN          -- ORA-06500 	Out of memory.
  WHEN PROGRAM_ERROR  THEN          -- ORA-06501 	
  WHEN VALUE_ERROR  THEN            -- ORA-06502 	You tried to perform an operation and there was a error on a conversion, truncation, or invalid constraining of numeric or character data.
  WHEN ROWTYPE_MISMATCH  THEN       -- ORA-06504 	 
  WHEN CURSOR_ALREADY_OPEN  THEN    -- ORA-06511 	The cursor is already open.
  WHEN ACCESS_INTO_NULL  THEN       -- ORA-06530 	 
  WHEN COLLECTION_IS_NULL  THEN     -- ORA-06531    
  WHEN OTHERS THEN
END;

*/

  function fn_RetornaContrato(pContrato in tdvadm.t_slf_contrato.slf_contrato_codigo%type) 
     return varchar2;

  function fn_RetornaObservacao(pListaNotas    in TpNota,
                                pListaCargaCli in TpCargaCli,
                                pRetBuscaFrete in TpBuscaVerba,
                                pTpVeiculo     in tdvadm.t_fcf_tpveiculo.fcf_tpveiculo_codigo%type) 
     Return varchar2;
                                  
 Function fn_InsereLogGeracao return Char;


  function fn_ConsultaKM(pOrigem in tdvadm.t_glb_localidade.glb_localidade_codigo%type,
                         pDestino in tdvadm.t_glb_localidade.glb_localidade_codigo%type)
   return NUMBER;

--  function fn_verifica_carga(pCargaQuadrem in tdvadm.t_xml_coleta.xml_coleta_tipocarga%type,
  function fn_verifica_carga(pCargaQuadrem in tdvadm.T_ARM_COLETAPART.arm_coletapart_tipocarga%type,
                             pCargaColeta  in tdvadm.t_arm_coleta.glb_tpcarga_codigo%type)
   return  varchar2 ;

-- function fn_verifica_Veiculo(pTransporteQuadrem in tdvadm.t_xml_coleta.xml_coleta_tipotransporte%type,
  function fn_verifica_Veiculo(pTransporteQuadrem in tdvadm.T_ARM_COLETAPART.arm_coletapart_veiculo%type,
                              pCargaColeta  in tdvadm.t_arm_coleta.glb_tpcarga_codigo%type,
                              pTpVeiculo    in tdvadm.t_arm_coleta.fcf_tpveiculo_codigo%type,
                              PCarregamento in tdvadm.t_arm_carregamento.arm_carregamento_codigo%type)
   return varchar2;
   

  Function fn_RetornaAgrupamento(pTpAgrupa in tdvadm.t_slf_tpagrupa.slf_tpagrupa_codigo%type)
     Return tpAgrupaCli;

 Function fn_RetTipoColeta(pColeta in TDVADM.T_arm_nota.arm_coleta_ncompra%type,
                           pColetaCiclo in  TDVADM.T_arm_nota.arm_coleta_ciclo%type)
   return  varchar2;

 Function fn_RetRotaArmazem(pArmazem in tdvadm.t_arm_armazem.arm_armazem_codigo%type)
   return tdvadm.t_arm_armazem.glb_rota_codigo%type;
   
 Function fn_RetRotaNFArmazem(pArmazem in tdvadm.t_arm_armazem.arm_armazem_codigo%type)
   return tdvadm.t_arm_armazem.glb_rota_codigo%type;

 Function fn_RetLocalidadeArmazem(pArmazem in tdvadm.t_arm_armazem.arm_armazem_codigo%type)
   return tdvadm.t_arm_armazem.glb_localidade_codigo%type;

 Function fn_RetCNPJArmazem(pArmazem in tdvadm.t_arm_armazem.arm_armazem_codigo%type)
   return tdvadm.t_arm_armazem.glb_rota_codigo%type;


 Function fn_EColetaExpressa(pColeta in TDVADM.T_arm_nota.arm_coleta_ncompra%type,
                             pColetaCiclo in  TDVADM.T_arm_nota.arm_coleta_ciclo%type)
   return char;
   
 Function fn_EColetaExpressa(pColeta in TDVADM.T_arm_nota.arm_coleta_ncompra%type)
   return char; 

 Function fn_EProdutoQuimico(pNota in TDVADM.T_arm_nota.arm_nota_numero%type,
                             pCnpj in TDVADM.T_arm_nota.glb_cliente_cgccpfremetente%type,
                             pSerie in TDVADM.T_arm_nota.arm_nota_serie%type)
   return  char;

 Function fn_RetOrigDestNota(pTipo in char, -- (O)rigem (D)estino,(C)oleta, (E)ntrega
                             pNota in TDVADM.T_arm_nota.arm_nota_numero%type,
                             pCnpj in TDVADM.T_arm_nota.glb_cliente_cgccpfremetente%type,
                             pSerie in TDVADM.T_arm_nota.arm_nota_serie%type,
                             pColeta in TDVADM.T_arm_nota.arm_coleta_ncompra%type default null,
                             pColetaCiclo in  TDVADM.T_arm_nota.arm_coleta_ciclo%type default null,
                             pChave in TDVADM.T_arm_nota.arm_nota_chavenfe%type default null,
                             pDiasDigitada in number default 120)
   return  TDVADM.T_glb_localidade.glb_localidade_codigo%Type;
      

   FUNCTION FN_BUSCA_TPCARGAVEICULO(P_GRUPO         TDVADM.T_FCF_LIMITECARGAS.GLB_GRUPOECONOMICO_CODIGO%TYPE,
                                   P_CONTRATO      TDVADM.T_FCF_LIMITECARGAS.SLF_CONTRATO_CODIGO%TYPE,
                                   P_CLIENTE       TDVADM.T_FCF_LIMITECARGAS.GLB_CLIENTE_CGCCPFCODIGO%TYPE,
                                   P_PESO          NUMBER,
                                   P_TIPOFRETE     TDVADM.T_SLF_TABELA.SLF_TABELA_TIPO%TYPE,
                                   P_TPVEICULO     VARCHAR2,
                                   P_TPCARGA       VARCHAR2,
                                   P_PESQVEIC      char,
                                   P_TIPODERETORNO CHAR) -- TC TIPO DE CARGA, TV TIPO DE VEICULO
    RETURN CHAR;


/*
 -- Se ninhgem reclamar ate dia 01/04/excluir  
  FUNCTION FN_SLF_CLIENTEREGRAPESO(P_CNPJ TDVADM.T_GLB_CLIENTE.GLB_CLIENTE_CGCCPFCODIGO%TYPE,
                                   P_CONTRATO TDVADM.T_ARM_NOTA.SLF_CONTRATO_CODIGO%TYPE DEFAULT QualquerContrato)
         RETURN CHAR;

*/




  Procedure SP_TESTACARGA15(pTesteCarga    in out TpTesteCarga,
                            pListaCargaCli in     TlistaCargaCli);
                                                    
  Procedure SP_TESTACARGAMENORVALOR(pTesteCarga    in out TpTesteCarga,
                                    pListaCargaCli in     TlistaCargaCli);

  -- Ver se vai deixar aqui ou retira de publica
 Function fn_MudaFormula(pFormula in tdvadm.v_slf_clientecargas2.slf_clientecargas_formulafrtx%type,
                         plistaVerba in glbadm.pkg_listas.tListaParamsString)
  return tdvadm.v_slf_clientecargas2.slf_clientecargas_formulafrtx%type;

  PROCEDURE SP_BUSCA_FRETEEMPRESA(P_Busca_Frete   in TpParamBuscaVerba,
                                  P_ConfCarga     in TpCargaCli,
                                  P_RetBuscaFrete out TpBuscaVerba,
                                  P_MENSAGEM      OUT VARCHAR2);
 /******************************/

 PROCEDURE SP_CON_CRIACTRCCARREG(P_ARM_CARREGAMENTO     IN TDVADM.T_ARM_CARREGAMENTO.ARM_CARREGAMENTO_CODIGO%TYPE,
                                  P_ARM_ARMAZEM          IN TDVADM.T_ARM_ARMAZEM.ARM_ARMAZEM_CODIGO%TYPE,
                                  P_DATAEMISSAO          IN DATE,
                                  P_USU_USUARIOCRIA      IN TDVADM.T_USU_USUARIO.USU_USUARIO_CODIGO%TYPE,
                                  P_RETORNOPROCESSAMENTO OUT VARCHAR);
  
  
  PROCEDURE SP_CON_SEPARACARREG(pCarregamento in tdvadm.t_arm_carregamento.arm_carregamento_codigo%type,
                                pArmazem      in varchar2,
                                pUsuario      in varchar2,
                                pStatus       out char,
                                pMessage      out varchar2);
  
  procedure SP_ARM_RODASEPARA;

  PROCEDURE SP_CON_JUNTACARREG(pCarregamento in tdvadm.t_arm_carregamento.arm_carregamento_codigo%type,
                               pTipo         in char default 'XXX',
                               pStatus       out char,
                               pMessage      out varchar2);


  procedure SP_SIMULADOR2(pOrigem   in tdvadm.t_glb_localidade.glb_localidade_codigoibge%type,
                          pDestino  in tdvadm.t_glb_localidade.glb_localidade_codigoibge%type,
                          pPeso     in number,
                          pCliente  in tdvadm.t_glb_cliente.glb_cliente_cgccpfcodigo%type,
                          pGrupo    in tdvadm.t_glb_cliente.glb_grupoeconomico_codigo%type,
                          pContrato in tdvadm.t_slf_contrato.slf_contrato_codigo%type,
                          pCarga    in tdvadm.t_fcf_tpcarga.fcf_tpcarga_codigo%type,
                          pVeiculo  in tdvadm.t_fcf_tpveiculo.fcf_tpveiculo_codigo%type,
                          pXML      out clob,
                          pCursor   out tpCurosr,
                          pStatus   out char,
                          pMessage  out varchar2,
                          pSql      out CLOB);
                         
  procedure SP_SIMULADOR(pXMLin    in varchar2,
                         pXML      out clob,
--                         pCursor   out tpCurosr,                  
                         pStatus   out char,
                         pMessage  out varchar2);
  
  function fn_testacarga(pConhec in tdvadm.t_con_conhecimento.con_conhecimento_codigo%type,
                         pSerie in tdvadm.t_con_conhecimento.con_conhecimento_serie%type,
                         pRota in tdvadm.t_con_conhecimento.glb_rota_codigo%type)
                  return varchar2;

 Function fni_RetornaTabSol(pSacado in TDVADM.T_glb_cliente.glb_cliente_cgccpfcodigo%type ,
                            pGrupo          in tdvadm.t_glb_grupoeconomico.glb_grupoeconomico_codigo%type,
                            pContratoCargas in TDVADM.T_arm_nota.slf_contrato_codigo%type) Return clob;

  Procedure SP_LIBERACARREG;
  
   function fn_RetornaListaPedidos(pNota in TDVADM.T_arm_nota.arm_nota_numero%type,
                                   pCnpj in TDVADM.T_arm_nota.glb_cliente_cgccpfremetente%type,
                                   pSerie in TDVADM.T_arm_nota.arm_nota_serie%type)
    Return Varchar2;

  Procedure sp_Partilha(pCte   in tdvadm.t_con_conhecimento.con_conhecimento_codigo%type,
                        pSerie in tdvadm.t_con_conhecimento.con_conhecimento_serie%type,
                        pRota  in tdvadm.t_con_conhecimento.glb_rota_codigo%type,
                        pStatus out char,
                        pMessage out varchar2);

    


END PKG_FIFO_CARREGCTRC;

 
/
CREATE OR REPLACE PACKAGE BODY PKG_FIFO_CARREGCTRC AS

  cCargaExpressa   constant varchar2(200) := '''LOTACAO/EXPRESSO'',''FRACIONADO/EXPRESSO'',''LOTACAO/EXPRESSO/QUIMICO'',''FRACIONADO/EXPRESSO/QUIMICO'',''FRACIONADO/LOTACAO/EXPRESSO''';
  cCargaFracionado constant varchar2(200) := '''FRACIONADO'',''FRACIONADO RE'',''FRACIONADO/EXPRESSO'',''FRACIONADO/QUIMICO'',''FRACIONADO/EXPRESSO/QUIMICO'',''FRACIONADO/LOTACAO''';
  cCargaLotacao    constant varchar2(200) := '''LOTACAO'',''LOTACAO RE'',''LOTACAO/EXPRESSO'',''LOTACAO/QUIMICO'',''LOTACAO/EXPRESSO/QUIMICO'',''FRACIONADO/LOTACAO''';
  cCargaPerigosa   constant varchar2(200) := '''LOTACAO/QUIMICO'',''FRACIONADO/QUIMICO'',''LOTACAO/EXPRESSO/QUIMICO'',''FRACIONADO/EXPRESSO/QUIMICO''';
  cCargaColeta     constant varchar2(200) := '''COLETA'',''COLETA/EXPRESSO'',''COLETA/QUIMICO'',''COLETA/EXPRESSO/QUIMICO''';

--  cCargaExpressa   constant varchar2(200) := '''EXPRESSO''';
--  cCargaFracionado constant varchar2(200) := '''FRACIONADO''';
--  cCargaLotacao    constant varchar2(200) := '''LOTACAO''';
--  cCargaPerigosa   constant varchar2(200) := '''QUIMICO''';


  vSemCOmparacaoEnviaEmail   char(1) := 'S';
  vSemCOmparacaoDestinatario varchar2(200) := 'jajunior@dellavolpe.com.br;toliveira@dellavolpe.com.br';

  vContextCount        number;
  

  ProdutoQuimicoSemFormulario CONSTANT char(10) := '0000000000';
  CargaExpressaSemFormulario  CONSTANT char(10) := '0000000000';
  CargaAHFormulario           CONSTANT char(10) := '0000000000';
  CargaSpotSemFormulario      CONSTANT char(10) := '0000000000';

  OnuNaoQuimico               CONSTANT char(4)  := '9999';

 
 cNFServico Constant Char(1) := 'N';
 cCTeCTRC   Constant Char(1) := 'E';

 vKmUPDINSRT   char(1) := 'N';

 ListaVerbas    glbadm.pkg_listas.tListaParamsString;
 ListaVerbasCol glbadm.pkg_listas.tListaParamsString;

 ListaAgrupaCli  TpAgrupaCli;   
 
 vErroFatal     char(1) := 'N';   
 vErro         char(1) := TDVADM.PKG_glb_common.Status_Nomal; 
 ListaSQL      TpSQL;
 ListaNotas    TpNota;
 ListaVaux     TpAuxiliar;
 ListaQuebras  TpQuebras;
 tpNotaCte     tdvadm.t_arm_notacte%rowtype;
 vAuxiliar     number;
   
 V_NOTASPROCESSADAS VARCHAR2(20000) := '';
 V_NOTASCOMERRO     VARCHAR2(20000) := '';
 V_TIPOVEICULO      TDVADM.T_FCF_TPVEICULO.FCF_TPVEICULO_DESCRICAO%TYPE;
 V_SACADOCARGA      TDVADM.T_GLB_CLIENTE.GLB_CLIENTE_CGCCPFCODIGO%TYPE;
 V_GRUPOCARGAS      TDVADM.T_GLB_GRUPOECONOMICO.GLB_GRUPOECONOMICO_CODIGO%TYPE;
 V_CONTRATOCARGAS   TDVADM.T_ARM_NOTA.SLF_CONTRATO_CODIGO%TYPE;
 V_ARM_CARREGAMENTO TDVADM.T_ARM_CARREGAMENTO.ARM_CARREGAMENTO_CODIGO%TYPE;
 V_CIFFOB           TDVADM.T_SLF_TABELA.SLF_TABELA_TIPO%TYPE;
 vDescCalculo       tdvadm.t_slf_tpcalculo.slf_tpcodigo_descricao%type;

 vPbArrend      tdvadm.t_slf_clienteregras.slf_clienteregras_pbarrend%type;
 vPbDecGramas   tdvadm.t_slf_clienteregras.slf_clienteregras_pbdecgramas%type;
 
 
 
  Function fni_CriaNovoCte(pCLIREM        in tdvadm.t_glb_cliente.glb_cliente_cgccpfcodigo%type,
                           pCLIREMANT     in tdvadm.t_glb_cliente.glb_cliente_cgccpfcodigo%type,
                           pCLIDEST       in tdvadm.t_glb_cliente.glb_cliente_cgccpfcodigo%type,
                           pCLIDESTANT    in tdvadm.t_glb_cliente.glb_cliente_cgccpfcodigo%type,
                           pCOLETA        in tdvadm.t_glb_localidade.glb_localidade_codigo%type,
                           pCODIGOORIANT  in tdvadm.t_glb_localidade.glb_localidade_codigo%type,
                           pENTREGA       in tdvadm.t_glb_localidade.glb_localidade_codigo%type,
                           pCODIGODESANT  in tdvadm.t_glb_localidade.glb_localidade_codigo%type,
                           pTABSOLCOD     in tdvadm.t_slf_tabela.slf_tabela_codigo%type,
                           pTABSOLCODANT  in tdvadm.t_slf_tabela.slf_tabela_codigo%type,
                           pListaCargaCli in TpCargaCli) 
     Return char
   As
     vRetorno  char(1) := 'S';
   Begin

      if ( pCLIDEST   = nvl(pCLIDESTANT,'XXX')   ) And
         ( pCLIREM    = nvl(pCLIREMANT,'XXX')    ) And 
         ( pCOLETA    = nvl(pCODIGOORIANT,'XXX') ) And 
         ( pENTREGA   = nvl(pCODIGODESANT,'XXX') ) And
         ( pTABSOLCOD = nvl(pTABSOLCODANT,'XXX') ) THEN
         vRetorno := 'N';
      Else
         vRetorno := 'S';
      End If; 
      
      -- Globalizado no Remetente
      -- Os destinatarios tem que ser iguais
      if pListaCargaCli.ccCteGlobalizado = 'R' Then
         if ( pCLIDEST = nvl(pCLIDESTANT,'XXX') ) Then
            vRetorno := 'N';
         Else
            vRetorno := 'S';
         End If;

      -- Globalizado no Destinatario
      -- Os Remetentes tem que ser iguais
      Elsif pListaCargaCli.ccCteGlobalizado = 'D' Then
         if ( pCLIREM = nvl(pCLIREMANT,'XXX') ) Then
            vRetorno := 'N';
         Else
            vRetorno := 'S';
         End If;
      End If;    
      
       -- Nao importa a Condicao se for de Tabelas Diferentes Cria um novo CTe 
      If ( pTABSOLCOD <> pTABSOLCODANT ) Then
         vRetorno := 'S';
      End IF;
      
      return vRetorno;
     

   End fni_CriaNovoCte; 
   
   
 Function fni_CriaSql(P_Busca_Frete   in TpParamBuscaVerba,
                      P_ConfCarga     in TpCargaCli,
                      pTipo in Varchar2)
    return varchar2
  As
     vSql     varchar2(20000);  
     vOrigem  tdvadm.t_glb_localidade.glb_localidade_codigo%type;
     vDestino tdvadm.t_glb_localidade.glb_localidade_codigo%type;
     vPESOPESQUISA number;
  Begin
    

     vSql := '';
     vSql := vSql || 'SELECT CK.*, ';
     vSql := vSql || '       T.GLB_MERCADORIA_CODIGO, ';
     vSql := vSql || '       T.SLF_TABELA_COLETAENTREGA, ';
     vSql := vSql || '       T.SLF_TABELA_TIPO, ';
     vSql := vSql || '       T.FCF_TPVEICULO_CODIGO, ';
     vSql := vSql || '       T.FCF_TPCARGA_CODIGO, ';
     vSql := vSql || '       T.GLB_CLIENTE_CGCCPFCODIGO, ';
     vSql := vSql || '       T.GLB_GRUPOECONOMICO_CODIGO, ';
     vSql := vSql || '       T.SLF_TABELA_CONTRATO, ';
     vSql := vSql || '       1 vPESOCOBRADO, ';
     vSql := vSql || '       1 vFATORRATEIO, ';
     vSql := vSql || '       ''OK'' vRetorno ';
     vSql := vSql || 'FROM TDVADM.T_SLF_CALCFRETEKM CK, ';
     vSql := vSql || '     TDVADM.T_SLF_TABELA T ';
     vSql := vSql || 'WHERE 0 = 0 ';

     vSql := vSql || '  AND CK.SLF_TABELA_CODIGO = T.SLF_TABELA_CODIGO ';
     vSql := vSql || '  AND CK.SLF_TABELA_SAQUE = T.SLF_TABELA_SAQUE ';
     vSql := vSql || '  AND NVL(T.SLF_TABELA_STATUS,''N'') = ''N''';

     vSql := vSql || '  AND T.SLF_TABELA_TIPO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(P_Busca_Frete.vTIPOFRETE);

     if P_Busca_Frete.vCLIENTE <> QualquerCliente Then
        vSql := vSql || '  AND trim(T.GLB_CLIENTE_CGCCPFCODIGO) = ' || TDVADM.PKG_glb_common.fn_QuotedStr(P_Busca_Frete.vCLIENTE);
     End If;
     
     if P_Busca_Frete.vCONTRATO <> QualquerContrato Then
        vSql := vSql || '  AND T.SLF_TABELA_CONTRATO = '|| TDVADM.PKG_glb_common.fn_QuotedStr(P_Busca_Frete.vCONTRATO) ;
     End If;
     
     if P_Busca_Frete.vGRUPO <> QualquerGrupo Then
        vSql := vSql || '  AND T.GLB_GRUPOECONOMICO_CODIGO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(P_Busca_Frete.vGRUPO);
     End If;

     vSql := vSql || '  AND CK.SLF_RECCUST_CODIGO = ' || TDVADM.PKG_glb_common.fn_QuotedStr('D_FRPSVO') ;
     vSql := vSql || '  AND T.FCF_TPCARGA_CODIGO =  ' || TDVADM.PKG_glb_common.fn_QuotedStr(P_ConfCarga.ccTPCARGACLIPESQ);

     vSql := vSql || '  AND nvl(T.SLF_TABELA_COLETAENTREGA,''A'') in (''N'',''A'',' || TDVADM.PKG_glb_common.fn_QuotedStr(P_Busca_Frete.vEntCol) || ')';
--     vSql := vSql || '  AND CK.SLF_CALCFRETEKM_TPFRETE = ' || TDVADM.PKG_glb_common.fn_QuotedStr(P_ConfCarga.ccTPFRETE) ;

     If P_ConfCarga.ccUSAFAIXAKM = 'S' Then
         vSql := vSql || '  AND round(' || trim(to_char(P_Busca_Frete.vKM)) || ',0) BETWEEN CK.SLF_CALCFRETEKM_KMDE AND CK.SLF_CALCFRETEKM_KMATE ';
     End If;   

     If P_ConfCarga.ccUSAFAIXAPS = 'S' Then 
        vSql := vSql || '   AND round(' || trim(to_char(vPESOPESQUISA)) || ',' || trim(to_char(nvl(vPbDecGramas,0))) || ') BETWEEN CK.SLF_CALCFRETEKM_PESODE AND CK.SLF_CALCFRETEKM_PESOATE ';
     End If;

     if P_ConfCarga.ccUSAVEICULO = 'S' Then
        vSql := vSql || '   AND TRIM(NVL(T.FCF_TPVEICULO_CODIGO,''9  '')) = ' || TDVADM.PKG_glb_common.fn_QuotedStr(P_Busca_Frete.vTPVEICULO) ;
     End If;   

       
--     vSql := vSql || '          AND TRIM(CK.SLF_CALCFRETEKM_ORIGEMI)  = TRIM(DECODE(TRIM(T.FCF_TPCARGA_CODIGO),'08',P_CODIGOORI,'99999'))
     if P_ConfCarga.ccTPCODORIGEM    = 'NN' Then -- Nao Pesquisa
        vOrigem := '99999';
     Elsif P_ConfCarga.ccTPCODORIGEM = 'LO' Then -- Localidade
        vOrigem := P_Busca_Frete.vLOCALIDADEORIGEM;
     Elsif P_ConfCarga.ccTPCODORIGEM = 'IB' Then -- IBGE
        vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'IBC')),8);
     Elsif P_ConfCarga.ccTPCODORIGEM = 'FI' Then -- FIXO IBGE
        If P_ConfCarga.ccORIGEMFIXA is not null then
           vOrigem := rpad(trim(P_ConfCarga.ccORIGEMFIXA),8);
        End If;
     Elsif P_ConfCarga.ccTPCODORIGEM = 'RE' Then -- Regiao Cartografica
        vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'IBR')),8);
     Elsif P_ConfCarga.ccTPCODORIGEM = 'RC' Then -- Regiao Cartografica do Cliente
        vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'IBRV')),8);
     Elsif P_ConfCarga.ccTPCODORIGEM = 'CI' Then -- Capital Interior
        vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'CI')),8);
     Elsif P_ConfCarga.ccTPCODORIGEM = 'UF' Then -- Por Estado
        vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'UF')),8);
     Elsif P_ConfCarga.ccTPCODORIGEM = 'RA' Then -- Por Raio
        vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'IBC')),8);
     Elsif P_ConfCarga.ccTPCODORIGEM = 'ME' Then -- Por Raio
        vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'MEC')),8);
     Elsif P_ConfCarga.ccTPCODORIGEM = 'MI' Then -- Por Raio
        vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'MIC')),8);
     Else
        vOrigem := null;  
     End If;     
     

     if P_ConfCarga.ccTPCODDESTINO    = 'NN' Then -- Nao Pesquisa
        vDestino := '99999';
     Elsif P_ConfCarga.ccTPCODDESTINO = 'LO' Then -- Localidade
        vDestino := rpad(trim(P_Busca_Frete.vLOCALIDADEDESTINO),8);
     Elsif P_ConfCarga.ccTPCODDESTINO = 'IB' Then -- IBGE
        vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'IBC')),8);
     Elsif P_ConfCarga.ccTPCODDESTINO = 'FI' Then -- FIXO IBGE
        If P_ConfCarga.ccDESTINOFIXO is not null Then
           vDestino := rpad(trim(P_ConfCarga.ccDESTINOFIXO),8);
        End If;
     Elsif P_ConfCarga.ccTPCODDESTINO = 'RE' Then -- Regiao Cartografica
        vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'IBR')),8);
     Elsif P_ConfCarga.ccTPCODDESTINO = 'RC' Then -- Regiao Cartografica do Cliente
        vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'IBRV')),8);
     Elsif P_ConfCarga.ccTPCODDESTINO = 'CI' Then -- Capital Interior
        vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'CI')),8);
     Elsif P_ConfCarga.ccTPCODDESTINO = 'UF' Then -- Por Estado
        vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'UF')),8);
     Elsif P_ConfCarga.ccTPCODDESTINO = 'RA' Then -- Por Raio
        vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'IBC')),8);
     Elsif P_ConfCarga.ccTPCODDESTINO = 'ME' Then -- Por Meso
        vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'MEC')),8);
     Elsif P_ConfCarga.ccTPCODDESTINO = 'MI' Then -- Por Micro
        vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'MIC')),8);
     Else
       vDestino := null;   
     End If;     
       
     if vOrigem is not null Then
        if P_ConfCarga.ccTPCODORIGEM <> 'RA' Then
           vSql := vSql || '          AND CK.SLF_CALCFRETEKM_ORIGEMI  = ' || TDVADM.PKG_glb_common.fn_QuotedStr(rpad(vOrigem,8));
        Else
           vSql := vSql || '          AND TDVADM.pkg_glb_common.fn_get_distanciaIBGE(trim(CK.SLF_CALCFRETEKM_ORIGEMI),' || TDVADM.PKG_glb_common.Fn_QuotedStr(vOrigem) || ') <= CK.SLF_CALCFRETEKM_RAIOKMORIGEM ';
           vSql := vSql || '          and (select i.ufsigla from TDVADM.v_glb_ibge i where i.codmun = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vOrigem) || ') = (select i.ufsigla from TDVADM.v_glb_ibge i where trim(i.codmun) = trim(CK.SLF_CALCFRETEKM_ORIGEMI)) ';

        End If;
     End If;

     if vDestino is not null Then 
        If P_ConfCarga.ccTPCODDESTINO <> 'RA' Then
           vSql := vSql || '          AND CK.SLF_CALCFRETEKM_DESTINOI  = ' ||  TDVADM.PKG_glb_common.fn_QuotedStr( rpad(vDestino,8) ) ;
        Else
           vSql := vSql || '          AND TDVADM.pkg_glb_common.fn_get_distanciaIBGE(trim(CK.SLF_CALCFRETEKM_DESTINOI),' || TDVADM.PKG_glb_common.Fn_QuotedStr(vDestino) || ') <= CK.SLF_CALCFRETEKM_RAIOKMDESTINO ';
           vSql := vSql || '          and (select i.ufsigla from TDVADM.v_glb_ibge i where i.codmun = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vDestino) || ') = (select i.ufsigla from TDVADM.v_glb_ibge i where trim(i.codmun) = trim(CK.SLF_CALCFRETEKM_DESTINOI)) ';
        End If;   
     End If;  

     vSql := vSql || '  AND T.SLF_TABELA_SAQUE = (SELECT MAX(T1.SLF_TABELA_SAQUE) ';
     vSql := vSql || '                            FROM TDVADM.T_SLF_TABELA T1 ';
     vSql := vSql || '                            WHERE T1.SLF_TABELA_CODIGO = T.SLF_TABELA_CODIGO ';
     vSql := vSql || '                              AND NVL(T1.SLF_TABELA_STATUS,''N'') = ''N''';
     vSql := vSql || '                              AND TO_DATE(T1.SLF_TABELA_VIGENCIA,''DD/MM/YYYY'') <= TO_DATE(SYSDATE,''DD/MM/YYYY'')) ';
     
     

     return vSql;



  End;    
 
 
 
 
 Function fni_TabPercExiste(pTabela in TDVADM.v_slf_clientecargas2.slf_clienteREGRAS_tabkm%type)
    return char
  As
   vExiste number;  
 Begin
    select count(*)
      into vExiste
    from tab t
    where t.tname = 'T_SLF_PERCURSO_' || upper(pTabela);
    
   if vExiste = 1 Then
      return 'S';
   Else
     return 'N';
   End If;        
    
 End fni_TabPercExiste;   

 Function fni_PercExiste(pTabela in TDVADM.v_slf_clientecargas2.slf_clienteREGRAS_tabkm%type,
                         pOrigem in TDVADM.T_slf_percurso.glb_localidade_codigoorigemi%type,
                         pDestino in TDVADM.T_slf_percurso.glb_localidade_codigodestinoi%type)
    return number
  As
   vSql varchar2(250);  
   vKm number;
 Begin
    vSql :=         'SELECT MAX(P.SLF_PERCURSO_KM) ';
    vSql := vSql || 'FROM TDVADM.T_SLF_PERCURSO_' || pTabela || ' P ';
    vSql := vSql || 'WHERE P.GLB_LOCALIDADE_CODIGOORIGEMI = ' || TDVADM.PKG_GLB_COMMON.Fn_QuotedStr(pOrigem) ; 
    vSql := vSql || '  AND P.GLB_LOCALIDADE_CODIGODESTINOI = ' || TDVADM.PKG_GLB_COMMON.Fn_QuotedStr(pDestino);

    Begin
    EXECUTE IMMEDIATE vSql INTO  vkm;
    Exception
      When OTHERS Then
         vkm := null;
      End;
     if nvl(vkm,0) = 0 then
      vkm := -1; 
     elsif nvl(vkm,0) > 0 then
       vkm := vkm;
--     else
--       vkm := ListaCargaCli.ccKMMinimo;
     end if;
    
    return nvl(vkm,-1);
   
 End fni_PercExiste;

 Function fni_IncPercurso(pTabela in TDVADM.v_slf_clientecargas2.slf_clienteREGRAS_tabkm%type,
                          pTpPercurso in TDVADM.T_slf_percurso%rowtype)
    return varchar2
  As
   vSql  varchar2(250);
   vErro varchar2(1000);  
   vAuxiliar number;
 Begin
    begin
        TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso :=  pTpPercurso;
        
        If pTabela = '2781910' then
           select count(*)
             into vAuxiliar
           from  TDVADM.T_SLF_PERCURSO_2781910 p
           where p.glb_localidade_codigoorigemi = pTpPercurso.Glb_Localidade_Codigoorigemi
             and p.glb_localidade_codigodestinoi = pTpPercurso.Glb_Localidade_Codigodestinoi;
           if  vAuxiliar = 0 Then 
              INSERT INTO TDVADM.T_SLF_PERCURSO_2781910 values tpPercurso;
           End If;
        ElsIf pTabela = '91566' Then
           select count(*)
             into vAuxiliar
           from  TDVADM.T_SLF_PERCURSO_91566 p
           where p.glb_localidade_codigoorigemi = pTpPercurso.Glb_Localidade_Codigoorigemi
             and p.glb_localidade_codigodestinoi = pTpPercurso.Glb_Localidade_Codigodestinoi;
           if  vAuxiliar = 0 Then 
              INSERT INTO TDVADM.T_SLF_PERCURSO_91566 values tpPercurso;
           End If;
        Elsif pTabela = '82795' then
           select count(*)
             into vAuxiliar
           from  TDVADM.T_SLF_PERCURSO_82795 p
           where p.glb_localidade_codigoorigemi = pTpPercurso.Glb_Localidade_Codigoorigemi
             and p.glb_localidade_codigodestinoi = pTpPercurso.Glb_Localidade_Codigodestinoi;
           if  vAuxiliar = 0 Then 
              INSERT INTO TDVADM.T_SLF_PERCURSO_82795 values tpPercurso;
           End If;
        end if;
        
--        vSql := 'INSERT INTO TDVADM.T_SLF_PERCURSO_' || pTabela || ' values TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso';
--           EXECUTE IMMEDIATE vSql ;
        return 'Ok';
    exception
      When OTHERS Then
         vErro := sqlerrm;
         return  sqlerrm;
    End ;

 End fni_IncPercurso;
 
 Function fn_CarregaVerbas(pConhecimento in tdvadm.t_con_conhecimento.con_conhecimento_codigo%type,
                           pSerie        in tdvadm.t_con_conhecimento.con_conhecimento_serie%type,
                           pRota         in tdvadm.t_con_conhecimento.glb_rota_codigo%type) 
      return glbadm.pkg_listas.tListaParamsString
   As
     vRetorno glbadm.pkg_listas.tListaParamsString;
   Begin
       for c_msg in (select slf_reccust_codigo,
                            con_calcviagem_desinencia,
                            con_calcviagem_valor 
                     from TDVADM.t_con_calcconhecimento ca
                     where ca.con_conhecimento_codigo = pConhecimento
                       and ca.con_conhecimento_serie = pSerie
                       and ca.glb_rota_codigo = pRota)
        Loop
           vRetorno(trim(c_msg.slf_reccust_codigo)).AsFloat      := c_msg.con_calcviagem_valor;
           vRetorno(trim(c_msg.slf_reccust_codigo)).Value        := trim(to_char(c_msg.con_calcviagem_valor));
           vRetorno(trim(c_msg.slf_reccust_codigo)).AsDesinencia := c_msg.con_calcviagem_desinencia;
        End Loop;
        
        Return vRetorno;
     
   End fn_CarregaVerbas;      
   
 Function fn_MudaObservacao(pObs in tdvadm.t_con_conhecimento.con_conhecimento_obs%type,
                            plistaVerba in glbadm.pkg_listas.tListaParamsString)
  return tdvadm.v_slf_clientecargas2.slf_clientecargas_formulafrtx%type
 As
   vQtdeTrocas Integer;
   vVerba      varchar2(50);
   vformula    tdvadm.t_con_conhecimento.con_conhecimento_obs%type;
 Begin
   vformula :=  pObs;
   vQtdeTrocas := TDVADM.PKG_glb_common.Fn_RetornaTAG(0,vformula);
   loop
     begin
     vVerba :=  TDVADM.PKG_glb_common.Fn_RetornaTAG(vQtdeTrocas,vformula);
     vformula := replace(vformula,'<<'|| trim(vVerba) || '>>',plistaVerba(vVerba).Value);
     exception
       when NO_DATA_FOUND then
         vQtdeTrocas := vQtdeTrocas;
       end;
     vQtdeTrocas := vQtdeTrocas - 1;
     exit when vQtdeTrocas = 0;
   End Loop;
   
   return vformula; 
 
 End fn_MudaObservacao;  

 Function fn_MudaFormula(pFormula in tdvadm.v_slf_clientecargas2.slf_clientecargas_formulafrtx%type,
                         plistaVerba in glbadm.pkg_listas.tListaParamsString)
  return tdvadm.v_slf_clientecargas2.slf_clientecargas_formulafrtx%type
 As
   vQtdeTrocas Integer;
   vVerba      varchar2(50);
   vformula    tdvadm.v_slf_clientecargas2.slf_clientecargas_formulafrtx%type;
 Begin
   vformula :=  pformula;
   vQtdeTrocas := TDVADM.PKG_glb_common.Fn_RetornaTAG(0,vformula);
   loop
     begin
     vVerba :=  TDVADM.PKG_glb_common.Fn_RetornaTAG(vQtdeTrocas,vformula);
     vformula := replace(vformula,'<<'|| trim(vVerba) || '>>',plistaVerba(vVerba).Value);
     exception
       when NO_DATA_FOUND then
         vQtdeTrocas := vQtdeTrocas;
       end;
     vQtdeTrocas := vQtdeTrocas - 1;
     exit when vQtdeTrocas = 0;
   End Loop;
   
   return vformula; 
 
 End fn_MudaFormula;  
 
 
 
 Function fn_InsereLogGeracao return Char
   as
    vErro char(1);
   Begin
--    v_classificaerro := '';
     If ListaVaux.cnArmazem is null Then
        return 'N';
     End If;
     if tpLogGeracao.Con_Loggeracao_Codigo is null Then 
        select max(lg.con_loggeracao_codigo)
           into tpLogGeracao.Con_Loggeracao_Codigo
        from tdvadm.t_con_loggeracao lg
        where lg.arm_carregamento_codigo = tpLogGeracao.Arm_Carregamento_Codigo;
        tpLogGeracao.Con_Loggeracao_Codigo := lpad(tpLogGeracao.Con_Loggeracao_Codigo,5,'0');
     ENd IF;   
     
     if ListaVaux.cnArmazem is null Then
        select ca.arm_armazem_codigo
          into ListaVaux.cnArmazem
        from TDVADM.t_arm_carregamento ca
        where ca.arm_carregamento_codigo = tpLogGeracao.Arm_Carregamento_Codigo;
     End If;    

     tpLogGeracao.Con_Loggeracao_Codigo := nvl(tpLogGeracao.Con_Loggeracao_Codigo,'020');
     tpLogGeracao.Con_Loggeracao_Codigo := lpad( tpLogGeracao.Con_Loggeracao_Codigo + 1,5,'0');
     tpLogGeracao.Con_Loggeracao_Dtgeracao := sysdate;

--     If ListaVaux.cnArmazem = '06' Then

        If tpLogGeracao.Con_Loggeracao_Obsgeracao is Null Then
           tpLogGeracao.Con_Loggeracao_Obsgeracao := substr(tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML,1,2000);
        End If;   

        If  tpLogGeracaO.Con_Loggeracao_Erro Is Null Then
           tpLogGeracaO.Con_Loggeracao_Erro := substr(tpLogGeracaO.Con_Loggeracao_ErroHTML,1,2000);
        End If;
       
        If tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML is Null Then
           tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := substr(tpLogGeracao.Con_Loggeracao_Obsgeracao,1,2000);
        End If;   

        If  tpLogGeracaO.Con_Loggeracao_ErroHTML Is Null Then
           tpLogGeracaO.Con_Loggeracao_ErroHTML := substr(tpLogGeracaO.Con_Loggeracao_Erro,1,2000);
        End If;




        tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := replace(tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML,'<<','[');
        tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := replace(tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML,'>>',']');
     
        tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := replace(tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML,chr(10),'<br/>');
        tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := replace(tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML,chr(13),'<br/>');
            
        tpLogGeracaO.Con_Loggeracao_ErroHTML := replace(tpLogGeracaO.Con_Loggeracao_ErroHTML,chr(10),'<br/>');
        tpLogGeracaO.Con_Loggeracao_ErroHTML := replace(tpLogGeracaO.Con_Loggeracao_ErroHTML,chr(13),'<br/>');
     
        if instr(lower(tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML),'html') = 0 Then
           tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := TDVADM.PKG_glb_html.Assinatura || TDVADM.PKG_glb_html.fn_FonteA('Courier New',2) || tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML || TDVADM.PKG_glb_html.fn_FonteF;
        End If;
        if instr(lower(tpLogGeracaO.Con_Loggeracao_ErroHTML),'html') = 0 Then
           tpLogGeracaO.Con_Loggeracao_ErroHTML := TDVADM.PKG_glb_html.Assinatura || TDVADM.PKG_glb_html.fn_FonteA('Courier New',2) || tpLogGeracaO.Con_Loggeracao_ErroHTML || TDVADM.PKG_glb_html.fn_FonteF;
        End If;

--     End If;


     insert into tdvadm.t_Con_Loggeracao
     Values tpLogGeracao;
     commit;

     if ( tpLogGeracaO.Con_Loggeracao_ErroHTML is not null ) Then 
        vErro := TDVADM.PKG_glb_common.Status_Erro;
     Else
        vErro := nvl(vErro, TDVADM.PKG_glb_common.Status_Nomal); 
     End if;   

     tpLogGeracao.Con_Loggeracao_Obsgeracao     := null;
     tpLogGeracaO.Con_Loggeracao_Erro           := null;
     tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := null;
     tpLogGeracao.Con_Loggeracao_ErroHTML       := null;
     tpLogGeracao.Con_Loggeracao_Sql            := null;
     tpLogGeracao.Con_Loggeracao_Formula        := null;
     tpLogGeracao.Arm_Nota_Peso                 := null;
     tpLogGeracao.Con_Loggeracao_Fator          := null;
     tpLogGeracao.Con_Loggeracao_Formulatra     := null;
     tpLogGeracao.Arm_Nota_Pesototal            := null;
     
     If nvl(vErro,TDVADM.PKG_glb_common.Status_Nomal) <> TDVADM.PKG_glb_common.Status_Nomal Then
        vErro := vErro;
     End If;
     
     return nvl(vErro,TDVADM.PKG_glb_common.Status_Nomal);
     
   End fn_InsereLogGeracao;
   
   
   
   function fn_RetornaContrato(pContrato in tdvadm.t_slf_contrato.slf_contrato_codigo%type) 
     return varchar2
     is
     Begin
        return TDVADM.PKG_slf_utilitarios.fn_retorna_contrato(pContrato);
        
     End fn_RetornaContrato;
     
   function fn_RetornaListaNotas(pNota in TDVADM.T_arm_nota.arm_nota_numero%type,
                                 pCnpj in TDVADM.T_arm_nota.glb_cliente_cgccpfremetente%type,
                                 pSerie in TDVADM.T_arm_nota.arm_nota_serie%type)
    Return Varchar2
    Is
      vRetorno varchar2(200);
    Begin

      vRetorno := '';
      for c_msg in (select an.arm_nota_numero
                    from tdvadm.t_arm_nota an
                    where (an.con_conhecimento_codigo,
                           an.con_conhecimento_serie,
                           an.glb_rota_codigo) in (select an1.con_conhecimento_codigo,
                                                          an1.con_conhecimento_serie,
                                                          an1.glb_rota_codigo
                                                   from tdvadm.t_arm_nota an1
                                                   where an1.arm_nota_numero = pNota
                                                     and an1.glb_cliente_cgccpfremetente = pCnpj
                                                     and an1.arm_nota_serie = pSerie))
      Loop
         vRetorno := substr(vRetorno || lpad(c_msg.arm_nota_numero,9,'0') || '/',1,200);        
      End Loop;
      
      return vRetorno;

    End fn_RetornaListaNotas; 



   function fn_RetornaListaPedidos(pNota in TDVADM.T_arm_nota.arm_nota_numero%type,
                                   pCnpj in TDVADM.T_arm_nota.glb_cliente_cgccpfremetente%type,
                                   pSerie in TDVADM.T_arm_nota.arm_nota_serie%type)
    Return Varchar2
    Is
      vRetorno varchar2(200);
    Begin

      vRetorno := '';
      for c_msg in (select distinct co.arm_coleta_pedido
                    from tdvadm.t_arm_nota an,
                         tdvadm.t_arm_coleta co
                    where (an.con_conhecimento_codigo,
                           an.con_conhecimento_serie,
                           an.glb_rota_codigo) in (select an1.con_conhecimento_codigo,
                                                          an1.con_conhecimento_serie,
                                                          an1.glb_rota_codigo
                                                   from tdvadm.t_arm_nota an1
                                                   where an1.arm_nota_numero = pNota
                                                     and rpad(an1.glb_cliente_cgccpfremetente,20) = pCnpj
                                                     and an1.arm_nota_serie = pSerie)
                      and an.arm_coleta_ncompra = co.arm_coleta_ncompra
                      and an.arm_coleta_ciclo = co.arm_coleta_ciclo)
      Loop
         vRetorno := substr(vRetorno || c_msg.arm_coleta_pedido || '/',1,200);        
      End Loop;
      
      return vRetorno;
      
    End fn_RetornaListaPedidos; 


  function fn_RetornaObservacao(pListaNotas    in TpNota,
                                pListaCargaCli in TpCargaCli,
                                pRetBuscaFrete in TpBuscaVerba,
                                pTpVeiculo     in tdvadm.t_fcf_tpveiculo.fcf_tpveiculo_codigo%type) 
     Return varchar2
    is
     vObs              varchar2(2000);
     vOBS1             varchar2(2000);
     vOBS2             varchar2(2000);
     VdiaMes           char(02);
     VdiaSemana        integer;
     vDiaHora          date;
     vCorteDiaSeguinte char(6) := '120000'; -- Horario Limite
     vDiaDoCodigo      date;
     vCodMercadoria    tdvadm.t_glb_mercadoria.glb_mercadoria_codigo%type;
     vValorMercadoria  tdvadm.t_con_calcconhecimento.con_calcviagem_valor%type;
     vEExpresso        char(1);
     vEQuimico         char(1);
     vAuxiliar         number;
     vNomeVeiculo      TDVADM.T_slf_cliregrasveic.slf_cliregrasveic_nomeveic%type;
     vCodMeso          v_glb_ibge.mesocod%type;
     vNotaMae          tdvadm.t_arm_notavide.arm_notavide_numero%type;
     vListaNotas       varchar2(200);
     vListaPedidos     varchar2(200);
     vDT               tdvadm.t_arm_nota.arm_nota_codcliviagem%type;
     vEmailSol         tdvadm.t_arm_coleta.arm_coleta_emailsolic%type;
     vOnu              tdvadm.t_Arm_Notafichaemerg.glb_onu_codigo%type; 
     vPesoCol          tdvadm.t_arm_coleta.arm_coleta_peso%type; 
     vPesoReal         tdvadm.t_con_calcconhecimento.con_calcviagem_valor%type;
     vPesoCob          tdvadm.t_con_calcconhecimento.con_calcviagem_valor%type;
     vPesoBalanca      tdvadm.t_con_calcconhecimento.con_calcviagem_valor%type;
     vKM               tdvadm.t_con_calcconhecimento.con_calcviagem_valor%type;
     vCTe              char(10);
   Begin
     
        Begin
           select ca.con_calcviagem_valor
             into vPesoCob
           from TDVADM.t_con_calcconhecimento ca
           where ca.con_conhecimento_codigo = pListaNotas.cnConhecimento
             and ca.con_conhecimento_serie = 'XXX'
             and ca.glb_rota_codigo = pListaNotas.cnRotaConhec
             and ca.slf_reccust_codigo = 'I_PSCOBRAD';
       Exception
         When NO_DATA_FOUND Then
             vPesoCob := 0;
         End;   

        Begin
           select ca.con_calcviagem_valor
             into vPesoReal
           from TDVADM.t_con_calcconhecimento ca
           where ca.con_conhecimento_codigo = pListaNotas.cnConhecimento
             and ca.con_conhecimento_serie = 'XXX'
             and ca.glb_rota_codigo = pListaNotas.cnRotaConhec
             and ca.slf_reccust_codigo = 'D_PSREAL ';
       Exception
         When NO_DATA_FOUND Then
             vPesoReal := 0;
         End;   

        Begin
            select ca.con_calcviagem_valor
             into vKM
           from TDVADM.t_con_calcconhecimento ca
           where ca.con_conhecimento_codigo = pListaNotas.cnConhecimento
             and ca.con_conhecimento_serie = 'XXX'
             and ca.glb_rota_codigo = pListaNotas.cnRotaConhec
             and ca.slf_reccust_codigo = 'S_KMPER';
       Exception
         When NO_DATA_FOUND Then
             vKM := 0;
         End;   
       
       Begin
           select sum(np.arm_notapesagem_pesototal)
             into vPesoBalanca
           from tdvadm.t_arm_notapesagem np,
                tdvadm.t_arm_nota an
           where np.arm_nota_sequencia = an.arm_nota_sequencia
             and an.con_conhecimento_codigo = pListaNotas.cnConhecimento
             and an.con_conhecimento_serie = 'XXX'
             and an.glb_rota_codigo = pListaNotas.cnRotaConhec;
       Exception
         When NO_DATA_FOUND Then
             vPesoBalanca := 0;
         End;   

      
      vObs := '';    
   
      vEExpresso := TDVADM.PKG_FIFO_CARREGCTRC.fn_EColetaExpressa(ListaNotas.cnNRCOLETA,ListaNotas.cnNrColetaCiclo);
      vEExpresso := nvl(vEExpresso,'N');
      vEQuimico  := TDVADM.PKG_FIFO_CARREGCTRC.fn_EProdutoQuimico(ListaNotas.cnNOTA,ListaNotas.cnCLIREM,ListaNotas.cnSERIENF);
      vEQuimico := nvl(vEQuimico,'N');
      
      vListaNotas   := fn_RetornaListaNotas(ListaNotas.cnNOTA,ListaNotas.cnCLIREM,ListaNotas.cnSERIENF);
      If vListaNotas = '/' Then
         vListaNotas := null;
      End If;
      vListaPedidos := fn_RetornaListaPedidos(ListaNotas.cnNOTA,ListaNotas.cnCLIREM,ListaNotas.cnSERIENF);
      If vListaPedidos = '/' Then
         vListaPedidos := null;
      End If;
      
      Begin
        Select co.arm_coleta_emailsolic,
               co.arm_coleta_peso
          into vEmailSol,
               vPesoCol
        from tdvadm.t_arm_coleta co
        where co.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
          and co.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo;
      exception
        When OTHERS Then
           vEmailSol := null;
           vPesoCol  := null;
      End;
      
      If vEQuimico = 'S' Then
         Begin
            Select fe.glb_onu_codigo
              into vOnu
            From tdvadm.t_arm_notafichaemerg fe
            where fe.arm_nota_sequencia =  ListaNotas.cnSequencia;
         Exception
           When OTHERS Then
              vOnu := null;
         End;
      Else
         vOnu := null;
      End If;
 
      If pRetBuscaFrete.FCF_TPVEICULO_CODIGO <> TpVFracionado Then
         Begin
            select distinct crv.slf_cliregrasveic_nomeveic
              into vNomeVeiculo
            from TDVADM.t_slf_cliregrasveic crv
            where crv.glb_grupoeconomico_codigo = pListaNotas.cnGRUPOECSAC
              and crv.slf_contrato_codigo = pListaNotas.cnContrato
              and crv.fcf_tpcarga_codigo = pRetBuscaFrete.FCF_TPCARGA_CODIGO
              and trim(crv.fcf_tpveiculo_codigo) = trim(pRetBuscaFrete.FCF_TPVEICULO_CODIGO)
              and rownum = 1;
         exception
            When NO_DATA_FOUND Then
               vNomeVeiculo := '';
         End;
      Else
         vNomeVeiculo := '';
      End If;    

     
      Begin
         select v.arm_notavide_numero
            into vNotaMae
         from tdvadm.t_arm_notavide v
         where v.arm_nota_sequencia = ListaNotas.cnSequencia;   
      exception
        When NO_DATA_FOUND Then
           vNotaMae := null;
        When OTHERS Then
           vNotaMae := null;
        End; 

      if to_char(sysdate,'yyyymmddhh24miss') > to_char(sysdate,'yyyymmdd') || vCorteDiaSeguinte Then
         -- Se passou o Horario de Corte pegar o proximo dia util
         vDiaDoCodigo := f_diautil_proximo(SYSDATE);
      Else
         vDiaDoCodigo := SYSDATE;
      End If;
      Select to_char(vDiaDoCodigo,'dd'),
             to_char(vDiaDoCodigo,'d')
         into VdiaMes,
              VdiaSemana
      From dual; 

      vCodMeso := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'MEC');
--      vCodMeso := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'MEC');

      
      If pListaNotas.cnGRUPOECSAC = '0000' Then /* so para documentar */
         vEExpresso := vEExpresso;
      ElsIf ( pListaNotas.cnContrato = 'C2016080027' ) and ( TRIM(pListaNotas.cnCLISAC) = '21042930000188' )  Then  -- MRO-AMSTED-0816-CRUZEIRO E HORTOLANDIA 
         If ( pListaNotas.cnCOLETA = '05571' ) Then -- Armazem S?o Paulo
            if ( tdvadm.fn_busca_codigoibge(pListaNotas.cnENTREGA,'IBC') = '3519071' ) Then -- Hortolandia
                if pTpVeiculo = TpVCarreta Then
                   if VdiaSemana = Segunda Then
                      vObs := '6096';
                   ElsIf VdiaSemana = Terca Then
                     vObs := '6097';
                   ElsIf VdiaSemana = Quarta Then
                      vObs := '6098';
                   ElsIf VdiaSemana = Quinta Then
                      vObs := '6099';
                   ElsIf VdiaSemana = Sexta Then
                      vObs := '6100';
                   ElsIf VdiaSemana = Sabado Then
                      vObs := '';
                   ElsIf VdiaSemana = Domingo Then
                      vObs := '';
                   End If;
                Elsif pTpVeiculo = TpVTruck Then
                   if VdiaSemana = Segunda Then
                      vObs := '6196';
                   ElsIf VdiaSemana = Terca Then
                      vObs := '6197';
                   ElsIf VdiaSemana = Quarta Then
                      vObs := '6198';
                   ElsIf VdiaSemana = Quinta Then
                      vObs := '6199';
                   ElsIf VdiaSemana = Sexta Then
                      vObs := '6200';
                   ElsIf VdiaSemana = Sabado Then
                      vObs := '';
                   ElsIf VdiaSemana = Domingo Then
                      vObs := '';
                   End If;
                Elsif pTpVeiculo = TpV3_4 Then
                   if VdiaSemana = Segunda Then
                      vObs := '6296';
                   ElsIf VdiaSemana = Terca Then
                      vObs := '6297';
                   ElsIf VdiaSemana = Quarta Then
                      vObs := '6298';
                   ElsIf VdiaSemana = Quinta Then
                      vObs := '6299';
                   ElsIf VdiaSemana = Sexta Then
                      vObs := '6300';
                   ElsIf VdiaSemana = Sabado Then
                      vObs := '';
                   ElsIf VdiaSemana = Domingo Then
                      vObs := '';
                   End If;
                Else
                  vObs := 'Veiculo Nao Passado';
                End If; 
            ElsIf ( tdvadm.fn_busca_codigoibge(pListaNotas.cnENTREGA,'IBC') = '3513405' ) Then -- Cruzeiro
                vObs := '9' || VdiaMes; 
            End IF;
         End If;

         if length(trim(vObs)) > 0  and  length(trim(vObs)) <= 4 Then
            vObs := 'PRACA-' || vObs || ' ';
         End If;

      ElsIf ( pListaNotas.cnContrato = 'C2016080027' ) and ( TRIM(pListaNotas.cnCLISAC) = '01599436000101' )  Then  -- MRO-AMSTED-0816-CRUZEIRO E HORTOLANDIA 
          if ( pListaNotas.cnCOLETA = '05571' ) Then -- Armazem S?o Paulo
             if ( tdvadm.fn_busca_codigoibge(pListaNotas.cnENTREGA,'IBC') = '3519071' ) Then -- Hortolandia
                 if pTpVeiculo = TpVCarreta Then
                    if VdiaSemana = Segunda Then
                       vObs := '2095';
                    ElsIf VdiaSemana = Terca Then
                       vObs := '2096';
                    ElsIf VdiaSemana = Quarta Then
                       vObs := '2097';
                    ElsIf VdiaSemana = Quinta Then
                       vObs := '2098';
                    ElsIf VdiaSemana = Sexta Then
                       vObs := '2099';
                    ElsIf VdiaSemana = Sabado Then
                       vObs := '';
                    ElsIf VdiaSemana = Domingo Then
                       vObs := '';
                    End If;
                 Elsif pTpVeiculo = TpVTruck Then
                    if VdiaSemana = Segunda Then
                       vObs := '2195';
                    ElsIf VdiaSemana = Terca Then
                       vObs := '2196';
                    ElsIf VdiaSemana = Quarta Then
                       vObs := '2197';
                    ElsIf VdiaSemana = Quinta Then
                       vObs := '2198';
                    ElsIf VdiaSemana = Sexta Then
                       vObs := '2199';
                    ElsIf VdiaSemana = Sabado Then
                       vObs := '';
                    ElsIf VdiaSemana = Domingo Then
                       vObs := '';
                    End If;
                 Elsif pTpVeiculo = TpV3_4 Then
                    if VdiaSemana = Segunda Then
                       vObs := '2495';
                    ElsIf VdiaSemana = Terca Then
                       vObs := '2496';
                    ElsIf VdiaSemana = Quarta Then
                       vObs := '2497';
                    ElsIf VdiaSemana = Quinta Then
                       vObs := '2498';
                    ElsIf VdiaSemana = Sexta Then
                       vObs := '2499';
                    ElsIf VdiaSemana = Sabado Then
                       vObs := '';
                    ElsIf VdiaSemana = Domingo Then
                       vObs := '';
                    End If;
                 Elsif pTpVeiculo = TpToco  Then
                    if VdiaSemana = Segunda Then
                       vObs := '2395';
                    ElsIf VdiaSemana = Terca Then
                       vObs := '2396';
                    ElsIf VdiaSemana = Quarta Then
                       vObs := '2397';
                    ElsIf VdiaSemana = Quinta Then
                       vObs := '2398';
                    ElsIf VdiaSemana = Sexta Then
                       vObs := '2399';
                    ElsIf VdiaSemana = Sabado Then
                       vObs := '';
                    ElsIf VdiaSemana = Domingo Then
                       vObs := '';
                    End If;
                 Elsif pTpVeiculo = TpVan  Then
                    if VdiaSemana = Segunda Then
                       vObs := '2595';
                    ElsIf VdiaSemana = Terca Then
                       vObs := '2596';
                    ElsIf VdiaSemana = Quarta Then
                       vObs := '2597';
                    ElsIf VdiaSemana = Quinta Then
                       vObs := '2598';
                    ElsIf VdiaSemana = Sexta Then
                       vObs := '2599';
                    ElsIf VdiaSemana = Sabado Then
                       vObs := '';
                    ElsIf VdiaSemana = Domingo Then
                       vObs := '';
                    End If;
                 Elsif pTpVeiculo = TpFiorino  Then
                    if VdiaSemana = Segunda Then
                       vObs := '2695';
                    ElsIf VdiaSemana = Terca Then
                       vObs := '2696';
                    ElsIf VdiaSemana = Quarta Then
                       vObs := '2697';
                    ElsIf VdiaSemana = Quinta Then
                       vObs := '2698';
                    ElsIf VdiaSemana = Sexta Then
                       vObs := '2699';
                    ElsIf VdiaSemana = Sabado Then
                       vObs := '';
                    ElsIf VdiaSemana = Domingo Then
                       vObs := '';
                    End If;
                       
                 Else
                   vObs := 'Veiculo Nao Passado';
                 End If; 
             ElsIf ( tdvadm.fn_busca_codigoibge(pListaNotas.cnENTREGA,'IBC') = '3513405' ) Then -- Cruzeiro
                 vObs := vObs; 
             End IF;
         End If;

         if length(trim(vObs)) > 0  and  length(trim(vObs)) <= 4 Then
            vObs := 'PRACA-' || vObs || ' ';
         End If;
      Elsif pListaNotas.cnContrato IN ('C2017010106', -- MRO-ALBRAS-0117-XXX
                                       'C4600005946', -- MRO-ALUNORTE-1116-XXX 
                                       'C4600005947'  -- MRO-HYDRO-1216-XXX
                                      ) Then

           If ListaNotas.cnContrato Is not null then
              vObs := vObs || 'Contrato : 4600007245';
           End If;          
           if ListaNotas.cnNRCOLETA is not null Then
              vObs := vObs || 'ID VERBA : [' || ListaNotas.cnNRCOLETA || ']';
           End If;     

           If ( ListaVaux.cnTemCD = 'S' ) Then
              vObs := vObs || ' CARGA DIRETA';
           End If;

           If nvl(vNomeVeiculo,'X') <> 'X' then   
              vObs := vObs || ' VEICULO [' || vNomeVeiculo  || ']';     
           End If;
         
           vObs := vObs || ' CARGA : [' || pListaCargaCli.ccTPCARGACLIDESC || ']';

           If nvl(vListaPedidos,'X') <> 'X' Then
              vObs := vObs || ' Pedido : [' || vListaPedidos || ']';
           End If;

           vObs := vObs || ' FRETE [ <<D_FRPSVO>> ] SEGURO [ <<D_ADVL>> ] PEDAGIO [ <<D_PD>> ] QTDE COLETAS [ <<S_QTDECOL>> ]';

      Elsif pListaNotas.cnContrato IN ('C2016080025') Then -- MRO-VOTORANTIM-0816-ZINCO
  
        vObs := '';
/*        If vListaPedidos is not null Then
            vObs := vObs || ' Pedido - [ ' || vListaPedidos || ' ] ';
        End If;         

         Select an.arm_nota_codclicoleta
           into vDT
         From tdvadm.t_arm_nota an
         where an.arm_nota_sequencia = pListaNotas.cnSequencia;
         
         If vDT is not null Then
            vObs := vObs || ' DT - [ ' || vDT || ' ] ';
        End If;     */    
        



         vObs := vObs || 'TIPO CARGA [';
         If ListaNotas.cnEntregaCol = 'E' Then
            If vEQuimico = 'S' Then
               vObs := vObs || 'EQ';
            Else
               vObs := vObs || 'E0';
            End If;
         Else
            If    pListaCargaCli.ccTPCARGACLI in ('01','11') Then -- LOTACAO
               If    ( vEQuimico = 'S' ) and ( vEExpresso = 'S' ) Then
                  vObs := vObs || 'QE';
               ElsIf ( vEQuimico = 'N' ) and ( vEExpresso = 'S' ) Then
                  vObs := vObs || 'LE';
               ElsIf ( vEQuimico = 'S' ) and ( vEExpresso = 'N' ) Then
                  vObs := vObs || 'LQ';
               Else
                  vObs := vObs || 'L0';
               End If;                        
            ElsIf pListaCargaCli.ccTPCARGACLI in ('02','12') Then -- FRACIONADO
               If vEQuimico = 'S' Then
                  vObs := vObs || 'FQ';
               Else
                  vObs := vObs || 'F0';
               End If;   
            End If;
         End If; 
         If vCodMeso = 'xxxx' Then -- So para documentar
            vCodMeso := vCodMeso;
         ElsIf vCodMeso = '3515' Then   -- Metropolitana de S?o Paulo
            vObs := vObs || '01';
         ElsIf vCodMeso = '3107' Then   -- Metropolitana de Belo Horizonte
            vObs := vObs || '02';
         ElsIf vCodMeso = '3112' Then   -- Zona da Mata
            vObs := vObs || '03';
         ElsIf vCodMeso = '3110' Then   -- Sul/Sudeste de Minas
            vObs := vObs || '04';
         ElsIf vCodMeso = '3512' Then   -- Macro Metropolitana Paulista
            vObs := vObs || '05';
         ElsIf vCodMeso = '3507' Then   -- Campinas
            vObs := vObs || '06';
         ElsIf vCodMeso = '3105' Then   -- Triangulo Mineiro
            vObs := vObs || '07';
         ElsIf vCodMeso = '3502' Then   -- Ribeir?o Preto
            vObs := vObs || '08';
         ElsIf vCodMeso = '3306' Then   -- Metropolitana do Rio de Janeiro
            vObs := vObs || '09';
         ElsIf vCodMeso = '3108' Then   -- Vale do Rio Doce
            vObs := vObs || '10';
         ElsIf vCodMeso = '3111' Then   -- Campo das Vertentes
            vObs := vObs || '11';
         ElsIf vCodMeso = '3203' Then   -- Central Espirito-Santense
            vObs := vObs || '12';
         ElsIf vCodMeso = '4206' Then   -- Sul Catarinense
            vObs := vObs || '13';
         ElsIf vCodMeso = '4204' Then   -- Vale do Itajai
            vObs := vObs || '14';
            
       -- Acrescentando novas meso. Felipe por Felipe Sousa
       
         ElsIf vCodMeso = '3513' Then 
            vObs := vObs || '15';
         ElsIf vCodMeso = '4110' Then 
            vObs := vObs || '16';
         ElsIf vCodMeso = '3503' Then 
            vObs := vObs || '17';
         ElsIf vCodMeso = '3505' Then 
            vObs := vObs || '18';
         ElsIf vCodMeso = '3510' Then 
            vObs := vObs || '19';
         ElsIf vCodMeso = '3504' Then
            vObs := vObs || '20';
         ElsIf vCodMeso = '3511' Then
            vObs := vObs || '21';
         ElsIf vCodMeso = '3514' Then
            vObs := vObs || '22';
         ElsIf vCodMeso = '3509' Then
            vObs := vObs || '23';
         ElsIf vCodMeso = '3506' Then
            vObs := vObs || '24';
         ElsIf vCodMeso = '3508' Then
            vObs := vObs || '25';
         ElsIf vCodMeso = '3501' Then
            vObs := vObs || '26';
         ElsIf vCodMeso = '3304' Then
            vObs := vObs || '27';
         ElsIf vCodMeso = '3303' Then
            vObs := vObs || '28';
         ElsIf vCodMeso = '3301' Then
            vObs := vObs || '29';
         ElsIf vCodMeso = '3302' Then
           vObs := vObs || '30';
         ElsIf vCodMeso = '3305' Then
           vObs := vObs || '31';
         ElsIf vCodMeso = '3106' Then
           vObs := vObs || '32';
         ElsIf vCodMeso = '3103' Then
           vObs := vObs || '33';
         ElsIf vCodMeso = '3101' Then
           vObs := vObs || '34';
         ElsIf vCodMeso = '3102' Then
           vObs := vObs || '35';
         ElsIf vCodMeso = '3109' Then
           vObs := vObs || '36';
         ElsIf vCodMeso = '3104' Then
           vObs := vObs || '37';
         ElsIf vCodMeso = '3202' Then
           vObs := vObs || '38';
         ElsIf vCodMeso = '3201' Then
           vObs := vObs || '39';
         ElsIf vCodMeso = '3204' Then
           vObs := vObs || '40';
         ElsIf vCodMeso = '5203' Then
           vObs := vObs || '41';
         ElsIf vCodMeso = '5204' Then
           vObs := vObs || '42';
         ElsIf vCodMeso = '5201' Then
           vObs := vObs || '43';
         ElsIf vCodMeso = '5202' Then
           vObs := vObs || '44';
         ElsIf vCodMeso = '5205' Then
           vObs := vObs || '45';
         ElsIf vCodMeso = '4102' Then
           vObs := vObs || '46';
         ElsIf vCodMeso = '4105' Then
           vObs := vObs || '47';
         ElsIf vCodMeso = '4108' Then
           vObs := vObs || '48';
         ElsIf vCodMeso = '4101' Then
           vObs := vObs || '49';
         ElsIf vCodMeso = '4103' Then
           vObs := vObs || '50';
         ElsIf vCodMeso = '4104' Then
           vObs := vObs || '51';
         ElsIf vCodMeso = '4106' Then
           vObs := vObs || '52';
         ElsIf vCodMeso = '4109' Then
           vObs := vObs || '53';
         ElsIf vCodMeso = '4107' Then
           vObs := vObs || '54';
         ElsIf vCodMeso = '2903' Then
           vObs := vObs || '55';
         ElsIf vCodMeso = '2906' Then
           vObs := vObs || '56';
         ElsIf vCodMeso = '2901' Then
           vObs := vObs || '57';
         ElsIf vCodMeso = '2905' Then
           vObs := vObs || '58';
         ElsIf vCodMeso = '2904' Then
           vObs := vObs || '59';
         ElsIf vCodMeso = '2907' Then
           vObs := vObs || '60';
         ElsIf vCodMeso = '2902' Then
           vObs := vObs || '61';
         ElsIf vCodMeso = '2603' Then
           vObs := vObs || '62';
         ElsIf vCodMeso = '5002' Then
           vObs := vObs || '63';
         ElsIf vCodMeso = '4303' Then
           vObs := vObs || '64';
         ElsIf vCodMeso = '4304' Then
           vObs := vObs || '65';
         End If;   
         vObs := vObs || ']';  
   
      ElsIf pListaNotas.cnContrato IN ('C5900010792') Then -- LOT-VALE-0411-TCN

         If ListaNotas.cnContrato Is not null then
            vObs := vObs || 'Contrato : [' || replace(ListaNotas.cnContrato,'/','-') || ']';
         End If;          

         If vNotaMae is not null Then
            vObs := vObs || 'Nota Mae : [' || vNotaMae || ']';
         End If;
         
         If nvl(vListaPedidos,'X') <> 'X' Then
            vObs := vObs || ' Pedido - [' || vListaPedidos || ']';
         End If;
         
      ElsIf pListaNotas.cnContrato = 'C2017090115' Then -- MRO-MS-0917-FIBRIA
      
         If pListaNotas.cnCodMercadoria = 'EX' Then

            Begin
               select ca.con_calcviagem_valor
                 into vAuxiliar
               from TDVADM.t_con_conhecimento c,
                    TDVADM.t_con_calcconhecimento ca
               where c.con_conhecimento_codigo = pListaNotas.cnConhecimento
                 and c.glb_rota_codigo = pListaNotas.cnRotaConhec
                 and c.con_conhecimento_codigo = ca.con_conhecimento_codigo
                 and c.con_conhecimento_serie = ca.con_conhecimento_serie
                 and c.glb_rota_codigo = ca.glb_rota_codigo
                 and ca.slf_reccust_codigo = 'I_VLICMS';
                 vAuxiliar := vAuxiliar * 0.80;
            Exception
               When NO_DATA_FOUND Then
                  vAuxiliar := 0;
            End;
           
            vObs := vObs || 'SUSPENSAO PIS/COFINS, LEI 10.865 - IN 595/05 ';
            vObs := vObs || 'E ATO DECLARATORIO 96/2010 BASE DE CALCULO R$ <<I_BSCLICMS>> - VALOR DO IMPOSTO RETIDO R$ ' || TDVADM.F_MASCARA_VALOR(vAuxiliar,10,2) ;
         End If;     
      ElsIf pListaNotas.cnContrato = 'C2015120020' Then --MRO-CBA-1215-XXX
         vObs := '';
         If ( pListaNotas.cnCOLETA = '05571' ) Then -- Armazem S?o Paulo
            If pListaCargaCli.ccTPCARGACLI in ('01','11') Then -- LOTACAO
               vObs := 'CARGA LOTA025 - ';
               if    pTpVeiculo = TpVUC      Then 
                  vObs := vObs || 'VM 2E 2.5 VUC - ';
               ElsIf pTpVeiculo = TpToco     Then
                  vObs := vObs || 'VM 2E 6.5 TOCO - ';
               Elsif pTpVeiculo = TpVTruck   Then      
                  vObs := vObs || 'VM 3E 14 TRUCK - ';
               ElsIf pTpVeiculo = TpVCarreta Then
                  vObs := vObs || 'VM 5E 25 CARRETA - ';
               End If;
            ElsIf pListaCargaCli.ccTPCARGACLI in ('02','12') Then -- FRACIONADO
               vObs := 'CARGA FRAC - ';
               -- Ver Faixa de Peso
               select ca.con_calcviagem_valor
                 into vAuxiliar
               from TDVADM.t_con_calcconhecimento ca
               where ca.con_conhecimento_codigo = pListaNotas.cnConhecimento
                 and ca.glb_rota_codigo = pListaNotas.cnRotaConhec
                 and ca.slf_reccust_codigo = 'I_PSCOBRAD';
               
               If vAuxiliar <= 10 Then
                  vObs := vObs || '0 - 10 - ';
               ElsIf vAuxiliar <= 20 Then
                  vObs := vObs || '10 - 20 - ';
               ElsIf vAuxiliar <= 30 Then
                  vObs := vObs || '20 - 30 - ';
               ElsIf vAuxiliar <= 40 Then
                  vObs := vObs || '30 - 40 - ';
               ElsIf vAuxiliar <= 50 Then
                  vObs := vObs || '40 - 50 - ';
               ElsIf vAuxiliar <= 60 Then
                  vObs := vObs || '50 - 60 - ';
               ElsIf vAuxiliar <= 70 Then
                  vObs := vObs || '60 - 70 - ';
               ElsIf vAuxiliar <= 80 Then
                  vObs := vObs || '70 - 80 - ';
               ElsIf vAuxiliar <= 90 Then
                  vObs := vObs || '80 - 90 - ';
               ElsIf vAuxiliar <= 100 Then
                  vObs := vObs || '90 - 100 - ';
               ElsIf vAuxiliar <= 200 Then
                  vObs := vObs || '100 - 200 - ';
               ElsIf vAuxiliar <= 300 Then
                  vObs := vObs || '200 - 300 - ';
               ElsIf vAuxiliar <= 400 Then
                  vObs := vObs || '300 - 400 - ';
               ElsIf vAuxiliar <= 500 Then
                  vObs := vObs || '400 - 500 - ';
               ElsIf vAuxiliar <= 1000 Then
                  vObs := vObs || '500 - 1000 - ';
               End If;
            End If;
         Else
            If pListaCargaCli.ccTPCARGACLI in ('01','11') Then -- LOTACAO
               vObs := 'CARGA LOTA - ';
               if    pTpVeiculo = TpVUC      Then 
                  vObs := vObs || 'VM 2E 2.5 VUC - ';
               ElsIf pTpVeiculo = TpToco     Then
                  vObs := vObs || 'VM 2E 6.5 TOCO - ';
               Elsif pTpVeiculo = TpVTruck   Then      
                  vObs := vObs || 'VM 3E 14 TRUCK - ';
               ElsIf pTpVeiculo = TpVCarreta Then
                  vObs := vObs || 'VM 5E 25 CARRETA - ';
               End If;
            End If;
         End If;

         Begin
            select count(distinct n.arm_coleta_ncompra || n.arm_coleta_ciclo)
              into vAuxiliar
              from TDVADM.t_arm_nota n,
                   tdvadm.t_arm_coleta c
             where n.con_conhecimento_codigo = pListaNotas.cnConhecimento
               and n.glb_rota_codigo = pListaNotas.cnRotaConhec
               and n.con_conhecimento_serie = 'XXX'
               and c.arm_coleta_ncompra = n.arm_coleta_ncompra
               and c.arm_coleta_ciclo   = n.arm_coleta_ciclo
               and c.arm_coletaorigem_cod = '4';
               
            update TDVADM.t_con_calcconhecimento ca
               set ca.con_calcviagem_valor = vAuxiliar
             where ca.con_conhecimento_codigo = pListaNotas.cnConhecimento
               and ca.glb_rota_codigo = pListaNotas.cnRotaConhec
               and ca.slf_reccust_codigo = 'S_QTDECOL';
         exception
           When NO_DATA_FOUND Then
               vAuxiliar := 0;
           End;                 
         If vAuxiliar > 0 then
            If pListaCargaCli.ccTPCARGACLI  not in ('01') Then
               vObs := vObs || 'TC' || trim(Lpad(vAuxiliar,2,'0')) || ' - ';
            End if;
         End If; 
           

         If    ( vEQuimico = 'S' ) and ( vEExpresso = 'N' ) Then
            vObs := vObs || 'IMO ';
         ElsIf ( vEQuimico = 'N' ) and ( vEExpresso = 'S' ) Then
            vObs := vObs || 'EMER ';
         ElsIf ( vEQuimico = 'S' ) and ( vEExpresso = 'S' ) Then
            vObs := vObs || 'IMO - EMER ';
         End If;                        

         Select an.arm_nota_codclicoleta
           into vDT
         From tdvadm.t_arm_nota an
         where an.arm_nota_sequencia = pListaNotas.cnSequencia;
         
         If vDT is not null Then
            vObs := vObs || ' DT - [ ' || vDT || ' ] ';
        End If;         
        
      ElsIf pListaNotas.cnContrato = 'C2018010117' Then  --  0541 - MRO-SUZANO IMPERATRIZ-0118-XXX


         Select an.arm_nota_codcliviagem
           into vDT
         From tdvadm.t_arm_nota an
         where an.arm_nota_sequencia = pListaNotas.cnSequencia;
         

         
         If nvl(vListaPedidos,'X') <> 'X' Then
            vObs := vObs || ' Pedido - [' || vListaPedidos || ']';
         End If;
         If nvl(vDT,'X') <> 'X' Then
            vObs := vObs || ' DT - [' || vDT || ']';
         End If;
      

         Begin
         select an.con_conhecimento_codigo || an.glb_rota_codigo
           into vCTe
         from tdvadm.t_arm_nota an
         where an.glb_tpcarga_codigo = 'CO'
           and an.arm_nota_numero = ListaNotas.cnNUMERO
           and an.glb_cliente_cgccpfremetente = ListaNotas.cnCLIREM
           and an.arm_nota_serie = ListaNotas.cnSERIENF;
          exception
            When NO_DATA_FOUND Then
               vCTe := null;
            End;

         If vCTe is not null Then
            vObs := vObs || 'Operac?o de redespacho  referente ao  CT-e [' || vCTe || '] ';          
         End If;

      Elsif pListaNotas.cnContrato in ('C7000067442','C4600006653') Then -- MRO-USIMINAS-0118-XXX e USIMINAS-MECANICA.

           Select an.arm_nota_codclicoleta
             into vDT
           From tdvadm.t_arm_nota an
           where an.arm_nota_sequencia = pListaNotas.cnSequencia;
        
           If substr(ListaNotas.cnCLISAC,1,8) = '17500224' Then
              vObs := vObs || 'CONTRATO [ 4600006653 ] ' ;
           ElsIf substr(ListaNotas.cnCLISAC,1,8) = '12056613' Then
              vObs := vObs || 'CONTRATO [ 4600151774 ] ' ;
           ElsIf substr(ListaNotas.cnCLISAC,1,8) = '17500224' Then
              vObs := vObs || 'CONTRATO [ 4600006653 ] ' ;
           ElsIf substr(ListaNotas.cnCLISAC,1,8) = '42956441' Then
              vObs := vObs || 'CONTRATO [ 4600151478 ] ' ;
           ElsIf substr(ListaNotas.cnCLISAC,1,8) = '60894730' Then
              vObs := vObs || 'CONTRATO [ 4600151478 ] ' ;
           ElsIf substr(ListaNotas.cnCLISAC,1,8) = '02830943' Then
              vObs := vObs || 'CONTRATO [ 4600151775 ] ' ;
           End If;
        
        
           If nvl(vDT,'X') <> 'X' Then
              vObs := vObs || ' DT - [' || vDT || '] ';
           End If;

           if ListaNotas.cnNRCOLETA is not null Then
              vObs := vObs || ' COLETA : [' || ListaNotas.cnNRCOLETA || '] ';
           End If;     
           
           If pRetBuscaFrete.SLF_CALCFRETEKM_CODCLI is not null Then
              vObs := vObs || ' CODCLI : [' || pRetBuscaFrete.SLF_CALCFRETEKM_CODCLI || '] ';
           End If;
           
           If    ( vEQuimico = 'S' ) Then
              vObs := vObs || ' [PRODUTO QUIMICO] ';
           End IF;
        
           If ( vEExpresso = 'S' ) Then
              vObs := vObs || ' [EXPRESSO] ';
           End If;
           
           If nvl(vListaPedidos,'X') <> 'X' Then
              vObs := vObs || ' Pedido - [' || vListaPedidos || '] ';
           End If;
           
      Elsif pListaNotas.cnContrato in ('C2020030005') Then
           
           if ListaNotas.cnNRCOLETA is not null Then
              vObs := vObs || ' COLETA : [' || ListaNotas.cnNRCOLETA || '] ';
           End If; 
           
           If nvl(vListaPedidos,'X') <> 'X' Then
              vObs := vObs || ' Pedido - [' || vListaPedidos || '] ';
           End If;  
           
      Elsif pListaNotas.cnContrato in ('C2019071135') Then

           if ListaNotas.cnNRCOLETA is not null Then
              vObs := vObs || ' COLETA : [' || ListaNotas.cnNRCOLETA || '] ';
           End If;     
           
           If pRetBuscaFrete.SLF_CALCFRETEKM_CODCLI is not null Then
              vObs := vObs || ' CODCLI : [' || pRetBuscaFrete.SLF_CALCFRETEKM_CODCLI || '] ';
           End If;
           
           If    ( vEQuimico = 'S' ) Then
              vObs := vObs || ' [PRODUTO QUIMICO] ';
           End IF;
        
           If ( vEExpresso = 'S' ) Then
              vObs := vObs || ' [EXPRESSO] ';
           End If;
           
           If nvl(vListaPedidos,'X') <> 'X' Then
              vObs := vObs || ' Pedido - [' || vListaPedidos || '] ';
           End If;
           
           vObs := vObs || ' Notas - [' || pListanotas.cnNOTA||'] ';
           
           vObs := vObs || ' Notas - [' || pListanotas.cnEMBALAGEM1||'] ';
      
    	Elsif pListaNotas.cnContrato in ('C2019041131') Then -- LOT-GUTIERREZ-0419
        
           vObs := vObs || 'CONTRATO [ ' || pListaNotas.cnContrato ||' ] ' ; 

           if ListaNotas.cnNRCOLETA is not null Then
              vObs := vObs || ' COLETA : [' || ListaNotas.cnNRCOLETA || '] ';
           End If;     
           
           If pRetBuscaFrete.SLF_CALCFRETEKM_CODCLI is not null Then
              vObs := vObs || ' CODCLI : [' || pRetBuscaFrete.SLF_CALCFRETEKM_CODCLI || '] ';
           End If;
           
           If    ( vEQuimico = 'S' ) Then
              vObs := vObs || ' [PRODUTO QUIMICO] ';
           End IF;
        
           If ( vEExpresso = 'S' ) Then
              vObs := vObs || ' [EXPRESSO] ';
           End If;
           
           If nvl(vListaPedidos,'X') <> 'X' Then
              vObs := vObs || ' Pedido - [' || vListaPedidos || '] ';
           End If;
            
      Elsif pListaNotas.cnGRUPOECSAC = '0535' Then   /* ARCELORMITTAL */
         vObs := null; 
         if pTpVeiculo = TpVCarreta Then
            if vEExpresso = 'S' Then
               vObs := 'WJ';
            End If;   
         ElsIf pTpVeiculo = TpVTruck Then
            if vEExpresso = 'S' Then
               vObs := 'WX';
            End If;   
         ElsIf pTpVeiculo = TpV3_4 Then
            if vEExpresso = 'S' Then
               vObs := 'WM';
            End If;   
         ElsIf pTpVeiculo = TpVUtilitario Then 
            if vEExpresso = 'S' Then
               vObs := 'WL';
            End If;   
         End If;
         if vObs is not null Then
            vObs := 'Veiculo - ' || vObs ;
         End If;
          
         vObs := vObs || ' Intinerario - ' || pRetBuscaFrete.SLF_CALCFRETEKM_CODCLI;
      
         If pListaNotas.cnNRCOLETA is not null Then
            vObs := vObs || ' Coleta - ' || pListaNotas.cnNRCOLETA;
         End If;
         
         If nvl(vListaPedidos,'X') <> 'X' Then
            vObs := vObs || ' Pedido - [' || vListaPedidos || ']';
         End If;
        
         If ( vEExpresso = 'S' ) and ( pListaCargaCli.ccPERCTEX <> 1 ) Then
            vObs := vObs || ' Emergencial - ' || trim(to_char(round(( 1 - pListaCargaCli.ccPERCTEX)*100,0))) || '%';
         End If;
      
      ElsIf pListaNotas.cnGRUPOECSAC = '0570' then   /* CSA */
         vObs := null; 

         If ListaNotas.cnContrato Is not null then
            vObs := vObs || 'Contrato : [' || replace(ListaNotas.cnContrato,'/','-') || '] ';
         End If;          
           
         If ListaNotas.cnContrato Is not null then
            vObs := vObs || 'MEMORIA CALCULO : [' || V_ARM_CARREGAMENTO || '] ';
         End If;          

         If pRetBuscaFrete.SLF_CALCFRETEKM_CODCLI is not null Then
             vObs := vObs || 'ID VERBA : [' || pRetBuscaFrete.SLF_CALCFRETEKM_CODCLI || '] ';
         End If;          
           
         if trunc(sysdate) >= '21/03/2016' Then
            If ListaNotas.cnNOTADI is not null Then
               vObs := vObs || 'DI : [' || ListaNotas.cnNOTADI || '] ';
            End If;
         End If;   
           
         if ListaNotas.cnNRCOLETA is not null Then
            vObs := vObs || 'COLETA : [' || ListaNotas.cnNRCOLETA || '] ';
         End If;     

         If pRetBuscaFrete.FCF_TPVEICULO_CODIGO <> TpVFracionado Then
           Begin
            select distinct crv.slf_cliregrasveic_nomeveic
              into vNomeVeiculo
            from TDVADM.t_slf_cliregrasveic crv
            where crv.glb_grupoeconomico_codigo = pListaNotas.cnGRUPOECSAC
              and crv.slf_contrato_codigo = pListaNotas.cnContrato
              and crv.fcf_tpcarga_codigo = pRetBuscaFrete.FCF_TPCARGA_CODIGO
              and trim(crv.fcf_tpveiculo_codigo) = trim(pRetBuscaFrete.FCF_TPVEICULO_CODIGO);
            exception
              When NO_DATA_FOUND Then
                  vNomeVeiculo := '';
              End;
              
            If nvl(vNomeVeiculo,'X') <> 'X' then   
               vObs := vObs || ' VEICULO [' || vNomeVeiculo  || ']';     
            End If;
         End If;


         If ( vEExpresso = 'S' ) and ( pListaCargaCli.ccPERCTEX <> 1 ) Then
            vObs := vObs || ' CARGA EXPRESSA - ' || trim(to_char(round(( 1 - pListaCargaCli.ccPERCTEX)*100,0))) || '% ';
         End If;

         If ( vEQuimico = 'S' ) and ( pListaCargaCli.ccPERCTQM <> 1 ) Then
            vObs := vObs || ' CARGA COM PRODUTO QUIMICO - ' || trim(to_char(round(( 1 - pListaCargaCli.ccPERCTQM)*100,0))) || '% ';
         End If;
      ElsIf TRIM(pListaNotas.cnCLISAC) = '31985633000120' Then  /* PISA INDUSTRIA DE PAPEIS LTDA. */
         if nvl(vCodMercadoria,'00') = '69' Then
             Begin
             select c.glb_mercadoria_codigo,
                    ca.con_calcviagem_valor
               into vCodMercadoria,
                    vValorMercadoria
             from TDVADM.t_con_conhecimento c,
                  TDVADM.t_con_calcconhecimento ca
             where c.con_conhecimento_codigo = pListaNotas.cnConhecimento
               and c.glb_rota_codigo = pListaNotas.cnRotaConhec
               and c.con_conhecimento_codigo = ca.con_conhecimento_codigo
               and c.con_conhecimento_serie = ca.con_conhecimento_serie
               and c.glb_rota_codigo = ca.glb_rota_codigo
               and ca.slf_reccust_codigo = 'I_VLMR';
             Exception
               When NO_DATA_FOUND Then
                  vCodMercadoria := null;
                  vValorMercadoria := null;
               End;
               If vValorMercadoria is not null Then
                  vObs := 'VALOR TOTAL DA MERCADORIA P/ EFEITO DE SEGURO: R$ ' || f_mascara_valor(vValorMercadoria * 1.6417,15,2) ;  
               End If;
           End If;

      ElsIf TRIM(pListaNotas.cnROTA) in ('060','061') Then /*Santos */
           Begin
              Select CASE nvl(A1.ARM_COLETA_NORMALIMPEXP,'N')   
                         WHEN 'N' Then replace (SUBSTR(A1.ARM_COLETA_OBS,346, 88), chr(13), '')
                         WHEN 'I' Then 'DI-' || a1.arm_coleta_direserva || ' RF CLI-' || a1.arm_coleta_codcli || ' RF DESP-' || a1.arm_coleta_coddesp || ' NAVIO-' || a1.arm_coleta_navio
                         WHEN 'E' Then 'RESERV-' || a1.arm_coleta_direserva || ' RF CLI-' || a1.arm_coleta_codcli || ' RF DESP-' || a1.arm_coleta_coddesp || ' NAVIO-' || a1.arm_coleta_navio
                      END COLETA_01OBS,
                      CASE A1.ARM_COLETA_NORMALIMPEXP   
                         WHEN 'N' Then replace (SUBSTR(A1.ARM_COLETA_OBS,434, 88), chr(13), '')
                         WHEN 'I' Then 'CONT-'||a1.arm_coleta_containertp||'PES-'||a1.arm_coleta_containercod||' COLETA-'|| a1.arm_coleta_terminalcol ||' ENTREGA-'||a1.arm_coleta_terminalent
                         WHEN 'E' Then 'CONT-'||a1.arm_coleta_containertp||'PES-'||a1.arm_coleta_containercod||' COLETA-'|| a1.arm_coleta_terminalcol ||' ENTREGA-'||a1.arm_coleta_terminalent||' PORTO-'|| a1.arm_coleta_porto
                      END COLETA_02OBS
                into vOBS1,
                     vOBS2
              From TDVADM.t_arm_coleta a1
              where a1.arm_coleta_ncompra = pListaNotas.cnNRCOLETA
                and a1.arm_coleta_ciclo = pListaNotas.cnNrColetaCiclo;
           Exception
             WHEN NO_DATA_FOUND Then
                vOBS1 := '';
                vOBS2 := '';
             End ;     
        
           vObs := trim(vOBS1) || ' ' || trim(vOBS2);  

      ElsIf pListaNotas.cnGRUPOECSAC = '0561' then   /* APERAM */
          -- Nao tem mais msg especifica
          vObs := '';

      Elsif pListaNotas.cnGRUPOECSAC = '0569' Then   /* CBA */

         If ListaNotas.cnContrato Is not null then
            vObs := vObs || 'Contrato : [' || replace(ListaNotas.cnContrato,'/','-') || ']';
         End If;          
         if pRetBuscaFrete.SLF_CALCFRETEKM_CODCLI is not null Then
            vObs := vObs || 'ID VERBA : [' || pRetBuscaFrete.SLF_CALCFRETEKM_CODCLI || ']';
         End If;          
         if ListaNotas.cnNRCOLETA is not null Then
            vObs := vObs || 'ID VERBA : [' || ListaNotas.cnNRCOLETA || ']';
         End If;     

         If ( vEExpresso = 'S' ) and ( pListaCargaCli.ccPERCTEX <> 1 ) Then
            vObs := vObs || ' CARGA EXPRESSA - ' || trim(to_char(round(( 1 - pListaCargaCli.ccPERCTEX)*100,0))) || '%';
         End If;

         If ( ListaVaux.cnTemCD = 'S' ) Then
            vObs := vObs || ' CARGA DIRETA ';
         End If;

         If ( vEQuimico = 'S' ) and ( pListaCargaCli.ccPERCTQM <> 1 ) Then
            vObs := vObs || ' IMO - ' || trim(to_char(round(( 1 - pListaCargaCli.ccPERCTQM)*100,0))) || '%';
         End If;
         
         
       
              
         If nvl(vNomeVeiculo,'X') <> 'X' then   
            vObs := vObs || ' VEICULO [' || vNomeVeiculo  || ']';     
         End If;

         vObs := vObs || ' CARGA : [' || pListaCargaCli.ccTPCARGACLIDESC || ']';

         vObs := vObs || ' FRETE [ <<D_FRPSVO>> ] SEGURO [ <<D_ADVL>> ] PEDAGIO [ <<D_PD>> ] QTDE COLETAS [ <<S_QTDECOL>> ]';

      ElsIf pListaNotas.cnContrato = 'C2018010119' Then -- MRO-RAIZEN-0119-XXX
--Campos rodape CTE ? Devera constar no rodape do Cte ? nessa ordem se possivel: 
      -- Ordem de coleta: _____  >> 
      -- Pedido de compra: _____ >> 
      -- NF: _____; 
      -- Tipo de carga: _____; 
      -- Tipo de veiculo: quando aplicavel; 
      -- peso informado na OC, 
      -- ONU informado na OC 
      -- Solicitante: e-mail solicitante da OC.
      
         vObs := '';
         if ListaNotas.cnNRCOLETA is not null Then
            vObs := vObs || 'Ordem de coleta : [' || ListaNotas.cnNRCOLETA || ']';
         End If;     
      
         If nvl(vListaPedidos,'X') <> 'X' Then
            vObs := vObs || ' Pedido de compra : [' || vListaPedidos || ']';
         End If;

         If nvl(vListaNotas,'X') <> 'X' Then
            vObs := vObs || ' NF : [' || vListaNotas || ']';
         End If;

         vObs := vObs || ' Tipo de carga : [' || pListaCargaCli.ccTPCARGACLIDESC || ']';

           If nvl(vNomeVeiculo,'X') <> 'X' then   
              vObs := vObs || ' Tipo de veiculo : [' || vNomeVeiculo  || ']';     
           End If;
           
           If vEQuimico = 'S' Then
              vObs := vObs || ' ONU informado na OC : [' || vOnu || ']'; 
           End If;  
       
       vObs := vObs || 'COD CLI [' || pRetBuscaFrete.SLF_CALCFRETEKM_CODCLI  || '] ';
       
       vObs := vObs || 'PBT [' || vPesoBalanca  || '] ';
       
       vObs := vObs || 'KM [' || vKM  || '] ';

       vObs := vObs || 'PESO REAL [' || vPesoReal   || '] ';

       vObs := vObs || 'PESO COBRADO [' || vPesoCob  || '] ';

          If nvl(vPesoCol,0) > 0 Then
              vObs := vObs || ' Peso informado OC : [' || vPesoCol || ']';              
           End If;
           
           vObs := vObs || 'CARREGAMENTO [' || V_ARM_CARREGAMENTO  || '] ';
       
         If  nvl(vEmailSol,'X') <> 'X' Then
              vObs := vObs || ' Solicitante : [' || vEmailSol || ']';
         End IF;
       
         vObs := vObs || ' /TDV: ';
       
         vObs := vObs || 'CONTRATO [' ||  ListaNotas.cnContrato  || '] ';
         
         vObs := vObs || ' Notas - [' || pListanotas.cnNOTA||'] ';
           
         vObs := vObs || ' Notas - [' || pListanotas.cnEMBALAGEM1||'] ';
       
      ElsIf pListaNotas.cnContrato = 'C2019121134' Then -- MRO-PETROPOLIS-1219-XXX  
          /*
            Sirlano 14/01/2020
          */      
           If pRetBuscaFrete.SLF_CALCFRETEKM_CODCLI is not null Then
              vObs := vObs || ' CODCLI : [' || pRetBuscaFrete.SLF_CALCFRETEKM_CODCLI || '] ';
           End If;
           
           If nvl(vListaPedidos,'X') <> 'X' Then
              vObs := vObs || ' Pedido - [' || vListaPedidos || '] ';
           End If;
        
        ElsIf pListaNotas.cnContrato in ('C2019120027','C2020050006') Then --ANGLO
          
        If nvl(vListaPedidos,'X') <> 'X' Then
              vObs := vObs || ' Pedido - [' || vListaPedidos || '] ';
         End If;
         
         if ListaNotas.cnNRCOLETA is not null Then
            vObs := vObs || 'Ordem de coleta : [' || ListaNotas.cnNRCOLETA || ']';
         End If;
         
         If  nvl(vEmailSol,'X') <> 'X' Then
              vObs := vObs || ' Solicitante : [' || vEmailSol || ']';
         End IF;
         
         If    ( vEQuimico = 'S' ) and ( vEExpresso = 'N' ) Then
            vObs := vObs || 'IMO ';
         ElsIf ( vEQuimico = 'N' ) and ( vEExpresso = 'S' ) Then
            vObs := vObs || 'EMER ';
         ElsIf ( vEQuimico = 'S' ) and ( vEExpresso = 'S' ) Then
            vObs := vObs || 'IMO - EMER ';
         End If;     
         
        vObs := vObs || 'CONTRATO [' ||  ListaNotas.cnContrato  || '] '; 
        
        
         
        ElsIf pListaNotas.cnContrato = 'C2020020002' Then --MRO-PRADA-0220-XXX
          
         if ListaNotas.cnNRCOLETA is not null Then
            vObs := vObs || 'Ordem de coleta : [' || ListaNotas.cnNRCOLETA || ']';
         End If;
         
         vObs := vObs || 'CARREGAMENTO [' || V_ARM_CARREGAMENTO  || '] ';
         
         If pRetBuscaFrete.SLF_CALCFRETEKM_CODCLI is not null Then
              vObs := vObs || ' CODCLI : [' || pRetBuscaFrete.SLF_CALCFRETEKM_CODCLI || '] ';
         End If;
         
         if trim(ListaNotas.cnCLISAC) = '56993900000131' then
           vObs := vObs || 'CONTRATO [' ||  'S14222651A'  || '] ';
         end if;
         
         if trim(ListaNotas.cnCLISAC) = '56993900003076' then
           vObs := vObs || 'CONTRATO [' ||  'S14222651B'  || '] ';
         end if;
         
         if trim(ListaNotas.cnCLISAC) = '56993900000999' then
           vObs := vObs || 'CONTRATO [' ||  'S14222651C'  || '] ';
         end if;
         
         If nvl(vListaPedidos,'X') <> 'X' Then
              vObs := vObs || ' Pedido - [' || vListaPedidos || '] ';
         End If;
       
       vObs := vObs || 'PESO REAL [' || vPesoReal   || '] ';

       vObs := vObs || 'PESO COBRADO [' || vPesoCob  || '] ';
         
           
        ElsIf pListaNotas.cnContrato = 'C2020020004' Then --VALMET
        
            vObs := vObs || 'CONTRATO [' ||  ListaNotas.cnContrato  || '] ';
                
         if ListaNotas.cnNRCOLETA is not null Then
            vObs := vObs || 'Ordem de coleta : [' || ListaNotas.cnNRCOLETA || ']';
         End If;
         
         vObs := vObs || 'CARREGAMENTO [' || V_ARM_CARREGAMENTO  || '] ';
         
           If nvl(vListaPedidos,'X') <> 'X' Then
              vObs := vObs || ' Pedido - [' || vListaPedidos || '] ';
           End If;
         
      End If;
      
      Return trim(vObs);
   End fn_RetornaObservacao; 



function fni_ConsultaKM(pOrigem in tdvadm.t_glb_localidade.glb_localidade_codigo%type,
                        pDestino in tdvadm.t_glb_localidade.glb_localidade_codigo%type)
   return NUMBER
 is
   vKm NUMBER;
   vAuxiliar number;
   vIBGEOrigem  tdvadm.t_glb_localidade.glb_localidade_codigoibge%type;
   vIBGEDestino tdvadm.t_glb_localidade.glb_localidade_codigoibge%type;
   vDesc        tdvadm.t_slf_percurso.slf_percuso_descricao%type;
   vXML         clob;
   vCorpoEmail  clob;
   vStatus      char(1);
   vMessage     varchar2(2000);
   vData        date;
   vIncCli     char(1);
   vDataCadastro date;
   vPesquisaGoogle char(1);
 Begin
       -- Retirar quando levar para o PKG
       vKmUPDINSRT     := 'N'; -- Inicializa como nao inserir
       vStatus         := 'N'; -- Inicializa como Normal
       vPesquisaGoogle := 'N'; -- Inicializa para Nao pesquisar
       vKm := 0;
       vIBGEOrigem  := tdvadm.fn_busca_codigoibge(pOrigem,'IBC');
       vIBGEDestino := tdvadm.fn_busca_codigoibge(pDestino,'IBC');
       -- Verifica se e mesma origem e destino, retorna o Minimo 
       if vIBGEOrigem = vIBGEDestino Then 
          return nvl(ListaCargaCli.ccKMMinimo,20);
       End If;  

       vDesc := substr(tdvadm.fn_busca_codigoibge(pOrigem,'IBD') || '-' || tdvadm.fn_busca_codigoibge(pDestino,'IBD'),1,50); 
       vIncCli := 'N';

     -- Verifica se existe na tabela do Cliente
     If ListaCargaCli.ccTABKM is not null then
        vkm := fni_PercExiste(ListaCargaCli.ccTABKM,rpad( vIBGEOrigem,8),rpad(vIBGEDestino,8));
        if vkm = -1 Then
           if (vIBGEOrigem = vIBGEDestino)  Then
              return nvl(ListaCargaCli.ccKMMinimo,20);
           End IF;
           vIncCli := 'S';
           vkm := 0; 
        elsif (vkm > 0) then

             return nvl(vkm,0);
             -- Sirlano 24/07/2017
             -- KMMinimo e somente para o mesmo municipio
             -- Se achou KM usa independente do minimo
             if vkm < ListaCargaCli.ccKMMinimo Then
                Return ListaCargaCli.ccKMMinimo;
             Else   
                return nvl(vkm,0);
             End If;   
        End If; 
     End If;

     -- Pesquisa se existe na TDV 
     Begin
         SELECT max(nvl(P.SLF_PERCURSO_KM,0)),
                COUNT(distinct nvl(P.SLF_PERCURSO_KM,0)),
                max(p.slf_percurso_datacadastro)
--                max(P.SLF_PERCURSO_XML)
           INTO vKm,
                vAuxiliar,
                vDataCadastro
--                vXML
         FROM TDVADM.T_SLF_PERCURSO P
         WHERE TRIM(P.GLB_LOCALIDADE_CODIGOORIGEMI) = TRIM(vIBGEOrigem) -- DEFINIR COMO PEGAR A COLETA
           AND TRIM(P.GLB_LOCALIDADE_CODIGODESTINOI) = TRIM(vIBGEDestino);
         if vAuxiliar = 1 Then
            Begin
              select P.SLF_PERCURSO_XML
                 into vXML
              FROM TDVADM.T_SLF_PERCURSO P
              WHERE TRIM(P.GLB_LOCALIDADE_CODIGOORIGEMI) = TRIM(vIBGEOrigem) -- DEFINIR COMO PEGAR A COLETA
               AND TRIM(P.GLB_LOCALIDADE_CODIGODESTINOI) = TRIM(vIBGEDestino)
               and p.slf_percurso_datacadastro = vDataCadastro
               and rownum = 1;
            exception
             When NO_DATA_FOUND Then
               vXML := null;
             end ; 
         End If;
         
         SELECT max(nvl(P.SLF_PERCURSO_KM,0)),
                COUNT(distinct nvl(P.SLF_PERCURSO_KM,0)),
                max(p.slf_percurso_datacadastro)
--                max(P.SLF_PERCURSO_XML)
           INTO vKm,
                vAuxiliar,
                vDataCadastro
--                vXML
         FROM TDVADM.T_SLF_PERCURSO P
         WHERE TRIM(P.GLB_LOCALIDADE_CODIGOORIGEM) = TRIM(pOrigem) -- DEFINIR COMO PEGAR A COLETA
           AND TRIM(P.GLB_LOCALIDADE_CODIGODESTINO) = TRIM(pDestino);
                  
     Exception
       When NO_DATA_FOUND Then
           vKm := 0;
           vAuxiliar := 0;
           vDataCadastro := to_date('01/01/1900','dd/mm/yyyy');
           vXML := empty_clob;
           vKmUPDINSRT := 'S';
           vPesquisaGoogle := 'S';
       End; 
       
     If vAuxiliar = 0 Then
       vKm := 0;
       vAuxiliar := 0;
       vDataCadastro := to_date('01/01/1900','dd/mm/yyyy');
       vXML := empty_clob;
       vKmUPDINSRT := 'S';
       vPesquisaGoogle := 'S';
     End If;     
     
     -- Verifica se vai inserir na TDV
     If vKmUPDINSRT = 'N' Then
        If ( vAuxiliar > 1 ) OR NVL(vKm,0) <= 0   Then
           vKmUPDINSRT := 'S';
           vPesquisaGoogle := 'S';
        Elsif nvl(vDataCadastro,to_date('20/04/2014','dd/mm/yyyy')) <= to_date('29/10/2014','dd/mm/yyyy') Then
           vKmUPDINSRT := 'S';
           vPesquisaGoogle := 'S';
        ElsIf vXML is null Then
           vKmUPDINSRT := 'N';
           vPesquisaGoogle := 'N';
        End If;
     End If;
     
     if vPesquisaGoogle = 'S' Then
       if BcoTDXAtivo = 'N' Then
           vkm := nvl(wservice.pkg_web.fn_km_google(pOrigem,pDestino),0);
           vXML := wservice.pkg_web.fn_km_googlexml(pOrigem,pDestino);
        Else
           vkm := 0;
        End IF;      
--         if nvl(vkm,0) <= 0 Then
--            vkm := nvl(wservice.pkg_web.fn_km_google@tdx2(pOrigem,pDestino),0);
--            vXML := wservice.pkg_web.fn_km_googlexml@tdx2(pOrigem,pDestino);
--         End IF;   

        If nvl(vkm,0) = wservice.pkg_web.CLocalidadeNaoEncontrada Then
            vMessage := 'Localidade Nao Encontrada na TDV';
        ElsIf nvl(vkm,0) = wservice.pkg_web.CErroAcessandoGOOGLE Then
            vMessage := 'Erro Acessando o Google';
        ElsIf nvl(vkm,0) = wservice.pkg_web.CErroLendoXML Then
            vMessage := 'Erro Lendo o XML';
        ElsIf nvl(vkm,0) = wservice.pkg_web.CSemROTA Then
            vMessage := 'Localidade Nao acessivel por veiculo';
        ElsIf nvl(vkm,0) = wservice.pkg_web.CKmErrado Then
            vMessage := 'Km Nao numerico';
        End IF;
        if nvl(vkm,0) <= 0 Then
            vStatus  := TDVADM.PKG_glb_common.Status_Erro; 
            vKmUPDINSRT := 'N';
            vIncCli := 'N';
        Else                         
            vStatus  := TDVADM.PKG_glb_common.Status_Nomal; 
        End IF;                  





     End IF;
     
     if NVL(vStatus,'N') <> TDVADM.PKG_glb_common.Status_Erro  Then
     
         if vKmUPDINSRT = 'S' Then
            
            UPDATE TDVADM.T_SLF_PERCURSO P
              SET p.slf_percuso_descricao = vDesc,
                  p.slf_percurso_kmtdv = p.slf_percurso_km,
                  p.slf_percurso_km = vkm,
                  p.slf_percurso_xml = vXML,
                  p.usu_usuario_codigo = 'web',
                  p.slf_percurso_datacadastro = sysdate
            WHERE TRIM(P.GLB_LOCALIDADE_CODIGOORIGEMI) = TRIM(vIBGEOrigem) -- DEFINIR COMO PEGAR A COLETA
              AND TRIM(P.GLB_LOCALIDADE_CODIGODESTINOI) = TRIM(vIBGEDestino);
            
            if sql%rowcount = 0 Then
               
             
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.slf_percurso_codigo           := substr(trim(pOrigem) || trim(pDestino),1,10);
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.slf_percuso_descricao         := trim(substr(vDesc,1,50));
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.glb_localidade_codigoorigem   := trim(pOrigem);
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.glb_localidade_codigodestino  := trim(pDestino);
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.slf_percurso_km               := vkm;
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.usu_usuario_codigo            := 'web';
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.slf_percurso_datacadastro     := sysdate;
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.slf_percurso_kmtdv            := vkm;
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.glb_localidade_codigoorigemi  := trim(vIBGEOrigem);
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.glb_localidade_codigodestinoi := trim(vIBGEDestino);
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.slf_percurso_xml              := trim(vXML);
              
              delete TDVADM.T_slf_percurso p
              where p.slf_percurso_codigo = TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.slf_percurso_codigo;

              insert into TDVADM.T_slf_percurso p
              values TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso;
              
            End If;
            COMMIT;
         End If;
         
         if vIncCli = 'S' Then

            if ( vStatus <> TDVADM.PKG_glb_common.Status_Erro ) or  
               ( nvl(vkm,0) = wservice.pkg_web.CSemROTA ) Then
               TDVADM.PKG_glb_html.LinasTexto := '020';
               TDVADM.PKG_glb_html.ColunasTexto := '120';  
               vCorpoEmail := ''; 
               vCorpoEmail := vCorpoEmail || TDVADM.PKG_glb_html.Assinatura;
               vCorpoEmail := vCorpoEmail || TDVADM.PKG_glb_html.fn_Titulo(vDesc || ' Km - ' || vkm,2);
               vCorpoEmail := vCorpoEmail || TDVADM.PKG_glb_html.LinhaH;
               vCorpoEmail := vCorpoEmail || TDVADM.PKG_glb_html.AbreTexto;
               vCorpoEmail := vCorpoEmail || trim(vXML);
               vCorpoEmail := vCorpoEmail || TDVADM.PKG_glb_html.FechaTexto;
               vCorpoEmail := vCorpoEmail || TDVADM.PKG_glb_html.LinhaH;
            End If;
              
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.slf_percurso_codigo           := substr(trim(pOrigem) || trim(pDestino),1,10);
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.slf_percuso_descricao         := trim(substr(vDesc,1,50));
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.glb_localidade_codigoorigem   := trim(pOrigem);
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.glb_localidade_codigodestino  := trim(pDestino);
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.slf_percurso_km               := vkm;
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.usu_usuario_codigo            := 'web';
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.slf_percurso_datacadastro     := sysdate;
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.slf_percurso_kmtdv            := vkm;
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.glb_localidade_codigoorigemi  := trim(vIBGEOrigem);
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.glb_localidade_codigodestinoi := trim(vIBGEDestino);
              TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso.slf_percurso_xml              := trim(vXML);

            if fni_IncPercurso(ListaCargaCli.ccTABKM,TDVADM.PKG_FIFO_CARREGCTRC.tpPercurso) <> 'Ok' Then
               RAISE_APPLICATION_ERROR(-20001,'Erro Inserindo na Tabela do Cliente :'||pOrigem||'pDestino:'||pDestino|| ' erro - ' || sqlerrm);
            Else
               if TDVADM.PKG_FIFO_CARREGCTRC.ListaCargaCli.ccTABKM = '2781910' Then
                  vCorpoEmail := vCorpoEmail;
               elsif TDVADM.PKG_FIFO_CARREGCTRC.ListaCargaCli.ccTABKM = '82795' then
                  vCorpoEmail := vCorpoEmail;
               End If;
               COMMIT;
            End If; 
         End If;    
     End If;      
     return vKm;
 End fni_ConsultaKM;



  function fn_ConsultaKM(pOrigem in tdvadm.t_glb_localidade.glb_localidade_codigo%type,
                         pDestino in tdvadm.t_glb_localidade.glb_localidade_codigo%type)
     return NUMBER
 
    is
      PRAGMA AUTONOMOUS_TRANSACTION;
      vKm  number;
  Begin
--     vKmUPDINSRT := 'S';
     vKmUPDINSRT := vKmUPDINSRT;
--     ListaCargaCli.ccTABKM := '2781910';
     vkm := fni_ConsultaKM(pOrigem,pDestino);
     -- Verifcar os erros se voltar negativo
/*
     If  vkm = wservice.pkg_web.CLocalidadeNaoEncontrada Then
        vMessage := 'Localidade Nao Encontrada na TDV';
     ElsIf vkm = wservice.pkg_web.CErroAcessandoGOOGLE Then
        vMessage := 'Erro Acessando o Google';
     ElsIf vkm = wservice.pkg_web.CErroLendoXML Then
        vMessage := 'Erro Lendo o XML';
     ElsIf vkm = wservice.pkg_web.CSemROTA Then
        vMessage := 'Localidade Nao acessivel por veiculo';
     ElsIf vkm = wservice.pkg_web.CKmErrado Then
        vMessage := 'Km Nao numerico';
     End IF;
*/
     return vkm;
    
  End fn_ConsultaKM;   


  Function fn_RetornaAgrupamento(pTpAgrupa in tdvadm.t_slf_tpagrupa.slf_tpagrupa_codigo%type)
     Return tpAgrupaCli
  As
    LstAgrupaCli tpagrupaCli;
  Begin
      -- Set todos para 'N';  
      LstAgrupaCli.acContrato          := 'N';
      LstAgrupaCli.acSacado            := 'N';
      LstAgrupaCli.acRemetente         := 'N';
      LstAgrupaCli.acDestinatario      := 'N';
      LstAgrupaCli.acTpEndRemetente    := 'N';
      LstAgrupaCli.acTpEndDestino      := 'N';
      LstAgrupaCli.acLocalidadeColeta  := 'N';
      LstAgrupaCli.acLocalidadeEntrega := 'N';
      LstAgrupaCli.acIBGEColeta        := 'N';
      LstAgrupaCli.acIBGEEntrega       := 'N';
      LstAgrupaCli.acColetaEntrega     := 'N';
      LstAgrupaCli.acTPCarga           := 'N';
      LstAgrupaCli.acNrColeta          := 'N';
      LstAgrupaCli.acNrNota            := 'N';
      LstAgrupaCli.acQuimico           := 'N';
      LstAgrupaCli.acExpresso          := 'N';
      
      For c_msg in (select d.slf_tpagrupatipo_codigo 
                    from tdvadm.t_slf_tpagrupadet d
                    where d.slf_tpagrupa_codigo = pTpAgrupa)
      Loop

         if    c_msg.slf_tpagrupatipo_codigo = '01' Then
            LstAgrupaCli.acContrato := 'S';
         Elsif c_msg.slf_tpagrupatipo_codigo = '02' Then
            LstAgrupaCli.acSacado := 'S';
         Elsif c_msg.slf_tpagrupatipo_codigo = '03' Then
            LstAgrupaCli.acRemetente := 'S';
         Elsif c_msg.slf_tpagrupatipo_codigo = '04' Then
            LstAgrupaCli.acDestinatario := 'S';
         Elsif c_msg.slf_tpagrupatipo_codigo = '05' Then
            LstAgrupaCli.acTpEndRemetente := 'S';
         Elsif c_msg.slf_tpagrupatipo_codigo = '06' Then
            LstAgrupaCli.acTpEndDestino := 'S';
         Elsif c_msg.slf_tpagrupatipo_codigo = '07' Then
            LstAgrupaCli.acLocalidadeColeta := 'S';
         Elsif c_msg.slf_tpagrupatipo_codigo = '08' Then
            LstAgrupaCli.acLocalidadeEntrega := 'S';
         Elsif c_msg.slf_tpagrupatipo_codigo = '09' Then
            LstAgrupaCli.acIBGEColeta := 'S';
         Elsif c_msg.slf_tpagrupatipo_codigo = '10' Then
            LstAgrupaCli.acIBGEEntrega := 'S';
         Elsif c_msg.slf_tpagrupatipo_codigo = '11' Then
            LstAgrupaCli.acColetaEntrega := 'S';
         Elsif c_msg.slf_tpagrupatipo_codigo = '12' Then
            LstAgrupaCli.acTPCarga := 'S';
         Elsif c_msg.slf_tpagrupatipo_codigo = '13' Then
            LstAgrupaCli.acNrColeta := 'S';
         ElsIf c_msg.slf_tpagrupatipo_codigo = '14' Then
            LstAgrupaCli.acNrNota := 'S';
         ElsIf c_msg.slf_tpagrupatipo_codigo = '15' Then
            LstAgrupaCli.acQuimico := 'S';
         ElsIf c_msg.slf_tpagrupatipo_codigo = '16' Then
            LstAgrupaCli.acExpresso := 'S';
            
         End If;
      End Loop;
      
      return LstAgrupaCli;             
        
  End fn_RetornaAgrupamento;


 Function fni_RetornaTabSol(pSacado in TDVADM.T_glb_cliente.glb_cliente_cgccpfcodigo%type ,
                            pGrupo          in tdvadm.t_glb_grupoeconomico.glb_grupoeconomico_codigo%type,
                            pContratoCargas in TDVADM.T_arm_nota.slf_contrato_codigo%type) Return clob
  As
   vTexTo       clob;
   vCursor      tpCurosr;
   vCursor1     tpCurosr;
   vLinha      TDVADM.PKG_glb_SqlCursor.tpString1024;

    
  Begin
    
   vTexTo := TDVADM.PKG_glb_html.Assinatura;
    
--     vTexTo := 'REGRA PARA GRUPO - ' || pGrupo || ' SACADO - ' || pSacado || ' CONTRATO - ' || pContratoCargas || chr(10);
--     vTexto := vTexTo || 'TIPO  COLETA/ENTREGA DESCRICAO                       CARGA                          VEICULO' || chr(10);
     open vCursor FOR select ta.slf_tabela_tipo Tipo,
                             trim(decode(ta.slf_tabela_coletaentrega,'E','Entrega',
                                                                'C','Coleta',
                                                                'N','Ambos',
                                                                'A','Ambos','Nao Sei')) ColEnt,
                             trim(ta.slf_tabela_descricao) descricao,
                             substr(ta.fcf_tpveiculo_codigo ||'-'|| tv.fcf_tpveiculo_descricao,1,30) veiculo,
                             substr(ta.fcf_tpcarga_codigo ||'-'||tc.fcf_tpcargadescricao,1,30) carga 
                      from TDVADM.t_slf_tabela ta,
                           TDVADM.t_fcf_tpveiculo tv,
                           TDVADM.t_fcf_tpcarga tc
                      where ta.glb_grupoeconomico_codigo = pGrupo
                        and ta.glb_cliente_cgccpfcodigo = pSacado
                        and ta.slf_tabela_contrato = pContratoCargas  
                        and nvl(ta.slf_tabela_status,'N') = 'N'
                        and ta.fcf_tpveiculo_codigo = tv.fcf_tpveiculo_codigo (+)
                        and ta.fcf_tpcarga_codigo = tc.fcf_tpcarga_codigo (+)
                        and ta.slf_tabela_saque = (select max(ta2.slf_tabela_saque)
                                                   from TDVADM.t_slf_tabela ta2
                                                   where ta2.slf_tabela_codigo = ta.slf_tabela_codigo)
                     Order by 5,4,2,1;
    
     TDVADM.PKG_glb_SqlCursor.TiposComuns.Formato := 'H';
--     TDVADM.PKG_glb_SqlCursor.TipoHederHTML.Alinhamento := 'Left';
     TDVADM.PKG_glb_SqlCursor.sp_Get_Cursor(vCursor,vLinha);
     for i in 1 .. vLinha.count loop
         if TDVADM.PKG_glb_SqlCursor.TiposComuns.Formato = 'H' then
           vTexto := vTexto || vLinha(i);
         Else
           vTexto := vTexto || vLinha(i) || chr(10);
         End if;
     end Loop;
     
     
   
     vTexto := vTexTo || '<br/><br/>';
--     vTexto := vTexTo || 'FAIXA DE PESO PESO ' || chr(10);
--     vTexto := vTexTo || 'CARGA                             VEICULO                   PESO DE                     PESO ATE';

      open vCursor1 FOR SELECT TC.FCF_TPCARGA_CODIGO || '-' || TC.fcf_tpcargadescricao CARGA,
                               TV.FCF_TPVEICULO_CODIGO || '-' || TV.FCF_TPVEICULO_DESCRICAO VEICULO,
                               LC.fcf_limitecargas_faixai PESODE,
                               fcf_limitecargas_faixaF PESOATE
                        FROM TDVADM.T_FCF_LIMITECARGAS LC,
                             TDVADM.T_FCF_TPCARGA TC,
                             TDVADM.T_FCF_TPVEICULO TV
                        WHERE LC.GLB_GRUPOECONOMICO_CODIGO = pGrupo
                          AND nvl(LC.SLF_CONTRATO_CODIGO,QualquerContrato) = pContratoCargas
                          AND LC.GLB_CLIENTE_CGCCPFCODIGO = pSacado
                          AND LC.FCF_TPCARGA_CODIGO = TC.FCF_TPCARGA_CODIGO (+)
                          AND LC.FCF_TPVEICULO_CODIGO = TV.FCF_TPVEICULO_CODIGO (+)
                          and lc.fcf_limitecargas_validade >= sysdate
                          and lc.fcf_limitecargas_vigencia <= sysdate;
      
      vLinha.delete;                     
     TDVADM.PKG_glb_SqlCursor.TiposComuns.Formato := 'H';
--     TDVADM.PKG_glb_SqlCursor.TipoHederHTML.Alinhamento := 'Left';
     TDVADM.PKG_glb_SqlCursor.sp_Get_Cursor(vCursor1,vLinha);
     for i in 1 .. vLinha.count loop
         if TDVADM.PKG_glb_SqlCursor.TiposComuns.Formato = 'H' then
           vTexto := vTexto || vLinha(i);
         Else
           vTexto := vTexto || vLinha(i) || chr(10);
         End if;
     end Loop;
      
      return vTexTo;

 End fni_RetornaTabSol;                            



 Procedure Sp_RetornaRegra(pSacado         in out t_glb_cliente.glb_cliente_cgccpfcodigo%type ,
                           pGrupo          in out tdvadm.t_glb_grupoeconomico.glb_grupoeconomico_codigo%type,
                           pContratoCargas in out TDVADM.T_arm_nota.slf_contrato_codigo%type,
                           pTipoAchado     in out char)
 IS
      vACHOU      INTEGER := 0;
    BEGIN
     
      pSacado     := nvl(trim(pSacado),QualquerCliente);
      pContratoCargas := NVL(trim(pContratoCargas), QualquerContrato);
      
      If nvl(pGrupo,QualquerGrupo) = QualquerGrupo Then
         begin
           if length(trim(pSacado)) = 8 Then
               SELECT min(C.GLB_GRUPOECONOMICO_CODIGO)
                 INTO pGrupo
                 FROM TDVADM.T_GLB_CLIENTE C
                WHERE substr(C.GLB_CLIENTE_CGCCPFCODIGO,1,8) = pSacado;
           Else  
               SELECT C.GLB_GRUPOECONOMICO_CODIGO
                 INTO pGrupo
                 FROM TDVADM.T_GLB_CLIENTE C
                WHERE C.GLB_CLIENTE_CGCCPFCODIGO = pSacado;
           End If;
         exception
           when NO_DATA_FOUND Then
               pGrupo := QualquerGrupo;
           End ;
      Else
         pGrupo := pGrupo;
      End If;     

      If ( pGrupo <> QualquerGrupo) and ( pSacado <> QualquerCliente)  and ( pContratoCargas <> QualquerContrato ) Then
          SELECT COUNT(*)
            INTO vACHOU
            FROM TDVADM.T_SLF_CLIENTECARGAS CC
           WHERE  cc.glb_cliente_cgccpfcodigo = pSacado
             AND CC.SLF_CONTRATO_CODIGO = pContratoCargas
             AND CC.GLB_GRUPOECONOMICO_CODIGO = pGrupo
             and cc.slf_clientecargas_ativo = 'S'
             and cc.slf_clientecargas_vigencia = (select max(cc1.slf_clientecargas_vigencia)
                                                  from TDVADM.T_SLF_CLIENTECARGAS CC1
                                                  where cc1.glb_grupoeconomico_codigo     = cc.glb_grupoeconomico_codigo
                                                    and cc1.glb_cliente_cgccpfcodigo      = cc.glb_cliente_cgccpfcodigo
                                                    and cc1.fcf_tpcarga_codigo            = cc.fcf_tpcarga_codigo
                                                    and cc1.slf_contrato_codigo           = cc.slf_contrato_codigo
                                                    and cc1.slf_tpfrete_codigo            = cc.slf_tpfrete_codigo
                                                    and cc1.fcf_tpcarga_codigopesq        = cc.fcf_tpcarga_codigopesq 
--                                                    and cc1.slf_clientecargas_pcobranca   = cc.slf_clientecargas_pcobranca
--                                                    and cc1.slf_clientecargas_fixaorigem  = cc.slf_clientecargas_fixaorigem
--                                                    and cc1.slf_clientecargas_fixadestino = cc.slf_clientecargas_fixadestino
                                                    and cc1.slf_clientecargas_ativo       = 'S');
         If vACHOU > 0 Then
            pTipoAchado := 'GCT'; -- ACHOU POR GRUPO/CNPJ/CONTRATO
            return;
         End If;   
      End If;
       
      If vACHOU = 0 Then

         If /*( pGrupo <> QualquerGrupo) and */ ( pSacado <> QualquerCliente)  and ( pContratoCargas <> QualquerContrato ) Then
             SELECT COUNT(*)
               INTO vACHOU
             FROM TDVADM.T_SLF_CLIENTECARGAS CC
             WHERE cc.glb_cliente_cgccpfcodigo = pSacado
               AND CC.SLF_CONTRATO_CODIGO = pContratoCargas
               AND CC.GLB_GRUPOECONOMICO_CODIGO = QualquerGrupo
               and cc.slf_clientecargas_ativo = 'S'
               and cc.slf_clientecargas_vigencia = (select max(cc1.slf_clientecargas_vigencia)
                                                    from TDVADM.T_SLF_CLIENTECARGAS CC1
                                                    where cc1.glb_grupoeconomico_codigo     = cc.glb_grupoeconomico_codigo
                                                      and cc1.glb_cliente_cgccpfcodigo      = cc.glb_cliente_cgccpfcodigo
                                                      and cc1.fcf_tpcarga_codigo            = cc.fcf_tpcarga_codigo
                                                      and cc1.slf_contrato_codigo           = cc.slf_contrato_codigo
                                                      and cc1.slf_tpfrete_codigo            = cc.slf_tpfrete_codigo
                                                      and cc1.fcf_tpcarga_codigopesq        = cc.fcf_tpcarga_codigopesq 
--                                                      and cc1.slf_clientecargas_pcobranca   = cc.slf_clientecargas_pcobranca
--                                                      and cc1.slf_clientecargas_fixaorigem  = cc.slf_clientecargas_fixaorigem
--                                                      and cc1.slf_clientecargas_fixadestino = cc.slf_clientecargas_fixadestino
                                                      and cc1.slf_clientecargas_ativo       = 'S');
               
            if vACHOU > 0 Then
               pTipoAchado := 'CT'; -- ACHOU POR CNPJ/CONTRATO
               pGrupo := QualquerGrupo;
               return;
            End If; 
         End IF; 
        
      End If; 

      If vACHOU = 0 Then

         If ( pGrupo <> QualquerGrupo) /*and  ( pSacado <> QualquerCliente)*/  and ( pContratoCargas <> QualquerContrato ) Then
             SELECT COUNT(*)
               INTO vACHOU
             FROM TDVADM.T_SLF_CLIENTECARGAS CC
             WHERE cc.glb_cliente_cgccpfcodigo = QualquerCliente
               AND CC.SLF_CONTRATO_CODIGO = pContratoCargas
               AND CC.GLB_GRUPOECONOMICO_CODIGO = pGrupo
               and cc.slf_clientecargas_ativo = 'S'
               and cc.slf_clientecargas_vigencia = (select max(cc1.slf_clientecargas_vigencia)
                                                    from TDVADM.T_SLF_CLIENTECARGAS CC1
                                                    where cc1.glb_grupoeconomico_codigo     = cc.glb_grupoeconomico_codigo
                                                      and cc1.glb_cliente_cgccpfcodigo      = cc.glb_cliente_cgccpfcodigo
                                                      and cc1.fcf_tpcarga_codigo            = cc.fcf_tpcarga_codigo
                                                      and cc1.slf_contrato_codigo           = cc.slf_contrato_codigo
                                                      and cc1.slf_tpfrete_codigo            = cc.slf_tpfrete_codigo
                                                      and cc1.fcf_tpcarga_codigopesq        = cc.fcf_tpcarga_codigopesq 
--                                                      and cc1.slf_clientecargas_pcobranca   = cc.slf_clientecargas_pcobranca
--                                                      and cc1.slf_clientecargas_fixaorigem  = cc.slf_clientecargas_fixaorigem
--                                                      and cc1.slf_clientecargas_fixadestino = cc.slf_clientecargas_fixadestino
                                                      and cc1.slf_clientecargas_ativo       = 'S');
               
             if vACHOU > 0 Then
               pTipoAchado := 'GT';  -- GRUPO/CONTRATO 
               pSacado := QualquerCliente;
               return;
             End If; 
         End IF; 
        
      End If; 


      If vACHOU = 0 Then

         If ( pGrupo <> QualquerGrupo) and  ( pSacado <> QualquerCliente)  /*and ( pContratoCargas <> QualquerContrato )*/ Then
             SELECT COUNT(*)
               INTO vACHOU
             FROM TDVADM.T_SLF_CLIENTECARGAS CC
             WHERE cc.glb_cliente_cgccpfcodigo = pSacado
               AND CC.SLF_CONTRATO_CODIGO = QualquerContrato
               AND CC.GLB_GRUPOECONOMICO_CODIGO = pGrupo
               and cc.slf_clientecargas_ativo = 'S'
               and cc.slf_clientecargas_vigencia = (select max(cc1.slf_clientecargas_vigencia)
                                                    from TDVADM.T_SLF_CLIENTECARGAS CC1
                                                    where cc1.glb_grupoeconomico_codigo     = cc.glb_grupoeconomico_codigo
                                                      and cc1.glb_cliente_cgccpfcodigo      = cc.glb_cliente_cgccpfcodigo
                                                      and cc1.fcf_tpcarga_codigo            = cc.fcf_tpcarga_codigo
                                                      and cc1.slf_contrato_codigo           = cc.slf_contrato_codigo
                                                      and cc1.slf_tpfrete_codigo            = cc.slf_tpfrete_codigo
                                                      and cc1.fcf_tpcarga_codigopesq        = cc.fcf_tpcarga_codigopesq 
--                                                      and cc1.slf_clientecargas_pcobranca   = cc.slf_clientecargas_pcobranca
--                                                      and cc1.slf_clientecargas_fixaorigem  = cc.slf_clientecargas_fixaorigem
--                                                      and cc1.slf_clientecargas_fixadestino = cc.slf_clientecargas_fixadestino
                                                      and cc1.slf_clientecargas_ativo       = 'S');
               
             if vACHOU > 0 Then
               pTipoAchado := 'GC'; -- ACHOU POR GRUPO/CNPJ
               pContratoCargas := QualquerContrato;
               return;
             End If; 
         End IF; 
        
      End If; 
      
      If vACHOU = 0 Then

         If /*( pGrupo <> QualquerGrupo) and*/  ( pSacado <> QualquerCliente)  /*and ( pContratoCargas <> QualquerContrato )*/ Then
             SELECT COUNT(*)
               INTO vACHOU
             FROM TDVADM.T_SLF_CLIENTECARGAS CC
             WHERE cc.glb_cliente_cgccpfcodigo = pSacado --QualquerCliente
               AND CC.SLF_CONTRATO_CODIGO = QualquerContrato
               AND CC.GLB_GRUPOECONOMICO_CODIGO = QualquerGrupo
               and cc.slf_clientecargas_ativo = 'S'
               and cc.slf_clientecargas_vigencia = (select max(cc1.slf_clientecargas_vigencia)
                                                    from TDVADM.T_SLF_CLIENTECARGAS CC1
                                                    where cc1.glb_grupoeconomico_codigo     = cc.glb_grupoeconomico_codigo
                                                      and cc1.glb_cliente_cgccpfcodigo      = cc.glb_cliente_cgccpfcodigo
                                                      and cc1.fcf_tpcarga_codigo            = cc.fcf_tpcarga_codigo
                                                      and cc1.slf_contrato_codigo           = cc.slf_contrato_codigo
                                                      and cc1.slf_tpfrete_codigo            = cc.slf_tpfrete_codigo
                                                      and cc1.fcf_tpcarga_codigopesq        = cc.fcf_tpcarga_codigopesq 
--                                                      and cc1.slf_clientecargas_pcobranca   = cc.slf_clientecargas_pcobranca
--                                                      and cc1.slf_clientecargas_fixaorigem  = cc.slf_clientecargas_fixaorigem
--                                                      and cc1.slf_clientecargas_fixadestino = cc.slf_clientecargas_fixadestino
                                                      and cc1.slf_clientecargas_ativo       = 'S');
               
             if vACHOU > 0 Then
                pTipoAchado := 'C'; -- ACHOU POR CLINETE
                pGrupo    := QualquerGrupo ;
--                pSacado     := QualquerCliente;
                pContratoCargas := QualquerContrato;
               return;
             End If; 
         End IF; 
        
      End If; 


      If vACHOU = 0 Then

         If ( pGrupo <> QualquerGrupo) /*and  ( pSacado <> QualquerCliente)  and ( pContratoCargas <> QualquerContrato )*/ Then
             SELECT COUNT(*)
               INTO vACHOU
             FROM TDVADM.T_SLF_CLIENTECARGAS CC
             WHERE cc.glb_cliente_cgccpfcodigo = QualquerCliente
               AND CC.SLF_CONTRATO_CODIGO = QualquerContrato
               AND CC.GLB_GRUPOECONOMICO_CODIGO = pGrupo --QualquerGrupo
               and cc.slf_clientecargas_ativo = 'S'
               and cc.slf_clientecargas_vigencia = (select max(cc1.slf_clientecargas_vigencia)
                                                    from TDVADM.T_SLF_CLIENTECARGAS CC1
                                                    where cc1.glb_grupoeconomico_codigo     = cc.glb_grupoeconomico_codigo
                                                      and cc1.glb_cliente_cgccpfcodigo      = cc.glb_cliente_cgccpfcodigo
                                                      and cc1.fcf_tpcarga_codigo            = cc.fcf_tpcarga_codigo
                                                      and cc1.slf_contrato_codigo           = cc.slf_contrato_codigo
                                                      and cc1.slf_tpfrete_codigo            = cc.slf_tpfrete_codigo
                                                      and cc1.fcf_tpcarga_codigopesq        = cc.fcf_tpcarga_codigopesq 
--                                                      and cc1.slf_clientecargas_pcobranca   = cc.slf_clientecargas_pcobranca
--                                                      and cc1.slf_clientecargas_fixaorigem  = cc.slf_clientecargas_fixaorigem
--                                                      and cc1.slf_clientecargas_fixadestino = cc.slf_clientecargas_fixadestino
                                                      and cc1.slf_clientecargas_ativo       = 'S');
               
             if vACHOU > 0 Then
                pTipoAchado := 'G'; -- ACHOU POR GRUPO
--                pGrupo    := QualquerGrupo ;
                pSacado     := QualquerCliente;
                pContratoCargas := QualquerContrato;
               return;
             End If; 
         End IF; 
        
      End If; 


      If vACHOU = 0 Then

         If /*( pGrupo <> QualquerGrupo) and  ( pSacado <> QualquerCliente)  and*/ ( pContratoCargas <> QualquerContrato ) Then
             SELECT COUNT(*)
               INTO vACHOU
             FROM TDVADM.T_SLF_CLIENTECARGAS CC
             WHERE cc.glb_cliente_cgccpfcodigo = QualquerCliente
               AND CC.SLF_CONTRATO_CODIGO = pContratoCargas --QualquerContrato
               AND CC.GLB_GRUPOECONOMICO_CODIGO = QualquerGrupo
               and cc.slf_clientecargas_ativo = 'S'
               and cc.slf_clientecargas_vigencia = (select max(cc1.slf_clientecargas_vigencia)
                                                    from TDVADM.T_SLF_CLIENTECARGAS CC1
                                                    where cc1.glb_grupoeconomico_codigo     = cc.glb_grupoeconomico_codigo
                                                      and cc1.glb_cliente_cgccpfcodigo      = cc.glb_cliente_cgccpfcodigo
                                                      and cc1.fcf_tpcarga_codigo            = cc.fcf_tpcarga_codigo
                                                      and cc1.slf_contrato_codigo           = cc.slf_contrato_codigo
                                                      and cc1.slf_tpfrete_codigo            = cc.slf_tpfrete_codigo
                                                      and cc1.fcf_tpcarga_codigopesq        = cc.fcf_tpcarga_codigopesq 
--                                                      and cc1.slf_clientecargas_pcobranca   = cc.slf_clientecargas_pcobranca
--                                                      and cc1.slf_clientecargas_fixaorigem  = cc.slf_clientecargas_fixaorigem
--                                                      and cc1.slf_clientecargas_fixadestino = cc.slf_clientecargas_fixadestino
                                                      and cc1.slf_clientecargas_ativo       = 'S');
               
             if vACHOU > 0 Then
               pTipoAchado := 'T'; -- ACHOU POR CONTRATO
               pGrupo    := QualquerGrupo ;
               pSacado     := QualquerCliente;
--               pContratoCargas := QualquerContrato;
               return;
             End If; 
         End IF; 
        
      End If; 



      -- SE ACHOU E CONTRATO DIFERENTE DE CONTRATO GERAL
      If (vACHOU = 0 ) or ( (pContratoCargas = QualquerContrato) AND ( pGrupo = QualquerGrupo ) and ( pSacado = QualquerCliente )) THEN
         pTipoAchado := 'QQQ'; 
      ELSIf pTIPOACHADO is null Then
         pTipoAchado := 'N'; -- USA O TIPO NORMAL PARA TODOS
      END IF;


 End Sp_RetornaRegra;                            

  function fni_retcenarioREGRA(pListaCargaCli in TpCargaCli) return clob
  As
    vRetorno clob;
    vTraduzPeso varchar2(50);
  Begin
     vRetorno := empty_clob;
 
     select decode(pListaCargaCli.ccPCOBRANCA,'PR','Peso da Nota',
                                              'PB','Peso Balanca',
                                              'PC','Peso Cubado',
                                              'PE','Peso Excedente',
                                              'PT','Peso Tara',
                                              pListaCargaCli.ccPCOBRANCA || '-Nao Sei')
        into vTraduzPeso
     From dual;


          vRetorno := 'CARGAS - ' || chr(13) ||
                      ' Cod Carga   ' || pListaCargaCli.ccTPCARGACLI || ' Carga Pesq ' || pListaCargaCli.ccTPCARGACLIPESQ || chr(13) ||
                      ' Tipo        ' || pListaCargaCli.ccTPCARGACLIDESC    || chr(10)  ||
                      ' Agrupa CTRC ' || pListaCargaCli.ccTPCARGAAGRUPACTRC || ' - Qtde - ' || pListaCargaCli.ccTPCARGAQTDEAGCTRC || chr(13) ||
                      ' Agrupa NFs  ' || pListaCargaCli.ccTPCARGAAGRUPANF   || ' - Qtde - ' || pListaCargaCli.ccTPCARGAQTDEAGNF   || chr(13) ||
                      ' Rateia      ' || pListaCargaCli.ccRATEIA || chr(13) ||
                      ' Onde Cobrar a coleta ' || pListaCargaCli.ccCteColeta  || chr(13) ||
                      ' Cte Globalizado ' || pListaCargaCli.ccCteGlobalizado  || chr(13) ||
                      ' Limite de Valor Por CTe ' || pListaCargaCli.ccLimiteCTe  || chr(13) ||
                      ' Limite de Valor Por NFSe ' || pListaCargaCli.ccLimiteNFSe  || chr(13) ||
                      
                      ' Peso Cobranca ' || vTraduzPeso || chr(13) ||
                      ' BaseOcup    ' || pListaCargaCli.ccBASEOCUPACAO      || ' - VlrBS - ' || pListaCargaCli.ccVALORBASE         || chr(13) ||
                      ' Peso Min    ' || pListaCargaCli.ccPESOMINIMO || chr(13) ||
                      ' Procedure   ' || pListaCargaCli.ccPROCEDURE  || chr(13) ||
                      ' Tipo de Agrupamento ' || pListaCargaCli.ccTPAGRUPA  || chr(13) || 
                      ' Tipo de Rateio      ' || pListaCargaCli.ccTPRATEIO  || chr(13) ||
                      ' Agrupo por Coleta ' || pListaCargaCli.ccAgrpPorColeta  || chr(13) ||
                      ' Agrupamento CTe por Coleta ' || pListaCargaCli.ccTPCARGAQPCOLCTRC  || chr(13) || 
                      ' Agrupamento Nota por Coleta ' || pListaCargaCli.ccTPCARGAQPCOLNF  || chr(13) || 
--                      ' ' || pListaCargaCli.ccPRIOREXQM  || chr(13) ||
                      ' Percent. Expresso ' || pListaCargaCli.ccPERCTEX  || chr(13) ||
                      ' Percent. Quimicio ' || pListaCargaCli.ccPERCTQM  || chr(13) ||
                      ' Percent. OUTBOUND ' || pListaCargaCli.ccPERCTOUT  || chr(13) ||
                      ' Percent. Transferencia ' || pListaCargaCli.ccPERCTRA  || chr(13) ||
                      ' Percent. Redutor ' || pListaCargaCli.ccPERCTREDUTOR  || chr(13) ||
                      ' Formula FRTX ' || pListaCargaCli.ccFORMULAFRTX  || chr(13) ||
                      ' Formula FRVL ' || pListaCargaCli.ccFORMULAFRVL  || chr(13) ||
                      ' Formula FRKM ' || pListaCargaCli.ccFORMULAFRKM  || chr(13) ||
                      ' Formula PEDTX ' || pListaCargaCli.ccFORMULAPDTX  || chr(13) ||
                      ' Formula PEDVL ' || pListaCargaCli.ccFORMULAPDVL  || chr(13) ||
--                      ' ' || pListaCargaCli.ccTPFRETE  || chr(13) ||
                      ' Origem Fixa ' || pListaCargaCli.ccORIGEMFIXA  || chr(13) ||
                      ' Destino Fixo ' || pListaCargaCli.ccDESTINOFIXO  || chr(13) ||
                      ' Exige Form.Quimico ' || pListaCargaCli.ccEXIGEFORMQM  || chr(13) ||
                      ' Exige Form.Expresso ' || pListaCargaCli.ccEXIGEFORMEX  || chr(13) ||
                      ' So Transferencia ' || pListaCargaCli.ccSOTRANSF  || chr(13) ||
                      ' TAB Pedagio' || pListaCargaCli.ccTABKM  || chr(13) ||
                      ' ' || pListaCargaCli.ccTPCARGA  || chr(13) ||
                      ' Busca da Carga ' || pListaCargaCli.ccTPCARGADESC  || chr(13) ||
                      ' Tp LOC ORIGEM ' || pListaCargaCli.ccTPCODORIGEM  || chr(13) ||
                      ' Tp LOC DESTINO ' || pListaCargaCli.ccTPCODDESTINO  || chr(13) ||
                      ' Usa Faixa de KM ' || pListaCargaCli.ccUSAFAIXAKM  || chr(13) ||
                      ' Usa Faixa de PESO ' || pListaCargaCli.ccUSAFAIXAPS  || chr(13) ||
                      ' Usa Viagem ' || pListaCargaCli.ccUSAFAIXAVG  || chr(13) ||
                      ' Usa Veiculo ' || pListaCargaCli.ccUSAVEICULO  || chr(13) ||
                      ' Onde Pesq Veiculo ' || pListaCargaCli.ccPESQVEICULO  || chr(13) ||
--                      ' ' || pListaCargaCli.ccTPFRETEOBS  || chr(13) ||
                      ' KM Minimo ' || pListaCargaCli.ccKMMinimo  || chr(13) ||
                      chr(13) || '     COLETA    '  || chr(13) ||
                      ' Cobro Coleta ' || pListaCargaCli.ccColetaCobra  || chr(13) ||
                      ' Forma de Cobranca' || pListaCargaCli.ccColetaTpCobranca  || chr(13) ||
--                      ' ' || pListaCargaCli.ccTPFRETECOL  || chr(13) ||
                      ' Tipo de Carga ' || pListaCargaCli.ccTPCARGACLICOL  || chr(13) ||

                      ' Formula COLTX ' || pListaCargaCli.ccFORMULACOLTX  || chr(13) ||
                      ' Formula COLVL ' || pListaCargaCli.ccFORMULACOLVL  || chr(13) ||
                      ' Formula COLKM ' || pListaCargaCli.ccFORMULACOLKM  || chr(13) ||

                      ' Busca da Carga ' || pListaCargaCli.ccTPCARGADESCCOL  || chr(13) ||
                      ' Tp LOC ORIGEM ' || pListaCargaCli.ccTPCODORIGEMCOL  || chr(13) ||
                      ' Tp LOC DESTINO ' || pListaCargaCli.ccTPCODDESTINOCOL  || chr(13) ||
                      ' Usa Faixa KM ' || pListaCargaCli.ccUSAFAIXAKMCOL  || chr(13) ||
                      ' Usa Faixa PESO ' || pListaCargaCli.ccUSAFAIXAPSCOL  || chr(13) ||
--                      ' ' || pListaCargaCli.ccUSAFAIXAVGCOL  || chr(13) ||
                      ' Usa Veiculo ' || pListaCargaCli.ccUSAVEICULOCOL  || chr(13) ||
                      ' Onde Pesq Veiculo ' || pListaCargaCli.ccPESQVEICULOCOL  || chr(13) ||

                      ' ' ;


         
         return vRetorno;
  End fni_retcenarioREGRA;

  function fni_retcenario(pTITULO in varchar2) return varchar2
    as
       vVencimento varchar2(100);
       vAuxiliarchar varchar2(10);
       vDescContrato tdvadm.t_slf_contrato.slf_contrato_descricao%type;
    Begin
       IF  nvl(ListaNotas.cnTABSOLCOD,SemTabelaCodigo) <> SemTabelaCodigo Then
           if ListaNotas.cnTABSOL = 'T' Then
             Begin
                Select ' - Vigente a partir de ' || to_char(t.slf_tabela_vigencia,'dd/mm/yyyy') || ' Status ' || decode(nvl(t.slf_tabela_status,'N'),'N','Normal','Suspensa')
                   into vVencimento
               From TDVADM.T_slf_tabela t
               where t.slf_tabela_codigo = ListaNotas.cnTABSOLCOD
                 and t.slf_tabela_saque = lpad(trim(ListaNotas.cnTABSOLSQ),4,'0')
                 AND NVL(T.SLF_TABELA_STATUS,'N') = 'N';
              exception
                When NO_DATA_FOUND Then
                    vVencimento := 'Tabela Nao encontrada';
                    tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Tabela Nao encontrada TP-' || ListaNotas.cnTABSOL || '-TAB-' || ListaNotas.cnTABSOLCOD ||  '-SQ-' || ListaNotas.cnTABSOLSQ;
                    vAuxiliarchar := fn_InsereLogGeracao ;             
                End; 
           Else
             Begin
                Select ' - Valida ate ' || to_char(t.Slf_Solfrete_Dataefetiva,'dd/mm/yyyy') || ' Status ' || decode(nvl(t.slf_solfrete_status,'N'),'N','Normal','Suspensa')
                   into vVencimento
               From TDVADM.T_slf_solfrete t
               where t.slf_solfrete_codigo = ListaNotas.cnTABSOLCOD
                 and t.slf_solfrete_saque = lpad(trim(ListaNotas.cnTABSOLSQ),4,'0')
                 AND NVL(T.SLF_SOLFRETE_STATUS,'N') = 'N';
              exception
                When NO_DATA_FOUND Then
                    vVencimento := 'Solicitac?o Nao encontrada';
                    tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Tabela Nao encontrada TP-' || ListaNotas.cnTABSOL || '-SOL-' || ListaNotas.cnTABSOLCOD ||  '-SQ-' || ListaNotas.cnTABSOLSQ;
                    vAuxiliarchar := fn_InsereLogGeracao ;               
                End; 
           End If;
         
       End If;
       
       If ListaVaux.cnNomeSacado is null then
          Begin
            select cl.glb_cliente_razaosocial
              into ListaVaux.cnNomeSacado
            From TDVADM.T_glb_cliente cl
            where cl.glb_cliente_cgccpfcodigo = ListaNotas.cnCLISAC;
          Exception
            When NO_DATA_FOUND Then
               ListaVaux.cnNomeSacado := null;
            End ;
       End If;
         
       Begin
         select c.slf_contrato_descricao
            into vDescContrato
         from tdvadm.t_slf_contrato c
         where c.slf_contrato_codigo = ListaQuebras.CONTRATO;
       Exception
         When NO_DATA_FOUND Then
            vDescContrato := 'Nao Achou';
         When OTHERS Then
            vDescContrato := 'erro: ' || sqlerrm;
         end;
    
       return substr( pTITULO || chr(10) ||
              'Tab/Sol            - ' || ListaNotas.cnTABSOLCOD || '-' || lpad(trim(ListaNotas.cnTABSOLSQ),4,'0') || vVencimento || chr(10) ||
              'Coleta-Nota/Sr/Rem - ' || ListaNotas.cnNrColetaCiclo || '-' || ListaNotas.cnNRCOLETA || '-' || ListaNotas.cnNOTA || '-' || ListaNotas.cnSERIENF || '-' || ListaNotas.cnCLIREM || chr(10) ||
              'Contrato           - ' || ListaQuebras.CONTRATO || '-' || vDescContrato || chr(10) ||
              'PAGADOR            - ' || ListaNotas.cnCLISAC || '-' || ListaVaux.cnNomeSacado || chr(10) ||
              'Grupo Sacado       - ' || ListaNotas.cnGRUPOECSAC || chr(10) ||
              'Grupo Remetente    - ' || ListaNotas.cnGRUPOECREM || chr(10) ||
              'Grupo Destinatario - ' || ListaNotas.cnGRUPOECDES || chr(10) ||
              'CODIGO ONU         - ' || ListaNotas.cnONU || '-' || ListaNotas.cnONUGRPEMB || chr(10) ||
              chr(10) || 
              'ORI                - ' || vDescOrigem.OrigemCodigo  || ' - LOC - ' || vDescOrigem.OrigemDescricao  || chr(10) ||
              'DES                - ' || vDescOrigem.DestinoCodigo || ' - LOC - ' || vDescOrigem.DestinoDescricao  || chr(10) ||
              chr(10) || 
              'COLETA             - ' || vDescOrigem.ColLocCodigo   || ' - ' || vDescOrigem.ColLocDescri   || chr(10) ||
              'COLETA CAP/INT     - ' || vDescOrigem.ColCIDescri                                           || chr(10) ||
              'COLETA IBGE        - ' || vDescOrigem.ColIBGECodigo  || ' - ' || vDescOrigem.ColIBGEDescri  || chr(10) ||
              'COLETA MESO        - ' || vDescOrigem.ColMESOCodigo  || ' - ' || vDescOrigem.ColMESODescri  || chr(10) ||
              'COLETA MICRO       - ' || vDescOrigem.ColMICROCodigo || ' - ' || vDescOrigem.ColMICRODescri || chr(10) ||
              'COLETA REGIAO      - ' || vDescOrigem.ColREGCodigo   || ' - ' || vDescOrigem.ColREGDescri   || chr(10) ||
              'COLETA REGIAOV     - ' || vDescOrigem.ColREGVCodigo  || ' - ' || vDescOrigem.ColREGVDescri  || chr(10) ||
              chr(10) || 
              'ENTREGA            - ' || vDescOrigem.EntLocCodigo   || ' - ' || vDescOrigem.EntLocDescri   || chr(10) ||
              'ENTREGA CAP/INT    - ' || vDescOrigem.EntCIDescri                                           || chr(10) ||
              'ENTREGA IBGE       - ' || vDescOrigem.EntIBGECodigo  || ' - ' || vDescOrigem.EntIBGEDescri  || chr(10) ||
              'ENTREGA MESO       - ' || vDescOrigem.EntMESOCodigo  || ' - ' || vDescOrigem.EntMESODescri  || chr(10) ||
              'ENTREGA MICRO      - ' || vDescOrigem.EntMICROCodigo || ' - ' || vDescOrigem.EntMICRODescri || chr(10) ||
              'ENTREGA REGIAO     - ' || vDescOrigem.EntREGCodigo   || ' - ' || vDescOrigem.EntREGDescri   || chr(10) ||
              'ENTREGA REGIAOV    - ' || vDescOrigem.EntREGVCodigo  || ' - ' || vDescOrigem.EntREGVDescri  || chr(10) ||
              chr(10) || 
              'KM         - [' || ListaVaux.cnKM || ']' || chr(10) ||
              'PESOCOB    - ' || ListaNotas.CnPESOCOBRADO || chr(10) ||
              'PESOCUBADO - ' || ListaNotas.cnPESOCUBADO || chr(10) ||
              'TP COL     - ' || ListaNotas.cnEntregaCol || chr(10) ||
              'TP FRETE   - ' || V_CIFFOB || chr(10) || 
              'TPCALCULO  -   ' || vDescCalculo || chr(10) ||
--              'TPCARGA CALCTESTE   - ' || ListaCargaCli.ccTPCARGACLIDESC || chr(10) ||
              'VEIC USANDO- ' || V_TIPOVEICULO || chr(10) ||
              'SACBUSCA   - ' || V_SACADOCARGA || chr(10) ||
              'GRPBUSCA   - ' || V_GRUPOCARGAS || chr(10) ||
              'FLAGPGTO   - ' || ListaNotas.cnFLAGPGTO || chr(10) ||
              'TpCargaNota- ' || ListaNotas.cnTpCarga || chr(10) || 
              'TPTRANSP ASN - ' || ListaNotas.cnTIPOTRANSP || chr(10) ||
              'TPCARGA  - ' || ListaNotas.cnTIPOCARGA || chr(10) ||
              'CHAVE NOTA - ' || ListaNotas.cnCHAVENFE || chr(10) ||
              '',1,1999);
      
    End fni_retcenario;

  

-- function fn_verifica_carga(pCargaQuadrem in tdvadm.t_xml_coleta.xml_coleta_tipocarga%type,
 function fn_verifica_carga(pCargaQuadrem in tdvadm.T_ARM_COLETAPART.arm_coletapart_tipocarga%type,
                            pCargaColeta  in tdvadm.t_arm_coleta.glb_tpcarga_codigo%type)
   return varchar2
  is
  Begin
     if(V_ARM_CARREGAMENTO = '720768') then
         return 'FRACIONADO';                  
     end if;
     if ( pCargaQuadrem is null ) or trim(pCargaQuadrem) = '' Then
         if substr(pCargaColeta,1,1) IN ('L','7') Then
            return 'LOTACAO';
         ElsIf substr(pCargaColeta,1,1) IN ('F','5') then      
            return 'FRACIONADO';
         ElsIf  substr(pCargaColeta,1,1) IN ('E','4') then       
            return 'EXPRESSO';    
         ElsIf pCargaColeta = '01' Then  
            return 'LOTACAO';
         Else
            return 'FRACIONADO';   
         End If;   
     End If;

     return trim(upper(pCargaQuadrem));
     
  End fn_verifica_carga;

-- function fn_verifica_Veiculo(pTransporteQuadrem in tdvadm.t_xml_coleta.xml_coleta_tipotransporte%type,
 function fn_verifica_Veiculo(pTransporteQuadrem in tdvadm.T_ARM_COLETAPART.arm_coletapart_veiculo%type,
                              pCargaColeta  in tdvadm.t_arm_coleta.glb_tpcarga_codigo%type,
                              pTpVeiculo    in tdvadm.t_arm_coleta.fcf_tpveiculo_codigo%type,
                              PCarregamento in tdvadm.t_arm_carregamento.arm_carregamento_codigo%type)
   return varchar2
  is
     vTipo tdvadm.t_fcf_tpveiculo.fcf_tpveiculo_descricao%type;
     vTipovC tdvadm.t_fcf_tpveiculo.fcf_tpveiculo_descricao%type;
     vContrato tdvadm.t_slf_contrato.slf_contrato_codigo%type;
     vGrupo    tdvadm.t_slf_contrato.glb_grupoeconomico_codigo%type; 
  Begin
     if ( pTransporteQuadrem is null ) or trim(pTransporteQuadrem) = '' Then
       
         Begin
           select distinct an.slf_contrato_codigo,
                           c.glb_grupoeconomico_codigo
             into vContrato,
                  vGrupo
           from tdvadm.t_arm_carregamentodet cd,
                tdvadm.t_arm_nota an,
                tdvadm.t_slf_contrato c
           where cd.arm_embalagem_numero = an.arm_embalagem_numero
             and cd.arm_embalagem_sequencia = an.arm_embalagem_sequencia
             and an.slf_contrato_codigo = c.slf_contrato_codigo
             and cd.arm_carregamento_codigo = PCarregamento;
         exception
           when OTHERS Then
              vContrato := null;
           End;
         Begin
         SELECT TV.FCF_TPVEICULO_DESCRICAO
           INTO vTipo
         FROM TDVADM.T_FCF_TPVEICULO TV
         WHERE TV.FCF_TPVEICULO_CODIGO = pTpVeiculo;
     
         SELECT distinct cv.slf_cliregrasveic_nomeveic
           INTO vTipovC
         FROM TDVADM.T_SLF_CLIREGRASVEIC CV
         WHERE CV.FCF_TPVEICULO_CODIGO = pTpVeiculo
           AND CV.FCF_TPCARGA_CODIGO = pCargaColeta;
         Exception
           when OThers Then
              vTipo := 'a';
              vTipovC := 'a';
           End;  
            
--         If ( ( vTipo = vTipovC ) or (vContrato = 'C2018010119' ) )  then
         If vGrupo <> '0020' Then
            return vTipovC;
         End If;
     
         if pTpVeiculo = '7  ' Then --    3-4
            return '3-4';
         ElsIf pTpVeiculo = '2  ' Then --  BI-TREM
            return 'BITREM';
         ElsIf pTpVeiculo = '16 ' Then --  BI-TRUCK
            return 'TRUCK';
         ElsIf pTpVeiculo = '20 ' Then --  BUG 20
            return 'BUG20';
         ElsIf pTpVeiculo = '21 ' Then --  BUG 40
            return 'BUG40';
         ElsIf pTpVeiculo = '1  ' Then --  CARRETA
            return 'CARRETA';
         ElsIf pTpVeiculo = '17 ' Then --  CARRETA FIXA
            return 'CARRETA';
         ElsIf pTpVeiculo = '12 ' Then -- CARRETA L
            return 'CARRETA';
         ElsIf pTpVeiculo = '13 ' Then --  CARRETA LS
            return 'CARRETA';
         ElsIf pTpVeiculo = '5  ' Then --  FIORINO
            return 'UTILITARIO';
         ElsIf pTpVeiculo = '19 ' Then --  KIA BONGO
            return 'UTILITARIO';
         ElsIf pTpVeiculo = '0  ' Then --  LOCALIZAR
            return '';
         ElsIf pTpVeiculo = '11 ' Then --  MALOTE
            return 'UTILITARIO';
         ElsIf pTpVeiculo = '6  ' Then --  MOTO
            return 'UTILITARIO';
         ElsIf pTpVeiculo = '15 ' Then --  RODO-TREM
            return 'BI-TREM';
         ElsIf pTpVeiculo = '10 ' Then --  S10
            return 'UTILITARIO';
         ElsIf pTpVeiculo = '9  ' Then --  SEM VEICULO (FRACIONADO)
            return 'SEMVEICULO';
         ElsIf pTpVeiculo = '18 ' Then --  STRADA-SAVEIRO-MONTANA
            return 'UTILITARIO';
         ElsIf pTpVeiculo = '4  ' Then --  TOCO
            return 'TOCO';
         ElsIf pTpVeiculo = '3  ' Then --  TRUCK
            return 'TRUCK';
         ElsIf pTpVeiculo = '22 ' Then --  UTILITARIO
            return 'UTILITARIO';
         ElsIf pTpVeiculo = '23 ' Then --  CARRO
            return 'CARRO';
         ElsIf pTpVeiculo = '8  ' Then --  VAN
            return 'UTILITARIO';
         ElsIf pTpVeiculo = '14 ' Then --  VANDERLEA
             return 'VANDERLEIA';
         ElsIf substr(pCargaColeta,2,1) = 'C' Then
            return 'CARRETA';
         ElsIf substr(pCargaColeta,2,1) = 'T' then      
            return 'TRUCK';
         ElsIf substr(pCargaColeta,2,1) = 'B' then      
            return 'BITREM';
         ElsIf substr(pCargaColeta,2,1) = 'F' then      
            return 'SEMVEICULO';
         Else

/*            Begin
              SELECT --VD.FCF_TPVEICULO_CODIGO TPDISP,
                     V.FCF_TPVEICULO_DESCRICAO
                 into vTipo
              FROM TDVADM.T_ARM_CARREGAMENTO C,
                   TDVADM.T_FCF_VEICULODISP VD,
                   TDVADM.T_FCF_TPVEICULO V
              WHERE C.FCF_VEICULODISP_CODIGO = VD.FCF_VEICULODISP_CODIGO
                AND C.FCF_VEICULODISP_SEQUENCIA = VD.FCF_VEICULODISP_SEQUENCIA     
                AND VD.FCF_TPVEICULO_CODIGO = V.FCF_TPVEICULO_CODIGO
                AND C.ARM_CARREGAMENTO_CODIGO = PCarregamento;
            exception
              When NO_DATA_FOUND Then
                 vTipo := '';
            End ;     
*/
            Begin
              select trim(tv.fcf_tpveiculo_descricao)
                 into vTipo
              from tdvadm.t_fcf_tpveiculo tv
              where tv.fcf_tpveiculo_codigo = pTpVeiculo;
              
            exception
              When NO_DATA_FOUND Then
                 vTipo := '';
              end;
            return vTipo;   
         End If;   
     end If;
     return pTransporteQuadrem;
     
  End fn_verifica_Veiculo;





 Function fn_RetTipoColeta(pColeta in TDVADM.T_arm_nota.arm_coleta_ncompra%type,
                           pColetaCiclo in  TDVADM.T_arm_nota.arm_coleta_ciclo%type)
   return  varchar2
   is
     vTipo tdvadm.t_arm_coleta.arm_coleta_tipo%type;
 Begin
     Begin
        SELECT nvl(CO.ARM_COLETA_TIPO,'ENTREGA')
          into vTipo
        FROM TDVADM.T_ARM_COLETA CO
        WHERE CO.ARM_COLETA_NCOMPRA = pColeta
          and co.arm_coleta_ciclo = pColetaCiclo;
     exception
       When NO_DATA_FOUND Then
           vTipo := 'ENTREGA';
       End;     
       
       return vTipo;
            
 End fn_RetTipoColeta;  
 
 
 Function fn_RetRotaArmazem(pArmazem in tdvadm.t_arm_armazem.arm_armazem_codigo%type)
   return tdvadm.t_arm_armazem.glb_rota_codigo%type
   is
   vRota tdvadm.t_arm_armazem.glb_rota_codigo%type;
 Begin
    Begin
       select a.glb_rota_codigo
          into vRota
       from TDVADM.T_arm_armazem a
       where a.arm_armazem_codigo = pArmazem;   
    exception
      When NO_DATA_FOUND Then
         vRota := '999';
    End;
    Return vRota;
     
 End fn_RetRotaArmazem;   

 Function fn_RetLocalidadeArmazem(pArmazem in tdvadm.t_arm_armazem.arm_armazem_codigo%type)
   return tdvadm.t_arm_armazem.glb_localidade_codigo%type
   is
   vLocalidade tdvadm.t_arm_armazem.glb_localidade_codigo%type;
 Begin
    Begin
       select a.glb_localidade_codigo
          into vLocalidade
       from TDVADM.T_arm_armazem a
       where a.arm_armazem_codigo = pArmazem;   
    exception
      When NO_DATA_FOUND Then
         vLocalidade := '99999';
    End;
    Return vLocalidade;
     
 End fn_RetLocalidadeArmazem;   



 Function fn_RetRotaNFArmazem(pArmazem in tdvadm.t_arm_armazem.arm_armazem_codigo%type)
   return tdvadm.t_arm_armazem.glb_rota_codigo%type
   is
   vRota tdvadm.t_arm_armazem.glb_rota_codigo%type;
 Begin
    Begin
       select a.glb_rota_codigonf
          into vRota
       from TDVADM.T_arm_armazem a
       where a.arm_armazem_codigo = pArmazem;   
    exception
      When NO_DATA_FOUND Then
         vRota := '999';
    End;
    Return vRota;
     
 End fn_RetRotaNFArmazem;   

 Function fn_RetCNPJArmazem(pArmazem in tdvadm.t_arm_armazem.arm_armazem_codigo%type)
   return tdvadm.t_arm_armazem.glb_rota_codigo%type
   is
   vCNPJ tdvadm.t_glb_rota.glb_rota_cgc%type;
 Begin
    Begin
       select r.glb_rota_cgc
          into vCNPJ
       from TDVADM.T_arm_armazem a,
            TDVADM.T_glb_rota r
       where a.arm_armazem_codigo = pArmazem
         and a.glb_rota_codigo = r.glb_rota_codigo;
    exception
      When NO_DATA_FOUND Then
         vCNPJ := '99999999999999';
    End;
    Return vCNPJ;
     
 End fn_RetCNPJArmazem;   


          
 Function fn_EColetaExpressa(pColeta in TDVADM.T_arm_nota.arm_coleta_ncompra%type,
                             pColetaCiclo in  TDVADM.T_arm_nota.arm_coleta_ciclo%type)
   return char
   is
     vAuxuliar number;
   Begin              
       
      select count(*)
         into vAuxuliar
      FROM TDVADM.T_ARM_COLETA CO,
           TDVADM.T_ARM_NOTA NT,
           TDVADM.T_ARM_EMBALAGEM EB
      where co.arm_coleta_ncompra = pColeta
        and co.arm_coleta_ciclo = pColetaCiclo
        AND co.arm_coleta_ncompra = NT.ARM_COLETA_NCOMPRA
        and co.arm_coleta_ciclo = NT.ARM_COLETA_CICLO
        AND NT.ARM_EMBALAGEM_NUMERO = EB.ARM_EMBALAGEM_NUMERO
        AND NT.ARM_EMBALAGEM_FLAG = EB.ARM_EMBALAGEM_FLAG
        AND NT.ARM_EMBALAGEM_SEQUENCIA = EB.ARM_EMBALAGEM_SEQUENCIA
        and CO.ARM_COLETA_TPCOLETA = 'E';
/*        
        and ( SUBSTR(CO.GLB_TPCARGA_CODIGO,1,1) = 'E' 
--           or SUBSTR(EB.ARM_TPCARGA_CODIGO,1,1) = 'E' 
           OR CO.ARM_COLETA_TPCOLETA = 'E' );
*/                           

       if vAuxuliar > 0 Then 
          Return 'S';
       Else
          Return 'N';
       End If;   

 End fn_EColetaExpressa;
   
 Function fn_EColetaExpressa(pColeta in TDVADM.T_arm_nota.arm_coleta_ncompra%type)
   return char 
 is 
   vCiclo TDVADM.T_ARM_COLETA.ARM_COLETA_CICLO%TYPE; 
 Begin
   Begin
     /*
       Corrigido problema de falta de ligacao de tabela
       Depois de reclames de lentidao na entrada de NOTA
       Sirlano
       feito em 30/03/2020
     */
      select MAX(CO.ARM_COLETA_CICLO)
         into vCiclo
      FROM TDVADM.T_ARM_COLETA CO,
           TDVADM.T_ARM_NOTA NT
      where co.arm_coleta_ncompra = pColeta
        AND co.arm_coleta_ncompra = NT.ARM_COLETA_NCOMPRA
        and co.arm_coleta_ciclo = NT.ARM_COLETA_CICLO;                        
     
      Return fn_EColetaExpressa(pColeta, vCiclo);
   
   Exception
      When OTHERS Then
         Return 'N';
   End;      
       
 End fn_EColetaExpressa; 

 Function fn_EProdutoQuimico(pNota in TDVADM.T_arm_nota.arm_nota_numero%type,
                             pCnpj in TDVADM.T_arm_nota.glb_cliente_cgccpfremetente%type,
                             pSerie in TDVADM.T_arm_nota.arm_nota_serie%type)
   return  char                           
   is
   vAuxiliar number;
  Begin
    
     select count(*)
       into vAuxiliar
     from TDVADM.T_ARM_NOTAFICHAEMERG fe,
          TDVADM.T_arm_nota an,
          TDVADM.T_glb_cliente cl
     where fe.arm_nota_numero = pNota
       and fe.glb_cliente_cgccpfremetente = trim(pCnpj)
       and fe.arm_nota_serie = pSerie
       and fe.arm_nota_sequencia = an.arm_nota_sequencia
       and an.glb_cliente_cgccpfsacado = trim(cl.glb_cliente_cgccpfcodigo)
       and nvl(fe.glb_onuclascli_codigo,ProdutoQuimicoPerigoso) = decode(cl.glb_grupoeconomico_codigo,'0020',nvl(fe.glb_onuclascli_codigo,ProdutoQuimicoPerigoso),ProdutoQuimicoPerigoso)
       and fe.glb_onu_codigo <> '9999';

     if vAuxiliar > 0 Then
        return 'S';
     Else
        return 'N';
     End If;   

  End fn_EProdutoQuimico;

 Function fn_GetPercentExpresso(pListaAux in TpAuxiliar,
                                pListaNota in TpNota 
                               ) return number
   as
     vAuxiliarchar char(1);
   Begin
      If ( trunc(sysdate) >= '17/08/2015' ) and ( pListaAux.cnGRUPOEC = '0535' ) Then
         If pListaAux.cnTpVeiculo = '7  ' Then   -- Veiculo 3/4
            Return 1.70;
         ElsIf pListaAux.cnTpVeiculo = '22 ' Then   -- Veiculo Utilitario
            Return 1.70;
         Else
            return nvl(pListaAux.cnPercentEx,1);
         End If;   
      Else
         return nvl(pListaAux.cnPercentEx,1);
      End If;
   End fn_GetPercentExpresso;

 Function fn_GetPercentQuimico(pListaAux  in TpAuxiliar,
                               pListaNota in TpNota ) return number
   as
     vAuxiliarchar char(1);
   Begin
 
        if pListaAux.cnSomaPesoQP > 0 Then
           tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Peso do Produto QUIMICO para NOVO CALCULO ' || pListaAux.cnSomaPesoQP || '-' || pListaAux.cnPercentQP  || ' - ' || pListaAux.cnCONTRATO || ' - ' || pListaAux.cnGRUPOEC ;
           vAuxiliarchar := fn_InsereLogGeracao;

           
           If ( pListaAux.cnCONTRATO in ('C5900011012',       -- 0020 - MRO-VALE-0314-CS2781910
                                         'C2014030105')) Then -- 0020 - MRO-VALE MANGANES-0314-CS2781910/M
           
               
               If ( trunc(sysdate) >= '17/10/2015' ) Then -- Data real do Acordo e 01/10/2015
                  if pListaNota.cnPESOCOBRADO <= 12500 Then
                     return 1.60;
                  Else
                     return 1.40;
                  End If;   
               
               Elsif ( trunc(sysdate) >= '21/10/2015' )   Then
                  -- 0 a 5 ton. taxa de 75%
                  if pListaNota.cnPESOCOBRADO <= 5000 Then
                     return 1.75; 
                  -- 5,01 a 12,5 ton. taxa de 60%   
                  ElsIf pListaNota.cnPESOCOBRADO <= 12500 Then
                     return 1.60;
                  -- 12,51 a 40 ton. taxa de 45%   
                  Else --If pListaAux.cnSomaPesoQP < 40000 Then
                    if ( trunc(sysdate) >= '10/06/2015' )  Then
                       return 1.40;
                    Else
                       return 1.45;
                    End If; 
                  End If;     
                  -- Ate esta data pegava pelo peso total dos quimicos
                  -- a pedido do Marques mudei para o Peso da Nota.
               Elsif ( trunc(sysdate) >= '01/06/2015' ) and ( trunc(sysdate) <= '20/10/2015' ) Then
                  -- 0 a 5 ton. taxa de 75%
                  if pListaAux.cnSomaPesoQP <= 5000 Then
                     return 1.75; 
                  -- 5,01 a 12,5 ton. taxa de 60%   
                  ElsIf pListaAux.cnSomaPesoQP <= 12500 Then
                     return 1.60;
                  -- 12,51 a 40 ton. taxa de 45%   
                  Else --If pListaAux.cnSomaPesoQP < 40000 Then
                    if ( trunc(sysdate) >= '10/06/2015' )  Then
                       return 1.40;
                    Else
                       return 1.45;
                    End If; 
                  End If; 
               End If;       
           Else 
              return nvl(pListaAux.cnPercentQP,1);
           End If;
        Else
          return 1;   
        End If;

   End fn_GetPercentQuimico;


 Function fn_RetOrigDestNota(pTipo in char, -- (O)rigem (D)estino,(C)oleta, (E)ntrega
                             pNota in TDVADM.T_arm_nota.arm_nota_numero%type,
                             pCnpj in TDVADM.T_arm_nota.glb_cliente_cgccpfremetente%type,
                             pSerie in TDVADM.T_arm_nota.arm_nota_serie%type,
                             pColeta in TDVADM.T_arm_nota.arm_coleta_ncompra%type default null,
                             pColetaCiclo in  TDVADM.T_arm_nota.arm_coleta_ciclo%type default null,
                             pChave in TDVADM.T_arm_nota.arm_nota_chavenfe%type default null,
                             pDiasDigitada in number default 120)
   return  TDVADM.T_glb_localidade.glb_localidade_codigo%Type                            
   is
   vColeta      TDVADM.T_arm_nota.arm_coleta_ncompra%type;
   vColetaCiclo TDVADM.T_arm_nota.arm_coleta_ciclo%type;
   vTpParceito  TDVADM.T_arm_coletatppar.arm_coletatppar_codigo%type;
   vRetorno     TDVADM.T_glb_localidade.glb_localidade_codigo%Type;
   vTipo        char(1);
   vRet         char(1);
   vAuxiliar    number;
   vAuxiliarT   TDVADM.T_glb_localidade.glb_localidade_codigo%Type;
   vErro        clob; 
   vOrigemReal  char(1);
   vTipoColeta  char(1);
   vLog         clob;
   vProc        varchar2(1000) := 'PKG_FIFO_CARREGCTRC.fn_RetOrigDestNota';
 Begin  
   
   
      
/*    if tpNotaCte.Arm_Notacte_Codigo is null Then
       begin
       select *
         into tpNotaCte
       from TDVADM.T_arm_notacte c
       where c.arm_nota_numero = pNota
         and c.glb_cliente_cgccpfremetente = rpad(pCnpj,20)
         and c.arm_nota_serie = rpad(pSerie,3)
         and c.con_conhecimento_codigo is null
         AND c.ARM_NOTACTE_CODIGO in ('DE', 'RE');
       exception
         when OTHERS Then
           vErro := sqlerrm;
           vTipo := vTipo;
         end;
      
    end If;
*/
    -- Tipo Coleta ou Entrega, Origem ou Destino
    vTipo := substr(pTipo,1,1);
    -- separa o tipo de Retorno I Ibge ou N para Localidade
    vRet  := nvl(substr(pTipo,2,1),'N');
    -- Se devolve a localidade Real ou Calculada pela regra.
    vOrigemReal := nvl(substr(pTipo,3,1),'C');

--   if ListaCargaCli.ccTPCARGACLI in ('13','14') Then
      if ( nvl(tpNotaCte.Arm_Notacte_Codigo,'XX') <> 'NO' ) OR
         ( ( nvl(tpNotaCte.Arm_Nota_Numero,0) <> pNota ) and 
         ( nvl(tpNotaCte.Glb_Cliente_Cgccpfremetente,'XXXXXXXXXXXXXXXXXXXX') <> rpad(pCnpj,20)) ) Then
        Begin
         select *
           into tpNotaCte
         from TDVADM.T_arm_notacte cte
         where cte.arm_nota_numero = pNota
           and cte.glb_cliente_cgccpfremetente = rpad(pCnpj,20)
           and cte.con_conhecimento_codigo is null
           and cte.arm_notacte_codigo <> 'NO';
--           and cte.arm_notacte_codigo = decode(ListaCargaCli.ccTPCARGACLI,'13','DE','RE') ;
         exception
           When NO_DATA_FOUND Then
              tpNotaCte.Arm_Notacte_Codigo := null;
              tpNotaCte := null;
           End ;

       End If;
--   End IF;        

    
    If nvl(tpNotaCte.Arm_Notacte_Codigo,'NO') in ('DE','RE') Then
       vColeta      := tpNotaCte.Arm_Coleta_Ncompra;
       vColetaCiclo := tpNotaCte.Arm_Coleta_Ciclo;
    Else
       vColeta      := nvl(pColeta,'000000');
       vColetaCiclo := nvl(pColetaCiclo,'000');   
    End If;   
    
    Begin
        select co.arm_coleta_entcoleta,
               nvl(ListaVaux.cnArmazem,co.arm_armazem_codigo)
           into vTipoColeta,
                ListaVaux.cnArmazem
        from TDVADM.T_arm_coleta co
        where co.arm_coleta_ncompra = vColeta
          and co.arm_coleta_ciclo =  vColetaCiclo;
    exception
      When NO_DATA_FOUND Then
         vTipoColeta := 'C';
      End;    
    

    vlog :=         'Nota [' || pTipo || ']-[' || pNota || ']-[' || pCnpj || ']-[' || pSerie || ']' || Chr(10);
    vLog := vLog || 'Coltea [' || pColeta || ']-[' || pColetaCiclo || ']' || chr(10);
    vLog := vLog || 'Chave [' || pChave || ']-[' || pDiasDigitada || ']' || chr(10);
    vLog := vLog || 'Tipo Coleta [' || vTipoColeta || ']' || chr(10);


    Begin
    If nvl(tpNotaCte.Arm_Notacte_Codigo,'NO') = 'NO' Then
      
        if vColeta = '000000' Then
           Select distinct an.arm_coleta_ncompra,
                  an.arm_coleta_ciclo
             into vColeta,
                  vColetaCiclo
           from TDVADM.T_arm_nota an  
           where an.arm_nota_numero = pNota
             and trim(an.glb_cliente_cgccpfremetente) = trim(pCnpj)
             and an.arm_nota_serie = pSerie
             and an.arm_armazem_codigo = nvl(ListaVaux.cnArmazem,an.arm_armazem_codigo)
             and nvl(an.arm_nota_chavenfe,'x') = nvl(pChave,'x')
             and an.con_conhecimento_codigo is null;    

            Begin
                select co.arm_coleta_entcoleta
                   into vTipoColeta
                from TDVADM.T_arm_coleta co
                where co.arm_coleta_ncompra = vColeta
                  and co.arm_coleta_ciclo =  vColetaCiclo;
            exception
              When NO_DATA_FOUND Then
                 vTipoColeta := 'C';
              End;    

        End  If; 
        
        if nvl(vTipo,'E') = 'E' Then
           vTpParceito := 'CE'; -- Destino Diferente da Nota
           Begin
              Select distinct ce.glb_localidade_codigo
                into vRetorno
              from TDVADM.T_arm_coletaparceiro cp,
                   TDVADM.T_glb_cliend ce
              where cp.arm_coleta_ncompra = vColeta
                and cp.arm_coleta_ciclo = vColetaCiclo
                and cp.arm_coletatppar_codigo = vTpParceito
                and trim(cp.glb_cliente_cgccpfpar) = trim(ce.glb_cliente_cgccpfcodigo)
                and cp.glb_tpcliend_codigopar = ce.glb_tpcliend_codigo;
                vLog := vLog || 'Achou com parceiro tipo [' || vTpParceito || ']' || chr(10);
           Exception
             When NO_DATA_FOUND Then
               begin   
                vRetorno := '00000';
                              
                SELECT distinct CD.GLB_LOCALIDADE_CODIGODESTINO
                   into vRetorno
                FROM TDVADM.T_ARM_NOTA N,
                     TDVADM.T_Arm_Carga CD
                where n.arm_nota_numero = pNota
                  and trim(n.glb_cliente_cgccpfremetente) = trim(pCnpj)
                  and n.arm_nota_serie = pSerie
                  and n.con_conhecimento_serie is null 
                  and n.arm_armazem_codigo = nvl(ListaVaux.cnArmazem,n.arm_armazem_codigo)
                  and nvl(n.arm_nota_chavenfe,'x') = nvl(pChave,'x')
                  AND N.ARM_CARGA_CODIGO = CD.ARM_CARGA_CODIGO
                  AND N.ARM_NOTA_DTINCLUSAO >= SYSDATE - nvl(pDiasDigitada,120);

                vLog := vLog || 'Achou Pela Localidade da Carga da Nota ' || chr(10);
  
                exception 
                  when NO_DATA_FOUND then  
                   begin   
                     vRetorno := '00000';
                    Select distinct ce.glb_localidade_codigo
                         into vRetorno
                       from TDVADM.T_arm_Nota nt,
                            TDVADM.T_glb_cliend ce
                    where nt.arm_nota_numero = pNota
                      and trim(nt.glb_cliente_cgccpfremetente) = trim(pCnpj)
                      and nt.arm_nota_serie = pSerie
                      and nvl(nt.arm_nota_chavenfe,'x') = nvl(pChave,'x')
                      and nt.arm_armazem_codigo = nvl(ListaVaux.cnArmazem,nt.arm_armazem_codigo)
                      and rpad(nt.glb_cliente_cgccpfdestinatario,20) = ce.glb_cliente_cgccpfcodigo
                      and nt.glb_tpcliend_coddestinatario = ce.glb_tpcliend_codigo
                      AND NT.ARM_NOTA_DTINCLUSAO >= SYSDATE - nvl(pDiasDigitada,120);

                    vLog := vLog ||  'Achou pelo Endereco da Nota t_glb_cliend ' || chr(10);

                    exception when others then  
                      return '00000';
          --            RAISE_APPLICATION_ERROR(-20001,'Oirgem ' || pTipo || ' - Verifique Nota - ' || pNota||' CNPJ - '||pCnpj || ' erro - ' || sqlerrm);
                     End;
               when OTHERS Then
                  RAISE_APPLICATION_ERROR(-20101,'Oirgem ' || pTipo || ' - Verifique Nota - ' || pNota||' CNPJ - '||pCnpj ||' pSerie: '|| pSerie || 'pChave: ' || pChave ||  ' erro - ' || sqlerrm);
                        
                end;  
                
             End;
        ElsIf nvl(vTipo,'E') = 'C' Then
            vTpParceito := 'CC'; -- Origem diferente da nota
           Begin
              Select distinct ce.glb_localidade_codigo
                into vRetorno
              from TDVADM.T_arm_coletaparceiro cp,
                   TDVADM.T_glb_cliend ce
              where cp.arm_coleta_ncompra = vColeta
                and cp.arm_coleta_ciclo = vColetaCiclo
                and cp.arm_coletatppar_codigo = vTpParceito
                and cp.glb_cliente_cgccpfpar = ce.glb_cliente_cgccpfcodigo
                and cp.glb_tpcliend_codigopar = ce.glb_tpcliend_codigo;
              vLog := vLog ||  'Achou com parceiro tipo [' || vTpParceito || ']' || chr(10);
                
           Exception
             When NO_DATA_FOUND Then
               begin
                 -- Trocado em 01/12/2015 - Sirlano
--                  if ( (( NVL(ListaCargaCli.ccColetaCobra,'N') = 'S' ) and ( vOrigemReal = 'C' ) ) or ( vTipoColeta = 'E' ) ) Then
                  if ( ( NVL(ListaCargaCli.ccColetaCobra,'N') = 'S'   ) or ( vTipoColeta = 'E' ) ) Then
                     Select distinct a.glb_localidade_codigo
                       into vRetorno
                     from TDVADM.T_arm_Nota nt,
                          TDVADM.T_arm_armazem a
                     where nt.arm_nota_numero = pNota
                       and trim(nt.glb_cliente_cgccpfremetente) = trim(pCnpj)
                       and nt.arm_nota_serie = pSerie
                       and nvl(nt.arm_nota_chavenfe,'x') = nvl(pChave,'x')
                       and nt.arm_armazem_codigo = nvl(ListaVaux.cnArmazem,nt.arm_armazem_codigo)
                       and nt.con_conhecimento_serie is null 
                       and nt.arm_armazem_codigo = a.arm_armazem_codigo;

                      vLog := vLog ||  'Colocou o Armazem por COBRA COLETA [' || ListaCargaCli.ccColetaCobra || '] or TIPO COLETA [' || vTipoColeta || ']' ||  chr(10);
                   Else
        --             Select distinct ce.glb_localidade_codigo
                     Select distinct nt.glb_localidade_codigoorigem
                       into vRetorno
                     from TDVADM.T_arm_Nota nt
                     where nt.arm_nota_numero = pNota
                       and trim(nt.glb_cliente_cgccpfremetente) = trim(pCnpj)
                       and nt.arm_nota_serie = pSerie
                       and nvl(nt.arm_nota_chavenfe,'x') = nvl(pChave,'x')
                       and nt.arm_armazem_codigo = nvl(ListaVaux.cnArmazem,nt.arm_armazem_codigo)
                       and nt.con_conhecimento_serie is null ;
                      vLog := vLog ||  'Colocou a Coleta digitada na Nota' ||  chr(10);
                   End If;
                      
               exception
                 When OTHERS Then 
                   begin
        --             Select distinct ce.glb_localidade_codigo
                     Select distinct NT.glb_localidade_codigoorigem
                       into vRetorno
                     from TDVADM.T_arm_Nota nt,
                          TDVADM.T_glb_cliend ce
                  where nt.arm_nota_numero = pNota
                    and trim(nt.glb_cliente_cgccpfremetente) = trim(pCnpj)
                    and nt.arm_nota_serie = pSerie
                    and nvl(nt.arm_nota_chavenfe,'x') = nvl(pChave,'x')
                    and nt.arm_armazem_codigo = nvl(ListaVaux.cnArmazem,nt.arm_armazem_codigo)
                    and rpad(nt.glb_cliente_cgccpfremetente,20) = ce.glb_cliente_cgccpfcodigo
                    and nt.glb_tpcliend_codremetente = ce.glb_tpcliend_codigo
                    AND NT.ARM_NOTA_DTINCLUSAO >= SYSDATE - nvl(pDiasDigitada,120);
    --                and nvl(nt.con_conhecimento_serie,'XXX') <> 'A1';
                   vLog := vLog ||  'Achou pelo Endereco da Nota t_glb_cliend ' || chr(10);

                   exception
                     When OTHERS Then 
                        vLog := vLog ||  'Deu Algum ERRO -> ' || chr(10) || sqlerrm || chr(10);
                        vLog := vLog ||  'Retornou 00000' || chr(10);
                        tdvadm.sp_log_tempgrava(vProc,vLog);
                        return '00000';
                     End;   
                 end; 
             End;
        End If;
    Else
        if nvl(vTipo,'E') = 'E' Then
           vRetorno := tpNotaCte.Glb_Localidade_Codigodestino;
        ElsIf nvl(vTipo,'E') = 'C' Then
           Vretorno := tpNotaCte.Glb_Localidade_Codigoorigem;
        End If;

    End If;
    
    
    
    if nvl(vRet,'N') in ('I') Then -- Retorna IBGE
       vAuxiliarT :=  tdvadm.fn_busca_codigoibge(vRetorno,'IBC');
       if vAuxiliarT = 'SIBGE' then
         select count(*)
            into vAuxiliar
         FROM V_GLB_IBGE I
         WHERE TRIM(I.codmun) = trim(vRetorno);
         if vAuxiliar = 0 then
            vRetorno := vAuxiliarT;
         End If;   
       Else
           vRetorno := vAuxiliarT;
       End If;
    End If;

    exception
      when NO_DATA_FOUND Then
         vRetorno := null;
    End ;    

    vLog := vLog ||  'Retornou ' || vRetorno || chr(10);
    tdvadm.sp_log_tempgrava(vProc,vLog);

     
    return vRetorno;            
    

 End fn_RetOrigDestNota;                             


 Procedure spi_SqlArmazemCarreg(pArmazem in tdvadm.t_arm_carregamento.arm_armazem_codigo%type,
                                pCarregamento in tdvadm.t_arm_carregamento.arm_carregamento_codigo%type)
   as
   Begin
    -- MONTANDO O SQL PADRAO DAS NOTAS
    ListaSQL.NOTAS :=                   'SELECT DISTINCT N.GLB_CLIENTE_CGCCPFDESTINATARIO CLIDEST,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.GLB_TPCLIEND_CODDESTINATARIO CLIENDDEST,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.GLB_CLIENTE_CGCCPFSACADO CLISAC,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.GLB_TPCLIEND_CODSACADO CLIENDSAC,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' CLS.GLB_GRUPOECONOMICO_CODIGO GRUPOEC,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' CLR.GLB_GRUPOECONOMICO_CODIGO GRUPOECREM,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' CLD.GLB_GRUPOECONOMICO_CODIGO GRUPOECDES,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.GLB_CLIENTE_CGCCPFREMETENTE CLIREM,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.GLB_TPCLIEND_CODREMETENTE CLIENDREM,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' VD.CAR_CARRETEIRO_CPFCODIGO CARRETEIRO,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' VD.CAR_CARRETEIRO_SAQUE CARRETEIROSAQ,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' VD.CAR_VEICULO_PLACA CARRETEIROPLACA,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' VD.CAR_VEICULO_SAQUE CARRETEIROPLACASAQ, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' VD.FRT_CONJVEICULO_CODIGO CONJFROTA, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' VD.FCF_VEICULODISP_FLAGVIRTUAL VIRTUAL, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' substr(TDVADM.PKG_FIFO_CARREGCTRC.fn_RetRotaArmazem(''' || pArmazem || '''),1,3) ROTA,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' ECR.GLB_LOCALIDADE_CODIGO ORIGEMCLI, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.GLB_LOCALIDADE_CODIGOORIGEM ORIGEM, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' ECD.GLB_LOCALIDADE_CODIGO DESTINO, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_LOCALCOLETAL COLETA, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_LOCALENTREGAL ENTREGA, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_LOCALOUTRACOLETAL OUTRACOLETA, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_LOCALOUTRAENTREGAL OUTRAENTREGA, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_COLETA_NCOMPRA NRCOLETA,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' LPAD(N.ARM_NOTA_NUMERO,9,''0'') NOTA,'; --cnNOTA
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_EMBALAGEM_NUMERO EMBALAGEM1,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.GLB_EMBALAGEM_CODIGO EMBALAGEM,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_VALORMERC VLRMERC,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_QTDVOLUME QTDVOLUMES,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_PESO cnPESO,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_PESOBALANCA cnPESOBAL,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' ''KG'' UNIDADE,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' 0 NUMERO,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_MERCADORIA MERCADORIA,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' nvl(N.ARM_NOTA_PESOBALANCA,0) PESOCOBRADO,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_LARGURA LARGURA,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_ALTURA ALTURA,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_COMPRIMENTO COMPRIMENTO,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_CUBAGEM CUBAGEM,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' 1 REMONTA,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' nvl(N.ARM_MOVIMENTO_PESOCUBADO,0) PESOCUBADO,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_DTRECEBIMENTO DATANOTA,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_MOVIMENTO_DATANFENTRADA,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_SERIE,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_ONU ONU,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_GRPEMB,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' O.GLB_ONU_KGISENTA KGISENTO,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_FLAGONU FLGPRODP,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' tdvadm.FN_CON_VERIFICASPOT(N.GLB_LOCALIDADE_CODIGOORIGEM,ECD.GLB_LOCALIDADE_CODIGO,N.ARM_COLETA_NCOMPRA, n.arm_coleta_ciclo) SPOT,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' substr(TDVADM.PKG_FIFO_CARREGCTRC.fn_RetRotaNFArmazem(''' || pArmazem || '''),1,3) ROTANF,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' CLS.GLB_CLIENTE_RAZAOSOCIAL NOMESACADO,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' CLR.GLB_CLIENTE_RAZAOSOCIAL NOMEREMETENTE,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.XML_NOTALINHA_NUMDOC,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' trim(NVL(N.ARM_NOTA_TABSOLCOD,''00000000'')) ARM_NOTA_TABSOLCOD,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' NVL(N.ARM_NOTA_TABSOLSQ,''0000'') ARM_NOTA_TABSOLSQ,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' NVL(N.ARM_NOTA_TABSOL,''T'') ARM_NOTA_TABSOL,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_DI,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.GLB_CFOP_CODIGO,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' ECD.GLB_CLIEND_CODCLIENTE,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_RI,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.CON_TPDOC_CODIGO,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_CHAVENFE,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_COLETA_CICLO,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_FLAGPGTO,';

--    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' X.XML_COLETA_NUMERO,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' X.ARM_COLETAPART_CODIGO,';
--    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' TDVADM.PKG_FIFO_CARREGCTRC.fn_verifica_Veiculo(X.XML_COLETA_TIPOTRANSPORTE,C.GLB_TPCARGA_CODIGO,C.FCF_TPVEICULO_CODIGO,' || TDVADM.PKG_glb_common.Fn_QuotedStr(pCarregamento) || '),';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' TDVADM.PKG_FIFO_CARREGCTRC.fn_verifica_Veiculo(X.ARM_COLETAPART_VEICULO,C.FCF_TPCARGA_CODIGO,C.FCF_TPVEICULO_CODIGO,' || TDVADM.PKG_glb_common.Fn_QuotedStr(pCarregamento) || '),';
-- Sirlano 04/08/2014 retirei a funcao e coloquei a coluna
--    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' TDVADM.PKG_FIFO_CARREGCTRC.FN_VERIFICA_CARGA(X.XML_COLETA_TIPOCARGA,C.GLB_TPCARGA_CODIGO),';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' NVL(C.ARM_COLETA_TPCARGACALC,' || TDVADM.PKG_glb_common.Fn_QuotedStr('OOOO') || '),';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' C.ARM_COLETA_ENTCOLETA,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' C.ARM_COLETA_TIPO,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' C.FCF_TPVEICULO_CODIGO, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_SEQUENCIA, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_NOTA_VIDE, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' (SELECT COUNT(DISTINCT NN.ARM_NOTA_NUMERO) ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                '  FROM TDVADM.T_ARM_NOTA NN, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                '       TDVADM.T_ARM_CARREGAMENTODET CDD ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                '  WHERE NN.ARM_COLETA_NCOMPRA = N.ARM_COLETA_NCOMPRA ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                '    AND NN.ARM_EMBALAGEM_NUMERO = CDD.ARM_EMBALAGEM_NUMERO ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                '    AND NN.ARM_EMBALAGEM_FLAG = CDD.ARM_EMBALAGEM_FLAG ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                '    AND NN.ARM_EMBALAGEM_SEQUENCIA = CDD.ARM_EMBALAGEM_SEQUENCIA ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                '    AND CDD.ARM_CARREGAMENTO_CODIGO = ' || TDVADM.PKG_GLB_COMMON.fn_QuotedStr(pCarregamento) || ') QTDECOL, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.CON_CONHECIMENTO_CODIGO , ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.GLB_ROTA_CODIGO, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.GLB_TPCARGA_CODIGO, ';
--    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' X.XML_COLETA_INCOTERMS, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' X.ARM_COLETAPART_TIPOFRETE, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' C.ARM_COLETA_PEDIDO, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.GLB_MERCADORIA_CODIGO, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.SLF_CONTRATO_CODIGO, ';        
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' N.ARM_JANELACONS_SEQUENCIA, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' NVL(JC.ARM_JANELACONS_PESOCONS,0), ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' NVL(JC.ARM_JANELACONS_MERCCONS,0), ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' ARM_COLETA_DTFECHAMENTO cnFechamentoCol, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' NVL(c.arm_coleta_containertara,0) cnTaraContainer, ';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' X.arm_coletapart_dtenvcli cnDtClienteInf,';
    ListaSQL.NOTAS := ListaSQL.NOTAS ||                ' nvl(X.arm_coletapart_pesoinfcli,0) cnPesoClienteInf '; 

    -- MONTA A CLAUSULA DE TABELAS MAIS WHERE PADRAO
    ListaSQL.TABWHERE :=                      'FROM TDVADM.T_ARM_CARREGAMENTODET CD,';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||     ' TDVADM.T_ARM_CARREGAMENTO CA,';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||     ' TDVADM.T_FCF_VEICULODISP VD,';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||     ' TDVADM.T_ARM_EMBALAGEM E,';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||     ' TDVADM.T_ARM_CARGADET CCD,';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||     ' TDVADM.T_ARM_NOTA N,';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||     ' TDVADM.T_GLB_CLIEND ECR,';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||     ' TDVADM.T_GLB_CLIEND ECD,';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||     ' TDVADM.T_GLB_CLIENTE CLS,';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||     ' TDVADM.T_GLB_CLIENTE CLR,';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||     ' TDVADM.T_GLB_CLIENTE CLD,';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||     ' TDVADM.T_GLB_ONU O, ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||     ' TDVADM.T_ARM_COLETA C,';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||     ' TDVADM.T_ARM_COLETAIMPEXP CI, ';
--    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||     ' TDVADM.T_XML_COLETA X, ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||     ' TDVADM.T_ARM_COLETAPART X, ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||     ' TDVADM.T_ARM_JANELACONS JC ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE || 'WHERE CD.ARM_CARREGAMENTO_CODIGO = ''' || pCarregamento || '''';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND CD.ARM_CARREGAMENTO_CODIGO = CA.ARM_CARREGAMENTO_CODIGO ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND CA.ARM_ARMAZEM_CODIGO = ''' || pArmazem || '''';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND CA.FCF_VEICULODISP_CODIGO = VD.FCF_VEICULODISP_CODIGO ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND CA.FCF_VEICULODISP_SEQUENCIA = VD.FCF_VEICULODISP_SEQUENCIA ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND VD.FCF_VEICULODISP_DATA >= SYSDATE - 30 ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND N.ARM_COLETA_NCOMPRA = C.ARM_COLETA_NCOMPRA ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND N.ARM_COLETA_CICLO = C.ARM_COLETA_CICLO ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND N.ARM_COLETA_NCOMPRA = CI.ARM_COLETA_NCOMPRA (+) ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND N.ARM_COLETA_CICLO = CI.ARM_COLETA_CICLO (+) ';
--    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND C.XML_COLETA_NUMERO = X.XML_COLETA_NUMERO (+) ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND N.ARM_COLETA_NCOMPRA = X.ARM_COLETA_NCOMPRA (+) ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND N.ARM_COLETA_CICLO = X.ARM_COLETA_CICLO (+) ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND N.ARM_JANELACONS_SEQUENCIA = JC.ARM_JANELACONS_SEQUENCIA (+) ';
     
    
    /******************************************************************************************************/
    /** KLAYTON EM 30/03/2015                                                                            **/
    /** INCLUIDO O STATUS = AR NO SELECT, PELOS OS CASOS DE COLETAS FCA QUE Nao RESPONDEREMOS NA HORA    **/
    /** E SIM QUANDO TIVERMOS O CTRC GERADO, ISSO PARA EVITAR O ENVIO DE RESPOSTA EM ROTAS DIFERENTES    **/
    /******************************************************************************************************/
--    Begin
      
       --ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND NVL(X.XML_COLETA_SEQUENCIA,0) = nvl((SELECT MAX(NVL(X1.XML_COLETA_SEQUENCIA,0)) FROM TDVADM.T_XML_COLETA X1 WHERE X1.XML_COLETA_NUMERO = X.XML_COLETA_NUMERO AND X1.XML_COLETA_TIPODOC = ''ASN'' AND X1.XML_COLETA_GRAVADO = ''CVRD'' AND X1.XML_COLETA_STATUS = ''OK'' AND X1.ARM_COLETA_NCOMPRA = X.ARM_COLETA_NCOMPRA AND X1.ARM_COLETA_CICLO = X.ARM_COLETA_CICLO),0) ' ;
       -- COLOQUEI A CRITICA QUE O CNPJ DO REMETENTE NAO PODE SER NULO 09/10/2015 SIRLANO
--       ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND NVL(X.XML_COLETA_SEQUENCIA,0) = nvl((SELECT MAX(NVL(X1.XML_COLETA_SEQUENCIA,0)) FROM TDVADM.T_XML_COLETA X1 WHERE X1.XML_COLETA_NUMERO = X.XML_COLETA_NUMERO AND X1.XML_COLETA_TIPODOC = ''ASN'' AND X1.XML_COLETA_GRAVADO = ''CVRD'' AND X1.XML_COLETA_STATUS in (''OK'',''AR'') AND X1.ARM_COLETA_NCOMPRA = X.ARM_COLETA_NCOMPRA AND X1.ARM_COLETA_CICLO = X.ARM_COLETA_CICLO /*AND X1.GLB_CLIENTE_CGCCPFREMETENTE IS NOT NULL*/),0) ' ;
-- retirado em 24/08/2016
-- Com a nova tabela de particularidades da coleta Nao sera mais necessario
--       ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND NVL(X.XML_COLETA_SEQUENCIA,0) = nvl((SELECT MAX(NVL(X1.XML_COLETA_SEQUENCIA,0)) FROM TDVADM.T_XML_COLETA X1 WHERE X1.XML_COLETA_NUMERO = X.XML_COLETA_NUMERO AND X1.XML_COLETA_TIPODOC = ''ASN'' AND X1.XML_COLETA_GRAVADO = ''CVRD'' AND X1.XML_COLETA_STATUS in (''OK'',''AR'') AND X1.ARM_COLETA_NCOMPRA = X.ARM_COLETA_NCOMPRA AND X1.ARM_COLETA_CICLO = X.ARM_COLETA_CICLO /*AND X1.GLB_CLIENTE_CGCCPFREMETENTE IS NOT NULL*/),0) ' ;
    
--    End;
    /*****************************************************/

    -- TODA ALTERAC?O QUE FIZER NESSE CODIGO. FAZER TAMBEM NA VIEW TDVADM.V_ARM_VERIFCARREG
    -- RETIRADO EM 08/05/2014 KLAYTON E SIRLANO.
    --ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND ''ASNR''            = X.XML_COLETA_TIPODOC(+) ';
    --ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND ''TDV''             = X.XML_COLETA_GRAVADO(+) ';
    
    -- INCLUIDO EM 08/05/2014 KLAYTON E SIRLANO.
-- retirado em 24/08/2016
-- Com a nova tabela de particularidades da coleta Nao sera mais necessario
--    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND ''ASN''              = X.XML_COLETA_TIPODOC(+) ';
--    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND ''CVRD''             = X.XML_COLETA_GRAVADO(+) ';
    
--    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND C.ARM_COLETA_NCOMPRA = X.ARM_COLETA_NCOMPRA (+) ';
--    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND C.ARM_COLETA_CICLO   = X.ARM_COLETA_CICLO (+) ';
    
    
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND CD.ARM_EMBALAGEM_NUMERO = E.ARM_EMBALAGEM_NUMERO ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND CD.ARM_EMBALAGEM_FLAG = E.ARM_EMBALAGEM_FLAG ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND CD.ARM_EMBALAGEM_SEQUENCIA = E.ARM_EMBALAGEM_SEQUENCIA ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND CCD.ARM_EMBALAGEM_NUMERO = E.ARM_EMBALAGEM_NUMERO ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND CCD.ARM_EMBALAGEM_FLAG = E.ARM_EMBALAGEM_FLAG ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND CCD.ARM_EMBALAGEM_SEQUENCIA = E.ARM_EMBALAGEM_SEQUENCIA ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND CCD.ARM_NOTA_NUMERO = N.ARM_NOTA_NUMERO ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND N.ARM_CARGA_CODIGO = CCD.ARM_CARGA_CODIGO '; -- COLOCADO EM 16/01/2009 PEGA SOMENTE AS NOTAS VALIDAS SEM SUJEIRA
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND CCD.ARM_CARGA_CODIGO IS NOT NULL ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND trim(N.GLB_CLIENTE_CGCCPFREMETENTE) = trim(CCD.GLB_CLIENTE_CGCCPFREMETENTE (+)) ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND E.ARM_EMBALAGEM_DTFECHADO IS NOT NULL ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND RPAD(N.GLB_CLIENTE_CGCCPFSACADO, 20) = CLS.GLB_CLIENTE_CGCCPFCODIGO (+) ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND RPAD(N.GLB_CLIENTE_CGCCPFDESTINATARIO, 20) = CLD.GLB_CLIENTE_CGCCPFCODIGO (+) ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND RPAD(N.GLB_CLIENTE_CGCCPFREMETENTE, 20) = CLR.GLB_CLIENTE_CGCCPFCODIGO (+) ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND RPAD(N.GLB_CLIENTE_CGCCPFREMETENTE, 20) = ECR.GLB_CLIENTE_CGCCPFCODIGO  ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND N.GLB_TPCLIEND_CODREMETENTE = ECR.GLB_TPCLIEND_CODIGO  ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND RPAD(N.GLB_CLIENTE_CGCCPFDESTINATARIO, 20) = ECD.GLB_CLIENTE_CGCCPFCODIGO  ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND N.GLB_TPCLIEND_CODDESTINATARIO = ECD.GLB_TPCLIEND_CODIGO  ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND RPAD(E.GLB_CLIENTE_CGCCPFDESTINATARIO, 20) = ECD.GLB_CLIENTE_CGCCPFCODIGO  ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND N.ARM_NOTA_ONU = O.GLB_ONU_CODIGO (+) ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND NVL(N.ARM_NOTA_GRPEMB,''SE'') = O.GLB_ONU_GRPEMB (+) ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||  ' AND N.ARM_NOTA_SEQUENCIA = (SELECT MAX(OO.ARM_NOTA_SEQUENCIA) ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||                              ' FROM TDVADM.T_ARM_NOTA OO ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||                              ' WHERE OO.ARM_NOTA_NUMERO = N.ARM_NOTA_NUMERO ';
    ListaSQL.TABWHERE := ListaSQL.TABWHERE ||                                ' AND OO.GLB_CLIENTE_CGCCPFREMETENTE = N.GLB_CLIENTE_CGCCPFREMETENTE) ';

   End spi_SqlArmazemCarreg; 

 Procedure spi_SqlSacGrupoContrato(pSacado in TDVADM.T_glb_cliente.glb_cliente_cgccpfcodigo%type ,
                                   pGrupo in tdvadm.t_glb_grupoeconomico.glb_grupoeconomico_codigo%type,
                                   pContratoCargas IN TDVADM.T_arm_nota.slf_contrato_codigo%type)
   as
   Begin

      -- WHERE PARA CONTA REPARO
      ListaSQL.RPWHERE :=                     ' AND 0 < (SELECT COUNT(*) ';
      ListaSQL.RPWHERE := ListaSQL.RPWHERE ||          ' FROM TDVADM.T_GLB_CLIENTE CC ';
      ListaSQL.RPWHERE := ListaSQL.RPWHERE ||          ' WHERE cc.glb_cliente_cgccpfcodigo = RPAD(N.GLB_CLIENTE_CGCCPFDESTINATARIO, 20) ';
      ListaSQL.RPWHERE := ListaSQL.RPWHERE ||            ' AND CC.GLB_GRUPOECONOMICO_CODIGO <> ' || TDVADM.PKG_glb_common.fn_QuotedStr(pGrupo) || ')';
      -- Temporariamente porque temos um Cliente
      -- que REPARO pode ser DELE para ELE
      -- Sirlano 19/07/2018
      ListaSQL.RPWHERE := '';
      ListaSQL.RPWHERE := ListaSQL.RPWHERE || ' AND 0 < (SELECT COUNT(*) ';
      ListaSQL.RPWHERE := ListaSQL.RPWHERE ||          ' FROM TDVADM.T_GLB_CLIENTE CC ';
      ListaSQL.RPWHERE := ListaSQL.RPWHERE ||          ' WHERE cc.glb_cliente_cgccpfcodigo = RPAD(N.GLB_CLIENTE_CGCCPFREMETENTE, 20) ';
      ListaSQL.RPWHERE := ListaSQL.RPWHERE ||            ' AND CC.GLB_GRUPOECONOMICO_CODIGO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pGrupo) || ')';

        -- MONTA SELECT PARA PEGAR OS TIPOS DE CARGA
        ListaSQL.FINALCARG := '';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || 'SELECT CC.FCF_TPCARGA_CODIGO              ccTPCARGACLI, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       TC.fcf_tpcargadescricao            ccTPCARGACLIDESC, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.FCF_TPCARGA_CODIGOPESQ          ccTPCARGACLIPESQ, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_AGCTRC        ccTPCARGAAGRUPACTRC, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_QTDECTRC      ccTPCARGAQTDEAGCTRC, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_AGNF          ccTPCARGAAGRUPANF, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_QTDENF        ccTPCARGAQTDEAGNF, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTEREGRAS_PCOBRANCA     ccPCOBRANCA, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTEREGRAS_BASEOCUPACAO  ccBASEOCUPACAO, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTEREGRAS_VALORBASE     ccVALORBASE, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_PMINIMO       ccPESOMINIMO, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_PROCEDURE     ccPROCEDURE, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_RATEIA        ccRATEIA, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_TPRATEIO_CODIGO             ccTPRATEIO, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_TPAGRUPA_CODIGO             ccTPAGRUPA, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_QPCOLCTRC     ccTPCARGAQPCOLCTRC, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_QPCOLNF       ccTPCARGAQPCOLNF, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_PRIOREXQM     ccPRIOREXQM, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_PERCNTEX      ccPERCTEX, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_PERCNTQM      ccPERCTQM, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_PERCNTOUT     ccPERCTOUT, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_PERCNTTRA     ccPERCTRA, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_REDUTOR       ccPERCTREDUTOR, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_FORMULAFRTX   ccFORMULAFRTX, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_FORMULAFRTVL  ccFORMULAFRVL, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_FORMULAFRTKM  ccFORMULAFRKM, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_FORMULAPDTX   ccFORMULAPDTX, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_FORMULAPDVL   ccFORMULAPDVL, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_TPFRETE_CODIGO              ccTPFRETE, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_FIXAORIGEM    ccORIGEMFIXA, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_FIXADESTINO   ccDESTINOFIXO, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_FORMULARIOQM  ccEXIGEFORMQM, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_FORMULARIOEX  ccEXIGEFORMEX, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_SOTRANSF      ccSOTRANSF,';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTEREGRAS_TABKM         ccTABKM, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       TC.FCF_TPCARGA_CODIGO              ccTPCARGA, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       TF.SLF_TPFRETE_DESCRICAO           ccTPCARGADESC, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       TF.SLF_TPFRETE_TPCODORIGEM         ccTPCODORIGEM, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       TF.SLF_TPFRETE_TPCODDESTINO        ccTPCODDESTINO, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       TF.SLF_TPFRETE_TPCODOCOUTRACOL     ccTPCODOCOUTRACOL, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       TF.SLF_TPFRETE_TPCODOCOUTRAENTR    ccTPCODOCOUTRAENTR, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_USAFAIXAKM    ccUSAFAIXAKM, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_USAFAIXAPESO  ccUSAFAIXAPS, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_USAFAIXAVG    ccUSAFAIXAVG, ';
--        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       TF.SLF_TPFRETE_TPUSAVEICULO       ccUSAVEICULO, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_USAVEICULO    ccUSAVEICULO, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_PESQVEICULO   ccPESQVEICULO, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       TF.SLF_TPFRETE_OBS                 ccTPFRETEOBS, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_KMMINIMO      ccKMMinimo, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_COBRACOLETA   ccColetaCobraTmp, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_COBRACOLETA   ccColetaCobra, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_FORCOBCOLETA  ccColetaTpCobranca, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_TPFRETE_CODIGOCOL           ccTPFRETECOL, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.FCF_TPCARGA_CODIGOCOL           ccTPCARGACLICOL, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_FORMULACOLTX  ccFORMULACOLTX, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_FORMULACOLVL  ccFORMULACOLVL, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_FORMULACOLKM  ccFORMULACOLKM, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       TFC.SLF_TPFRETE_DESCRICAO          ccTPCARGADESCCOL, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       TFC.SLF_TPFRETE_TPCODORIGEM        ccTPCODORIGEMCOL, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       TFC.SLF_TPFRETE_TPCODDESTINO       ccTPCODDESTINOCOL,';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_USAFAIXAKMC   ccUSAFAIXAKMCOL, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_USAFAIXAPSOC  ccUSAFAIXAPSCOL, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_USAFAIXAVGC   ccUSAFAIXAVGCOL, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_USAVEICULOC   ccUSAVEICULOCOL, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_PESQVEICULOC  ccPESQVEICULOCOL, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_AGRPORCOLETA  ccAgrpPorColeta, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_LIMITECTE     ccLimiteCTe, '; 
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_LIMITENFSE    ccLimiteNFSe, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_CTEDECOLETA   ccCteColeta, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTEREGRAS_GLOBALIZADO   ccCteGlobalizado, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_PESAGEMMAX    ccLimitePesagem, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_MUDAORIGEMCC  ccMudaOrigemCC, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTECARGAS_PARASEMPCC    ccParaSemPCC,';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '       CC.SLF_CLIENTEREGRAS_VALEPED       ccPagaValePedagio ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || 'FROM TDVADM.V_SLF_CLIENTECARGAS2 CC, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '     TDVADM.T_FCF_TPCARGA TC, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '     TDVADM.T_SLF_TPFRETE TF, ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '     TDVADM.T_SLF_TPFRETE TFC ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || 'WHERE CC.GLB_CLIENTE_CGCCPFCODIGO = ''' || pSacado || '''';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '  AND CC.SLF_CONTRATO_CODIGO = ''' || pContratoCargas || '''';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '  AND CC.GLB_GRUPOECONOMICO_CODIGO = ''' || pGrupo || '''';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '  AND CC.FCF_TPCARGA_CODIGO = TC.FCF_TPCARGA_CODIGO ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '  AND CC.SLF_TPFRETE_CODIGO = TF.SLF_TPFRETE_CODIGO ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || '  AND CC.SLF_TPFRETE_CODIGOCOL = TFC.SLF_TPFRETE_CODIGO (+) ';
        ListaSQL.FINALCARG := ListaSQL.FINALCARG || 'ORDER BY CC.SLF_CLIENTECARGAS_SEQEXEC ';




     
   End spi_SqlSacGrupoContrato;

   
   Procedure spi_SqlCliEnvolvidos(pTpQuebra in TpQuebras)
     as
     Begin

     ListaSQL.NOTASWHERE := '';


    if nvl(pTpQuebra.TABSOLCOD,SemTabelaCodigo) <> SemTabelaCodigo Then
--        ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND NVL(N.ARM_NOTA_TABSOL,''T'') = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pTpQuebra.TPTABSOL);
       ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND trim(NVL(N.ARM_NOTA_TABSOLCOD,''00000000'')) = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pTpQuebra.TABSOLCOD);
       ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND lpad(NVL(Trim(N.ARM_NOTA_TABSOLSQ), ''0''), 4, ''0'') = ' || TDVADM.PKG_glb_common.fn_QuotedStr(lpad(nvl(Trim(pTpQuebra.TABSOLSQ),'0'),4,'0'));
    End If;   

    If ListaAgrupaCli.acContrato = 'S' Then
       If ListaQuebras.CONTRATO is not null Then
          ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND nvl(N.SLF_CONTRATO_CODIGO,' || TDVADM.PKG_glb_common.fn_QuotedStr(QualquerContrato) || ') = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pTpQuebra.CONTRATO);
       End If;          
    End If;

    If ListaAgrupaCli.acSacado = 'S' Then
        ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND N.GLB_CLIENTE_CGCCPFSACADO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pTpQuebra.CLISAC);
    End If;
    
    If ListaAgrupaCli.acNrNota = 'S' Then
       ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND ROWNUM = 1 ';
    End If;

     
    If ListaAgrupaCli.acRemetente = 'S' Then
-- RETIRADO EM 12/01/2017 ESTAVA CONSOLIDANDO ERRADO AS CARGAS DA albras alunorte E hydra
--      If nvl(ListaCargaCli.ccColetaCobra,'N') = 'N' Then
--       if ListaQuebras.ENTCOL <> 'E' Then
          ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND N.GLB_CLIENTE_CGCCPFREMETENTE = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pTpQuebra.CNPJREM);
--       End If;   
    End If; 
            
    If ListaAgrupaCli.acDestinatario = 'S' Then
        ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND N.GLB_CLIENTE_CGCCPFDESTINATARIO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pTpQuebra.CNPJDES);
    End If; 

--    If ListaAgrupaCli.acTpEndRemetente = 'S' Then
--       if ListaQuebras.ENTCOL <> 'E' Then
--          ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND N.GLB_TPCLIEND_CODDESTINATARIO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pTpQuebra.CLIENDDES);
--       End If;
--    End If; 

--    If ListaAgrupaCli.acTpEndDestino = 'S' Then
--        ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND N.GLB_TPCLIEND_CODDESTINATARIO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pTpQuebra.CLIENDDES);
--    End If; 

--    If ListaAgrupaCli.acLocalidadeColeta = 'S' Then
      
--    End If; 

--    If ListaAgrupaCli.acLocalidadeEntrega = 'S' Then
      
--    End If; 

    If ListaAgrupaCli.acIBGEColeta = 'S' Then
       ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTpQuebra.ORIGEMNOTA,'IBC')),8) || '''';
    End If; 

    If ListaAgrupaCli.acIBGEEntrega = 'S' Then
       ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTpQuebra.DESTINONOTA,'IBC')),8) || '''';
    End If; 

--    If ListaAgrupaCli.acColetaEntrega = 'S' Then
      
--    End If; 

--    If ListaAgrupaCli.acTPCarga = 'S' Then
      
--    End If; 

    If ListaAgrupaCli.acNrColeta = 'S' Then
       ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND N.ARM_COLETA_NCOMPRA  = ''' ||  pTpQuebra.NRCOLETA || '''';
    End If; 
    
    
    If ListaAgrupaCli.acQuimico = 'S' Then
      ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND TDVADM.PKG_FIFO_CARREGCTRC.fn_EProdutoQuimico(n.arm_nota_numero,n.glb_cliente_cgccpfremetente,N.ARM_NOTA_SERIE) = ''' ||  pTpQuebra.ccQuimico || '''';
    End If;

    If ListaAgrupaCli.acExpresso = 'S' Then
      ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND TDVADM.PKG_FIFO_CARREGCTRC.fn_EColetaExpressa(N.ARM_COLETA_NCOMPRA,N.ARM_COLETA_CICLO) = ''' ||  pTpQuebra.ccExpresso || '''';
    End If;     

    

    If  nvl(ListaQuebras.ccTPRATEIO,'02') = 'XX' then 

            if nvl(ListaQuebras.ccTPRATEIO,'02') = '01' then

        /*
        OK-CONTRATO
        OK-SACADO
        OK-DESTINO
        OK-TpEndDestino

        Localidade da Coleta
        Localidade da Entrega
        OK-COL / ENTREGA
        */

                ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND N.GLB_CLIENTE_CGCCPFSACADO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pTpQuebra.CLISAC);
                ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND N.GLB_CLIENTE_CGCCPFDESTINATARIO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pTpQuebra.CNPJDES);
                ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND N.GLB_TPCLIEND_CODDESTINATARIO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pTpQuebra.CLIENDDES);

            ElsIf nvl(ListaQuebras.ccTPRATEIO,'02') = '02' Then
        /*
        OK-CONTRATO
        OK-REMETENTE 
        OK-IBGE Coleta
        OK-IBGE Entrega
        OK-TPCarga
        OK-COL / ENTREGA
        */
               -- se for entraga Nao considera o remetente    
               if ListaQuebras.ENTCOL <> 'E' Then
                  ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND N.GLB_CLIENTE_CGCCPFREMETENTE = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pTpQuebra.CNPJREM);
               End If;   
                      
               ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTpQuebra.ORIGEMNOTA,'IBC')),8) || '''';
               ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTpQuebra.DESTINONOTA,'IBC')),8) || '''';


            ElsIf nvl(ListaQuebras.ccTPRATEIO,'02') = '03' Then
        /*
        OK-CONTRATO
        OK-SACADO
        OK-DESTINO
        OK-TpEndDestino
        Localidade da Coleta
        Localidade da Entrega
        OK-COL / ENTREGA
        */     

                ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND N.GLB_CLIENTE_CGCCPFSACADO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pTpQuebra.CLISAC);
                ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND N.GLB_CLIENTE_CGCCPFDESTINATARIO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pTpQuebra.CNPJDES);
                ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND N.GLB_TPCLIEND_CODDESTINATARIO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pTpQuebra.CLIENDDES);

            ElsIf nvl(ListaQuebras.ccTPRATEIO,'02') = '04' Then
        /*
        OK-CONTRATO
        OK-NRCOLETA
        OK-IBGE Coleta,
        OK-IBGE Entrega
        OK-TPCarga
        */     

               ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTpQuebra.ORIGEMNOTA,'IBC')),8) || '''';
               ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTpQuebra.DESTINONOTA,'IBC')),8) || '''';


                -- Sem Regra
                ListaQuebras.ccTPRATEIO := ListaQuebras.ccTPRATEIO;

            ElsIf nvl(ListaQuebras.ccTPRATEIO,'02') = '05' Then
        /*
        OK-CONTRATO
        OK-REMETENTE
        OK-DESTINO
        OK-IBGE Coleta
        OK-IBGE Entrega
        OK-TPCarga
        OK-COL / ENTREGA
        */     

               ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND N.GLB_CLIENTE_CGCCPFREMETENTE = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pTpQuebra.CNPJREM);
               ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND N.GLB_CLIENTE_CGCCPFDESTINATARIO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pTpQuebra.CNPJDES);

               ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTpQuebra.ORIGEMNOTA,'IBC')),8) || '''';
               ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTpQuebra.DESTINONOTA,'IBC')),8) || '''';



            ElsIf nvl(ListaQuebras.ccTPRATEIO,'02') = '06' Then

        /*
        OK-CONTRATO
        OK-SACADO
        Localidade da Coleta
        */

                ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || ' AND N.GLB_CLIENTE_CGCCPFSACADO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(pTpQuebra.CLISAC);

            End If;
    End If;
    
     
  End spi_SqlCliEnvolvidos;


   Procedure spi_SqlColetaEntrega(pColeta in tdvadm.t_glb_cliend.glb_localidade_codigo%type ,
                                  pEntrega in tdvadm.t_glb_cliend.glb_localidade_codigo%type,
                                  pListaCargaCli in TpCargaCli )
     as
     
     -- SIRLANO 05/09/2014
       vOrigem  varchar2(200);
       vDestino varchar2(200);
     
   Begin
     

        ListaSQL.SCWHERE     := '';
        ListaSQL.EXWHERErat  := '';
        ListaSQL.PQWHERErat  := ''; -- Nao tem

        ListaSQL.LotWHERErat := '';
        ListaSQL.RMWHERErat  := '';
        ListaSQL.WHERECOL    := '';
        ListaSQL.SPOT        := '';  -- Nao tem
        ListaSQL.FraWHERErat := '';




        If ListaAgrupaCli.acColetaEntrega = 'S' Then
           If ListaQuebras.ENTCOL is Not Null then
--           if nvl(ListaQuebras.ccTPRATEIO,'02') in ('01','02','03') Then
             ListaSQL.SCWHERE := ListaSQL.SCWHERE || ' AND C.ARM_COLETA_ENTCOLETA = ' || TDVADM.PKG_glb_common.fn_QuotedStr(ListaQuebras.ENTCOL); 
           End If;
        End If ;


       
--     vSql := vSql || '          AND TRIM(CK.SLF_CALCFRETEKM_ORIGEMI)  = TRIM(DECODE(TRIM(T.FCF_TPCARGA_CODIGO),'08',P_CODIGOORI,'99999'))
     if pListaCargaCli.ccTPCODORIGEM    = 'NN' Then -- Nao Pesquisa
        vOrigem := '99999';
        vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pColeta,'IBC')),8) || '''';
     Elsif pListaCargaCli.ccTPCODORIGEM = 'LO' Then -- Localidade
        vOrigem := ' AND N.ARM_NOTA_LOCALCOLETAL = ''' || trim(pColeta)  || '''';
     Elsif pListaCargaCli.ccTPCODORIGEM = 'IB' Then -- IBGE
        vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pColeta,'IBC')),8) || '''';
     Elsif pListaCargaCli.ccTPCODORIGEM = 'FI' Then -- FIXO IBGE
        If pListaCargaCli.ccORIGEMFIXA is not null then
           vOrigem := ' AND N.ARM_NOTA_LOCALCOLETA = ''' || rpad(trim(pListaCargaCli.ccORIGEMFIXA),8)  || '''';
        End If;
     Elsif pListaCargaCli.ccTPCODORIGEM = 'RE' Then -- Regiao Cartografica
        vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBR'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pColeta,'IBR')),8) || '''';
     Elsif pListaCargaCli.ccTPCODORIGEM = 'RC' Then -- Regiao Cartografica do Cliente
        vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBRV'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pColeta,'IBRV')),8) || '''';
     Elsif pListaCargaCli.ccTPCODORIGEM = 'CI' Then -- Capital Interior
        vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''CI'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pColeta,'CI')),8) || '''';
     Elsif pListaCargaCli.ccTPCODORIGEM = 'UF' Then -- Por Estado
        vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''UF'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pColeta,'UF')),8) || '''';
     Elsif pListaCargaCli.ccTPCODORIGEM = 'RA' Then -- Por Raio
        vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pColeta,'IBC')),8) || '''';
     Elsif pListaCargaCli.ccTPCODORIGEM = 'ME' Then -- Por Raio
        vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''MEC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pColeta,'MEC')),8) || '''';
     Elsif pListaCargaCli.ccTPCODORIGEM = 'MI' Then -- Por Raio
        vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''MIC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pColeta,'MIC')),8) || '''';
     Else
        vOrigem := null;  
     End If;     
     

     if pListaCargaCli.ccTPCODDESTINO    = 'NN' Then -- Nao Pesquisa
        vDestino := '99999';
        vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pEntrega,'IBC')),8) || '''';
     Elsif pListaCargaCli.ccTPCODDESTINO = 'LO' Then -- Localidade
        vDestino := ' AND N.ARM_NOTA_LOCALENTREGAL = ''' || rpad(trim(pEntrega),8) || '''';
     Elsif pListaCargaCli.ccTPCODDESTINO = 'IB' Then -- IBGE
        vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pEntrega,'IBC')),8) || '''';
     Elsif pListaCargaCli.ccTPCODDESTINO = 'FI' Then -- FIXO IBGE
        If pListaCargaCli.ccDESTINOFIXO is not null Then
           vDestino := ' AND N.ARM_NOTA_LOCALENTREGAI = ''' || rpad(trim(pListaCargaCli.ccDESTINOFIXO),8) || '''';
        End If;
     Elsif pListaCargaCli.ccTPCODDESTINO = 'RE' Then -- Regiao Cartografica
        vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBR'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pEntrega,'IBR')),8) || '''';
     Elsif pListaCargaCli.ccTPCODDESTINO = 'RC' Then -- Regiao Cartografica do Cliente
        vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBRV'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pEntrega,'IBRV')),8) || '''';
     Elsif pListaCargaCli.ccTPCODDESTINO = 'CI' Then -- Capital Interior
        vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''CI'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pEntrega,'CI')),8) || '''';
     Elsif pListaCargaCli.ccTPCODDESTINO = 'UF' Then -- Por Estado
        vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''UF'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pEntrega,'UF')),8) || '''';
     Elsif pListaCargaCli.ccTPCODDESTINO = 'RA' Then -- Por Raio
        vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pEntrega,'IBC')),8) || '''';
     Elsif pListaCargaCli.ccTPCODDESTINO = 'ME' Then -- Por Meso
        vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''MEC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pEntrega,'MEC')),8) || '''';
     Elsif pListaCargaCli.ccTPCODDESTINO = 'MI' Then -- Por Micro
        vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''MIC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pEntrega,'MIC')),8) || '''';
     Else
       vDestino := null;   
     End If; 


        If pColeta is Not Null then
--           if nvl(ListaQuebras.ccTPRATEIO,'02') in ('01','03','06') Then 
           If ListaAgrupaCli.acLocalidadeColeta = 'S' Then
              ListaSQL.SCWHERE := ListaSQL.SCWHERE || ' AND N.ARM_NOTA_LOCALCOLETAL = ''' || trim(pColeta)  || '''';
           Else   
--           Elsif nvl(ListaQuebras.ccTPRATEIO,'02') in ('02','04','05') Then  
--             IF LENGTH(TRIM(pColeta)) = 7 Then
--                ListaSQL.SCWHERE := ListaSQL.SCWHERE || ' AND N.ARM_NOTA_LOCALCOLETAL = ''' || trim(pColeta)  || '''';
--             Else
--                ListaSQL.SCWHERE := ListaSQL.SCWHERE || ' AND N.ARM_NOTA_LOCALCOLETAI = ''' || trim(tdvadm.fn_busca_codigoibge(pColeta,'IBC'))  || '''';
                ListaSQL.SCWHERE := ListaSQL.SCWHERE || vOrigem ;
--             End If;    
           End If;
        End if;   



        If pEntrega is Not Null then
--           if nvl(ListaQuebras.ccTPRATEIO,'02') in ('01','03') Then  
           If ListaAgrupaCli.acLocalidadeEntrega = 'S' Then
              ListaSQL.SCWHERE := ListaSQL.SCWHERE || ' AND N.ARM_NOTA_LOCALENTREGAL = ''' || trim(pEntrega) || '''';
           Else
--           Elsif nvl(ListaQuebras.ccTPRATEIO,'02') in ('02','04','05') Then  
--             IF LENGTH(TRIM(pEntrega)) = 7 Then
--                 ListaSQL.SCWHERE := ListaSQL.SCWHERE || ' AND N.ARM_NOTA_LOCALENTREGAL = ''' || trim(pEntrega) || '''';
--             Else
--                 ListaSQL.SCWHERE := ListaSQL.SCWHERE || ' AND N.ARM_NOTA_LOCALENTREGAI = ''' || trim(tdvadm.fn_busca_codigoibge(pEntrega,'IBC')) || '''';
                 ListaSQL.SCWHERE := ListaSQL.SCWHERE || vDestino;
--             End If;    
           End If;
        End if;   
        

        If pListaCargaCli.ccAgrpPorColeta = 'S' Then
           if nvl(ListaQuebras.NRCOLETA,'01') <> '01' Then
              ListaSQL.SCWHERE := ListaSQL.SCWHERE || ' AND N.ARM_COLETA_NCOMPRA  = ''' || trim(ListaQuebras.NRCOLETA)  || '''';
           End If;   
        End If;


        if ListaQuebras.NRCOLETA is Not Null Then
           ListaSQL.EXWHERErat := ListaSQL.EXWHERErat || ' AND TDVADM.PKG_FIFO_CARREGCTRC.fn_EColetaExpressa(N.ARM_COLETA_NCOMPRA,N.ARM_COLETA_CICLO) = ''S''';
        End If;
        
        If ListaAgrupaCli.acTPCarga = 'S' Then
           ListaSQL.LotWHERErat := ListaSQL.LotWHERErat || ' AND ( NVL(C.ARM_COLETA_TPCARGACALC,' || TDVADM.PKG_glb_common.Fn_QuotedStr('OOOO') ||')  in (' || cCargaLotacao || '))';
           ListaSQL.FraWHERErat := ListaSQL.FraWHERErat || ' AND ( NVL(C.ARM_COLETA_TPCARGACALC,' || TDVADM.PKG_glb_common.Fn_QuotedStr('OOOO') ||')  in (' || cCargaFracionado || '))'; 
           ListaSQL.RMWHERErat  := ListaSQL.RMWHERErat || ' AND ( NVL(C.ARM_COLETA_TPCARGACALC,' || TDVADM.PKG_glb_common.Fn_QuotedStr('OOOO') ||')  in (' || cCargaFracionado || ',' || cCargaLotacao || '))';
           ListaSQL.WHERECOL    := ListaSQL.WHERECOL || ' AND ( NVL(C.ARM_COLETA_TPCARGACALC,' || TDVADM.PKG_glb_common.Fn_QuotedStr('OOOO') ||')  in (' || cCargaColeta || ',' || cCargaLotacao || '))';
        End If;
              
--        if nvl(ListaQuebras.ccTPRATEIO,'02') in ('02','04','05') Then
--           ListaSQL.LotWHERErat := ListaSQL.LotWHERErat || ' AND ( NVL(C.ARM_COLETA_TPCARGACALC,' || TDVADM.PKG_glb_common.Fn_QuotedStr('OOOO') ||')  in (' || cCargaLotacao || '))';
--        End If;

--        if nvl(ListaQuebras.ccTPRATEIO,'02')  in ('02','04','05') Then
--           ListaSQL.RMWHERErat := ListaSQL.RMWHERErat || ' AND ( NVL(C.ARM_COLETA_TPCARGACALC,' || TDVADM.PKG_glb_common.Fn_QuotedStr('OOOO') ||')  in (' || cCargaFracionado  || '))';
--           ListaSQL.RMWHERErat := ListaSQL.RMWHERErat || ' AND ( NVL(C.ARM_COLETA_TPCARGACALC,' || TDVADM.PKG_glb_common.Fn_QuotedStr('OOOO') ||')  in (' || cCargaFracionado || ',' || cCargaLotacao || '))';
--        End If;
       
        
   End spi_SqlColetaEntrega;                               




 Procedure spi_SqlFixos 
   as
   Begin
     
      ListaSQL.PQWHERE  := '';
      ListaSQL.PQWHERE2 := '';
      ListaSQL.EXWHERE  := '';  

      ListaSQL.PQWHERE  := ' AND nvl(N.ARM_NOTA_ONU,' || TDVADM.PKG_glb_common.fn_QuotedStr(OnuNaoQuimico) || ') <> ' || TDVADM.PKG_glb_common.fn_QuotedStr(OnuNaoQuimico) ;
      ListaSQL.PQWHERE2 := ' AND ''S'' = TDVADM.PKG_FIFO_CARREGCTRC.fn_EProdutoQuimico(n.arm_nota_numero,n.glb_cliente_cgccpfremetente,N.ARM_NOTA_SERIE) ';

      ListaSQL.EXWHERE :=  ' AND ''S'' = TDVADM.PKG_FIFO_CARREGCTRC.fn_EColetaExpressa(N.ARM_COLETA_NCOMPRA,N.ARM_COLETA_CICLO) ';  

   

    -- aqui que define de onde para onde
    -- MONTANDO O SQL DE SACADOS ENVOLVIDOS NO CAREGAMENTO
      ListaSQL.SACADOS :=                     'SELECT N.GLB_CLIENTE_CGCCPFSACADO CLISAC, ';
      ListaSQL.SACADOS := ListaSQL.SACADOS || ' N.GLB_CLIENTE_CGCCPFREMETENTE REM, ';
      ListaSQL.SACADOS := ListaSQL.SACADOS || ' N.GLB_TPCLIEND_CODREMETENTE ENDREM, ';
      ListaSQL.SACADOS := ListaSQL.SACADOS || ' N.ARM_NOTA_LOCALCOLETAL ORIGEMNOTA,';
      ListaSQL.SACADOS := ListaSQL.SACADOS || ' N.GLB_CLIENTE_CGCCPFDESTINATARIO DEST, ';
      ListaSQL.SACADOS := ListaSQL.SACADOS || ' N.GLB_TPCLIEND_CODDESTINATARIO ENDDEST, ';
      ListaSQL.SACADOS := ListaSQL.SACADOS || ' N.ARM_NOTA_LOCALENTREGAL DESTINONOTA,';
      ListaSQL.SACADOS := ListaSQL.SACADOS || ' C.ARM_COLETA_ENTCOLETA ENTCOLETA, ';
      ListaSQL.SACADOS := ListaSQL.SACADOS || ' N.SLF_CONTRATO_CODIGO, ';
      ListaSQL.SACADOS := ListaSQL.SACADOS || ' TDVADM.PKG_FIFO_CARREGCTRC.fn_RetornaContrato(N.SLF_CONTRATO_CODIGO), ';
      ListaSQL.SACADOS := ListaSQL.SACADOS || ' N.ARM_NOTA_FLAGPGTO, ';
      ListaSQL.SACADOS := ListaSQL.SACADOS || ' CLS.GLB_GRUPOECONOMICO_CODIGO GRUPOEC,';
      ListaSQL.SACADOS := ListaSQL.SACADOS || ' NVL(N.ARM_NOTA_TABSOL,''T'') ARM_NOTA_TABSOL ,';
      ListaSQL.SACADOS := ListaSQL.SACADOS || ' trim(NVL(N.ARM_NOTA_TABSOLCOD,''00000000'')) ARM_NOTA_TABSOLCOD,';
      ListaSQL.SACADOS := ListaSQL.SACADOS || ' NVL(N.ARM_NOTA_TABSOLSQ,''0000'') ARM_NOTA_TABSOLSQ,';
--      ListaSQL.SACADOS := ListaSQL.SACADOS || ' ''01'' ARM_COLETA_NCOMPRA, ';      
      ListaSQL.SACADOS := ListaSQL.SACADOS || ' N.ARM_COLETA_NCOMPRA, ';      
      ListaSQL.SACADOS := ListaSQL.SACADOS || ' ''01'' TPRATEIO, '; 
      ListaSQL.SACADOS := ListaSQL.SACADOS || ' ''01'' TPAGRUPA, '; 
      If ListaAgrupaCli.acNrNota = 'S' Then
         ListaSQL.SACADOS := ListaSQL.SACADOS || ' LPAD(N.ARM_NOTA_NUMERO,9,''0'') NOTA,';
     Else
         ListaSQL.SACADOS := ListaSQL.SACADOS || ' ''01'' NOTA, ';     
      End If;
--      If ListaAgrupaCli.acQuimico = 'S' Then
         ListaSQL.SACADOS := ListaSQL.SACADOS || ' TDVADM.PKG_FIFO_CARREGCTRC.fn_EProdutoQuimico(n.arm_nota_numero,n.glb_cliente_cgccpfremetente,N.ARM_NOTA_SERIE) QUIMICO,';
--      Else
--        ListaSQL.SACADOS := ListaSQL.SACADOS || ' ''N'' QUIMICO, ';
--      End If ;         

--      If ListaAgrupaCli.acExpresso = 'S' Then
         ListaSQL.SACADOS := ListaSQL.SACADOS || ' TDVADM.PKG_FIFO_CARREGCTRC.fn_EColetaExpressa(N.ARM_COLETA_NCOMPRA,N.ARM_COLETA_CICLO) EXPRESSO,';
--      Else
--        ListaSQL.SACADOS := ListaSQL.SACADOS || ' ''N'' EXPRESSO, ';
--      End If;
      
  
      
      ListaSQL.SACADOS := ListaSQL.SACADOS || ' COUNT(*) ';

    -- MONTANDO O GROUP BY DE SACADOS
      ListaSQL.SACADOSGB :=              ' GROUP BY N.GLB_CLIENTE_CGCCPFSACADO,';
      ListaSQL.SACADOSGB := ListaSQL.SACADOSGB || ' N.GLB_CLIENTE_CGCCPFREMETENTE, ';
      ListaSQL.SACADOSGB := ListaSQL.SACADOSGB || ' N.GLB_TPCLIEND_CODREMETENTE, ';
      ListaSQL.SACADOSGB := ListaSQL.SACADOSGB || ' N.ARM_NOTA_LOCALCOLETAL, ';
      ListaSQL.SACADOSGB := ListaSQL.SACADOSGB || ' N.GLB_CLIENTE_CGCCPFDESTINATARIO,';
      ListaSQL.SACADOSGB := ListaSQL.SACADOSGB || ' N.GLB_TPCLIEND_CODDESTINATARIO,';
      ListaSQL.SACADOSGB := ListaSQL.SACADOSGB || ' N.ARM_NOTA_LOCALENTREGAL, ';
      ListaSQL.SACADOSGB := ListaSQL.SACADOSGB || ' C.ARM_COLETA_ENTCOLETA, ';
      ListaSQL.SACADOSGB := ListaSQL.SACADOSGB || ' N.SLF_CONTRATO_CODIGO,';
      ListaSQL.SACADOSGB := ListaSQL.SACADOSGB || ' N.ARM_NOTA_FLAGPGTO,';
      ListaSQL.SACADOSGB := ListaSQL.SACADOSGB || ' CLS.GLB_GRUPOECONOMICO_CODIGO,';
      ListaSQL.SACADOSGB := ListaSQL.SACADOSGB || ' NVL(N.ARM_NOTA_TABSOL,''T''),';
      ListaSQL.SACADOSGB := ListaSQL.SACADOSGB || ' trim(NVL(N.ARM_NOTA_TABSOLCOD,''00000000'')),';
      ListaSQL.SACADOSGB := ListaSQL.SACADOSGB || ' NVL(N.ARM_NOTA_TABSOLSQ,''0000''), ';
      ListaSQL.SACADOSGB := ListaSQL.SACADOSGB || ' N.ARM_COLETA_NCOMPRA, ';      
      ListaSQL.SACADOSGB := ListaSQL.SACADOSGB || ' TDVADM.PKG_FIFO_CARREGCTRC.fn_EProdutoQuimico(n.arm_nota_numero,n.glb_cliente_cgccpfremetente,N.ARM_NOTA_SERIE) ,';
      ListaSQL.SACADOSGB := ListaSQL.SACADOSGB || ' TDVADM.PKG_FIFO_CARREGCTRC.fn_EColetaExpressa(N.ARM_COLETA_NCOMPRA,N.ARM_COLETA_CICLO) '; 
      If ListaAgrupaCli.acNrNota = 'S' Then
         ListaSQL.SACADOSGB := ListaSQL.SACADOSGB || ' ,LPAD(N.ARM_NOTA_NUMERO,9,''0'') ';
      End If;
      ListaSQL.SACADOSGB := ListaSQL.SACADOSGB || ' order by trim(NVL(N.ARM_NOTA_TABSOLCOD,''00000000'')) desc,N.SLF_CONTRATO_CODIGO,N.GLB_CLIENTE_CGCCPFSACADO,N.GLB_TPCLIEND_CODREMETENTE,C.ARM_COLETA_ENTCOLETA ';

End spi_SqlFixos;


 

  FUNCTION FN_BUSCA_TPCARGAVEICULO(P_GRUPO         TDVADM.T_FCF_LIMITECARGAS.GLB_GRUPOECONOMICO_CODIGO%TYPE,
                                   P_CONTRATO      TDVADM.T_FCF_LIMITECARGAS.SLF_CONTRATO_CODIGO%TYPE,
                                   P_CLIENTE       TDVADM.T_FCF_LIMITECARGAS.GLB_CLIENTE_CGCCPFCODIGO%TYPE,
                                   P_PESO          NUMBER,
                                   P_TIPOFRETE     TDVADM.T_SLF_TABELA.SLF_TABELA_TIPO%TYPE,
                                   P_TPVEICULO     VARCHAR2,
                                   P_TPCARGA       VARCHAR2,
                                   P_PESQVEIC      char,
                                   P_TIPODERETORNO CHAR) -- TC TIPO DE CARGA, 
                                                         -- TV TIPO DE VEICULO
    RETURN CHAR
  IS
      V_TPCARGA   TDVADM.T_FCF_LIMITECARGAS.FCF_TPCARGA_CODIGO%TYPE;
      V_TPVEICULO TDVADM.T_FCF_LIMITECARGAS.FCF_TPVEICULO_CODIGO%TYPE;
      vAuxiliar   integer := 0;    
  BEGIN
     V_TPCARGA := NVL(P_TPCARGA,'00');
     vAuxiliar := 0;
     If nvl(P_PESQVEIC,'X') = 'F' and  NVL(P_PESO,0) <> 0 Then 
         BEGIN
            SELECT --LC.GLB_GRUPOECONOMICO_CODIGO,
                   TC.FCF_TPCARGA_CODIGO,
                   --TC.fcf_tpcargadescricao,
                   TV.FCF_TPVEICULO_CODIGO
                   --TV.FCF_TPVEICULO_DESCRICAO
               INTO V_TPCARGA,
                    V_TPVEICULO    
            FROM TDVADM.T_FCF_LIMITECARGAS LC,
                 TDVADM.T_FCF_TPCARGA TC,
                 TDVADM.T_FCF_TPVEICULO TV
            WHERE LC.GLB_GRUPOECONOMICO_CODIGO = P_GRUPO
              AND nvl(LC.SLF_CONTRATO_CODIGO,QualquerContrato) = P_CONTRATO
              AND LC.GLB_CLIENTE_CGCCPFCODIGO = P_CLIENTE
              AND LC.FCF_TPCARGA_CODIGO = TC.FCF_TPCARGA_CODIGO (+)
              AND LC.FCF_TPVEICULO_CODIGO = TV.FCF_TPVEICULO_CODIGO (+)
              AND LC.FCF_TPCARGA_CODIGO = DECODE(V_TPCARGA,'00',LC.FCF_TPCARGA_CODIGO,V_TPCARGA)
              AND P_PESO BETWEEN LC.FCF_LIMITECARGAS_FAIXAI AND LC.FCF_LIMITECARGAS_FAIXAF
              AND LC.FCF_LIMITECARGAS_VIGENCIA <= TRUNC(SYSDATE)
              AND LC.FCF_LIMITECARGAS_VALIDADE >= TRUNC(SYSDATE);
--              AND ROWNUM = 1;
         EXCEPTION
            WHEN NO_DATA_FOUND THEN
               V_TPCARGA   := null;
               V_TPVEICULO := '0  ';

            SELECT max(LC.FCF_LIMITECARGAS_FAIXAF)
               INTO vAuxiliar
            FROM TDVADM.T_FCF_LIMITECARGAS LC,
                 TDVADM.T_FCF_TPCARGA TC,
                 TDVADM.T_FCF_TPVEICULO TV
            WHERE LC.GLB_GRUPOECONOMICO_CODIGO = P_GRUPO
              AND nvl(LC.SLF_CONTRATO_CODIGO,QualquerContrato) = P_CONTRATO
              AND LC.GLB_CLIENTE_CGCCPFCODIGO = P_CLIENTE
              AND LC.FCF_TPCARGA_CODIGO = TC.FCF_TPCARGA_CODIGO (+)
              AND LC.FCF_TPVEICULO_CODIGO = TV.FCF_TPVEICULO_CODIGO (+)
              AND LC.FCF_TPCARGA_CODIGO = DECODE(V_TPCARGA,'00',LC.FCF_TPCARGA_CODIGO,V_TPCARGA)
              AND P_PESO BETWEEN LC.FCF_LIMITECARGAS_FAIXAI AND LC.FCF_LIMITECARGAS_FAIXAF
              AND LC.FCF_LIMITECARGAS_VALIDADE >= TRUNC(SYSDATE)
              AND LC.FCF_LIMITECARGAS_VIGENCIA <= TRUNC(SYSDATE);
 
              -- Se o Numero Der Negativo excedeu o limite da Faixa
              vAuxiliar :=  (  vAuxiliar - P_PESO );
               
               
               
/*               BEGIN
                SELECT --LC.GLB_GRUPOECONOMICO_CODIGO,
                       TC.FCF_TPCARGA_CODIGO,
                       --TC.fcf_tpcargadescricao,
                       TV.FCF_TPVEICULO_CODIGO
                       --TV.FCF_TPVEICULO_DESCRICAO
                   INTO V_TPCARGA,
                        V_TPVEICULO    
                FROM TDVADM.T_FCF_LIMITECARGAS LC,
                     TDVADM.T_FCF_TPCARGA TC,
                     TDVADM.T_FCF_TPVEICULO TV
                WHERE LC.GLB_GRUPOECONOMICO_CODIGO = P_GRUPO
                  AND nvl(LC.SLF_CONTRATO_CODIGO,QualquerContrato) = P_CONTRATO
                  AND LC.GLB_CLIENTE_CGCCPFCODIGO = P_CLIENTE
                  AND LC.FCF_TPCARGA_CODIGO = TC.FCF_TPCARGA_CODIGO (+)
                  AND LC.FCF_TPVEICULO_CODIGO = TV.FCF_TPVEICULO_CODIGO (+)
                  AND P_PESO BETWEEN LC.FCF_LIMITECARGAS_FAIXAI AND LC.FCF_LIMITECARGAS_FAIXAF
                  AND ROWNUM = 1;
               EXCEPTION
                 WHEN NO_DATA_FOUND THEN
                     V_TPCARGA   := null;
                     V_TPVEICULO := null;
               END;
*/         END;
    Elsif nvl(P_PESQVEIC,'X') = 'G' Then
          BEGIN
             SELECT VD.FCF_TPVEICULO_CODIGO
                INTO V_TPVEICULO
             FROM TDVADM.T_ARM_CARREGAMENTO CA
                  ,TDVADM.T_FCF_VEICULODISP VD
             WHERE CA.ARM_CARREGAMENTO_CODIGO = V_ARM_CARREGAMENTO
               AND CA.FCF_VEICULODISP_CODIGO = VD.FCF_VEICULODISP_CODIGO
               AND CA.FCF_VEICULODISP_SEQUENCIA = VD.FCF_VEICULODISP_SEQUENCIA;
          EXCEPTION     
            WHEN OTHERS THEN
               V_TPVEICULO := NULL;
            END ;
    Elsif nvl(P_PESQVEIC,'X') = 'C' Then 
       If P_CONTRATO not in ('C590030755/2','C590030755/3') Then
          if P_TPVEICULO in ('CARRETA',
                             'Cavalo 6x4',
                             'Cavalo 4x2',
                             'BR00000002', -- CARRETA
                             'BR00000007', -- Cavalo 4x2
                             'BR00000009'  -- Cavalo 6x4
                             ) Then 
             V_TPVEICULO := '1  ';
          Elsif P_TPVEICULO in ('BI-TREM',
                                'Cavalo 6x2',
                                'Cavalo 6x6',
                                'BR00000001', -- BI_TREM
                                'BR00000008', -- Cavalo 6x2
                                'BR00000010'  -- Cavalo 6x6
                                ) Then 
             V_TPVEICULO := '2  ';
          Elsif P_TPVEICULO in ('TRUCK','BR00000005') Then 
             V_TPVEICULO := '3  ';
          Elsif P_TPVEICULO in ('TOCO','BR00000004') Then 
             V_TPVEICULO := '4  ';
          Elsif UPPER(P_TPVEICULO) in ('UTILITARIO',
                                       'UTILITARIO',
                                       'BR00000006') Then 
             V_TPVEICULO := '22 ';
          Elsif P_TPVEICULO in ('BUG20',
                                'Cavalo 8x4',
                                'BR00000012',
                                'BR00000011' -- Cavalo 8x4
                                ) Then 
             V_TPVEICULO := '20 ';
          Elsif P_TPVEICULO in ('BUG40','BR00000013') Then 
             V_TPVEICULO := '21 ';
          ElsIf  P_TPVEICULO = 'SEMVEICULO' Then   
             V_TPVEICULO := '9  ';
          Else
            if ListaNotas.cnVeicCarreg is not null Then
               V_TPVEICULO := ListaNotas.cnVeicCarreg;
            Else
               V_TPVEICULO := '0';
            End If;   
          End If  ;
       Else
          If P_TPVEICULO in ('CARRETA',
                             'BR00000007', -- Cavalo 4x2
                             'BR00000010', -- Cavalo 6x6
                             'Cavalo 4x2',
                             'Cavalo 6x6'
                            ) Then
             V_TPVEICULO := '1  ';
          ElsIf P_TPVEICULO in ('BITREM',
                                'BR00000008', -- Cavalo 6x2
                                'BR00000011', -- Cavalo 8x4
                                'Cavalo 6x2',
                                'Cavalo 8x4'
                               ) Then
             V_TPVEICULO := '2  ';
          ElsIf P_TPVEICULO in ('TRUCK',
                                'BR00000009', -- Cavalo 6x4
                                'Cavalo 6x4'
                               ) Then
             V_TPVEICULO := '3  ';
          End If;           
       End If;        
        /*if P_GRUPO = '0020' Then

            -- Mudei para pegar por faixa se o peso for maior que a capacidade encontrada
            -- Pedido do Marques em 23/10/2015
            SELECT count(*)
               INTO vAuxiliar
            FROM TDVADM.T_FCF_LIMITECARGAS LC
            WHERE LC.GLB_GRUPOECONOMICO_CODIGO = P_GRUPO
              AND nvl(LC.SLF_CONTRATO_CODIGO,QualquerContrato) = P_CONTRATO
              AND LC.GLB_CLIENTE_CGCCPFCODIGO = P_CLIENTE
              AND LC.FCF_TPCARGA_CODIGO = DECODE(V_TPCARGA,'00',LC.FCF_TPCARGA_CODIGO,V_TPCARGA)
              and lc.fcf_tpveiculo_codigo = V_TPVEICULO
              AND P_PESO < LC.FCF_LIMITECARGAS_FAIXAF
              AND LC.FCF_LIMITECARGAS_VIGENCIA <= TRUNC(SYSDATE)
              AND LC.FCF_LIMITECARGAS_VALIDADE >= TRUNC(SYSDATE);
          
            if vAuxiliar = 0 Then
                Begin
                SELECT --LC.GLB_GRUPOECONOMICO_CODIGO,
                       --TC.FCF_TPCARGA_CODIGO,
                       --TC.fcf_tpcargadescricao,
                       TV.FCF_TPVEICULO_CODIGO
                       --TV.FCF_TPVEICULO_DESCRICAO
                   INTO V_TPVEICULO    
                FROM TDVADM.T_FCF_LIMITECARGAS LC,
                     TDVADM.T_FCF_TPCARGA TC,
                     TDVADM.T_FCF_TPVEICULO TV
                WHERE LC.GLB_GRUPOECONOMICO_CODIGO = P_GRUPO
                  AND nvl(LC.SLF_CONTRATO_CODIGO,QualquerContrato) = P_CONTRATO
                  AND LC.GLB_CLIENTE_CGCCPFCODIGO = P_CLIENTE
                  AND LC.FCF_TPCARGA_CODIGO = TC.FCF_TPCARGA_CODIGO (+)
                  AND LC.FCF_TPVEICULO_CODIGO = TV.FCF_TPVEICULO_CODIGO (+)
                  AND LC.FCF_TPCARGA_CODIGO = DECODE(V_TPCARGA,'00',LC.FCF_TPCARGA_CODIGO,V_TPCARGA)
                  AND P_PESO BETWEEN LC.FCF_LIMITECARGAS_FAIXAI AND LC.FCF_LIMITECARGAS_FAIXAF
                  AND LC.FCF_LIMITECARGAS_VIGENCIA <= TRUNC(SYSDATE)
                  AND LC.FCF_LIMITECARGAS_VALIDADE >= TRUNC(SYSDATE);
                exception
                  When NO_DATA_FOUND Then
                      V_TPVEICULO := V_TPVEICULO;
                  End ;
              
            End IF;
        End IF;*/
        
     End If;
     
     if P_GRUPO = '0563' or P_GRUPO = '563' Then
        V_TPCARGA := '08';
     End If;   

     If vAuxiliar >= 0 Then 
        IF P_TIPODERETORNO = 'TC' THEN
           RETURN V_TPCARGA;
        ELSE
           RETURN nvl(V_TPVEICULO,'0');
        END IF;      
     Else
        RETURN 'EL'; -- passou do limite da Faixa 
     End If;

  END FN_BUSCA_TPCARGAVEICULO;
  

/*
    -- Se ninhgem reclamar ate dia 01/04/excluir  
  
  FUNCTION FN_SLF_CLIENTEREGRAPESO(P_CNPJ TDVADM.T_GLB_CLIENTE.GLB_CLIENTE_CGCCPFCODIGO%TYPE,
                                 P_CONTRATO TDVADM.T_ARM_NOTA.SLF_CONTRATO_CODIGO%TYPE DEFAULT QualquerContrato)
   RETURN CHAR
IS
   V_GRUPO      TDVADM.T_GLB_GRUPOECONOMICO.GLB_GRUPOECONOMICO_CODIGO%TYPE;
   V_TIPOACHADO CHAR;
   V_ACHOU      INTEGER;
   V_CONTRATO   TDVADM.T_ARM_NOTA.SLF_CONTRATO_CODIGO%TYPE;
BEGIN
   V_CONTRATO := NVL(P_CONTRATO,QualquerContrato);
   SELECT C.GLB_GRUPOECONOMICO_CODIGO
     INTO V_GRUPO
   FROM TDVADM.T_GLB_CLIENTE C
   WHERE C.GLB_CLIENTE_CGCCPFCODIGO = P_CNPJ;

   SELECT COUNT(*)
      INTO V_ACHOU
   FROM TDVADM.T_SLF_CLIENTECARGAS CC
   WHERE cc.glb_cliente_cgccpfcodigo = P_CNPJ
     AND CC.SLF_CONTRATO_CODIGO = V_CONTRATO
     AND CC.GLB_GRUPOECONOMICO_CODIGO = V_GRUPO
     and cc.slf_clientecargas_ativo = 'S'
     and cc.slf_clientecargas_vigencia = (select max(cc1.slf_clientecargas_vigencia)
                                          from TDVADM.T_SLF_CLIENTECARGAS CC1
                                          where cc1.glb_grupoeconomico_codigo     = cc.glb_grupoeconomico_codigo
                                            and cc1.glb_cliente_cgccpfcodigo      = cc.glb_cliente_cgccpfcodigo
                                            and cc1.fcf_tpcarga_codigo            = cc.fcf_tpcarga_codigo
                                            and cc1.slf_contrato_codigo           = cc.slf_contrato_codigo
                                            and cc1.slf_tpfrete_codigo            = cc.slf_tpfrete_codigo
                                            and cc1.fcf_tpcarga_codigopesq        = cc.fcf_tpcarga_codigopesq 
                                            and cc1.slf_clientecargas_pcobranca   = cc.slf_clientecargas_pcobranca
--                                            and cc1.slf_clientecargas_fixaorigem  = cc.slf_clientecargas_fixaorigem
--                                            and cc1.slf_clientecargas_fixadestino = cc.slf_clientecargas_fixadestino
                                            and cc1.slf_clientecargas_ativo       = 'S');
     

   If V_ACHOU = 0 Then
     
       SELECT COUNT(*)
          INTO V_ACHOU
       FROM TDVADM.T_SLF_CLIENTECARGAS CC
       WHERE cc.glb_cliente_cgccpfcodigo = P_CNPJ
         AND CC.SLF_CONTRATO_CODIGO = V_CONTRATO
         AND CC.GLB_GRUPOECONOMICO_CODIGO = QualquerGrupo
         and cc.slf_clientecargas_ativo = 'S'
         and cc.slf_clientecargas_vigencia = (select max(cc1.slf_clientecargas_vigencia)
                                              from TDVADM.T_SLF_CLIENTECARGAS CC1
                                              where cc1.glb_grupoeconomico_codigo     = cc.glb_grupoeconomico_codigo
                                                and cc1.glb_cliente_cgccpfcodigo      = cc.glb_cliente_cgccpfcodigo
                                                and cc1.fcf_tpcarga_codigo            = cc.fcf_tpcarga_codigo
                                                and cc1.slf_contrato_codigo           = cc.slf_contrato_codigo
                                                and cc1.slf_tpfrete_codigo            = cc.slf_tpfrete_codigo
                                                and cc1.fcf_tpcarga_codigopesq        = cc.fcf_tpcarga_codigopesq 
                                                and cc1.slf_clientecargas_pcobranca   = cc.slf_clientecargas_pcobranca
--                                                and cc1.slf_clientecargas_fixaorigem  = cc.slf_clientecargas_fixaorigem
--                                                and cc1.slf_clientecargas_fixadestino = cc.slf_clientecargas_fixadestino
                                                and cc1.slf_clientecargas_ativo       = 'S');
         

   End If;

   V_TIPOACHADO := NULL;

     -- SE ACHOU E CONTRATO DIFERENTE DE CONTRATO GERAL
   IF (V_ACHOU = 1) AND ( V_CONTRATO <> QualquerContrato ) THEN
      V_TIPOACHADO := 'GCC'; -- ACHOU POR GRUPO/CNPJ/CONTRATO
   ELSIF (V_ACHOU = 1) AND ( V_CONTRATO = QualquerContrato ) THEN
      V_TIPOACHADO := 'GC'; -- ACHOU POR GRUPO/CNPJ
   END IF;


   IF V_TIPOACHADO IS NULL THEN
      SELECT COUNT(*)
         INTO V_ACHOU
      FROM TDVADM.T_SLF_CLIENTECARGAS CC
      WHERE cc.glb_cliente_cgccpfcodigo = QualquerCliente
        AND CC.SLF_CONTRATO_CODIGO = QualquerContrato
        AND CC.GLB_GRUPOECONOMICO_CODIGO = V_GRUPO
        and cc.slf_clientecargas_ativo = 'S'
        and cc.slf_clientecargas_vigencia = (select max(cc1.slf_clientecargas_vigencia)
                                             from TDVADM.T_SLF_CLIENTECARGAS CC1
                                             where cc1.glb_grupoeconomico_codigo     = cc.glb_grupoeconomico_codigo
                                               and cc1.glb_cliente_cgccpfcodigo      = cc.glb_cliente_cgccpfcodigo
                                               and cc1.fcf_tpcarga_codigo            = cc.fcf_tpcarga_codigo
                                               and cc1.slf_contrato_codigo           = cc.slf_contrato_codigo
                                               and cc1.slf_tpfrete_codigo            = cc.slf_tpfrete_codigo
                                               and cc1.fcf_tpcarga_codigopesq        = cc.fcf_tpcarga_codigopesq 
                                               and cc1.slf_clientecargas_pcobranca   = cc.slf_clientecargas_pcobranca
--                                               and cc1.slf_clientecargas_fixaorigem  = cc.slf_clientecargas_fixaorigem
--                                               and cc1.slf_clientecargas_fixadestino = cc.slf_clientecargas_fixadestino
                                               and cc1.slf_clientecargas_ativo       = 'S');
        

      IF (V_ACHOU > 0) THEN
         V_TIPOACHADO := 'G'; -- ACHOU POR GRUPO
      ELSE
         V_TIPOACHADO := 'N'; -- USA O TIPO NORMAL PARA TODOS
      END IF;
   END IF;


   RETURN TRIM(V_TIPOACHADO);
END FN_SLF_CLIENTEREGRAPESO;
  
*/

  PROCEDURE SP_BUSCA_FRETEEMPRESA(P_Busca_Frete   in TpParamBuscaVerba,
                                  P_ConfCarga     in TpCargaCli,
                                  P_RetBuscaFrete out TpBuscaVerba,
                                  P_MENSAGEM      OUT VARCHAR2)
  IS

     cFrete        tpCurosr;

/*


     V_CODMEORI     TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_ORIGEM%TYPE;
     V_CODMEDES     TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_DESTINO%TYPE;
     V_CODMIORI     TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_ORIGEM%TYPE;
     V_CODMIDES     TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_DESTINO%TYPE;
     V_CIDDESOR     TDVADM.T_GLB_LOCALIDADE.GLB_LOCALIDADE_DESCRICAO%TYPE;
     V_CIDDESDE     TDVADM.T_GLB_LOCALIDADE.GLB_LOCALIDADE_DESCRICAO%TYPE;
--     vColetaEntrega char(1);
     vTPCARGA       tdvadm.t_fcf_tpcarga.fcf_tpcarga_codigo%type;
     V_TPVEICULO    TDVADM.T_SLF_TABELA.FCF_TPVEICULO_CODIGO%Type;
*/

     vGRUPO        TDVADM.T_GLB_GRUPOECONOMICO.GLB_GRUPOECONOMICO_CODIGO%TYPE;
     vDescVeiculo  tdvadm.t_fcf_tpveiculo.fcf_tpveiculo_descricao%type;
     vDescCArga    tdvadm.t_fcf_tpcarga.fcf_tpcargadescricao%type;
     vDescGrupo    tdvadm.t_glb_grupoeconomico.glb_grupoeconomico_descricao%type;
     vPESOPESQUISA number;
     vErro          clob;
     vSql           clob;
     vOrigem       TDVADM.T_slf_calcfretekm.slf_calcfretekm_origemi%type;
     vDestino      TDVADM.T_slf_calcfretekm.slf_calcfretekm_destinoi%type;
     vOutraColeta  TDVADM.t_Slf_Calcfretekm.slf_calcfretekm_outracoletai%type;
     vOutraEntrega TDVADM.t_Slf_Calcfretekm.slf_calcfretekm_outraentregai%type;
     vAuxiliar     CHAR;
  Begin
     vSql := empty_clob;

     IF P_Busca_Frete.vRATEIA = 'S' Then
        vPESOPESQUISA := nvl(P_Busca_Frete.vPESOTOTAL,1);
     ELSE
        vPESOPESQUISA := nvl(P_Busca_Frete.vPESO,1);
     END IF;      


     vSql := '';
     vSql := vSql || 'SELECT CK.*, ';
     vSql := vSql || '       T.GLB_MERCADORIA_CODIGO, ';
     vSql := vSql || '       T.SLF_TABELA_COLETAENTREGA, ';
     vSql := vSql || '       T.SLF_TABELA_TIPO, ';
     vSql := vSql || '       T.FCF_TPVEICULO_CODIGO, ';
     vSql := vSql || '       T.FCF_TPCARGA_CODIGO, ';
     vSql := vSql || '       T.GLB_CLIENTE_CGCCPFCODIGO, ';
     vSql := vSql || '       T.GLB_GRUPOECONOMICO_CODIGO, ';
     vSql := vSql || '       T.SLF_TABELA_CONTRATO, ';
     vSql := vSql || '       1 vPESOCOBRADO, ';
     vSql := vSql || '       1 vFATORRATEIO, ';
     vSql := vSql || '       ''OK'' vRetorno, ';
     vSql := vSql || '       CK.ROWID ';
     vSql := vSql || 'FROM TDVADM.T_SLF_CALCFRETEKM CK, ';
     vSql := vSql || '     TDVADM.T_SLF_TABELA T ';
     vSql := vSql || 'WHERE 0 = 0 ';

     vSql := vSql || '  AND CK.SLF_TABELA_CODIGO = T.SLF_TABELA_CODIGO ';
     vSql := vSql || '  AND CK.SLF_TABELA_SAQUE = T.SLF_TABELA_SAQUE ';
     vSql := vSql || '  AND NVL(T.SLF_TABELA_STATUS,''N'') = ''N''';


     if P_Busca_Frete.vCLIENTE <> QualquerCliente Then
        vSql := vSql || '  AND trim(T.GLB_CLIENTE_CGCCPFCODIGO) = ' || TDVADM.PKG_glb_common.fn_QuotedStr(P_Busca_Frete.vCLIENTE);
     End If;
     
     if P_Busca_Frete.vCONTRATO <> QualquerContrato Then
        vSql := vSql || '  AND T.SLF_TABELA_CONTRATO = '|| TDVADM.PKG_glb_common.fn_QuotedStr(P_Busca_Frete.vCONTRATO) ;
     End If;
     
     if P_Busca_Frete.vGRUPO <> QualquerGrupo Then
        vSql := vSql || '  AND T.GLB_GRUPOECONOMICO_CODIGO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(P_Busca_Frete.vGRUPO);
     End If;

     vSql := vSql || '  AND CK.SLF_RECCUST_CODIGO = ' || TDVADM.PKG_glb_common.fn_QuotedStr('D_FRPSVO') ;

     if (P_Busca_Frete.vPesqFRETECOLETA = 'F') or ( P_Busca_Frete.vPesqFRETECOLETA = 'M' ) Then

        vSql := vSql || '  AND T.SLF_TABELA_TIPO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(P_Busca_Frete.vTIPOFRETE);
        vSql := vSql || '  AND nvl(T.SLF_TABELA_COLETAENTREGA,''A'') in (''N'',''A'',' || TDVADM.PKG_glb_common.fn_QuotedStr(P_Busca_Frete.vEntCol) || ')';

        If P_ConfCarga.ccUSAFAIXAKM = 'S' Then
            vSql := vSql || '  AND round(' || trim(to_char(P_Busca_Frete.vKM)) || ',0) BETWEEN CK.SLF_CALCFRETEKM_KMDE AND CK.SLF_CALCFRETEKM_KMATE ';
        End If;   

        If P_ConfCarga.ccUSAFAIXAPS = 'S' Then 
           vSql := vSql || '   AND round(' || trim(to_char(vPESOPESQUISA)) || ',' || trim(to_char(nvl(vPbDecGramas,0))) || ') BETWEEN CK.SLF_CALCFRETEKM_PESODE AND CK.SLF_CALCFRETEKM_PESOATE ';
        End If;

        if P_ConfCarga.ccUSAVEICULO = 'S' Then
           vSql := vSql || '   AND TRIM(NVL(T.FCF_TPVEICULO_CODIGO,''9  '')) = ' || TDVADM.PKG_glb_common.fn_QuotedStr(P_Busca_Frete.vTPVEICULO) ;
        End If;   

        vSql := vSql || '  AND T.FCF_TPCARGA_CODIGO =  ' || TDVADM.PKG_glb_common.fn_QuotedStr(P_ConfCarga.ccTPCARGACLIPESQ);

     Else
 

        vSql := vSql || '  AND T.SLF_TABELA_TIPO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(P_Busca_Frete.vTIPOFRETE);
--        vSql := vSql || '  AND nvl(T.SLF_TABELA_COLETAENTREGA,''A'') in (''N'',''A'',' || TDVADM.PKG_glb_common.fn_QuotedStr(P_Busca_Frete.vEntCol) || ')';

        If P_ConfCarga.ccUSAFAIXAKMCOL = 'S' Then
            vSql := vSql || '  AND round(' || trim(to_char(P_Busca_Frete.vKM)) || ',0) BETWEEN CK.SLF_CALCFRETEKM_KMDE AND CK.SLF_CALCFRETEKM_KMATE ';
        End If;   

        If P_ConfCarga.ccUSAFAIXAPSCOL = 'S' Then 
           vSql := vSql || '   AND round(' || trim(to_char(vPESOPESQUISA)) || ',' || trim(to_char(nvl(vPbDecGramas,0))) || ') BETWEEN CK.SLF_CALCFRETEKM_PESODE AND CK.SLF_CALCFRETEKM_PESOATE ';
        End If;

        if P_ConfCarga.ccUSAVEICULOCOL = 'S' Then
           vSql := vSql || '   AND TRIM(NVL(T.FCF_TPVEICULO_CODIGO,''9  '')) = ' || TDVADM.PKG_glb_common.fn_QuotedStr(P_Busca_Frete.vTPVEICULO) ;
        End If;   

        vSql := vSql || '  AND T.FCF_TPCARGA_CODIGO =  ' || TDVADM.PKG_glb_common.fn_QuotedStr(P_ConfCarga.ccTPCARGACLICOL);

     End If;   

--     vSql := vSql || '  AND CK.SLF_CALCFRETEKM_TPFRETE = ' || TDVADM.PKG_glb_common.fn_QuotedStr(P_ConfCarga.ccTPFRETE) ;




     if (P_Busca_Frete.vPesqFRETECOLETA = 'F') or ( P_Busca_Frete.vPesqFRETECOLETA = 'M' ) Then
       
    --     vSql := vSql || '          AND TRIM(CK.SLF_CALCFRETEKM_ORIGEMI)  = TRIM(DECODE(TRIM(T.FCF_TPCARGA_CODIGO),'08',P_CODIGOORI,'99999'))
         if P_ConfCarga.ccTPCODORIGEM    = 'NN' Then -- Nao Pesquisa
            vOrigem := '99999';
         Elsif P_ConfCarga.ccTPCODORIGEM = 'LO' Then -- Localidade
            vOrigem := P_Busca_Frete.vLOCALIDADEORIGEM;
         Elsif P_ConfCarga.ccTPCODORIGEM = 'IB' Then -- IBGE
            vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'IBC')),8);
         Elsif P_ConfCarga.ccTPCODORIGEM = 'FI' Then -- FIXO IBGE
            If P_ConfCarga.ccORIGEMFIXA is not null then
               vOrigem := rpad(trim(P_ConfCarga.ccORIGEMFIXA),8);
            End If;
         Elsif P_ConfCarga.ccTPCODORIGEM = 'RE' Then -- Regiao Cartografica
            vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'IBR')),8);
         Elsif P_ConfCarga.ccTPCODORIGEM = 'RC' Then -- Regiao Cartografica do Cliente
            vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'IBRV')),8);
         Elsif P_ConfCarga.ccTPCODORIGEM = 'CI' Then -- Capital Interior
            vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'CI')),8);
         Elsif P_ConfCarga.ccTPCODORIGEM = 'UF' Then -- Por Estado
            vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'UF')),8);
         Elsif P_ConfCarga.ccTPCODORIGEM = 'RA' Then -- Por Raio
            vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'IBC')),8);
         Elsif P_ConfCarga.ccTPCODORIGEM = 'ME' Then -- Por Raio
            vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'MEC')),8);
         Elsif P_ConfCarga.ccTPCODORIGEM = 'MI' Then -- Por Raio
            vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'MIC')),8);
         Else
            vOrigem := null;  
         End If;     
         

         if P_ConfCarga.ccTPCODDESTINO    = 'NN' Then -- Nao Pesquisa
            vDestino := '99999';
         Elsif P_ConfCarga.ccTPCODDESTINO = 'LO' Then -- Localidade
            vDestino := rpad(trim(P_Busca_Frete.vLOCALIDADEDESTINO),8);
         Elsif P_ConfCarga.ccTPCODDESTINO = 'IB' Then -- IBGE
            vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'IBC')),8);
         Elsif P_ConfCarga.ccTPCODDESTINO = 'FI' Then -- FIXO IBGE
            If P_ConfCarga.ccDESTINOFIXO is not null Then
               vDestino := rpad(trim(P_ConfCarga.ccDESTINOFIXO),8);
            End If;
         Elsif P_ConfCarga.ccTPCODDESTINO = 'RE' Then -- Regiao Cartografica
            vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'IBR')),8);
         Elsif P_ConfCarga.ccTPCODDESTINO = 'RC' Then -- Regiao Cartografica do Cliente
            vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'IBRV')),8);
         Elsif P_ConfCarga.ccTPCODDESTINO = 'CI' Then -- Capital Interior
            vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'CI')),8);
         Elsif P_ConfCarga.ccTPCODDESTINO = 'UF' Then -- Por Estado
            vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'UF')),8);
         Elsif P_ConfCarga.ccTPCODDESTINO = 'RA' Then -- Por Raio
            vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'IBC')),8);
         Elsif P_ConfCarga.ccTPCODDESTINO = 'ME' Then -- Por Meso
            vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'MEC')),8);
         Elsif P_ConfCarga.ccTPCODDESTINO = 'MI' Then -- Por Micro
            vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'MIC')),8);
         Else
           vDestino := null;   
         End If;  


         if P_ConfCarga.ccTPCODOCOUTRACOL    = 'NN' Then -- Nao Pesquisa
            vOutraColeta := null;
         Elsif P_ConfCarga.ccTPCODOCOUTRACOL = 'LO' Then -- Localidade
            vOutraColeta := rpad(trim(P_Busca_Frete.vLOCALIDADEOUTRACOL),8);
         Elsif P_ConfCarga.ccTPCODOCOUTRACOL = 'IB' Then -- IBGE
            vOutraColeta := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEOUTRACOL,'IBC')),8);
         Elsif P_ConfCarga.ccTPCODOCOUTRACOL = 'RE' Then -- Regiao Cartografica
            vOutraColeta := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEOUTRACOL,'IBR')),8);
         Elsif P_ConfCarga.ccTPCODOCOUTRACOL = 'RC' Then -- Regiao Cartografica do Cliente
            vOutraColeta := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEOUTRACOL,'IBRV')),8);
         Elsif P_ConfCarga.ccTPCODOCOUTRACOL = 'CI' Then -- Capital Interior
            vOutraColeta := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEOUTRACOL,'CI')),8);
         Elsif P_ConfCarga.ccTPCODOCOUTRACOL = 'UF' Then -- Por Estado
            vOutraColeta := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEOUTRACOL,'UF')),8);
         Elsif P_ConfCarga.ccTPCODOCOUTRACOL = 'RA' Then -- Por Raio
            vOutraColeta := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEOUTRACOL,'IBC')),8);
         Elsif P_ConfCarga.ccTPCODOCOUTRACOL = 'ME' Then -- Por Meso
            vOutraColeta := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEOUTRACOL,'MEC')),8);
         Elsif P_ConfCarga.ccTPCODOCOUTRACOL = 'MI' Then -- Por Micro
            vOutraColeta := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEOUTRACOL,'MIC')),8);
         Else
           vOutraColeta := null;   
         End If;  

         if P_ConfCarga.ccTPCODOCOUTRAENTR    = 'NN' Then -- Nao Pesquisa
            vOutraEntrega := null;
         Elsif P_ConfCarga.ccTPCODOCOUTRAENTR = 'LO' Then -- Localidade
            vOutraEntrega := rpad(trim(P_Busca_Frete.vLOCALIDADEOUTRAENT),8);
         Elsif P_ConfCarga.ccTPCODOCOUTRAENTR = 'IB' Then -- IBGE
            vOutraEntrega := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEOUTRAENT,'IBC')),8);
         Elsif P_ConfCarga.ccTPCODOCOUTRAENTR = 'RE' Then -- Regiao Cartografica
            vOutraEntrega := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEOUTRAENT,'IBR')),8);
         Elsif P_ConfCarga.ccTPCODOCOUTRAENTR = 'RC' Then -- Regiao Cartografica do Cliente
            vOutraEntrega := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEOUTRAENT,'IBRV')),8);
         Elsif P_ConfCarga.ccTPCODOCOUTRAENTR = 'CI' Then -- Capital Interior
            vOutraEntrega := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEOUTRAENT,'CI')),8);
         Elsif P_ConfCarga.ccTPCODOCOUTRAENTR = 'UF' Then -- Por Estado
            vOutraEntrega := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEOUTRAENT,'UF')),8);
         Elsif P_ConfCarga.ccTPCODOCOUTRAENTR = 'RA' Then -- Por Raio
            vOutraEntrega := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEOUTRAENT,'IBC')),8);
         Elsif P_ConfCarga.ccTPCODOCOUTRAENTR = 'ME' Then -- Por Meso
            vOutraEntrega := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEOUTRAENT,'MEC')),8);
         Elsif P_ConfCarga.ccTPCODOCOUTRAENTR = 'MI' Then -- Por Micro
            vOutraEntrega := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEOUTRAENT,'MIC')),8);
         Else
           vOutraEntrega := null;   
         End If;  






     ElsIf P_Busca_Frete.vPesqFRETECOLETA = 'C' Then

    --     vSql := vSql || '          AND TRIM(CK.SLF_CALCFRETEKM_ORIGEMI)  = TRIM(DECODE(TRIM(T.FCF_TPCARGA_CODIGO),'08',P_CODIGOORI,'99999'))
         if P_ConfCarga.ccTPCODORIGEMCOL    = 'NN' Then -- Nao Pesquisa
            vOrigem := '99999';
         Elsif P_ConfCarga.ccTPCODORIGEMCOL = 'LO' Then -- Localidade
            vOrigem := P_Busca_Frete.vLOCALIDADEORIGEM;
         Elsif P_ConfCarga.ccTPCODORIGEMCOL = 'IB' Then -- IBGE
            vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'IBC')),8);
         Elsif P_ConfCarga.ccTPCODORIGEMCOL = 'FI' Then -- FIXO IBGE
            If P_ConfCarga.ccORIGEMFIXA is not null then
               vOrigem := rpad(trim(P_ConfCarga.ccORIGEMFIXA),8);
            End If;
         Elsif P_ConfCarga.ccTPCODORIGEMCOL = 'RE' Then -- Regiao Cartografica
            vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'IBR')),8);
         Elsif P_ConfCarga.ccTPCODORIGEMCOL = 'RC' Then -- Regiao Cartografica do Cliente
            vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'IBRV')),8);
         Elsif P_ConfCarga.ccTPCODORIGEMCOL = 'CI' Then -- Capital Interior
            vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'CI')),8);
         Elsif P_ConfCarga.ccTPCODORIGEMCOL = 'UF' Then -- Por Estado
            vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'UF')),8);
         Elsif P_ConfCarga.ccTPCODORIGEMCOL = 'RA' Then -- Por Raio
            vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'IBC')),8);
         Elsif P_ConfCarga.ccTPCODORIGEMCOL = 'ME' Then -- Por Raio
            vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'MEC')),8);
         Elsif P_ConfCarga.ccTPCODORIGEMCOL = 'MI' Then -- Por Raio
            vOrigem := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEORIGEM,'MIC')),8);
         Else
            vOrigem := null;  
         End If;     
         

         if P_ConfCarga.ccTPCODDESTINOCOL    = 'NN' Then -- Nao Pesquisa
            vDestino := '99999';
         Elsif P_ConfCarga.ccTPCODDESTINOCOL = 'LO' Then -- Localidade
            vDestino := rpad(trim(P_Busca_Frete.vLOCALIDADEDESTINO),8);
         Elsif P_ConfCarga.ccTPCODDESTINOCOL = 'IB' Then -- IBGE
            vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'IBC')),8);
         Elsif P_ConfCarga.ccTPCODDESTINOCOL = 'FI' Then -- FIXO IBGE
            If P_ConfCarga.ccDESTINOFIXO is not null Then
               vDestino := rpad(trim(P_ConfCarga.ccDESTINOFIXO),8);
            End If;
         Elsif P_ConfCarga.ccTPCODDESTINOCOL = 'RE' Then -- Regiao Cartografica
            vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'IBR')),8);
         Elsif P_ConfCarga.ccTPCODDESTINOCOL = 'RC' Then -- Regiao Cartografica do Cliente
            vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'IBRV')),8);
         Elsif P_ConfCarga.ccTPCODDESTINOCOL = 'CI' Then -- Capital Interior
            vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'CI')),8);
         Elsif P_ConfCarga.ccTPCODDESTINOCOL = 'UF' Then -- Por Estado
            vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'UF')),8);
         Elsif P_ConfCarga.ccTPCODDESTINOCOL = 'RA' Then -- Por Raio
            vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'IBC')),8);
         Elsif P_ConfCarga.ccTPCODDESTINOCOL = 'ME' Then -- Por Meso
            vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'MEC')),8);
         Elsif P_ConfCarga.ccTPCODDESTINOCOL = 'MI' Then -- Por Micro
            vDestino := rpad(trim(tdvadm.fn_busca_codigoibge(P_Busca_Frete.vLOCALIDADEDESTINO,'MIC')),8);
         Else
           vDestino := null;   
         End If;  
            

     End If;   
       
     if vOrigem is not null Then
        if P_ConfCarga.ccTPCODORIGEM <> 'RA' Then
           vSql := vSql || '          AND CK.SLF_CALCFRETEKM_ORIGEMI  = ' || TDVADM.PKG_glb_common.fn_QuotedStr(rpad(vOrigem,8));
        Else
           vSql := vSql || '          AND TDVADM.pkg_glb_common.fn_get_distanciaIBGE(trim(CK.SLF_CALCFRETEKM_ORIGEMI),' || TDVADM.PKG_glb_common.Fn_QuotedStr(vOrigem) || ') <= CK.SLF_CALCFRETEKM_RAIOKMORIGEM ';
           vSql := vSql || '          and (select i.ufsigla from TDVADM.v_glb_ibge i where i.codmun = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vOrigem) || ') = (select i.ufsigla from TDVADM.v_glb_ibge i where trim(i.codmun) = trim(CK.SLF_CALCFRETEKM_ORIGEMI)) ';

        End If;
     End If;

     if vDestino is not null Then 
        If P_ConfCarga.ccTPCODDESTINO <> 'RA' Then
           vSql := vSql || '          AND CK.SLF_CALCFRETEKM_DESTINOI  = ' ||  TDVADM.PKG_glb_common.fn_QuotedStr( rpad(vDestino,8) ) ;
        Else
           vSql := vSql || '          AND TDVADM.PKG_glb_common.fn_get_distanciaIBGE(trim(CK.SLF_CALCFRETEKM_DESTINOI),' || TDVADM.PKG_glb_common.Fn_QuotedStr(vDestino) || ') <= CK.SLF_CALCFRETEKM_RAIOKMDESTINO ';
           vSql := vSql || '          and (select i.ufsigla from TDVADM.v_glb_ibge i where i.codmun = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vDestino) || ') = (select i.ufsigla from TDVADM.v_glb_ibge i where trim(i.codmun) = trim(CK.SLF_CALCFRETEKM_DESTINOI)) ';
        End If;   
     End If;  
     
     If vOutraColeta is not null Then
        If P_ConfCarga.ccTPCODOCOUTRACOL <> 'RA' Then
           vSql := vSql || '          AND CK.SLF_CALCFRETEKM_OUTRACOLETAI  = ' ||  TDVADM.PKG_glb_common.fn_QuotedStr( rpad(vOutraColeta,8) ) ;
        End If;   
     End If;

     If vOutraEntrega is not null Then
        If P_ConfCarga.ccTPCODOCOUTRAENTR <> 'RA' Then
           vSql := vSql || '          AND CK.SLF_CALCFRETEKM_OUTRAENTREGAI  = ' ||  TDVADM.PKG_glb_common.fn_QuotedStr( rpad(vOutraEntrega,8) ) ;
        End If;   
     End If;


     vSql := vSql || '  AND T.SLF_TABELA_SAQUE = (SELECT MAX(T1.SLF_TABELA_SAQUE) ';
     vSql := vSql || '                            FROM TDVADM.T_SLF_TABELA T1 ';
     vSql := vSql || '                            WHERE T1.SLF_TABELA_CODIGO = T.SLF_TABELA_CODIGO ';
     vSql := vSql || '                              AND NVL(T1.SLF_TABELA_STATUS,''N'') = ''N''';
     vSql := vSql || '                              AND TO_DATE(T1.SLF_TABELA_VIGENCIA,''DD/MM/YYYY'') <= TO_DATE(SYSDATE,''DD/MM/YYYY'')) ';
     

    if tpLogGeracao.Arm_Carregamento_Codigo is null Then
       tpLogGeracao.Arm_Carregamento_Codigo := '999999';
    End If;
     
     Begin
     OPEN cFrete FOR vSql;
     FETCH cFrete into P_RetBuscaFrete;
     Exception
       When OTHERS Then
          vErro := sqlerrm;
          P_RetBuscaFrete.vRetorno := 'ER';
          P_RetBuscaFrete.SLF_TABELA_CODIGO := null;
          P_RetBuscaFrete.SLF_TABELA_SAQUE := null;
          P_RetBuscaFrete.SLF_CALCFRETEKM_VALOR := 0;
         
       End ;
    
    If trim(sys_context('CARREGAMENTO','CODCARREG')) = trim(V_ARM_CARREGAMENTO) Then
       vContextCount := vContextCount + 1; 
       Insert Into t_glb_sql ( glb_sql_instrucao, 
                               glb_sql_dtgravacao, 
                               glb_sql_programa) 
                      Values ( vsql, 
                               Sysdate, 
                               lpad(vContextCount,3,'0') || '-' || V_ARM_CARREGAMENTO || '-Cursor=buscafrete=' || V_ARM_CARREGAMENTO || 'TpCarga=' || P_ConfCarga.ccTPCARGACLI  || ' Retorna = ' || vTesteCarga.vRetorna  || ' Vez ' || to_char(tpLogGeracao.Con_Loggeracao_Codigo)); 
       Commit;
    End If;  
    
     -- Se Nao encontrou
     If cFrete%notfound Then
       P_RetBuscaFrete.vRetorno := 'NE';
       P_RetBuscaFrete.SLF_TABELA_CODIGO := TDVADM.PKG_FIFO_CARREGCTRC.SemTabelaCodigo;
       P_RetBuscaFrete.SLF_TABELA_SAQUE := TDVADM.PKG_FIFO_CARREGCTRC.SemTabelaSaque;
       P_RetBuscaFrete.SLF_CALCFRETEKM_VALOR := 0;
     Else

        IF (P_Busca_Frete.vGRUPO = QualquerGrupo) AND (P_Busca_Frete.vCLIENTE <> QualquerCliente) IS NULL THEN
           SELECT C.GLB_GRUPOECONOMICO_CODIGO
              INTO vGrupo
           FROM TDVADM.T_GLB_CLIENTE C
           WHERE C.GLB_CLIENTE_CGCCPFCODIGO = P_Busca_Frete.vCLIENTE;
        ELSE
           vGRUPO  := P_Busca_Frete.vGRUPO;
        END IF;


        Begin
           select trim(tv.fcf_tpveiculo_codigo) || '-' || trim(tv.fcf_tpveiculo_descricao) || ' '
              into vDescVeiculo
           from tdvadm.t_fcf_tpveiculo tv
           where tv.fcf_tpveiculo_codigo =  P_Busca_Frete.vTPVEICULO ;       
        Exception
        when NO_DATA_FOUND then
           vDescVeiculo := null;
        end;

        Begin
           select trim(tc.fcf_tpcarga_codigo) || '-' || trim(tc.fcf_tpcargadescricao) || ' '
              into vDescCArga
           from tdvadm.t_fcf_tpcarga tc
           where tc.fcf_tpcarga_codigo =  P_Busca_Frete.vTPCARGA;
           Exception
        when NO_DATA_FOUND then
           vDescCArga := null;
        end;

        Begin
           select trim(ge.glb_grupoeconomico_codigo) || '-' || trim(ge.glb_grupoeconomico_nome) || ' '
              into vDescGrupo
           from tdvadm.t_glb_grupoeconomico ge
           where ge.glb_grupoeconomico_codigo = vGRUPO;
        Exception
        when NO_DATA_FOUND then
           vDescGrupo := null;
        end;

 
        IF ( P_RetBuscaFrete.vPESOCOBRADO < P_Busca_Frete.vPESOMINIMO ) and 
           ( P_Busca_Frete.vRATEIA = 'N' )  THEN
           P_RetBuscaFrete.vPESOCOBRADO := P_Busca_Frete.vPESOMINIMO;
        END IF;   
 
        P_RetBuscaFrete.SLF_CALCFRETEKM_PESOATE   := P_RetBuscaFrete.vPESOCOBRADO;

        IF ( P_Busca_Frete.vRATEIA = 'S' ) and ( ListaQuebras.ccTPRATEIO <> '00' ) and ( NVL(P_Busca_Frete.vPESOTOTAL,0) <> 0 ) Then
           P_RetBuscaFrete.vFATORRATEIO := P_Busca_Frete.vPESO / NVL(P_Busca_Frete.vPESOTOTAL,1);
        ELSE
           P_RetBuscaFrete.vFATORRATEIO  := 1;
        END IF;      

        P_RetBuscaFrete.vFATORRATEIO := nvl(P_RetBuscaFrete.vFATORRATEIO,1);


/*        IF P_ConfCarga.ccTPCARGACLI = '08' THEN
           -- VOLTA O PESO PORQUE Nao COBRA PELA MAIOR DA FAIXA
           P_RetBuscaFrete.vPESOCOBRADO := P_RetBuscaFrete.SLF_CALCFRETEKM_PESOATE ;
        ELSIF P_Busca_Frete.vPESOTOTAL > 14000  THEN
           P_RetBuscaFrete.vPESOCOBRADO := P_Busca_Frete.vPESOTOTAL * P_RetBuscaFrete.vFATORRATEIO;
        ElsIF P_Busca_Frete.vPESOTOTAL <= 14000  THEN
           P_RetBuscaFrete.vPESOCOBRADO := P_RetBuscaFrete.SLF_CALCFRETEKM_PESOATE * P_RetBuscaFrete.vFATORRATEIO;
        ELSE -- nunca vai entrar aqui
           P_RetBuscaFrete.vPESOCOBRADO := P_Busca_Frete.vPESO * P_RetBuscaFrete.vFATORRATEIO;
        END IF;
*/
        
     End If;
     
     
/*     FETCH cFrete into P_RetBuscaFrete;
     If cFrete%found Then
       P_RetBuscaFrete.vRetorno := 'NE';
       P_RetBuscaFrete.SLF_TABELA_CODIGO := null;
       P_RetBuscaFrete.SLF_TABELA_SAQUE := null;
       P_RetBuscaFrete.SLF_CALCFRETEKM_VALOR := 0;
       tpLogGeracao.Con_Loggeracao_Sql := vsql;
       tpLogGeracaO.Con_Loggeracao_ErroHTML := 'FRETE RETORNOU MAIS DE UMA LINHA COM VALORES CARGA ' || P_ConfCarga.ccTPCARGACLIDESC || ' CARGAPES ' || P_ConfCarga.ccTPCARGACLIPESQ;
       vAuxiliar := fn_InsereLogGeracao;    
     End If;
*/
     
     

--     insert into t_glb_sql 
--       values 
--      (vsql,
--       sysdate,
--       'SP_BUSCA_FRETEEMPRESA - CARGA ' || P_ConfCarga.ccTPCARGACLIPESQ || '-' || P_ConfCarga.ccTPCARGACLIPESQ || ' Peso - ' || p_Busca_Frete.vPESOTOTAL,
--       ' Carreg ' || V_ARM_CARREGAMENTO || ' Origem - ' ||  P_Busca_Frete.vOrigem || '-' || P_RetBuscaFrete.vRetorno);



/* 
     vRetorno := nvl(vRetorno,'NE');
     
     IF vRetorno IN ('LO') THEN
        P_CODIGOORI := P_CODIGOORI;
        P_CODIGODES := P_CODIGODES;
     ELSIF vRetorno IN ('KM','MA','LK') THEN
        P_CODIGOORI := P_LOCALIDADEORIGEM;
        P_CODIGODES := P_LOCALIDADEDESTINO;
     ELSIF vRetorno = 'ME' THEN
        P_CODIGOORI := V_CODMEORI;
        P_CODIGODES := V_CODMEDES;
     ELSIF vRetorno = 'MI' THEN
        P_CODIGOORI := V_CODMIORI;
        P_CODIGODES := V_CODMIDES;
     ELSIF vRetorno = 'EI' THEN
        P_CODIGOORI := V_CODMEORI;
        P_CODIGODES := V_CODMIDES;
     ELSIF vRetorno = 'IE' THEN
        P_CODIGOORI := V_CODMIORI;
        P_CODIGODES := V_CODMEDES;
     ELSIF vRetorno = 'IBKM' THEN
        P_CODIGOORI := trim(tdvadm.fn_busca_codigoibge(P_LOCALIDADEORIGEM ,vFuncaoIBGeO));
        P_CODIGODES := trim(tdvadm.fn_busca_codigoibge(P_LOCALIDADEDESTINO,vFuncaoIBGeD));
     ELSIF vRetorno = 'RE' THEN
        P_CODIGOORI := trim(tdvadm.fn_busca_codigoibge(P_LOCALIDADEORIGEM ,vFuncaoIBGeO));
        P_CODIGODES := trim(tdvadm.fn_busca_codigoibge(P_LOCALIDADEDESTINO,vFuncaoIBGeD));
     ELSIF vRetorno = 'DE' then
        P_CODIGOORI := tpNotaCte.Glb_Localidade_Codigoorigem;
        P_CODIGODES := tpNotaCte.Glb_Localidade_Codigodestino;
     ELSIF vRetorno = 'NE' THEN
        P_CODIGOORI := NULL;
        P_CODIGODES := NULL;
     END IF;   
     P_TPRETORNO := substr(vRetorno,1,2);
*/

    tpLogGeracao.Con_Loggeracao_Sql := vsql;
    tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'BUSCANDO PRECO TAB CARGA - ' || P_ConfCarga.ccTPCARGACLIDESC || ' CARGAPES - ' || P_ConfCarga.ccTPCARGACLIPESQ || ' - FRETECOLETA - ' || P_Busca_Frete.vPesqFRETECOLETA || ' - ' || P_RetBuscaFrete.vRetorno ;
    vAuxiliar := fn_InsereLogGeracao;    
    commit; 


  END SP_BUSCA_FRETEEMPRESA;


  PROCEDURE SP_TESTA_VEICULOPASSADO(P_GRUPO      in TDVADM.T_FCF_LIMITECARGAS.GLB_GRUPOECONOMICO_CODIGO%TYPE,
                                    P_CONTRATO   in TDVADM.T_FCF_LIMITECARGAS.SLF_CONTRATO_CODIGO%TYPE,
                                    P_CLIENTE    in TDVADM.T_FCF_LIMITECARGAS.GLB_CLIENTE_CGCCPFCODIGO%TYPE,
                                    P_PESO       in NUMBER,
                                    P_TIPOFRETE  in TDVADM.T_SLF_TABELA.SLF_TABELA_TIPO%TYPE,
                                    P_TIPOTRANSP in VARCHAR2,
                                    P_TPCARGA    in VARCHAR2,
                                    P_PESQVEIC   in char,
                                    P_TPVEICULO  out VARCHAR2,
                                    P_STATUS     out char,
                                    P_MESSAGE    out varchar2)
    Is
      vAuxiliar number;
      vCarga    varchar2(50);
    Begin

                 Begin 
                    Select trim(tc.fcf_tpcarga_codigo) || '-' || tc.fcf_tpcarga_descricao
                      into vCarga
                    from tdvadm.t_fcf_tpcarga tc
                    where tc.fcf_tpcarga_codigo = P_TPCARGA;
                 Exception
                   When OTHERS Then
                     vCarga := trim(P_TPCARGA) || '-Nao definada';
                 end;
                 P_STATUS := TDVADM.PKG_glb_common.Status_Nomal;
                 
                 P_TPVEICULO := trim(TDVADM.PKG_FIFO_CARREGCTRC.FN_BUSCA_TPCARGAVEICULO(P_GRUPO,
                                                             P_CONTRATO,
                                                             P_CLIENTE,
                                                             P_PESO,
                                                             P_TIPOFRETE,
                                                             P_TIPOTRANSP,
                                                             P_TPCARGA,
                                                             P_PESQVEIC,
                                                             'TV'));
                    
                   

                 If trim(P_TPVEICULO) = 'EL' Then
                    P_MESSAGE := 'Tipo de Carga ' || vCarga || chr(10) || 
                                 'E-Peso ' || TO_CHAR(P_PESO) || ' Excedeu Limite da Faixa do Cliente' || chr(10);
                    P_STATUS := 'E';                     
                 Elsif ( trim(P_TPVEICULO) = '0' ) Then
                    if P_PESQVEIC = 'C' Then
                       P_MESSAGE :=  'Tipo de Carga ' || vCarga || chr(10) ||
                                     'VEICULO Nao IDENTIFICADO, VERIFIQUE NA COLETA ' || chr(10) || chr(10) ||
                                    'COLETA WEB          - SELECCIONAR UM TITPO DE VEICULO VALIDO. ' || chr(10) || chr(10) ||
                                    'COLETA SIST TDV - VERIRIFCAR O TIPO DE CARGA ' || chr(10) ||
                                    '                        LT - LOTACAO TRUCK'   || chr(10) ||
                                    '                        LC - LOTACAO CARRETA' || chr(10) ||
                                    '                        LB - LOTACAO BI-TREM' || chr(10);
                       P_STATUS := 'E';                     
                    ElsIf P_PESQVEIC = 'F' Then
                       P_MESSAGE :=  'Tipo de Carga ' || vCarga || chr(10) ||
                                     'VEICULO Nao IDENTIFICADO, Nao ENCONTROU NA FAIXA DE PESO' ||  chr(10) || chr(10) ||
                                    'VERIFICAR O PESO TOTAL DO AGRUPAMENTO. ' || chr(10) || 
                                    'PESO APURADO ' || TO_CHAR(P_PESO) || chr(10) ||
                                    'ESTE PESO Nao FOI LOCALIZADO NA FAIXA DE PESO PARA VEICULO' || chr(10) ||
                                    'GRUPO - ' || P_GRUPO || chr(10) ||
                                    'CONTRATO - ' || P_CONTRATO || chr(10) ||
                                    'CNPJ - ' || P_CLIENTE  || chr(10) || 
                                    'CARGA - ' || P_TPCARGA ;
                       P_STATUS := 'W';
                    ElsIf P_PESQVEIC = 'G' Then
                       P_MESSAGE :=  'Tipo de Carga ' || vCarga || chr(10) ||
                                     'VEICULO Nao IDENTIFICADO, Nao ENCONTROU NO GRID DO FIFO' || chr(10) ||
                                     'SELECIONE O CARREGAMENTO E USE O BOTAO DIREITO DO MOUSE '|| chr(10) ||
                                     'PARA VINCULAR UM VEICULO' || chr(10);
                       P_STATUS := 'E';                     
                    Else
                       P_MESSAGE :=  'Tipo de Carga ' || vCarga || chr(10) ||
                                     'VEICULO Nao IDENTIFICADO';
                       P_STATUS := 'E';                     
                    End If;
                 Else
                   If P_TPCARGA <> '20 ' then
                      If P_PESQVEIC = 'G' Then
                         update TDVADM.T_arm_carregamento c
                           set c.fcf_tpveiculo_codigo = P_TPVEICULO
                         where c.arm_carregamento_codigo = tpLogGeracao.Arm_Carregamento_Codigo;
                      Else          
                         update TDVADM.T_arm_carregamento c
                           set c.fcf_tpveiculo_codigo = null
                         where c.arm_carregamento_codigo = tpLogGeracao.Arm_Carregamento_Codigo;
                      End If;   
                   End If;
                 End If;    
                 
                 If ( P_STATUS = TDVADM.PKG_glb_common.Status_Nomal ) and ( P_TPCARGA <> '20 ' ) Then
                   
                     If trim(P_TPVEICULO) not in ('0','9') Then
                        select count(*)
                          into vAuxiliar
                        from tdvadm.t_slf_cliregrasveic cv
                        where cv.glb_grupoeconomico_codigo = decode(P_GRUPO,TDVADM.PKG_FIFO_CARREGCTRC.QualquerGrupo,cv.glb_grupoeconomico_codigo,P_GRUPO)
                          and cv.glb_cliente_cgccpfcodigo = decode(P_CLIENTE,TDVADM.PKG_FIFO_CARREGCTRC.QualquerCliente,cv.glb_cliente_cgccpfcodigo,P_CLIENTE)
                          and cv.slf_contrato_codigo = Decode(P_CONTRATO,TDVADM.PKG_FIFO_CARREGCTRC.QualquerContrato,cv.slf_contrato_codigo,P_CONTRATO)
                          and trim(cv.fcf_tpveiculo_codigo) = trim(P_TPVEICULO)
--                          and cv.fcf_tpcarga_codigo = P_TPCARGA
                          ;
                        
                        If vAuxiliar = 0 Then
                           P_MESSAGE :=  'Tipo de Carga ' || vCarga || chr(10) ||
                                         'VEICULO COD ' || P_TPVEICULO || ' Nao CONSTA NO ' || chr(10) ||
                                         'CONTRATO '  || P_CONTRATO ||  chr(10) ||
                                         'CLIENTE '   || P_CLIENTE || chr(10) ||
                                         'GRUPO ' || P_GRUPO || chr(10);
                           P_STATUS := 'N';
                        End If; 
                  End If;   
                   
                 End If;
                   
      
    End SP_TESTA_VEICULOPASSADO;

  Procedure SP_TESTACARGA15(pTesteCarga    in out TpTesteCarga,
                            pListaCargaCli in     TlistaCargaCli)
 
  Is
    vGrupoRem  tdvadm.t_glb_grupoeconomico.glb_grupoeconomico_codigo%type;
    vGrupoDest tdvadm.t_glb_grupoeconomico.glb_grupoeconomico_codigo%type;
    vAuxiliar  integer;
    vOrigem  varchar2(1000);
    vDestino varchar2(1000);
  Begin
    -- Procura a Carga na Lista Passada
    vAuxiliar := 0;
    loop
      vAuxiliar := vAuxiliar + 1;
      exit when pListaCargaCli(vAuxiliar).ccTPCARGACLI = pTesteCarga.vTPCARGACLI;
    end loop;  
  
    -- Testar se e uma Transferencia
    -- Remetente e Destinatario tem que ser do Mesmo Grupo
    pTesteCarga.vRetorna := 'S';
    Select cl.glb_grupoeconomico_codigo
      into vGrupoRem
    From TDVADM.T_glb_cliente cl
    where cl.glb_cliente_cgccpfcodigo = rpad(pTesteCarga.vCNPJREM,20);

    Select cl.glb_grupoeconomico_codigo
      into vGrupoDest
    From TDVADM.T_glb_cliente cl
    where cl.glb_cliente_cgccpfcodigo = rpad(pTesteCarga.vCNPJDES,20);
 
    if pListaCargaCli(vAuxiliar).ccSOTRANSF = 'S' Then 
       if vGrupoRem <> vGrupoDest Then   
          pTesteCarga.vRetorna := 'S';
          pTesteCarga.FINALNOTA := '';
          Return;
       End If;   
    End If;


       pTesteCarga.vRetorna := 'N';
 
--       Verifica se vai fazer um Novo Lista de envolvidos
--       spi_SqlCliEnvolvidos
  
       if pListaCargaCli(vAuxiliar).ccTPCODORIGEM    = 'NN' Then -- Nao Pesquisa
          vOrigem := '99999';
          vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'IBC')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'LO' Then -- Localidade
          vOrigem := ' AND N.ARM_NOTA_LOCALCOLETAL = ''' || trim(pTesteCarga.vLOCALIDADEORIGEM)  || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'IB' Then -- IBGE
          vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'IBC')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'FI' Then -- FIXO IBGE
          If pListaCargaCli(vAuxiliar).ccORIGEMFIXA is not null then
             vOrigem := ' AND N.ARM_NOTA_LOCALCOLETA = ''' || rpad(trim(pListaCargaCli(vAuxiliar).ccORIGEMFIXA),8)  || '''';
          End If;
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'RE' Then -- Regiao Cartografica
          vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBR'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'IBR')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'RC' Then -- Regiao Cartografica do Cliente
          vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBRV'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'IBRV')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'CI' Then -- Capital Interior
          vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''CI'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'CI')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'UF' Then -- Por Estado
          vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''UF'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'UF')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'RA' Then -- Por Raio
          vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'IBC')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'ME' Then -- Por Raio
          vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''MEC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'MEC')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'MI' Then -- Por Raio
          vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''MIC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'MIC')),8) || '''';
       Else
          vOrigem := null;  
       End If;     
     
  
       pTesteCarga.vSql.NOTASWHERE := pTesteCarga.vSql.NOTASWHERE || vOrigem;


       if pListaCargaCli(vAuxiliar).ccTPCODDESTINO    = 'NN' Then -- Nao Pesquisa
          vDestino := '99999';
          vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'IBC')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'LO' Then -- Localidade
          vDestino := ' AND N.ARM_NOTA_LOCALENTREGAL = ''' || rpad(trim(pTesteCarga.vLOCALIDADEDESTINO),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'IB' Then -- IBGE
          vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'IBC')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'FI' Then -- FIXO IBGE
          If pListaCargaCli(vAuxiliar).ccDESTINOFIXO is not null Then
             vDestino := ' AND N.ARM_NOTA_LOCALENTREGAI = ''' || rpad(trim(pListaCargaCli(vAuxiliar).ccDESTINOFIXO),8) || '''';
          End If;
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'RE' Then -- Regiao Cartografica
          vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBR'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'IBR')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'RC' Then -- Regiao Cartografica do Cliente
          vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBRV'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'IBRV')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'CI' Then -- Capital Interior
          vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''CI'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'CI')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'UF' Then -- Por Estado
          vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''UF'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'UF')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'RA' Then -- Por Raio
          vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'IBC')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'ME' Then -- Por Meso
          vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''MEC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'MEC')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'MI' Then -- Por Micro
          vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''MIC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'MIC')),8) || '''';
       Else
         vDestino := null;   
       End If; 

       pTesteCarga.vSql.NOTASWHERE := pTesteCarga.vSql.NOTASWHERE || vDestino;

       
       pTesteCarga.TESTAPESO := pTesteCarga.vSql.CONTAPESO || 
                                pTesteCarga.vSql.TABWHERE  ||
                                pTesteCarga.vSql.SEMCTRSDR ||
                                pTesteCarga.vSql.SEMCTRC   || 
                                pTesteCarga.vSql.NOTASWHERE;       

--       insert into TDVADM.T_glb_sql values (vTesteCarga.FINALNOTA,sysdate,'VLI','VLI15');
--       commit;

--     insert into TDVADM.T_glb_sql 
--       values 
--      (pTesteCarga.TESTAPESO,
--       sysdate,
--       'SP_TESTACARGA15 - CARGA '  || pListaCargaCli(vAuxiliar).ccTPCARGACLIPESQ,
--       ' Carreg ' || V_ARM_CARREGAMENTO);

       EXECUTE IMMEDIATE pTesteCarga.TESTAPESO INTO  pTesteCarga.vTestePeso,pTesteCarga.vTesteVlrMerc;
       
       If nvl(pTesteCarga.vTestePeso,0) > 0 Then
          pTesteCarga.FINALNOTA := pTesteCarga.vSql.NOTAS || 
                                   pTesteCarga.vSql.TABWHERE ||
                                   pTesteCarga.vSql.SEMCTRSDR ||
                                   pTesteCarga.vSql.SEMCTRC || 
                                   pTesteCarga.vSql.NOTASWHERE; 
                         
          pTesteCarga.vRetorna := 'N';
       Else
          pTesteCarga.vRetorna := 'S';
          pTesteCarga.FINALNOTA := '';
       End If;
    
  End SP_TESTACARGA15;   
  
  

  Procedure SP_TESTACARGAMENORVALOR(pTesteCarga    in out TpTesteCarga,
                                    pListaCargaCli in     TlistaCargaCli)
 
  Is
    vGrupoRem  tdvadm.t_glb_grupoeconomico.glb_grupoeconomico_codigo%type;
    vGrupoDest tdvadm.t_glb_grupoeconomico.glb_grupoeconomico_codigo%type;
    vAuxiliar  integer;
    V_MENSAGEM varchar2(1000);
    vBusca_Frete        TpParamBuscaVerba;
    vRetBuscaFrete      TpBuscaVerba;

    vListaCargaCli      TpCargaCli;
    vMenorFreteVLR      number;
    VmaiorFreteVLR      number;
    vMenorFreteTC       tdvadm.t_fcf_tpcarga.fcf_tpcarga_codigo%type;
    vMaiorFreteTC       tdvadm.t_fcf_tpcarga.fcf_tpcarga_codigo%type;
    vMenorFreteSQL      clob;
    vMaiorFreteSQL      clob;
    vFormulaTraduzidaF  varchar2(1000);
    vFormulaUsada       Varchar2(1000);
    vAuxiliarnumerico   number;
    vTextoMSG           varchar2(2000);
    ListaVerbas         glbadm.pkg_listas.tListaParamsString;
    vQtdePrecosachados  number := 0;
    vTextoEmail         clob;
    vAuxiliarT          varchar2(100);
    vStatus             char(1);
    vMessage            varchar2(2000);
  Begin
     vTextoEmail    := empty_clob;
     VmaiorFreteVLR := null;
     vMenorFreteVLR := null;
     vMenorFreteSQL := empty_clob;
     vMaiorFreteSQL := empty_clob;
     vTextoMSG      := '';
    -- Procura a Primeira Carga a Ser Testada
    vAuxiliar := 0;
    vQtdePrecosachados := 0;
    loop
       vAuxiliar := vAuxiliar + 1;
         Begin
            vListaCargaCli := pListaCargaCli(vAuxiliar);
         Exception
           When NO_DATA_FOUND Then
              exit;             
           End;   

       if instr(NVL(vListaCargaCli.ccPROCEDURE,'x'),'SP_TESTACARGAMENORVALOR') > 0 Then 

           If  pTesteCarga.vLOCALIDADEORIGEM = '06400' or 
               pTesteCarga.vLOCALIDADEORIGEM = '3505708' Then
              pTesteCarga.vLOCALIDADEORIGEM := pTesteCarga.vLOCALIDADEORIGEM;
           End If;    


           vBusca_Frete.vLOCALIDADEORIGEM  := pTesteCarga.vLOCALIDADEORIGEM;
           vBusca_Frete.vLOCALIDADEDESTINO := pTesteCarga.vLOCALIDADEDESTINO;
           vBusca_Frete.vLOCALIDADEOUTRACOL := pTesteCarga.vLOCALIDADEOUTRACOL;
           vBusca_Frete.vLOCALIDADEOUTRAENT := pTesteCarga.vLOCALIDADEOUTRAENT;
           vBusca_Frete.vTIPOFRETE         := pTesteCarga.vTIPOFRETE;
           vBusca_Frete.vTPCARGA           := vListaCargaCli.ccTPCARGACLI;
           vBusca_Frete.vRATEIA            := vListaCargaCli.ccRATEIA;
           vBusca_Frete.vPESOMINIMO        := vListaCargaCli.ccPESOMINIMO;
           vBusca_Frete.vCLIENTE           := pTesteCarga.vCLISAC;
           vBusca_Frete.vGRUPO             := pTesteCarga.vGRUPO;
           vBusca_Frete.vCONTRATO          := pTesteCarga.vCONTRATO;
           vBusca_Frete.vTPVEICULO         := pTesteCarga.vTPVEICULO;
           vBusca_Frete.vKM                := pTesteCarga.vKM;
           vBusca_Frete.vPESO              := pTesteCarga.vPeso;
           vBusca_Frete.vPESOTOTAL         := pTesteCarga.vPesoTotal;
           vBusca_Frete.vEntCol            := pTesteCarga.vEntCol;

           spi_SqlColetaEntrega( vBusca_Frete.vLOCALIDADEORIGEM,vBusca_Frete.vLOCALIDADEDESTINO,vListaCargaCli);
           pTesteCarga.TESTAPESO := pTesteCarga.vSql.CONTAPESO || 
                                    pTesteCarga.vSql.TABWHERE  ||
                                    pTesteCarga.vSql.SEMCTRSDR ||
                                    pTesteCarga.vSql.SEMCTRC   || 
                                    pTesteCarga.vSql.SCWHERE   ||
                                    pTesteCarga.vSql.NOTASWHERE;

           EXECUTE IMMEDIATE pTesteCarga.TESTAPESO INTO  pTesteCarga.vTestePeso,pTesteCarga.vTesteVlrMerc;
           
           If nvl(pTesteCarga.vTestePeso,0) > 0 Then
              pTesteCarga.FINALNOTA := pTesteCarga.vSql.NOTAS || 
                                       pTesteCarga.vSql.TABWHERE ||
                                       pTesteCarga.vSql.SEMCTRSDR ||
                                       pTesteCarga.vSql.SEMCTRC || 
                                       pTesteCarga.vSql.SCWHERE   ||
                                       pTesteCarga.vSql.NOTASWHERE;
              pTesteCarga.vRetorna := 'N';
           Else
              pTesteCarga.vRetorna := 'S';
              pTesteCarga.FINALNOTA := '';
           End If;
           tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Testando MENOR PRECO Tipo de Carga ' || vListaCargaCli.ccTPCARGACLI || ' - Peso ' || nvl(pTesteCarga.vTestePeso,0); 
           tpLogGeracao.Con_Loggeracao_Sql := pTesteCarga.TESTAPESO;
           vTextoMSG := fn_InsereLogGeracao;
           commit;
           if pTesteCarga.vRetorna = 'N' Then
              vBusca_Frete.vPESOTOTAL         := pTesteCarga.vTestePeso;                      
              vBusca_Frete.vPESO              := pTesteCarga.vTestePeso;


              tpLogGeracao.Con_Loggeracao_Sql := pTesteCarga.TESTAPESO;
              
              -- Se For Modo antigo Nao usa veiculo
              If nvl(ListaNotas.cnTABSOLCOD,SemTabelaCodigo) <> SemTabelaCodigo Then
                 vListaCargaCli.ccUSAVEICULO := 'N';
              End If;

           -- Busca o Tipo de Veiculo
              if vListaCargaCli.ccUSAVEICULO = 'N' Then
                 vBusca_Frete.vTPVEICULO := '9  ';
              Else
                 If Not ( ( nvl(pTesteCarga.vTemCD,'N') = 'N' ) and  ( nvl(pTesteCarga.vTemExpresso,'N') = 'N' ) ) Then
                    -- Forca a pesquisa ser pela GRID
                    vListaCargaCli.ccPESQVEICULO := 'G';
                 End If;   
                 

                 SP_TESTA_VEICULOPASSADO(vBusca_Frete.vGRUPO,
                                         vBusca_Frete.vCONTRATO,
                                         vBusca_Frete.vCLIENTE,
                                         vBusca_Frete.vPESOTOTAL,
                                         vBusca_Frete.vTIPOFRETE,
                                         null, -- TIPO DE TRANSPORTE
                                         vBusca_Frete.vTPCARGA,
                                         vListaCargaCli.ccPESQVEICULO,
                                         vBusca_Frete.vTPVEICULO,
                                         vStatus,
                                         vMessage);
                                        

                 If vStatus = 'E' Then
                    tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Erro Fatal ' || chr(10) || vMessage;
                 Else
                    tpLogGeracaO.Con_Loggeracao_ErroHTML := vMessage;
                 End If;                                    
                 vTextoMSG := fn_InsereLogGeracao;

                
              End If;                                         
              vBusca_Frete.vOrigem := pTesteCarga.vTPCARGACLI || '-' || nvl(pTesteCarga.vTemCD,'N') || nvl(pTesteCarga.vTemExpresso,'N') || '-' || vListaCargaCli.ccTPCARGACLI || '-' || vListaCargaCli.ccTPCARGACLIDESC; 
              vBusca_Frete.vPesqFRETECOLETA := 'M';
              SP_BUSCA_FRETEEMPRESA(vBusca_Frete,
                                    vListaCargaCli,
                                    vRetBuscaFrete,
                                    V_MENSAGEM);
              If vRetBuscaFrete.vRetorno = 'NE' Then                 
                 vRetBuscaFrete.SLF_CALCFRETEKM_VALOR := 0;
                 vTextoMSG := vTextoMSG || 'CD [' || nvl(pTesteCarga.vTemCD,'N') || '] EX [' || nvl(pTesteCarga.vTemExpresso,'N') || '] -' || vListaCargaCli.ccTPCARGACLI || '-' || vListaCargaCli.ccTPCARGACLIDESC || ' - ' || '   0,00' || '<br/>' ;
              Else

                 if ( vListaCargaCli.ccFORMULAFRTX is not null ) OR 
                    ( vListaCargaCli.ccFORMULAFRVL IS NOT NULL ) OR 
                    ( vListaCargaCli.ccFORMULAFRKM IS NOT NULL ) then

                   
                  -- Carrega as Verbas

                      if nvl(pTesteCarga.vTemQuimico,'N') = 'S' Then
                         ListaVerbas('V_PERCTQ').AsFloat      := vListaCargaCli.ccPERCTQM;
                         ListaVerbas('V_PERCTQ').Value        := trim(to_char(vListaCargaCli.ccPERCTQM));
                         ListaVerbas('V_PERCTQ').AsDesinencia := '%';
                      Else
                         ListaVerbas('V_PERCTQ').AsFloat      := 1;
                         ListaVerbas('V_PERCTQ').Value        := '1';
                         ListaVerbas('V_PERCTQ').AsDesinencia := '%';
                      End If;

                      if ( trim(pTesteCarga.vGrupoRem) = trim(pTesteCarga.vGrupoSac) ) AND 
                         ( trim(pTesteCarga.vGrupoDes) <>  trim(pTesteCarga.vGrupoSac) ) Then
                          ListaVerbas('V_PERCTO').AsFloat      := vListaCargaCli.ccPERCTOUT;
                          ListaVerbas('V_PERCTO').Value        := trim(to_char(vListaCargaCli.ccPERCTOUT));
                          ListaVerbas('V_PERCTO').AsDesinencia := '%';
                      Else
                          ListaVerbas('V_PERCTO').AsFloat      := 1;
                          ListaVerbas('V_PERCTO').Value        := '1';
                          ListaVerbas('V_PERCTO').AsDesinencia := '%';
                      End If;

                      if (trim(pTesteCarga.vGrupoRem) = trim(pTesteCarga.vGrupoDes)) and 
                         (trim(pTesteCarga.vGrupoSac) = trim(pTesteCarga.vGrupoDes))
                       Then
                         ListaVerbas('V_PERCTT').AsFloat      := vListaCargaCli.ccPERCTRA;
                         ListaVerbas('V_PERCTT').Value        := trim(to_char(vListaCargaCli.ccPERCTRA));
                         ListaVerbas('V_PERCTT').AsDesinencia := '%';
                      Else  
                         ListaVerbas('V_PERCTT').AsFloat      := 1;
                         ListaVerbas('V_PERCTT').Value        := '1';
                         ListaVerbas('V_PERCTT').AsDesinencia := '%';
                      End If;   

                      if nvl(pTesteCarga.vTemExpresso,'N') = 'S' Then
                         ListaVerbas('V_PERCTE').AsFloat      := vListaCargaCli.ccPERCTEX;
                         ListaVerbas('V_PERCTE').Value        := trim(to_char(vListaCargaCli.ccPERCTEX));
                         ListaVerbas('V_PERCTE').AsDesinencia := '%';
                      Else  
                         ListaVaux.cnPercentEx := 1;
                         ListaVerbas('V_PERCTE').AsFloat      := 1;
                         ListaVerbas('V_PERCTE').Value        := '1';
                         ListaVerbas('V_PERCTE').AsDesinencia := '%';
                      End If;    


                      ListaVerbas('V_PERCTR').AsFloat      := vListaCargaCli.ccPERCTREDUTOR;
                      ListaVerbas('V_PERCTR').Value        := trim(to_char(vListaCargaCli.ccPERCTREDUTOR));
                      ListaVerbas('V_PERCTR').AsDesinencia := '%';


                      ListaVerbas('V_VLRFIXO').AsFloat      := nvl(vRetBuscaFrete.SLF_CALCFRETEKM_VALORF,0);
                      ListaVerbas('V_VLRFIXO').Value        := trim(to_char(nvl(vRetBuscaFrete.SLF_CALCFRETEKM_VALORF,0)));
                      ListaVerbas('V_VLRFIXO').AsDesinencia := vRetBuscaFrete.SLF_CALCFRETEKM_DESINENCIAF;


                      ListaVerbas('D_FRPSVO').AsFloat      := vRetBuscaFrete.SLF_CALCFRETEKM_VALOR;
                      ListaVerbas('D_FRPSVO').Value        := trim(to_char(vRetBuscaFrete.SLF_CALCFRETEKM_VALOR));
                      ListaVerbas('D_FRPSVO').AsDesinencia := vRetBuscaFrete.SLF_CALCFRETEKM_DESINENCIA;


                      ListaVerbas('S_KMPER').AsFloat      := vBusca_Frete.vKM;
                      ListaVerbas('S_KMPER').Value        := trim(to_char(vBusca_Frete.vKM));
                      ListaVerbas('S_KMPER').AsDesinencia := 'VL';


/*                      ListaVerbas('D_PSREAL').AsFloat := round(vBusca_Frete.vPESOTOTAL,3);
                      ListaVerbas('D_PSREAL').Value   := trim(to_char((round(vBusca_Frete.vPESOTOTAL,3))));

                      ListaVerbas('I_PSCOBRAD').AsFloat := round(vBusca_Frete.vPESOTOTAL,3);
                      ListaVerbas('I_PSCOBRAD').Value   := trim(to_char((round(vBusca_Frete.vPESOTOTAL,3))));
*/
                      ListaVerbas('D_PSREAL').AsFloat := vBusca_Frete.vPESOTOTAL;
                      ListaVerbas('D_PSREAL').Value   := trim(to_char((vBusca_Frete.vPESOTOTAL)));

                      ListaVerbas('I_PSCOBRAD').AsFloat := vBusca_Frete.vPESOTOTAL;
                      ListaVerbas('I_PSCOBRAD').Value   := trim(to_char((vBusca_Frete.vPESOTOTAL)));

                      ListaVerbas('V_PSRATEIO').AsFloat      := vBusca_Frete.vPESOTOTAL;
                      ListaVerbas('V_PSRATEIO').Value        := trim(to_char(vBusca_Frete.vPESOTOTAL));
                      ListaVerbas('V_PSRATEIO').AsDesinencia := '%';

                      ListaVerbas('V_FTRATEIO').AsFloat      := 1;
                      ListaVerbas('V_FTRATEIO').Value        := '1';
                      ListaVerbas('V_FTRATEIO').AsDesinencia := '%';



                      ListaVerbas('S_ALICMS').AsFloat := 1;
                      ListaVerbas('S_ALICMS').Value   := '1';

                      ListaVerbas('S_ALISS').AsFloat := 1;
                      ListaVerbas('S_ALISS').Value   := '1';

                      ListaVerbas('I_VLMR').AsFloat := 1;
                      ListaVerbas('I_VLMR').Value   := '1';


                      ListaVerbas('D_VLRSEGUR').AsFloat := 1;
                      ListaVerbas('D_VLRSEGUR').Value   := '1';


                      ListaVerbas('D_PD').AsFloat := 0;                               
                      ListaVerbas('D_PD').Value   := '0';
                  
                 
                 
                 
                    if vRetBuscaFrete.SLF_CALCFRETEKM_DESINENCIA = 'TX' Then
                       vFormulaUsada := vListaCargaCli.ccFORMULAFRTX;
                       vFormulaTraduzidaF := ' SELECT ' || fn_MudaFormula(vListaCargaCli.ccFORMULAFRTX,ListaVerbas) || ' FROM DUAL ';
                       execute immediate vFormulaTraduzidaF into vRetBuscaFrete.SLF_CALCFRETEKM_VALOR;
                       vRetBuscaFrete.SLF_CALCFRETEKM_VALOR := vRetBuscaFrete.SLF_CALCFRETEKM_VALOR * ( vBusca_Frete.vPESOTOTAL / 1000 );
                    ElsIf vRetBuscaFrete.SLF_CALCFRETEKM_DESINENCIA = 'KM' Then 
                       vFormulaUsada := vListaCargaCli.ccFORMULAFRKM;
                       vFormulaTraduzidaF := ' SELECT ' || fn_MudaFormula(vListaCargaCli.ccFORMULAFRKM,ListaVerbas) || ' FROM DUAL ';
                       execute immediate vFormulaTraduzidaF into vRetBuscaFrete.SLF_CALCFRETEKM_VALOR;
                    Else
                       vFormulaUsada := vListaCargaCli.ccFORMULAFRVL;
                       vFormulaTraduzidaF := ' SELECT ' || fn_MudaFormula(vListaCargaCli.ccFORMULAFRVL,ListaVerbas) || ' FROM DUAL ';
                       execute immediate vFormulaTraduzidaF into vRetBuscaFrete.SLF_CALCFRETEKM_VALOR;
                    End If;   
                 ELse 
                    vFormulaUsada := 'SEM FORMULA';
                    if vRetBuscaFrete.SLF_CALCFRETEKM_DESINENCIA = 'TX' Then
                       vRetBuscaFrete.SLF_CALCFRETEKM_VALOR := vRetBuscaFrete.SLF_CALCFRETEKM_VALOR * ( vBusca_Frete.vPESOTOTAL / 1000 );
                    Else
                       vRetBuscaFrete.SLF_CALCFRETEKM_VALOR := vRetBuscaFrete.SLF_CALCFRETEKM_VALOR;
                    End If;
                 End If   ;
                 vTextoMSG := vTextoMSG || 'Formula Usada : ' || replace(replace(vFormulaUsada,'<<','(('),'>>','))') || '<br/>' || 'Formula Traduzida : ' || vFormulaTraduzidaF || '<br/>' ;
                 vTextoMSG := vTextoMSG || 'CD [' || nvl(pTesteCarga.vTemCD,'N') || '] EX [' || nvl(pTesteCarga.vTemExpresso,'N') || '] -' || vListaCargaCli.ccTPCARGACLI || '-' || vListaCargaCli.ccTPCARGACLIDESC || ' - ' || to_char(vRetBuscaFrete.SLF_CALCFRETEKM_VALOR) || '<br/>' ;
              
                 
                 if ( ( nvl(pTesteCarga.vTemCD,'N')       = 'S' )  or 
                      ( nvl(pTesteCarga.vTemExpresso,'N') = 'S' ) ) and 
                      ( pTesteCarga.vGRUPO = '0535'  ) Then
                    if pTesteCarga.vTPCARGACLI = '01'  Then
                       pTesteCarga.vRetorna := 'N';
                       pTesteCarga.FINALNOTA := pTesteCarga.FINALNOTA;
                    Else
                       pTesteCarga.vRetorna := 'S';
                       pTesteCarga.FINALNOTA := '';
                    End If;  
                    tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := replace(vTextoMSG,'<br/>',chr(10)) ;
                    vTextoMSG := fn_InsereLogGeracao;
                       return;
                 End If;

              
              End If;
           Else
              vRetBuscaFrete.SLF_CALCFRETEKM_VALOR := 0;
              vBusca_Frete.vPESOTOTAL := 0;                     
           End If;        


           if ( nvl(VmaiorFreteVLR,0) < vRetBuscaFrete.SLF_CALCFRETEKM_VALOR ) and ( vRetBuscaFrete.SLF_CALCFRETEKM_VALOR  > 0 ) Then
              VmaiorFreteVLR := vRetBuscaFrete.SLF_CALCFRETEKM_VALOR;
              vMaiorFreteTC  := vBusca_Frete.vTPCARGA;
              vMaiorFreteSQL :=  pTesteCarga.FINALNOTA;
           End If;
             
           if ( nvl(VmenorFreteVLR,100000) > vRetBuscaFrete.SLF_CALCFRETEKM_VALOR) and ( vRetBuscaFrete.SLF_CALCFRETEKM_VALOR  > 0 )  Then
              VmenorFreteVLR := vRetBuscaFrete.SLF_CALCFRETEKM_VALOR;
              vMenorFreteTC  := vBusca_Frete.vTPCARGA;
              vMenorFreteSQL :=  pTesteCarga.FINALNOTA;
           End If;
           
           If vRetBuscaFrete.SLF_CALCFRETEKM_VALOR  > 0 Then
              vQtdePrecosachados := vQtdePrecosachados + 1;
           End If;   
           
       End If;
    End loop;  

    if vMenorFreteTC = pTesteCarga.vTPCARGACLI Then
       pTesteCarga.vRetorna := 'N';
       pTesteCarga.FINALNOTA := vMenorFreteSQL;
    Else
       pTesteCarga.vRetorna := 'S';
       pTesteCarga.FINALNOTA := '';
    End IF;
    
    tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Retorna - ' || pTesteCarga.vRetorna || chr(10) || 
                                              'Carga Entrada ' || pTesteCarga.vTPCARGACLI || chr(10) ||
                                              vTextoMSG;
    If (vQtdePrecosachados < 2) /*and (vQtdePrecosachados <> 0)*/  Then
       pTesteCarga.vRetorna := 'S';
       pTesteCarga.FINALNOTA := '';
       tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Sem preco para comparac?o. Total de Precos encontrados : ' || to_char(vQtdePrecosachados);
       
       if vSemCOmparacaoEnviaEmail = 'S' Then
           vTextoEmail := TDVADM.PKG_GLB_HTML.Assinatura;
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_Titulo('FALTA PRECO PARA COMPARAC?O - Carregamento [' || trim(V_ARM_CARREGAMENTO) || ']' ) ;
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_AbreLista; 
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_ItensLista('ORIGEM        : ',NULL,tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'IBD'));
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_ItensLista('DESTINO       : ',NULL,tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'IBD'));
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_ItensLista('ORIGEM MESO   : ',NULL,tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'MED'));
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_ItensLista('DESTINO MESO  : ',NULL,tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'MED'));
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_ItensLista('ORIGEM MICRO  : ',NULL,tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'MID'));
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_ItensLista('DESTINO MICRO : ',NULL,tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'MID'));
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_ItensLista('TPFRETE     : ',NULL,pTesteCarga.vTIPOFRETE);
           vAuxiliarT := '';
           Begin
              select tc.fcf_tpcarga_codigo || '-' || tc.fcf_tpcarga_descricao
                into vAuxiliarT
              from TDVADM.T_fcf_tpcarga tc
              where tc.fcf_tpcarga_codigo = vListaCargaCli.ccTPCARGACLI;
           exception
             When OTHERS Then
                vAuxiliarT := vListaCargaCli.ccTPCARGACLI;
           End ; 
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_ItensLista('TPCARGA     : ',NULL,vAuxiliarT);
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_ItensLista('RATEIA      : ',NULL,vListaCargaCli.ccRATEIA);
           vAuxiliarT := '';
           Begin
              select cl.glb_cliente_cgccpfcodigo || '-' || cl.glb_cliente_razaosocial
                into vAuxiliarT
              from TDVADM.T_glb_cliente cl
              where cl.glb_cliente_cgccpfcodigo = pTesteCarga.vCLISAC;
           exception
             When OTHERS Then
                vAuxiliarT := pTesteCarga.vCLISAC;
           End ; 
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_ItensLista('SACADO      : ',NULL,vAuxiliarT);
           vAuxiliarT := '';
           Begin
              select gp.glb_grupoeconomico_codigo || '-' || gp.glb_grupoeconomico_nome
                into vAuxiliarT
              from TDVADM.T_glb_grupoeconomico gp
              where gp.glb_grupoeconomico_codigo = pTesteCarga.vGRUPO;
           exception
             When OTHERS Then
                vAuxiliarT := pTesteCarga.vGRUPO;
           End ; 
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_ItensLista('GRUPO       : ',NULL,vAuxiliarT);
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_ItensLista('CONTRATO    : ',NULL,pTesteCarga.vCONTRATO);
           vAuxiliarT := '';
           Begin
              select tc.fcf_tpveiculo_codigo || '-' || tc.fcf_tpveiculo_descricao
                into vAuxiliarT
              from TDVADM.T_fcf_tpveiculo tc
              where tc.fcf_tpveiculo_codigo = pTesteCarga.vTPVEICULO;
           exception
             When OTHERS Then
                vAuxiliarT := pTesteCarga.vTPVEICULO;
           End ; 
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_ItensLista('TPVEICULO   : ',NULL,vAuxiliarT);
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_ItensLista('KM          : ',NULL,pTesteCarga.vKM);
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_ItensLista('PESO MINIMO : ',NULL,vListaCargaCli.ccPESOMINIMO);
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_ItensLista('PESO        : ',NULL,vBusca_Frete.vPESOTOTAL);
--           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_ItensLista('PESO TOTAL  : ',NULL,vBusca_Frete.vPESOTOTAL);
           if pTesteCarga.vEntCol = 'E' Then
              vAuxiliarT := 'ENTREGA';
           Else
              vAuxiliarT := 'COLETA';
           End If;   
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_ItensLista('ENT/COL     : ',NULL,vAuxiliarT);
           vTextoEmail := vTextoEmail || TDVADM.PKG_GLB_HTML.fn_FechaLista;
           vTextoEmail := vTextoEmail || vTextoMSG;
           if length(trim(vTextoMSG)) > 100 Then
              WSERVICE.PKG_GLB_EMAIL.SP_ENVIAEMAIL('CONTRATO - ' || vBusca_Frete.vCONTRATO || ' GRUPO ' || vBusca_Frete.vGRUPO || ' - ARMAZEM :' || ListaVaux.cnArmazemNome ,
                                                   vTextoEmail,
                                                   'aut-e@dellavolpe.com.br',
                                                   vSemCOmparacaoDestinatario);
           End If;   
           vSemCOmparacaoEnviaEmail := 'N';
       End If;     
    End If;
    vTextoMSG := fn_InsereLogGeracao;

    
  End SP_TESTACARGAMENORVALOR;   


  Procedure SP_TESTACARGASPOT(pTesteCarga    in out tdvadm.PKG_FIFO_CARREGCTRC.TpTesteCarga,
                                     pListaCargaCli in     tdvadm.PKG_FIFO_CARREGCTRC.TlistaCargaCli)
 
  Is
    vAuxiliar  integer;
    vOrigem  varchar2(1000);
    vDestino varchar2(1000);
  Begin
    -- Procura a Carga na Lista Passada
    vAuxiliar := 0;
    loop
      vAuxiliar := vAuxiliar + 1;
      exit when pListaCargaCli(vAuxiliar).ccTPCARGACLI = pTesteCarga.vTPCARGACLI;
    end loop;  
  
    pTesteCarga.vRetorna := 'S';

 
 
       if pListaCargaCli(vAuxiliar).ccTPCODORIGEM    = 'NN' Then -- Nao Pesquisa
          vOrigem := '99999';
          vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'IBC')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'LO' Then -- Localidade
          vOrigem := ' AND N.ARM_NOTA_LOCALCOLETAL = ''' || trim(pTesteCarga.vLOCALIDADEORIGEM)  || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'IB' Then -- IBGE
          vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'IBC')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'FI' Then -- FIXO IBGE
          If pListaCargaCli(vAuxiliar).ccORIGEMFIXA is not null then
             vOrigem := ' AND N.ARM_NOTA_LOCALCOLETA = ''' || rpad(trim(pListaCargaCli(vAuxiliar).ccORIGEMFIXA),8)  || '''';
          End If;
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'RE' Then -- Regiao Cartografica
          vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBR'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'IBR')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'RC' Then -- Regiao Cartografica do Cliente
          vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBRV'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'IBRV')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'CI' Then -- Capital Interior
          vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''CI'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'CI')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'UF' Then -- Por Estado
          vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''UF'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'UF')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'RA' Then -- Por Raio
          vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'IBC')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'ME' Then -- Por Raio
          vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''MEC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'MEC')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODORIGEM = 'MI' Then -- Por Raio
          vOrigem := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALCOLETAI,''MIC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEORIGEM,'MIC')),8) || '''';
       Else
          vOrigem := null;  
       End If;     
     
  
       pTesteCarga.vSql.NOTASWHERE := pTesteCarga.vSql.NOTASWHERE || vOrigem;


       if pListaCargaCli(vAuxiliar).ccTPCODDESTINO    = 'NN' Then -- Nao Pesquisa
          vDestino := '99999';
          vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'IBC')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'LO' Then -- Localidade
          vDestino := ' AND N.ARM_NOTA_LOCALENTREGAL = ''' || rpad(trim(pTesteCarga.vLOCALIDADEDESTINO),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'IB' Then -- IBGE
          vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'IBC')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'FI' Then -- FIXO IBGE
          If pListaCargaCli(vAuxiliar).ccDESTINOFIXO is not null Then
             vDestino := ' AND N.ARM_NOTA_LOCALENTREGAI = ''' || rpad(trim(pListaCargaCli(vAuxiliar).ccDESTINOFIXO),8) || '''';
          End If;
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'RE' Then -- Regiao Cartografica
          vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBR'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'IBR')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'RC' Then -- Regiao Cartografica do Cliente
          vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBRV'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'IBRV')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'CI' Then -- Capital Interior
          vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''CI'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'CI')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'UF' Then -- Por Estado
          vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''UF'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'UF')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'RA' Then -- Por Raio
          vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''IBC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'IBC')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'ME' Then -- Por Meso
          vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''MEC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'MEC')),8) || '''';
       Elsif pListaCargaCli(vAuxiliar).ccTPCODDESTINO = 'MI' Then -- Por Micro
          vDestino := ' AND rpad(trim(tdvadm.fn_busca_codigoibge(N.ARM_NOTA_LOCALENTREGAI,''MIC'')),8)  = ''' ||  rpad(trim(tdvadm.fn_busca_codigoibge(pTesteCarga.vLOCALIDADEDESTINO,'MIC')),8) || '''';
       Else
         vDestino := null;   
       End If; 

       pTesteCarga.vSql.NOTASWHERE := pTesteCarga.vSql.NOTASWHERE || vDestino;

       
       pTesteCarga.TESTAPESO := pTesteCarga.vSql.CONTAPESO || 
                                pTesteCarga.vSql.TABWHERE  ||
                                pTesteCarga.vSql.SEMCTRSDR ||
                                pTesteCarga.vSql.SEMCTRC   || 
                                pTesteCarga.vSql.NOTASWHERE;       


       EXECUTE IMMEDIATE pTesteCarga.TESTAPESO INTO  pTesteCarga.vTestePeso,pTesteCarga.vTesteVlrMerc;
       


       If nvl(pTesteCarga.vTestePeso,0) > 0 Then
          pTesteCarga.FINALNOTA := pTesteCarga.vSql.NOTAS || 
                                   pTesteCarga.vSql.TABWHERE ||
                                   pTesteCarga.vSql.SEMCTRSDR ||
                                   pTesteCarga.vSql.SEMCTRC || 
                                   pTesteCarga.vSql.NOTASWHERE; 
                         
          pTesteCarga.vRetorna := 'N';
       Else
          pTesteCarga.vRetorna := 'S';
          pTesteCarga.FINALNOTA := '';
       End If;
    
       If pTesteCarga.vTPCARGACLI = '28' Then
          If pTesteCarga.vTemCD = 'N' Then
             pTesteCarga.vRetorna := 'S';
             pTesteCarga.FINALNOTA := '';
          End If; 
       ElsIf pTesteCarga.vTPCARGACLI = '29' Then
          If pTesteCarga.vTemCD = 'S' Then
             pTesteCarga.vRetorna := 'S';
             pTesteCarga.FINALNOTA := '';
          End If; 
       Else   
          pTesteCarga.vRetorna := 'S';
          pTesteCarga.FINALNOTA := '';
       End If;


   End SP_TESTACARGASPOT;   
  


   PROCEDURE SP_CON_CRIACTRCCARREG(P_ARM_CARREGAMENTO     IN TDVADM.T_ARM_CARREGAMENTO.ARM_CARREGAMENTO_CODIGO%TYPE,
                                   P_ARM_ARMAZEM          IN TDVADM.T_ARM_ARMAZEM.ARM_ARMAZEM_CODIGO%TYPE,
                                   P_DATAEMISSAO          IN DATE,
                                   P_USU_USUARIOCRIA      IN TDVADM.T_USU_USUARIO.USU_USUARIO_CODIGO%TYPE,
                                   P_RETORNOPROCESSAMENTO OUT VARCHAR)

   IS
    -- criando um cursor temporario pois as embalagens de transferencias
    -- Nao est?o indo para ABA de CTRC
    vSql       clob;
    vDTCol              tdvadm.t_arm_nota.arm_nota_codclicoleta%type;
    vPedido       tdvadm.t_arm_coleta.arm_coleta_pedido%type;
    vIdCarga            Integer;
    pAgrupamentoEmissao glbadm.pkg_listas.tListaParamsString;
    pAgrupamentoCorte   glbadm.pkg_listas.tListaParamsString;
    pOrigemOriginalNota glbadm.pkg_listas.tListaParamsString;
    vQtdeCorte          number;
    vQtdeLimiteJanela   number;  
    vQtdeNotasCteEmitido number;

    vBusca_Frete        TpParamBuscaVerba;
    vRetBuscaFrete      TpBuscaVerba;

    vBusca_FreteCol     TpParamBuscaVerba;
    vRetBuscaFreteCol   TpBuscaVerba;

    vTpCargaJanela      tdvadm.t_fcf_tpcarga.fcf_tpcarga_codigo%type;     
    plistaparams glbadm.pkg_listas.tlistausuparametros;
    tpCarragamentoHist tdvadm.T_ARM_CARREGAMENTO_HIST%rowtype;
    tpConViagem tdvadm.t_con_viagem%rowtype;
    tpConViagemDet      tdvadm.t_con_viagemdet%rowtype;

    tpConRedespacho    TDVADM.T_con_consigredespacho%Rowtype;
    tpArmNotaRedespacho TDVADM.T_arm_notaredespacho%Rowtype;

    tpConConhecimento      tdvadm.t_con_conhecimento%rowtype;
    tpConCalcConhecimento  tdvadm.t_con_calcconhecimento%rowtype;
    tpConhecComplemento    tdvadm.t_con_conheccomplemento%rowtype;
    tpConNftransporta      tdvadm.t_con_nftransporta%rowtype;
    tpConNftransportaExtra tdvadm.t_con_nftransportaextra%rowtype;
    tpConhecRegEsp         tdvadm.t_con_conhecimentoregesp%rowtype;
    vLocalColetaL     char(8);
    vLocalEntregaL    char(8);
    vLocalColetaI     char(8);
    vLocalEntregaI    char(8);
    vError            varchar2(20000);  
    tpsimulador       TDVSVA.T_CS278_SIMULADOR%ROWTYPE;
    
    vValeFreteCOD    tdvadm.t_con_valefrete.con_conhecimento_codigo%type;
    vValeFreteROTA   tdvadm.t_con_valefrete.glb_rota_codigo%type;
    vValeFreteSR     tdvadm.t_con_valefrete.con_conhecimento_serie%type;
    vValeFreteSQ     tdvadm.t_con_valefrete.con_valefrete_saque%type;
    vMilkRun         varchar2(50);
    
    
     cursor C_EMBTRANSCTRC
    is 
      select nc.ARM_CARREGAMENTO_CODIGO carn,
             nc.CTRC,
             nc.serie,
             nc.rota
  from TDVADM.T_con_conhecimento c,
       v_arm_notascarregamento nc
  where nc.ARM_CARREGAMENTO_CODIGO = P_ARM_CARREGAMENTO
    and nc.CTRC = c.con_conhecimento_codigo
    and nc.serie = c.con_conhecimento_serie
    and nc.rota = c.glb_rota_codigo
    and nc.ARM_CARREGAMENTO_CODIGO <> nvl(c.arm_carregamento_codigo,'999999');
    

   tpCarregamento  tdvadm.t_arm_carregamento%rowtype;

    -- VARIAVEIS QUE DEVEM SER CRIADAS PARA PROCEDURE DE PRODUCAO NAO DAR ERRO
   -- VERRO VARCHAR2(32000);

    -- CRIANDO OS CURSORESp_cursor2
    cSACADO tpCurosr;
    cNOTAS  tpCurosr;
    cCARGAS tpCurosr;
    -- criando variaveis para pegar dados da nota para envio do CTe
    v_notacfop     TDVADM.T_XML_NOTA.XML_NOTA_CFOP%TYPE;
    v_notacodimp   TDVADM.T_XML_NOTAIMPOSTO.XML_NOTAIMPOSTO_CODIMPOSTO%TYPE;
    v_notabaseimp  TDVADM.T_XML_NOTAIMPOSTO.XML_NOTAIMPOSTO_BASE%TYPE;
    v_notavlrimp   TDVADM.T_XML_NOTAIMPOSTO.XML_NOTAIMPOSTO_VALORIMPOSTO%TYPE;

    -- CRIANDO VARIAVEIS AUXILIARES DAS INSTRUCOES SQL
    -- CRIANDO VARIAVEIS GERAIS

      
    -- incicializa a mesma com 1 caracter para que a instruc?o INSTR Nao retorne null
    vLISTADENOTASNRAT    VARCHAR2(10000) := ',';
    vInstrucaoNRat       varchar2(10100) := '';  
    V_MESSAGE            VARCHAR2(1000); 

    V_PESOCOBRADOFAIXA   NUMBER;
    V_SOMAPESOREAL       NUMBER;
    V_SOMAPESOBALANCA    NUMBER;
    V_SOMAPESOCOBRADO    NUMBER;
    V_SOMAMERCADORIA     NUMBER;
    V_SOMAMERCADORIACC   number;
    V_LISTANOTASCTRC     varchar2(2000);
    V_PESOTOTAL          NUMBER;
    V_PESOBALTOTAL       NUMBER;
    V_PESOCOBTOTAL       NUMBER;
    V_VALORTOTMERCADORIA NUMBER;
    V_MSGOBS             VARCHAR2(20000); -- variavel para montar observacao
    V_MSGOBS2            VARCHAR2(20000); -- variavel para montar observacao
    
    V_MOTVEICULO         CHAR(1);
    V_CODVIAGEM          TDVADM.T_CON_VIAGEM.CON_VIAGEM_NUMERO%TYPE;
    V_CODMOTFROTA        TDVADM.T_FRT_CONJUNTO.FRT_MOTORISTA_CODIGO%TYPE;
    V_CONTADORCTRC       NUMBER;
    V_CONTAVERBAVLR      NUMBER;
    V_CONTADORNOTA       NUMBER;
    v_CTRCIMPRESSO       NUMBER;
    
    V_TOTNOTCOMCTRC      NUMBER;
    V_CTRCCODIGO         TDVADM.T_CON_CONHECIMENTO.CON_CONHECIMENTO_CODIGO%TYPE;
    V_VERTPCARGAS        CHAR(3);
    V_LOTACAO            NUMBER;
    V_LOTACAOVLRMERC     NUMBER;
--    V_FATORRATEIO        NUMBER;
    V_PESOAUXILIAR       NUMBER;
    V_PESOAUXILIAR2      NUMBER;
    V_PESOEXCEDENTE      NUMBER;
--    vTeste               NUMBER;
--    V_RETORNA            CHAR(1);
--    V_TPRETORNO          TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_TPFRETE%TYPE;
--    V_FRETEEMPRESA       TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_VALOR%TYPE;
--    V_FRETEDESINENCIA    TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_DESINENCIA%TYPE;
--    V_TABELA             TDVADM.T_SLF_TABELA.SLF_TABELA_CODIGO%TYPE;
--    V_TABELASQ           TDVADM.T_SLF_TABELA.SLF_TABELA_SAQUE%TYPE;
    V_MENSAGEM           TDVADM.T_CON_LOGGERACAO.CON_LOGGERACAO_OBSGERACAO%TYPE;
    V_CODIGOVEICULO      TDVADM.T_FCF_TPVEICULO.FCF_TPVEICULO_CODIGO%TYPE;
    V_CONTADORDENOTAS    NUMBER;
    --   V_FRETEPRACA      VARCHAR2(100);
    V_TPCALCULO          TDVADM.T_SLF_TABELA.SLF_TPCALCULO_CODIGO%TYPE;
    V_ALIQUOTA         TDVADM.T_SLF_ICMS.SLF_ICMS_ALIQUOTA%TYPE;
--    V_CODIGOLOG        INTEGER;
--    V_CODMERCADORIA    TDVADM.T_GLB_MERCADORIA.GLB_MERCADORIA_CODIGO%TYPE;
    v_classificaerro   varchar2(20000);
    v_datactrc         TDVADM.T_con_conhecimento.con_conhecimento_dtembarque%type;
--    V_LISTADENOTAS     VARCHAR2(20000);
    V_ACHOUSACADO      CHAR(1);
    V_CODCLIENTE       TDVADM.T_SLF_CALCFRETE.SLF_CALCFRETE_CODCLI%TYPE;
    V_CONTADOR         NUMBER;
    V_CONTADOR2       NUMBER;
    V_LOCREM           TDVADM.T_GLB_LOCALIDADE.GLB_LOCALIDADE_CODIGO%TYPE;
    V_LOCDEST          TDVADM.T_GLB_LOCALIDADE.GLB_LOCALIDADE_CODIGO%TYPE;
    V_ARMTRAVADO       VARCHAR2(1000);
    
    v_vlrlotacao        TDVADM.T_SLF_TABELALOTACAO.GLB_TABELALOTACAO_MAXKG%TYPE;  
    V_PRIORIDADE        TDVADM.T_ARM_COLETA.ARM_COLETA_PRIORIDADE%TYPE;

    CURSOR C_VIAGEM IS
      SELECT v.con_viagem_numero, v.glb_rota_codigoviagem
        FROM TDVADM.T_CON_VIAGEM V
       WHERE V.GLB_ROTA_CODIGOVIAGEM = ListaNotas.cnROTA
         and rownum = 1
         FOR UPDATE of v.con_viagem_numero;
         
    V_OBS_PESAGEM VARCHAR(1000);
    V_PESAGEM     number;
    --KLAYTON 27/01/2011 VARIAVEL PARA A CHAVE DA NFE
    v_ObsTABSOL         TDVADM.T_SLF_SOLFRETE.SLF_SOLFRETE_OBSSOLICITACAO%TYPE;
    v_ObsTABSOLImp      TDVADM.T_slf_solfrete.slf_solfrete_imprimeobsctrc%TYPE; 


   -- ENTROU POR CAUSA DO NO CONCEITO DE PRODUTO QUIMICO (FICHA DE EMERGENCIA)
    v_FORMULARIOCLI      tdvadm.t_arm_notafichaemerg.arm_notafichaemerg_codcli%TYPE;
    v_CLASSIFCLI         tdvadm.t_arm_notafichaemerg.glb_onuclascli_codigo%TYPE;
    
    v_FormularioEX     tdvadm.t_arm_coleta.arm_coleta_nrformulario%Type;
    v_FormularioSP     tdvadm.t_arm_coleta.arm_coleta_nrformulario%Type;
    v_FormularioAH     tdvadm.t_arm_coleta.arm_coleta_nrformulario%Type;
    Vautorizador       tdvadm.t_arm_coleta.arm_coletaex_soap_codigo%TYPE; 
    
    
   vDedoDuro         Varchar2(20000);
   vPeso             Number;
   vNotaMae_Numero   TDVADM.T_arm_notavide.arm_nota_numero%Type;
   vNotaMae_Serie    TDVADM.T_arm_notavide.arm_nota_serie%Type;
   vTipoDocumento    Char(1); -- Indica se estou fazendo um CTRC/CTE ou Nota Fiscal de Servico
   
   --Variavel inteira, utilizada para controle de operac?es
   vControl NUMBER;
   vControlRedespacho number;
   vListaCOBCOL  tListaCobraColeta;
   vAuxiliarCOBCOL number := 0; 
   vAuxiliarMemo varchar2(4000);
   vAuxiliarchar char(1) := '';
   vAuxiliarnumerico Number := 0; 
   vAuxiliarnumerico2 Number := 0; 
   vAuxiliarnumerico3 Number := 0; 
   vAuxiliarPesoRateio Number :=0;
   vAuxiliarFatorRateio Number := 0;
   vCorpoEmail clob;     
   vAuxiliarT varchar2(1000);
   vAuxiliarJ1 varchar2(1000);
   vAuxiliarJ2 varchar2(1000);
   vFormulaTraduzidaF tdvadm.v_slf_clientecargas2.slf_clientecargas_formulafrtx%type;
   vFormulaTraduzidaP tdvadm.v_slf_clientecargas2.slf_clientecargas_formulafrtx%type;
   vAuxiliarT1  varchar2(100);
   vAuxiliarT2  varchar2(100);
   vAuxiliarT3  varchar2(100);
   vAuxiliar    number;
   vAuxiliarD   date;
   vErro    char(1);
   vStatus  char(1);
   vMessage varchar2(32000);
   vNomeRota tdvadm.t_glb_rota.glb_rota_descricao%type;
   --Variaveis de linha, utilizada apenas para facilitar inserc?es / busca de dados.
   
   vPesagemObrigatoria char(1);
   vPesominimo    number;
   vPesagemMaximo number;
    
   vCodVeicVirtual  tdvadm.t_fcf_veiculodisp.fcf_veiculodisp_codigo%type;
    
   tpJanela TDVADM.T_arm_carregamemcalc%rowtype;
   
   tpCarregamentodet tdvadm.t_arm_carregamentodet%rowtype;
   
  
  Begin
    vSql              := empty_clob;
    vErroFatal        := 'N';
    vContextCount     := 0;
    vAuxiliarnumerico := 0;

    Execute immediate ( ' ALTER SESSION set NLS_DATE_FORMAT = "DD/MM/YYYY" ' );
    
    who_called_me2;
     
    vCorpoEmail := empty_clob;
    
    -- Atualiza as Janelas de CTe Nao Gerados
    update tdvadm.t_arm_janelacons jc
      set jc.arm_janelacons_qtdenf = (select count(*) from tdvadm.t_arm_nota an where an.arm_janelacons_sequencia = jc.arm_janelacons_sequencia),
          jc.arm_janelacons_qtdectenfs = nvl((select count(*) from tdvadm.t_arm_nota an where an.arm_janelacons_sequencia = jc.arm_janelacons_sequencia and an.con_conhecimento_codigo is not null),0),
          jc.arm_janelacons_pesocons = nvl((select sum( nvl(an.arm_nota_pesobalanca,an.arm_nota_peso)) from tdvadm.t_arm_nota an where an.arm_janelacons_sequencia = jc.arm_janelacons_sequencia),0),
          jc.arm_janelacons_merccons = nvl((select sum( an.arm_nota_valormerc) from tdvadm.t_arm_nota an where an.arm_janelacons_sequencia = jc.arm_janelacons_sequencia),0)
    where jc.arm_janelacons_qtdectenfs <= 0;
    commit;
    
   /* if trim(lower(P_USU_USUARIOCRIA)) = 'dvirgens' Thencompleme
       raise_application_error(-20001,'SIRLANO');
       system.pkg_glb_context.sp_set_vlr_CARREGAMENTO('CODCARREG',trim(P_ARM_CARREGAMENTO));
       commit;
    End If;*/

    -- RELACAO DE ARQMAZENS TRAVADO PARA O NOVO PROCESSO DE PRODUTO QUIMICO
    -- SERA SUBSTITUIDO POR PARAMETRO
    ListaVaux.cnArmazem := P_ARM_ARMAZEM;
    P_RETORNOPROCESSAMENTO := TDVADM.PKG_glb_common.Status_Nomal;
    -- trocado em 23/04/2012
    V_ARM_CARREGAMENTO := P_ARM_CARREGAMENTO;
    V_ARMTRAVADO := '00';
    tpLogGeracao.Arm_Carregamento_Codigo := P_ARM_CARREGAMENTO;
    tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'FECHANDO COM A NOVA PKG_FIFO_CARREGCTRC' || chr(10) ||
                                              'Usuario: ' || P_USU_USUARIOCRIA;
    P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;


    -- Apaga Memoria de Calculo
    delete TDVADM.T_arm_carregamemcalc x where x.arm_carregamemcalc_memocalc = P_ARM_CARREGAMENTO;
    -- Apaga Simulac?es
    Begin
        select distinct s.cs278_simulador_processo 
          into vAuxiliarnumerico
        from tdvsva.t_cs278_simulador s
        where s.arm_carregamento_codigo = P_ARM_CARREGAMENTO;
        if vAuxiliarnumerico is not null Then
           TDVSVA.PKG_SVA_LIB.SP_LIMPA_PROCESSO(vAuxiliarnumerico);
        End If;
        delete tdvsva.t_cs278_simulador s where s.arm_carregamento_codigo = P_ARM_CARREGAMENTO;
    exception
      When OTHERS Then
         vAuxiliar := '';
      End ;  
    
    tpLogGeracao.arm_carregamento_codigo := P_ARM_CARREGAMENTO;
    tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Limpado Memoria de Calculo';
    P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
--    DELETE T_GLB_SQL SQ WHERE SQ.GLB_SQL_OBSERVACAO like '%Carreg ' || V_ARM_CARREGAMENTO || '%';
    -- pega Dados do Armazem
    select a.glb_rota_codigo,
           a.arm_armazem_descricao,
           a.glb_localidade_codigo
      into ListaVaux.cnArmazemRota,
           ListaVaux.cnArmazemNome, 
           ListaVaux.cnArmazemLoc
    From TDVADM.T_arm_armazem a
    where a.arm_armazem_codigo = P_ARM_ARMAZEM;
      
    
    select nvl(c.FCF_VEICULODISP_CODIGO,0)
      into vCodVeicVirtual
    from TDVADM.T_ARM_CARREGAMENTO c
    WHERE ARM_CARREGAMENTO_CODIGO = P_ARM_CARREGAMENTO;
     
    if vCodVeicVirtual = 0 Then
       vCodVeicVirtual := TDVADM.PKG_fifo.fn_CriaVeicVirtual(P_ARM_CARREGAMENTO);
       update tdvadm.T_ARM_CARREGAMENTO c
         set c.FCF_VEICULODISP_CODIGO = vCodVeicVirtual,
             c.fcf_veiculodisp_sequencia = 0
       WHERE c.ARM_CARREGAMENTO_CODIGO = P_ARM_CARREGAMENTO;
       tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Estava sem Veiculo Virtual';
       P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
    End If;
    
    
    -- paga os parametros para uso
    if Not glbadm.pkg_listas.fn_get_usuparamtros('carreg',
                                                 P_USU_USUARIOCRIA,
                                                 ListaVaux.cnArmazemRota,
                                                 plistaparams) Then
                                    
       tpLogGeracaO.Con_Loggeracao_ErroHTML := 'ERRO AO BUSCAR OS PARAMETROS';
       P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
    End if ;                                 
    

    begin
       if plistaparams('ACESSOINTERNET').texto = 'TDP' Then
          BcoTDXAtivo := 'N';
       ElsIf plistaparams('ACESSOINTERNET').texto = 'TDX' Then
          BcoTDXAtivo := 'S';
       Else
          BcoTDXAtivo := 'N';
       End If;      
    exception
      When NO_DATA_FOUND Then 
         BcoTDXAtivo := 'N';
      End ;


    begin
       vPesagemObrigatoria := plistaparams('PESAGEMOBRIGATORIA').texto;
    exception
      When NO_DATA_FOUND Then 
         vPesagemObrigatoria := 'S';
      End ;

    begin
       vPesominimo := plistaparams('PESAGEMPESOMINIMO').NUMERICO1;
    exception
      When NO_DATA_FOUND Then 
         vPesominimo := 1;
      End ;
      
      
      

     if vPesagemObrigatoria = 'S' Then 
        Select max(nvl(fb.glb_filialbalanca_capacidade,0)),
               count(*)
          into vPesagemMaximo,
               vAuxiliar
        from TDVADM.T_glb_filialbalanca fb
        where fb.glb_rota_codigo  = ListaVaux.cnArmazemRota
          and fb.glb_filialbalanca_ativa = 'S';   
        if vAuxiliar > 0 Then
          if nvl(vPesagemMaximo,0) = 0 then 
            tpLogGeracaO.Con_Loggeracao_ErroHTML := 'BALANCA SEM CAPACIDADE DEFINIDA' ;
            P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
            vPesagemMaximo := vPesominimo;
          End if;   
          Else
            -- Se Nao Tem Balanca faz o manximo = ao minimo
            vPesagemMaximo := vPesominimo;
          End if;
          If nvl(Listacargacli.ccLimitePesagem,0) > 0 Then
             If ( nvl(Listacargacli.ccLimitePesagem,0) > 0 ) and 
                ( nvl(Listacargacli.ccLimitePesagem,0) <  vPesagemMaximo ) Then
                vPesagemMaximo := nvl(Listacargacli.ccLimitePesagem,0);
             End If;
          End If;
          
     Else
        vPesagemMaximo := vPesominimo;
     End if;
     
     if ListaNotas.cnCodMercadoria = '06' Then
        vPesagemObrigatoria := 'N' ;
     End If;

     if  ( vPesagemObrigatoria = 'N' ) or  ( ListaNotas.cnPESO > vPesagemMaximo )  Then 
        V_PESAGEM  := ListaNotas.cnPESO;
     Else
        tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Rota Travada PESO MINIMO -> ' || to_char(vPesominimo)  || ' Peso MAXIMO ' || to_char(vPesagemMaximo) ;
        vAuxiliarchar := fn_InsereLogGeracao;
     End if;   
     
      
    --ESTA PROCEDURE E RODADA PARA VERIFICAR SUJEIRAS DA NOTA OU SE O CONHEC E DE TRANSFERENCIA
   
       sp_trata_goodyear(P_ARM_CARREGAMENTO, vErro, vMessage);
         
       sp_verifica_notas(P_ARM_CARREGAMENTO);


    -- INICIALIZA O VALOR TOTAL DE MERCADORIA
    V_SOMAMERCADORIA := 0;
    
    -- INICIALIZA OS PESOS
    V_SOMAPESOBALANCA := 0;
    V_SOMAPESOCOBRADO := 0;
    V_SOMAPESOREAL    := 0;


    SELECT Max(nvl(lg.con_loggeracao_codigo,0))
      INTO tpLogGeracao.Con_Loggeracao_Codigo
      FROM TDVADM.T_CON_LOGGERACAO LG
     WHERE LG.ARM_CARREGAMENTO_CODIGO = P_ARM_CARREGAMENTO;
     

    /**************************************INICIO***************************************/
    /***************************INSERINDO NA TABELA DE HISTORICO************************/
    /***********************************************************************************/
    --TABELA CRIADA PARA ANALISARMOS A HORA E QUANTAS VEZES EST?O TENTANDO FECHAR UM CARREGAMENTO

    tpCarragamentoHist.Arm_Carregamento_Codigo     := P_ARM_CARREGAMENTO;
    tpCarragamentoHist.Arm_Carregamento_Hist_Obs   := 'FECHANDO UM CARREGAMENTO'  || to_char(Sysdate, 'dd/mm/yyyy hh24:mi:ss');
    tpCarragamentoHist.Arm_Armazem_Codigo          := P_ARM_ARMAZEM;
    tpCarragamentoHist.Arm_Carregamento_Hist_Data  := sysdate;
    tpCarragamentoHist.Arm_Estagiocarregmob_Codigo := 'F';

    SELECT TRIM('MAQUINA:' || trim(upper(v.terminal)) || ' USUARIO:' || trim(upper(v.os_user )) || 'TDV:'|| trim(P_USU_USUARIOCRIA)) MAQUINA
      into tpCarragamentoHist.Usu_Usuario_Codigo
    FROM TDVADM.v_glb_ambiente v;

    select count(*) + 1
      into tpCarragamentoHist.Arm_Carregamento_Hist_Seq
    from TDVADM.T_ARM_CARREGAMENTO_HIST h
    where h.arm_carregamento_codigo = P_ARM_CARREGAMENTO;
    
    INSERT INTO TDVADM.T_ARM_CARREGAMENTO_HIST
    VALUES tpCarragamentoHist;
    commit;
       
    /**************************************FIM***************************************/
    /***************************INSERINDO NA TABELA DE HISTORICO************************/
    /***********************************************************************************/

    tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'INICIO DA PROCEDURE LIMPEI O LOG ANTERIOR - ' || TO_CHAR(V_CONTADORNOTA);
    vAuxiliarchar := fn_InsereLogGeracao;

   
    -- LIMPANDO LOG DE GERAC?O DO CARREGAMENTO E ZERA O CODIGO

    spi_SqlArmazemCarreg(P_ARM_ARMAZEM,P_ARM_CARREGAMENTO);
    spi_SqlFixos;


   -- ENTROU POR CAUSA DO NO CONCEITO DE PRODUTO QUIMICO (FICHA DE EMERGENCIA)
  -- V_SQLNOTAS := V_SQLNOTAS || ' FE.ARM_NOTAFICHAEMERG_CODCLI,';
  -- V_SQLNOTAS := V_SQLNOTAS || ' FE.GLB_ONUCLASCLI_CODIGO ';


    -- CONTADOR DE CONHECIMENTOS
    V_CONTADORCTRC := 0;
    V_CONTADORNOTA := 0;
    -- MONTANDO O SQL DE SACADO
    ListaSQL.FINALSAC := ListaSQL.SACADOS || 
                         ListaSQL.TABWHERE || 
                         ListaSQL.SEMCTRouDR ||
--                         ListaSQL.SEMCTRC || 
                         ListaSQL.SACADOSGB;
    --    P_RETORNO := V_SQLFINALSAC;
    V_CONTADORCTRC         := length(trim(ListaSQL.FINALSAC));
    V_CONTADORCTRC         := 0;
    vTesteCarga.vRetorna   := 'N';


    If trim(sys_context('CARREGAMENTO','CODCARREG')) = trim(P_ARM_CARREGAMENTO) Then
       vContextCount := vContextCount + 1; 
       Insert Into TDVADM.T_glb_sql ( glb_sql_instrucao, 
                               glb_sql_dtgravacao, 
                               glb_sql_programa) 
                      Values ( ListaSQL.FINALSAC, 
                               Sysdate, 
                               lpad(vContextCount,3,'0') || '-' || P_ARM_CARREGAMENTO || '-Cursor=Sacado carregamento=' || P_ARM_CARREGAMENTO || 'TpCarga=' || ListaCargaCli.ccTPCARGACLI  || ' Retorna = ' || vTesteCarga.vRetorna  || ' Vez ' || to_char(tpLogGeracao.Con_Loggeracao_Codigo)||P_USU_USUARIOCRIA); 
       Commit;
    End If;  
    -- inicializacao as notas com erro
    V_NOTASCOMERRO := '';
    
    -- CONTA QUANTAS NOTAS SER?O PORCESSADAS

    -- WHERE USADO PARA CONTAR NOTAS COM CTRC 

    V_CONTADORNOTA := 0;
    ListaSQL.FINALNOTA := ListaSQL.CONTANOTA || 
                          ListaSQL.TABWHERE || 
                          ListaSQL.CTNOTAWHERECC;
    EXECUTE IMMEDIATE (TRIM(ListaSQL.FINALNOTA))
      INTO v_CTRCIMPRESSO;

    If trim(sys_context('CARREGAMENTO','CODCARREG')) = trim(P_ARM_CARREGAMENTO) Then
       vContextCount := vContextCount + 1; 
       Insert Into TDVADM.T_glb_sql ( glb_sql_instrucao, 
                               glb_sql_dtgravacao, 
                               glb_sql_programa) 
                      Values ( ListaSQL.FINALNOTA, 
                               Sysdate, 
                               lpad(vContextCount,3,'0') || '-' || P_ARM_CARREGAMENTO || '-Cursor=Notas ComCTe=' || P_ARM_CARREGAMENTO || 'TpCarga=' || ListaCargaCli.ccTPCARGACLI  || ' Retorna = ' || vTesteCarga.vRetorna  || ' Vez ' || to_char(tpLogGeracao.Con_Loggeracao_Codigo)||P_USU_USUARIOCRIA); 
       Commit;
    End If;  
    tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'INICIO DA ROTINA QUANTIDADE DE NOTAS COM CTRC - ' || TO_CHAR(v_CTRCIMPRESSO);
    tpLogGeracao.Con_Loggeracao_Sql := ListaSQL.FINALNOTA;
    vAuxiliarchar := fn_InsereLogGeracao;

    V_CONTADORNOTA := 0;
    ListaSQL.FINALNOTA := ListaSQL.CONTANOTA || 
                          ListaSQL.TABWHERE || 
                          ListaSQL.CTNOTAWHERESC;
    EXECUTE IMMEDIATE (TRIM(ListaSQL.FINALNOTA))
      INTO V_CONTADORNOTA;
    
    tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'INICIO DA ROTINA QUANTIDADE DE NOTAS SEM CTRC - ' || TO_CHAR(V_CONTADORNOTA);
    tpLogGeracao.Con_Loggeracao_Sql := ListaSQL.FINALNOTA;
    vAuxiliarchar := fn_InsereLogGeracao;

    If trim(sys_context('CARREGAMENTO','CODCARREG')) = trim(P_ARM_CARREGAMENTO) Then
       vContextCount := vContextCount + 1; 
       Insert Into TDVADM.T_glb_sql ( glb_sql_instrucao, 
                               glb_sql_dtgravacao, 
                               glb_sql_programa) 
                      Values ( ListaSQL.FINALNOTA, 
                               Sysdate, 
                               lpad(vContextCount,3,'0') || '-' || P_ARM_CARREGAMENTO || '-Cursor=Notas SemCTe=' || P_ARM_CARREGAMENTO || 'TpCarga=' || ListaCargaCli.ccTPCARGACLI  || ' Retorna = ' || vTesteCarga.vRetorna  || ' Vez ' || to_char(tpLogGeracao.Con_Loggeracao_Codigo)||P_USU_USUARIOCRIA); 
       Commit;
    End If;  


    IF /*(v_CTRCIMPRESSO = 0) AND*/ (V_CONTADORNOTA = 0) THEN 
       tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'FAVOR VERIFICAR O CARREGAMENTO, Nao HA NOTAS IDENTIFICADAS NELE SEM CONHECIMENTO. E OBRIGATORIO TER UMA NOTA SEM CONHECIMENTO';
       vAuxiliarchar := fn_InsereLogGeracao;
--       RAISE_APPLICATION_ERROR(-20003,'*****************************************************************' || chr(13) ||
--                                      'E OBRIGATORIO TER PELO MENOS UMA NOTA SEM CONHECIMENTO DO ARMAZEM' || chr(13) ||
--                                      '*****************************************************************' || chr(13) );
    END IF;
        
    v_classificaerro := '';

    if ( V_CONTADORNOTA = 0 ) AND ( v_CTRCIMPRESSO = 0 ) Then
       tpLogGeracaO.Con_Loggeracao_ErroHTML := 'OCORREU ALGUM PROBLEMA Nao CONSEGUI ACHAR NENHUMA NOTA '|| chr(10) ;
       P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
    End If;


    ListaSQL.FINALNOTA := ListaSQL.NOTAS || 
                          ListaSQL.TABWHERE;
                          
    tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'ABRINDO CURSOR DE NOTAS PARA VERIFICAR REGRAS';
    tpLogGeracao.Con_Loggeracao_Sql := ListaSQL.FINALNOTA;
    vAuxiliarchar := fn_InsereLogGeracao;
    commit;
           
    ListaVaux.cnArmazem := P_ARM_ARMAZEM;
    -- Acertando as localidade e Cargas das NOTAS SEM CONHECIMENTO
    -- Verifica Grande Fluxo das Aguas

    OPEN cNOTAS FOR ListaSQL.FINALNOTA;
    Loop
       fetch cNOTAS
         into ListaNotas;
       Exit When cnotas%Notfound;
        
          vAuxiliarnumerico := 0;
          
          Begin
             select jc.arm_janelacons_qtdectenfs
               into vAuxiliarnumerico
             from tdvadm.t_arm_janelacons jc
             where jc.arm_janelacons_sequencia = ListaNotas.cnJanelaCons_Seq;
               
          exception
            When NO_DATA_FOUND Then
                vAuxiliarnumerico := 0;
            End;
          If ListaNotas.cnConhecimento  is not null then
             vAuxiliarnumerico := vAuxiliarnumerico + 1;
          End If;   


/* Para bloquear geracao de CTe
          If  ListaNotas.cnGRUPOECSAC = '0020' then
              vErroFatal := 'E';
              tpLogGeracao.Con_Loggeracao_ErroHTML := 'F- EMISSAO BLOQUEADA PARA A VALE' || chr(10) ;
              P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
          End If;
*/
          If (vAuxiliarnumerico = 0) Then
             pkg_slf_contrato.SP_SETPARTCONTRATO(ListaNotas.cnNOTA,
                                                  ListaNotas.cnCLIREM,
                                                  ListaNotas.cnSERIENF,
                                                  vStatus,
                                                  vMessage);
               If vStatus = 'E' Then
                  tpLogGeracao.Con_Loggeracao_Errohtml := vMessage;
                  P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
               End If;
          End If;
     end Loop;
     commit;

 
    OPEN cNOTAS FOR ListaSQL.FINALNOTA;
    Loop
       fetch cNOTAS
         into ListaNotas;
       Exit When cnotas%Notfound;
        
          vAuxiliarnumerico := 0;
          
          Begin
             select jc.arm_janelacons_qtdectenfs
               into vAuxiliarnumerico
             from tdvadm.t_arm_janelacons jc
             where jc.arm_janelacons_sequencia = ListaNotas.cnJanelaCons_Seq;
               
          exception
            When NO_DATA_FOUND Then
                vAuxiliarnumerico := 0;
            End;
          If ListaNotas.cnConhecimento  is not null then
             vAuxiliarnumerico := vAuxiliarnumerico + 1;
          End If;   


/* Para bloquear geracao de CTe
          If  ListaNotas.cnGRUPOECSAC = '0020' then
              vErroFatal := 'E';
              tpLogGeracao.Con_Loggeracao_ErroHTML := 'F- EMISSAO BLOQUEADA PARA A VALE' || chr(10) ;
              P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
          End If;
*/
          If (vAuxiliarnumerico = 0) Then
             pkg_slf_contrato.SP_SETPARTCONTRATO(ListaNotas.cnNOTA,
                                                  ListaNotas.cnCLIREM,
                                                  ListaNotas.cnSERIENF,
                                                  vStatus,
                                                  vMessage);
               If vStatus = 'E' Then
                  tpLogGeracao.Con_Loggeracao_Errohtml := vMessage;
                  P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
               End If;
          End If;
          
/*          If ListaNotas.cnPESOBAL <> nvl(ListaNotas.cnPesoClienteInf,ListaNotas.cnPESOBAL) Then

             tpLogGeracao.Con_Loggeracao_Errohtml := 'Nota ' || ListaNotas.cnNOTA || '-' || ListaNotas.cnNOTA || ' Peso informado ao Cliente ' || nvl(ListaNotas.cnPesoClienteInf,ListaNotas.cnPESOBAL) || ' - Peso Atual ' || ListaNotas.cnPESOBAL || chr(10);
             P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
            
          End If;*/
          
          pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring :=  ListaNotas.cnCOLETA;

          -- VERIFICANDO SE EXISTE NOTAS FILHAS FORA DO CARREGAMENTO
          
          FOR C_MSG IN (select a.arm_armazem_codigo,
                               a.arm_nota_dtinclusao,
                               a.arm_nota_vide flagvidenota,
                               a.Arm_Nota_Sequencia sequenciafilha,
                               a.arm_nota_numero numerofilha,
                               a.glb_cliente_cgccpfremetente remetfilha,
                               a.glb_tpcliend_codremetente Glb_Tpcliend_Codigofilha,
                               a.arm_nota_serie srfilha,
                               a.arm_embalagem_numero,
                               a.arm_embalagem_flag,
                               a.arm_embalagem_sequencia,
                               a.glb_cliente_cgccpfdestinatario,
                               a.Glb_Tpcliend_Coddestinatario
                        from tdvadm.t_arm_nota a
                                                      -- PEGA TODAS AS SEQUENCIAS DAS FILHAS 
                        where a.arm_nota_sequencia in (select nv.arm_notavide_sequencia
                                                       from tdvadm.t_arm_notavide nv
                                                       where nv.arm_nota_numero = ListaNotas.cnNOTA
                                                         and trim(nv.arm_notavide_cgccpfremetente) = trim(ListaNotas.cnCLIREM)
                                                         and nv.arm_nota_serie = ListaNotas.cnSERIENF
                                                       )
                          -- NOTA NAO PODE ESTAR EM CARREGAMENTO
                          AND 0 = (SELECT COUNT(*)
                                   FROM TDVADM.T_ARM_CARREGAMENTODET CD
                                   WHERE CD.ARM_EMBALAGEM_NUMERO = A.ARM_EMBALAGEM_NUMERO
                                     AND CD.ARM_EMBALAGEM_FLAG = A.ARM_EMBALAGEM_FLAG
                                     AND CD.ARM_EMBALAGEM_SEQUENCIA = A.ARM_EMBALAGEM_SEQUENCIA)
                          -- PEGO SE FOI FEITO PELA DIGITACAO MANUAL
                          AND 0 = (select count(*)
                                   from tdvadm.t_con_nftransporta nf
                                   where nf.con_nftransportada_numnfiscal = lpad(a.arm_nota_numero,9,'0')
                                     and nf.glb_cliente_cgccpfcodigo = rpad(a.glb_cliente_cgccpfremetente,20)
                                     and nf.con_nftransportada_serienf = triM(a.arm_nota_serie)) )

          LOOP
            
             tpCarregamentodet.Arm_Carregamento_Codigo        := P_ARM_CARREGAMENTO;
             tpCarregamentodet.Arm_Embalagem_Numero           := c_msg.arm_embalagem_numero;
             tpCarregamentodet.Arm_Embalagem_Flag             := c_msg.arm_embalagem_flag;
             tpCarregamentodet.Arm_Embalagem_Sequencia        := c_msg.arm_embalagem_sequencia;
             tpCarregamentodet.Glb_Cliente_Cgccpfdestinatario := c_msg.Glb_Cliente_Cgccpfdestinatario;
             tpCarregamentodet.Glb_Tpcliend_Coddestinatario   := c_msg.Glb_Tpcliend_Coddestinatario;
             tpCarregamentodet.Glb_Cliente_Cgccpfcodigo       := c_msg.remetfilha;
             tpCarregamentodet.Glb_Tpcliend_Codigo            := c_msg.Glb_Tpcliend_Codigofilha;
             tpCarregamentodet.Arm_Carregamentodet_Posveic    := null;
             tpCarregamentodet.Arm_Carregamentodet_Flagtrans  := null;
             tpCarregamentodet.Arm_Armazem_Codigo_Transf      := null;
             tpCarregamentodet.Arm_Carregamentodet_Qtdtransf  := null;
             tpCarregamentodet.Arm_Carregamentodet_Qtdok      := null;
             tpCarregamentodet.Arm_Carregamentodet_Dcheckin   := null;
             tpCarregamentodet.Usu_Usuario_Codigocheckin      := null;
             insert into tdvadm.t_arm_carregamentodet values tpCarregamentodet;
             commit;
          
            
          END LOOP;  

    End Loop;


    vError := '';
    OPEN cNOTAS FOR ListaSQL.FINALNOTA;
    loop
       fetch cNOTAS
         into ListaNotas;
       Exit When cnotas%Notfound;
        
          If ( ListaNotas.cnConhecimento is null ) and 
             ( substr(ListaNotas.cnTABSOLCOD,1,3) = '021' ) and 
             ( ListaNotas.cnTABSOL = 'T' ) Then

             update tdvadm.t_arm_nota an
               set an.arm_nota_tabsolcod = null,
                   an.arm_nota_tabsolsq = null,
                   an.arm_nota_tabsol = null
             where an.arm_nota_sequencia = ListaNotas.cnSequencia;
          
          End If;
          
          -- NJ?o se sabe porque mais alguma rotina esta zerando o CFOP
          If ( ListaNotas.cnCFOP is null ) or ( length(trim(ListaNotas.cnCFOP)) < 4 ) Then
               tpLogGeracao.Arm_Nota_Numero := ListaNotas.cnNOTA;
               tpLogGeracao.Glb_Cliente_Cgccpfremetente := ListaNotas.cnCLIREM;
               tpLogGeracao.Con_Loggeracao_Errohtml := 'Nota SEM CFOP ou CFOP Invalido';
               P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
          End If;

 /* retirado em 30/05/2016          
        IF ListaNotas.cnConhecimento IS NULL Then      
           if ( ListaNotas.cnEntregaCol = 'C' ) and ( nvl(ListaNotas.cnINCOTERMS,'FCA') = 'FCA' ) and ( ListaNotas.cnASN is not null )  Then


                            select count(*)
                              into vAuxiliarnumerico
                            From TDVADM.T_xml_clientelib cl,
                                 TDVADM.T_XML_COLETAPARCEIRO CP,
                                 TDVADM.T_XML_COLETA CX
                            where CX.ARM_COLETA_NCOMPRA = ListaNotas.cnNRCOLETA
                              AND CX.ARM_COLETA_CICLO = ListaNotas.cnNrColetaCiclo
                              and cl.xml_clientelib_ativo = 'S'
                              and ( cl.xml_clientelib_flagporto = 'S' or cl.xml_clientelib_flagaeroporto = 'S' )
                              AND CX.XML_COLETA_NUMERO = CP.XML_COLETA_NUMERO
                              AND CX.XML_COLETA_TIPOCOLETA = CP.XML_TIPOPARCEIRO_CODIGO
                              AND CX.XML_COLETA_TIPODOC = CP.XML_COLETA_TIPODOC
                              AND CX.XML_COLETA_SEQUENCIA = CP.XML_COLETA_SEQUENCIA
                              and cl.glb_cliente_cgccpfcodigo = RPAD(CP.XML_COLETAPARCEIRO_CNPJ,20)
                              AND CP.XML_TIPOPARCEIRO_CODIGO = 'OR'
                              AND CP.XML_COLETA_TIPODOC = 'ASN'
--                              and cl.fcf_tpcarga_codigo = ListaCargaCli.ccTPCARGACLIPESQ
-- Alterado em 09/10/2015 Sirlano
--                              and trim(cl.glb_localidade_codigoori) = trim(decode(trim(cl.glb_localidade_codigoori),'99999','99999',tdvadm.fn_busca_codigoibge1(ListaNotas.cnORIGEM,cl.xml_clientelib_tpcodori)))
--                              and trim(cl.glb_localidade_codigodes) = trim(decode(trim(cl.glb_localidade_codigodes),'99999','99999',tdvadm.fn_busca_codigoibge1(ListaNotas.cnDESTINO,cl.xml_clientelib_tpcoddes)))
                              and trim(cl.glb_localidade_codigoori) = trim(decode(trim(cl.glb_localidade_codigoori),'99999','99999',tdvadm.fn_busca_codigoibge1(ListaNotas.cnCOLETA,cl.xml_clientelib_tpcodori)))
                              and trim(cl.glb_localidade_codigodes) = trim(decode(trim(cl.glb_localidade_codigodes),'99999','99999',tdvadm.fn_busca_codigoibge1(ListaNotas.cnENTREGA,cl.xml_clientelib_tpcoddes)))
                              and cl.xml_clientelib_dtvigencia = (select max(cl1.xml_clientelib_dtvigencia)
                                                                  from TDVADM.T_xml_clientelib cl1
                                                                  where cl1.glb_cliente_cgccpfcodigo     = cl.glb_cliente_cgccpfcodigo
                                                                    and cl1.xml_clientelib_ativo         = cl.xml_clientelib_ativo
                                                                    and cl1.xml_clientelib_flagporto     = cl.xml_clientelib_flagporto
                                                                    and cl1.xml_clientelib_flaggf        = cl.xml_clientelib_flaggf
                                                                    and cl1.xml_clientelib_flagaeroporto = cl.xml_clientelib_flagaeroporto
                                                                    and cl1.glb_localidade_codigoori     = cl.glb_localidade_codigoori
                                                                    and cl1.xml_clientelib_tpcodori      = cl.xml_clientelib_tpcodori
                                                                    and cl1.glb_localidade_codigodes     = cl.glb_localidade_codigodes
                                                                    and cl1.xml_clientelib_tpcoddes      = cl.xml_clientelib_tpcoddes
                                                                    and cl1.fcf_tpcarga_codigo           = cl.fcf_tpcarga_codigo);





              If vAuxiliarnumerico =  0 and P_ARM_ARMAZEM not in ('15','08') Then 
                  tpLogGeracaO.Con_Loggeracao_ErroHTML := 'VALE Informou ENTREGA de Mercadoria. E NOSSA Coleta esta como IR BUSCAR NO CLIENTE'  || chr(10) || 
                                                          'Coleta    ' || ListaNotas.cnNRCOLETA || chr(10) ||
                                                          'Coleta TP ' || ListaNotas.cnEntregaCol || chr(10) ||
                                                          'ASN       ' || ListaNotas.cnASN || chr(10) ||
                                                          'INCOTERM  ' || ListaNotas.cnINCOTERMS || chr(10);
                  tpLogGeracao.Arm_Nota_Numero :=   ListaNotas.cnNOTA;
                  tpLogGeracao.Glb_Cliente_Cgccpfremetente := trim(ListaNotas.cnCLIREM);
                  P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
              End If;
           End If;
           if ( ListaNotas.cnEntregaCol = 'E' ) and ( nvl(ListaNotas.cnINCOTERMS,'FCA') <> 'FCA' ) and ( ListaNotas.cnASN is not null )  Then
              tpLogGeracaO.Con_Loggeracao_ErroHTML := 'VALE Solicitou para COLETAR Mercadoria. ASN Nao e do TIPO FCA ' || chr(10) || 
                                                      'Coleta    ' || ListaNotas.cnNRCOLETA || chr(10) ||
                                                      'Coleta TP ' || ListaNotas.cnEntregaCol || chr(10) ||
                                                      'ASN       ' || ListaNotas.cnASN || chr(10) ||
                                                      'INCOTERM  ' || ListaNotas.cnINCOTERMS || chr(10);
              tpLogGeracao.Arm_Nota_Numero     :=   ListaNotas.cnNOTA;
              tpLogGeracao.Glb_Cliente_Cgccpfremetente := trim(ListaNotas.cnCLIREM);
              P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
           End If;
        End If;
*/

    End Loop; 

    tpLogGeracao.Arm_Nota_Numero := null;
    tpLogGeracao.Glb_Cliente_Cgccpfremetente := null;

    If vErroFatal = 'E' Then
       tpLogGeracaO.Con_Loggeracao_ErroHTML := 'F-' || vError || chr(10) ;
       P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
    End If;
    commit;

    if P_RETORNOPROCESSAMENTO = 'E' Then
       return;
    End If;
    

    OPEN cSACADO FOR TRIM(ListaSQL.FINALSAC);

    tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'ABRI CURSOR DE SACADO ';
    tpLogGeracao. Con_Loggeracao_Sql := ListaSQL.FINALSAC;
    vAuxiliarchar := fn_InsereLogGeracao;
    COMMIT;
    
    loop
      fetch cSACADO
        into ListaQuebras;
      exit when cSACADO%notfound;

      vSemCOmparacaoEnviaEmail := 'S';
      
      if ListaQuebras.CNPJDES = '06107062000183' Then
         ListaQuebras.CNPJDES := ListaQuebras.CNPJDES;
      End If;

      IF ListaQuebras.CLISAC IS NULL Then
         tpLogGeracaO.Con_Loggeracao_ErroHTML := 'SACADO NAO ENCONTRADO PARA O DESTINATARIO - ' || ListaQuebras.CNPJDES || ' TIPO DE ENDERECO - ' || ListaQuebras.CLIENDDES || chr(10) ||
                                             'CONSULTE NO CADASTRO DE CLIENTES PARA VERIFICAR ' || chr(10);
         P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
         v_classificaerro       := trim(v_classificaerro) || 'S';
         V_ACHOUSACADO          := 'N';
      ELSE
        V_ACHOUSACADO := 'S';
      END IF;
      
      If trunc(sysdate) = '28/08/2018' Then
         If to_char(sysdate,'HH24') < 16 Then
            If ListaQuebras.GRUPOEC = '0020' Then
               tpLogGeracaO.Con_Loggeracao_ErroHTML := 'EMISSAO DE CTe para a VALE esta Bloqueada' ||  chr(10);
               P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
              vErroFatal := 'E';
            End If;
         End If;
      End If;
      

      spi_SqlCliEnvolvidos(ListaQuebras);
      spi_SqlColetaEntrega(ListaQuebras.ORIGEMNOTA,ListaQuebras.DESTINONOTA,ListaCargaCli);

      IF P_RETORNOPROCESSAMENTO = 'N' THEN
        -- PEGA COMO SERA PESQUISADO O CLIENTE
        V_VERTPCARGAS := TDVADM.PKG_slf_contrato.FN_SLF_CLIENTEREGRACARGA(ListaQuebras.CLISAC, ListaQuebras.CONTRATO);
        IF V_VERTPCARGAS = 'GCT' THEN -- ACHOU POR GRUPO/CNPJ/CONTRADO
          V_SACADOCARGA    := ListaQuebras.CLISAC;
          V_GRUPOCARGAS    := ListaQuebras.GRUPOEC;
          V_CONTRATOCARGAS := ListaQuebras.CONTRATO;
        ELSIF V_VERTPCARGAS = 'GC' THEN -- ACHOU POR GRUPO/CNPJ
          V_SACADOCARGA    := ListaQuebras.CLISAC;
          V_GRUPOCARGAS    := ListaQuebras.GRUPOEC;
          V_CONTRATOCARGAS := QualquerContrato;
        ELSIF V_VERTPCARGAS = 'GT' THEN -- ACHOU GRUPO/CONTRATO
          V_SACADOCARGA    := QualquerCliente;
          V_GRUPOCARGAS    := ListaQuebras.GRUPOEC;
          V_CONTRATOCARGAS := ListaQuebras.CONTRATO;
        ELSIF V_VERTPCARGAS = 'G' THEN --ACHOU POR GRUPO
          V_SACADOCARGA    := QualquerCliente;
          V_GRUPOCARGAS    := ListaQuebras.GRUPOEC;
          V_CONTRATOCARGAS := QualquerContrato;
        ELSIF V_VERTPCARGAS = 'C' THEN --ACHOU POR CLIENTE
          V_SACADOCARGA    := ListaQuebras.CLISAC;
          V_GRUPOCARGAS    := QualquerGrupo;
          V_CONTRATOCARGAS := QualquerContrato;
        ELSIF V_VERTPCARGAS = 'T' THEN --ACHOU POR CONTRATO
          V_SACADOCARGA    := QualquerCliente;
          V_GRUPOCARGAS    := QualquerGrupo;
          V_CONTRATOCARGAS := ListaQuebras.CONTRATO;
        ELSIF V_VERTPCARGAS = 'QQQ' THEN --POR QUALQUER COISA
          V_SACADOCARGA    := QualquerCliente;
          V_GRUPOCARGAS    := QualquerGrupo;
          V_CONTRATOCARGAS := QualquerContrato;
        ELSE
          V_SACADOCARGA    := QualquerCliente;
          V_GRUPOCARGAS    := QualquerGrupo;
          V_CONTRATOCARGAS := QualquerContrato;
        END IF;
    
      -------------Victor e Sirlano-----------------
      ---------Alterado dia 23/09/2019--------------
      ----Verificar as regras de arredoindamento----
      Begin
          select cr.slf_clienteregras_pbarrend,
                 cr.slf_clienteregras_pbdecgramas
             into vPbArrend,
                  vPbDecGramas         
          from tdvadm.t_slf_clienteregras cr
          where cr.glb_grupoeconomico_codigo = V_GRUPOCARGAS
            and cr.glb_cliente_cgccpfcodigo = V_SACADOCARGA
            and cr.slf_contrato_codigo = V_CONTRATOCARGAS
            and cr.slf_clienteregras_ativo = 'S'
            and cr.slf_clienteregras_vigencia = ( Select Max(cr1.slf_clienteregras_vigencia)
                                                  from tdvadm.t_slf_clienteregras cr1
                                                  where cr1.glb_grupoeconomico_codigo = cr.glb_grupoeconomico_codigo
                                                    and cr1.glb_cliente_cgccpfcodigo = cr.glb_cliente_cgccpfcodigo
                                                    and cr1.slf_contrato_codigo = cr.slf_contrato_codigo
                                                    and cr1.slf_clienteregras_ativo = cr.slf_clienteregras_ativo);            
       Exception
         when NO_DATA_FOUND Then
           vPbArrend    := 'S';
           vPbDecGramas := 0;
         End;  
         
        spi_SqlSacGrupoContrato(V_SACADOCARGA,V_GRUPOCARGAS,V_CONTRATOCARGAS);

         tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'PROCURANDO REGRA PARA CLIENTE  - ' || chr(10) ||
                                                   ' GRUPO EC - ' || V_GRUPOCARGAS || chr(10) ||
                                                   ' SACADO - ' || V_SACADOCARGA || chr(10) || 
                                                   ' CONTRATO - ' || V_CONTRATOCARGAS;
         vAuxiliarchar := fn_InsereLogGeracao;

        
-- MUDEI PARA CA HOJE 24/03/2014 ERA MAIS EMBAIXO

        If trim(sys_context('CARREGAMENTO','CODCARREG')) = trim(P_ARM_CARREGAMENTO) Then
           vContextCount := vContextCount + 1; 
           Insert Into TDVADM.T_glb_sql ( glb_sql_instrucao, 
                                   glb_sql_dtgravacao, 
                                   glb_sql_programa) 
                          Values ( ListaSQL.FINALCARG, 
                                   Sysdate, 
                                   lpad(vContextCount,3,'0') || '-' || P_ARM_CARREGAMENTO || '-Cursor=Cargas carregamento=' || P_ARM_CARREGAMENTO || 'TpCarga=' || ListaCargaCli.ccTPCARGACLI  || ' Retorna = ' || vTesteCarga.vRetorna  || ' Vez ' || to_char(tpLogGeracao.Con_Loggeracao_Codigo)||P_USU_USUARIOCRIA); 
          Commit;
        End If;  

        
        -- Crio uma Lista com todas os Tipos de Carga
        -- Para esta regra.
        tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'ABRI CURSOR DE CARGAS ';
        tpLogGeracao. Con_Loggeracao_Sql := ListaSQL.FINALCARG;
        vAuxiliarchar := fn_InsereLogGeracao;

        OPEN cCARGAS FOR ListaSQL.FINALCARG;
        FETCH cCARGAS
        BULK COLLECT INTO BListaCargaCli;
        CLOSE cCARGAS; 
        vIdCarga := 0;
        LOOP
          vIdCarga := vIdCarga + 1;
          Begin
             ListaCargaCli := BListaCargaCli(vIdCarga);
          exception
            When NO_DATA_FOUND Then
                exit;
            End;   
          ListaVaux.cnPercentEx   := ListaCargaCli.ccPERCTEX;
          ListaVaux.cnPercentQP   := ListaCargaCli.ccPERCTQM;
          ListaQuebras.ccTPRATEIO := nvl( ListaCargaCli.ccTPRATEIO,'02');
          ListaQuebras.ccTPAGRUPA := nvl( ListaCargaCli.ccTPAGRUPA,'02');

          -- Liga Tipo de Agrupamentos 
          ListaAgrupaCli := fn_RetornaAgrupamento(ListaQuebras.ccTPAGRUPA);

          If ( ListaQuebras.TABSOLCOD <> SemTabelaCodigo ) and 
             ( ListaCargaCli.ccTPCARGACLI not in ('13','14')) Then
             -- Usa Modo Antigo
             ListaCargaCli.ccTPCARGACLIPESQ := '00';
             ListaCargaCli.ccTPCARGACLI     := '00';
          End If;

          if ListaVaux.cnTemCD = 'S' Then
--             ListaCargaCli.ccRATEIA := 'N';
             ListaCargaCli.ccColetaCobra := 'N';
          End If;
          
          

          If ( nvl(ListaCargaCli.ccColetaCobra,'N') = 'S' )  and  
             ( nvl(ListaCargaCli.ccMudaOrigemCC,'S') = 'S' ) and
             ( nvl(ListaNotas.cnTABSOLCOD,SemTabelaCodigo) = SemTabelaCodigo ) Then
             vAuxiliarT := trim(fn_RetLocalidadeArmazem(P_ARM_ARMAZEM));
             Begin
             If pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring is null Then
                pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring := ListaNotas.cnCOLETA;
             End If;
             exception
               When NO_DATA_FOUND Then
                  pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring := ListaNotas.cnCOLETA;
               End;
             ListaNotas.cnCOLETA := vAuxiliarT;
             update TDVADM.T_arm_nota an
               set an.arm_nota_localcoletal = vAuxiliarT,
                   an.arm_nota_localcoletai = tdvadm.fn_busca_codigoibge(vAuxiliarT,'IBC')
             where 0 = 0
               and (an.arm_embalagem_numero,an.arm_embalagem_flag,an.arm_embalagem_sequencia) in (select cd.arm_embalagem_numero,cd.arm_embalagem_flag,cd.arm_embalagem_sequencia
                                                                                                 from TDVADM.T_arm_carregamentodet cd
                                                                                                 where cd.arm_carregamento_codigo = P_ARM_CARREGAMENTO)
               and an.con_conhecimento_codigo is null
                -- Diferente de Coleta CO e Carga Direta CD

               and an.glb_tpcarga_codigo not in ('CD','CO');
              if sql%rowcount > 0 Then
                ListaNotas.cnCOLETA := vAuxiliarT;
                ListaQuebras.ORIGEMNOTA := vAuxiliarT;
              End If;
          Else
             -- Se cabra coleta for igual a N e Muda Origem = N
             -- Se a localidade for diferente, volta a original
             IF ( trim(ListaNotas.cnCOLETA) <> trim(nvl(pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring,ListaNotas.cnCOLETA)) ) Then
                ListaNotas.cnCOLETA     := trim(pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring);
                ListaQuebras.ORIGEMNOTA := trim(pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring);
                
                ---------Rafael, Klayton e Sirlano------------
                ---------Alterado dia 08/05/2019--------------
                ------Devido origem incorreta da Vale---------
                
               if (ListaNotas.cnGRUPOECSAC <> '0020') then
                
                      update TDVADM.T_arm_nota an
                        set an.arm_nota_localcoletal = pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring,
                            an.arm_nota_localcoletai = tdvadm.fn_busca_codigoibge(pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring,'IBC')
                      where 0 = 0
                        and (an.arm_embalagem_numero,an.arm_embalagem_flag,an.arm_embalagem_sequencia) in (select cd.arm_embalagem_numero,cd.arm_embalagem_flag,cd.arm_embalagem_sequencia
                                                                                                           from TDVADM.T_arm_carregamentodet cd
                                                                                                           where cd.arm_carregamento_codigo = P_ARM_CARREGAMENTO)
                        and an.con_conhecimento_codigo is null
                     -- Diferente de Coleta CO e Carga Direta CD
                        and an.glb_tpcarga_codigo not in ('CD','CO');
                  
                end if;
              End If;
          End IF;
          
--          ListaCargaCli.ccRATEIA := nvl(ListaCargaCli.ccRATEIA,'S');
          if ListaCargaCli.ccRATEIA = 'S' Then
             ListaCargaCli.ccRATEIA := 'S';
          Else
             ListaCargaCli.ccRATEIA := 'N';
          End IF;   
         
          spi_SqlArmazemCarreg(P_ARM_ARMAZEM,P_ARM_CARREGAMENTO);
          spi_SqlFixos;


          spi_SqlCliEnvolvidos(ListaQuebras);
          spi_SqlColetaEntrega(ListaQuebras.ORIGEMNOTA,ListaQuebras.DESTINONOTA,ListaCargaCli);
           
          
          tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := fni_retcenarioREGRA(ListaCargaCli);
          vAuxiliarchar :=  fn_InsereLogGeracao;
          
        --VERIFICAR OS TRES ENVOLVIDOS.
        IF TRIM(ListaQuebras.FLAGPGTO) In ('P', 'R') THEN
          V_CIFFOB := 'CIF';
        ELSIF TRIM(ListaQuebras.FLAGPGTO) In ('A', 'D') THEN
          V_CIFFOB := 'FOB';
        ELSE
          V_CIFFOB := 'FOB';
        END IF;
        
         
       tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'GERANDO PARA CLIENTE  - ' || V_CIFFOB || 
                                                   ' GRUPO EC - ' || ListaQuebras.GRUPOEC || 
                                                   ' SACADO - ' || ListaQuebras.CLISAC || ' DEST - ' || ListaQuebras.CNPJDES ||
                                                   ' TPEND - ' || ListaQuebras.CLIENDDES || 
                                                   ' CONTRATO - ' || ListaQuebras.CONTRATO || chr(13) ||
                                                   trim(fni_RetornaTabSol(V_SACADOCARGA,V_GRUPOCARGAS,V_CONTRATOCARGAS));
         vAuxiliarchar := fn_InsereLogGeracao;
         
     
        -- LIMPA VARIAVEL DE NOTAS PROCESSADAS
      
    
    -- MONTA O SQL PARA CONTAR SE EXISTE PRODUTO QUIMICO SE RETORNA > 0 TEM
    -- SELECT PARA PEGAR CARGAS LOTACAO
    IF ListaCargaCli.ccPCOBRANCA = 'PB' THEN -- Peso Balanca
      ListaSQL.CONTAPESO := ' SELECT /*+ LEADING (N) */ nvl(SUM(NVL(N.ARM_NOTA_PESOBALANCA,0)),0) peso, nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) VlrMerc ';
      ListaSQL.CONTAPQ   := ' SELECT NVL(SUM(NVL(N.ARM_NOTA_PESOBALANCA,0)) - MIN(NVL(O.GLB_ONU_KGISENTA,0)),0) PRODUTOQUIMICO, nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) VlrMerc ';
      ListaSQL.CONTAPQ2  := ' SELECT count(*) PRODUTOQUIMICO,nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) VlrMerc  ';
    Elsif ListaCargaCli.ccPCOBRANCA = 'PC' Then -- Peso Cubado
      ListaSQL.CONTAPESO := ' SELECT nvl(SUM(NVL(N.ARM_MOVIMENTO_PESOCUBADO,0)),0) peso, nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) VlrMerc ';
      ListaSQL.CONTAPQ   := ' SELECT NVL(SUM(NVL(N.ARM_MOVIMENTO_PESOCUBADO,0)) - MIN(NVL(O.GLB_ONU_KGISENTA,0)),0) PRODUTOQUIMICO, nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) VlrMerc ';
      ListaSQL.CONTAPQ2  := ' SELECT count(*) PRODUTOQUIMICO,nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) VlrMerc  ';
    Elsif ListaCargaCli.ccPCOBRANCA = 'PR' Then  -- Peso Real
      ListaSQL.CONTAPESO := ' SELECT nvl(SUM(NVL(N.ARM_NOTA_PESO,0)),0) peso, nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) VlrMerc ';
      ListaSQL.CONTAPQ   := ' SELECT NVL(SUM(NVL(N.ARM_NOTA_PESO,0)) - MIN(NVL(O.GLB_ONU_KGISENTA,0)),0) PRODUTOQUIMICO, nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) VlrMerc ';
      ListaSQL.CONTAPQ2  := ' SELECT count(*) PRODUTOQUIMICO,nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) VlrMerc  ';
    Elsif ListaCargaCli.ccPCOBRANCA = 'PT' Then  -- Peso Tara
      ListaSQL.CONTAPESO := ' SELECT nvl(SUM(NVL(N.ARM_NOTA_PESO,0)),0) + nvl(sum(NVL(N.USUARIO_WEB_LOGIN_RI,0)),0) peso, nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) VlrMerc ';
      ListaSQL.CONTAPQ   := ' SELECT NVL(SUM(NVL(N.ARM_NOTA_PESO,0)) + nvl(sum(NVL(n.USUARIO_WEB_LOGIN_RI,0)),0) - MIN(NVL(O.GLB_ONU_KGISENTA,0)),0) PRODUTOQUIMICO, nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) VlrMerc ';
      ListaSQL.CONTAPQ2  := ' SELECT count(*) PRODUTOQUIMICO,nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) VlrMerc  ';

    ElsIf ListaCargaCli.ccPCOBRANCA = 'PE' Then -- Peso Excedente
      if ListaCargaCli.ccBASEOCUPACAO = 'S' Then    
         if nvl(ListaCargaCli.ccVALORBASE,0) <= 0 Then
            tpLogGeracaO.Con_Loggeracao_ErroHTML := 'FAVOR VERIFICAR BASE DE OCUPACAO ' || TO_CHAR(ListaCargaCli.ccVALORBASE);
            P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
         End if;
      End If;
      if ListaCargaCli.ccBASEOCUPACAO = 'S' Then    
         ListaSQL.CONTAPESO  := ' SELECT nvl(SUM(NVL(N.ARM_MOVIMENTO_PESOCUBADO,0.001) * ' || to_char(ListaCargaCli.ccVALORBASE)  || '),0) peso, nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) VlrMerc ';
      Else
         ListaSQL.CONTAPESO  := ' SELECT /*+ LEADING (N) */ nvl(SUM(NVL(N.ARM_NOTA_PESOBALANCA,0.001),0) peso, nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) VlrMerc ';
      End If;         
      ListaSQL.CONTAPESO2 := ' SELECT /*+ LEADING (N) */ nvl(SUM(NVL(N.ARM_NOTA_PESOBALANCA,0.001)),0) peso , nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) VlrMerc ';
          
    Else -- Default Peso Cobrado
      ListaSQL.CONTAPESO := ' SELECT nvl(SUM(NVL(N.ARM_COLETA_PESOCOBRADO,0)),0) peso, nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) VlrMerc ';
      ListaSQL.CONTAPQ   := ' SELECT NVL(SUM(NVL(N.ARM_COLETA_PESOCOBRADO,0)) - MIN(NVL(O.GLB_ONU_KGISENTA,0)),0) PRODUTOQUIMICO, nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) VlrMerc ';
      ListaSQL.CONTAPQ2  := ' SELECT count(*) PRODUTOQUIMICO,nvl(SUM(NVL(N.ARM_NOTA_VALORMERC,0)),0) VlrMerc ';
    END IF;

    -- INICIALIZA O PESO EXCEDENTE
    V_PESOEXCEDENTE := 0;




          -- VERIFICAR PRODUTOS QUIMICOS
          -- VERIFICAR CARGA EXPRESSA
          -- VERIFICAR LOTACAO
          -- VERIFICAR FRACIONADO
          -- VERIFICAR SPOT
          -- VARIAVEL E RECRIADA PARA CADA SACADO NOVO
          -- MONTA CLAUSULA PARA MUDANCA DO SACADO
        
          -- MONTA WHERE PARA SELECIONAR AS NOTAS
          
          spi_SqlCliEnvolvidos(ListaQuebras);
          spi_SqlColetaEntrega(ListaQuebras.ORIGEMNOTA,ListaQuebras.DESTINONOTA,ListaCargaCli);
          spi_SqlSacGrupoContrato(V_SACADOCARGA,V_GRUPOCARGAS,V_CONTRATOCARGAS);
          
          vTesteCarga.vRetorna := 'N'; -- PARA FAZER OU NAO O LOOP DAS NOTAS
        
          V_LOTACAO := 0;
          V_LOTACAOVLRMERC := 0;
          if nvl(ListaQuebras.ccTPAGRUPA,'02') in ('00') Then          
             spi_SqlColetaEntrega(null,null,ListaCargaCli);
          Else
             spi_SqlColetaEntrega(ListaQuebras.ORIGEMNOTA,ListaQuebras.DESTINONOTA,ListaCargaCli);
          End If;   
          
          vTesteCarga.vRetorna := 'S';
          ListaSQL.FINALNOTA   := '';
          -- o Default e Fracionao se entrar em Lotacao troca 
          ListaNotas.cnTIPOCARGA := 'FRACIONADO';
            -- Verifica as condicoes para as notas
            -- inicializa a lista;
            -- 04/01/2015 voltei o ListaSQL.SCWHERE
            ListaSQL.FINALNOTA := ListaSQL.NOTAS || 
                                  ListaSQL.TABWHERE ||
                                  ListaSQL.NOTASWHERE ||
                                  ListaSQL.SCWHERE ||
                                  ListaSQL.SEMCTRC ||
                                  ListaSQL.NOTASORDER;
            
-- DUPLIQUEI ESTE LOOP ANTES DE RODAR AS NOTAS
--            ListaVaux.cnCLIREMANT    := 'VAZIO';
            ListaVaux.cnNRCOLETAANT  := 'VAZIO';
--            ListaVaux.cnTABSOLCODANT := 'VAZIO';
            ListaVaux.cnNRCOLETAANT  := 'VAZIO';
            ListaVaux.cnContaNotas   := 0;
            ListaVaux.cnContaTodaNotas := 0;
            ListaVaux.cnContaFornec  := 0;
            ListaVaux.cnContaDestinatario := 0;
            ListaVaux.cnContaQuimico := 0;
            ListaVaux.cnSomaPesoQP   := 0;
            ListaVaux.cnCONTRATO := ListaQuebras.CONTRATO;
            ListaVaux.cnGRUPOEC  := ListaQuebras.GRUPOEC;

            pAgrupamentoEmissao.delete;
            ListaVaux.cnTemQuimico  := 'N';
            ListaVaux.cnTemExpresso := 'N';
            ListaVaux.cnTemCD       := 'N';
            -- Acertando e contando Particularidades das Notas
            -- Conta Notas, Fornecedores
            -- Verifica algumas particularidades de Contrato
            OPEN cNOTAS FOR ListaSQL.FINALNOTA;
            loop
              fetch cNOTAS
                into ListaNotas;
              Exit When cnotas%Notfound;
              
             if vAuxiliarnumerico = 9999 Then
                 Return;
             End If;     

              -- Volta a Codic?o pois pode mudar para cada nota
              ListaCargaCli.ccColetaCobra := ListaCargaCli.ccColetaCobraTmp;

              if TDVADM.PKG_FIFO_CARREGCTRC.fn_EColetaExpressa(ListaNotas.cnNRCOLETA,ListaNotas.cnNrColetaCiclo) = 'S' Then
                 ListaVaux.cnTemExpresso := 'S';
              End If;
              
              If ListaNotas.cnTpCarga = 'CD' Then
                 ListaVaux.cnTemCD           := 'S';
                 ListaCargaCli.ccColetaCobra := 'N';
              End If; 
              
              -- Rateia a Tara dos Containes para as notas
              Begin
                 select i.arm_coletaimpexp_contara
                   into vAuxiliarnumerico
                 from tdvadm.t_arm_coletaimpexp i
                 where i.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
                   and i.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo;
              Exception
                When NO_DATA_FOUND Then
                   vAuxiliarnumerico := 0;
                End;     
               
         
              if ( ListaCargaCli.ccPCOBRANCA = 'PT') and ( vAuxiliarnumerico > 0 ) Then
                
                 select count(*)
                   into vAuxiliarnumerico2
                 from tdvadm.t_arm_nota an
                 where an.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
                   and an.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo;
              
                 update tdvadm.t_arm_nota an
                   set an.USUARIO_WEB_LOGIN_RI = round((vAuxiliarnumerico / vAuxiliarnumerico2),0)
                 where an.arm_nota_sequencia = ListaNotas.cnSequencia;
              Else
                 -- se tiver peso de Tara zero
                If vAuxiliarnumerico > 0 Then
                   update tdvadm.t_arm_nota an
                     set an.USUARIO_WEB_LOGIN_RI = 0
                   where an.arm_nota_sequencia = ListaNotas.cnSequencia;
                End If; 
              End If;
              
              
              if trim(nvl(ListaVaux.cnColetaPlaca,'X')) = trim(nvl(ListaNotas.cnCARRETEIROPLACA,'Y')) or 
                 trim(nvl(ListaVaux.cnColetaPlaca,'C')) = trim(nvl(ListaNotas.cnCONJFROTA,'F')) or
                 ListaVaux.cnColetaPlaca IS NULL
                  Then
                 -- Se umas da Placas forem iguais Nao sera cobrado a coleta
                 -- Retirado em 06/01/2016 era por causa do contrato antigo da VLI
--                 ListaCargaCli.ccColetaCobra := 'N';
                   ListaCargaCli.ccColetaCobra := ListaCargaCli.ccColetaCobra;
              Else
                 If ListaNotas.cnTpCarga = 'CD' Then
                    ListaVaux.cnTemCD           := 'S';
                    ListaCargaCli.ccColetaCobra := 'N';
                 End If; 
              End If;   
              
                ListaVaux.cnContaNotas := ListaVaux.cnContaNotas + 1;
                ListaVaux.cnContaTodaNotas := ListaVaux.cnContaTodaNotas + 1;
                -- Conta contas notas tem para o MESMO REMETENTE DESTINATARIO ENDERENCO 
                -- Agrupamento CTe Normal
                  vAuxiliarT  := ListaNotas.cnCLIREM    || ListaNotas.cnCLIDEST;  --|| ListaNotas.cnCLIENDDEST;
                  begin
                     pAgrupamentoEmissao(vAuxiliarT).Asinteger := pAgrupamentoEmissao(vAuxiliarT).Asinteger + 1;
                  Exception
                    When NO_DATA_FOUND Then
                        pAgrupamentoEmissao(vAuxiliarT).Asinteger := 1;                    
                    End;

                -- Agrupamento CTe Globalizado Remetente
                  vAuxiliarT1 := '61139432000172      ' || ListaNotas.cnCLIDEST;  
                  begin
                     pAgrupamentoEmissao(vAuxiliarT1).Asinteger := pAgrupamentoEmissao(vAuxiliarT1).Asinteger + 1;
                  Exception
                    When NO_DATA_FOUND Then
                        pAgrupamentoEmissao(vAuxiliarT1).Asinteger := 1;                    
                    End;

                -- Agrupamento CTe Globalizado Destinatario
                  vAuxiliarT2 := ListaNotas.cnCLIREM    ||  '61139432000172      ';
                  begin
                     pAgrupamentoEmissao(vAuxiliarT2).Asinteger := pAgrupamentoEmissao(vAuxiliarT2).Asinteger + 1;
                  Exception
                    When NO_DATA_FOUND Then
                        pAgrupamentoEmissao(vAuxiliarT2).Asinteger := 1;                    
                    End;


                if TDVADM.PKG_FIFO_CARREGCTRC.fn_EProdutoQuimico(ListaNotas.cnNOTA,ListaNotas.cnCLIREM,ListaNotas.cnSERIENF) = 'S' Then
                   ListaVaux.cnContaQuimico := ListaVaux.cnContaQuimico + 1;
                   ListaVaux.cnTemQuimico   := 'S';
                   ListaVaux.cnSomaPesoQP   := ListaVaux.cnSomaPesoQP + ListaNotas.cnPESOCOBRADO;
                End If;   
                
                if ListaNotas.cnCLIREM <> ListaVaux.cnCLIREMANT then
                   ListaVaux.cnCLIREMANT :=  ListaNotas.cnCLIREM;
                   ListaVaux.cnContaFornec := ListaVaux.cnContaFornec + 1;
                End If;
                
                if ListaNotas.cnCLIDEST <> ListaVaux.cnCLIDESTANT then
                   ListaVaux.cnCLIDESTANT :=  ListaNotas.cnCLIDEST;
                   ListaVaux.cnContaDestinatario := ListaVaux.cnContaDestinatario + 1;
                End If;

                
                
                

            End Loop; 
            commit;

          spi_SqlColetaEntrega(ListaQuebras.ORIGEMNOTA,ListaQuebras.DESTINONOTA,ListaCargaCli);          


          -- Carrega as Variaveis para Testar a Carga
                  vTesteCarga.vTPCARGACLI        := ListaCargaCli.ccTPCARGACLI;
                  vTesteCarga.vRetorna           := vTesteCarga.vRetorna;
                  vTesteCarga.vTestePeso         := vTesteCarga.vTestePeso;
                  vTesteCarga.vExcecute          := vTesteCarga.vExcecute;
                  vTesteCarga.vTpCArgaRodando    := ListaCargaCli.ccTPCARGACLI;
                  vTesteCarga.FINALNOTA          := vTesteCarga.FINALNOTA;
                  vTesteCarga.TESTAPESO          := vTesteCarga.TESTAPESO;
                  vTesteCarga.vLOCALIDADEORIGEM  := ListaQuebras.ORIGEMNOTA;
                  vTesteCarga.vLOCALIDADEDESTINO := ListaQuebras.DESTINONOTA;
                  vTesteCarga.vTIPOFRETE         := V_CIFFOB;
                  vTesteCarga.vCLIENTE           := V_SACADOCARGA;
                  vTesteCarga.vGRUPO             := V_GRUPOCARGAS;
                  vTesteCarga.vCONTRATO          := V_CONTRATOCARGAS;
                  vTesteCarga.vTPVEICULO         := V_CODIGOVEICULO;
                  vTesteCarga.vKM                := fnI_ConsultaKM(ListaQuebras.ORIGEMNOTA,ListaQuebras.DESTINONOTA);
                  If ( nvl(vTesteCarga.vKM,0) < 0 ) and ( ListaCargaCli.ccUSAFAIXAKM = 'S' )  Then
                       tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Problemas ao pegar KM no GOOGLE, entre manualmente. codigo ' || to_char(vTesteCarga.vKM);
                       vTesteCarga.vKM  := 0;
                       P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                  End If;
                  vtesteCarga.vEntCol            := ListaQuebras.ENTCOL;
                  vTesteCarga.vCLISAC            := V_SACADOCARGA;
                  vTesteCarga.vGrupoSac          := ListaNotas.cnGRUPOECSAC;
                  vTesteCarga.vCNPJREM           := ListaQuebras.CNPJREM;
                  vTesteCarga.vGrupoRem          := ListaNotas.cnGRUPOECREM;
                  VtesteCarga.vCLIENDREM         := ListaQuebras.CLIENDREM;
                  vTesteCarga.vORIGEMNOTA        := ListaQuebras.ORIGEMNOTA;
                  vTesteCarga.vCNPJDES           := ListaQuebras.CNPJDES;
                  vTesteCarga.vGrupoDes          := ListaNotas.cnGRUPOECDES;
                  VtesteCarga.vCLIENDDES         := ListaQuebras.CLIENDDES;
                  vTesteCarga.vDESTINONOTA       := ListaQuebras.DESTINONOTA;
                  vTesteCarga.vFLAGPGTO          := vTesteCarga.vFLAGPGTO;
                  vTesteCarga.vTemCD             := ListaVaux.cnTemCD;
                  vTesteCarga.vTemExpresso       := ListaVaux.cnTemExpresso;
                  vTesteCarga.vTemQuimico        := ListaVaux.cnTemQuimico;
                  vTesteCarga.vSql               := ListaSQL;
                  vTesteCarga.vTABSOLCOD         := vTesteCarga.vTABSOLCOD;
                  vTesteCarga.vTABSOLSQ          := vTesteCarga.vTABSOLSQ;
                  vTesteCarga.vTABSOL            := vTesteCarga.vTABSOL;


          vTesteCarga.vRetorna := 'N';                      
          IF ListaCargaCli.ccTPCARGACLI = '99' THEN
             vTesteCarga.vRetorna := 'S'; -- So para pode fachar os IF's
             ListaSQL.TESTAPESO := '';
             ListaSQL.FINALNOTA   := '';

          ElsIf ( ListaQuebras.TABSOLCOD <> SemTabelaCodigo )  Then
             -- Usa Modo Antigo



            ListaSQL.FINALNOTA := '';
            ListaSQL.TESTAPESO := '';
            ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTAPESO  || 
                                                        ListaSQL.TABWHERE   ||
--                                                        ListaSQL.SEMCTRSDR  ||
                                                        ListaSQL.NOTASWHERE ||
                                                        ListaSQL.SCWHERE;
            
            if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
               If ListaCargaCli.ccTPCARGACLI in ('13') Then
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
               ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
               ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
               ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
               End If; 
            Else
               ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
            End If; 

--            ListaCargaCli.ccTPCARGACLIPESQ := '00';
--             ListaCargaCli.ccTPCARGACLI     := '00';

            ListaCargaCli.ccTPCARGACLIDESC := 'Usando TAB/SOL - ' || ListaQuebras.TABSOLCOD;
            vTesteCarga.vTestePeso := 0;
            EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))
              INTO vTesteCarga.vTestePeso,vTesteCarga.vTesteVlrMerc;
             
            IF vTesteCarga.vTestePeso > 0  THEN

               
               ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTAS      || 
                                                           ListaSQL.TABWHERE   ||
--                                                           ListaSQL.SEMCTRSDR  ||
                                                           ListaSQL.NOTASWHERE;

                if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                   ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRCDR;
                Else
                   ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRSDR;
                End If;   
                ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SCWHERE || ListaSQL.NOTASORDER;
            ELSE
              vTesteCarga.vRetorna := 'S'; -- SE NAO RETRONOU LOTACAONAO DEIXA FAZER O LOOP DAS NOTAS
            END IF;
            
          Elsif nvl(trim(ListaCargaCli.ccPROCEDURE),'SEMPROC') <> 'SEMPROC' Then
               Begin
              tpLogGeracao.Con_Loggeracao_Sql := ListaSQL.TESTAPESO;
              
              -- Se For Modo antigo Nao usa veiculo
              If nvl(ListaNotas.cnTABSOLCOD,SemTabelaCodigo) <> SemTabelaCodigo Then
                 ListaCargaCli.ccUSAVEICULO := 'N';
              End If;

              IF ListaCargaCli.ccUSAVEICULO = 'N' Then -- trim(ListaCargaCli.ccTPCARGACLI) in ('02','06','08','10','12','13','14') THEN
                 V_CODIGOVEICULO := '9  ';
              Else

                 SP_TESTA_VEICULOPASSADO(V_GRUPOCARGAS,
                                         V_CONTRATOCARGAS,
                                         V_SACADOCARGA,
                                         vTesteCarga.vTestePeso,
                                         V_CIFFOB,
                                         ListaNotas.cnTIPOTRANSP,
                                         ListaCargaCli.ccTPCARGACLI,
                                         ListaCargaCli.ccPESQVEICULO,
                                         V_CODIGOVEICULO,
                                         vStatus,
                                         vMessage);
                                        

                 -- Sera ignorado o Erro Fatal
                 vStatus := 'N';
                 If vStatus = 'E' Then
                    tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Erro Fatal ' || chr(10) || vMessage;
                 Else
                    tpLogGeracaO.Con_Loggeracao_ErroHTML := vMessage;
                 End If;                                    
                 vAuxiliarchar := fn_InsereLogGeracao;

                             
              End IF;   


                  vTesteCarga.vTPCARGACLI        := ListaCargaCli.ccTPCARGACLI;
                  vTesteCarga.vRetorna           := vTesteCarga.vRetorna;
                  vTesteCarga.vTestePeso         := vTesteCarga.vTestePeso;
                  vTesteCarga.vExcecute          := vTesteCarga.vExcecute;
                  vTesteCarga.vTpCArgaRodando    := ListaCargaCli.ccTPCARGACLI;
                  vTesteCarga.FINALNOTA          := vTesteCarga.FINALNOTA;
                  vTesteCarga.TESTAPESO          := vTesteCarga.TESTAPESO;
                  vTesteCarga.vLOCALIDADEORIGEM  := ListaQuebras.ORIGEMNOTA;
                  vTesteCarga.vLOCALIDADEDESTINO := ListaQuebras.DESTINONOTA;
                  vTesteCarga.vTIPOFRETE         := V_CIFFOB;
                  vTesteCarga.vCLIENTE           := V_SACADOCARGA;
                  vTesteCarga.vGRUPO             := V_GRUPOCARGAS;
                  vTesteCarga.vCONTRATO          := V_CONTRATOCARGAS;
                  vTesteCarga.vTPVEICULO         := V_CODIGOVEICULO;
                  vTesteCarga.vKM                := fnI_ConsultaKM(ListaQuebras.ORIGEMNOTA,ListaQuebras.DESTINONOTA);
                  If ( nvl(vTesteCarga.vKM,0) <= 0 )  and ( ListaCargaCli.ccUSAFAIXAKM = 'S' )Then
                       tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Problemas ao pegar KM no GOOGLE, entre manualmente. codigo ' || to_char(vTesteCarga.vKM);
                       vTesteCarga.vKM  := 0;
                       P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                  End If;
                  vtesteCarga.vEntCol            := ListaQuebras.ENTCOL;
                  vTesteCarga.vCLISAC            := V_SACADOCARGA;
                  vTesteCarga.vGrupoSac          := ListaNotas.cnGRUPOECSAC;
                  vTesteCarga.vCNPJREM           := ListaQuebras.CNPJREM;
                  vTesteCarga.vGrupoRem          := ListaNotas.cnGRUPOECREM;
                  VtesteCarga.vCLIENDREM         := ListaQuebras.CLIENDREM;
                  vTesteCarga.vORIGEMNOTA        := ListaQuebras.ORIGEMNOTA;
                  vTesteCarga.vCNPJDES           := ListaQuebras.CNPJDES;
                  vTesteCarga.vGrupoDes          := ListaNotas.cnGRUPOECDES;
                  VtesteCarga.vCLIENDDES         := ListaQuebras.CLIENDDES;
                  vTesteCarga.vDESTINONOTA       := ListaQuebras.DESTINONOTA;
                  vTesteCarga.vFLAGPGTO          := vTesteCarga.vFLAGPGTO;
                  vTesteCarga.vTemCD             := ListaVaux.cnTemCD;
                  vTesteCarga.vTemExpresso       := ListaVaux.cnTemExpresso;
                  vTesteCarga.vTemQuimico        := ListaVaux.cnTemQuimico;
                  vTesteCarga.vSql               := ListaSQL;
                  vTesteCarga.vTABSOLCOD         := vTesteCarga.vTABSOLCOD;
                  vTesteCarga.vTABSOLSQ          := vTesteCarga.vTABSOLSQ;
                  vTesteCarga.vTABSOL            := vTesteCarga.vTABSOL;
                  
                  if ( nvl(vTesteCarga.vKM,0) <= 0 ) and ( ListaCargaCli.ccUSAFAIXAKM = 'S') Then
                     tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Busca de KM Com ERRO : ORIGEM ' || ListaQuebras.ORIGEMNOTA || '- DESTINO ' || ListaQuebras.DESTINONOTA;
                                                             
                     If nvl(vTesteCarga.vKM,0) = wservice.pkg_web.CLocalidadeNaoEncontrada Then
                         tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Localidade Nao Encontrada na TDV';
                     ElsIf nvl(vTesteCarga.vKM,0) = wservice.pkg_web.CErroAcessandoGOOGLE Then
                         tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Erro Acessando o Google';
                     ElsIf nvl(vTesteCarga.vKM,0) = wservice.pkg_web.CErroLendoXML Then
                         tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Erro Lendo o XML';
                     ElsIf nvl(vTesteCarga.vKM,0) = wservice.pkg_web.CSemROTA Then
                         tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Localidade Nao acessivel por veiculo';
                     ElsIf nvl(vTesteCarga.vKM,0) = wservice.pkg_web.CKmErrado Then
                         tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Km Nao numerico';
                     End IF;
                     P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                  End If;
                  
                  
--                  vTesteCarga
                  vAuxiliar := LENGTH(TRIM(ListaCargaCli.ccPROCEDURE)) + 3;
                  ListaCargaCli.ccPROCEDURE := replace(upper(ListaCargaCli.ccPROCEDURE),'PKG_FIFO_CARREGCTRC.','PKG_FIFO_CARREGCTRC.');
                  vTesteCarga.vExcecute :=                          chr(10);
                  vTesteCarga.vExcecute := vTesteCarga.vExcecute || 'Begin ' || chr(10);
                  vTesteCarga.vExcecute := vTesteCarga.vExcecute || '   ' || ListaCargaCli.ccPROCEDURE || '(TDVADM.PKG_FIFO_CARREGCTRC.vTesteCarga,' || chr(10);
                  vTesteCarga.vExcecute := vTesteCarga.vExcecute || RPAD(' ',vAuxiliar) ||                ' TDVADM.PKG_FIFO_CARREGCTRC.BListaCargaCli);' ||  chr(10);
                  vTesteCarga.vExcecute := vTesteCarga.vExcecute || 'End;' || chr(10);

                   tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Script Montado: ' || chr(10) || vTesteCarga.vExcecute;
                   P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                   commit;
                  EXECUTE IMMEDIATE (vTesteCarga.vExcecute);
                  ListaSQL.FINALNOTA := nvl(vTesteCarga.FINALNOTA,'');
                  ListaSQL.TESTAPESO := nvl(vTesteCarga.TESTAPESO ,'');
                  V_LOTACAO := nvl(vTesteCarga.vTestePeso,0);
                  V_LOTACAOVLRMERC := nvl(vTesteCarga.vTesteVlrMerc,0);
               exception
                 When OTHERS Then
                   vTesteCarga.vRetorna := 'S';
                   ListaSQL.FINALNOTA   := '';
                   ListaSQL.TESTAPESO   := ''; 
                   V_LOTACAO := 0;
                   V_LOTACAOVLRMERC := 0;
                   tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Script Montado: ' || chr(10) || vTesteCarga.vExcecute || chr(10) || 'Erro Durante a Execucao do Proc ' || ListaCargaCli.ccPROCEDURE || chr(10) || ' erro: ' || sqlerrm;
                   P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                 End;
          ElsIf ListaCargaCli.ccTPCARGACLIPESQ in ('01', -- LOTACAO
                                                   '33', -- LOTACAO EX0
                                                   '34', -- LOTACAO EX1
                                                   '38', -- LOTACAO
                                                   '41') -- CARGA DIRETA
          
          THEN -- LOTACAO
         
            --  SELECT PARA PEGAR CARGAS LOTACAO
            ListaSQL.FINALNOTA := '';
            ListaSQL.TESTAPESO := '';
            ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTAPESO || 
                                                        ListaSQL.TABWHERE;
            if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
               If ListaCargaCli.ccTPCARGACLI in ('13') Then
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
               ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
               ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
               ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
               End If;     
               ListaNotas.cnTIPOCARGA := 'LOTACAO';
            Else
               ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
            End If;  
            if ListaCargaCli.ccTPCARGACLI = '03' then
               ListaSQL.TESTAPESO := ListaSQL.TESTAPESO ||   ListaSQL.EXWHERE;
            End If;   
            ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.NOTASWHERE || 
                                                        ListaSQL.SCWHERE ||
                                                        ListaSQL.LotWHERErat;
            If ListaCargaCli.ccTPCARGACLI in ('01','41') and ListaCargaCli.ccTPCARGACLIPESQ in ('01') Then
               ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.TSTLOT01;
            ElsiF ListaCargaCli.ccTPCARGACLI in ('38') Then
               ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.TSTLOT;
            ElsiF ListaCargaCli.ccTPCARGACLI in ('33') Then
               ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.TSTLOTEX0;
            ElsiF ListaCargaCli.ccTPCARGACLI in ('34') Then
               ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.TSTLOTEX1;
            End If; 

            --                    P_RETORNO :=  V_SQLFINALNOTA;
            vTesteCarga.vTestePeso := 0;
            EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))
              INTO vTesteCarga.vTestePeso,vTesteCarga.vTesteVlrMerc;

            If vTesteCarga.vTestePeso = 0 Then
               vTesteCarga.vRetorna := 'S';
            End If;
             
            vAuxiliarT1 := trim(TDVADM.PKG_FIFO_CARREGCTRC.FN_BUSCA_TPCARGAVEICULO(V_GRUPOCARGAS,
                                                        V_CONTRATOCARGAS,
                                                        V_SACADOCARGA,
                                                        vTesteCarga.vTestePeso,
                                                        V_CIFFOB,
                                                        ListaNotas.cnTIPOTRANSP,
                                                        ListaCargaCli.ccTPCARGACLI,
                                                        ListaCargaCli.ccPESQVEICULO,
                                                        'TC')); 
            IF (( trim(nvl( vAuxiliarT1,ListaCargaCli.ccTPCARGACLI)) = trim(ListaCargaCli.ccTPCARGACLI) ) 
               Or ( trim(NVL(ListaQuebras.TABSOLCOD,SemTabelaCodigo)) <> SemTabelaCodigo ) )
               and vTesteCarga.vTestePeso > 0 THEN

                ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTAS || 
                                                            ListaSQL.TABWHERE ;
                if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                   ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRCDR;
                   ListaNotas.cnTIPOCARGA := 'LOTACAO';
                Else
                   ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRSDR;
                End If;   
                if ListaCargaCli.ccTPCARGACLI = '03' then
                   ListaSQL.FINALNOTA := ListaSQL.FINALNOTA ||   ListaSQL.EXWHERE;
                End If;   

                ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTASWHERE || ListaSQL.SCWHERE || ListaSQL.LotWHERErat ;
                If ListaCargaCli.ccTPCARGACLI in ('01','41') and ListaCargaCli.ccTPCARGACLIPESQ in ('01')  Then
                   ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.TSTLOT01;
                ElsIf ListaCargaCli.ccTPCARGACLI in ('38') Then
                   ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.TSTLOT;
                ElsiF ListaCargaCli.ccTPCARGACLI in ('33') Then
                   ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.TSTLOTEX0;
                ElsiF ListaCargaCli.ccTPCARGACLI in ('34') Then
                   ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.TSTLOTEX1;
                End If; 
     
                ListaSQL.FINALNOTA := ListaSQL.FINALNOTA ||  ListaSQL.NOTASORDER;

            ELSE
                vTesteCarga.vRetorna := 'S'; -- SE NAO RETRONOU LOTACAONAO DEIXA FAZER O LOOP DAS NOTAS
            END IF;
          ELSIF ListaCargaCli.ccTPCARGACLIPESQ IN ('02', -- FRACIONADO
                                                   '31', -- FRACIONADO SEMANAL
                                                   '32', -- FRACIONADO EX1
                                                   '37') -- FRACIONADO EX0
          THEN -- FRACIONADO
          
            ListaSQL.FINALNOTA := '';
            ListaSQL.TESTAPESO := '';
            ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTAPESO || 
                                                        ListaSQL.TABWHERE;
            if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
               If ListaCargaCli.ccTPCARGACLI in ('13') Then
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
               ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
               ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
               ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
               End If;     
            Else
               ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
            End If;   
            if ListaCargaCli.ccTPCARGACLI = '03' then
               ListaSQL.TESTAPESO := ListaSQL.TESTAPESO ||   ListaSQL.EXWHERE;
            End If;   
            
            -- Sirlano 08/10/2015
            ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.NOTASWHERE ||
                                                        ListaSQL.SCWHERE ||
                                                        ListaSQL.FraWHERErat;
            If ListaCargaCli.ccTPCARGACLIPESQ = '02' Then
               ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.TSTFRA;
            ElsIf ListaCargaCli.ccTPCARGACLIPESQ = '31' Then
               ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.TSTFRASEM;
            ElsIf ListaCargaCli.ccTPCARGACLIPESQ = '32' Then
               ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.TSTFRAEXD1;
            ElsIf ListaCargaCli.ccTPCARGACLIPESQ = '37' Then
               ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.TSTFRAEXD0;
            End If;

            vTesteCarga.vTestePeso := 0;
            EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))
              INTO vTesteCarga.vTestePeso,vTesteCarga.vTesteVlrMerc;
            If vTesteCarga.vTestePeso = 0 Then
               vTesteCarga.vRetorna := 'S';
            End If;
            vAuxiliarT1 := trim(TDVADM.PKG_FIFO_CARREGCTRC.FN_BUSCA_TPCARGAVEICULO(V_GRUPOCARGAS,
                                                        V_CONTRATOCARGAS,
                                                        V_SACADOCARGA,
                                                        vTesteCarga.vTestePeso,
                                                        V_CIFFOB,
                                                        ListaNotas.cnTIPOTRANSP,
                                                        ListaCargaCli.ccTPCARGACLI,
                                                        ListaCargaCli.ccPESQVEICULO,
                                                        'TC')); 
            IF ( trim(nvl( vAuxiliarT1,ListaCargaCli.ccTPCARGACLI)) = trim(ListaCargaCli.ccTPCARGACLI) ) Then

            ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTAS || 
                                                        ListaSQL.TABWHERE;
            if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
               ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRCDR;
            Else
               ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRSDR;
            End If;   
            if ListaCargaCli.ccTPCARGACLI = '03' then
               ListaSQL.FINALNOTA := ListaSQL.FINALNOTA ||   ListaSQL.EXWHERE;
            End If;   
            ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTASWHERE;

            If ListaCargaCli.ccTPCARGACLIPESQ = '02' Then
               ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.TSTFRA;
            ElsIf ListaCargaCli.ccTPCARGACLIPESQ = '31' Then
               ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.TSTFRASEM;
            ElsIf ListaCargaCli.ccTPCARGACLIPESQ = '32' Then
               ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.TSTFRAEXD1;
            ElsIf ListaCargaCli.ccTPCARGACLIPESQ = '37' Then
               ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.TSTFRAEXD0;
            End If;

            ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SCWHERE || ListaSQL.NOTASORDER;
     ELSE
              vTesteCarga.vRetorna := 'S'; -- SE NAO RETRONOU LOTACAONAO DEIXA FAZER O LOOP DAS NOTAS
            END IF;
          ELSIF ListaCargaCli.ccTPCARGACLIPESQ = '03' THEN -- EXPRESSA KM
            
            ListaSQL.FINALNOTA := '';
            ListaSQL.TESTAPESO := '';
            ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTAEX || 
                                                        ListaSQL.TABWHERE;
            if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
               If ListaCargaCli.ccTPCARGACLI in ('13') Then
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
               ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
               ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
               ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
               End If;     
            Else
               ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
            End If;   
            if ListaCargaCli.ccTPCARGACLI = '03' then
               ListaSQL.TESTAPESO := ListaSQL.TESTAPESO ||   ListaSQL.EXWHERE;
            End If;   
            ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.NOTASWHERE ||
                                                        ListaSQL.SCWHERE ||
                                                        ListaSQL.EXWHERE;

            vTesteCarga.vTestePeso := 0;
            EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))
              INTO vTesteCarga.vTestePeso;
            IF vTesteCarga.vTestePeso > 0 THEN
              -- SE TEM PRODUTO QUIMICO PERIGOSO

                ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTAS || 
                                                            ListaSQL.TABWHERE;
                if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                   ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRCDR;
                Else
                   ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRSDR;
                End If;   
                if ListaCargaCli.ccTPCARGACLI = '03' then
                   ListaSQL.FINALNOTA := ListaSQL.FINALNOTA ||   ListaSQL.EXWHERE;
                End If;   
                ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTASWHERE ||
                                                            ListaSQL.EXWHERE ||
                                                            ListaSQL.SCWHERE ||
                                                            ListaSQL.NOTASORDER;

            ELSE
              vTesteCarga.vRetorna := 'S'; -- SE NAO ACHOU PRODUTO QUIMICO NAO DEIXA FAZER O LOOP DAS NOTAS
            END IF;
          ELSIF ListaCargaCli.ccTPCARGACLIPESQ in ('04', -- PRODUTO QUIMICO
                                                   '35', -- PERIGOSO EX0
                                                   '36') -- PERIGOSO EX1
          
          THEN -- PROD.QUIMICO KM
            -- MUDANCA PRODUTO QUIMICO NOVO CONCEITO
            -- SOMENTE ARMAZENS TRAVADOS
                ListaSQL.FINALNOTA := '';
                ListaSQL.TESTAPESO := '';
                IF INSTR(V_ARMTRAVADO,P_ARM_ARMAZEM) = 0 THEN

                   ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTAPQ2 || 
                                                               ListaSQL.TABWHERE;
                    if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                       If ListaCargaCli.ccTPCARGACLI in ('13') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
                       ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
                       ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
                       ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
                       End If;     
                   Else
                      ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
                   End If;   
                   if ListaCargaCli.ccTPCARGACLI = '03' then
                      ListaSQL.TESTAPESO := ListaSQL.TESTAPESO ||   ListaSQL.EXWHERE;
                   End If;   
                   ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.NOTASWHERE ||
                                                               ListaSQL.SCWHERE ||
                                                            ListaSQL.PQWHERE2;

              ELSE

                   ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTAPQ || 
                                                               ListaSQL.TABWHERE;
                    if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                       If ListaCargaCli.ccTPCARGACLI in ('13') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
                       ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
                       ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
                       ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
                       End If;     
                   Else
                      ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
                   End If;   
                   if ListaCargaCli.ccTPCARGACLI = '03' then
                      ListaSQL.TESTAPESO := ListaSQL.TESTAPESO ||   ListaSQL.EXWHERE;
                   End If;   
                   ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.NOTASWHERE ||
                                                               ListaSQL.SCWHERE ||
                                                               ListaSQL.PQWHERE;
              
           END IF;
            --                    P_RETORNO :=  V_SQLFINALNOTA;
            
           If ListaCargaCli.ccTPCARGACLIPESQ = '04' Then
               ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.TSTQUI;
            ElsIf ListaCargaCli.ccTPCARGACLIPESQ = '35' Then
               ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.TSTQUIEX0;
            ElsIf ListaCargaCli.ccTPCARGACLIPESQ = '36' Then
               ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.TSTQUIEX1;
            End If;
            
            vTesteCarga.vTestePeso := 0;
            EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))
              INTO vTesteCarga.vTestePeso,vTesteCarga.vTesteVlrMerc;
            IF vTesteCarga.vTestePeso > 0 Then
              
            -- fazer a nova verificacao se existe formulario para esa nota



              -- SE TEM PRODUTO QUIMICO PERIGOSO
              
              IF INSTR(V_ARMTRAVADO,P_ARM_ARMAZEM) = 0 THEN
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTAS || 
                                                              ListaSQL.TABWHERE;
                    if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                       If ListaCargaCli.ccTPCARGACLI in ('13') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
                       ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
                       ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
                       ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
                       End If;     
                  Else
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTASWHERE ||
                                                              ListaSQL.PQWHERE2 ||
                                                              ListaSQL.SCWHERE ||
                                                              ListaSQL.NOTASORDER;

              ELSE
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTAS || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRCDR;
                  Else
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTASWHERE ||
                                                              ListaSQL.PQWHERE ||
                                                              ListaSQL.SCWHERE ||
                                                              ListaSQL.NOTASORDER;

              END IF;                      
            Else
            -- quando testamos o produto e ele retorna valor negativo e porque Nao e produto quimico
              vTesteCarga.vRetorna := 'S'; -- SE NAO ACHOU PRODUTO QUIMICO NAO DEIXA FAZER O LOOP DAS NOTAS
            END IF;
            
          ELSIF ListaCargaCli.ccTPCARGACLIPESQ = '05' THEN -- SPOT KM
                  ListaSQL.FINALNOTA := '';
                  ListaSQL.TESTAPESO := '';
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTAPESO || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     If ListaCargaCli.ccTPCARGACLI in ('13') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
                     End If;     
                  Else
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.NOTASWHERE ||
                                                              ListaSQL.SCWHERE ||
                                                              ListaSQL.SPOT;

            vTesteCarga.vTestePeso := 0;
            
            
            EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))
              INTO vTesteCarga.vTestePeso,vTesteCarga.vTesteVlrMerc;

            IF vTesteCarga.vTestePeso > 0 THEN

                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTAS || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRCDR;
                  Else
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTASWHERE ||
                                                              ListaSQL.SPOT ||
                                                              ListaSQL.SCWHERE ||
                                                              ListaSQL.NOTASORDER;
            ELSE
              vTesteCarga.vRetorna := 'S'; -- SE NAO ACHOU REPARONAO DEIXA FAZER O LOOP DAS NOTAS
            END IF;
          
          ELSIF ListaCargaCli.ccTPCARGACLIPESQ = '06' THEN -- REPARO
            -- CRIA A CLAUSULA DE WHERE NOVAMENTE PARA PEGAR O GRUPO ECONOMICO

                  ListaSQL.FINALNOTA := '';
                  ListaSQL.TESTAPESO := '';
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTAREPARO || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     If ListaCargaCli.ccTPCARGACLI in ('13') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
                     End If;     
                  Else
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.NOTASWHERE ||
                                                              ListaSQL.SCWHERE ||
                                                              ListaSQL.RPWHERE;

            vTesteCarga.vTestePeso := 0;
            
            
            EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))
              INTO vTesteCarga.vTestePeso,vTesteCarga.vTesteVlrMerc;

            IF vTesteCarga.vTestePeso > 0 THEN

                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTAS || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRCDR;
                  Else
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTASWHERE ||
                                                              ListaSQL.RPWHERE ||
                                                              ListaSQL.SCWHERE ||
                                                              ListaSQL.NOTASORDER;
            ELSE
              vTesteCarga.vRetorna := 'S'; -- SE NAO ACHOU REPARONAO DEIXA FAZER O LOOP DAS NOTAS
            END IF;
          
          ELSIF ListaCargaCli.ccTPCARGACLIPESQ = '07' THEN -- REDESPACHO

              ListaSQL.TESTAPESO := '';
              ListaSQL.FINALNOTA := '';
              vTesteCarga.vRetorna := 'S'; -- Nao implementado
          ELSIF ListaCargaCli.ccTPCARGACLIPESQ = '08' THEN -- EXCEDENTE
            -- CONTA PESO COBRADO 
                  ListaSQL.FINALNOTA := '';
                  ListaSQL.TESTAPESO := '';
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTAPESO2 || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     If ListaCargaCli.ccTPCARGACLI in ('13') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
                     End If;     
                  Else
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.NOTASWHERE || ListaSQL.SCWHERE;

            
            V_PESOAUXILIAR2 := 0;
            EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))
              INTO vTesteCarga.vTestePeso,vTesteCarga.vTesteVlrMerc;
              
            V_PESOAUXILIAR2 := vTesteCarga.vTestePeso;
              
            if nvl(V_PESOAUXILIAR2,0) = 0 Then  
               V_PESOAUXILIAR2 := 0.001;
            End If;   
            -- CONTA PESO CUBADO 

                  ListaSQL.TESTAPESO := '';
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTAPESO || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     If ListaCargaCli.ccTPCARGACLI in ('13') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
                     End If;     
                  Else
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.NOTASWHERE || ListaSQL.SCWHERE;

            V_PESOAUXILIAR := 0;
            EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))
              INTO vTesteCarga.vTestePeso,vTesteCarga.vTesteVlrMerc;

            V_PESOAUXILIAR := vTesteCarga.vTestePeso;
              
            if nvl(V_PESOAUXILIAR,0) = 0 Then  
               V_PESOAUXILIAR := 0.001;
            End If;   
            
             IF  V_PESOAUXILIAR > V_PESOAUXILIAR2 THEN -- CUBADO > QUE COBRADO
                 ListaCargaCli.ccTPCARGACLIDESC := 'EXCEDENTE CUBADO';
                 V_LOTACAO := V_PESOAUXILIAR;
             ELSE
                 ListaCargaCli.ccTPCARGACLIDESC := 'EXCEDENTE COBRADO';
                 V_LOTACAO := V_PESOAUXILIAR2;
             END IF;
             IF V_LOTACAO > ListaCargaCli.ccPESOMINIMO THEN
                V_PESOEXCEDENTE := V_LOTACAO - ListaCargaCli.ccPESOMINIMO;
             ELSE
                V_PESOEXCEDENTE := 0;
             END IF;      
                           
            vAuxiliarT1 := trim(TDVADM.PKG_FIFO_CARREGCTRC.FN_BUSCA_TPCARGAVEICULO(V_GRUPOCARGAS,
                                                        V_CONTRATOCARGAS,
                                                        V_SACADOCARGA,
                                                        vTesteCarga.vTestePeso,
                                                        V_CIFFOB,
                                                        ListaNotas.cnTIPOTRANSP,
                                                        ListaCargaCli.ccTPCARGACLI,
                                                        ListaCargaCli.ccPESQVEICULO,
                                                        'TC')); 
            IF ( trim(nvl( vAuxiliarT1,ListaCargaCli.ccTPCARGACLI)) = trim(ListaCargaCli.ccTPCARGACLI) ) 
               Or ( trim(NVL(ListaQuebras.TABSOLCOD,SemTabelaCodigo)) <> SemTabelaCodigo )  THEN

                  ListaSQL.FINALNOTA := '';
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTAS || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRCDR;
                  Else
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTASWHERE ||
                                                              ListaSQL.SCWHERE ||
                                                              ListaSQL.NOTASORDER;
            ELSE
              IF ( ListaCargaCli.ccTPCARGACLI NOT IN ('01', '02', '03', '04', '05', '06','08') ) and 
                 ( ListaCargaCli.ccPROCEDURE is null ) Then
                 vTesteCarga.vRetorna := 'S'; -- SE NAO RETRONOU LOTACAONAO DEIXA FAZER O LOOP DAS NOTAS
              End If;
              
              /**************************************************************************
                     processo unificado para testar
              **************************************************************************/          
            END IF;
            -- Se Nao tem peso Retorno
            if nvl(V_LOTACAO,0) = 0 Then
               vTesteCarga.vRetorna := 'S';  
            End If;   
          ELSIF ListaCargaCli.ccTPCARGACLIPESQ = '09' THEN -- FIXO
              ListaSQL.TESTAPESO := '';
              ListaSQL.FINALNOTA := '';
              vTesteCarga.vRetorna := 'S'; -- Nao implementado
          ELSIF ListaCargaCli.ccTPCARGACLIPESQ = '10' THEN -- ROTA MESTRE
            -- CRIA A CLAUSULA DE WHERE NOVAMENTE PARA PEGAR O GRUPO ECONOMICO

                  ListaSQL.FINALNOTA := '';
                  ListaSQL.TESTAPESO := '';
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTAPESO || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     If ListaCargaCli.ccTPCARGACLI in ('13') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
                     End If;     
                  Else
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.NOTASWHERE ||
                                                              ListaSQL.SCWHERE ||  
                                                              ListaSQL.RMWHERErat;
                              
            vTesteCarga.vTestePeso := 0;
            EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))
              INTO vTesteCarga.vTestePeso,vTesteCarga.vTesteVlrMerc;
            IF vTesteCarga.vTestePeso > 0 THEN

                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTAS || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRCDR;
                  Else
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTASWHERE ||
                                                              ListaSQL.SCWHERE ||  
                                                              ListaSQL.RMWHERErat ||
                                                              ListaSQL.NOTASORDER;

            ELSE
              vTesteCarga.vRetorna := 'S'; -- SE NAO ACHOU REPARONAO DEIXA FAZER O LOOP DAS NOTAS
            END IF;
            
          ELSIF ListaCargaCli.ccTPCARGACLIPESQ = '11' THEN -- LOTACAO RE
            -- CRIA A CLAUSULA DE WHERE NOVAMENTE PARA PEGAR O GRUPO ECONOMICO

                  ListaSQL.FINALNOTA := '';
                  ListaSQL.TESTAPESO := '';
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTAPESO || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     If ListaCargaCli.ccTPCARGACLI in ('13') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
                     End If;     
                  Else
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.NOTASWHERE ||
                                                              ListaSQL.SCWHERE ||  
                                                              ListaSQL.LotWHERErat;
                  
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ' AND C.FCF_TPCARGA_CODIGO <> ''01'' ';

                  tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'TESTANDO' ||
                                                                ' SQL DO TESTA PESO TIPO DE CARGA ' || ListaCargaCli.ccTPCARGACLIDESC || '-' || ListaCargaCli.ccTPCARGACLIPESQ || '-' || ' PESO TOTAL - ' ||
                                                                TO_CHAR(vTesteCarga.vTestePeso);
                  tpLogGeracao.Con_Loggeracao_SQL := ListaSQL.TESTAPESO;        
                  vAuxiliarchar :=  fn_InsereLogGeracao;                               


            vTesteCarga.vTestePeso := 0;
            EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))
              INTO vTesteCarga.vTestePeso,vTesteCarga.vTesteVlrMerc;

            IF vTesteCarga.vTestePeso > 0 THEN
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTAS || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRCDR;
                  Else
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTASWHERE ||
                                                              ListaSQL.SCWHERE ||  
                                                              ListaSQL.LotWHERErat ||
                                                              ' AND C.FCF_TPCARGA_CODIGO <> ''01'' ' ||
                                                              ListaSQL.NOTASORDER;

            ELSE
              vTesteCarga.vRetorna := 'S'; -- SE NAO ACHOU REPARONAO DEIXA FAZER O LOOP DAS NOTAS
            END IF;
          ELSIF ListaCargaCli.ccTPCARGACLIPESQ = '12' THEN -- FRACIONADO RE
            -- CRIA A CLAUSULA DE WHERE NOVAMENTE PARA PEGAR O GRUPO ECONOMICO
                  ListaSQL.FINALNOTA := '';
                  ListaSQL.TESTAPESO := '';
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTAPESO || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     If ListaCargaCli.ccTPCARGACLI in ('13') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
                     End If;     
                    Else
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.NOTASWHERE ||
                                                              ListaSQL.SCWHERE;
                  If ListaQuebras.GRUPOEC <> '0020' Then 
                   ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.FraWHERErat;
                  End If;


            vTesteCarga.vTestePeso := 0;
            EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))
              INTO vTesteCarga.vTestePeso,vTesteCarga.vTesteVlrMerc;

            IF vTesteCarga.vTestePeso > 0 THEN
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTAS || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRCDR;
                  Else
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTASWHERE ||
                                                              ListaSQL.SCWHERE ||  
                                                              ListaSQL.FraWHERErat || 
                                                              ListaSQL.NOTASORDER;
            ELSE
              vTesteCarga.vRetorna := 'S'; -- SE NAO ACHOU REPARONAO DEIXA FAZER O LOOP DAS NOTAS
            END IF;
          ElsIf ListaCargaCli.ccTPCARGACLIPESQ = '13' THEN -- REENTREGA
             vTesteCarga.vRetorna := 'S';

                  ListaSQL.FINALNOTA := '';
                  ListaSQL.TESTAPESO := '';
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTANOTA || 
                                                              ListaSQL.TABWHERE;
                    if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                       If ListaCargaCli.ccTPCARGACLI in ('13') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
                       ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
                       ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
                       ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
                       End If;     
                  Else
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.NOTASWHERE || 
                                                              ListaSQL.SCWHERE ||
                                                              ListaSQL.REEWHERE;

             vTesteCarga.vTestePeso := 0;
             EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))
               INTO vTesteCarga.vTestePeso/*,vTesteCarga.vTesteVlrMerc*/;
            IF vTesteCarga.vTestePeso > 0 THEN
              vTesteCarga.vTpCArgaRodando := ListaCargaCli.ccTPCARGACLI;
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTAS || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRCDR;
                  Else
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTASWHERE || 
                                                              ListaSQL.REEWHERE ||
                                                              ListaSQL.SCWHERE ||
                                                              ListaSQL.NOTASORDER;

            ELSE
              vTesteCarga.vRetorna := 'S'; -- SE NAO ACHOU REPARONAO DEIXA FAZER O LOOP DAS NOTAS
            END IF;
          ElsIf ListaCargaCli.ccTPCARGACLIPESQ = '14' THEN -- DEVOLUCAO
                  vTesteCarga.vRetorna := 'S';
                  ListaSQL.FINALNOTA := '';
                  ListaSQL.TESTAPESO := '';
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTANOTA || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     If ListaCargaCli.ccTPCARGACLI in ('13') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
                     End If;     
                  Else
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.NOTASWHERE || 
                                                              ListaSQL.SCWHERE ||
                                                              ListaSQL.DEVWHERE;
             
             vTesteCarga.vTestePeso := 0;
             EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))
               INTO vTesteCarga.vTestePeso/*,vTesteCarga.vTesteVlrMerc*/;
            IF vTesteCarga.vTestePeso > 0 THEN
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTAS || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRCDR;
                  Else
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTASWHERE || 
                                                              ListaSQL.DEVWHERE   ||
                                                              ListaSQL.SCWHERE ||
                                                              ListaSQL.NOTASORDER;

            ELSE
              vTesteCarga.vRetorna := 'S'; -- SE NAO ACHOU REPARONAO DEIXA FAZER O LOOP DAS NOTAS
            END IF;

          ELSIF ListaCargaCli.ccTPCARGACLIPESQ = '20' THEN -- COLETA
            -- CRIA A CLAUSULA DE WHERE NOVAMENTE PARA PEGAR O GRUPO ECONOMICO

                  ListaSQL.FINALNOTA := '';
                  ListaSQL.TESTAPESO := '';
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTAPESO || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     If ListaCargaCli.ccTPCARGACLI in ('13') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
                     End If;     
                  Else
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.NOTASWHERE ||
                                                              ListaSQL.SCWHERE ||  
                                                              ListaSQL.WHERECOL;
                              
            vTesteCarga.vTestePeso := 0;
            EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))
              INTO vTesteCarga.vTestePeso,vTesteCarga.vTesteVlrMerc;
            IF vTesteCarga.vTestePeso > 0 THEN

                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTAS || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRCDR;
                  Else
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTASWHERE ||
                                                              ListaSQL.SCWHERE ||  
                                                              ListaSQL.WHERECOL ||
                                                              ListaSQL.NOTASORDER;

            ELSE
              vTesteCarga.vRetorna := 'S'; -- SE NAO ACHOU REPARONAO DEIXA FAZER O LOOP DAS NOTAS
            END IF;


          ElsIf ListaCargaCli.ccTPCARGACLIPESQ = '25' THEN -- COMPLEMENTO
                  vTesteCarga.vRetorna := 'S';
                  ListaSQL.FINALNOTA := '';
                  ListaSQL.TESTAPESO := '';
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTANOTA || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     If ListaCargaCli.ccTPCARGACLI in ('13') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
                     End If;     
                  Else
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.NOTASWHERE || 
                                                              ListaSQL.SCWHERE ||
                                                              ListaSQL.DEVWHERE;
             
             vTesteCarga.vTestePeso := 0;
             EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))
               INTO vTesteCarga.vTestePeso/*,vTesteCarga.vTesteVlrMerc*/;
            IF vTesteCarga.vTestePeso > 0 THEN
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTAS || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRCDR;
                  Else
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTASWHERE || 
                                                              ListaSQL.DEVWHERE   ||
                                                              ListaSQL.SCWHERE ||
                                                              ListaSQL.NOTASORDER;

            ELSE
              vTesteCarga.vRetorna := 'S'; -- SE NAO ACHOU REPARONAO DEIXA FAZER O LOOP DAS NOTAS
            END IF;

          ElsIf ListaCargaCli.ccTPCARGACLIPESQ = '26' THEN -- REMOCAO
                  vTesteCarga.vRetorna := 'S';
                  ListaSQL.FINALNOTA := '';
                  ListaSQL.TESTAPESO := '';
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTANOTA || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     If ListaCargaCli.ccTPCARGACLI in ('13') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
                     ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                        ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
                     End If;     
                  Else
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.NOTASWHERE || 
                                                              ListaSQL.SCWHERE ||
                                                              ListaSQL.DEVWHERE;
             
             vTesteCarga.vTestePeso := 0;
             EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))
               INTO vTesteCarga.vTestePeso/*,vTesteCarga.vTesteVlrMerc*/;
            IF vTesteCarga.vTestePeso > 0 THEN
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTAS || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRCDR;
                  Else
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTASWHERE || 
                                                              ListaSQL.DEVWHERE   ||
                                                              ListaSQL.SCWHERE ||
                                                              ListaSQL.NOTASORDER;
            ELSE
              vTesteCarga.vRetorna := 'S'; -- SE NAO ACHOU REPARONAO DEIXA FAZER O LOOP DAS NOTAS
            END IF;
          ELSIF ListaCargaCli.ccTPCARGACLIPESQ in ('21', --REDEX
                                                   '22', --OP.CASADA
                                                   '23', --OP.SIMPLES CH
                                                   '24', --OP.REDONDA
                                                   '27', -- CUBADA
                                                   '30') -- OP.SIMPLES VZ
                                                         THEN 
            -- CRIA A CLAUSULA DE WHERE NOVAMENTE PARA PEGAR O GRUPO ECONOMICO
                  ListaSQL.FINALNOTA := '';
                  ListaSQL.TESTAPESO := '';
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CONTAPESO || 
                                                              ListaSQL.TABWHERE;
                    if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                       If ListaCargaCli.ccTPCARGACLI in ('13') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.REEWHERE;
                       ElsiF ListaCargaCli.ccTPCARGACLI in ('14') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.DEVWHERE;
                       ElsiF ListaCargaCli.ccTPCARGACLI in ('25') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.CCWHERE;
                       ElsiF ListaCargaCli.ccTPCARGACLI in ('26') Then
                          ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.RRWHERE;
                       End If;     
                  Else
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.TESTAPESO := ListaSQL.TESTAPESO ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.TESTAPESO := ListaSQL.TESTAPESO || ListaSQL.NOTASWHERE ||
                                                              ListaSQL.SCWHERE ||  
                                                              ' AND C.FCF_TPCARGA_CODIGO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(ListaCargaCli.ccTPCARGACLIPESQ) ;


            vTesteCarga.vTestePeso := 0;
            EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))
              INTO vTesteCarga.vTestePeso,vTesteCarga.vTesteVlrMerc;

            IF vTesteCarga.vTestePeso > 0 THEN
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTAS || 
                                                              ListaSQL.TABWHERE;
                  if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then                      
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRCDR;
                  Else
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.SEMCTRSDR;
                  End If;   
                  if ListaCargaCli.ccTPCARGACLI = '03' then
                     ListaSQL.FINALNOTA := ListaSQL.FINALNOTA ||   ListaSQL.EXWHERE;
                  End If;   
                  ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTASWHERE ||
                                                              ListaSQL.SCWHERE ||  
                                                              ' AND C.FCF_TPCARGA_CODIGO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(ListaCargaCli.ccTPCARGACLIPESQ) || 
                                                              ListaSQL.NOTASORDER;
            ELSE
              vTesteCarga.vRetorna := 'S'; -- SE NAO ACHOU REPARONAO DEIXA FAZER O LOOP DAS NOTAS
            END IF;    
       ELSE
            vTesteCarga.vRetorna := 'S';
            ListaSQL.FINALNOTA := '';
            ListaSQL.TESTAPESO := '';
       END IF;

            If trim(sys_context('CARREGAMENTO','CODCARREG')) = trim(P_ARM_CARREGAMENTO) Then
               vContextCount := vContextCount + 1; 
               Insert Into TDVADM.T_glb_sql ( glb_sql_instrucao, 
                                       glb_sql_dtgravacao, 
                                       glb_sql_programa) 
                              Values ( ListaSQL.TESTAPESO, 
                                       Sysdate, 
                                       lpad(vContextCount,3,'0') || '-' || P_ARM_CARREGAMENTO || '-Cursor=Conta Peso carregamento=' || P_ARM_CARREGAMENTO || 'TpCarga=' || ListaCargaCli.ccTPCARGACLI || '-' || ListaCargaCli.ccTPCARGACLIPESQ  || ' Retorna = ' || vTesteCarga.vRetorna  || ' Vez ' || to_char(tpLogGeracao.Con_Loggeracao_Codigo)||P_USU_USUARIOCRIA); 
               vContextCount := vContextCount + 1; 
               Insert Into TDVADM.T_glb_sql ( glb_sql_instrucao, 
                                       glb_sql_dtgravacao, 
                                       glb_sql_programa) 
                              Values ( ListaSQL.FINALNOTA, 
                                       Sysdate, 
                                       lpad(vContextCount,3,'0') || '-' || P_ARM_CARREGAMENTO || '-Cursor=Lista Nota carregamento=' || P_ARM_CARREGAMENTO || 'TpCarga=' || ListaCargaCli.ccTPCARGACLI || '-' || ListaCargaCli.ccTPCARGACLIPESQ  || ' Retorna = ' || vTesteCarga.vRetorna  || ' Vez ' || to_char(tpLogGeracao.Con_Loggeracao_Codigo)||P_USU_USUARIOCRIA); 
               commit;
            End If;   
        
          -- PEGA O TIPO DE VEICULO PARA A CARGA
        
              -- Se For Modo antigo Nao usa veiculo
              If nvl(ListaNotas.cnTABSOLCOD,SemTabelaCodigo) <> SemTabelaCodigo Then
                 ListaCargaCli.ccUSAVEICULO := 'N';
              End If;

              If  vTesteCarga.vRetorna = 'N' Then
                  IF ListaCargaCli.ccUSAVEICULO = 'N' Then -- trim(ListaCargaCli.ccTPCARGACLI) in ('02','06','08','10','12','13','14') THEN
                     V_CODIGOVEICULO := '9  ';
                  Else
                     tpLogGeracao.Con_Loggeracao_Sql := ListaSQL.TESTAPESO;


                     SP_TESTA_VEICULOPASSADO(V_GRUPOCARGAS,
                                             V_CONTRATOCARGAS,
                                             V_SACADOCARGA,
                                             vTesteCarga.vTestePeso,
                                             V_CIFFOB,
                                             ListaNotas.cnTIPOTRANSP,
                                             ListaCargaCli.ccTPCARGACLI,
                                             ListaCargaCli.ccPESQVEICULO,
                                             V_CODIGOVEICULO,
                                             vStatus,
                                             vMessage);
                                            
                     -- Ignora o Erro Fatal
                     vStatus := 'N';
                     If vStatus = 'E' Then
                        tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Erro Fatal ' || chr(10) || vMessage;
                     Else
                        tpLogGeracaO.Con_Loggeracao_ErroHTML := vMessage;
                     End If;                                    
                     vAuxiliarchar := fn_InsereLogGeracao;

                  End IF;   
                  ListaVaux.cnTpVeiculo := V_CODIGOVEICULO;
                  SELECT TV.FCF_TPVEICULO_DESCRICAO
                    INTO V_TIPOVEICULO
                  FROM TDVADM.T_FCF_TPVEICULO TV
                  WHERE TV.FCF_TPVEICULO_CODIGO = V_CODIGOVEICULO;
              End If;
              -- PEGAR UMA SEQUENCIA PARA JUSTIFICAR O CALCULO
              IF ( ListaCargaCli.ccTPCARGACLI NOT IN ('01','02','03','04','05','06','08','09','10','11','12','13','14','20','21','22','23','24','25','26','27','30','31','32','33','34','35','36','37','38','41') ) and 
                 ( ListaCargaCli.ccPROCEDURE is null ) and 
                 ( ListaQuebras.TABSOLCOD = SemTabelaCodigo ) Then

                vTesteCarga.vRetorna := 'S'; -- SOMENTE PARA NAO RODAR AGORA
              END IF;
           
          --                   v_retorna := 'S'; -- SOMENTE PARA NAO RODAR AGORA
          V_MOTVEICULO := 'N'; -- N - Nao VEZ , S - PEGOU MOTORISTA e V - VIRTUAL\
          --               P_RETORNO :=  V_SQLFINALNOTA;
          

         if vTesteCarga.vRetorna = 'S' Then 
            tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'TESTANDO' ||
                                                   ' TIPO DE CARGA ' || ListaCargaCli.ccTPCARGACLIDESC || '-' || ListaCargaCli.ccTPCARGACLIPESQ || '-' || ' PESO TOTAL - ' ||
                                                   TO_CHAR(vTesteCarga.vTestePeso);
            tpLogGeracao.Con_Loggeracao_SQL := ListaSQL.TESTAPESO;                                       
         Else                                          
            tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'RODANDO' ||
                                                      ' SQL DO TESTA PESO TIPO DE CARGA ' || ListaCargaCli.ccTPCARGACLIDESC || '-' || ListaCargaCli.ccTPCARGACLIPESQ || '-' || ' PESO TOTAL - ' ||
                                                      TO_CHAR(vTesteCarga.vTestePeso);
            tpLogGeracao.Con_Loggeracao_SQL := ListaSQL.TESTAPESO;        
            vAuxiliarchar :=  fn_InsereLogGeracao;                               
            tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'RODANDO' ||
                                                      ' TIPO DE CARGA ' || ListaCargaCli.ccTPCARGACLIDESC || '-' || ListaCargaCli.ccTPCARGACLIPESQ || '-' || ' PESO TOTAL - ' ||
                                                      TO_CHAR(vTesteCarga.vTestePeso);
            tpLogGeracao.Con_Loggeracao_SQL := ListaSQL.FINALNOTA;                                       
         End If;       
         vAuxiliarchar :=  fn_InsereLogGeracao;


           If vTesteCarga.vTestePeso > 40000 Then
              tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Peso Total da Notas Supera a capacidade de um Veiculo de Transporte Rodoviario - Peso Total Carregado em Quilos ' || TO_CHAR(vTesteCarga.vTestePeso,'999,999.999');
              vAuxiliarchar :=  fn_InsereLogGeracao;
           End If;           

   
        if  vTesteCarga.vRetorna = 'N' then

            V_CONTADORDENOTAS    := 0;
            V_PESOTOTAL          := 0;
            V_PESOBALTOTAL       := 0;
            V_PESOCOBTOTAL       := 0;
            V_VALORTOTMERCADORIA := 0;
            V_LISTANOTASCTRC     := 'NOTA(s) FISCAL(is)-';
            ListaVaux.cnCLIREMANT          := '';
            ListaVaux.cnCLIDESTANT         := '';
            ListaVaux.cnCLIENDDESTANT      := '';
            ListaVaux.cnTABSOLCODANT       := '';
            ListaVaux.cnNRCOLETAANT        := '';
            if P_RETORNOPROCESSAMENTO <> 'E' then
               P_RETORNOPROCESSAMENTO := 'N';
            end if;
            V_CONTADOR2 := 0;
            
            -- Inicializa o Remente e a Coleta  antes de entrar no LOOP
--            ListaVaux.cnCLIREMANT    := 'VAZIO';
            ListaVaux.cnNRCOLETAANT  := 'VAZIO';
--            ListaVaux.cnTABSOLCODANT := 'VAZIO';
            ListaVaux.cnContaNotas   := 0;
            ListaVaux.cnContaTodaNotas := 0;
            ListaVaux.cnContaFornec  := 0;
            ListaVaux.cnContaDestinatario := 0;
            ListaVaux.cnContaQuimico := 0;
            ListaVaux.cnSomaPesoQP   := 0;
            ListaVaux.cnCONTRATO := ListaQuebras.CONTRATO;
            ListaVaux.cnGRUPOEC  := ListaQuebras.GRUPOEC;
             

            -- Guarda a Condic?o de cobra o nao a coleta
--            ListaCargaCli.ccColetaCobraTmp := ListaCargaCli.ccColetaCobra;
            vBusca_Frete.vPESOTOTAL := 0;
            vBusca_Frete.vPESO      := 0;
            -- Inicializac?o 
            V_CONTADORDENOTAS    := 0;
            V_PESOTOTAL          := 0;
            V_PESOBALTOTAL       := 0;
            V_PESOCOBTOTAL       := 0;
            V_VALORTOTMERCADORIA := 0;
            V_LISTANOTASCTRC     := 'NOTA(s) FISCAL(is)-';


            -- FAZENDO UMA NOVA VERIFICACAO NAS NOTAS
            pAgrupamentoEmissao.delete;
            ListaVaux.cnTemQuimico  := 'N';
            ListaVaux.cnTemExpresso := 'N';
            ListaVaux.cnTemCD       := 'N';
            -- Acertando e contando Particularidades das Notas
            -- Acertando Localidades de Origem e Destino
            OPEN cNOTAS FOR ListaSQL.FINALNOTA;
            loop
              fetch cNOTAS
                into ListaNotas;
              Exit When cnotas%Notfound;
              
             if vAuxiliarnumerico = 9999 Then
                 Return;
             End If;     
             

             vLocalColetaL  := substr(TDVADM.PKG_FIFO_CARREGCTRC.fn_RetOrigDestNota('C',ListaNotas.cnNOTA,ListaNotas.cnCLIREM,ListaNotas.cnSERIENF,ListaNotas.cnNRCOLETA,ListaNotas.cnNrColetaCiclo,ListaNotas.cnCHAVENFE,90),1,8);
           if vLocalColetaL = '00000' Then
              tpLogGeracaO.Con_Loggeracao_ErroHTML := fni_retcenario('Retornou LOCALIDADE COLETA ZERADA! Favor verificar NOTA e COLETA') ;
              tpLogGeracao.Arm_Nota_Numero :=   ListaNotas.cnNOTA;
              tpLogGeracao.Glb_Cliente_Cgccpfremetente := trim(ListaNotas.cnCLIREM);
              P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
           End If;


           vLocalEntregaL := substr(TDVADM.PKG_FIFO_CARREGCTRC.fn_RetOrigDestNota('E',ListaNotas.cnNOTA,ListaNotas.cnCLIREM,ListaNotas.cnSERIENF,ListaNotas.cnNRCOLETA,ListaNotas.cnNrColetaCiclo,ListaNotas.cnCHAVENFE,90),1,8);
           if vLocalEntregaL = '00000' Then
              tpLogGeracaO.Con_Loggeracao_ErroHTML := fni_retcenario('Retornou LOCALIDADE ENTREGA ZERADA! Favor verificar NOTA e COLETA') ;
              tpLogGeracao.Arm_Nota_Numero :=   ListaNotas.cnNOTA;
              tpLogGeracao.Glb_Cliente_Cgccpfremetente := trim(ListaNotas.cnCLIREM);
              P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
           End If;
         
           vLocalColetaI  := tdvadm.fn_busca_codigoibge(vLocalColetaL,'IBC'); 
           if vLocalColetaI = '00000' Then
              tpLogGeracaO.Con_Loggeracao_ErroHTML := fni_retcenario('Retornou IBGE COLETA ZERADO! Favor verificar ' || chr(10) || 
                                                                 'Endereco da Nota NOTA e/ou da  COLETA ou ' || chr(10) ||
                                                                 'Nota Digitada a mais de 90 dias') ;
              tpLogGeracao.Arm_Nota_Numero :=   ListaNotas.cnNOTA;
              tpLogGeracao.Glb_Cliente_Cgccpfremetente := trim(ListaNotas.cnCLIREM);
              P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
           End If;
           vLocalEntregaI := tdvadm.fn_busca_codigoibge(vLocalEntregaL,'IBC'); 
           if vLocalEntregaI = '00000' Then
              tpLogGeracaO.Con_Loggeracao_ErroHTML := fni_retcenario('Retornou IBEG ENTREGA ZERADO! Favor verificar ' || chr(10) || 
                                                                 'Endereco da Nota NOTA e/ou da  COLETA ou ' || chr(10) ||
                                                                 'Nota Digitada a mais de 90 dias') ;
              tpLogGeracao.Arm_Nota_Numero :=   ListaNotas.cnNOTA;
              tpLogGeracao.Glb_Cliente_Cgccpfremetente := trim(ListaNotas.cnCLIREM);
              P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
           End If;
          

              -- Volta a Codic?o pois pode mudar para cada nota
              ListaCargaCli.ccColetaCobra := ListaCargaCli.ccColetaCobraTmp;

              if TDVADM.PKG_FIFO_CARREGCTRC.fn_EColetaExpressa(ListaNotas.cnNRCOLETA,ListaNotas.cnNrColetaCiclo) = 'S' Then
                 ListaVaux.cnTemExpresso := 'S'; 
              End If;
              
              If ListaNotas.cnTpCarga = 'CD' Then
                 ListaCargaCli.ccColetaCobra := 'N';
                 ListaVaux.cnTemCD           := 'S';
              End If; 
              

              if trim(ListaVaux.cnColetaPlaca) = trim(ListaNotas.cnCARRETEIROPLACA) or 
                 trim(ListaVaux.cnColetaPlaca) = trim(ListaNotas.cnCONJFROTA) or
                 ListaVaux.cnColetaPlaca IS NULL
                  Then
                 -- Se umas da Placas forem iguais Nao sera cobrado a coleta
                 -- Retirado em 06/01/2016 era por causa do contrato antigo da VLI
--                 ListaCargaCli.ccColetaCobra := 'N';
                   ListaCargaCli.ccColetaCobra := ListaCargaCli.ccColetaCobra;
              Else
                 If ListaNotas.cnTpCarga = 'CD' Then
                    ListaVaux.cnTemCD           := 'S';
                    ListaCargaCli.ccColetaCobra := 'N';
                 End If; 
              End If;   
              



                ListaVaux.cnContaNotas := ListaVaux.cnContaNotas + 1;
                ListaVaux.cnContaTodaNotas := ListaVaux.cnContaTodaNotas + 1;

                -- Agrupamento CTe Normal
                  vAuxiliarT  := ListaNotas.cnCLIREM    || ListaNotas.cnCLIDEST;  --|| ListaNotas.cnCLIENDDEST;
                  begin
                     pAgrupamentoEmissao(vAuxiliarT).Asinteger := pAgrupamentoEmissao(vAuxiliarT).Asinteger + 1;
                  Exception
                    When NO_DATA_FOUND Then
                        pAgrupamentoEmissao(vAuxiliarT).Asinteger := 1;                    
                    End;

                -- Agrupamento CTe Globalizado Remetente
                  vAuxiliarT1 := '61139432000172      ' || ListaNotas.cnCLIDEST;  
                  begin
                     pAgrupamentoEmissao(vAuxiliarT1).Asinteger := pAgrupamentoEmissao(vAuxiliarT1).Asinteger + 1;
                  Exception
                    When NO_DATA_FOUND Then
                        pAgrupamentoEmissao(vAuxiliarT1).Asinteger := 1;                    
                    End;

                -- Agrupamento CTe Globalizado Destinatario
                  vAuxiliarT2 := ListaNotas.cnCLIREM    ||  '61139432000172      ';
                  begin
                     pAgrupamentoEmissao(vAuxiliarT2).Asinteger := pAgrupamentoEmissao(vAuxiliarT2).Asinteger + 1;
                  Exception
                    When NO_DATA_FOUND Then
                        pAgrupamentoEmissao(vAuxiliarT2).Asinteger := 1;                    
                    End;

                if TDVADM.PKG_FIFO_CARREGCTRC.fn_EProdutoQuimico(ListaNotas.cnNOTA,ListaNotas.cnCLIREM,ListaNotas.cnSERIENF) = 'S' Then
--                If nvl(ListaNotas.cnONU,OnuNaoQuimico) <> OnuNaoQuimico Then
                   ListaVaux.cnContaQuimico := ListaVaux.cnContaQuimico + 1;
                   ListaVaux.cnTemQuimico   := 'S';
                   ListaVaux.cnSomaPesoQP   := ListaVaux.cnSomaPesoQP + ListaNotas.cnPESOCOBRADO;
                End If;   
                if ListaNotas.cnCLIREM <> ListaVaux.cnCLIREMANT then
                   ListaVaux.cnCLIREMANT :=  ListaNotas.cnCLIREM;
                   ListaVaux.cnContaFornec := ListaVaux.cnContaFornec + 1;
                End If;

                if ListaNotas.cnCLIDEST <> ListaVaux.cnCLIDESTANT then
                   ListaVaux.cnCLIDESTANT :=  ListaNotas.cnCLIDEST;
                   ListaVaux.cnContaDestinatario := ListaVaux.cnContaDestinatario + 1;
                End If;

                  
            End Loop; 
            commit;


            if instr(ListaSQL.FINALNOTA,'ORDER BY') = 0 Then
               ListaSQL.FINALNOTA := ListaSQL.FINALNOTA || ListaSQL.NOTASORDER;
            End If;  


            tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'ABRI CURSOR DE NOTAS ';
            tpLogGeracao. Con_Loggeracao_Sql := ListaSQL.FINALNOTA;
            vAuxiliarchar := fn_InsereLogGeracao;
            close cNOTAS;
            vQtdeNotasCteEmitido := 0;
            OPEN cNOTAS FOR ListaSQL.FINALNOTA;
            loop
              fetch cNOTAS
                into ListaNotas;
              Exit When cnotas%Notfound;
             
--              ListaVaux.cnLocalColetaTmp := null;  
              Begin
              If pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring is null  Then
                 pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring := ListaNotas.cnCOLETA;
              End If;   
              Exception
                When NO_DATA_FOUND Then
                  pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring := ListaNotas.cnCOLETA;
                End;
              tpLogGeracao.Arm_Nota_Numero := ListaNotas.cnNOTA;
              tpLogGeracao.Glb_Cliente_Cgccpfremetente := ListaNotas.cnCLIREM;  
              
              If ListaNotas.cnNOTA = 4053 Then
                 ListaNotas.cnNOTA := ListaNotas.cnNOTA;
              End If;
              -- Traduzindo Origem / Destino


              If ( nvl(ListaCargaCli.ccColetaCobra,'N') = 'S' )  and  
                 ( nvl(ListaCargaCli.ccMudaOrigemCC,'S') = 'S' )  and
                 ( nvl(ListaNotas.cnTABSOLCOD,SemTabelaCodigo) = SemTabelaCodigo ) Then
                  vAuxiliarT := trim(fn_RetLocalidadeArmazem(P_ARM_ARMAZEM));
                  Begin
                  If pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring is null Then
                     pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring := ListaNotas.cnCOLETA;
                  End If;
                  Exception
                    When NO_DATA_FOUND Then
                      pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring := ListaNotas.cnCOLETA;
                    End;
                  ListaNotas.cnCOLETA := vAuxiliarT;
                  
                  -- alterado dia 08/05/2019 as 14:35 por Klayton, Sirlano e Rafael
                  -- devido a troca de origem das notas da Vale
                  IF (ListaNotas.cnGRUPOECSAC <> '0020') THEN
                  
                      update TDVADM.T_arm_nota an
                       set an.arm_nota_localcoletal = vAuxiliarT,
                           an.arm_nota_localcoletai = tdvadm.fn_busca_codigoibge(vAuxiliarT,'IBC')
                     where 0 = 0
                       and (an.arm_embalagem_numero,an.arm_embalagem_flag,an.arm_embalagem_sequencia) in (select cd.arm_embalagem_numero,cd.arm_embalagem_flag,cd.arm_embalagem_sequencia
                                                                                                         from TDVADM.T_arm_carregamentodet cd
                                                                                                         where cd.arm_carregamento_codigo = P_ARM_CARREGAMENTO)
                       and an.con_conhecimento_codigo is null
                       -- Diferente de Coleta CO e Carga Direta CD
                       and an.glb_tpcarga_codigo not in ('CD','CO');
                        
                      if sql%rowcount > 0 Then
                        ListaNotas.cnCOLETA     := trim(vAuxiliarT);
                        ListaQuebras.ORIGEMNOTA := trim(vAuxiliarT);
                      End If;
                      
                 END IF;
                   
              Else
                 -- Se cabra coleta for igual a N e Muda Origem = N
                 -- Se a localidade for diferente, volta a original
                 IF ( trim(ListaNotas.cnCOLETA) <> trim(nvl(pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring,ListaNotas.cnCOLETA)) ) Then
                    ListaNotas.cnCOLETA     := trim(pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring);
                    ListaQuebras.ORIGEMNOTA := trim(pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring);
                    update TDVADM.T_arm_nota an
                      set an.arm_nota_localcoletal = pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring,
                          an.arm_nota_localcoletai = tdvadm.fn_busca_codigoibge(pOrigemOriginalNota(ListaNotas.cnNOTA||ListaNotas.cnCLIREM).Asstring,'IBC')
                    where 0 = 0
                      and (an.arm_embalagem_numero,an.arm_embalagem_flag,an.arm_embalagem_sequencia) in (select cd.arm_embalagem_numero,cd.arm_embalagem_flag,cd.arm_embalagem_sequencia
                                                                                                         from TDVADM.T_arm_carregamentodet cd
                                                                                                         where cd.arm_carregamento_codigo = P_ARM_CARREGAMENTO)
                      and an.con_conhecimento_codigo is null
                   -- Diferente de Coleta CO e Carga Direta CD
                      and an.glb_tpcarga_codigo not in ('CD','CO');
                  End If;
              End IF;





               vDescOrigem.OrigemCodigo     := ListaNotas.cnORIGEM;
               vDescOrigem.OrigemDescricao  := tdvadm.fn_busca_codigoibge(ListaNotas.cnORIGEM,'LOD');
               vDescOrigem.DestinoCodigo    := ListaNotas.cnDESTINO;
               vDescOrigem.DestinoDescricao := tdvadm.fn_busca_codigoibge(ListaNotas.cnDESTINO,'LOD');

               vDescOrigem.ColLocCodigo     := ListaNotas.cnCOLETA;
               vDescOrigem.ColLocDescri     := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'LOD');
               vDescOrigem.ColIBGECodigo    := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'IBC');
               vDescOrigem.ColIBGEDescri    := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'IBD');
               vDescOrigem.ColCIDescri      := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'CI');
               vDescOrigem.ColCIDescri      := substr(vDescOrigem.ColCIDescri,1,2) || '-' || substr(vDescOrigem.ColCIDescri,3,1);
               vDescOrigem.ColMESOCodigo    := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'MEC');
               vDescOrigem.ColMESODescri    := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'MED');
               vDescOrigem.ColMICROCodigo   := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'MIC');
               vDescOrigem.ColMICRODescri   := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'MID');
               vDescOrigem.ColREGCodigo     := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'IBR');
               select decode(vDescOrigem.ColREGCodigo,1,'Norte',
                                                      2,'Nordeste',
                                                      3,'Sudeste',
                                                      4,'Sul',
                                                      5,'Centro Oeste')
                    into vDescOrigem.ColREGDescri
               From dual;
               vDescOrigem.ColREGVCodigo    := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'IBRV');

               select decode(vDescOrigem.ColREGVCodigo,1,'Norte',
                                                       2,'Norte',
                                                       3,'Sul',
                                                       4,'Sul',
                                                       5,'Sul')
                      into vDescOrigem.ColREGVDescri
                from dual;
               

               vDescOrigem.EntLocCodigo     := ListaNotas.cnENTREGA;
               vDescOrigem.EntLocDescri     := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'LOD');
               vDescOrigem.EntIBGECodigo    := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'IBC');
               vDescOrigem.EntIBGEDescri    := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'IBD');
               vDescOrigem.EntCIDescri      := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'CI');
               vDescOrigem.EntCIDescri      := substr(vDescOrigem.EntCIDescri,1,2) || '-' || substr(vDescOrigem.EntCIDescri,3,1);
               vDescOrigem.EntMESOCodigo    := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'MEC');
               vDescOrigem.EntMESODescri    := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'MED');
               vDescOrigem.EntMICROCodigo   := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'MIC');
               vDescOrigem.EntMICRODescri   := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'MID');
               vDescOrigem.EntREGCodigo     := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'IBR');
               select decode(vDescOrigem.EntREGCodigo,1,'Norte',
                                                      2,'Nordeste',
                                                      3,'Sudeste',
                                                      4,'Sul',
                                                      5,'Centro Oeste')
                     into vDescOrigem.EntREGDescri
               From dual;
               vDescOrigem.ColREGVCodigo    := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'IBRV');
               select decode(vDescOrigem.EntREGVCodigo,1,'Norte',
                                                       2,'Norte',
                                                       3,'Sul',
                                                       4,'Sul',
                                                       5,'Sul')
                     into vDescOrigem.ColREGVDescri
               From Dual;

               If Listacargacli.ccCteGlobalizado = 'R' Then
                  If ListaVaux.cnContaFornec < 5 Then
                     Listacargacli.ccCteGlobalizado := 'N';  
                  End If;
               ElsIf Listacargacli.ccCteGlobalizado = 'D' Then
                  If ListaVaux.cnContaDestinatario < 5 Then
                     Listacargacli.ccCteGlobalizado := 'N';  
                  End If;
               End If;

          
              ListaVaux.cnGRUPOEC     := V_GRUPOCARGAS;
              ListaVaux.cnCONTRATO    := V_CONTRATOCARGAS;

              -- Volta a Codic?o pois pode mudar para cada nota
              ListaCargaCli.ccColetaCobra := ListaCargaCli.ccColetaCobraTmp;

              If ListaNotas.cnTpCarga = 'CD' Then
                 ListaVaux.cnTemCD           := 'S';
                 ListaCargaCli.ccColetaCobra := 'N';
              End If; 
             
             -- Se o Usuario colocou na NOTA como CARGA DIRETA
             -- E a Coleta estava como ENTREGA
             -- Provoco erro FATAL


             
             If ListaVaux.cnTemCD = 'S' and ListaQuebras.ENTCOL = 'E' Then
                    tpLogGeracaO.Con_Loggeracao_ErroHTML := 'F-Coleta esta Indicando que e ENTREGA.' || chr(10) ||
                                                        'Usuario Digitou a Nota Como CARGA DIRETA' || chr(10) || 
                                                        ' Impossivel prosseguir ';
                    P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                    vErroFatal := 'E';
             End If;

              IF ListaCargaCli.ccPCOBRANCA = 'PB' THEN -- Peso Balanca
                 ListaNotas.cnPESOCOBRADO := ListaNotas.cnPESOBAL;
              Elsif ListaCargaCli.ccPCOBRANCA = 'PC' Then -- Peso Cubado
                 ListaNotas.cnPESOCOBRADO := ListaNotas.cnPESOCUBADO;
                 vPesagemObrigatoria := 'N';
              Elsif ListaCargaCli.ccPCOBRANCA = 'PR' Then  -- Peso Real
                 ListaNotas.cnPESOCOBRADO := ListaNotas.cnPESO;
                 vPesagemObrigatoria := 'N';
              Elsif ListaCargaCli.ccPCOBRANCA = 'PT' Then  -- Peso Tara
                 ListaNotas.cnPESOCOBRADO := ListaNotas.cnPESO + ListaNotas.cnTaraContainer;
                 vPesagemObrigatoria := 'N';
              ElsIf ListaCargaCli.ccPCOBRANCA = 'PE' Then -- Peso Excedente
                 ListaNotas.cnPESOCOBRADO := ListaNotas.cnPESOCOBRADO;
                 vPesagemObrigatoria := 'N';
              Else -- Default Peso Cobrado
                 ListaNotas.cnPESOCOBRADO := ListaNotas.cnPESO;
              END IF;
              
                if LPAD(ListaNotas.cnNOTA,9,'0') in ('000170817','000170774','000170769') Then
                   ListaNotas.cnNOTA := ListaNotas.cnNOTA;
                End If;

               if ListaNotas.cnCLIREM = '33054412000163' Then
                  ListaNotas.cnCLIREM := ListaNotas.cnCLIREM;
               End If;
              
              -- inicializa a variavel para ser testada antes de adicionar no campo de observac?o 
              v_FORMULARIOCLI := ProdutoQuimicoSemFormulario;

              if nvl(ListaNotas.cnONU,OnuNaoQuimico) <> OnuNaoQuimico Then

                 Select min(nvl(fe.glb_onuclascli_codigo,ProdutoNaoQuimico)),
                        min(nvl(fe.arm_notafichaemerg_codcli,ProdutoQuimicoSemFormulario))
                    Into v_CLASSIFCLI,
                         v_FORMULARIOCLI   
                 From TDVADM.T_arm_notafichaemerg fe
                 Where 0 = 0
                   AND LPAD(FE.ARM_NOTA_NUMERO,9,'0') = LPAD(ListaNotas.cnNOTA,9,'0')
                   AND trim(FE.GLB_CLIENTE_CGCCPFREMETENTE) = Trim(ListaNotas.cnCLIREM)
                   and fe.arm_nota_serie = ListaNotas.cnSERIENF;


                 -- Independente da Resposta da Vale 
                 -- A pedido do Gilberto foi colocado todos como Quimico
                 -- Caso a Onu seja Difierente de 9999
                 
                 if ListaNotas.cnGRUPOECSAC = '0020' Then
                    -- Fim da Regra devido a entrada do novo contrato da Vale
                    -- sirlano 30/03/2019
                    if trunc(sysdate) >= '12/06/2015' and TRUNC(SYSDATE) <= TO_DATE('30/03/2019','DD/MM/YYYY')  Then
                       v_CLASSIFCLI := ProdutoQuimicoPerigoso;
                    End If;
                    -- Quando nao tem  formulario jogo este.                 
                    if (v_FORMULARIOCLI = ProdutoQuimicoSemFormulario) then
                       v_FORMULARIOCLI := '123456';
                    end if;   
                 End If;
                 
                 -- Verifica se esta aguardando resposta da Vale
                 If ( v_CLASSIFCLI = ProdutoQuimicoAguardRetorno)  THEN              
                    tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Aguardando Resposta de Produto Quimico ' ;
                    P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                     
                 End If;
              
              Else
                 v_CLASSIFCLI := ProdutoNaoQuimico;
                 v_FORMULARIOCLI := null;
              End If;


              ListaCargaCli.ccPERCTQM := fn_GetPercentQuimico(ListaVaux, ListaNotas);
              ListaVerbas('V_PERCTQ').AsFloat := ListaCargaCli.ccPERCTQM;
              ListaVerbas('V_PERCTQ').Value := trim(to_char(ListaCargaCli.ccPERCTQM));
              ListaVerbas('V_PERCTQ').AsDesinencia := '%';
              ListaVaux.cnPercentQP   := ListaCargaCli.ccPERCTQM;

              if nvl(ListaNotas.cnONU,OnuNaoQuimico) = OnuNaoQuimico Then
--                 ListaCargaCli.ccPERCTQM := 1;
                 ListaVerbas('V_PERCTQ').AsFloat := ListaCargaCli.ccPERCTQM;
                 ListaVerbas('V_PERCTQ').Value := trim(to_char(ListaCargaCli.ccPERCTQM));
                 ListaVerbas('V_PERCTQ').AsDesinencia := '%';
                 ListaVaux.cnPercentQP   := ListaCargaCli.ccPERCTQM;
              End If;
            
              -- Verifica se o Cliente tem Estadia
              select count(*)
                into vAuxiliarnumerico
              from TDVADM.T_glb_cliente ce
              where ce.glb_cliente_cgccpfcodigo = ListaNotas.cnCLISAC
                and ce.glb_cliente_estadia = 'S';
                
              if ( vAuxiliarnumerico > 0 ) and ( ListaNotas.cnGRUPOECSAC = ListaNotas.cnGRUPOECDES ) Then   
                  select count(*)
                    into vAuxiliarnumerico
                  from TDVADM.T_glb_cliend ce
                  where ce.glb_cliente_cgccpfcodigo = ListaNotas.cnCLIDEST
                    and ce.glb_tpcliend_codigo = ListaNotas.cnCLIENDDEST
                    and ce.glb_portaria_id is null;
                  if vAuxiliarnumerico > 0 Then 
                     select ce.glb_cliend_codcliente || '-' || ce.glb_estado_codigo || '-' || ce.glb_cliend_cidade
                        into vAuxiliarT
                     from TDVADM.T_glb_cliend ce
                     where ce.glb_cliente_cgccpfcodigo = ListaNotas.cnCLIDEST
                       and ce.glb_tpcliend_codigo = ListaNotas.cnCLIENDDEST;
                    tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Cliente Nao tem Portaria Cadastrada. ' || chr(10) || 
                                                            'CNPJ-TPEND ' || ListaNotas.cnCLIDEST || ListaNotas.cnCLIENDDEST || chr(10) ||
                                                            'CODCLI-UF-CIDADE ' || vAuxiliarT || chr(10) ||
                                                            'Entre em Contato com o FATURAMENTO na MATRIZ.' ;
                    P_RETORNOPROCESSAMENTO := 0;
                  End If;
             End If;       
                   
            
              select co.arm_coleta_placa,
                     co.glb_cliente_cgccpfcodigocoleta,
                     trunc(co.arm_coleta_dtprogramacao)
                 into ListaVaux.cnColetaPlaca,
                      ListaVaux.cnColetaRemetente,
                      ListaVaux.cnColetaData
              From TDVADM.T_arm_coleta co
              where co.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
                and co.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo;


              if trim(ListaVaux.cnColetaPlaca) = trim(ListaNotas.cnCARRETEIROPLACA) or 
                 trim(ListaVaux.cnColetaPlaca) = trim(ListaNotas.cnCONJFROTA) or
                 ListaVaux.cnColetaPlaca IS NULL
                  Then
                 -- Se umas da Placas forem iguais Nao sera cobrado a coleta
                 -- Retirado em 06/01/2016 era por causa do contrato antigo da VLI
--                 ListaCargaCli.ccColetaCobra := 'N';
                   ListaCargaCli.ccColetaCobra := ListaCargaCli.ccColetaCobra;
              Else
                 If ListaNotas.cnTpCarga = 'CD' Then
                    ListaCargaCli.ccColetaCobra := 'N';
                 End If; 
              End If;   
              
             
              If ( ListaNotas.cnConhecimento is null )   Then            

                 -- Se for Vide Nota verifica se o peso e zerado e coloca 1 Kg
                 if nvl(ListaNotas.cnVideNota,0) = 1 Then
                    if nvl(ListaNotas.cnPESOCOBRADO,0) = 0 Then
                       ListaNotas.cnPESOCOBRADO := 1;
                    End If;
                    if nvl(ListaNotas.cnPESO,0) = 0 Then
                       ListaNotas.cnPESO := ListaNotas.cnPESOCOBRADO;
                    End If;
                 End If;
            
                 
                 -- vERIFICA SE TEM CONSIGNATARIO/REDESPACHO    
                 Begin
                   Select re.*
                      Into tpArmNotaRedespacho
                   From TDVADM.T_arm_notaredespacho re,
                        TDVADM.T_arm_notaservadd ss
                   Where lpad(re.arm_nota_numero, 9, '0') = lpad(Trim(ListaNotas.cnNOTA), 9, '0')
                    And Trim(re.glb_cliente_cgccpfremetente) = Trim(ListaNotas.cnCLIREM)
                    And Trim(upper(re.arm_nota_serie)) = Trim(upper(ListaNotas.cnSERIENF))
                    and re.arm_nota_sequencia = ListaNotas.cnSequencia
                    and re.arm_notaservadd_codigo = ss.arm_notaservadd_codigo
                    and 0 = (select count(*)
                             from tdvadm.t_arm_coletaparceiro cp
                             where cp.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
                               and cp.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo
                               and cp.arm_coletatppar_codigo = decode(re.arm_notaservadd_codigo,'03','CE',
                                                                                                '04','CC',
                                                                                                'XX'));

                   Select ss.con_consigredespacho_flagcr
                      Into vAuxiliarchar
                   From TDVADM.T_arm_notaredespacho re,
                        TDVADM.T_arm_notaservadd ss
                   Where lpad(re.arm_nota_numero, 9, '0') = lpad(Trim(ListaNotas.cnNOTA), 9, '0')
                    And Trim(re.glb_cliente_cgccpfremetente) = Trim(ListaNotas.cnCLIREM)
                    And Trim(upper(re.arm_nota_serie)) = Trim(upper(ListaNotas.cnSERIENF))
                    and re.arm_nota_sequencia = ListaNotas.cnSequencia
                    and re.arm_notaservadd_codigo = ss.arm_notaservadd_codigo
                    and 0 = (select count(*)
                             from tdvadm.t_arm_coletaparceiro cp
                             where cp.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
                               and cp.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo
                               and cp.arm_coletatppar_codigo = decode(re.arm_notaservadd_codigo,'03','CE',
                                                                                                '04','CC',
                                                                                                'XX'));
                 exception
                   When NO_DATA_FOUND Then
                     vAuxiliarchar := 'X';
                   End;
                   
                 if vAuxiliarchar = 'R' Then -- 
                    Begin
                        delete  TDVADM.T_arm_coletaparceiro cp
                        where cp.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
                          and cp.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo
                          and cp.arm_coletatppar_codigo = 'CC';
                        insert into TDVADM.T_arm_coletaparceiro cp
                        values (ListaNotas.cnNRCOLETA,
                                tpArmNotaRedespacho.Arm_Notaredespacho_Cnpjctrc,
                                tpArmNotaRedespacho.Arm_Notaredespacho_Tpcliend,
                                'CC',
                                ListaNotas.cnNrColetaCiclo);
                    Exception
                      When OTHERS Then
                        vAuxiliarchar := 'X';
                    End;    
                  Elsif vAuxiliarchar = 'C' Then  -- Coleta
                    Begin
                        delete  TDVADM.T_arm_coletaparceiro cp
                        where cp.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
                          and cp.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo
                          and cp.arm_coletatppar_codigo = 'CC';
                        insert into TDVADM.T_arm_coletaparceiro cp
                        values (ListaNotas.cnNRCOLETA,
                                tpArmNotaRedespacho.Arm_Notaredespacho_Cnpjctrc,
                                tpArmNotaRedespacho.Arm_Notaredespacho_Tpcliend,
                                'CC',
                                ListaNotas.cnNrColetaCiclo);
                    Exception
                      When OTHERS Then
                        vAuxiliarchar := 'X';
                    End;    
                  Elsif vAuxiliarchar = 'E' Then   -- Entrega
                    Begin
                        delete  TDVADM.T_arm_coletaparceiro cp
                        where cp.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
                          and cp.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo
                          and cp.arm_coletatppar_codigo = 'CE';
                        insert into TDVADM.T_arm_coletaparceiro cp
                        values (ListaNotas.cnNRCOLETA,
                                tpArmNotaRedespacho.Arm_Notaredespacho_Cnpjctrc,
                                tpArmNotaRedespacho.Arm_Notaredespacho_Tpcliend,
                                'CE',
                                ListaNotas.cnNrColetaCiclo);
                    Exception
                      When OTHERS Then
                        vAuxiliarchar := 'X';
                    End;    

                  End If;                   
                 -- Inicializa a Variavel do KM para  Nota;
                 ListaVaux.cnKM := 0;
                 
                  -- Verifica se vai agrupar conhecimentos por coleta
                  if ListaCargaCli.ccTPCARGAQPCOLCTRC = 'S' then
                     ListaCargaCli.ccTPCARGAQTDEAGCTRC := ListaNotas.cnQTDEColeta;
                  End If;
                  if ListaCargaCli.ccTPCARGAQPCOLNF = 'S' then
                     ListaCargaCli.ccTPCARGAQTDEAGNF := ListaNotas.cnQTDEColeta;
                  End If;
                   
                   ListaNotas.cnTABSOLCOD :=  lpad(trim(ListaNotas.cnTABSOLCOD),8,'0');
                   ListaNotas.cnTABSOLSQ  :=  lpad(trim(ListaNotas.cnTABSOLSQ),4,'0');
                   
                   -- alimenta a Variavel informando quantas notas tem para este agrupamento

                   If Listacargacli.ccCteGlobalizado = 'N' Then
                   -- Agrupamento CTe Normal
                      vAuxiliarT  := ListaNotas.cnCLIREM    || ListaNotas.cnCLIDEST;  --|| ListaNotas.cnCLIENDDEST;
                   ElsIf Listacargacli.ccCteGlobalizado = 'R' Then
                   -- Agrupamento CTe Globalizado Destinatario
                      vAuxiliarT := '61139432000172      ' || ListaNotas.cnCLIDEST;  
                   ElsIf Listacargacli.ccCteGlobalizado = 'D' Then
                   -- Agrupamento CTe Globalizado Remetente
                      vAuxiliarT := ListaNotas.cnCLIREM    ||  '61139432000172      ';
                   End If;
                   
                   ListaVaux.cnContaNotas := pAgrupamentoEmissao(vAuxiliarT).Asinteger;

                   IF nvl(ListaNotas.cnEntregaCol,'X') = 'X' Then
                      if  nvl(ListaNotas.cnEntregaCol2,'VAZIO') = 'VAZIO' Then
                            tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Nao foi possivel definir entrega e coleta' || chr(10) ;
                            P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                            ListaNotas.cnEntregaCol := 'C';
                      Else
                         ListaNotas.cnEntregaCol := substr(ListaNotas.cnEntregaCol2,1,1);
                      End If;
                   End if;      

                 begin
                   select cl.glb_cliente_razaosocial
                      into ListaVaux.cnNomeSacado
                   from TDVADM.T_glb_cliente cl
                   where cl.glb_cliente_cgccpfcodigo = ListaNotas.cnCLISAC;   
                 exception
                   When NO_DATA_FOUND Then
                     ListaVaux.cnNomeSacado := 'NOME Nao LOCALIZADO';
                 End ;  

                 -- Se for Devolucao ou reentrega
                 begin
                     -- Inicializa as varias de Complemento
                     tpConConhecimento.Con_Conhecimento_Flagcomplemen := Null;
                     tpConhecComplemento.Con_Conhecimento_Codigo := Null;
                     tpConhecComplemento.Con_Conhecimento_Serie := Null;
                     tpConhecComplemento.Glb_Rota_Codigo := Null;
                     tpConhecComplemento.Con_Conhecimento_Codigoorigem := Null;
                     tpConhecComplemento.Con_Conhecimento_Serieorigem := Null;
                     tpConhecComplemento.Glb_Rota_Codigoorigem := Null;
                     
                     
                     if trim(ListaCargaCli.ccTPCARGACLI) = '13' Then -- REENTREGA
                         select *
                           into tpNotaCte
                         from TDVADM.T_arm_notacte c
                         where 0 = 0
--                           and c.arm_notacte_codigo = ListaNotas.cnNOTA
--                           and c.glb_cliente_cgccpfremetente = ListaNotas.cnCLIREM
 --                          and c.arm_nota_serie = ListaNotas.cnSERIENF
                           and c.arm_nota_sequencia  = ListaNotas.cnSequencia
                           and c.arm_notacte_codigo = 'RE';
                           
                           tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'REENTREGA - COLETA ANTERIOR: ' || ListaNotas.cnNRCOLETA || ' - ATUAL: ' || tpNotaCte.Arm_Coleta_Ncompra ; 
                           vAuxiliarchar :=  fn_InsereLogGeracao;
   
                         ListaNotas.cnORIGEM        := tpNotaCte.Glb_Localidade_Codigoorigem;
                         ListaNotas.cnDESTINO       := tpNotaCte.Glb_Localidade_Codigodestino;
                         ListaNotas.cnCOLETA        := tpNotaCte.Glb_Localidade_Codigoorigem;
                         ListaNotas.cnENTREGA       := tpNotaCte.Glb_Localidade_Codigodestino;
                         ListaNotas.cnNRCOLETA      := tpNotaCte.Arm_Coleta_Ncompra;
                         ListaNotas.cnNrColetaCiclo := tpNotaCte.Arm_Coleta_Ciclo;
                         ListaNotas.cnTABSOLCOD     := lpad(nvl(trim(tpNotaCte.Arm_Nota_Tabsolcod),SemTabelaCodigo),8,'0');
                         ListaNotas.cnTABSOLSQ      := lpad(nvl(trim(tpNotaCte.Arm_Nota_Tabsolsq),SemTabelaSaque),4,'0');
                         ListaNotas.cnTABSOL        := tpNotaCte.Arm_Nota_Tabsol;
                         if ListaCargaCli.ccTPCARGACLIPESQ = '11' Then
                            ListaNotas.cnTIPOCARGA     := 'LOTACAO';
                         Else   
                            ListaNotas.cnTIPOCARGA     := 'FRACIONADO';
                         End If;   
                         ListaNotas.cnEntregaCol := 'E';
                      Elsif trim(ListaCargaCli.ccTPCARGACLI) = '14' Then  -- DEVOLUCAO   
                         select *
                           into tpNotaCte
                         from TDVADM.T_arm_notacte c
                         where 0 = 0
--                           and c.arm_notacte_codigo = ListaNotas.cnNOTA
--                           and c.glb_cliente_cgccpfremetente = ListaNotas.cnCLIREM
--                           and c.arm_nota_serie = ListaNotas.cnSERIENF
                           and c.arm_nota_sequencia  = ListaNotas.cnSequencia
                           and c.arm_notacte_codigo = 'DE';

                           tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'DEVOLUCAO - COLETA ANTERIOR: ' || ListaNotas.cnNRCOLETA || ' - ATUAL: ' || tpNotaCte.Arm_Coleta_Ncompra ; 
                           vAuxiliarchar :=  fn_InsereLogGeracao;

                         ListaNotas.cnORIGEM        := tpNotaCte.Glb_Localidade_Codigoorigem;
                         ListaNotas.cnDESTINO       := tpNotaCte.Glb_Localidade_Codigodestino;
                         ListaNotas.cnCOLETA        := tpNotaCte.Glb_Localidade_Codigoorigem;
                         ListaNotas.cnENTREGA       := tpNotaCte.Glb_Localidade_Codigodestino;
                         ListaNotas.cnNRCOLETA      := tpNotaCte.Arm_Coleta_Ncompra;
                         ListaNotas.cnNrColetaCiclo := tpNotaCte.Arm_Coleta_Ciclo;
                         ListaNotas.cnTABSOLCOD     := lpad(nvl(trim(tpNotaCte.Arm_Nota_Tabsolcod),SemTabelaCodigo),8,'0');
                         ListaNotas.cnTABSOLSQ      := lpad(nvl(trim(tpNotaCte.Arm_Nota_Tabsolsq),SemTabelaSaque),4,'0');
                         ListaNotas.cnTABSOL        := tpNotaCte.Arm_Nota_Tabsol;
                         if ListaCargaCli.ccTPCARGACLIPESQ = '11' Then
                            ListaNotas.cnTIPOCARGA     := 'LOTACAO';
                         Else   
                            ListaNotas.cnTIPOCARGA     := 'FRACIONADO';
                         End If;   
                         ListaNotas.cnEntregaCol := 'E';
                      Elsif trim(ListaCargaCli.ccTPCARGACLI) = '25' Then  -- COMPLEMENTO   
                         select *
                           into tpNotaCte
                         from TDVADM.T_arm_notacte c
                         where 0 = 0
--                           and c.arm_notacte_codigo = ListaNotas.cnNOTA
--                           and c.glb_cliente_cgccpfremetente = ListaNotas.cnCLIREM
--                           and c.arm_nota_serie = ListaNotas.cnSERIENF
                           and c.arm_nota_sequencia  = ListaNotas.cnSequencia
                           and c.arm_notacte_codigo = 'CC';

                         tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'COMPLEMENTO - COLETA ANTERIOR: ' || ListaNotas.cnNRCOLETA || ' - ATUAL: ' || tpNotaCte.Arm_Coleta_Ncompra ; 
                         vAuxiliarchar :=  fn_InsereLogGeracao;

                         ListaNotas.cnORIGEM        := tpNotaCte.Glb_Localidade_Codigoorigem;
                         ListaNotas.cnDESTINO       := tpNotaCte.Glb_Localidade_Codigodestino;
                         ListaNotas.cnCOLETA        := tpNotaCte.Glb_Localidade_Codigoorigem;
                         ListaNotas.cnENTREGA       := tpNotaCte.Glb_Localidade_Codigodestino;
                         ListaNotas.cnNRCOLETA      := tpNotaCte.Arm_Coleta_Ncompra;
                         ListaNotas.cnNrColetaCiclo := tpNotaCte.Arm_Coleta_Ciclo;
                         ListaNotas.cnTABSOLCOD     := lpad(nvl(trim(tpNotaCte.Arm_Nota_Tabsolcod),SemTabelaCodigo),8,'0');
                         ListaNotas.cnTABSOLSQ      := lpad(nvl(trim(tpNotaCte.Arm_Nota_Tabsolsq),SemTabelaSaque),4,'0');
                         ListaNotas.cnTABSOL        := tpNotaCte.Arm_Nota_Tabsol;
                         if ListaCargaCli.ccTPCARGACLIPESQ = '11' Then
                            ListaNotas.cnTIPOCARGA     := 'LOTACAO';
                         Else   
                            ListaNotas.cnTIPOCARGA     := 'FRACIONADO';
                         End If;   
                           
                         tpConConhecimento.Con_Conhecimento_Flagcomplemen := 'S';
                         tpConhecComplemento.Con_Conhecimento_Codigo := '';
                         tpConhecComplemento.Con_Conhecimento_Serie := '';
                         tpConhecComplemento.Glb_Rota_Codigo := '';
                         tpConhecComplemento.Con_Conhecimento_Codigoorigem := tpNotaCte.Con_Conhecimento_Codigoa;
                         tpConhecComplemento.Con_Conhecimento_Serieorigem := tpNotaCte.Con_Conhecimento_Seriea;
                         tpConhecComplemento.Glb_Rota_Codigoorigem := tpNotaCte.Glb_Rota_Codigoa;
                         
                         ListaNotas.cnEntregaCol := 'E';
                      Elsif trim(ListaCargaCli.ccTPCARGACLI) = '26' Then  -- REMOCAO
                         ListaNotas.cnEntregaCol := 'E';
                      End If;
                       
                 exception
                   When NO_DATA_FOUND Then
                        tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Nao foi Localizada a Referencia para Devolicao/Entrega' || chr(10) ;
                        P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                   end;
        

                   if ListaNotas.cnTABSOLCOD <> SemTabelaCodigo and ListaNotas.cnTABSOLSQ = SemTabelaSaque Then
                      if ListaNotas.cnTABSOL = 'S' Then
                         select Max(sf.slf_solfrete_saque)
                           into ListaNotas.cnTABSOLSQ
                         from TDVADM.T_slf_solfrete sf
                         where sf.slf_solfrete_codigo = ListaNotas.cnTABSOLCOD
                           and nvl(sf.slf_solfrete_status,'N') = 'N';
                           
                      Else
                         select Max(t.slf_tabela_saque)
                           into ListaNotas.cnTABSOLSQ
                         from TDVADM.T_slf_tabela t
                         where t.slf_tabela_codigo = ListaNotas.cnTABSOLCOD
                           and nvl(t.slf_tabela_status,'N') <> 'S';
                      End If; 
                      if lpad(trim(nvl(ListaNotas.cnTABSOLSQ,'0')),4,'0') = SemTabelaSaque Then
                            tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Nao foi possivel definir o Saque da Tabela/Solicitac?o' || chr(10) ;
                            P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                        
                      End If;
                   End If;   


                   if ListaNotas.cnTIPOTRANSP is null then
                      ListaNotas.cnTIPOTRANSP := ListaNotas.cnTIPOTRANSP;
                   End IF;  
                   if ListaNotas.cnVIRTUAL is null Then
                      ListaNotas.cnTIPOTRANSP := ListaNotas.cnTIPOTRANSP;
                   End IF;  
                   if ListaNotas.cnVeicCarreg is null Then
                      ListaNotas.cnTIPOTRANSP := ListaNotas.cnTIPOTRANSP;
                   End IF;  
                     
        
                   --Verifico se o conhecimento criado, vem de alguma nota com redespacho
                   Select Count(*) 
                      Into vControlRedespacho 
                   From TDVADM.T_arm_notaredespacho re
                   Where lpad(re.arm_nota_numero, 9, '0') = lpad(Trim(ListaNotas.cnNOTA), 9, '0')
                    And Trim(re.glb_cliente_cgccpfremetente) = Trim(ListaNotas.cnCLIREM)
                    And Trim(upper(re.arm_nota_serie)) = Trim(upper(ListaNotas.cnSERIENF))
                    And re.arm_nota_sequencia = ListaNotas.cnSequencia;
                              
                    --Casotenha encontrado algum registro
                    If ( vControlRedespacho > 0 ) Then
                      --Busco todos os dados da nota
                      Begin 
                         Select * Into tpArmNotaRedespacho
                         From TDVADM.T_arm_notaredespacho re
                         Where lpad(re.arm_nota_numero, 9, '0') = lpad(Trim(ListaNotas.cnNOTA), 9, '0')
                           And Trim(re.glb_cliente_cgccpfremetente) = Trim(ListaNotas.cnCLIREM)
                           And Trim(upper(re.arm_nota_serie)) = Trim(upper(ListaNotas.cnSERIENF))
                           and re.arm_notaservadd_codigo is not null
                           And re.arm_nota_sequencia = ListaNotas.cnSequencia
                           and rownum = 1;
                      exception
                        When NO_DATA_FOUND Then
                            tpLogGeracaO.Con_Loggeracao_ObsgeracaoHTML := 'Nota sem registro de REDESPACHO ' || lpad(Trim(ListaNotas.cnNOTA), 9, '0') || '-' || Trim(ListaNotas.cnCLIREM) || '-' || Trim(upper(ListaNotas.cnSERIENF)) || chr(10) ;
                            P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                        End;     
                    End If;                                  
                 




                   -- Faco esta classificacao ante de entrar no LOOP      
                   -- SE Nao VIER DE UMA ASN
--                   IF ListaNotas.cnTIPOCARGA IS NULL THEN     
--                      IF fn_EColetaExpressa(ListaNotas.cnNRCOLETA,ListaNotas.cnNrColetaCiclo) = 'S' THEN
--                         ListaNotas.cnTIPOCARGA := 'EXPRESSA';
--                         
--                      ELSE
--                         ListaNotas.cnTIPOCARGA := 'FRACIONADO';
--                      END IF;                          
--                   END IF;
                   

                   
                   tpLogGeracao.Arm_Nota_Numero             := ListaNotas.cnNOTA;
                   tpLogGeracao.Glb_Cliente_Cgccpfremetente := ListaNotas.cnCLIREM;



-- Verifica se existe alguj parceiro trocando as localidades de entrega e coleta
          
           tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'LOC Coleta: ' || ListaNotas.cnCOLETA || ' - Antes Origem / Destino a serem procurado: cnORIGEM: '||ListaNotas.cnORIGEM||' ListaNotas.cnDESTINO: '||ListaNotas.cnDESTINO||' ListaVaux.cnKM: '||ListaVaux.cnKM; 
           vAuxiliarchar :=  fn_InsereLogGeracao;

  
            V_CONTADOR2 := V_CONTADOR2 + 1;
--            If  Trim(P_ARM_CARREGAMENTO) = '255346' Then          
              -- Verifico se a coleta possui um parceiro do tipo Coleta          
              Select Count(*) Into vControl
              From 
                TDVADM.T_arm_coletaparceiro parc
              Where
                parc.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
                And parc.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo
                And parc.arm_coletatppar_codigo = 'CC';
              

              --caso tenha algum parceiro do tipo coleta, passo a utilizar a localidade do endereco

              If ( vControl >  0 ) Then 
                Select 
                  endereco.glb_localidade_codigo Into ListaNotas.cnORIGEM
                From
                  TDVADM.T_arm_coletaparceiro parc,
                  TDVADM.T_glb_cliend endereco
                Where
                  parc.glb_cliente_cgccpfpar = endereco.glb_cliente_cgccpfcodigo
                  And parc.glb_tpcliend_codigopar = endereco.glb_tpcliend_codigo
                  And parc.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
                  And parc.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo
                  And parc.arm_coletatppar_codigo = 'CC';

                If ( nvl(ListaCargaCli.ccColetaCobra,'N') = 'S' )  and  
                   ( nvl(ListaCargaCli.ccMudaOrigemCC,'S') = 'S' )  and
                   ( nvl(ListaNotas.cnTABSOLCOD,SemTabelaCodigo) = SemTabelaCodigo ) Then
                   vAuxiliarT := trim(fn_RetLocalidadeArmazem(P_ARM_ARMAZEM));
                   ListaNotas.cnCOLETA := vAuxiliarT;
                Else  
                  ListaNotas.cnCOLETA := ListaNotas.cnORIGEM;
                End If;

              End If;
            

              Select Count(*) Into vControl
              From 
                TDVADM.T_arm_coletaparceiro parc
              Where
                parc.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
                And parc.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo
                And parc.arm_coletatppar_codigo = 'CE';
              
              --caso tenha algum parceiro do tipo coleta, passo a utilizar a localidade do endereco
              If ( vControl >  0 ) Then 
                Select 
                  endereco.glb_localidade_codigo Into ListaNotas.cnDESTINO
                From
                  TDVADM.T_arm_coletaparceiro parc,
                  TDVADM.T_glb_cliend endereco
                Where
                  parc.glb_cliente_cgccpfpar = endereco.glb_cliente_cgccpfcodigo
                  And parc.glb_tpcliend_codigopar = endereco.glb_tpcliend_codigo
                  And parc.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
                  And parc.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo
                  And parc.arm_coletatppar_codigo = 'CE';
                  
                  ListaNotas.cnENTREGA := ListaNotas.cnDESTINO;
              End If;
            





                   ListaVaux.cnCODIGOORI  := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnORIGEM, 'IBC'), 8);
                   if trim(ListaVaux.cnCODIGOORI) = 'SIBGE' then
                      tpLogGeracaO.Con_Loggeracao_ErroHTML :=  fni_retcenario('LOC ORIGEM SEM IBGE');
                      P_RETORNOPROCESSAMENTO :=  fn_InsereLogGeracao;
                   Else
                      ListaVaux.cnCODIGOREGO := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnORIGEM, 'IBR'), 1);
                   End If;
                   ListaVaux.cnCODIGODES  := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnDESTINO, 'IBC'), 8);
                   if trim(ListaVaux.cnCODIGODES) = 'SIBGE' then
                      tpLogGeracaO.Con_Loggeracao_ErroHTML :=  fni_retcenario('LOC DESTINO SEM IBGE');
                      P_RETORNOPROCESSAMENTO :=  fn_InsereLogGeracao;
                   Else
                      ListaVaux.cnCODIGOREGD := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnDESTINO, 'IBR'), 1);
                   End If;
                   
                   if trim(tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC'))  = 'SIBGE' Then
                      tpLogGeracaO.Con_Loggeracao_ErroHTML :=  fni_retcenario('LOC COLETA SEM IBGE');
                      P_RETORNOPROCESSAMENTO :=  fn_InsereLogGeracao;
                   End If;   
                   
                   if trim(tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC'))  = 'SIBGE' Then
                      tpLogGeracaO.Con_Loggeracao_ErroHTML :=  fni_retcenario('LOC ENTREGA SEM IBGE');
                      P_RETORNOPROCESSAMENTO :=  fn_InsereLogGeracao;
                   End If;   
                   

                   
                   

--                 ListaVaux.cnKM := fni_ConsultaKM(ListaNotas.cnORIGEM,ListaNotas.cnDESTINO);
                   if ListaCargaCli.ccTABKM is null Then
                      ListaVaux.cnKM := fni_ConsultaKM(ListaNotas.cnCOLETA,ListaNotas.cnENTREGA);
                      tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Pegou Km com sem uso de Tabela - ' || ListaCargaCli.ccTABKM || ' Retornou KM - ' || ListaVaux.cnKM || ' Origem - ' || ListaNotas.cnCOLETA || ' Destino ' || ListaNotas.cnENTREGA;
                   Else
--                      ListaVaux.cnKM := fni_PercExiste(ListaCargaCli.ccTABKM,rpad(tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'IBC'),8),rpad(tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'IBC'),8));
--                      tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Pegou Km com uso de Tabela - ' || ListaCargaCli.ccTABKM || ' Retornou KM - ' || ListaVaux.cnKM || ' Origem - ' || rpad(tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'IBC'),8) || ' Destino ' || rpad(tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'IBC'),8);
                      ListaVaux.cnKM := fni_ConsultaKM(ListaNotas.cnCOLETA,ListaNotas.cnENTREGA);
                      tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Pegou Km com uso de Tabela - ' || ListaCargaCli.ccTABKM || ' Retornou KM - ' || ListaVaux.cnKM || ' Origem - ' || ListaNotas.cnCOLETA || ' Destino ' || ListaNotas.cnENTREGA;
                      P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                   End If;
                   if nvl(ListaVaux.cnKM,0) = 0  and ( ListaCargaCli.ccUSAFAIXAKM = 'S') and ( ListaCargaCli.ccTABKM is null )  Then
                      tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Retornou KM 0 (zero), VERIFICAR TABELA DE KM ORIGEM - ' || ListaNotas.cnCOLETA || ' DESTINO - ' || ListaNotas.cnENTREGA ;
                      P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                   Else   
                      if ( ListaVaux.cnKM < 0 ) and ( ListaCargaCli.ccUSAFAIXAKM = 'S') then
                         tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Busca de KM Com ERRO : ORIGEM ' || ListaNotas.cnCOLETA || ' - DESTINO ' || ListaNotas.cnENTREGA;
                         If nvl(ListaVaux.cnKM,0) = wservice.pkg_web.CLocalidadeNaoEncontrada Then
                             tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Localidade Nao Encontrada na TDV';
                         ElsIf nvl(ListaVaux.cnKM,0) = wservice.pkg_web.CErroAcessandoGOOGLE Then
                             tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Erro Acessando o Google';
                         ElsIf nvl(ListaVaux.cnKM,0) = wservice.pkg_web.CErroLendoXML Then
                             tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Erro Lendo o XML';
                         ElsIf nvl(ListaVaux.cnKM,0) = wservice.pkg_web.CSemROTA Then
                             tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Localidade Nao acessivel por veiculo';
                         ElsIf nvl(ListaVaux.cnKM,0) = wservice.pkg_web.CKmErrado Then
                             tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Km Nao numerico';
                         End IF;
                         vAuxiliarT := fn_InsereLogGeracao;
                      End If;
                     
                      if ListaVaux.cnKM < 0 Then
                         ListaVaux.cnKM := 0;
                       -- Sirlano 24/07/2017
                       -- KMMinimo e somente para o mesmo municipio
                       -- Se achou KM usa independente do minimo
--                      ElsIf ListaVaux.cnKM < ListaCargaCli.ccKMMinimo Then
--                         ListaVaux.cnKM := ListaCargaCli.ccKMMinimo;
                      End If;    
                   End If;

                    if ( ListaVaux.cnContaQuimico = ListaVaux.cnContaTodaNotas ) and 
                       ( ListaVaux.cnContaFornec = 1 ) and
                       ( ListaNotas.cnGRUPOECSAC in ('0020','0074') ) Then
                       -- Percentual do Quimico vira 1

                       if  ( ListaVaux.cnSomaPesoQP > 6000 ) and ( trunc(sysdate) < to_date('15/12/2014','dd/mm/yyyy') ) Then 
                         if trim(ListaCargaCli.ccTPCARGACLIPESQ) <> '11' Then
                            tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Produto Quimico Incompativel Carga Tem que ser Lotacao ';
                            P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                         End If;   
                       End If;
                       
                       if trunc(sysdate) < to_date('15/12/2014','dd/mm/yyyy') Then
                           if trim(ListaCargaCli.ccTPCARGACLIPESQ) = '11' Then
                              tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Produto Quimico Compativel Carga Tem que ser Lotacao ';
                              P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                           End If;   
                       End If;
                       
                    End If;



                   
                   if ( 
                        ( ListaNotas.cnGRUPOECSAC in ('0020','0074') ) and 
                        ( nvl(ListaNotas.cnTABSOLCOD,SemTabelaCodigo) = SemTabelaCodigo ) and 
                        ( trim(ListaCargaCli.ccTPCARGACLIPESQ) = '11' ) and -- LOTACAO
                        ( ListaQuebras.CONTRATO <> QualquerContrato)
                      ) Then
                      
                        -- Verifica se e QUIMICO INCOMPATIVEL
                        --insert into dropme m (a , x) values ('Lucas1303', 'coleta: ' ||ListaNotas.cnNRCOLETA);
                        
                    IF ( ( nvl(ListaNotas.cnONU,OnuNaoQuimico) <> OnuNaoQuimico ) AND (ListaQuebras.GRUPOEC  in ('0020','0074')) ) Then
               
                         -- a classificac?o 00 indica que Nao houve resposta do Cliente.
                         -- e o produto e quimico isot e <> de 9999         
                        If ( v_CLASSIFCLI <> ProdutoQuimicoAguardRetorno) AND ( nvl(ListaNotas.cnONU,OnuNaoQuimico) <> OnuNaoQuimico )  THEN

                            if ( ListaVaux.cnSomaPesoQP  < 6000 ) and ( trunc(sysdate) < to_date('15/12/2014','dd/mm/yyyy') ) Then

                                 if ( nvl(v_FORMULARIOCLI,ProdutoQuimicoSemFormulario) <> ProdutoQuimicoSemFormulario ) AND 
                                    ( NVL(v_FORMULARIOCLI,ProdutoQuimicoSemFormulario) <> '999999' ) then
                                    if ( ListaVaux.cnContaQuimico = ListaVaux.cnContaTodaNotas ) and 
                                       ( ListaVaux.cnSomaPesoQP  < 6000 ) and 
                                       ( ListaVaux.cnContaFornec = 1 ) Then
                                       -- Percentual do Quimico vira 1
      --                                 ListaCargaCli.ccPERCTQM := ListaCargaCli.ccPERCTQM;            
      --                              Else
                                       tpLogGeracaO.Con_Loggeracao_ErroHTML := 'PRODUTO QUIMICO COMPATIVEL NAO PODE SER LOTAC?O :' || chr(13) || 
                                                                           tpLogGeracaO.Con_Loggeracao_ErroHTML ;
                                       P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                         
                                    End If;  
                                 Else
                                     tpLogGeracaO.Con_Loggeracao_ErroHTML := 'PRODUTO QUIMICO COMPATIVEL NAO PODE SER LOTAC?O :' || chr(13) || 
                                                                         tpLogGeracaO.Con_Loggeracao_ErroHTML ;
                                     P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                 End If;

                            Else
                                IF trunc(sysdate) < to_date('15/12/2014','dd/mm/yyyy') Then
                                   tpLogGeracaO.Con_Loggeracao_ErroHTML := 'PRODUTO QUIMICO COMPATIVEL NAO PODE SER LOTAC?O :' || chr(13) || 
                                                                       tpLogGeracaO.Con_Loggeracao_ErroHTML ;
                                   P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                End IF;   
                            End If;      
                        End If;    

                      
                    End If;  
                   End If;
                      
                   ListaVaux.cnEGrandeFluxo := 'N';   
                   if ( 
                        (ListaQuebras.CONTRATO in ('C5900011012',       -- 0020 - MRO-VALE-0314-CS2781910
                                                   'C2014030105')) and  -- 0020 - MRO-VALE MANGANES-0314-CS2781910/M


--                        ( ListaNotas.cnGRUPOECSAC in ('0020','0074') ) and 
                        ( nvl(ListaNotas.cnTABSOLCOD,SemTabelaCodigo) = SemTabelaCodigo ) and 
                        ( trim(ListaCargaCli.ccTPCARGACLIPESQ) in ('11','12') ) and -- LOTACAO
                        ( ListaQuebras.CONTRATO <> QualquerContrato) and 
                        ( trunc(sysdate) <= to_date('30/03/2019','dd/mm/yyyy') )
                      ) Then
                         -- Verifico se o Local de Origem e Porto
                         -- Para ser Lotacao tem que ser um CHINES
                         select count(*)
                           into vAuxiliarnumerico
                         From TDVADM.T_glb_cliente cl
                         where cl.glb_cliente_cgccpfcodigo = ListaNotas.cnCLIREM
                           and nvl(cl.glb_cliente_nacional,'N') <> 'N';
                         
                        -- Se for Chines verifica se e Aeroporto 
                        If vAuxiliarnumerico <> 0 Then 
                            Begin
                                select cl.xml_clientelib_rateia
                                  into ListaCargaCli.ccRATEIA
                                From TDVADM.T_xml_clientelib cl
                                where cl.glb_cliente_cgccpfcodigo = ListaNotas.cnCLIREM
                                  and cl.xml_clientelib_ativo = 'S'
                                  and cl.xml_clientelib_flagaeroporto = 'S'
                                  and cl.fcf_tpcarga_codigo = ListaCargaCli.ccTPCARGACLIPESQ
    -- Alterado em 09/10/2015 Sirlano
    --                              and trim(cl.glb_localidade_codigoori) = trim(decode(trim(cl.glb_localidade_codigoori),'99999','99999',tdvadm.fn_busca_codigoibge1(ListaNotas.cnORIGEM,cl.xml_clientelib_tpcodori)))
    --                              and trim(cl.glb_localidade_codigodes) = trim(decode(trim(cl.glb_localidade_codigodes),'99999','99999',tdvadm.fn_busca_codigoibge1(ListaNotas.cnDESTINO,cl.xml_clientelib_tpcoddes)))
                                  and trim(cl.glb_localidade_codigoori) = trim(decode(trim(cl.glb_localidade_codigoori),'99999','99999',tdvadm.fn_busca_codigoibge1(ListaNotas.cnCOLETA,cl.xml_clientelib_tpcodori)))
                                  and trim(cl.glb_localidade_codigodes) = trim(decode(trim(cl.glb_localidade_codigodes),'99999','99999',tdvadm.fn_busca_codigoibge1(ListaNotas.cnENTREGA,cl.xml_clientelib_tpcoddes)))
                                  and cl.xml_clientelib_dtvigencia = (select max(cl1.xml_clientelib_dtvigencia)
                                                                      from TDVADM.T_xml_clientelib cl1
                                                                      where cl1.glb_cliente_cgccpfcodigo     = cl.glb_cliente_cgccpfcodigo
                                                                        and cl1.xml_clientelib_ativo         = cl.xml_clientelib_ativo
                                                                        and cl1.xml_clientelib_flagporto     = cl.xml_clientelib_flagporto
                                                                        and cl1.xml_clientelib_flaggf        = cl.xml_clientelib_flaggf
                                                                        and cl1.xml_clientelib_flagaeroporto = cl.xml_clientelib_flagaeroporto
                                                                        and cl1.glb_localidade_codigoori     = cl.glb_localidade_codigoori
                                                                        and cl1.xml_clientelib_tpcodori      = cl.xml_clientelib_tpcodori
                                                                        and cl1.glb_localidade_codigodes     = cl.glb_localidade_codigodes
                                                                        and cl1.xml_clientelib_tpcoddes      = cl.xml_clientelib_tpcoddes
                                                                        and cl1.fcf_tpcarga_codigo           = cl.fcf_tpcarga_codigo);
                                    vAuxiliarnumerico := 1;
                            exception
                              When NO_DATA_FOUND Then
                                   -- Conta novamente se e Chines.
                                   select count(*)
                                     into vAuxiliarnumerico
                                   From TDVADM.T_glb_cliente cl
                                   where cl.glb_cliente_cgccpfcodigo = ListaNotas.cnCLIREM
                                     and nvl(cl.glb_cliente_nacional,'N') <> 'N';
                              End;

                         
                        End If;
                         
                         -- Se Nao For olho se e Grande Fluxo
                         If ( vAuxiliarnumerico = 0 ) and 
                            ( ListaQuebras.CONTRATO not in ('C590030755/2','C590030755/3') ) and
                            ( trunc(sysdate) <= to_date('30/03/2019','dd/mm/yyyy') ) Then
                            tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Remetente ' || f_mascara_cgccpf(trim(ListaNotas.cnCLIREM)) || ' Nao e CHINES, Testando Grande Fluxo' || chr(13);
                            Begin
                                select cl.xml_clientelib_rateia
                                  into ListaCargaCli.ccRATEIA
                                From TDVADM.T_xml_clientelib cl
                                where cl.glb_cliente_cgccpfcodigo = ListaNotas.cnCLIREM
                                  and cl.xml_clientelib_ativo = 'S'
                                  and cl.xml_clientelib_flaggf = 'S'
                                  and cl.fcf_tpcarga_codigo = ListaCargaCli.ccTPCARGACLIPESQ
    -- Alterado em 09/10/2015 Sirlano
    --                              and trim(cl.glb_localidade_codigoori) = trim(decode(trim(cl.glb_localidade_codigoori),'99999','99999',tdvadm.fn_busca_codigoibge1(ListaNotas.cnORIGEM,cl.xml_clientelib_tpcodori)))
    --                              and trim(cl.glb_localidade_codigodes) = trim(decode(trim(cl.glb_localidade_codigodes),'99999','99999',tdvadm.fn_busca_codigoibge1(ListaNotas.cnDESTINO,cl.xml_clientelib_tpcoddes)))
                                  and trim(cl.glb_localidade_codigoori) = trim(decode(trim(cl.glb_localidade_codigoori),'99999','99999',tdvadm.fn_busca_codigoibge1(ListaNotas.cnCOLETA,cl.xml_clientelib_tpcodori)))
                                  and trim(cl.glb_localidade_codigodes) = trim(decode(trim(cl.glb_localidade_codigodes),'99999','99999',tdvadm.fn_busca_codigoibge1(ListaNotas.cnENTREGA,cl.xml_clientelib_tpcoddes)))
                                  and cl.xml_clientelib_dtvigencia = (select max(cl1.xml_clientelib_dtvigencia)
                                                                      from TDVADM.T_xml_clientelib cl1
                                                                      where cl1.glb_cliente_cgccpfcodigo     = cl.glb_cliente_cgccpfcodigo
                                                                        and cl1.xml_clientelib_ativo         = cl.xml_clientelib_ativo
                                                                        and cl1.xml_clientelib_flagporto     = cl.xml_clientelib_flagporto
                                                                        and cl1.xml_clientelib_flaggf        = cl.xml_clientelib_flaggf
                                                                        and cl1.xml_clientelib_flagaeroporto = cl.xml_clientelib_flagaeroporto
                                                                        and cl1.glb_localidade_codigoori     = cl.glb_localidade_codigoori
                                                                        and cl1.xml_clientelib_tpcodori      = cl.xml_clientelib_tpcodori
                                                                        and cl1.glb_localidade_codigodes     = cl.glb_localidade_codigodes
                                                                        and cl1.xml_clientelib_tpcoddes      = cl.xml_clientelib_tpcoddes
                                                                        and cl1.fcf_tpcarga_codigo           = cl.fcf_tpcarga_codigo);
                                    vAuxiliarnumerico := 1;
                            exception
                              When NO_DATA_FOUND Then
                                vAuxiliarnumerico := 0;
                              End;
                            if ( vAuxiliarnumerico = 0 ) Then 
                               -- Se Nao achou para a Carga Pesquisa Ve se encontra para outro tipo de carga
                                Begin
                                select cl.fcf_tpcarga_codigo
                                  into vAuxiliarT
                                From TDVADM.T_xml_clientelib cl
                                where cl.glb_cliente_cgccpfcodigo = ListaNotas.cnCLIREM
                                  and cl.xml_clientelib_ativo = 'S'
                                  and cl.xml_clientelib_flaggf = 'S'
                                  and cl.fcf_tpcarga_codigo <> ListaCargaCli.ccTPCARGACLIPESQ
-- Alterado em 09/10/2015 sirlano
--                                  and trim(cl.glb_localidade_codigoori) = trim(decode(trim(cl.glb_localidade_codigoori),'99999','99999',tdvadm.fn_busca_codigoibge1(ListaNotas.cnORIGEM,cl.xml_clientelib_tpcodori)))
--                                  and trim(cl.glb_localidade_codigodes) = trim(decode(trim(cl.glb_localidade_codigodes),'99999','99999',tdvadm.fn_busca_codigoibge1(ListaNotas.cnDESTINO,cl.xml_clientelib_tpcoddes)))
                                  and trim(cl.glb_localidade_codigoori) = trim(decode(trim(cl.glb_localidade_codigoori),'99999','99999',tdvadm.fn_busca_codigoibge1(ListaNotas.cnCOLETA,cl.xml_clientelib_tpcodori)))
                                  and trim(cl.glb_localidade_codigodes) = trim(decode(trim(cl.glb_localidade_codigodes),'99999','99999',tdvadm.fn_busca_codigoibge1(ListaNotas.cnENTREGA,cl.xml_clientelib_tpcoddes)))
                                  and cl.xml_clientelib_dtvigencia = (select max(cl1.xml_clientelib_dtvigencia)
                                                                      from TDVADM.T_xml_clientelib cl1
                                                                      where cl1.glb_cliente_cgccpfcodigo     = cl.glb_cliente_cgccpfcodigo
                                                                        and cl1.xml_clientelib_ativo         = cl.xml_clientelib_ativo
                                                                        and cl1.xml_clientelib_flagporto     = cl.xml_clientelib_flagporto
                                                                        and cl1.xml_clientelib_flaggf        = cl.xml_clientelib_flaggf
                                                                        and cl1.xml_clientelib_flagaeroporto = cl.xml_clientelib_flagaeroporto
                                                                        and cl1.glb_localidade_codigoori     = cl.glb_localidade_codigoori
                                                                        and cl1.xml_clientelib_tpcodori      = cl.xml_clientelib_tpcodori
                                                                        and cl1.glb_localidade_codigodes     = cl.glb_localidade_codigodes
                                                                        and cl1.xml_clientelib_tpcoddes      = cl.xml_clientelib_tpcoddes
                                                                        and cl1.fcf_tpcarga_codigo           = cl.fcf_tpcarga_codigo);
                                vAuxiliarnumerico := 1; 

                                exception
                                  When OTHERS Then
                                     vAuxiliarnumerico := 0;
                                     vAuxiliarT := '00';
                                  End ;
                                  
                                 if vAuxiliarT <> '00' Then 
                                    if trim(vAuxiliarT) <> trim(ListaCargaCli.ccTPCARGACLIPESQ) Then
                                       tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Remetente ' || f_mascara_cgccpf(trim(ListaNotas.cnCLIREM)) || ' Tem GRANDE FLUXO. para Carga tipo - ' || trim(vAuxiliarT) || chr(10) || 
                                                                                                               'Verifique a Origem  ' || ListaNotas.cnColeta    || chr(13) ||
                                                                                                               '            Destino ' || ListaNotas.cnEntrega || chr(13);
                                    Else
                                       tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Fechando com Grande Fluxo Autorizado';
                                    End If;
                                 Else
                                    if ListaCargaCli.ccTPCARGACLIPESQ = '11' Then
                                       tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Carga Nao pode ser LOTACAO, Nao e Chines e nem GRANDE FLUXO.' || chr(10);
                                       if ListaCargaCli.ccTPCARGACLI not in ('13','14') Then
                                          tpLogGeracaO.Con_Loggeracao_ErroHTML := 'F-' || tpLogGeracaO.Con_Loggeracao_ErroHTML;
                                          vErroFatal := 'E';
                                       End If;   
                                    End If;
                                 End If;
                                 P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                            ElsIf ( vAuxiliarnumerico > 0 ) and ( instr(cCargaLotacao ,TDVADM.PKG_glb_common.Fn_QuotedStr(ListaNotas.cnTIPOCARGA)) = 0 ) and  ( ListaCargaCli.ccTPCARGACLIPESQ = '11' ) Then
                               tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || ' TIPO DE CARGA DA COLETA TEM QUE SER LOTACAO' || chr(13);
                               if ListaCargaCli.ccTPCARGACLI not in ('13','14') Then
                                  tpLogGeracaO.Con_Loggeracao_ErroHTML := 'F-' || tpLogGeracaO.Con_Loggeracao_ErroHTML;
                                  vErroFatal := 'E';
                               End If;   
                               P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                            ElsIf ( vAuxiliarnumerico > 0 ) and ( instr(cCargaFracionado,TDVADM.PKG_glb_common.Fn_QuotedStr(trim(ListaNotas.cnTIPOCARGA))) = 0 ) and ListaCargaCli.ccTPCARGACLIPESQ = '12' Then 
                               tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || ' TIPO DE CARGA DA COLETA TEM QUE SER FRACIONADO' || chr(13);
                               if ListaCargaCli.ccTPCARGACLI not in ('13','14') Then
                                  tpLogGeracaO.Con_Loggeracao_ErroHTML := 'F-' || tpLogGeracaO.Con_Loggeracao_ErroHTML;
                                  vErroFatal := 'E';
                               End If;
                            ElsIf ( vAuxiliarnumerico > 0 ) and ( instr(cCargaExpressa,TDVADM.PKG_glb_common.Fn_QuotedStr(trim(ListaNotas.cnTIPOCARGA))) > 0 ) and ( ListaCargaCli.ccTPCARGACLIPESQ = '11' ) Then 
                               tpLogGeracaO.Con_Loggeracao_ErroHTML := 'F-NOTA Nao PODE SER LOTACAO QUANDO SOLICITADO EXPRESSO :' || chr(13) || 
                                                                    tpLogGeracaO.Con_Loggeracao_ErroHTML ;
                               vErroFatal := 'E';
                               P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                               ListaNotas.cnTIPOCARGA := ListaNotas.cnTIPOCARGA;
                            End If;
                              
                         End If;
                         
                         if vAuxiliarnumerico <> 0 Then
                            ListaVaux.cnEGrandeFluxo := 'S';
                         Else
                            ListaVaux.cnEGrandeFluxo := 'N';   
                         End If;
                       
                      -- Retirar temporariamente ate final dos TESTES
                      
                      /*   
                         
                      if instr(cCargaLotacao,TDVADM.PKG_glb_common.Fn_QuotedStr(trim(ListaNotas.cnTIPOCARGA))) > 0 Then

                         

                         if vAuxiliarnumerico = 0 Then
                            tpLogGeracaO.Con_Loggeracao_ErroHTML := 'NOTA Nao PODE SER LOTACAO :' || chr(13) || 
                                                                 tpLogGeracaO.Con_Loggeracao_ErroHTML ;
                            P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                         End If;
                      Else
                         -- Verifico se o Local de Origem e Porto
                         -- Para ser Lotacao tem que ser um CHINES
                         select count(*)
                           into vAuxiliarnumerico
                         From TDVADM.T_glb_cliente cl
                         where cl.glb_cliente_cgccpfcodigo = ListaNotas.cnCLIREM
                           and nvl(cl.glb_cliente_nacional,'N') <> 'N';
                         
                         -- Se Nao For olho se e Grande Fluxo
                         If vAuxiliarnumerico > 0 Then
                            tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Remetente ' || f_mascara_cgccpf(trim(ListaNotas.cnCLIREM)) || ' E CHINES Tipo de Carga -> ' || ListaNotas.cnTIPOCARGA || '-' || cCargaLotacao || chr(13);
                         End If;
                         if vAuxiliarnumerico > 0 Then
                            tpLogGeracaO.Con_Loggeracao_ErroHTML := 'COLETA TEM QUE SER LOTACAO :' || chr(13) || 
                                                                 tpLogGeracaO.Con_Loggeracao_ErroHTML ;
                            P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                         End If;
                      End If;
                      
                      */
                      
                   End If; 

/**********************************************************/                   
                     

  --      IF TRIM(cnFLAGPGTO) In ('P', 'R') THEN
  --        V_CIFFOB := 'CIF';
  --      ELSE
  --        V_CIFFOB := 'FOB';
  --      END IF;

           ListaNotas.cnEMBALAGEM := nvl(ListaNotas.cnEMBALAGEM,'A7');
           
           if ListaNotas.cnTABSOLCOD <> SemTabelaCodigo Then
              vRetBuscaFrete.vRetorno := 'MA';
           End If;   
            
--            End If;     

                -- TESTE PARA VERIFICAC?O KLAYTO / SIRLANO 16/10/13
                
           ListaVaux.cnCODIGOORI  := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnORIGEM, 'IBC'), 8);
           if trim(ListaVaux.cnCODIGOORI) = 'SIBGE' then
              tpLogGeracaO.Con_Loggeracao_ErroHTML :=  fni_retcenario('LOC ORIGEM SEM IBGE');
              P_RETORNOPROCESSAMENTO :=  fn_InsereLogGeracao;
           Else
              ListaVaux.cnCODIGOREGO := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnORIGEM, 'IBR'), 1);
           End If;
           ListaVaux.cnCODIGODES  := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnDESTINO, 'IBC'), 8);
           if trim(ListaVaux.cnCODIGODES) = 'SIBGE' then
              tpLogGeracaO.Con_Loggeracao_ErroHTML :=  fni_retcenario('LOC DESTINO SEM IBGE');
              P_RETORNOPROCESSAMENTO :=  fn_InsereLogGeracao;
           Else
              ListaVaux.cnCODIGOREGD := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnDESTINO, 'IBR'), 1);
           End If;
           
           if trim(tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC'))  = 'SIBGE' Then
              tpLogGeracaO.Con_Loggeracao_ErroHTML :=  fni_retcenario('LOC COLETA SEM IBGE');
              P_RETORNOPROCESSAMENTO :=  fn_InsereLogGeracao;
           End If;   
           
           if trim(tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC'))  = 'SIBGE' Then
              tpLogGeracaO.Con_Loggeracao_ErroHTML :=  fni_retcenario('LOC ENTREGA SEM IBGE');
              P_RETORNOPROCESSAMENTO :=  fn_InsereLogGeracao;
           End If;   

--           ListaVaux.cnKM := fni_ConsultaKM(ListaNotas.cnORIGEM,ListaNotas.cnDESTINO);
--              ListaVaux.cnKM := fni_ConsultaKM(ListaNotas.cnCOLETA,ListaNotas.cnENTREGA);

                 if ( nvl(ListaVaux.cnKM,0) = 0 ) and ( ListaCargaCli.ccUSAFAIXAKM = 'S') and ( ListaCargaCli.ccTABKM is null ) Then
                    tpLogGeracaO.Con_Loggeracao_ErroHTML := '2 Retornou KM 0 (zero), VERIFICAR TABELA DE KM ORIGEM - ' || ListaNotas.cnCOLETA || ' DESTINO - ' || ListaNotas.cnENTREGA ;
                    P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                 End If;  
            
                   
              tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'LOC Coleta: ' || ListaNotas.cnCOLETA || ' - Antes Origem / Destino a serem procurado: cnORIGEM: '||ListaNotas.cnORIGEM||' ListaNotas.cnDESTINO: '||ListaNotas.cnDESTINO||' ListaVaux.cnKM: '||ListaVaux.cnKM; 
              vAuxiliarchar :=  fn_InsereLogGeracao;
    

   
             IF ( instr('166177',ListaNotas.cnnota) > 0  ) AND ( upper(P_USU_USUARIOCRIA) = 'JSANTOS') THEN
                v_FORMULARIOCLI := ProdutoQuimicoSemFormulario;
             END IF;

             -- VERIFICA SE EXISTE PRODUTO QUIMICO E SE TEM FORMULARIO 
             IF ( ( nvl(ListaNotas.cnONU,OnuNaoQuimico) <> OnuNaoQuimico ) AND (ListaQuebras.GRUPOEC  in ('0020','0074')) ) Then
               
/*   Coloquei esta no inico do loop de Notas

               Select min(nvl(fe.glb_onuclascli_codigo,'00')),
                      min(nvl(fe.arm_notafichaemerg_codcli,ProdutoQuimicoSemFormulario))
                   Into v_CLASSIFCLI,
                        v_FORMULARIOCLI   
               From TDVADM.T_arm_notafichaemerg fe
               Where 0 = 0
                AND LPAD(FE.ARM_NOTA_NUMERO,9,'0') = LPAD(ListaNotas.cnNOTA,9,'0')
                AND trim(FE.GLB_CLIENTE_CGCCPFREMETENTE) = Trim(ListaNotas.cnCLIREM)
                and fe.arm_nota_serie = ListaNotas.cnSERIENF;
*/               
                 

                 -- a classificac?o 00 indica que Nao houve resposta do Cliente.
                 -- e o produto e quimico isot e <> de 9999         
                  If ( v_CLASSIFCLI = ProdutoQuimicoAguardRetorno ) AND ( nvl(ListaNotas.cnONU,OnuNaoQuimico) <> OnuNaoQuimico )  THEN
                  -- VERIFICA OS ARMAZENS TRAVADOS
                     IF INSTR(V_ARMTRAVADO,P_ARM_ARMAZEM) = 0 Then
                        if ListaCargaCli.ccEXIGEFORMQM = 'S' Then
                           tpLogGeracaO.Con_Loggeracao_ErroHTML := 'PRODUTO QUIMICO SEM FORMULARIO DE AUTORIZAC?O - ONU ' || ListaNotas.cnONU;
                           P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                        Else
                           v_FORMULARIOCLI := ProdutoQuimicoSemFormulario; 
                           -- Sirlano alterei em 05/06/2015
                           v_FORMULARIOCLI := ProdutoQuimicoSemFormulario;
                           v_CLASSIFCLI    := ProdutoQuimicoNPerigoso;
                        End If;   
                    END IF;
                  -- caso o usuario tem fazer no processo antigo
                  -- com classificac?o 01 e 02 trava dizendo que Nao pode
                  -- pois existe ja uma classificac?o 03 e 04 para o processo por email  
                  Elsif ( v_CLASSIFCLI In ('01',ProdutoNaoQuimico) ) AND ( nvl(ListaNotas.cnONU,OnuNaoQuimico) <> OnuNaoQuimico )  Then
                  -- VERIFICA OS ARMAZENS TRAVADOS
                     IF INSTR(V_ARMTRAVADO,P_ARM_ARMAZEM) = 0 Then
                        if ListaCargaCli.ccEXIGEFORMQM = 'S' Then
                           tpLogGeracaO.Con_Loggeracao_ErroHTML := 'VOCE UTILIZOU O PROCESSO ANTIGO DE CLASSIFICAO DE PRODUTO QUIMICO. Classificacao ->' || v_CLASSIFCLI  || ' COD.ONU->' || ListaNotas.cnONU;
                           P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                        Else
                           v_FORMULARIOCLI := ProdutoQuimicoSemFormulario; 
                           -- Sirlano alterei em 05/06/2015
                           v_FORMULARIOCLI := ProdutoQuimicoSemFormulario;
                           v_CLASSIFCLI    := ProdutoQuimicoNPerigoso;
                        End If;   
                     End If;
                  Elsif nvl(v_CLASSIFCLI, 'XX') = 'XX' Then
                     tpLogGeracaO.Con_Loggeracao_ErroHTML := 'FALTA DIGITAR FICHA DE EMERGENCIA OU FICHA INCOMPLETA - ONU ' || ListaNotas.cnONU;
                     P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                 End If;
             END IF;
             


/*              
              -- VERIFICA SE VAI AGRUPAR NOTAS EM UM MESMO DOCUMENTO
                  IF ( ListaNotas.cnCLIDEST    = nvl(ListaVaux.cnCLIDESTANT,'XXX') ) 
--                 AND ( ListaNotas.cnCLIENDDEST = nvl(ListaVaux.cnCLIENDDESTANT,'XXX') ) 
                 AND ( ListaNotas.cnCLIREM     = nvl(ListaVaux.cnCLIREMANT,'XXX') ) 
                 AND ( ListaNotas.cnCOLETA     = nvl(ListaVaux.cnCODIGOORIANT,'XXXXX') )
                 AND ( ListaNotas.cnENTREGA    = nvl(ListaVaux.cnCODIGODESANT,'XXXXX') )
                 AND ( ListaNotas.cnTABSOLCOD  = nvl(ListaVaux.cnTABSOLCODANT,'XXXX') ) THEN
                 -- verifica se e CTRC

                  IF ( ListaNotas.cnCLIDEST    = nvl(ListaVaux.cnCLIDESTANT,'XXX') ) 
--                 AND ( ListaNotas.cnCLIENDDEST = nvl(ListaVaux.cnCLIENDDESTANT,'XXX') ) 
                 AND ( ListaNotas.cnCLIREM     = nvl(ListaVaux.cnCLIREMANT,'XXX') ) 
                 AND ( tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'IBC')     = tdvadm.fn_busca_codigoibge(nvl(ListaVaux.cnCODIGOORIANT,'XXXXX'),'IBC') )
                 AND ( tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'IBC')    = tdvadm.fn_busca_codigoibge(nvl(ListaVaux.cnCODIGODESANT,'XXXXX'),'IBC') )
                 AND ( ListaNotas.cnTABSOLCOD  = nvl(ListaVaux.cnTABSOLCODANT,'XXXX') ) THEN

*/

                 If fni_CriaNovoCte(ListaNotas.cnCLIREM,
                                    nvl(ListaVaux.cnCLIREMANT,'XXX'),
                                    ListaNotas.cnCLIDEST,
                                    nvl(ListaVaux.cnCLIDESTANT,'XXX'),
                                    tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'IBC'),
                                    tdvadm.fn_busca_codigoibge(nvl(ListaVaux.cnCODIGOORIANT,'XXXXX'),'IBC'),
                                    tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'IBC'),
                                    tdvadm.fn_busca_codigoibge(nvl(ListaVaux.cnCODIGODESANT,'XXXXX'),'IBC'),
                                    ListaNotas.cnTABSOLCOD,
                                    nvl(ListaVaux.cnTABSOLCODANT,'XXXX'),
                                    ListaCargaCli) = 'N' Then
                                      
                    -- Verifica se e para quebrar por coleta
                    If  ( ListaCargaCli.ccAgrpPorColeta = 'S' and ListaNotas.cnNRCOLETA = ListaVaux.cnNRCOLETAANT ) or 
                        ( ListaCargaCli.ccAgrpPorColeta = 'N' )  Then
                 
                         -- BEM POSSIVEL QUE O ERRO ESTA AQUI NO RETORNO DA FUNCAO
                         -- SIRLANO 28/06/2010
                         if tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC') = tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC') then
                            If (ListaCargaCli.ccTPCARGAAGRUPANF = 'N') or 
                               ( V_CONTADORDENOTAS >= least(ListaCargaCli.ccTPCARGAQTDEAGNF,ListaVaux.cnContaNotas) ) or 
                               (P_RETORNOPROCESSAMENTO = 'E' ) then

                               -- Caso seja para agrupar veriifcar se e a mesma coleta

                               V_CONTADORDENOTAS := 0;
                               V_PESOTOTAL          := 0;
                               V_PESOBALTOTAL       := 0;
                               V_PESOCOBTOTAL       := 0;
                               V_VALORTOTMERCADORIA := 0;
                               V_LISTANOTASCTRC     := 'NOTA(s) FISCAL(is)-';
                              
                            End If;
                         Else -- se For CTRC      
                            If (ListaCargaCli.ccTPCARGAAGRUPACTRC = 'N') or 
                               ( V_CONTADORDENOTAS >= least(ListaCargaCli.ccTPCARGAQTDEAGCTRC,ListaVaux.cnContaNotas) )  or 
                               (P_RETORNOPROCESSAMENTO = 'E' ) then
                               V_CONTADORDENOTAS := 0;
                               V_PESOTOTAL          := 0;
                               V_PESOBALTOTAL       := 0;
                               V_PESOCOBTOTAL       := 0;
                               V_VALORTOTMERCADORIA := 0;
                               V_LISTANOTASCTRC     := 'NOTA(s) FISCAL(is)-';
                            End If;
                         End If;   
                  Else
                       V_CONTADORDENOTAS := 0;
                       V_PESOTOTAL          := 0;
                       V_PESOBALTOTAL       := 0;
                       V_PESOCOBTOTAL       := 0;
                       V_VALORTOTMERCADORIA := 0;
                       V_LISTANOTASCTRC     := 'NOTA(s) FISCAL(is)-';
                       if V_CTRCCODIGO is not null Then
                           
                       
                          select sum(decode(trim(c.slf_reccust_codigo),'D_PSREAL',c.con_calcviagem_valor,0)) PesoReal,
                                 sum(decode(trim(c.slf_reccust_codigo),'I_PSCOBRAD',c.con_calcviagem_valor,0)) PesoCobrado,
                                 count(*) Qtde
                             into vAuxiliarnumerico,
                                  vAuxiliarnumerico2,
                                  vAuxiliarnumerico3
                          from TDVADM.T_con_calcconhecimento c
                          where c.con_conhecimento_codigo =  V_CTRCCODIGO
                            and c.glb_rota_codigo = ListaNotas.cnROTA
                            and c.con_conhecimento_serie = 'XXX'
                            and trim(c.slf_reccust_codigo) in ('D_PSREAL','I_PSCOBRAD');
                       
                        If vAuxiliarnumerico3 > 1 Then
                           Update TDVADM.T_con_calcconhecimento c
                             set c.con_calcviagem_valor = decode(trim(c.slf_reccust_codigo),'D_PSREAL',vAuxiliarnumerico,vAuxiliarnumerico2)
                          where c.con_conhecimento_codigo =  V_CTRCCODIGO
                            and c.glb_rota_codigo = ListaNotas.cnROTA
                            and c.con_conhecimento_serie = 'XXX'
                            and trim(c.slf_reccust_codigo) in ('D_PSREAL','I_PSCOBRAD');
                        End If;
                       
                          If instr(tpConConhecimento.Con_Conhecimento_Obs,'<<') > 0 Then
                              ListaVerbas := fn_CarregaVerbas(tpConConhecimento.Con_Conhecimento_Codigo,
                                                              tpConConhecimento.Con_Conhecimento_Serie,
                                                              tpConConhecimento.Glb_Rota_Codigo);

                             select count(distinct co.arm_coleta_ncompra)
                               into vAuxiliar
                             from TDVADM.T_arm_nota an,
                                  TDVADM.T_arm_coleta co
                             where an.con_conhecimento_codigo =  V_CTRCCODIGO
                               and an.glb_rota_codigo = ListaNotas.cnROTA
                               and an.con_conhecimento_serie = 'XXX'
                               and an.arm_coleta_ncompra = co.arm_coleta_ncompra
                               and an.arm_coleta_ciclo = co.arm_coleta_ciclo
                               and co.arm_coleta_valor > 0;

                              ListaVerbas('S_QTDECOL').AsFloat      := vAuxiliar;
                              ListaVerbas('S_QTDECOL').Value        := trim(to_char(vAuxiliar));
                              ListaVerbas('S_QTDECOL').AsDesinencia := 'VL';
                              
                              UPDATE tdvadm.t_con_calcconhecimento ca
                                SET CA.CON_CALCVIAGEM_VALOR = vAuxiliar
                              WHERE CA.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                AND CA.CON_CONHECIMENTO_SERIE = 'XXX'
                                AND CA.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                AND CA.SLF_RECCUST_CODIGO = 'S_QTDECOL';
                              
                              tpConConhecimento.Con_Conhecimento_Obs := fn_MudaObservacao(tpConConhecimento.Con_Conhecimento_Obs,
                                                                                          ListaVerbas);
                                                                                       
                              UPDATE TDVADM.T_CON_CONHECIMENTO C
                                 SET C.CON_CONHECIMENTO_OBS = tpConConhecimento.Con_Conhecimento_Obs
                               WHERE C.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                 AND C.CON_CONHECIMENTO_SERIE = 'XXX'
                                 AND C.GLB_ROTA_CODIGO = ListaNotas.cnROTA;
                              commit;
                          End If;
                         
                       end If;
                       -- Se mudou o remetente ou destinatario zera o numero do CTe
                       V_CTRCCODIGO := null;
                  End If; 
              Else
                 V_CONTADORDENOTAS := 0;
                 V_PESOTOTAL          := 0;
                 V_PESOBALTOTAL       := 0;
                 V_PESOCOBTOTAL       := 0;
                 V_VALORTOTMERCADORIA := 0;
                 V_LISTANOTASCTRC     := 'NOTA(s) FISCAL(is)-';
                 -- Se mudou o remetente ou destinatario zera o numero do CTe

                 if V_CTRCCODIGO is not null Then
                          select sum(decode(trim(c.slf_reccust_codigo),'D_PSREAL',c.con_calcviagem_valor,0)) PesoReal,
                                 sum(decode(trim(c.slf_reccust_codigo),'I_PSCOBRAD',c.con_calcviagem_valor,0)) PesoCobrado,
                                 count(*) Qtde
                             into vAuxiliarnumerico,
                                  vAuxiliarnumerico2,
                                  vAuxiliarnumerico3
                          from TDVADM.T_con_calcconhecimento c
                          where c.con_conhecimento_codigo =  V_CTRCCODIGO
                            and c.glb_rota_codigo = ListaNotas.cnROTA
                            and c.con_conhecimento_serie = 'XXX'
                            and trim(c.slf_reccust_codigo) in ('D_PSREAL','I_PSCOBRAD');
                       
                        If vAuxiliarnumerico3 > 1 Then
                           Update TDVADM.T_con_calcconhecimento c
                             set c.con_calcviagem_valor = decode(trim(c.slf_reccust_codigo),'D_PSREAL',vAuxiliarnumerico,vAuxiliarnumerico2)
                          where c.con_conhecimento_codigo =  V_CTRCCODIGO
                            and c.glb_rota_codigo = ListaNotas.cnROTA
                            and c.con_conhecimento_serie = 'XXX'
                            and trim(c.slf_reccust_codigo) in ('D_PSREAL','I_PSCOBRAD');
                        End If;

                    If instr(tpConConhecimento.Con_Conhecimento_Obs,'<<') > 0 Then
                        ListaVerbas := fn_CarregaVerbas(tpConConhecimento.Con_Conhecimento_Codigo,
                                                        tpConConhecimento.Con_Conhecimento_Serie,
                                                        tpConConhecimento.Glb_Rota_Codigo);

                               
                     select count(*)
                       into vAuxiliar
                     from TDVADM.T_arm_nota an,
                          TDVADM.T_arm_coleta co
                     where an.con_conhecimento_codigo =  V_CTRCCODIGO
                       and an.glb_rota_codigo = ListaNotas.cnROTA
                       and an.con_conhecimento_serie = 'XXX'
                       and an.arm_coleta_ncompra = co.arm_coleta_ncompra
                       and an.arm_coleta_ciclo = co.arm_coleta_ciclo
                       and co.arm_coleta_valor > 0;

                      ListaVerbas('S_QTDECOL').AsFloat      := vAuxiliar;
                      ListaVerbas('S_QTDECOL').Value        := trim(to_char(vAuxiliar));
                      ListaVerbas('S_QTDECOL').AsDesinencia := 'VL';
                              
                              UPDATE tdvadm.t_con_calcconhecimento ca
                                SET CA.CON_CALCVIAGEM_VALOR = vAuxiliar
                              WHERE CA.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                AND CA.CON_CONHECIMENTO_SERIE = 'XXX'
                                AND CA.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                AND CA.SLF_RECCUST_CODIGO = 'S_QTDECOL';

                        tpConConhecimento.Con_Conhecimento_Obs := fn_MudaObservacao(tpConConhecimento.Con_Conhecimento_Obs,
                                                                                    ListaVerbas);
                                                                                       
                        UPDATE TDVADM.T_CON_CONHECIMENTO C
                           SET C.CON_CONHECIMENTO_OBS = tpConConhecimento.Con_Conhecimento_Obs
                         WHERE C.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                           AND C.CON_CONHECIMENTO_SERIE = 'XXX'
                           AND C.GLB_ROTA_CODIGO = ListaNotas.cnROTA;
                        commit;
                    End If;
                         
                 end If;

                 V_CTRCCODIGO := null;
              End If;    



                
            
              -- se notas forem da categoria de EXPRESSA / QUIMICO / REPARO
              -- Nao DEIXA SER SPOT CASO NAO ACHE AS TABELAS
              -- retirado o tipo 06 temporariamente 28/01/2009
              if V_CONTADORCTRC = 137 then 
                 V_CONTADORCTRC:= V_CONTADORCTRC;
              End if;   
            
             -- verificando se existe autorizacao
              IF (trim(ListaCargaCli.ccTPCARGACLI) = '05') AND (ListaNotas.cnSPOT IS NOT NULL) THEN -- SPOT
                 SELECT COUNT(*)
                   INTO V_CONTADOR
                 FROM TDVADM.T_ARM_COLETAFORMEXP FE
                 WHERE FE.ARM_COLETA_NCOMPRA = ListaNotas.cnNRCOLETA
                   And fe.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo
                   AND FE.ARM_COLETAFORMEXP_TIPO = 'S';
                 
                 IF V_CONTADOR = 0 Then

                    update TDVADM.T_arm_coleta co
                     set co.glb_tpcarga_codigo = 'SP'
                    where co.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
                      and co.arm_coleta_ciclo  = ListaNotas.cnNrColetaCiclo; 

                    tpLogGeracaO.Con_Loggeracao_ErroHTML := 'COLETA SPOT SEM AUTORIZAC?O -> ' || ListaNotas.cnNrColetaCiclo ||'.'|| ListaNotas.cnNRCOLETA;
                    P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                 
                 ELSE
                   begin
                      SELECT co.arm_coleta_nrformulario
                        INTO v_FormularioSP
                      FROM TDVADM.T_ARM_COLETA CO
                      WHERE CO.ARM_COLETA_NCOMPRA = ListaNotas.cnNRCOLETA
                        AND CO.ARM_COLETA_CICLO   = ListaNotas.cnNrColetaCiclo
                        AND CO.ARM_COLETA_NRFORMULARIO IS NOT NULL;
                      V_CONTADOR := 1;
                    exception
                      when NO_DATA_FOUND Then
                          V_CONTADOR := 0;
                          v_FormularioSP := null;

                          begin
                              SELECT FE.ARM_COLETA_NRFORMULARIO,
                                     FE.ARM_COLETAEX_SOAP_CODIGO
                                INTO v_FormularioSP,
                                     Vautorizador
                              FROM TDVADM.T_ARM_COLETAFORMEXP FE
                              WHERE FE.ARM_COLETA_NCOMPRA = ListaNotas.cnNRCOLETA
                                AND FE.ARM_COLETA_CICLO   = ListaNotas.cnNrColetaCiclo
                                AND FE.ARM_COLETA_NRFORMULARIO IS NOT NULL;
                              update TDVADM.T_arm_coleta co
                                set co.arm_coleta_nrformulario = v_FormularioSP,
                                    co.ARM_COLETAEX_SOAP_CODIGO = Vautorizador
                              WHERE co.ARM_COLETA_NCOMPRA = ListaNotas.cnNRCOLETA
                                AND co.ARM_COLETA_CICLO   = ListaNotas.cnNrColetaCiclo;
                              V_CONTADOR := 1;
                          exception
                            when NO_DATA_FOUND Then
                               V_CONTADOR := 0;
                               v_FormularioSP := null;
                            end; 




                      end; 
                    IF V_CONTADOR = 0 Then
                       tpLogGeracaO.Con_Loggeracao_ErroHTML := 'COLETA SPOT SEM NUMERO DE FORMULARIO -> ' || ListaNotas.cnNrColetaCiclo ||'.'|| ListaNotas.cnNRCOLETA;
                       P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                    END IF; 
                 END IF;      
              
              
              END IF;


              IF ( trim(ListaCargaCli.ccTPCARGACLI) = '03' )  or ( instr(cCargaExpressa,TDVADM.PKG_glb_common.Fn_QuotedStr(ListaNotas.cnTIPOCARGA)) > 0  ) THEN -- EXPRESSA
--                 if nvl(ListaVaux.cnContaNotas,0) > 1 Then
--                    tpLogGeracaO.Con_Loggeracao_ErroHTML := 'ENTRAR EM CONTATO COM SIRLANO CARGAS EXPRESSAS BLOQUEADAS';
--                    P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
--                 End If;   
                 If ListaCargaCli.ccEXIGEFORMEX = 'S' Then 
                    SELECT COUNT(*)
                      INTO V_CONTADOR
                    FROM TDVADM.T_ARM_COLETAFORMEXP FE
                    WHERE FE.ARM_COLETA_NCOMPRA = ListaNotas.cnNRCOLETA
                      And fe.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo
                      AND FE.ARM_COLETAFORMEXP_TIPO = 'E';
                 
                    IF V_CONTADOR = 0 Then
                       tpLogGeracaO.Con_Loggeracao_ErroHTML := 'COLETA EXPRESSA SEM AUTORIZAC?O -> ' || ListaNotas.cnNrColetaCiclo ||'.'|| ListaNotas.cnNRCOLETA;
                       P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                 
                    ELSE
                       begin
                          SELECT co.arm_coleta_nrformulario
                            INTO v_FormularioEX
                          FROM TDVADM.T_ARM_COLETA CO
                          WHERE CO.ARM_COLETA_NCOMPRA = ListaNotas.cnNRCOLETA
                            AND CO.ARM_COLETA_CICLO   = ListaNotas.cnNrColetaCiclo
                            AND CO.ARM_COLETA_NRFORMULARIO IS NOT NULL;
                          V_CONTADOR := 1;
                       exception
                         when NO_DATA_FOUND Then
                             V_CONTADOR := 0;
                             v_FormularioEX := null;
                             begin
                                SELECT FE.ARM_COLETA_NRFORMULARIO,
                                       FE.ARM_COLETAEX_SOAP_CODIGO
                                    INTO v_FormularioEX,
                                         Vautorizador
                                FROM TDVADM.T_ARM_COLETAFORMEXP FE
                                WHERE FE.ARM_COLETA_NCOMPRA = ListaNotas.cnNRCOLETA
                                  AND FE.ARM_COLETA_CICLO   = ListaNotas.cnNrColetaCiclo
                                  AND FE.ARM_COLETA_NRFORMULARIO IS NOT NULL;
                                update TDVADM.T_arm_coleta co
                                  set co.arm_coleta_nrformulario = v_FormularioEX,
                                      co.ARM_COLETAEX_SOAP_CODIGO = Vautorizador
                                WHERE co.ARM_COLETA_NCOMPRA = ListaNotas.cnNRCOLETA
                                  AND co.ARM_COLETA_CICLO   = ListaNotas.cnNrColetaCiclo;
                                V_CONTADOR := 1;
                             exception
                             when NO_DATA_FOUND Then
                                 V_CONTADOR := 0;
                                 v_FormularioEX := null;
                             end; 
                       end;
                       IF V_CONTADOR = 0 Then
                       -- VERIFICA SE E COLETA AD HOC
                          SELECT COUNT(*)
                             INTO V_CONTADOR
                          FROM TDVADM.T_ARM_COLETA CO,
                               TDVADM.T_XML_PO PO
                          WHERE CO.ARM_COLETA_NCOMPRA = ListaNotas.cnNRCOLETA
                            AND CO.ARM_COLETA_CICLO   = ListaNotas.cnNrColetaCiclo
                            AND CO.ARM_COLETA_PEDIDO = PO.XML_PO_NUMERO
                            AND INSTR(PO.XML_PO_OBS,'HOC') > 0 ;
                          IF V_CONTADOR > 0 Then
                             update TDVADM.T_arm_coleta co
                               set co.arm_coletaex_soap_codigo = '000',
                                   co.arm_coleta_nrformulario = substr('AH' ||  co.arm_coleta_pedido,1,10)
                             WHERE CO.ARM_COLETA_NCOMPRA = ListaNotas.cnNRCOLETA
                               AND CO.ARM_COLETA_CICLO   = ListaNotas.cnNrColetaCiclo;
                             begin
                                SELECT co.arm_coleta_nrformulario
                                   INTO v_FormularioAH
                                FROM TDVADM.T_ARM_COLETA CO
                                WHERE CO.ARM_COLETA_NCOMPRA = ListaNotas.cnNRCOLETA
                                  AND CO.ARM_COLETA_CICLO   = ListaNotas.cnNrColetaCiclo
                                  AND CO.ARM_COLETA_NRFORMULARIO IS NOT NULL;
                                V_CONTADOR := 1;
                             exception
                             when NO_DATA_FOUND Then
                                V_CONTADOR := 0;
                                v_FormularioAH := null;
                             end; 
                          Else     
                             tpLogGeracaO.Con_Loggeracao_ErroHTML := 'COLETA EXPRESSA SEM NUMERO DE FORMULARIO -> ' || ListaNotas.cnNrColetaCiclo ||'.'|| ListaNotas.cnNRCOLETA;
                             P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                          End If;   
                       END IF; 
                    END IF;      
                 End If; 
              END IF;
              -- KLAYTON 10/11/2009 VERIFICO SE O REMENTENTE OU DESTINATARIO Nao POSSUE CODIGO DE LOCALIDADE PARA O TIPO DE ENDERECO
              SELECT COUNT(*)          
                 INTO V_LOCREM
              FROM TDVADM.T_GLB_CLIEND CD
              WHERE CD.GLB_CLIENTE_CGCCPFCODIGO =  ListaNotas.cnCLIREM
                AND CD.GLB_TPCLIEND_CODIGO      =  ListaNotas.cnCLIENDREM
                AND NVL(CD.GLB_LOCALIDADE_CODIGO,'0') <> '0';
              
              IF V_LOCREM = 0 Then
                 tpLogGeracaO.Con_Loggeracao_ErroHTML := 'REMETENTE '|| ListaNotas.cnCLIREM ||' Nao POSSUE CODIGO DE LOCALIDADE PARA ESSE TIPO DE ENDERECO' || ListaNotas.cnCLIENDREM;
                 P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
              END IF;  
              
              SELECT count(*)
                 INTO V_LOCDEST
              FROM TDVADM.T_GLB_CLIEND CD
              WHERE CD.GLB_CLIENTE_CGCCPFCODIGO =  ListaNotas.cnCLIDEST
                AND CD.GLB_TPCLIEND_CODIGO      =  ListaNotas.cnCLIENDDEST
                AND NVL(CD.GLB_LOCALIDADE_CODIGO,'0') <> '0';
                
              IF V_LOCDEST = 0 Then
                 tpLogGeracaO.Con_Loggeracao_ErroHTML := 'DESTINATARIO '|| ListaNotas.cnCLIDEST ||' Nao POSSUE CODIGO DE LOCALIDADE PARA ESSE TIPO DE ENDERECO' || ListaNotas.cnCLIENDDEST;
                 P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
              END IF;  

              v_datactrc := P_DATAEMISSAO;

              -- se for produto quimico, procurar se achou o mesmo na tabela da ONU 
              if trim(ListaCargaCli.ccTPCARGACLI) = '04' then
                 select count(*)
                   INTO V_CONTADOR
                 from TDVADM.T_glb_onu o
                 where o.glb_onu_codigo = ListaNotas.cnONU
                   and o.glb_onu_grpemb = ListaNotas.cnONUGRPEMB;
              
                 IF V_CONTADOR = 0 THEN
                    tpLogGeracaO.Con_Loggeracao_ErroHTML := 'CODIGO DA ONU Nao LOCALIZADO COD-' || ListaNotas.cnONU || ' GRPEMB-' || ListaNotas.cnONUGRPEMB ;
                    P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                    v_classificaerro       := trim(v_classificaerro) || ';ONU';
                 END IF;
                
              end if;
           
              if nvl(ListaNotas.cnORIGEM, '00000') = '00000' then

                 tpLogGeracaO.Con_Loggeracao_ErroHTML := 'CLIENTE SEM ORIGEM VERIFIQUE';
                 P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                 v_classificaerro       := trim(v_classificaerro) || ';CO';
              
              end if;
            
              if nvl(ListaNotas.cnDESTINO, '00000') = '00000' then
                 tpLogGeracaO.Con_Loggeracao_ErroHTML := 'CLIENTE SEM DESTINO VERIFIQUE';
                 P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                 v_classificaerro       := trim(v_classificaerro) || ';CD';
              
              end if;
            
              if nvl(ListaNotas.cnCOLETA, '00000') = '00000' then

                 tpLogGeracaO.Con_Loggeracao_ErroHTML := 'CLIENTE SEM LOCALIDADE DE COLETA VERIFIQUE';
                 P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                 v_classificaerro       := trim(v_classificaerro) || ';LC';
              
              end if;
            
              if nvl(ListaNotas.cnENTREGA, '00000') = '00000' Then

                 tpLogGeracaO.Con_Loggeracao_ErroHTML := 'CLIENTE SEM LOCALIDADE DE ENTREGA VERIFIQUE';
                 P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                 v_classificaerro       := trim(v_classificaerro) || ';LE';
              
              end if;
            
              IF P_RETORNOPROCESSAMENTO = 'N' THEN
            
                -- PEGA O KM DO PERCURSO
              
                -- DEFINE O TIPO DE CALCULO CTRC OU NF
                IF tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC') = tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC') THEN
                   V_TPCALCULO := '115';
                   vDescCalculo := 'CALCULO ISS';
                   if ( ListaNotas.cnContrato = 'C2013010022' ) Then -- LOT-VOLKSWAGEN-0113-XXX
                      V_TPCALCULO := '316';
                   end If   ;
                   If ListaNotas.cnGRUPOECSAC = '0020' Then
                      V_TPCALCULO := '316';
                   End If;
                   vTipoDocumento := cNFServico;
                   ListaNotas.cnROTA      := nvl(ListaNotas.cnROTANF, ListaNotas.cnROTA);
                Else
                   V_TPCALCULO := '041';
                   vDescCalculo := 'CALCULO ICMS';
                   if ( ListaNotas.cnContrato = 'C2013010022' ) Then -- LOT-VOLKSWAGEN-0113-XXX
                      V_TPCALCULO := '315';
                   end If   ;
                   If ListaNotas.cnGRUPOECSAC = '0020' Then
                      V_TPCALCULO := '315';
                   End If;
                   select decode(r.glb_rota_cte,'S','E',cCTeCTRC)
                     into vTipoDocumento
                   from TDVADM.T_glb_rota r  
                   where r.glb_rota_codigo = ListaNotas.cnROTA;
                END IF;
              
                IF length(nvl(ListaNotas.cnROTA, 'A')) < 3 THEN

                   tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := fni_retcenario('NAO FOI ENCONTRADO A ROTA DO ARMAZEM PARA EMISSAO DO DOCUMENTO');
                    P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                END IF;
              
                ListaVaux.cnCODIGOORI  := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnORIGEM, 'IBC'), 8);

                if trim(ListaVaux.cnCODIGOORI) = 'SIBGE' then
                   tpLogGeracaO.Con_Loggeracao_ErroHTML :=  fni_retcenario('LOC ORIGEM SEM IBGE');
                   P_RETORNOPROCESSAMENTO :=  fn_InsereLogGeracao;
                Else
                   ListaVaux.cnCODIGOREGO := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnORIGEM, 'IBR'), 1);
                End If;
                
                ListaVaux.cnCODIGODES  := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnDESTINO, 'IBC'), 8);
                if trim(ListaVaux.cnCODIGODES) = 'SIBGE' then
                   tpLogGeracaO.Con_Loggeracao_ErroHTML :=  fni_retcenario('LOC DESTINO SEM IBGE');
                   P_RETORNOPROCESSAMENTO :=  fn_InsereLogGeracao;
                Else
                   ListaVaux.cnCODIGOREGD := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnDESTINO, 'IBR'), 1);
                End If;
           
                if trim(tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC'))  = 'SIBGE' Then
                   tpLogGeracaO.Con_Loggeracao_ErroHTML :=  fni_retcenario('LOC COLETA SEM IBGE');
                   P_RETORNOPROCESSAMENTO :=  fn_InsereLogGeracao;
                End If;   
           
                if trim(tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC'))  = 'SIBGE' Then
                   tpLogGeracaO.Con_Loggeracao_ErroHTML :=  fni_retcenario('LOC ENTREGA SEM IBGE');
                   P_RETORNOPROCESSAMENTO :=  fn_InsereLogGeracao;
                End If;   

                if ( nvl(ListaVaux.cnKM,0) = 0 ) and ( ListaCargaCli.ccUSAFAIXAKM = 'S') and ( ListaCargaCli.ccTABKM is null ) Then
                   tpLogGeracaO.Con_Loggeracao_ErroHTML := '3Falta KM, VERIFICAR TABELA DE KM ORIGEM - ' || ListaNotas.cnCOLETA || ' DESTINO - ' || ListaNotas.cnENTREGA ;
                   P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                End If;  
 
                if ListaCargaCli.ccPCOBRANCA = 'PB' Then

                      BEGIN
                        select nvl(p.arm_notapesagem_pesototal,0)
                           into V_PESAGEM
                        from TDVADM.T_arm_nota n,
                             TDVADM.T_arm_notapesagem p
--                             ,TDVADM.T_arm_notapesagemitem pi
                        where 0 = 0
--                          and n.arm_nota_chavenfe = p.arm_nota_chavenfe 
                          and n.arm_nota_sequencia = p.arm_nota_sequencia
                          AND n.arm_armazem_codigo = ListaVaux.cnArmazem
                          and n.arm_nota_sequencia = ListaNotas.cnSequencia;
--                          and n.arm_nota_chavenfe = ListaNotas.cnCHAVENFE;
                          V_PESAGEM := nvl(V_PESAGEM,0);
                      EXCEPTION 
                        WHEN NO_DATA_FOUND THEN
                          /****************************** Sirlano 04/09/2013*/ 
                          -- SE Nao ACHAR NA TRABELA DA BALANCA USA O QUE FOI DIGITADO
                          -- Inicializa
                          V_PESAGEM := 0;
                          if ( vPesagemObrigatoria = 'N' ) Then
                            if trim(ListaCargaCli.ccTPCARGACLI) in ('13','14','25','26') Then
                               V_PESAGEM := ListaNotas.cnPESOBAL;
                            Else  
                               V_PESAGEM  := ListaNotas.cnPESO;
                            End If; 
                          Else
                             ListaNotas.cnPESOBAL := nvl(V_PESAGEM,0);
                             if ( vPesominimo < ListaNotas.cnPESO ) and 
                                ( vPesagemMaximo > ListaNotas.cnPESO ) and 
                                ( trim(ListaCargaCli.ccTPCARGACLI) not in ('13','14','25','26') ) Then 
                                 V_PESAGEM := 0;
                                 vErroFatal := 'E';
                                 tpLogGeracaO.Con_Loggeracao_ErroHTML := 'F-Rota Travada PESO DA NOTA -> ' || to_char(ListaNotas.cnPESO)  || ' PESAGEM NA BALANCA OBRIGATORIA'||' vPesominimo: '||vPesominimo||' ListaCargaCli.ccTPCARGACLI: '||ListaCargaCli.ccTPCARGACLI;
                                 P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                             Else
                                 -- Caso a Pesagem Maxima seja Menor que o Peso Vale o Peso Independente da Pesagem
                                 IF ( NVL(ListaNotas.cnPESOBAL,0) = 0 ) or ( vPesagemMaximo < ListaNotas.cnPESO ) Then
                                    ListaNotas.cnPESOBAL := ListaNotas.cnPESO;
                                 End If;   
                                 UPDATE TDVADM.T_ARM_NOTA N
                                    SET N.Arm_Nota_Pesobalanca = ListaNotas.cnPESOBAL
                                 WHERE TRIM(N.GLB_CLIENTE_CGCCPFREMETENTE) = TRIM(ListaNotas.cnCLIREM)
                                   AND N.ARM_NOTA_NUMERO = TO_NUMBER(ListaNotas.cnNOTA)
                                   AND TRIM(N.GLB_CLIENTE_CGCCPFDESTINATARIO) = TRIM(ListaNotas.cnCLIDEST)
                                   AND N.CON_CONHECIMENTO_CODIGO IS NULL;
                                 tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'NOTA ISENTA DE PESAGEM. PESO-> ' || to_char(ListaNotas.cnPESO) ;
                                 vAuxiliarchar := fn_InsereLogGeracao;
                                 if trim(ListaCargaCli.ccTPCARGACLI) in ('13','14','25','26') Then
                                    V_PESAGEM := ListaNotas.cnPESOBAL;
--                                 Else  
--                                    V_PESAGEM  := ListaNotas.cnPESO;
                                 End If; 
                             End If;    
                             
                          End if;   
                          if nvl(ListaNotas.cnVideNota,0) = 1 Then
                             V_PESAGEM := ListaNotas.cnPESOCOBRADO;
                          End If;
                        WHEN OTHERS Then
                           vErroFatal := 'E';
                           tpLogGeracaO.Con_Loggeracao_ErroHTML := fni_retcenario('F-ERRO NA BUSCA DO PESO BALANCA' || 'ListaNotas.cnCHAVENFE ' || ListaNotas.cnCHAVENFE || chr(10) || sqlerrm || chr(10));
                           P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                      END;   
                      
                      if  ( ListaNotas.cnPESO - V_PESAGEM  > 1000 ) and ( V_PESAGEM > 0 ) Then
                          if vPesagemObrigatoria = 'S' Then
                              tpLogGeracaO.Con_Loggeracao_ErroHTML := 'F-Pesagem Suspeita PESO DA NOTA -> ' || to_char(ListaNotas.cnPESO)  || ' PESO BALANCA ' || to_char(V_PESAGEM) || chr(10) ||
                                                                  'CASO OS PESSOS ESTIVEREM CORRETOS, ENTRE COM O USUARIO LIBERADO DE PESAGEM.' || chr(10) ||
                                                                  'SE O PROBLEMA PERSISTIR ENTRE EM CONTATO COM BRUNO ou SIRLANO';
                              P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                              vErroFatal := 'E';
                          Else
                              tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Pesagem Suspeita PESO DA NOTA -> ' || to_char(ListaNotas.cnPESO)  || ' PESO BALANCA ' || to_char(V_PESAGEM) || chr(10) ||
                                                                        'CASO OS PESSOS ESTIVEREM CORRETOS, ENTRE COM O USUARIO LIBERADO DE PESAGEM.' || chr(10) ||
                                                                        'SE O PROBLEMA PERSISTIR ENTRE EM CONTATO COM BRUNO ou SIRLANO';
                              vAuxiliarchar := fn_InsereLogGeracao;
                          End If;   
                      End If;                 
                      
                      V_SOMAPESOBALANCA := V_SOMAPESOBALANCA +  V_PESAGEM;                  
                      --REGRA INCLUIDA NO DIA 9/6/2013 SIRLANO

                   IF(V_PESAGEM > 0) then
                   
                      -- Usa a Pesagem Caso o Peso da Nota esteja abaixo do Maximo do Contrato
                      If ListaCargaCli.ccLimitePesagem <= ListaNotas.CnPESOCOBRADO Then
                         if trim(ListaCargaCli.ccTPCARGACLI) in ('13','14','25','26') Then
                            ListaNotas.cnPESOCOBRADO := ListaNotas.cnPESOCOBRADO;
                         Else  
                            ListaNotas.CnPESOCOBRADO := V_PESAGEM;
                         End If; 
                      End If;   
                   end if;
                Else
                   if trim(ListaCargaCli.ccTPCARGACLI) in ('13','14','25','26') Then
                      IF(V_PESAGEM > 0) then
                         V_PESAGEM := V_PESAGEM;
                      Else
                         V_PESAGEM := ListaNotas.cnPESOCOBRADO;
                      End If;
                   Else  
                      IF(V_PESAGEM > 0) then
                         V_PESAGEM := V_PESAGEM;
                      Else
                         V_PESAGEM := ListaNotas.cnPESO;
                      End If;   
                   End If; 
                End If;
                
                -- VERIFICAR AQUI SE EXISTE TABELA MODO ANTIGO
                -- SIRLANO 23/09/09
                IF ListaNotas.cnTABSOLCOD = SemTabelaCodigo THEN
                
                   ListaNotas.cnTABSOL := 'T';

                  /****************************************************************
                  UNIFICAC?O
                  
                  loop Basico, pois se for lotac?o e Veiculo tipo 4 - TOCO
                  Caso Nao encontre carga muda para tipo de carga fracionado e roda novamente
                  
                  ****************************************************************/

                   loop   
                  
                   
                      if ListaCargaCli.ccRATEIA = 'S' Then

                         vInstrucaoNRat := ' AND INSTR(''' || vLISTADENOTASNRAT || ''',N.GLB_CLIENTE_CGCCPFREMETENTE||LPAD(N.ARM_NOTA_NUMERO,9,''0'')) = 0 ';

                         if nvl(ListaQuebras.ccTPAGRUPA,'02') in ('00') Then          
                            spi_SqlColetaEntrega(null,null,ListaCargaCli);
                         Else
                           spi_SqlColetaEntrega(ListaQuebras.ORIGEMNOTA,ListaQuebras.DESTINONOTA,ListaCargaCli);
                         End If;   
             
                         If nvl(trim(ListaCargaCli.ccPROCEDURE),'SEMPROC') = 'SEMPROC' Then

                             if trim(ListaCargaCli.ccTPCARGACLI) = '05' Then -- Spot
                                ListaSQL.TESTAPESO := ListaSQL.CONTAPESO || 
                                                      ListaSQL.TABWHERE ||
                                                      ListaSQL.NOTASWHERE || 
                                                      ListaSQL.SCWHERE ||  
                                                      vInstrucaoNRat   ||
                                                      ListaSQL.SPOT ;
                             Elsif trim(ListaCargaCli.ccTPCARGACLI) = '04' Then -- Quimico
                                ListaSQL.TESTAPESO := ListaSQL.CONTAPESO || 
                                                      ListaSQL.TABWHERE ||
    --                                                  ListaSQL.SEMCTRCA1 || 
                                                      ListaSQL.NOTASWHERE || 
                                                      ListaSQL.SCWHERE ||  
                                                      vInstrucaoNRat   ||
                                                      ListaSQL.PQWHERE || 
                                                      ListaSQL.PQWHERErat;
                             Elsif trim(ListaCargaCli.ccTPCARGACLI) = '03' Then -- Expresso
                                ListaSQL.TESTAPESO := ListaSQL.CONTAPESO || 
                                                      ListaSQL.TABWHERE ||
    --                                                  ListaSQL.SEMCTRCA1 || 
                                                      ListaSQL.NOTASWHERE || 
                                                      ListaSQL.SCWHERE ||  
                                                      vInstrucaoNRat   ||
                                                      ListaSQL.EXWHERE || 
                                                      ListaSQL.EXWHERErat;
                             Elsif trim(ListaCargaCli.ccTPCARGACLI) in ('10') Then -- Rota Mestre
                                ListaSQL.TESTAPESO := ListaSQL.CONTAPESO || 
                                                      ListaSQL.TABWHERE ||
    --                                                  ListaSQL.SEMCTRC || 
                                                      ListaSQL.NOTASWHERE ||
                                                      ListaSQL.SCWHERE ||  
                                                      vInstrucaoNRat   ||
                                                      ListaSQL.RMWHERErat;
                             -- Na realidade e se tem rateio ou nao 
                             -- Sirlano VERIFICAR
                             Elsif trim(ListaCargaCli.ccTPCARGACLI) in ('01','11','41') Then -- Lotacao
                                ListaSQL.TESTAPESO := ListaSQL.CONTAPESO || 
                                                      ListaSQL.TABWHERE ||
    --                                                  ListaSQL.SEMCTRC || 
                                                      ListaSQL.NOTASWHERE ||
                                                      ListaSQL.SCWHERE ||  
                                                      vInstrucaoNRat   ||
                                                      ListaSQL.LotWHERErat;
                             Elsif trim(ListaCargaCli.ccTPCARGACLI) in ('09','02','12') Then -- Fracionado
                                ListaSQL.TESTAPESO := ListaSQL.CONTAPESO || 
                                                      ListaSQL.TABWHERE ||
    --                                                  ListaSQL.SEMCTRC || 
                                                      ListaSQL.NOTASWHERE ||
                                                      ListaSQL.SCWHERE ||  
                                                      vInstrucaoNRat   ||
                                                      ListaSQL.FraWHERErat;
                             Elsif trim(ListaCargaCli.ccTPCARGACLI) in ('15','19') Then -- Dedicado
                                ListaSQL.TESTAPESO := ListaSQL.TESTAPESO;
                             Elsif trim(ListaCargaCli.ccTPCARGACLI) in ('20') Then -- Fracionado
                                ListaSQL.TESTAPESO := ListaSQL.CONTAPESO || 
                                                      ListaSQL.TABWHERE ||
    --                                                  ListaSQL.SEMCTRC || 
                                                      ListaSQL.NOTASWHERE ||
                                                      ListaSQL.SCWHERE ||  
                                                      vInstrucaoNRat   ||
                                                      ListaSQL.WHERECOL;

                             Else
                                ListaSQL.TESTAPESO := ListaSQL.CONTAPESO || 
                                                      ListaSQL.TABWHERE ||
    --                                                  ListaSQL.SEMCTRC || 
                                                      ListaSQL.NOTASWHERE ||
                                                      ListaSQL.SCWHERE ||  
                                                      vInstrucaoNRat   ||
                                                      ' AND C.FCF_TPCARGA_CODIGO = ' || TDVADM.PKG_glb_common.fn_QuotedStr(ListaCargaCli.ccTPCARGACLIPESQ) ;
--                                ListaSQL.TESTAPESO := '';  
                             End If;
                         
                         End If; 
                         
                        If trim(sys_context('CARREGAMENTO','CODCARREG')) = trim(P_ARM_CARREGAMENTO) Then
                           vContextCount := vContextCount + 1; 
                           Insert Into TDVADM.T_glb_sql ( glb_sql_instrucao, 
                                                   glb_sql_dtgravacao, 
                                                   glb_sql_programa) 
                                          Values ( ListaSQL.TESTAPESO, 
                                                   Sysdate, 
                                                   lpad(vContextCount,3,'0') || '-' || P_ARM_CARREGAMENTO || '-Cursor=Conta Peso2 carregamento=' || P_ARM_CARREGAMENTO || 'TpCarga=' || ListaCargaCli.ccTPCARGACLI || '-' || ListaCargaCli.ccTPCARGACLIPESQ  || ' Retorna = ' || vTesteCarga.vRetorna  || ' Vez ' || to_char(tpLogGeracao.Con_Loggeracao_Codigo)||P_USU_USUARIOCRIA); 
                           vContextCount := vContextCount + 1; 
                           Insert Into TDVADM.T_glb_sql ( glb_sql_instrucao, 
                                                   glb_sql_dtgravacao, 
                                                   glb_sql_programa) 
                                          Values ( ListaSQL.FINALNOTA, 
                                                   Sysdate, 
                                                   lpad(vContextCount,3,'0') || '-' || P_ARM_CARREGAMENTO || '-Cursor=Lista Nota2 carregamento=' || P_ARM_CARREGAMENTO || 'TpCarga=' || ListaCargaCli.ccTPCARGACLI || '-' || ListaCargaCli.ccTPCARGACLIPESQ  || ' Retorna = ' || vTesteCarga.vRetorna  || ' Vez ' || to_char(tpLogGeracao.Con_Loggeracao_Codigo)||P_USU_USUARIOCRIA); 
                           commit;
                        End If;   


                        if length(trim(ListaSQL.TESTAPESO)) <> 0 Then
                           if trim(ListaCargaCli.ccTPCARGACLI) not in ('15','19') then
                              If nvl(trim(ListaCargaCli.ccPROCEDURE),'SEMPROC') = 'SEMPROC' Then
                                 EXECUTE IMMEDIATE (TRIM(ListaSQL.TESTAPESO))INTO V_LOTACAO,V_LOTACAOVLRMERC;
                                 tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'TESTA PESA PARA OBTER PESO LOTACAO TOTAL ' || V_LOTACAO;
                                 tpLogGeracao.Con_Loggeracao_Sql := TRIM(ListaSQL.TESTAPESO);
                                 P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;

                              /********** SIRLANO JANELA *************/
                                 If P_ARM_ARMAZEM = P_ARM_ARMAZEM Then 
                                    if ( ListaNotas.cnJanelaCons_Seq is not null ) and ( ListaNotas.cnGRUPOECSAC = '0020' ) then
                                       V_LOTACAO := nvl(ListaNotas.cnPesoCons,0);
                                       V_LOTACAOVLRMERC := nvl(ListaNotas.cnMercCons,0);
                                       tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Peguei Peso e Mercadoria pela Janela ' || V_LOTACAO;
                                       P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                    end If;
                                 End If;

                              End If;
                           End If;    
                        Else
                           V_LOTACAO := ListaNotas.CnPESOCOBRADO;
                           V_LOTACAOVLRMERC := ListaNotas.cnVLRMERC;
                           /********** SIRLANO JANELA *************/
                           If P_ARM_ARMAZEM = P_ARM_ARMAZEM Then 
                              if ( ListaNotas.cnJanelaCons_Seq is not null ) and ( ListaNotas.cnGRUPOECSAC = '0020' ) then
                                 V_LOTACAO := nvl(ListaNotas.cnPesoCons,0);
                                 V_LOTACAOVLRMERC := nvl(ListaNotas.cnMercCons,0);
                                 tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'PEGANDO LOTACAO MODO ANTERIOR ' || V_LOTACAO || chr(10);
                                 V_LOTACAO := nvl(ListaNotas.cnPesoCons,0);
                                 V_LOTACAOVLRMERC := nvl(ListaNotas.cnMercCons,0);
                                 tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML || 'Peguei Peso e Mercadoria pela Janela ' || V_LOTACAO;
                                 P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                              end If;
                           End If;

                        End If;     
                         
                      Else -- ccRATEIA = 'N'
                         if nvl(V_LOTACAO,0) = 0 Then
                            V_LOTACAO := ListaNotas.CnPESOCOBRADO;                      
                            V_LOTACAOVLRMERC := ListaNotas.cnVLRMERC;
                         Else
                            V_LOTACAO  := V_LOTACAO + ListaNotas.CnPESOCOBRADO ; --vBusca_Frete.vPESOTOTAL + ListaNotas.CnPESOCOBRADO;
                            V_LOTACAOVLRMERC := V_LOTACAOVLRMERC + ListaNotas.cnVLRMERC;
                         End If;
                      End If;  

          -- PEGA O TIPO DE VEICULO PARA A CARGA
        
              -- Se For Modo antigo Nao usa veiculo
              If nvl(ListaNotas.cnTABSOLCOD,SemTabelaCodigo) <> SemTabelaCodigo Then
                 ListaCargaCli.ccUSAVEICULO := 'N';
              End If;

              IF ListaCargaCli.ccUSAVEICULO = 'N' Then -- trim(ListaCargaCli.ccTPCARGACLI) in ('02','06','08','10','12','13','14') THEN
                 V_CODIGOVEICULO := '9  ';
              Else
                 tpLogGeracao.Con_Loggeracao_Sql := ListaSQL.TESTAPESO;


                     SP_TESTA_VEICULOPASSADO(V_GRUPOCARGAS,
                                             V_CONTRATOCARGAS,
                                             V_SACADOCARGA,
                                             vTesteCarga.vTestePeso,
                                             V_CIFFOB,
                                             ListaNotas.cnTIPOTRANSP,
                                             ListaCargaCli.ccTPCARGACLI,
                                             ListaCargaCli.ccPESQVEICULO,
                                             V_CODIGOVEICULO,
                                             vStatus,
                                             vMessage);
                                            

                     If vStatus = 'E' Then
                        tpLogGeracaO.Con_Loggeracao_ErroHTML := 'F-' || chr(10) || vMessage;
                        vErroFatal := 'E';
                     Else
                        tpLogGeracaO.Con_Loggeracao_ErroHTML := vMessage;
                     End If;                                    
                     P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;

              End IF;   
              ListaVaux.cnTpVeiculo := V_CODIGOVEICULO;
              SELECT TV.FCF_TPVEICULO_DESCRICAO
                INTO V_TIPOVEICULO
              FROM TDVADM.T_FCF_TPVEICULO TV
              WHERE TV.FCF_TPVEICULO_CODIGO = V_CODIGOVEICULO;

                    -- se spot verificar como vamos fazer
                    -- Nao vai achar praca
                    vBusca_Frete.vLOCALIDADEORIGEM  := ListaNotas.cnCOLETA;  -- ListaNotas.cnORIGEM
                    vBusca_Frete.vLOCALIDADEDESTINO := ListaNotas.cnENTREGA; -- ListaNotas.cnDESTINO
                    vBusca_Frete.vLOCALIDADEOUTRACOL := ListaNotas.cnOUTRACOLETA;
                    vBusca_Frete.vLOCALIDADEOUTRAENT := ListaNotas.cnOUTRAENTREGA;

                    vBusca_Frete.vTIPOFRETE         := V_CIFFOB;
                    vBusca_Frete.vTPCARGA           := ListaCargaCli.ccTPCARGACLI;
                    vBusca_Frete.vRATEIA            := ListaCargaCli.ccRATEIA;
                    vBusca_Frete.vPESOMINIMO        := ListaCargaCli.ccPESOMINIMO;
                    vBusca_Frete.vCLIENTE           := V_SACADOCARGA;
                    vBusca_Frete.vGRUPO             := V_GRUPOCARGAS; --NO CASO DE LOTACAO PARA PEGAR O TIPO DE VEICULO USANDO O PESO TOTAL DA CARGA
                    vBusca_Frete.vCONTRATO          := V_CONTRATOCARGAS;
                    vBusca_Frete.vTPVEICULO         := V_CODIGOVEICULO;
                    vBusca_Frete.vKM                := ListaVaux.cnKM;
                    if ( nvl(V_LOTACAO,0) = 0 ) and ListaVaux.cnContaNotas = 1 Then
                       if V_PESOCOBTOTAL = 0 Then
                          vBusca_Frete.vPESOTOTAL    := ListaNotas.CnPESOCOBRADO;                      
                          vBusca_Frete.vPESO         := ListaNotas.CnPESOCOBRADO;
                          vBusca_frete.vVlrMerc      := ListaNotas.cnVLRMERC;
                          vBusca_frete.vVlrMercTOTAL := ListaNotas.cnVLRMERC;
                       Else
                          vBusca_Frete.vPESOTOTAL    := V_PESOCOBTOTAL ; --vBusca_Frete.vPESOTOTAL + ListaNotas.CnPESOCOBRADO;
                          vBusca_Frete.vPESO         := V_PESOCOBTOTAL;
                          vBusca_frete.vVlrMerc      := V_VALORTOTMERCADORIA;
                          vBusca_frete.vVlrMercTOTAL := V_VALORTOTMERCADORIA;
                       End If;
                    Else   
                       vBusca_Frete.vPESOTOTAL    := V_LOTACAO;
                       vBusca_Frete.vPESO         := ListaNotas.CnPESOCOBRADO;
                       vBusca_frete.vVlrMerc      := V_LOTACAOVLRMERC;
                       vBusca_frete.vVlrMercTOTAL := ListaNotas.cnVLRMERC;
                    End IF;   
                    vBusca_Frete.vEntCol            := ListaQuebras.ENTCOL;
                    ListaVaux.cnColetaValor     := 0;
                    
                    tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML :=  fni_retcenario('DADOS PARA A BUSCA DO FRETE');
                    P_RETORNOPROCESSAMENTO :=  fn_InsereLogGeracao;
                    
                    vBusca_Frete.vOrigem := 'SP_CON_CRIACTRCCARREG'; 
                    vBusca_Frete.vPesqFRETECOLETA := 'F';
                    SP_BUSCA_FRETEEMPRESA(vBusca_Frete,
                                          ListaCargaCli,
                                          vRetBuscaFrete,
                                          V_MENSAGEM);
                      
                    
                    if nvl(vBusca_Frete.vPESOTOTAL,-1) <= 0 Then
                       tpLogGeracaO.Con_Loggeracao_ErroHTML := 'PESO TOTAL Nao APURADO BUSCANDO FRETE';
                       P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                    End If;
                    
                    ListaVaux.cnTABSOLCODANT       := ListaNotas.cnTABSOLCOD;   

                    ListaNotas.cnTABSOLCOD := nvl(vRetBuscaFrete.SLF_TABELA_CODIGO,TDVADM.PKG_FIFO_CARREGCTRC.SemTabelaCodigo);
                    ListaNotas.cnTABSOLSQ  := nvl(vRetBuscaFrete.SLF_TABELA_SAQUE,TDVADM.PKG_FIFO_CARREGCTRC.SemTabelaSaque);
                    ListaNotas.cnTABSOL    := 'T';  
                    
                     If vRetBuscaFrete.vRetorno = 'NE' Then
--                         tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Retorno NE ' || V_MENSAGEM;
                         tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML  := fni_retcenario('NAO ENC TAB FRETE PARA: ');
                         vAuxiliarchar := fn_InsereLogGeracao;
                     End If;
                     
                     -- Verifica se vai calcular a coleta
                     If  P_RETORNOPROCESSAMENTO = 'N' and  vRetBuscaFrete.vRetorno <> 'NE' Then

                        ListaVaux.cnColetaValor := 0;
                        If ( ListaCargaCli.ccColetaCobra = 'S' ) and ( ListaNotas.cnEntregaCol = 'C' )  Then



                           
                        
                           -- Pega a localidade real da Coleta e Nao a calculada
                           ListaVaux.cnRemetenteLoc := TDVADM.PKG_FIFO_CARREGCTRC.fn_RetOrigDestNota('CNR',
                                                                                              ListaNotas.cnNOTA,
                                                                                              ListaNotas.cnCLIREM,
                                                                                              ListaNotas.cnSERIENF,
                                                                                              ListaNotas.cnNRCOLETA,
                                                                                              ListaNotas.cnNrColetaCiclo,
                                                                                              listaNotas.cnCHAVENFE,
                                                                                              90);
                           ListaVaux.cnColetaKM := fni_ConsultaKM(ListaNotas.cnORIGEMCli,
                                                                  trim(fn_RetLocalidadeArmazem(P_ARM_ARMAZEM)));

                            if ( ListaVaux.cnColetaKM <= 0 ) and ( ListaCargaCli.ccUSAFAIXAKM = 'S') Then
                               tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Busca de KM Com ERRO : Origem ' || ListaNotas.cnORIGEMCli || ' - Destino ' || trim(fn_RetLocalidadeArmazem(P_ARM_ARMAZEM)); 
                               
                               If nvl(ListaVaux.cnColetaKM,0) = wservice.pkg_web.CLocalidadeNaoEncontrada Then
                                   tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Localidade Nao Encontrada na TDV';
                               ElsIf nvl(ListaVaux.cnColetaKM,0) = wservice.pkg_web.CErroAcessandoGOOGLE Then
                                   tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Erro Acessando o Google';
                               ElsIf nvl(ListaVaux.cnColetaKM,0) = wservice.pkg_web.CErroLendoXML Then
                                   tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Erro Lendo o XML';
                               ElsIf nvl(ListaVaux.cnColetaKM,0) = wservice.pkg_web.CSemROTA Then
                                   tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Localidade Nao acessivel por veiculo';
                               ElsIf nvl(ListaVaux.cnColetaKM,0) = wservice.pkg_web.CKmErrado Then
                                   tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Km Nao numerico';
                               End IF;
                               P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                            End If;

                           
                           
                           Begin 
                              select co.arm_coleta_placa,
                                     co.glb_cliente_cgccpfcodigocoleta,
                                     trunc(co.arm_coleta_dtprogramacao)
                                 into ListaVaux.cnColetaPlaca,
                                      ListaVaux.cnColetaRemetente,
                                      ListaVaux.cnColetaData
                              From TDVADM.T_arm_coleta co
                              where co.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
                                and co.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo;
                                                
                              -- Peso          
                              /*
                              Sirlano 14/01/2020
                              Usado para guardar o Peso total da Coleta por PLACA
                              */      
                              select sum(n.arm_nota_peso)
                                into ListaVaux.cnColetaPesoPlaca
                              From TDVADM.T_arm_nota n,
                                   TDVADM.T_arm_carregamentodet cdet,
                                   TDVADM.T_arm_coleta co
                              Where 0 = 0
                                and n.arm_embalagem_numero = cdet.arm_embalagem_numero
                                and n.arm_embalagem_flag = cdet.arm_embalagem_flag
                                and n.arm_embalagem_sequencia = cdet.arm_embalagem_sequencia
                                and n.arm_coleta_ncompra = co.arm_coleta_ncompra
                                and n.arm_coleta_ciclo = co.arm_coleta_ciclo
                                and nvl(co.arm_coleta_placa,'XXXXXXX') = nvl(ListaVaux.cnColetaPlaca,'XXXXXXX')
                                and co.glb_cliente_cgccpfcodigocoleta = ListaVaux.cnColetaRemetente
                                and trunc(co.arm_coleta_dtprogramacao) = ListaVaux.cnColetaData
                                and cdet.arm_carregamento_codigo = P_ARM_CARREGAMENTO;

                             ListaVaux.cnColetaPesoPlaca  := nvl(ListaVaux.cnColetaPesoPlaca,0);
                             ListaVaux.cnColetaPeso := ListaVaux.cnColetaPesoPlaca ;

                              -- Acerta o KM da Coleta
                              if ( ListaVaux.cnColetaKM * 2 ) < ListaCargaCli.ccKMMinimo Then
                                  ListaVaux.cnColetaKM := ListaCargaCli.ccKMMinimo;
                              Else
                                  -- VEr para retirar isto
                                  ListaVaux.cnColetaKM := ListaVaux.cnColetaKM ;/** 2;*/
                              End If;

                              vBusca_FreteCol.vLOCALIDADEORIGEM  := ListaNotas.cnORIGEMCli;
                              vBusca_FreteCol.vLOCALIDADEDESTINO := trim(fn_RetLocalidadeArmazem(P_ARM_ARMAZEM));

                              vBusca_FreteCol.vLOCALIDADEOUTRACOL := ListaNotas.cnOUTRACOLETA;
                              vBusca_FreteCol.vLOCALIDADEOUTRAENT := ListaNotas.cnOUTRAENTREGA;

                              vBusca_FreteCol.vTIPOFRETE         := V_CIFFOB;
                              vBusca_FreteCol.vTPCARGA           := ListaCargaCli.ccTPCARGACLICOL;
--                              vBusca_FreteCol.vRATEIA            := ListaCargaCli.ccRATEIA;
--                              vBusca_FreteCol.vPESOMINIMO        := ListaCargaCli.ccPESOMINIMO;
                              vBusca_FreteCol.vCLIENTE           := V_SACADOCARGA;
                              vBusca_FreteCol.vGRUPO             := V_GRUPOCARGAS; --NO CASO DE LOTACAO PARA PEGAR O TIPO DE VEICULO USANDO O PESO TOTAL DA CARGA
                              vBusca_FreteCol.vCONTRATO          := V_CONTRATOCARGAS;
                              vBusca_FreteCol.vPESOTOTAL         := ListaVaux.cnColetaPeso;
                              vBusca_FreteCol.vPESO              := ListaVaux.cnColetaPeso;
                              
                              select co.fcf_tpveiculo_codigo
                                 into vBusca_FreteCol.vTPVEICULO
                              from TDVADM.T_arm_coleta co
                              where co.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
                                and co.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo   ;
                             
                             -- Se For Modo antigo Nao usa veiculo 
                             If vRetBuscaFrete.vRetorno = 'MA' then -- nvl(ListaNotas.cnTABSOLCOD,SemTabelaCodigo) <> SemTabelaCodigo )  Then
                                ListaCargaCli.ccUSAVEICULO := 'N';
                             End If;

                             If ListaCargaCli.ccUSAVEICULOCOL = 'N' Then
                                vBusca_FreteCol.vTPVEICULO := '9  ';
                             Else
                                 SP_TESTA_VEICULOPASSADO(V_GRUPOCARGAS,
                                                         V_CONTRATOCARGAS,
                                                         V_SACADOCARGA,
                                                         0, -- Verificar e pegar o peso da Coleta
                                                         V_CIFFOB,
                                                         null,
                                                         ListaCargaCli.ccTPCARGACLICOL,
                                                         ListaCargaCli.ccPESQVEICULOCOL,
                                                         vBusca_FreteCol.vTPVEICULO,
                                                         vStatus,
                                                         vMessage);
                                                        

                                 -- Sera ignorado o Erro Fatal
                                 If vStatus = 'E' Then
                                    tpLogGeracaO.Con_Loggeracao_ErroHTML := 'F-' || chr(10) || vMessage;
                                    vErroFatal := 'E';
                                 Else
                                    tpLogGeracaO.Con_Loggeracao_ErroHTML := vMessage;
                                 End If;                                    
                                 P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;

                             End If;
                                 
                              vBusca_FreteCol.vKM                := ListaVaux.cnColetaKM;

                              vBusca_FreteCol.vOrigem := 'SP_CON_CRIACTRCCARREG'; 
                              vBusca_FreteCol.vPesqFRETECOLETA := 'C';
                              
                              SP_BUSCA_FRETEEMPRESA(vBusca_FreteCol,
                                                    ListaCargaCli,
                                                    vRetBuscaFreteCol,
                                                    V_MENSAGEM);
                             

                              if nvl(vBusca_FreteCol.vPESOTOTAL,-1) <= 0 Then
                                 tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Peso Total Nao Apurado Buscando COLETA';
                                 vAuxiliarchar := fn_InsereLogGeracao;
                              End If;
                              vAuxiliarnumerico := 0;
                              -- Pegar a Tabela e saque da Coleta.
                               If vRetBuscaFreteCol.vRetorno = 'NE' Then
          --                         tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Retorno NE ' || V_MENSAGEM;
                                   tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML  := fni_retcenario('NAO ENC TAB FRETE PARA COLETA ');
                                   vAuxiliarchar := fn_InsereLogGeracao;
                                   vAuxiliarnumerico := 0;
                                   
                                   ListaVerbasCol('V_PERCTT').Value := 0;
                                   ListaVerbasCol('V_PSRATEIO').Value := 0;
                                   ListaVerbasCol('V_FTRATEIO').Value := 0;
                                   ListaVerbasCol('V_PERCTO').Value := 0;
                                   ListaVerbasCol('V_PERCTR').Value := 0; 
                                   ListaVerbasCol('D_FRPSVO').Value := 0;
                                   ListaVerbasCol('D_FRPSVO').AsDesinencia := 'NA';

                                   If nvl(ListaCargaCli.ccParaSemPCC,'S') = 'S' AND ListaNotas.cnTpCarga <> 'CD' Then
                                      vErroFatal := 'E';
                                      tpLogGeracaO.Con_Loggeracao_ErroHTML := 'F-NAO ENCONTROU PRECO PARA COBRANCA DA COLETA';
                                      P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                   End If;
                                   
                               Else
                                 
                               
                               
                                 

                                   IF ( ListaCargaCli.ccFORMULACOLTX is not null ) OR
                                      ( ListaCargaCli.ccFORMULACOLVL IS NOT NULL ) OR 
                                      ( ListaCargaCli.ccFORMULACOLKM IS NOT NULL ) then

                                      
                                    -- Cobra quimico da Coleta somente se a Nota foi quimica              
                                    if nvl(ListaNotas.cnONU,OnuNaoQuimico) <> OnuNaoQuimico Then
--                                    if nvl(vTesteCarga.vTemQuimico,'N') = 'S' Then
                                       ListaVerbasCol('V_PERCTQ').AsFloat      := ListaCargaCli.ccPERCTQM;
                                       ListaVerbasCol('V_PERCTQ').Value        := trim(to_char(ListaCargaCli.ccPERCTQM));
                                       ListaVerbasCol('V_PERCTQ').AsDesinencia := '%';
                                    Else
                                       ListaVerbasCol('V_PERCTQ').AsFloat      := 1;
                                       ListaVerbasCol('V_PERCTQ').Value        := '1';
                                       ListaVerbasCol('V_PERCTQ').AsDesinencia := '%';
                                    End If;

                                    if ( trim(vTesteCarga.vGrupoRem) = trim(vTesteCarga.vGrupoSac) ) AND 
                                       ( trim(vTesteCarga.vGrupoDes) <>  trim(vTesteCarga.vGrupoSac) ) Then
                                        ListaVerbasCol('V_PERCTO').AsFloat      := ListaCargaCli.ccPERCTOUT;
                                        ListaVerbasCol('V_PERCTO').Value        := trim(to_char(ListaCargaCli.ccPERCTOUT));
                                        ListaVerbasCol('V_PERCTO').AsDesinencia := '%';
                                    Else
                                        ListaVerbasCol('V_PERCTO').AsFloat      := 1;
                                        ListaVerbasCol('V_PERCTO').Value        := '1';
                                        ListaVerbasCol('V_PERCTO').AsDesinencia := '%';
                                    End If;

                                    if ( trim(vTesteCarga.vGrupoRem) = trim(vTesteCarga.vGrupoDes)) and 
                                       ( trim(vTesteCarga.vGrupoSac) = trim(vTesteCarga.vGrupoDes))
                                     Then
                                       ListaVerbasCol('V_PERCTT').AsFloat      := ListaCargaCli.ccPERCTRA;
                                       ListaVerbasCol('V_PERCTT').Value        := trim(to_char(ListaCargaCli.ccPERCTRA));
                                       ListaVerbasCol('V_PERCTT').AsDesinencia := '%';
                                    Else  
                                       ListaVerbasCol('V_PERCTT').AsFloat      := 1;
                                       ListaVerbasCol('V_PERCTT').Value        := '1';
                                       ListaVerbasCol('V_PERCTT').AsDesinencia := '%';
                                    End If;   

                                    if nvl(vTesteCarga.vTemExpresso,'N') = 'S' Then
                                       ListaVerbasCol('V_PERCTE').AsFloat      := ListaCargaCli.ccPERCTEX;
                                       ListaVerbasCol('V_PERCTE').Value        := trim(to_char(ListaCargaCli.ccPERCTEX));
                                       ListaVerbasCol('V_PERCTE').AsDesinencia := '%';
                                    Else  
                                       ListaVaux.cnPercentEx := 1;
                                       ListaVerbasCol('V_PERCTE').AsFloat      := 1;
                                       ListaVerbasCol('V_PERCTE').Value        := '1';
                                       ListaVerbasCol('V_PERCTE').AsDesinencia := '%';
                                    End If;    


                                    ListaVerbasCol('V_PERCTR').AsFloat      := ListaCargaCli.ccPERCTREDUTOR;
                                    ListaVerbasCol('V_PERCTR').Value        := trim(to_char(ListaCargaCli.ccPERCTREDUTOR));
                                    ListaVerbasCol('V_PERCTR').AsDesinencia := '%';


--                                    If V_PESOEXCEDENTE > 0 Then
                                       -- PEGAR O PESO DA COLETA
                                      /*
                                        Sirlano 14/01/2020
                                        Usado para guardar o Peso total da Coleta pelo numero dela
                                      */      
                                       select sum(an.arm_nota_pesobalanca)
                                          into ListaVaux.cnColetaPesonrColeta
                                       from tdvadm.t_arm_nota an
                                       where an.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
                                         and an.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo;

                                       ListaVaux.cnColetaPesonrColeta := nvl(ListaVaux.cnColetaPesonrColeta,0) / 1000 ;

                                    /*
                                      Sirlano 14/01/2020
                                      Criado variavel para substituicao em formula do peso total da coleta
                                      Ver regra para usar o pesos total por numero ou opor placa
                                    */      
                                    ListaVerbasCol('V_PSCOLETA').AsFloat := ListaVaux.cnColetaPesonrColeta; 
                                    ListaVerbasCol('V_PSCOLETA').Value   := trim(to_char((ListaVerbasCol('V_PSCOLETA').AsFloat)));
                                     
                                    ListaVerbasCol('V_PSEXEC').AsFloat := V_PESOEXCEDENTE;
                                    ListaVerbasCol('V_PSEXEC').Value   := trim(to_char((ListaVerbasCol('V_PSEXEC').AsFloat)));

                                    ListaVerbasCol('V_PSLIM').AsFloat := ( vRetBuscaFreteCol.SLF_CALCFRETEKM_LIMITE/1000 ) ;
                                    ListaVerbasCol('V_PSLIM').Value   := trim(to_char((ListaVerbasCol('V_PSLIM').AsFloat)));
                                       
                                    ListaVerbasCol('V_VLREXEC').AsFloat := vRetBuscaFreteCol.SLF_CALCFRETEKM_VALORE;
                                    ListaVerbasCol('V_VLREXEC').Value   := trim(to_char((vRetBuscaFreteCol.SLF_CALCFRETEKM_VALORE)));
                                    ListaVerbasCol('V_VLREXEC').AsDesinencia := vRetBuscaFreteCol.SLF_CALCFRETEKM_DESINENCIAE;

                                    ListaVerbasCol('V_VLRFIXO').AsFloat      := nvl(vRetBuscaFreteCol.SLF_CALCFRETEKM_VALORF,0);
                                    ListaVerbasCol('V_VLRFIXO').Value        := trim(to_char(nvl(vRetBuscaFreteCol.SLF_CALCFRETEKM_VALORF,0)));
                                    ListaVerbasCol('V_VLRFIXO').AsDesinencia := vRetBuscaFreteCol.SLF_CALCFRETEKM_DESINENCIAF;


                                    ListaVerbasCol('D_FRPSVO').AsFloat      := vRetBuscaFreteCol.SLF_CALCFRETEKM_VALOR;
                                    ListaVerbasCol('D_FRPSVO').Value        := trim(to_char(vRetBuscaFreteCol.SLF_CALCFRETEKM_VALOR));
                                    ListaVerbasCol('D_FRPSVO').AsDesinencia := vRetBuscaFreteCol.SLF_CALCFRETEKM_DESINENCIA;


                                    ListaVerbasCol('S_KMPER').AsFloat      := vBusca_Frete.vKM;
                                    ListaVerbasCol('S_KMPER').Value        := trim(to_char(vBusca_Frete.vKM));
                                    ListaVerbasCol('S_KMPER').AsDesinencia := 'VL';

                                    ListaVerbasCol('S_KMCOL').AsFloat      := ListaVaux.cnColetaKM;
                                    ListaVerbasCol('S_KMCOL').Value        := trim(to_char(ListaVaux.cnColetaKM));
                                    ListaVerbasCol('S_KMCOL').AsDesinencia := 'VL';


/*                                    ListaVerbasCol('D_PSREAL').AsFloat := round(vBusca_Frete.vPESOTOTAL,3);
                                    ListaVerbasCol('D_PSREAL').Value   := trim(to_char((round(vBusca_Frete.vPESOTOTAL,3))));

                                    ListaVerbasCol('I_PSCOBRAD').AsFloat := round(vBusca_Frete.vPESOTOTAL,3);
                                    ListaVerbasCol('I_PSCOBRAD').Value   := trim(to_char((round(vBusca_Frete.vPESOTOTAL,3))));
*/
                                    ListaVerbasCol('D_PSREAL').AsFloat := (vBusca_Frete.vPESOTOTAL/1000);
                                    ListaVerbasCol('D_PSREAL').Value   := trim(to_char((ListaVerbasCol('D_PSREAL').AsFloat)));

                                    ListaVerbasCol('I_PSCOBRAD').AsFloat := (vBusca_Frete.vPESOTOTAL/1000);
                                    ListaVerbasCol('I_PSCOBRAD').Value   := trim(to_char((ListaVerbasCol('I_PSCOBRAD').AsFloat)));


                                    ListaVerbasCol('I_VLMR').AsFloat := vBusca_fRETE.vVlrMercTOTAL;
                                    ListaVerbasCol('I_VLMR').Value   := trim(to_char(vBusca_fRETE.vVlrMercTOTAL));
                                    ListaVerbasCol('I_VLMR').AsDesinencia := 'VL';
                                    
                                    ListaVerbasCol('D_VLRSEGUR').AsFloat := vBusca_fRETE.vVlrMercTOTAL;
                                    ListaVerbasCol('D_VLRSEGUR').Value   := trim(to_char(vBusca_fRETE.vVlrMercTOTAL));
                                    ListaVerbasCol('D_VLRSEGUR').AsDesinencia := 'VL';



                                    ListaVerbasCol('V_PSRATEIO').AsFloat      := vBusca_Frete.vPESOTOTAL;
                                    ListaVerbasCol('V_PSRATEIO').Value        := trim(to_char(vBusca_Frete.vPESOTOTAL));
                                    ListaVerbasCol('V_PSRATEIO').AsDesinencia := '%';

                                    ListaVerbasCol('V_FTRATEIO').AsFloat      := 1;
                                    ListaVerbasCol('V_FTRATEIO').Value        := '1';
                                    ListaVerbasCol('V_FTRATEIO').AsDesinencia := '%';



                                    ListaVerbasCol('S_ALICMS').AsFloat := 1;
                                    ListaVerbasCol('S_ALICMS').Value   := '1';

                                    ListaVerbasCol('S_ALISS').AsFloat := 1;
                                    ListaVerbasCol('S_ALISS').Value   := '1';

                                    ListaVerbasCol('D_PD').AsFloat := 0;                               
                                    ListaVerbasCol('D_PD').Value   := '0';


                                -- If trim(ListaCargaCli.ccTPCARGACLI) IN ('10','11','12','13','14','15') Then 
                                if ListaCargaCli.ccFORMULACOLTX is not null then
                                    vAuxiliarnumerico := 0;
                                    if ListaVerbasCol('D_FRPSVO').AsDesinencia = 'TX' Then
                                       vFormulaTraduzidaF := ' SELECT ' || fn_MudaFormula(ListaCargaCli.ccFORMULACOLTX,ListaVerbasCol) || ' FROM DUAL ';
                                    Elsif ListaVerbasCol('D_FRPSVO').AsDesinencia = 'KM' Then
                                       vFormulaTraduzidaF := ' SELECT ' || fn_MudaFormula(ListaCargaCli.ccFORMULACOLKM,ListaVerbasCol) || ' FROM DUAL ';
                                       ListaVerbasCol('D_FRPSVO').AsDesinencia := 'VL';
                                    Else
                                       vFormulaTraduzidaF := ' SELECT ' || fn_MudaFormula(ListaCargaCli.ccFORMULACOLVL,ListaVerbasCol) || ' FROM DUAL ';
                                    End If;   
                                    execute immediate vFormulaTraduzidaF into vAuxiliarnumerico;

                                      tpLogGeracao.Con_Loggeracao_FormulaTRA := vFormulaTraduzidaP;
                                      tpLogGeracao.Con_Loggeracao_Formula    := vFormulaTraduzidaF;
                                      tpLogGeracao.Arm_Nota_Peso             := to_char(vBusca_Frete.vPESO);
                                      tpLogGeracao.Arm_Nota_PesoTOTAL        := to_char(vBusca_Frete.vPESOTOTAL);
                                      tpLogGeracao.Con_Loggeracao_Fator      := ListaVerbasCol('V_FTRATEIO').Value;

                                    if ListaVerbasCol('V_FTRATEIO').AsFloat  > 1 Then
                                       vErroFatal := 'E';
                                       tpLogGeracaO.Con_Loggeracao_ErroHTML  := 'F-FATOR RATEIO MUITO ALTO PESO COBRADO - COLETA' ||  TO_CHAR(V_PESOCOBTOTAL) || ' PESO TOTAL ' ||  TO_CHAR(V_LOTACAO) || ' FATOR ' ||  ListaVerbas('V_FTRATEIO').Value;
                                       P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                    End If;


                                      update TDVADM.T_arm_coleta co
                                        set co.arm_coleta_valor = nvl(vAuxiliarnumerico,0)
                                      where co.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
                                        and co.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo
                                        and nvl(co.arm_coleta_valor,0) <> nvl(vAuxiliarnumerico,0) ;
                                      commit; 
                                      -- Procura se esta coleta ja esta sendo cobrada
                                      vAuxiliarnumerico2 := 1;
                                      -- Verifica se ja existe alguma cobranca de coleta
                                      If vAuxiliarCOBCOL > 0 Then 
                                         loop
                                             if trim(vListaCOBCOL(vAuxiliarnumerico2).pColeta) = trim(ListaNotas.cnNRCOLETA) Then
                                                vAuxiliarnumerico := 0;
                                                exit;
                                             End If;
                                             vAuxiliarnumerico2 := vAuxiliarnumerico2 + 1;
                                             Exit When (vAuxiliarnumerico2 > vAuxiliarCOBCOL);
                                         end loop;
                                      End If;

                                      If nvl(vAuxiliarnumerico,0) > 0 Then
                                         vAuxiliarCOBCOL := vAuxiliarCOBCOL + 1;
                                         vListaCOBCOL(vAuxiliarCOBCOL).pTpCobranca   := ListaCargaCli.ccCteColeta;
                                         vListaCOBCOL(vAuxiliarCOBCOL).pNota         := ListaNotas.cnNOTA;
                                         vListaCOBCOL(vAuxiliarCOBCOL).pRemetente    := ListaNotas.cnCLIREM;
                                         vListaCOBCOL(vAuxiliarCOBCOL).pSerie        := ListaNotas.cnSERIENF;
                                         vListaCOBCOL(vAuxiliarCOBCOL).pSequencia    := ListaNotas.cnSequencia;
                                         vListaCOBCOL(vAuxiliarCOBCOL).pColeta       := ListaNotas.cnNRCOLETA;
                                         vListaCOBCOL(vAuxiliarCOBCOL).pCiclo        := ListaNotas.cnNrColetaCiclo;
                                         vListaCOBCOL(vAuxiliarCOBCOL).pCteCod       := V_CTRCCODIGO;
                                         vListaCOBCOL(vAuxiliarCOBCOL).pCteRT        := ListaNotas.cnROTA;
                                         vListaCOBCOL(vAuxiliarCOBCOL).pCteSr        := 'XXX';
                                         vListaCOBCOL(vAuxiliarCOBCOL).pBuscaFrete   := vBusca_FreteCol;
                                         vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete     := vRetBuscaFreteCol;
                                         vListaCOBCOL(vAuxiliarCOBCOL).pValor        := nvl(vAuxiliarnumerico,0);
                                         vListaCOBCOL(vAuxiliarCOBCOL).pPesoReal     := ListaVerbasCol('D_PSREAL').AsFloat;
                                         vListaCOBCOL(vAuxiliarCOBCOL).pPesoCobrado  := ListaVerbasCol('I_PSCOBRAD').AsFloat;
                                         vListaCOBCOL(vAuxiliarCOBCOL).pValorMerc    := ListaVerbasCol('I_VLMR').AsFloat;
                                         vListaCOBCOL(vAuxiliarCOBCOL).pValorMercSeg := ListaVerbasCol('D_VLRSEGUR').AsFloat;
                                      End If;   

                                      tpLogGeracao.Con_Loggeracao_FormulaTRA := null;
                                      tpLogGeracao.Con_Loggeracao_Formula    := null;
                                      tpLogGeracao.Arm_Nota_Peso             := null;
                                      tpLogGeracao.Arm_Nota_PesoTOTAL        := null;
                                      tpLogGeracao.Con_Loggeracao_Fator      := null;

                                End If;
                           End If;
                                
                       End If;



                   exception
                     When NO_DATA_FOUND Then
                        vAuxiliarnumerico := 0;
                     End ;
                           
                      ListaVaux.cnColetaValor := vAuxiliarnumerico;  

                      if vRetBuscaFreteCol.SLF_CALCFRETEKM_VALORF <= 0 Then
                          vAuxiliarnumerico := -1;   
                      End If;

                 Begin
                     tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML  := 'Cenario da Cobranca de Coleta ' || chr(10) ||
                                                                ' Nota ' || ListaNotas.cnNOTA || chr(10) ||  
                                                                ' Coleta ' || ListaNotas.cnNRCOLETA || '-' || ListaNotas.cnNrColetaCiclo || chr(10) ||
                                                                ' Armazem ' || ListaVaux.cnArmazemLoc || '-' || tdvadm.fn_busca_codigoibge(ListaVaux.cnArmazemLoc,'IBD') || chr(10) ||
                                                                ' Coleta MUNICIPIO ' || vBusca_FreteCol.vLOCALIDADEORIGEM  || '-' || tdvadm.fn_busca_codigoibge(vBusca_FreteCol.vLOCALIDADEORIGEM,'IBD') || chr(10) ||
                                                                ' Coleta MESO ' || vBusca_FreteCol.vLOCALIDADEORIGEM  || '-' || tdvadm.fn_busca_codigoibge(vBusca_FreteCol.vLOCALIDADEORIGEM,'MED') || chr(10) ||
                                                                ' Coleta MICRO ' || vBusca_FreteCol.vLOCALIDADEORIGEM  || '-' || tdvadm.fn_busca_codigoibge(vBusca_FreteCol.vLOCALIDADEORIGEM,'MID') || chr(10) ||
                                                                ' Entrega ' || vBusca_FreteCol.vLOCALIDADEDESTINO  || '-' || tdvadm.fn_busca_codigoibge(vBusca_FreteCol.vLOCALIDADEDESTINO,'IBD') || chr(10) ||
                                                                ' Carga Frete ' || ListaCargaCli.ccTPCARGACLI || '-' || ListaCargaCli.ccTPCARGACLIDESC || chr(10) ||
                                                                ' Carga Coleta ' || ListaCargaCli.ccTPCARGACLICOL || chr(10) ||
                                                                ' Carregamento ' || P_ARM_CARREGAMENTO || chr(10) ||
                                                                ' CTe ' || V_CTRCCODIGO || '-' || ListaNotas.cnROTA || chr(10) ||
                                                                ' Cobra coleta ' || ListaCargaCli.ccColetaCobra || chr(10) ||
                                                                ' Origem ' || vBusca_FreteCol.vLOCALIDADEORIGEM  || chr(10) ||
                                                                ' Destino ' || vBusca_FreteCol.vLOCALIDADEDESTINO || chr(10) ||
                                                                ' Km da Coleta ' || to_char(ListaVaux.cnColetaKM) || chr(10) ||
                                                                ' Peso da Coleta ' || to_char(ListaVaux.cnColetaPeso) || chr(10) ||
                                                                ' Peso Total   ' || to_char(vBusca_FreteCol.vPESOTOTAL) || chr(10) ||
                                                                ' Peso da Nota   ' || to_char(vBusca_FreteCol.vPESO) || chr(10) ||
                                                                ' Frete Localizado ' || to_char(vAuxiliarnumerico) || chr(10) ||
                                                                ' Placa da Coleta ' || trim(ListaVaux.cnColetaPlaca) || chr(10) ||
                                                                ' Placa do Conhecimento ' || trim(ListaNotas.cnCARRETEIROPLACA) || chr(10) ||
                                                                ' Placa Frota ' || trim(ListaNotas.cnCONJFROTA) || chr(10) ||
                                                                ' Veiculo     ' || vRetBuscaFreteCol.FCF_TPVEICULO_CODIGO || chr(10) ||
                                                                ' PercentPQ   ' || to_char(ListaVaux.cnPercentQP) || chr(10) ||
                                                                ' PercentEX   ' || to_char(ListaVaux.cnPercentEx) || chr(10) ||
                                                                ' FatorTransf ' || ListaVerbasCol('V_PERCTT').Value || chr(10) ||
                                                                ' PesoRateio  ' || ListaVerbasCol('V_PSRATEIO').Value || chr(10) ||
                                                                ' FatorRateio ' || ListaVerbasCol('V_FTRATEIO').Value || chr(10) ||
                                                                ' PercentOUT  ' || ListaVerbasCol('V_PERCTO').Value || chr(10) ||
                                                                ' Redutor     ' || ListaVerbasCol('V_PERCTR').Value || chr(10) || 
                                                                ' FreteVar    ' || ListaVerbasCol('D_FRPSVO').Value || chr(10) || 
                                                                ' DesVar      ' || ListaVerbasCol('D_FRPSVO').AsDesinencia || chr(10) || 
                                                                ' TpCargaNota- ' || ListaNotas.cnTpCarga || chr(10) || 
                                                                ' Formula Frete TX  - ' || ListaCargaCli.ccFORMULACOLTX || chr(10) ||
                                                                ' Formula Frete VL  - ' || ListaCargaCli.ccFORMULACOLVL || chr(10) ||
                                                                ' Formula Frete KM  - ' || ListaCargaCli.ccFORMULACOLKM || chr(10) ||
                                                                ' Formula traduzida - ' || vFormulaTraduzidaF || chr(10);
                        vAuxiliarchar := fn_InsereLogGeracao;
                  exception
                    When OTHERS Then
                       vAuxiliarchar := vAuxiliarchar;
                    End ;   


                         ListaVaux.cnColetaPeso := nvl(ListaVaux.cnColetaPeso,1);

                          
                    Begin
                            tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML  := 'Cenario da Cobranca de Coleta ' || chr(10) ||
                                                                       ' Nota ' || ListaNotas.cnNOTA || chr(10) ||  
                                                                       ' Coleta ' || ListaNotas.cnNRCOLETA || '-' || ListaNotas.cnNrColetaCiclo || chr(10) ||
                                                                       ' Armazem ' || ListaVaux.cnArmazemLoc || '-' || tdvadm.fn_busca_codigoibge(ListaVaux.cnArmazemLoc,'IBD') || chr(10) ||
                                                                       ' Coleta MUNICIPIO ' || vBusca_FreteCol.vLOCALIDADEORIGEM  || '-' || tdvadm.fn_busca_codigoibge(vBusca_FreteCol.vLOCALIDADEORIGEM,'IBD') || chr(10) ||
                                                                       ' Coleta MESO ' || vBusca_FreteCol.vLOCALIDADEORIGEM  || '-' || tdvadm.fn_busca_codigoibge(vBusca_FreteCol.vLOCALIDADEORIGEM,'MED') || chr(10) ||
                                                                       ' Coleta MICRO ' || vBusca_FreteCol.vLOCALIDADEORIGEM  || '-' || tdvadm.fn_busca_codigoibge(vBusca_FreteCol.vLOCALIDADEORIGEM,'MID') || chr(10) ||
                                                                       ' Entrega ' || vBusca_FreteCol.vLOCALIDADEDESTINO  || '-' || tdvadm.fn_busca_codigoibge(vBusca_FreteCol.vLOCALIDADEDESTINO,'IBD') || chr(10) ||
                                                                       ' Tipo Carga ' || ListaCargaCli.ccTPCARGACLICOL || chr(10) || 
                                                                       ' Cobra coleta ' || ListaCargaCli.ccColetaCobra || chr(10) ||
                                                                       ' Km da Coleta ' || to_char(ListaVaux.cnColetaKM) || chr(10) ||
                                                                       ' Peso da Coleta ' || to_char(ListaVaux.cnColetaPeso) || chr(10) ||
                                                                       ' Peso Total   ' || to_char(vBusca_FreteCol.vPESOTOTAL) || chr(10) ||
                                                                       ' Peso da Nota   ' || to_char(vBusca_FreteCol.vPESO) || chr(10) ||
                                                                       ' Valor Coleta   ' || to_char(ListaVaux.cnColetaValor) || chr(10) ||
                                                                       ' Fator Rateio   ' || to_char(ListaNotas.cnPESOCOBRADO / ListaVaux.cnColetaPeso) || chr(10) ||
                                                                       ' Verba Coleta   ' || ListaVerbasCol('D_FRPSVO').Value || chr(10) ||
                                                                       ' Frete Localizado ' || to_char(vAuxiliarnumerico);
                            vAuxiliarchar :=  fn_InsereLogGeracao;
                  exception
                    When OTHERS Then
                       vAuxiliarchar := vAuxiliarchar;
                    End ;   

                            -- Se For para Cobra em um Novo CTe e zerado a Verba da Coleta
                            If ListaCargaCli.ccCteColeta = 'N' Then
                               ListaVaux.cnColetaValor := 0;
                            -- Se For no Mesmo Mantem o Valor achado
                            ElsIf ListaCargaCli.ccCteColeta = 'M' Then
                               ListaVaux.cnColetaValor := ListaVaux.cnColetaValor;
                            End If;
                        Else
                            -- Se Nao e para Cobra coleta zera a Verba
                            ListaVaux.cnColetaValor := 0; 
                        End If;    
                     End If;
                     
                      IF tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC') = tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC') THEN
                         vDescCalculo := 'CALCULO ISS';
                         V_TPCALCULO := '115';
                         if ( ListaNotas.cnContrato = 'C2013010022' ) Then -- LOT-VOLKSWAGEN-0113-XXX
                            V_TPCALCULO := '316';
                         end If   ;
                         If ListaNotas.cnGRUPOECSAC = '0020' Then
                            V_TPCALCULO := '316';
                         End If;
                         ListaNotas.cnROTA      := ListaNotas.cnROTANF;
                      Else
                         vDescCalculo := 'CALCULO ICMS';
                         V_TPCALCULO := '041';
                         if ( ListaNotas.cnContrato = 'C2013010022' ) Then -- LOT-VOLKSWAGEN-0113-XXX
                            V_TPCALCULO := '315';
                         end If   ;
                         If ListaNotas.cnGRUPOECSAC = '0020' Then
                            V_TPCALCULO := '315';
                         End If;
                      END IF;
                    
                  /****************************************************************/                    
                      IF ( trim(ListaCargaCli.ccTPCARGACLI) = '01' )   AND  -- Se Lotacao
                         ( V_CODIGOVEICULO = '4  ' ) AND  -- Veiculo TOCO
                         ( ListaNotas.cnTABSOLCOD IS NULL )      Then -- Nao Encontrou Preco

                         tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML  := fni_retcenario('NAO ACHEI CARGA PARA TOCO E MUDEI O VEICULO PARA CODIGO 3 TRUCK');
                         vAuxiliarchar :=  fn_InsereLogGeracao;

                         V_CODIGOVEICULO  := '9  '; -- Veiculo Qualquer um
                         V_TIPOVEICULO    := 'Nao Definido';
                         ListaCargaCli.ccTPCARGACLI     := '02'; -- Mudo Para Fracionado
                         ListaCargaCli.ccTPCARGACLIDESC := 'FRACIONADO';


                      Else   
                         -- Forca a saida do LOOP se Nao houve Troca de Carga
                         exit;
                      End If;    

                   end loop; -- Fim loop Basico
                    
--                   if ListaNotas.CnPESOCOBRADO < V_LOTACAO Then
--                      ListaNotas.CnPESOCOBRADO := V_LOTACAO;
--                   End If;
                  
--                   IF ListaNotas.CnPESOCOBRADO < ccPESOMINIMO  Then
--                      ListaNotas.CnPESOCOBRADO := ccPESOMINIMO;
--                   END IF;   
                  
                   IF NVL(vRetBuscaFrete.SLF_CALCFRETEKM_VALOR,0) = 0 THEN  
                      tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Frete Empresa Zerado ' || V_MENSAGEM;
                      vAuxiliarchar := fn_InsereLogGeracao;                  
                   END IF;
                  
                ELSE
                  -- SE MODO ANTIGO
                   vRetBuscaFrete.vRetorno := 'MA';
                   ListaVaux.cnTABSOLCODANT       := ListaNotas.cnTABSOLCOD;   

                   vRetBuscaFrete.SLF_TABELA_CODIGO := ListaNotas.cnTABSOLCOD;
                   vRetBuscaFrete.SLF_TABELA_SAQUE  :=  lpad(trim(ListaNotas.cnTABSOLSQ),4,'0');
                
                END IF; -- FIM DO IF PARA NOVA REGRA

                if ( nvl(ListaVaux.cnKM,0) = 0 ) and ( ListaCargaCli.ccUSAFAIXAKM = 'S') then
                
                   tpLogGeracaO.Con_Loggeracao_ErroHTML := substr('NAO ENC KM PARA ORI -' || ListaNotas.cnORIGEM || '-DES -' ||
                                                       ListaNotas.cnDESTINO || '-TP FRETE-' || V_CIFFOB || '-TPCALCULO-' || vDescCalculo ||
                                                       '-TPCARGA-' || ListaCargaCli.ccTPCARGACLIDESC || '-TPVEIC-' ||
                                                       V_TIPOVEICULO || '-SACBUSCA-' || V_SACADOCARGA ||
                                                       '-GRPBUSCA-' || V_GRUPOCARGAS || '-KM-' || ListaVaux.cnKM ||
                                                       '-PESOCOB-' || ListaNotas.CnPESOCOBRADO,1,1000);
                   P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;

                end if;
              
                IF trim(ListaCargaCli.ccTPCARGACLI) <> '99' THEN
                  IF ListaNotas.cnTABSOLCOD IS NULL THEN

                     tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := V_MENSAGEM;
                     vAuxiliarchar := fn_InsereLogGeracao;

                     tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML  := fni_retcenario('NAO ENC TAB FRETE PARA:');
                     vAuxiliarchar := fn_InsereLogGeracao;
                     v_classificaerro       := trim(v_classificaerro) || ';TF';
                     commit;
                  END IF;
                END IF;
              
                -- COLOQUEI ESTA CONDICAO POIS HOPUVE CASOS QUE AS COLETAS Nao EXISTEM
                -- 25/03/2009 SIRLANO
                BEGIN
                   SELECT C.ARM_COLETA_PRIORIDADE
                     INTO V_PRIORIDADE
                   FROM TDVADM.T_ARM_COLETA C
                   WHERE C.ARM_COLETA_NCOMPRA = ListaNotas.cnNRCOLETA 
                     And c.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo;
                 
                EXCEPTION
                  WHEN NO_DATA_FOUND THEN
                     ListaNotas.cnNRCOLETA := NULL;
                     V_PRIORIDADE := NULL;
                END;   
             

                IF (ListaNotas.cnTABSOLCOD IS NOT NULL) and (P_RETORNOPROCESSAMENTO <> 'E') THEN
                   IF V_MOTVEICULO = 'N' THEN
                      V_CODMOTFROTA := NULL;
                      IF ListaNotas.cnVIRTUAL = 'S' THEN
                         V_MOTVEICULO := 'V';
                      ELSE
                         V_MOTVEICULO := 'S';
                         -- PEGA O CODIGO DO FROTA
                         IF ListaNotas.cnCONJFROTA IS NOT NULL THEN
                            SELECT C.FRT_MOTORISTA_CODIGO
                              INTO V_CODMOTFROTA
                              FROM TDVADM.T_FRT_CONJUNTO C
                             WHERE C.FRT_CONJVEICULO_CODIGO = ListaNotas.cnCONJFROTA;
                         END IF;
                      END IF;
                   end if;
                  -- PEGA O CODIGO DA VIAGEM
                   tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML :=  fni_retcenario('Pegando Situac?o da NOTA Antes de Gerar CTE');
                   vAuxiliarchar := fn_InsereLogGeracao ;             

                   IF   (( V_CONTADORDENOTAS = 0 ) and 
                         ( NVL(vRetBuscaFrete.SLF_CALCFRETEKM_VALOR,0) > 0 ) or ( NVL(vRetBuscaFrete.vRetorno,'MA') = 'MA' ))   
                    Then
                      -- inicializa a OBS a cada nova viagem/Documento
                      V_MSGOBS := '';
                      V_MSGOBS2 := '';
                      
                      OPEN C_VIAGEM;
                      begin 
                          SELECT TRIM(TO_CHAR(MAX(TO_NUMBER(trim(nvl(v.CON_VIAGEM_NUMERO,
                                                                0)))) + 1,
                                              SemTabelaCodigo))
                            INTO tpConViagem.Con_Viagem_Numero
                          FROM TDVADM.T_CON_VIAGEM V
                          WHERE V.GLB_ROTA_CODIGOVIAGEM = ListaNotas.cnROTA;

                           if nvl(tpConViagem.Con_Viagem_Numero,'0') = '0' then 
                              tpConViagem.Con_Viagem_Numero := '00000001';
                           End if;  
                                 
                         exception
                           when NO_DATA_FOUND then
                                tpConViagem.Con_Viagem_Numero := '00000001';
                           when others then
                             raise_application_error(-20601, 'Erro ao Gerar Viagem' || sqlerrm || dbms_utility.format_call_stack);
                         end;  
                        
                         tpConViagem.Glb_Rota_Codigoviagem := ListaNotas.cnROTA;
                         tpConViagem.Con_Viagem_Capacidade := V_LOTACAO;
                         tpConViagem.Con_Viagem_Usada      := 1;
                         tpConViagem.Con_Viagem_Dataviagem := v_datactrc;
                         tpConViagem.Car_Carreteiro_Cpfcodigo := ListaNotas.cnCARRETEIRO;
                         tpConViagem.Car_Carreteiro_Saque     := ListaNotas.cnCARRETEIROSAQ;
                         tpConViagem.Frt_Motorista_Codigo     := V_CODMOTFROTA;
                         tpConViagem.Con_Viagem_Conjveiculo   := ListaNotas.cnCONJFROTA;
--                         tpConViagem.Con_Viagem_Conjveiculo   := null;
                         tpConViagem.Con_Viagem_Cpfcodigo     := null;
                         tpConViagem.Con_Viagem_Cpfsaque      := null;
                         tpConViagem.Con_Viagem_Frtmotorista  := null;
                         tpConViagem.Con_Viagem_Placa         := null;
                         tpConViagem.Con_Viagem_Placasaque    := null;
                         tpConViagem.Con_Viagem_Dtviagem      := v_datactrc; 

                         If P_ARM_ARMAZEM = '42' Then
                         
                            Begin
                               select vc.con_valefrete_codigo,
                                      vc.glb_rota_codigovalefrete,
                                      vc.con_valefrete_serie,
                                      vc.con_valefrete_saque
                                  into vValeFreteCOD,
                                       vValeFreteROTA,
                                       vValeFreteSR,
                                       vValeFreteSQ
                               from TDVADM.T_con_vfretecoleta vc
                               where vc.arm_coleta_ncompra = ListaNotas.cnNRCOLETA
                                 and vc.arm_coleta_ciclo = ListaNotas.cnNrColetaCiclo;

  
                               select vf.con_valefrete_placa,
                                      vf.con_valefrete_placasaque,
                                      vf.con_valefrete_carreteiro
                                   into tpConViagem.Con_Viagem_Placa,
                                        tpConViagem.Con_Viagem_Placasaque,
                                        tpConViagem.Car_Carreteiro_Cpfcodigo
                               from TDVADM.T_con_valefrete vf
                               where vf.con_conhecimento_codigo = vValeFreteCOD
                                 and vf.con_conhecimento_serie = vValeFreteSR
                                 and vf.glb_rota_codigo = vValeFreteROTA
                                 and vf.con_valefrete_saque = vValeFreteSQ;
                                
                              -- Verifica se e Frota 
                              If substr(tpConViagem.Con_Viagem_Placa,1,3) = '000' then
                                
                                 tpConViagem.Con_Viagem_Conjveiculo := tpConViagem.Con_Viagem_Placa;
                                
                                 select max(m.frt_motorista_codigo)
                                   into tpConViagem.Frt_Motorista_Codigo
                                 from TDVADM.T_frt_motorista m
                                 where m.frt_motorista_cpf = tpConViagem.Car_Carreteiro_Cpfcodigo; 
                                 
                                 tpConViagem.Con_Viagem_Placasaque    := null;
                                 tpConViagem.Car_Carreteiro_Cpfcodigo := null;
                                 tpConViagem.Car_Carreteiro_Saque     := null;
                                 tpConViagem.Con_Viagem_Cpfsaque      := null;

                              Else -- Se For Careteiro
                                
                                 tpConViagem.Frt_Motorista_Codigo   := null;
                                 tpConViagem.Con_Viagem_Conjveiculo := null;

                                 Select max(ca.car_carreteiro_saque)
                                   into tpConViagem.Car_Carreteiro_Saque
                                 from TDVADM.T_car_carreteiro ca
                                 where ca.car_carreteiro_cpfcodigo = tpConViagem.Car_Carreteiro_Cpfcodigo 
                                   and ca.car_veiculo_placa = tpConViagem.Con_Viagem_Placa
                                   and ca.car_veiculo_saque = tpConViagem.Con_Viagem_Placasaque;
                                   
                                 tpConViagem.Con_Viagem_Cpfsaque := tpConViagem.Car_Carreteiro_Saque;
                                 
                              End If;

                            Exception
                              When NO_DATA_FOUND then
                                 vValeFreteCOD  := null;
                                 vValeFreteROTA := null;
                                 vValeFreteSR   := null;
                                 vValeFreteSQ   := null;
                              When OTHERS then
                                 vValeFreteCOD  := null;
                                 vValeFreteROTA := null;
                                 vValeFreteSR   := null;
                                 vValeFreteSQ   := null;
                              End;
                         End If; 
                        
                         /**************** Thiago - 08/11/2019 - *************
                         -- Select para saber se existe na  tabela          --
                         -- T_GLB_MERCADORIA                                --
                         ****************************************************/ 
                         --SELECT M.* FROM TDVADM.T_GLB_MATERIAL M
                         --    INTO V_GLB_MATERIAL_CODIGO
                         --WHERE M.GLB_MATERIAL_CODIGO = ;
                         
                         --IF NVL(V_GLB_MATERIAL_CODIGO, '') = '' THEN
                         --      RAISE_APPLICATION_ERROR(-20001,
                         --             'Cdigo de mercadoria: ' || xxxxxxxx ||
                         --             ' no existe na tabela de mercadoria.');  ' );
                         --END;
                         
                         INSERT INTO TDVADM.T_CON_VIAGEM
                         VALUES tpConViagem;
                        
                         If sql%rowcount = 0 Then
                             tpLogGeracaO.Con_Loggeracao_ErroHTML := 'NAO CONSEGUI GERAR VIAGEM - ' || V_CODVIAGEM;
                             P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                             v_classificaerro       := trim(v_classificaerro) || ';GV';
                             if C_VIAGEM%isopen Then
                                CLOSE C_VIAGEM;
                             End If;   
                         Else
                             COMMIT;
                             if C_VIAGEM%isopen then
                                CLOSE C_VIAGEM;
                             End If;   
                         End If;
                      END IF;
                      
                      begin
                          if ListaNotas.cnTABSOLCOD is null Then
                             tpLogGeracaO.Con_Loggeracao_ErroHTML := 'A NOTA ' || ListaNotas.cnNOTA || ' do CNPJ ' || f_mascara_cgccpf(trim(ListaNotas.cnCLIREM)) || ' Nao TEM TABELA/SOLICITACAO';
                             P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                          Else  
                              if ListaNotas.cnTABSOL = 'T' then
                                select nvl(ta.glb_embalagem_codigo,'A7'),
                                       TA.GLB_MERCADORIA_CODIGO,
                                       ta.slf_tabela_obstabela,
                                       ta.slf_tabela_imprimeobsctrc
                                   into ListaNotas.cnEMBALAGEM,
                                        vRetBuscaFrete.GLB_MERCADORIA_CODIGO,
                                        v_ObsTABSOL,
                                        v_ObsTABSOLImp
                                from TDVADM.T_slf_tabela ta   
                                where ta.slf_tabela_codigo = ListaNotas.cnTABSOLCOD
                                  and ta.slf_tabela_saque = ListaNotas.cnTABSOLSQ
                                  and nvl(ta.slf_tabela_status,'N') = 'N';
                              else
                                select nvl(ta.glb_embalagem_codigo,'A7'),
                                       TA.GLB_MERCADORIA_CODIGO,
                                       ta.slf_solfrete_obssolicitacao,
                                       ta.slf_solfrete_imprimeobsctrc
                                   into ListaNotas.cnEMBALAGEM,
                                        vRetBuscaFrete.GLB_MERCADORIA_CODIGO,
                                        v_ObsTABSOL,
                                        v_ObsTABSOLImp
                                from TDVADM.T_slf_solfrete ta   
                                where ta.slf_solfrete_codigo = ListaNotas.cnTABSOLCOD
                                  and ta.slf_solfrete_saque = ListaNotas.cnTABSOLSQ
                                  and nvl(ta.slf_solfrete_status,'N') = 'N';
                              end if;                          
                          End If;
                      Exception
                      when NO_DATA_FOUND then
                         ListaNotas.cnEMBALAGEM := 'A7';
                      end;  
                      
                      If length(trim(nvl(ListaNotas.cnEMBALAGEM,''))) = 0 Then
                         tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Tabela/Solicitac?o [' || ListaNotas.cnTABSOLCOD || '] sem codigo de Embalagem';
                         P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                      End If;                     
                      
                      IF ( (P_RETORNOPROCESSAMENTO = 'N') and 
                          (NVL(vRetBuscaFrete.SLF_CALCFRETEKM_VALOR,0) > 0 ) or ( NVL(vRetBuscaFrete.vRetorno,'MA') = 'MA' )) THEN
                        commit;
                        if V_CONTADORDENOTAS <> 0 THEN 
                           V_CONTADORDENOTAS := V_CONTADORDENOTAS;
                        End If;  
                        IF V_CONTADORDENOTAS = 0 THEN
                          tpConViagemDet.Con_Viagem_Numero        := tpConViagem.Con_Viagem_Numero;
                          tpConViagemDet.Glb_Rota_Codigoviagem    := tpConViagem.Glb_Rota_Codigoviagem;
                          tpConViagemDet.Con_Viagam_Saque         := '1';
                          tpConViagemDet.Con_Viagemdet_Qtdeconhec := '1';

                          INSERT INTO TDVADM.T_CON_VIAGEMDET
                          VALUES tpConViagemDet;
                          COMMIT;

                          SELECT CON_SEQCONHECIMENTO_CODIGO.NEXTVAL
                            INTO V_CTRCCODIGO
                            FROM DUAL;
                          Begin
                            
                          ListaNotas.cnConhecimento := V_CTRCCODIGO;
                          ListaNotas.cnRotaConhec    := ListaNotas.cnROTA;
                          tpLogGeracao.Con_Conhecimento_Codigo := V_CTRCCODIGO;
                          tpLogGeracao.Con_Conhecimento_Serie  := 'XXX';
                          tpLogGeracao.Glb_Rota_Codigo         := ListaNotas.cnROTA;
                          
                          
                            tpConConhecimento.Con_Conhecimento_Codigo        := V_CTRCCODIGO;
                            tpConConhecimento.Con_Conhecimento_Serie         := 'XXX';
                            tpConConhecimento.Glb_Rota_Codigo                := ListaNotas.cnROTA;
                            tpConConhecimento.Glb_Rota_Codigoreceita         := ListaNotas.cnROTA;
                            tpConConhecimento.Glb_Rota_Codigoimpressao       := ListaNotas.cnROTA;
                            if ListaNotas.cnTABSOL = 'T' Then
                               tpConConhecimento.Slf_Tabela_Codigo           := ListaNotas.cnTABSOLCOD;
                               tpConConhecimento.Slf_Tabela_Saque            := ListaNotas.cnTABSOLSQ;
                               tpConConhecimento.Slf_Solfrete_Codigo         := null;
                               tpConConhecimento.Slf_Solfrete_Saque          := null;
                            Elsif ListaNotas.cnTABSOL = 'S' Then
                               tpConConhecimento.Slf_Tabela_Codigo           := null;
                               tpConConhecimento.Slf_Tabela_Saque            := null;
                               tpConConhecimento.Slf_Solfrete_Codigo         := ListaNotas.cnTABSOLCOD;
                               tpConConhecimento.Slf_Solfrete_Saque          := ListaNotas.cnTABSOLSQ;
                            Else
                               tpConConhecimento.Slf_Tabela_Codigo           := null;
                               tpConConhecimento.Slf_Tabela_Saque            := null;
                               tpConConhecimento.Slf_Solfrete_Codigo         := null;
                               tpConConhecimento.Slf_Solfrete_Saque          := null;
                            End If;
                            tpConConhecimento.Glb_Cliente_Cgccpfremetente    := ListaNotas.cnCLIREM;
                            tpConConhecimento.Glb_Tpcliend_Codigoremetente   := ListaNotas.cnCLIENDREM;
                            tpConConhecimento.Glb_Cliente_Cgccpfdestinatario := ListaNotas.cnCLIDEST;
                            tpConConhecimento.Glb_Tpcliend_Codigodestinatari := ListaNotas.cnCLIENDDEST;
                            tpConConhecimento.Glb_Cliente_Cgccpfsacado       := ListaNotas.cnCLISAC;
                            tpConConhecimento.Con_Viagem_Numero              := tpConViagemDet.Con_Viagem_Numero;
                            tpConConhecimento.Glb_Rota_Codigoviagem          := tpConViagemDet.Glb_Rota_Codigoviagem;
                            tpConConhecimento.Con_Viagam_Saque               := tpConViagemDet.Con_Viagam_Saque;

                            tpConConhecimento.Con_Conhecimento_Placa         := trim(tpConViagem.Con_Viagem_Placa);
                            tpConConhecimento.Con_Valefrete_Codigo           := vValeFreteCOD;
                            tpConConhecimento.Glb_Rota_Codigovalefrete       := vValeFreteROTA;
                            tpConConhecimento.Con_Valefrete_Serie            := vValeFreteSR;
                            tpConConhecimento.Con_Valefrete_Saque            := vValeFreteSQ;
                            


                            tpConConhecimento.Glb_Mercadoria_Codigo          := ListaNotas.cnCodMercadoria; -- vRetBuscaFrete.GLB_MERCADORIA_CODIGO; 
                            tpConConhecimento.Glb_Embalagem_Codigo           := ListaNotas.cnEMBALAGEM;
                            tpConConhecimento.Con_Conhecimento_Localcoleta   := ListaNotas.cnCOLETA;
                            tpConConhecimento.Con_Conhecimento_Localentrega  := ListaNotas.cnENTREGA;
                            tpConConhecimento.Glb_Localidade_Codigoorigem    := ListaNotas.cnORIGEM;
                            tpConConhecimento.Glb_Localidade_Codigodestino   := ListaNotas.cnDESTINO;
                            tpConConhecimento.Con_Conhecimento_Dtembarque    := v_datactrc;
                            tpConConhecimento.Con_Conhecimento_Horasaida     := SYSDATE;
                            tpConConhecimento.Con_Conhecimento_Dtemissao     := v_datactrc;
                            tpConConhecimento.Con_Conhecimento_Dtinclusao    := TRUNC(SYSDATE);
                            tpConConhecimento.Con_Conhecimento_Dtgravacao    := SYSDATE;
                            tpConConhecimento.CON_CONHECIMENTO_QTDEENTREGA   := 1;
                            tpConConhecimento.CON_CONHECIMENTO_NUMVIAGENS    := 1;
                            tpConConhecimento.CON_CONHECIMENTO_OBS           := null;
                            if vTipoDocumento <> cNFServico Then
                               tpConConhecimento.CON_CONHECIMENTO_OBSLEI     := 'OPT.CRED.PRESUMIDO-CONV.ICMS 106/96-';
                            Else
                               tpConConhecimento.CON_CONHECIMENTO_OBSLEI     := null;
                            End IF;
                            tpConConhecimento.CON_CONHECIMENTO_OBSCLIENTE    := '';
                            tpConConhecimento.CON_CONHECIMENTO_EMISSOR       := P_USU_USUARIOCRIA;
                            tpConConhecimento.CON_CONHECIMENTO_DIGITADO      := 'D';
                            tpConConhecimento.GLB_GERRISCO_CODIGO            := null;
                            tpConConhecimento.CON_CONHECIMENTO_CODLIBERACAO  := null;
                            tpConConhecimento.ARM_COLETA_NCOMPRA             := ListaNotas.cnNRCOLETA;
                            tpConConhecimento.arm_coleta_ciclo               := ListaNotas.cnNrColetaCiclo;
                            tpConConhecimento.Arm_Carregamento_Codigo        := P_ARM_CARREGAMENTO;
                            tpConConhecimento.Arm_Carregamento_Codigopr      := P_ARM_CARREGAMENTO;

                          INSERT INTO TDVADM.T_CON_CONHECIMENTO
                          VALUES tpConConhecimento;
                          
                          If ListaCargaCli.ccPagaValePedagio = 'S' Then
                          
                             insert into tdvadm.t_con_conhecvped cp
                               (con_conhecimento_codigo,
                                con_conhecimento_serie,
                                glb_rota_codigo,
                                glb_cliente_cgccpfcodigo,
                                glb_clienteregesp_codigo,
                                con_fpagtomotped_codigo,
                                con_fcobped_codigo,
                                con_modalidadeped_codigo,
                                con_conhecvped_transacao,
                                con_conhecvped_valor,
                                con_conhecimento_valortdv,
                                con_conhecimento_dtgravacao)
                              Values
                                (tpConConhecimento.Con_Conhecimento_Codigo,
                                 tpConConhecimento.Con_Conhecimento_Serie,
                                 tpConConhecimento.Glb_Rota_Codigo,
                                 tpConConhecimento.Glb_Cliente_Cgccpfsacado,
                                 null, -- regime especial
                                 '00', -- no cartao
                                 '02', -- custo tdv 
                                 '00', -- DEMONSTRA NO CTRC Nao INCLUI NO TOT. PRESTACAO
                                 null,
                                 0,
                                 0,
                                 sysdate);
                         
                          End If;
                          
                          
                          if trim(ListaCargaCli.ccTPCARGACLI) = '25' Then  -- COMPLEMENTO   
                             tpConhecComplemento.Con_Conhecimento_Codigo := tpConConhecimento.Con_Conhecimento_Codigo;
                             tpConhecComplemento.Con_Conhecimento_Serie := tpConConhecimento.Con_Conhecimento_Serie;
                             tpConhecComplemento.Glb_Rota_Codigo := tpConConhecimento.Glb_Rota_Codigo;
                             insert into tdvadm.t_con_conheccomplemento c
                             values tpConhecComplemento;
                          End If;

                         
                          If ListacargaCLi.ccCteGlobalizado <> 'N' Then
                             tpConhecRegEsp.Con_Conhecimento_Codigo        := V_CTRCCODIGO;
                             tpConhecRegEsp.Con_Conhecimento_Serie         := 'XXX';
                             tpConhecRegEsp.Glb_Rota_Codigo                := ListaNotas.cnROTA;
                             tpConhecRegEsp.Con_Conhecimentoregesp_Data    := TRUNC(SYSDATE);
                             tpConhecRegEsp.Con_Conhecimentoregesp_Codigo  := null;
                             tpConhecRegEsp.Con_Conhecimentoregesp_Tpglob  := ListacargaCLi.ccCteGlobalizado;
                             insert into TDVADM.T_con_conhecimentoregesp values tpConhecRegEsp;
                          End If;  


                          ListaVaux.cnNRCOLETAANT        := ListaNotas.cnNRCOLETA;
                          ListaVaux.cnCLIREMANT          := ListaNotas.cnCLIREM;
                          ListaVaux.cnCLIDESTANT         := ListaNotas.cnCLIDEST;
                          ListaVaux.cnCLIENDDESTANT      := ListaNotas.cnCLIENDDEST;
                          ListaVaux.cnCODIGOORIANT       := ListaNotas.cnCOLETA;
                          ListaVaux.cnCODIGODESANT       := ListaNotas.cnENTREGA;
                             
                              --Casotenha encontrado algum registro
                              -- Coloquei logo apos a Abertura do Cursor de Notas para fazer validacoes 
                              -- de enderecos.
                              If ( vControlRedespacho > 0 ) Then
                                --Populo a variavel de linha do CTRC_REDESPACHO
                                tpConRedespacho.Con_Conhecimento_Codigo := tpConConhecimento.Con_Conhecimento_Codigo;
                                tpConRedespacho.Con_Conhecimento_Serie := tpConConhecimento.Con_Conhecimento_Serie;
                                tpConRedespacho.Glb_Rota_Codigo := tpConConhecimento.Glb_Rota_Codigo;
  --                              tpConRedespacho.Con_Consigredespacho_Flagcr := 'R';     -- Redespacho
                                tpConRedespacho.Con_Tpdoc_Codigo := '00';               -- CTRC
                                
                                --Busco o flagCR na tabela de servicos add.
                                Select w.con_consigredespacho_flagcr 
                                Into tpConRedespacho.Con_Consigredespacho_Flagcr
                                From TDVADM.T_arm_notaservadd w
                                Where w.arm_notaservadd_codigo = tpArmNotaRedespacho.Arm_Notaservadd_Codigo;     
                                
                                
                                
                                --Dados imputados junto com a nota                              
                                tpConRedespacho.Con_Consigredespacho_Cgccpf    := tpArmNotaRedespacho.Arm_Notaredespacho_Cnpjctrc;
                                tpConRedespacho.Glb_Tpcliend_Codigo            := tpArmNotaRedespacho.Arm_Notaredespacho_Tpcliend;

                                select ce.glb_cliend_ie
                                  into tpConRedespacho.Con_Consigredespacho_Ie
                                from tdvadm.t_glb_cliend ce
                                where ce.glb_cliente_cgccpfcodigo = tpConRedespacho.Con_Consigredespacho_Cgccpf
                                  and ce.glb_tpcliend_codigo = tpConRedespacho.Glb_Tpcliend_Codigo;
                                
                                tpConRedespacho.Con_Consigredespacho_Conhec    := tpArmNotaRedespacho.Arm_Notaredespacho_Ctrc;
                                tpConRedespacho.Con_Consigredespacho_Seriedoc  := Trim(tpArmNotaRedespacho.Arm_Notaredespacho_Serie);
                                tpConRedespacho.Con_Consigredespacho_Dtemissao := tpArmNotaRedespacho.Arm_Notaredespacho_Dtemissao;
                                tpConRedespacho.Con_Consigredespacho_Chavecte  := tpArmNotaRedespacho.Arm_Notaredespacho_Chavecte;
                                
                                --Faco o insert na TDVADM.T_con_consigredespacho
                                Insert Into TDVADM.T_con_consigredespacho Values tpConRedespacho;
                              End If;

                             Exception
                               When Others Then
                                  vMessage := substr(sqlerrm, 1, 1000);
                                  tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Veja TAB/SOL - ' || ListaNotas.cnTABSOL || ' - ' || ListaNotas.cnTABSOLCOD || '-' || ListaNotas.cnTABSOLSQ || '- da NOTA -' || ListaNotas.cnNOTA || '-' || vMessage;
                                  P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
  --                               RAISE_APPLICATION_ERROR(-20001, 'veja TAB/SOL' || ListaNotas.cnTABSOL || ' - ' || V_TABELA || '-' || V_TABELASQ || '- da NOTA -' || cnNOTA || '-' || Sqlerrm );
                               End;
   
                             V_CONTADORCTRC := V_CONTADORCTRC + 1;

                          -- INSERINDO AS NOTAS
                          
                          -- SIRLANO 28/06/2010 -- COMMIT NO CTRC COLOCAR AMANHA
                          
                          -- VERIFICA PELO CODIGO DO IBGE SE E A MESMA PRACA
                          -- PARA FAZER NOTA FISCAL DE SERVICO
                          if tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC') = tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC') then
                              V_TPCALCULO := '115';
                              vDescCalculo := 'CALCULO ISS';
                              if ( ListaNotas.cnContrato = 'C2013010022' ) Then -- LOT-VOLKSWAGEN-0113-XXX
                                 V_TPCALCULO := '316';
                              end If   ;
                              If ListaNotas.cnGRUPOECSAC = '0020' Then
                                 V_TPCALCULO := '316';
                              End If;
                           Else
                              vDescCalculo := 'CALCULO ICMS';
                              V_TPCALCULO := '041';

                              if ( ListaNotas.cnContrato = 'C2013010022' ) Then -- LOT-VOLKSWAGEN-0113-XXX
                                 V_TPCALCULO := '315';
                              end If   ;
                              If ListaNotas.cnGRUPOECSAC = '0020' Then
                                 V_TPCALCULO := '315';
                              End If;
                          end if;
                          
                          -- SE NAO FOR MODO ANTIGO 
                          -- PESQUISA NO NOVO CONCEITO
                          IF vRetBuscaFrete.vRetorno <> 'MA' Then 

                             INSERT INTO TDVADM.T_CON_CALCCONHECIMENTO CC
                             SELECT V_CTRCCODIGO,
                                    'XXX',
                                    ListaNotas.cnROTA,
                                    CK.SLF_RECCUST_CODIGO,
                                    V_TPCALCULO,
                                    '0001',
                                    CK.SLF_CALCFRETEKM_DESINENCIA,
                                    NULL,
                                    CK.SLF_CALCFRETEKM_VALOR,
                                    '*',
                                    V_DATACTRC, --P_DATAEMISSAO,,
                                    NULL,
                                    NULL,
                                    CK.SLF_CALCFRETEKM_CODCLI
                             FROM TDVADM.T_SLF_CALCFRETEKM CK,
                                  TDVADM.T_SLF_TABELA T
                             WHERE T.SLF_TABELA_CODIGO          = vRetBuscaFrete.SLF_TABELA_CODIGO
                               and T.SLF_TABELA_SAQUE           = vRetBuscaFrete.SLF_TABELA_SAQUE
                               and T.SLF_TABELA_TIPO            = vRetBuscaFrete.SLF_TABELA_TIPO
                               AND T.GLB_CLIENTE_CGCCPFCODIGO   = vRetBuscaFrete.GLB_CLIENTE_CGCCPFCODIGO
                               AND T.GLB_GRUPOECONOMICO_CODIGO  = vRetBuscaFrete.GLB_GRUPOECONOMICO_CODIGO
                               AND T.SLF_TABELA_CONTRATO        = vRetBuscaFrete.SLF_TABELA_CONTRATO
                               AND T.FCF_TPCARGA_CODIGO         = vRetBuscaFrete.FCF_TPCARGA_CODIGO
                               and nvl(t.slf_tabela_status,'N') = 'N'
                               AND trim(T.FCF_TPVEICULO_CODIGO) = trim(vRetBuscaFrete.FCF_TPVEICULO_CODIGO)
                               AND T.SLF_TABELA_COLETAENTREGA   = vRetBuscaFrete.SLF_TABELA_COLETAENTREGA
                               AND CK.SLF_CALCFRETEKM_KMDE      = vRetBuscaFrete.SLF_CALCFRETEKM_KMDE
                               and CK.SLF_CALCFRETEKM_KMATE     = vRetBuscaFrete.SLF_CALCFRETEKM_KMATE
                               and CK.SLF_CALCFRETEKM_PESODE    = vRetBuscaFrete.SLF_CALCFRETEKM_PESODE
-- Sirlano 12/02/2016
--                               and CK.SLF_CALCFRETEKM_PESOATE   = vRetBuscaFrete.SLF_CALCFRETEKM_PESOATE
                               and CK.SLF_CALCFRETEKM_ORIGEMI   =  vRetBuscaFrete.SLF_CALCFRETEKM_ORIGEMI
                               and CK.SLF_CALCFRETEKM_DESTINOI  = vRetBuscaFrete.SLF_CALCFRETEKM_DESTINOI
                               and CK.SLF_CALCFRETEKM_ORIGEM    =  vRetBuscaFrete.SLF_CALCFRETEKM_ORIGEM
                               and CK.SLF_CALCFRETEKM_DESTINO   = vRetBuscaFrete.SLF_CALCFRETEKM_DESTINO
                               and ck.slf_calcfretekm_outracoletai = vRetBuscaFrete.SLF_CALCFRETEKM_OUTRACOLETAI
                               and ck.slf_calcfretekm_outraentregai = vRetBuscaFrete.SLF_CALCFRETEKM_OUTRAENTREGAI
                               AND CK.SLF_TABELA_CODIGO         = T.SLF_TABELA_CODIGO
                               AND CK.SLF_TABELA_SAQUE          = T.SLF_TABELA_SAQUE;
-- Sirlano 12/02/2016
-- O pessoal do Fatruamento garante somente na linha do FRETE
--                               and nvl(CK.SLF_CALCFRETEKM_CODCLI,'99') =  nvl(vRetBuscaFrete.SLF_CALCFRETEKM_CODCLI,'99')
--SIRLANO 25/06/2015
-- Nao e mais usado o Tipo de Frete da Calc
--                               and CK.SLF_CALCFRETEKM_TPFRETE  =  vRetBuscaFrete.SLF_CALCFRETEKM_TPFRETE

                               vAuxiliarnumerico := SQL%Rowcount;
                               
                               if tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC') = tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC') then
                                  V_TPCALCULO := '115';
                                  vDescCalculo := 'CALCULO ISS';
                                  if ( ListaNotas.cnContrato = 'C2013010022' ) Then -- LOT-VOLKSWAGEN-0113-XXX
                                     V_TPCALCULO := '316';
                                  end If   ;
                                  If ListaNotas.cnGRUPOECSAC = '0020' Then
                                     V_TPCALCULO := '316';
                                  End If;
                               Else
                                  vDescCalculo := 'CALCULO ICMS';
                                  V_TPCALCULO := '041';
 
                                  if ( ListaNotas.cnContrato = 'C2013010022' ) Then -- LOT-VOLKSWAGEN-0113-XXX
                                     V_TPCALCULO := '315';
                                  end If   ;
                                  If ListaNotas.cnGRUPOECSAC = '0020' Then
                                     V_TPCALCULO := '315';
                                  End If;
                              end if;


                               IF SQL%ROWCOUNT = 0 Then
                                  tpLogGeracaO.Con_Loggeracao_ErroHTML :=  fni_retcenario('VERIFIQUE AS PRACAS VERBAS ou KM DA TABELA');
                                  P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                  v_classificaerro       := trim(v_classificaerro) ||
                                                            ';GVA' || '-' || ListaNotas.cnTABSOLCOD || '-';
                               END IF;

                            -- Se For Do Modo Antigo o 
                            -- Usuario Indicou uma Tabela ou Solicitac?o
                            ELSIF vRetBuscaFrete.vRetorno  in ('MA') then 
                               IF ListaNotas.cnTABSOL = 'T' THEN
                                 begin
                                 
                                    -- verifica se o sacado e o mesmo
                                    SELECT COUNT(*)
                                      INTO vAuxiliarnumerico
                                    FROM TDVADM.T_SLF_TABELA TA
                                    WHERE TA.GLB_CLIENTE_CGCCPFCODIGO = ListaNotas.cnCLISAC;
                                    
                                    If vAuxiliarnumerico > 0 Then 
                                        INSERT INTO TDVADM.T_CON_CALCCONHECIMENTO
                                        SELECT distinct V_CTRCCODIGO,
                                               'XXX',
                                               ListaNotas.cnROTA,
                                               CF.SLF_RECCUST_CODIGO,
                                               V_TPCALCULO, -- CF.SLF_TPCALCULO_CODIGO,
                                               CF.GLB_MOEDA_CODIGO,
                                               CF.SLF_CALCTABELA_DESINECIA,
                                               NULL,
                                               CF.SLF_CALCTABELA_VALOR,
                                               '*',
                                               v_datactrc, --P_DATAEMISSAO,,
                                               NULL,
                                               NULL,
                                               null
                                        FROM TDVADM.T_SLF_CALCTABELA CF, 
                                             TDVADM.T_GLB_LOCALIDADE LO,
                                             TDVADM.T_SLF_TABELA TA
                                        WHERE CF.SLF_TABELA_CODIGO = ListaNotas.cnTABSOLCOD
                                          AND CF.SLF_TABELA_SAQUE = ListaNotas.cnTABSOLSQ
                                          AND CF.SLF_TABELA_CODIGO = TA.SLF_TABELA_CODIGO
                                          AND CF.SLF_TABELA_SAQUE = TA.SLF_TABELA_SAQUE
                                          AND CF.GLB_LOCALIDADE_CODIGO = LO.GLB_LOCALIDADE_CODIGO
                                          AND TRIM(LO.GLB_LOCALIDADE_CODIGOIBGE) = TRIM(DECODE(TA.SLF_TABELA_TIPO,'FOB',ListaVaux.cnCODIGOORI,
                                                                                                                  ' ',ListaVaux.cnCODIGOORI,ListaVaux.cnCODIGODES));
                                        vAuxiliarnumerico := sql%rowcount;                                                                    

                                        IF vAuxiliarnumerico = 0 Then
                                            tpLogGeracaO.Con_Loggeracao_ErroHTML := fni_retcenario('VERIFIQUE AS PRACAS VERBAS ou KM DA TABELA');
                                            P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                        end if;  
                                    Else
                                         tpLogGeracaO.Con_Loggeracao_ErroHTML := fni_retcenario('TABELA ' || ListaNotas.cnTABSOLCOD || ' NAO PERTENCE AO SACADO ' || ListaNotas.cnCLISAC);
                                         P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                    End If;
 
                                    Begin
                                       select DISTINCT sf.slf_tpcalculo_codigo
                                         into V_TPCALCULO
                                       from TDVADM.T_SLF_CALCTABELA sf
                                       WHERE SF.SLF_TABELA_CODIGO = ListaNotas.cnTABSOLCOD
                                        AND SF.SLF_TABELA_SAQUE = ListaNotas.cnTABSOLSQ                          
                                        AND SF.SLF_RECCUST_CODIGO = 'D_FRPSVO';

                                       if tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC') = tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC') then
                                           V_TPCALCULO := '115';
                                           vDescCalculo := 'CALCULO ISS';
                                           if ( ListaNotas.cnContrato = 'C2013010022' ) Then -- LOT-VOLKSWAGEN-0113-XXX
                                              V_TPCALCULO := '316';
                                           end If   ;
                                           If ListaNotas.cnGRUPOECSAC = '0020' Then
                                              V_TPCALCULO := '316';
                                           End If;
                                        Else
                                           vDescCalculo := 'CALCULO ICMS';
                                           V_TPCALCULO := '041';
   
                                           if ( ListaNotas.cnContrato = 'C2013010022' ) Then -- LOT-VOLKSWAGEN-0113-XXX
                                              V_TPCALCULO := '315';
                                           end If   ;
                                           If ListaNotas.cnGRUPOECSAC = '0020' Then
                                              V_TPCALCULO := '315';
                                           End If;
                                       end if;
                                    exception 
                                    when NO_DATA_FOUND Then
                                       tpLogGeracaO.Con_Loggeracao_ErroHTML := fni_retcenario('TABELA SEM FRETE PESO VOLUME');
                                       P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                    End ;
                                 exception
                                 WHEN DUP_VAL_ON_INDEX  THEN
                                    BEGIN
                                       SELECT I.codmun || '-' || TRIM(I.nomeex)
                                           INTO vAuxiliarT
                                       FROM V_GLB_IBGE I
                                       WHERE I.codmun = TRIM(DECODE(V_CIFFOB,'FOB',ListaVaux.cnCODIGOORI,
                                                                             'FOC',ListaVaux.cnCODIGOORI,ListaVaux.cnCODIGODES));
                                    EXCEPTION
                                    WHEN OTHERS THEN
                                       vAuxiliarT := '';
                                    END;
                                    tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Verifique DUPLICIDADE de PRACAS na TABELA IBGE : ' || vAuxiliarT || chr(10);
                                    for c_MSG in (SELECT cf.glb_localidade_codigo colloc,
                                                         substr(trim(lo.glb_estado_codigo) || '-' || trim(lo.glb_localidade_descricao),1,50) descricao,
                                                         f_mascara_valor(cf.slf_calctabela_valor,15) valor
                                                  FROM TDVADM.T_SLF_CALCTABELA CF, TDVADM.T_GLB_LOCALIDADE LO
                                                  WHERE CF.SLF_TABELA_CODIGO = ListaNotas.cnTABSOLCOD
                                                    AND CF.SLF_TABELA_SAQUE = ListaNotas.cnTABSOLSQ
                                                    and CF.SLF_RECCUST_CODIGO = 'D_FRPSVO'
                                                    AND CF.GLB_LOCALIDADE_CODIGO = LO.GLB_LOCALIDADE_CODIGO
                                                    AND TRIM(LO.GLB_LOCALIDADE_CODIGOIBGE) = TRIM(DECODE(V_CIFFOB,'FOB',ListaVaux.cnCODIGOORI,
                                                                                                                  'FOC',ListaVaux.cnCODIGOORI,ListaVaux.cnCODIGODES)))
                                    LOOP
                                       tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Localidade - ' || C_MSG.COLLOC || '-' || C_MSG.DESCRICAO || '- Frete -' || c_msg.valor || chr(10);
                                    END LOOP;                                                         
                                    P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                       
                                 WHEN OTHERS Then
                                    raise_application_error(-20701,'Chave de inserc?o na CALC - ' ||ListaNotas.cnTABSOLCOD||'-'||ListaNotas.cnTABSOLSQ||'-'||V_CIFFOB||'-'||ListaVaux.cnCODIGOORI||'-'||ListaVaux.cnCODIGODES||'-'||V_CTRCCODIGO||' - '|| '-TPCALCULO-' || vDescCalculo ||Sqlerrm);
                                 END;                    
                                ELSE

                                    -- verifica se o sacado e o mesmo
                                    SELECT COUNT(*)
                                      INTO vAuxiliarnumerico
                                    FROM TDVADM.T_SLF_SOLFRETE TA
                                    WHERE TA.GLB_CLIENTE_CGCCPFCODIGOSAC = ListaNotas.cnCLISAC;


                                  -- MUDAR O TEXTO PARA INSERIR DADOS DE
                                  -- UMA SOLICITACAO
                                   If vAuxiliarnumerico > 0 Then
                                  
                                       INSERT INTO TDVADM.T_CON_CALCCONHECIMENTO
                                       SELECT distinct V_CTRCCODIGO,
                                              'XXX',
                                              ListaNotas.cnROTA,
                                              CF.SLF_RECCUST_CODIGO,
                                              V_TPCALCULO, -- CF.SLF_TPCALCULO_CODIGO,
                                              CF.GLB_MOEDA_CODIGO,
                                              CF.SLF_CALCSOLFRETE_DESINENCIA,
                                              NULL,
                                              CF.SLF_CALCSOLFRETE_VALOR,
                                              '*',
                                              v_datactrc, --P_DATAEMISSAO,,
                                              NULL,
                                              NULL,
                                              null
                                       FROM TDVADM.T_Slf_Calcsolfrete CF
                                       WHERE CF.SLF_SOLFRETE_CODIGO = ListaNotas.cnTABSOLCOD
                                         AND CF.SLF_SOLFRETE_SAQUE = ListaNotas.cnTABSOLSQ;
                                        
                                       vAuxiliarnumerico := sql%rowcount;
                                       IF vAuxiliarnumerico = 0 Then
                                          tpLogGeracaO.Con_Loggeracao_ErroHTML := fni_retcenario('VERIFIQUE AS PRACAS VERBAS ou KM DA SOLICITAC?O');
                                          P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                          v_classificaerro       := trim(v_classificaerro) || ';CVS - ' || ListaNotas.cnTABSOL  ;
                                       END IF;
                                    Else
                                       tpLogGeracaO.Con_Loggeracao_ErroHTML := fni_retcenario('SOLICITACAO DE FRETE ' || ListaNotas.cnTABSOLCOD || ' NAO PERTENCE AO SACADO ' || ListaNotas.cnCLISAC);
                                       P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                    End If;
                                         
                                   begin
                                      select DISTINCT sf.slf_tpcalculo_codigo
                                         into V_TPCALCULO
                                      from TDVADM.T_Slf_Calcsolfrete sf
                                      WHERE SF.SLF_SOLFRETE_CODIGO = ListaNotas.cnTABSOLCOD
                                        AND SF.SLF_SOLFRETE_SAQUE = ListaNotas.cnTABSOLSQ
                                        and sf.slf_reccust_codigo = 'D_FRPSVO';

                                       if tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC') = tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC') then
                                           V_TPCALCULO := '115';
                                           vDescCalculo := 'CALCULO ISS';
                                           if ( ListaNotas.cnContrato = 'C2013010022' ) Then -- LOT-VOLKSWAGEN-0113-XXX
                                              V_TPCALCULO := '316';
                                           end If   ;
                                           If ListaNotas.cnGRUPOECSAC = '0020' Then
                                              V_TPCALCULO := '316';
                                           End If;
                                        Else
                                           vDescCalculo := 'CALCULO ICMS';
                                           V_TPCALCULO := '041';
   
                                           if ( ListaNotas.cnContrato = 'C2013010022' ) Then -- LOT-VOLKSWAGEN-0113-XXX
                                              V_TPCALCULO := '315';
                                           end If   ;
                                           If ListaNotas.cnGRUPOECSAC = '0020' Then
                                              V_TPCALCULO := '315';
                                           End If;
                                       end if;

                                   exception 
                                   when NO_DATA_FOUND Then
                                      tpLogGeracaO.Con_Loggeracao_ErroHTML := fni_retcenario('SOLICITAC?O SEM FRETE PESO VOLUME');
                                      P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                   End ;

                                END IF;
                             END IF;
                          END IF;
                      END IF;
                      -- Ver se for <> do Antigo
                      -- INSERE AS DEMAIS VERBAS DO CALCULO
                      IF ( vRetBuscaFrete.vRetorno  <> 'MA' )  and  ( V_CTRCCODIGO is not null ) then  
                         INSERT INTO TDVADM.T_CON_CALCCONHECIMENTO CC
                         SELECT V_CTRCCODIGO,
                                'XXX',
                                ListaNotas.cnROTA,
                                CA.SLF_RECCUST_CODIGO,
                                V_TPCALCULO,
                                '0001',
                                RC.SLF_RECCUST_DESINECIA,
                                NULL,
                                0,
                                '*',
                                v_datactrc, --P_DATAEMISSAO,,
                                NULL,
                                NULL,
                                null
                         FROM TDVADM.T_SLF_CALCULO CA,
                              TDVADM.T_SLF_RECCUST RC
                         WHERE CA.SLF_TPCALCULO_CODIGO = V_TPCALCULO
                           AND CA.SLF_RECCUST_CODIGO = RC.SLF_RECCUST_CODIGO
                           AND 0 = (SELECT COUNT(*)
                                    FROM TDVADM.T_CON_CALCCONHECIMENTO C
                                    WHERE C.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                      AND C.CON_CONHECIMENTO_SERIE = 'XXX'
                                      AND C.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                      AND C.SLF_RECCUST_CODIGO = CA.SLF_RECCUST_CODIGO);

                          
                         vAuxiliarnumerico := SQL%Rowcount;
                         IF SQL%ROWCOUNT = 0 Then
                            select count(*)
                              into vAuxiliarnumerico
                            FROM TDVADM.T_CON_CALCCONHECIMENTO C
                            WHERE C.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                              AND C.CON_CONHECIMENTO_SERIE = 'XXX'
                              AND C.GLB_ROTA_CODIGO = ListaNotas.cnROTA;
                          -- Caso Nao insera mais verbas verifica se ja foram inseridas
                            if vAuxiliarnumerico < 80 Then                 
                               tpLogGeracaO.Con_Loggeracao_ErroHTML := 'NAO CARREGOU AS DEMAIS VERBAS-' || V_TPCALCULO || '-' || vDescCalculo ||
                                                                   '-ORIGEM - ' || ListaNotas.cnORIGEM || ' DESTINO - ' ||
                                                                   ListaNotas.cnDESTINO || ' KM - ' || TO_CHAR(ListaVaux.cnKM) ||
                                                                   ' PESO - ' || TO_CHAR(ListaNotas.CnPESOCOBRADO) ||
                                                                   ' TABELA - ' || ListaNotas.cnTABSOLCOD || '-' || ListaNotas.cnTABSOLSQ;
                               P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                               v_classificaerro       := trim(v_classificaerro) || ';DVO';
                            End If;   
                         END IF;
                          
                      End If;

                      -- Carrega a Lista
                     glbadm.pkg_listas.sp_Get_VerbasConhec(V_CTRCCODIGO,
                                                           'XXX',
                                                           ListaNotas.cnROTA,
                                                           ListaVerbas);

                      -- PEGAR ALIQUOTA
                      -- SE NAO TEM DESCRICAO LEI, PEGAR AQUI                    
                      -- SIRLANO / KLAYTON
                      -- ATE DIA 28/01/2014
                      SELECT FN_GET_ALIQUOTA(ListaNotas.cnCOLETA,
                                             ListaNotas.cnENTREGA,
                                             v_datactrc,
                                             ListaNotas.cnROTA)
                         INTO V_ALIQUOTA
                      FROM DUAL;
                   ELSE
                      -- SIRLANO / KLAYTON
                      -- ATE DIA 28/01/2014
                      SELECT FN_GET_ALIQUOTA(ListaNotas.cnCOLETA,
                                             ListaNotas.cnENTREGA,
                                             v_datactrc,
                                             ListaNotas.cnROTA)
                         INTO V_ALIQUOTA
                      FROM DUAL;
                          
                      -- INSERIR INSERT PARA CALCULO COM SOLICITAC?O
                      -- MODO ANTIGO
                      -- SIRLANO 23/09/2009
 
                      if NVL(V_ALIQUOTA, 0) = 0 Then
                         tpLogGeracaO.Con_Loggeracao_ErroHTML := 'NAO FOI ENCONTRADO ALIQUOTA DO IMPOSTO';
                         P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                         v_classificaerro       := trim(substr(v_classificaerro ||
                                                   ';ALI dt nota ' || ListaNotas.cnNOTA,1,400));
                      end if;
                   END IF; -- V_CONTADORDENOTAS    

                   -- Vide Nota de for 0 (zero) e que Nao e Vide  e 1 (hum) indica que e NOTA VIDE
                   if ( NVL(ListaNotas.CnPESOCOBRADO, 0) = 0 ) and ( nvl(ListaNotas.cnVideNota,0) = 0 ) Then
                      tpLogGeracaO.Con_Loggeracao_ErroHTML := 'PROBLEMA NO PESO VALOR ZERO';
                      P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                      v_classificaerro       := trim(v_classificaerro) || ';PS';
                   End if;
                   if NVL(ListaNotas.cnVLRMERC, 0) = 0 Then
                      tpLogGeracaO.Con_Loggeracao_ErroHTML := 'PROBLEMA NO VALOR DA MERCADORIA';
                      P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                      v_classificaerro       := trim(v_classificaerro) || ';MERC';
                   end if;
                    -- PEGANDO OS DADOS PARA QUANDO FOR CTE
                   Begin
                      v_notacfop    := ListaNotas.cnCFOP;
                      v_notacodimp  := 'ICMS';
                      v_notabaseimp := 0;
                      v_notavlrimp  := 0;
                   EXCEPTION
                   WHEN OTHERS THEN
                      v_notacfop    := ListaNotas.cnCFOP;
                      v_notacodimp  := 'ICMS';
                      v_notabaseimp := 0;
                      v_notavlrimp  := 0;
                   END; 
                 
                  if ListaNotas.cnMERCADORIA is null Then
                     tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Descricao da Mercadoria nao pode ser em BRANCO, Favor editar a nota.';
                     P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                  End if;
                  
                  if ListaNotas.cnEMBALAGEM is null Then
                     tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Embalagem Nao pode ser em BRANCO, Favor editar a nota.';
                     P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                  End if;
                  
                  
                  IF ( P_RETORNOPROCESSAMENTO = 'N' ) and ( V_CTRCCODIGO is not null ) THEN
                  BEGIN
                     vQtdeNotasCteEmitido := vQtdeNotasCteEmitido + 1;
                     tpConNftransporta.Con_Conhecimento_Codigo        := tpConConhecimento.Con_Conhecimento_Codigo;
                     tpConNftransporta.Con_Conhecimento_Serie         := tpConConhecimento.Con_Conhecimento_Serie;
                     tpConNftransporta.Glb_Rota_Codigo                := tpConConhecimento.Glb_Rota_Codigo;
                     tpConNftransporta.Con_Nftransportada_Numnfiscal  := ListaNotas.cnNOTA;
                     tpConNftransporta.Glb_Embalagem_Codigo           := ListaNotas.cnEMBALAGEM;
                     tpConNftransporta.Con_Nftransportada_Valor       := ListaNotas.cnVLRMERC;
                     tpConNftransporta.Con_Nftransportada_Volumes     := ListaNotas.cnQTDVOLUME;
--                     tpConNftransporta.Con_Nftransportada_Peso        := round(ListaNotas.cnPESO / 1000,3);
                     tpConNftransporta.Con_Nftransportada_Peso        := ListaNotas.cnPESO / 1000;
                     -- TROCADO EM 26/03/2010
                     -- IMPLANTACAO DO CTE VER DEPOIS O QUE FAZER
                     -- SIRLANO
                     tpConNftransporta.Con_Nftransportada_Unidade     := 'TON'; -- cnUNIDADE,
                     tpConNftransporta.Con_Nftransportada_Numero      := ListaNotas.cnNUMERO;
                     tpConNftransporta.Con_Nfttransporta_Mercadoria   := ListaNotas.cnMERCADORIA;
                     tpConNftransporta.Glb_Cliente_Cgccpfcodigo       := ListaNotas.cnCLIREM;
                     tpConNftransporta.Con_Nftransportada_Valorseg    := ListaNotas.cnVLRMERC;
--                     tpConNftransporta.Con_Nftransportada_Pesocobrado := round(ListaNotas.CnPESOCOBRADO / 1000,3);
                     tpConNftransporta.Con_Nftransportada_Pesocobrado := ListaNotas.CnPESOCOBRADO / 1000;
                     tpConNftransporta.Con_Nftransportada_Largura     := ListaNotas.cnLARGURA;
                     tpConNftransporta.Con_Nftransportada_Altura      := ListaNotas.cnALTURA;
                     tpConNftransporta.Con_Nftransportada_Comprimento := ListaNotas.cnCOMPRIMENTO;
                     tpConNftransporta.Con_Nftransportada_Cubagem     := ListaNotas.cnCUBAGEM;
                     tpConNftransporta.Con_Nftransportada_Remonta     := ListaNotas.cnREMONTA;
                     tpConNftransporta.Con_Nftransportada_Pesocubado  := ListaNotas.cnPESOCUBADO;
                     tpConNftransporta.Con_Nftransportada_Armazem     := 'S';
                     tpConNftransporta.Glb_Cfop_Codigo                := v_notacfop;
                     if v_notacodimp ='ICMS-ST' Then
                        tpConNftransporta.Con_Nftransportada_Valorbsicms := 0;
                        tpConNftransporta.Con_Nftransportada_Valoricms   := 0;
                        tpConNftransporta.Con_Nftransportada_Vlbsicmsst  := v_notabaseimp;
                        tpConNftransporta.Con_Nftransportada_Vlicmsst    := v_notavlrimp;
                     Else
                        tpConNftransporta.Con_Nftransportada_Valorbsicms := v_notabaseimp;
                        tpConNftransporta.Con_Nftransportada_Valoricms   := v_notavlrimp;
                        tpConNftransporta.Con_Nftransportada_Vlbsicmsst  := 0;
                        tpConNftransporta.Con_Nftransportada_Vlicmsst    := 0;
                     End If;                            
                     tpConNftransporta.Con_Nftransportada_Chavenfe    := ListaNotas.cnCHAVENFE;
                     tpConNftransporta.Con_Tpdoc_Codigo               := ListaNotas.cnTpDocumento;
                     tpConNftransporta.Con_Nftransportada_Dtemissao   := ListaNotas.cnDATANOTA;
                     tpConNftransporta.Con_Nftransportada_Dtsaida     := ListaNotas.cnDATANOTAR;
                     tpConNftransporta.Con_Nftransportada_Serienf     := ListaNotas.cnSERIENF;
                     tpConNftransporta.Glb_Onu_Codigo                 := ListaNotas.cnONU;
                     tpConNftransporta.Glb_Onu_Grpemb                 := ListaNotas.cnONUGRPEMB;
                     tpConNftransporta.Arm_Coleta_Ncompra             := ListaNotas.cnNRCOLETA;
                     tpConNftransporta.Arm_Coleta_Ciclo               := ListaNotas.cnNrColetaCiclo;
                     
                     INSERT INTO TDVADM.T_CON_NFTRANSPORTA NF
                       VALUES tpConNftransporta;
                       
                     vAuxiliarnumerico := 0;
                     Loop
                         vAuxiliarnumerico := vAuxiliarnumerico + 1;
                         -- Se for a mesma nota coloca o codigo do conhecimento  
                         begin
                             If ( vListaCOBCOL(vAuxiliarnumerico).pNota  = ListaNotas.cnNOTA ) and 
                                ( vListaCOBCOL(vAuxiliarnumerico).pRemetente = ListaNotas.cnCLIREM ) and 
                                ( vListaCOBCOL(vAuxiliarnumerico).pSerie = ListaNotas.cnSERIENF ) Then 
        --                       vListaCOBCOL(vAuxiliarnumerico).pSequencia    := ListaNotas.cnSequencia;
        --                       vListaCOBCOL(vAuxiliarnumerico).pColeta       := ListaNotas.cnNRCOLETA;
        --                       vListaCOBCOL(vAuxiliarnumerico).pCiclo        := ListaNotas.cnNrColetaCiclo;
                                 vListaCOBCOL(vAuxiliarnumerico).pCteCod       := V_CTRCCODIGO;
                                 vListaCOBCOL(vAuxiliarnumerico).pCteRT        := ListaNotas.cnROTA;
                                 vListaCOBCOL(vAuxiliarnumerico).pCteSr        := 'XXX';
                                 exit;
                              End If;    
                         Exception
                           When NO_DATA_FOUND Then
                             -- so para Nao dar  erro caso Nao houver cobranca de coleta
                              exit;
                           end ;  
                     End Loop;  
                       
                       
                  exception
                  when others Then
                     P_RETORNOPROCESSAMENTO := 'E';
                     vMessage := substr(Sqlerrm, 1, 1000);
                     tpLogGeracaO.Con_Loggeracao_ErroHTML := 'NOTA COM PROBLEMAS: '|| ListaNotas.cnNOTA || '-'|| 
                                                         'Cnpj:' || ListaNotas.cnCLIREM ||'-' || 
                                                         'CFOP-' || v_notacfop || 
                                                         '-CTRC-' || V_CTRCCODIGO || 
                                                         '-rota-' || ListaNotas.cnROTA || 
                                                         '-QTDECTRC-' || TO_CHAR(V_CONTADORDENOTAS) ||
                                                         '-MSGERRO-' || vMessage ;
                     P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
--                     raise_application_error(-20001, 'NOTA COM PROBLEMAS: '|| cnNOTA || '-'|| 'Cnpj:' || cnCLIREM ||'-' || 'CFOP-' || v_notacfop || '-CTRC-' || V_CTRCCODIGO || '-rota-' || cnROTA || '-QTDECTRC-' || TO_CHAR(V_CONTADORDENOTAS) || '-MSGERRO-' || sqlerrm);
                  End;
                        
                        
                  if P_RETORNOPROCESSAMENTO <> 'E' Then
                     tpConNftransportaExtra.Con_Conhecimento_Codigo       := tpConNftransporta.Con_Conhecimento_Codigo;
                     tpConNftransportaExtra.Con_Conhecimento_Serie        := tpConNftransporta.Con_Conhecimento_Serie;
                     tpConNftransportaExtra.Glb_Rota_Codigo               := tpConNftransporta.Glb_Rota_Codigo;
                     tpConNftransportaExtra.Con_Nftransportada_Numnfiscal := ListaNotas.cnNOTA;
                     tpConNftransportaExtra.Glb_Embalagem_Codigo          := ListaNotas.cnEMBALAGEM;
                     tpConNftransportaExtra.Con_Nfttransporta_Mercadoria  := ListaNotas.cnMERCADORIA;
                     tpConNftransportaExtra.Con_Nftransporta_Dtemissao    := ListaNotas.cnDATANOTAR;
                     tpConNftransportaExtra.Con_Nftransporta_Data2        := null;
                     tpConNftransportaExtra.Con_Nftransporta_String1      := V_CODCLIENTE;
                     tpConNftransportaExtra.Con_Nftransporta_String2      := null;
                     tpConNftransportaExtra.Con_Nftransporta_String3      := null;
                     tpConNftransportaExtra.Con_Nftransporta_String4      := null;
                     tpConNftransportaExtra.Con_Nftransporta_Number1      := V_LOTACAO;
                     tpConNftransportaExtra.Con_Nftransporta_Number2      := null;
                     tpConNftransportaExtra.Con_Nftransporta_Number3      := null;                    
                     tpConNftransportaExtra.Con_Nftransporta_Number4      := null;
                     tpConNftransportaExtra.Con_Nftransporta_Serie        := tpConNftransporta.Con_Nftransportada_Serienf;
                     tpConNftransportaExtra.Con_Nftransporta_Data1        := null;
                     tpConNftransportaExtra.Glb_Onu_Codigo                := null;
                     tpConNftransportaExtra.Glb_Onu_Grpemb                := null;

                     INSERT INTO TDVADM.T_CON_NFTRANSPORTAEXTRA NF
                     VALUES tpConNftransportaExtra;

                     V_CONTADORDENOTAS    := V_CONTADORDENOTAS + 1;
                     V_PESOTOTAL          := V_PESOTOTAL + ListaNotas.cnPESO;
                     V_PESOBALTOTAL       := V_PESOBALTOTAL + V_PESAGEM;
                     V_PESOCOBTOTAL       := V_PESOCOBTOTAL + ListaNotas.CnPESOCOBRADO;
                     V_VALORTOTMERCADORIA := V_VALORTOTMERCADORIA + ListaNotas.cnVLRMERC;
                     V_LISTANOTASCTRC     := trim(substr(V_LISTANOTASCTRC || trim(ListaNotas.cnNOTA) ||', ',1,300));

                     UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                        SET CC.CON_CALCVIAGEM_VALOR = V_ALIQUOTA
                     WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                       AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                       AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                       AND trim(CC.SLF_RECCUST_CODIGO) IN ('S_ALICMS', 'S_ALISS');
                      -- PEGAR VALOR DE MERCADORIA
                      vAuxiliarnumerico := SQL%Rowcount;

                      ListaVerbas('S_ALICMS').AsFloat := V_ALIQUOTA;
                      ListaVerbas('S_ALICMS').Value := trim(to_char(V_ALIQUOTA));
--                      ListaVerbas('S_ALICMS').AsDesinencia := 'VL';
                      ListaVerbas('S_ALISS').AsFloat := V_ALIQUOTA;
                      ListaVerbas('S_ALISS').Value := trim(to_char(V_ALIQUOTA));
--                      ListaVerbas('S_ALISS').AsDesinencia := 'VL';

                     /*
                     Sirlano em 14/01/2020
                     Usa a soma abaixo para apurar o valor total cobrado das coletas do CTe
                     */ 
                     select sum(co.arm_coleta_valor)
                       into ListaVaux.cnColetaValor
                     from tdvadm.t_arm_coleta co
                     where (co.arm_coleta_ncompra, 
                            co.arm_coleta_ciclo ) in (select an.arm_coleta_ncompra,
                                                            an.arm_coleta_ciclo 
                                                     from tdvadm.t_con_nftransporta an
                                                     where an.con_conhecimento_codigo = V_CTRCCODIGO
                                                       AND an.con_conhecimento_serie = 'XXX'
                                                       AND an.glb_rota_codigo = ListaNotas.cnROTA)  ;
                  
                      ListaVaux.cnColetaValor := nvl(ListaVaux.cnColetaValor,0);

                     If ListaVaux.cnColetaValor = 0 Then
                         select sum(co.arm_coleta_valor)
                           into ListaVaux.cnColetaValor
                         from tdvadm.t_arm_coleta co
                         where (co.arm_coleta_ncompra, 
                                co.arm_coleta_ciclo ) in (select an.arm_coleta_ncompra,
                                                                an.arm_coleta_ciclo 
                                                         from tdvadm.t_con_conhecimento an
                                                         where an.con_conhecimento_codigo = V_CTRCCODIGO
                                                           AND an.con_conhecimento_serie = 'XXX'
                                                           AND an.glb_rota_codigo = ListaNotas.cnROTA)  ;
                      ListaVaux.cnColetaValor := nvl(ListaVaux.cnColetaValor,0);
                    End If;


                      commit;   

                      If Not ListaNotas.cnContrato in ('C2017070112') Then -- LOT-NESTLE-0319-IMPORTAO&EXPORTAO

                         If ( ListaCargaCli.ccColetaCobra = 'S' ) and  ( ListaCargaCli.ccCteColeta = 'M' ) Then

                            UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                              SET CC.CON_CALCVIAGEM_VALOR = ListaVaux.cnColetaValor,
                                  cc.con_calcviagem_desinencia = 'VL'
                            WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                              AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                              AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                              AND trim(CC.SLF_RECCUST_CODIGO) = 'D_OT2';

                         End If;  
                      End If; 

                      UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                         SET CC.CON_CALCVIAGEM_VALOR = V_VALORTOTMERCADORIA
                       WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                         AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                         AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                         AND trim(CC.SLF_RECCUST_CODIGO) = 'I_VLMR';
                      V_SOMAMERCADORIA := V_SOMAMERCADORIA + ListaNotas.cnVLRMERC;
                      vAuxiliarnumerico := SQL%Rowcount;

                      ListaVerbas('I_VLMR').AsFloat := V_VALORTOTMERCADORIA;
                      ListaVerbas('I_VLMR').Value := trim(to_char(V_VALORTOTMERCADORIA));
--                      ListaVerbas('I_VLMR').AsDesinencia := 'VL';

                      -- PEGAR VALOR DE MERC PARA SEGURO
                      UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                         SET CC.CON_CALCVIAGEM_VALOR = V_VALORTOTMERCADORIA
                      WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                        AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                        AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                        AND trim(CC.SLF_RECCUST_CODIGO) = 'D_VLRSEGUR';
                        vAuxiliarnumerico := SQL%Rowcount;

                      ListaVerbas('D_VLRSEGUR').AsFloat := V_VALORTOTMERCADORIA;
                      ListaVerbas('D_VLRSEGUR').Value := trim(to_char(V_VALORTOTMERCADORIA));
--                      ListaVerbas('D_VLRSEGUR').AsDesinencia := 'VL';

                     -- PEGAR PESO REAL
/*                     UPDATE T_CON_CALCCONHECIMENTO CC
                        SET CC.CON_CALCVIAGEM_VALOR = round(V_PESOTOTAL / 1000,3)
                     WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                       AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                       AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                       AND trim(CC.SLF_RECCUST_CODIGO) = 'D_PSREAL';
                     V_SOMAPESOREAL    := V_SOMAPESOREAL + ListaNotas.cnPESO;
                      vAuxiliarnumerico := SQL%Rowcount;
                      ListaVerbas('D_PSREAL').AsFloat := round(V_PESOTOTAL / 1000,3);
                      ListaVerbas('D_PSREAL').Value := trim(to_char((round(V_PESOTOTAL / 1000,3))));
--                      ListaVerbas('D_PSREAL').AsDesinencia := 'VL';

*/

                     UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                        SET CC.CON_CALCVIAGEM_VALOR = V_PESOTOTAL / 1000
                     WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                       AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                       AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                       AND trim(CC.SLF_RECCUST_CODIGO) = 'D_PSREAL';
                     V_SOMAPESOREAL    := V_SOMAPESOREAL + ListaNotas.cnPESO;
                      vAuxiliarnumerico := SQL%Rowcount;
                      ListaVerbas('D_PSREAL').AsFloat := V_PESOTOTAL / 1000;
                      ListaVerbas('D_PSREAL').Value := trim(to_char((V_PESOTOTAL / 1000)));
--                      ListaVerbas('D_PSREAL').AsDesinencia := 'VL';










                      -- PEGAR PESO COBRADO
                     If nvl(vRetBuscaFrete.SLF_TABELA_CODIGO,SemTabelaCodigo) <> SemTabelaCodigo Then
                        if ListaNotas.cnTABSOL = 'T' Then
                            -- Pega o Maior
                           Begin
                              select greatest(V_PESOCOBTOTAL,nvl(ta.slf_tabela_pesominimo,0))
                                 into V_PESOCOBTOTAL
                              from TDVADM.T_slf_tabela ta 
                              Where ta.SLF_TABELA_CODIGO = ListaNotas.cnTABSOLCOD
                                AND ta.SLF_TABELA_SAQUE = ListaNotas.cnTABSOLSQ
                                and nvl(ta.slf_tabela_status,'N') = 'N'; 
                           exception
                           When NO_DATA_FOUND Then
                               V_PESOCOBTOTAL := V_PESOCOBTOTAL;
                           End;   
                        Else
                            Begin
                               select greatest(V_PESOCOBTOTAL,nvl(ta.slf_solfrete_pesominimo,0))
                                 into V_PESOCOBTOTAL
                               from TDVADM.T_slf_solfrete ta 
                               Where ta.slf_solfrete_codigo = ListaNotas.cnTABSOLCOD
                                 AND ta.slf_solfrete_saque = ListaNotas.cnTABSOLSQ
                                 AND NVL(TA.SLF_SOLFRETE_STATUS,'N') = 'N'; 
                            exception
                            When NO_DATA_FOUND Then
                               V_PESOCOBTOTAL := V_PESOCOBTOTAL;
                            End;   
                         End If; 
                      End If; 
                       


                      if ListaCargaCli.ccRATEIA = 'S' Then
                        vAuxiliarPesoRateio := V_PESOCOBTOTAL + ListaNotas.cnTaraContainer;
                      Else
                         vAuxiliarPesoRateio := ListaNotas.CnPESOCOBRADO;
                         -- Calcula novamente o Peso exedente
                        IF ListaNotas.CnPESOCOBRADO > ListaCargaCli.ccPESOMINIMO THEN
                           V_PESOEXCEDENTE := ListaNotas.CnPESOCOBRADO - ListaCargaCli.ccPESOMINIMO;
                        ELSE
                           V_PESOEXCEDENTE := 0;
                        END IF;                              
                      End If; 

                      if nvl(V_LOTACAO,0) = 0 then 
                         V_LOTACAO := vAuxiliarPesoRateio;
                      End If;
                       
/*
                      UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                         SET CC.CON_CALCVIAGEM_VALOR =  round(vAuxiliarPesoRateio / 1000,3)
                       WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                         AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                         AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                         AND trim(CC.SLF_RECCUST_CODIGO) = 'I_PSCOBRAD';

                      ListaVerbas('I_PSCOBRAD').AsFloat := round(vAuxiliarPesoRateio / 1000,3);
                      ListaVerbas('I_PSCOBRAD').Value := trim(to_char((round(vAuxiliarPesoRateio / 1000,3))));
--                      ListaVerbas('I_PSCOBRAD').AsDesinencia := 'VL';

*/

                      UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                         SET CC.CON_CALCVIAGEM_VALOR =  (vAuxiliarPesoRateio / 1000 )
                       WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                         AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                         AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                         AND trim(CC.SLF_RECCUST_CODIGO) = 'I_PSCOBRAD';

                      ListaVerbas('I_PSCOBRAD').AsFloat := vAuxiliarPesoRateio / 1000;
                      ListaVerbas('I_PSCOBRAD').Value := trim(to_char((vAuxiliarPesoRateio / 1000)));
--                      ListaVerbas('I_PSCOBRAD').AsDesinencia := 'VL';


                      UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                         SET CC.CON_CALCVIAGEM_VALOR =  ListaVaux.cnColetaKM,
                             cc.con_calcviagem_desinencia = 'VL',
                             cc.con_conhecimento_altaltman = 'F'
--                             cc.con_calcconhecimento_cocli = 
                       WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                         AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                         AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                         AND trim(CC.SLF_RECCUST_CODIGO) = 'S_KMCOL';


                      UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                         SET CC.CON_CALCVIAGEM_VALOR =  ListaVaux.cnKM,
                             cc.con_calcviagem_desinencia = 'VL',
                             cc.con_conhecimento_altaltman = 'F'
--                             cc.con_calcconhecimento_cocli = 
                       WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                         AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                         AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                         AND trim(CC.SLF_RECCUST_CODIGO) = 'S_KMPER';

                     ListaVerbas('S_KMPER').AsFloat := ListaVaux.cnKM;
                     ListaVerbas('S_KMPER').Value := trim(to_char(ListaVaux.cnKM));
                     ListaVerbas('S_KMPER').AsDesinencia := 'VL';


                      -- RATEIO FEITO APOS CALCULADO O PESO DE TODAS AS NOTAS
                      -- SOMENTE PARA ESTAS DUAS VERBAS E QUANDO FOR LOTACAO
--                       IF  ccRATEIA = 'S' Then -- ( ListaCargaCli.ccTPCARGACLI In ( '01', '03', '04' , '05') ) Then
                          /*  deve ser colocado aqui as verbas que devem ser rateadas */

                          If /* Se For NOTA FISCAL DE SERVICO */ 
                            ( (  vTipoDocumento = cNFServico  ) And  
                               /* Verifica se Atingiu o Limite ou */ 
                               ( ( V_CONTADORDENOTAS >= least(ListaCargaCli.ccTPCARGAQTDEAGNF,ListaVaux.cnContaNotas)  )  ))
                                Or 
                              /* Se For CONHECIMENTO */ 
                             ( (  vTipoDocumento = cCTeCTRC  ) And  
                               /* Verifica se Atingiu o Limite ou */ 
                                 ( V_CONTADORDENOTAS >= least(ListaCargaCli.ccTPCARGAQTDEAGCTRC,ListaVaux.cnContaNotas )) ) Then

                            if ListaCargaCli.ccRATEIA = 'S' Then
                              vAuxiliarPesoRateio := V_PESOCOBTOTAL;
                            Else
                              vAuxiliarPesoRateio := ListaNotas.CnPESOCOBRADO;
                            End If;  
                            if ListaCargaCli.ccRATEIA = 'S' Then
                              if ListaQuebras.ccTPRATEIO <> '00' then

                                select count(*)
                                  into vAuxiliarnumerico3
                                from TDVADM.T_CON_NFTRANSPORTA CC  
                                WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                  AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                                  AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA;

                                   -- Rateio por Fornecedor
                                if nvl(ListaQuebras.ccTPRATEIO,'02') = '03' Then
                                  
                                   vRetBuscaFrete.vFATORRATEIO :=  1 / nvl(ListaVaux.cnContaFornec,1); 
                                   vAuxiliarFatorRateio := vRetBuscaFrete.vFATORRATEIO;
                                   
                                   -- Rateio Por valor de Mercadoria
                                ElsIf ListaQuebras.ccTPRATEIO = '06' Then
                                  vAuxiliarnumerico3 := 2;
                                  If vAuxiliarnumerico3 > 1 then
                                     if V_LOTACAOVLRMERC <> 0 Then
                                        vRetBuscaFrete.vFATORRATEIO := ( V_VALORTOTMERCADORIA / V_LOTACAOVLRMERC );
                                     Else
                                        vRetBuscaFrete.vFATORRATEIO := 1;
                                     End If;   
                                  End If;   
                                  vAuxiliarFatorRateio := nvl(vRetBuscaFrete.vFATORRATEIO,1);

                                  if V_LOTACAOVLRMERC = V_VALORTOTMERCADORIA Then
                                     vRetBuscaFrete.vFATORRATEIO := 1; 
                                     vAuxiliarFatorRateio := 1;
                                  End If;
                                  
                                   -- Rateio pelo Peso
                                Else
                                  -- Refazendo o fator rateio se tiver mais de uma Nota
                                   If vAuxiliarnumerico3 > 1 then
                                      vRetBuscaFrete.vFATORRATEIO := ( V_PESOCOBTOTAL / V_LOTACAO );
                                      If vRetBuscaFrete.vFATORRATEIO > 1 then
                                        vRetBuscaFrete.vFATORRATEIO := 1;
                                      End If;
                                   End If;   
                                  
                                  vAuxiliarFatorRateio := nvl(vRetBuscaFrete.vFATORRATEIO,1);

                                  if V_LOTACAO = V_PESOCOBTOTAL Then
                                     vRetBuscaFrete.vFATORRATEIO := 1; 
                                     vAuxiliarFatorRateio := 1;
                                  End If;
                                  
                                
                                End If;   
                              Else
                                 vRetBuscaFrete.vFATORRATEIO := 1; 
                                 vAuxiliarFatorRateio := 1;
                              End If;   
                            Else
                              vRetBuscaFrete.vFATORRATEIO := 1; 
                              vAuxiliarFatorRateio := 1;
                            End If;  

                            if ListaVerbas('V_FTRATEIO').AsFloat  > 1 Then
                               vErroFatal := 'E';
                               tpLogGeracaO.Con_Loggeracao_ErroHTML  := 'F-FATOR RATEIO MUITO ALTO PESO COBRADO ' ||  TO_CHAR(V_PESOCOBTOTAL) || ' PESO TOTAL ' ||  TO_CHAR(V_LOTACAO) || ' FATOR ' ||  ListaVerbas('V_FTRATEIO').Value;
                               P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                            End If;
                              -- veb as rateadas

                                    select cc.con_calcviagem_desinencia,
                                           cc.con_calcviagem_valor
                                      into vAuxiliarT,
                                           vAuxiliarnumerico
                                    from TDVADM.T_CON_CALCCONHECIMENTO CC  
                                    WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                      AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                                      AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                      AND trim(CC.SLF_RECCUST_CODIGO) = 'D_FRPSVO';

                                    ListaVerbas('D_FRPSVO').AsFloat := vAuxiliarnumerico;
                                    ListaVerbas('D_FRPSVO').Value := trim(to_char(vAuxiliarnumerico));
                                    ListaVerbas('D_FRPSVO').AsDesinencia := vAuxiliarT;

                                    if trim(ListaCargaCli.ccTPCARGACLI) = '25' Then  -- COMPLEMENTO   
                                       ListaVerbas('D_FRPSVO').AsFloat := tpNotaCte.Arm_Notacte_Valor;
                                       ListaVerbas('D_FRPSVO').Value := trim(to_char(tpNotaCte.Arm_Notacte_Valor));
                                       ListaVerbas('D_FRPSVO').AsDesinencia := 'VL';
                                    Elsif trim(ListaCargaCli.ccTPCARGACLI) = '26' Then  -- REMOCAO
                                       ListaVerbas('D_FRPSVO').AsFloat := tpNotaCte.Arm_Notacte_Valor;
                                       ListaVerbas('D_FRPSVO').Value := trim(to_char(tpNotaCte.Arm_Notacte_Valor));
                                       ListaVerbas('D_FRPSVO').AsDesinencia := 'VL';
                                    End If;

                                    -- e outbound


                                    if ( trim(ListaNotas.cnGRUPOECREM) = trim(ListaNotas.cnGRUPOECSAC) ) AND 
                                       ( trim(ListaNotas.cnGRUPOECDES) <>  trim(ListaNotas.cnGRUPOECSAC) ) Then
                                        ListaVerbas('V_PERCTO').AsFloat := ListaCargaCli.ccPERCTOUT;
                                        ListaVerbas('V_PERCTO').Value := trim(to_char(ListaCargaCli.ccPERCTOUT));
                                        ListaVerbas('V_PERCTO').AsDesinencia := '%';
                                    Else --Nao e outbound
                                        ListaVerbas('V_PERCTO').AsFloat := 1;
                                        ListaVerbas('V_PERCTO').Value := '1';
                                        ListaVerbas('V_PERCTO').AsDesinencia := '%';
                                    End If;
                                     
                                    -- Nao e transferencia
                                    if (trim(ListaNotas.cnGRUPOECREM) = trim(ListaNotas.cnGRUPOECDES)) and 
                                       (trim(ListaNotas.cnGRUPOECSAC) = trim(ListaNotas.cnGRUPOECDES))  
                                     Then
                                       ListaVerbas('V_PERCTT').AsFloat := ListaCargaCli.ccPERCTRA;
                                       ListaVerbas('V_PERCTT').Value := trim(to_char(ListaCargaCli.ccPERCTRA));
                                       ListaVerbas('V_PERCTT').AsDesinencia := '%';
                                    Else  
                                       ListaVerbas('V_PERCTT').AsFloat := 1;
                                       ListaVerbas('V_PERCTT').Value := '1';
                                       ListaVerbas('V_PERCTT').AsDesinencia := '%';
                                    End If;   

                                    if ( instr(cCargaExpressa,TDVADM.PKG_glb_common.Fn_QuotedStr(ListaNotas.cnTIPOCARGA)) > 0 ) or
                                        TDVADM.PKG_FIFO_CARREGCTRC.fn_EColetaExpressa(ListaNotas.cnNRCOLETA,ListaNotas.cnNrColetaCiclo) = 'S'  Then
                                       ListaCargaCli.ccPERCTEX := fn_GetPercentExpresso(ListaVaux,ListaNotas);
                                       ListaVaux.cnPercentEx := ListaCargaCli.ccPERCTEX;
                                       ListaVerbas('V_PERCTE').AsFloat := ListaCargaCli.ccPERCTEX;
                                       ListaVerbas('V_PERCTE').Value := trim(to_char(ListaCargaCli.ccPERCTEX));
                                       ListaVerbas('V_PERCTE').AsDesinencia := '%';
                                    Else  
                                       ListaVaux.cnPercentEx := 1;
                                       ListaVerbas('V_PERCTE').AsFloat := 1;
                                       ListaVerbas('V_PERCTE').Value := '1';
                                       ListaVerbas('V_PERCTE').AsDesinencia := '%';
                                    End If;    
-- Sirlano Retirei em 22/10/2015
--                                    ListaVaux.cnPercentEx   := ListaCargaCli.ccPERCTEX;

                                    
                                    ListaVerbas('V_PERCTQ').AsFloat := ListaCargaCli.ccPERCTQM;
                                    ListaVerbas('V_PERCTQ').Value := trim(to_char(ListaCargaCli.ccPERCTQM));
                                    ListaVerbas('V_PERCTQ').AsDesinencia := '%';
                                    
                                    if ( nvl(v_FORMULARIOCLI,ProdutoQuimicoSemFormulario) <> ProdutoQuimicoSemFormulario ) AND 
                                       ( NVL(v_FORMULARIOCLI,ProdutoQuimicoSemFormulario) <> '999999' ) then



                                      if ( trim(ListaCargaCli.ccTPCARGACLIPESQ) = '11' ) and ( trunc(sysdate) < to_date('15/12/2014','dd/mm/yyyy') )  Then -- Lotacao
                                       -- Nao e quimico
                                             
                                       
                                          ListaVaux.cnPercentQP := 1;
                                          ListaVerbas('V_PERCTQ').AsFloat := 1;
                                          ListaVerbas('V_PERCTQ').Value := '1';
                                          ListaVerbas('V_PERCTQ').AsDesinencia := '%';
                                      
                                      End If;    

                                   Else
                                     
                                      if (ListaCargaCli.ccEXIGEFORMQM = 'S') then
                                         -- Nao e quimico
                                        ListaVaux.cnPercentQP := 1;
                                        ListaVerbas('V_PERCTQ').AsFloat := 1;
                                        ListaVerbas('V_PERCTQ').Value := '1';
                                        ListaVerbas('V_PERCTQ').AsDesinencia := '%';
                                      end if;
                                   End If;
                                    
                                    


/*                                    if ListaNotas.cnTIPOCARGA in ('QUIMICO','QUIMICO EXPRESSO','QUIMICA/PERIGOSA') Then
                                       ListaVaux.cnPercentQP := 2.50; -- 150 %/
                                    Else
                                       ListaVaux.cnPercentQP := 1;
                                    End If;    
*/

                                    If V_PESOEXCEDENTE > 0 Then
                                       ListaVerbas('V_PSEXEC').AsFloat := V_PESOEXCEDENTE;
                                       ListaVerbas('V_PSEXEC').Value   := trim(to_char((ListaVerbas('V_PSEXEC').AsFloat)));

                                       ListaVerbas('V_PSLIM').AsFloat := vRetBuscaFrete.SLF_CALCFRETEKM_LIMITE;
                                       ListaVerbas('V_PSLIM').Value   := trim(to_char((ListaVerbas('V_PSLIM').AsFloat)));
                                       
                                       ListaVerbas('V_VLREXEC').AsFloat := vRetBuscaFrete.SLF_CALCFRETEKM_VALORE;
                                       ListaVerbas('V_VLREXEC').Value   := trim(to_char((vRetBuscaFrete.SLF_CALCFRETEKM_VALORE)));
                                       ListaVerbas('V_VLREXEC').AsDesinencia := vRetBuscaFrete.SLF_CALCFRETEKM_DESINENCIAE;
                                    Else
                                       ListaVerbas('V_PSEXEC').AsFloat := 0;
                                       ListaVerbas('V_PSEXEC').Value   := trim(to_char((ListaVerbas('V_PSEXEC').AsFloat)));

                                       ListaVerbas('V_PSLIM').AsFloat := 0;
                                       ListaVerbas('V_PSLIM').Value   := trim(to_char((ListaVerbas('V_PSLIM').AsFloat)));

                                       ListaVerbas('V_VLREXEC').AsFloat := 0;
                                       ListaVerbas('V_VLREXEC').Value   := trim(to_char((ListaVerbas('V_VLREXEC').AsFloat)));
                                       ListaVerbas('V_VLREXEC').AsDesinencia := 'VL';
                                    End If;



                                    ListaVerbas('V_VLRFIXO').AsFloat := nvl(vRetBuscaFrete.SLF_CALCFRETEKM_VALORF,0);
                                    ListaVerbas('V_VLRFIXO').Value := trim(to_char(nvl(vRetBuscaFrete.SLF_CALCFRETEKM_VALORF,0)));
                                    ListaVerbas('V_VLRFIXO').AsDesinencia := vRetBuscaFrete.SLF_CALCFRETEKM_DESINENCIAF;






                                    vAuxiliarPesoRateio  := nvl(vAuxiliarPesoRateio,1);
                                    ListaVerbas('V_PSRATEIO').AsFloat := vAuxiliarPesoRateio;
                                    ListaVerbas('V_PSRATEIO').Value := trim(to_char(vAuxiliarPesoRateio));
                                    ListaVerbas('V_PSRATEIO').AsDesinencia := '%';

                                    vAuxiliarFatorRateio := nvl(vAuxiliarFatorRateio,1);
                                    ListaVerbas('V_FTRATEIO').AsFloat := vAuxiliarFatorRateio;
                                    ListaVerbas('V_FTRATEIO').Value := trim(to_char(vAuxiliarFatorRateio));
                                    ListaVerbas('V_FTRATEIO').AsDesinencia := '%';

                                    if ListaVerbas('V_FTRATEIO').AsFloat  > 1 Then
                                       vErroFatal := 'E';
                                       tpLogGeracaO.Con_Loggeracao_ErroHTML  := 'F-FATOR RATEIO MUITO ALTO PESO COBRADO ' ||  TO_CHAR(V_PESOCOBTOTAL) || ' PESO TOTAL ' ||  TO_CHAR(V_LOTACAO) || ' FATOR ' ||  ListaVerbas('V_FTRATEIO').Value;
                                       P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                    End If;


                                    ListaVerbas('V_PERCTR').AsFloat := ListaCargaCli.ccPERCTREDUTOR;
                                    ListaVerbas('V_PERCTR').Value := trim(to_char(ListaCargaCli.ccPERCTREDUTOR));
                                    ListaVerbas('V_PERCTR').AsDesinencia := '%';

                                 -- Pegando outras Verbas
                                 begin
                                     select nvl(cc.con_calcviagem_valor,0),
                                            trim(to_char(nvl(cc.con_calcviagem_valor,0))),
                                            cc.con_calcviagem_desinencia
                                         into ListaVerbas('D_PD').AsFloat,                               
                                              ListaVerbas('D_PD').Value,
                                              ListaVerbas('D_PD').AsDesinencia
                                     from TDVADM.T_con_calcconhecimento cc
                                     WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                       AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                                       AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                       AND trim(CC.SLF_RECCUST_CODIGO) = 'D_PD';
                                 exception
                                   When NO_DATA_FOUND Then
                                       ListaVerbas('D_PD').AsFloat := 0;
                                       ListaVerbas('D_PD').Value := '0';
                                       ListaVerbas('D_PD').AsDesinencia := 'VL';
                                   End ;         




                                 if NVL(vRetBuscaFrete.vRetorno,'MA') <> 'MA' Then
                                 -- sirlano 15/09/2014   
                                    if nvl(ListaQuebras.ccTPRATEIO,'02') = 'X00' THEN
                                         ListaQuebras.ccTPRATEIO := ListaQuebras.ccTPRATEIO;
                                    ElsIF nvl(ListaQuebras.ccTPRATEIO,'02')  in ('02','04','05') or 
                                          ( ListaCargaCli.ccFORMULAFRTX is not null ) OR
                                          ( ListaCargaCli.ccFORMULAFRVL IS NOT NULL ) OR 
                                          ( ListaCargaCli.ccFORMULAFRKM IS NOT NULL ) then

                                        -- If trim(ListaCargaCli.ccTPCARGACLI) IN ('10','11','12','13','14','15') Then 
                                        if ListaCargaCli.ccFORMULAFRTX is not null then
                                            if ListaVerbas('D_FRPSVO').AsDesinencia = 'TX' Then
                                               vFormulaTraduzidaF := ' SELECT ' || fn_MudaFormula(ListaCargaCli.ccFORMULAFRTX,ListaVerbas) || ' FROM DUAL ';
                                            Elsif ListaVerbas('D_FRPSVO').AsDesinencia = 'KM' Then
                                               vFormulaTraduzidaF := ' SELECT ' || fn_MudaFormula(ListaCargaCli.ccFORMULAFRKM,ListaVerbas) || ' FROM DUAL ';
                                               ListaVerbas('D_FRPSVO').AsDesinencia := 'VL';
                                            Else
                                               vFormulaTraduzidaF := ' SELECT ' || fn_MudaFormula(ListaCargaCli.ccFORMULAFRVL,ListaVerbas) || ' FROM DUAL ';
                                            End If;   
                                            
                                         
                                              tpLogGeracao.Con_Loggeracao_FormulaTRA := vFormulaTraduzidaP;
                                              tpLogGeracao.Con_Loggeracao_Formula    := vFormulaTraduzidaF;
                                              tpLogGeracao.Arm_Nota_Peso             := to_char(vBusca_Frete.vPESO);
                                              tpLogGeracao.Arm_Nota_PesoTOTAL        := to_char(vBusca_Frete.vPESOTOTAL);
                                              tpLogGeracao.Con_Loggeracao_Fator      := ListaVerbas('V_FTRATEIO').Value;

                                             tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML  := 'Carga ' || ListaCargaCli.ccTPCARGACLI || '-' || ListaCargaCli.ccTPCARGACLIDESC || chr(10) ||
                                                                                        'Carregamento ' || P_ARM_CARREGAMENTO || chr(10) ||
                                                                                        'CTe ' || V_CTRCCODIGO || '-' || ListaNotas.cnROTA || chr(10) ||
                                                                                        'Desinencia  ' || vAuxiliarT || chr(10) ||
                                                                                        'Valor Frete ' || to_char(vAuxiliarnumerico) || chr(10) ||
                                                                                        'Peso Total  ' || to_char(vBusca_Frete.vPESOTOTAL)  || chr(10) ||
                                                                                        'Peso        ' || to_char(vBusca_Frete.vPESO)  || chr(10) ||
                                                                                        'Km          ' || to_char(ListaVaux.cnKM) || chr(10) ||
                                                                                        'Veiculo     ' || vRetBuscaFrete.FCF_TPVEICULO_CODIGO || chr(10) ||
                                                                                        'PercentPQ   ' || to_char(ListaVaux.cnPercentQP) || chr(10) ||
                                                                                        'PercentEX   ' || to_char(ListaVaux.cnPercentEx) || chr(10) ||
                                                                                        'FatorTransf ' || ListaVerbas('V_PERCTT').Value || chr(10) ||
                                                                                        'PesoRateio  ' || ListaVerbas('V_PSRATEIO').Value || chr(10) ||
                                                                                        'FatorRateio ' || ListaVerbas('V_FTRATEIO').Value || chr(10) ||
                                                                                        'PercentOUT  ' || ListaVerbas('V_PERCTO').Value || chr(10) ||
                                                                                        'Redutor     ' || ListaVerbas('V_PERCTR').Value || chr(10) || 
                                                                                        'FreteVar    ' || ListaVerbas('D_FRPSVO').Value || chr(10) || 
                                                                                        'DesVar      ' || ListaVerbas('D_FRPSVO').AsDesinencia || chr(10) || 
                                                                                        'TpCargaNota- ' || ListaNotas.cnTpCarga || chr(10) || 
                                                                                        'Formula Frete TX  - ' || ListaCargaCli.ccFORMULAFRTX || chr(10) ||
                                                                                        'Formula Frete VL  - ' || ListaCargaCli.ccFORMULAFRVL || chr(10) ||
                                                                                        'Formula Frete KM  - ' || ListaCargaCli.ccFORMULAFRKM || chr(10) ||
                                                                                        'Formula traduzida - ' || vFormulaTraduzidaF || chr(10) ||
                                                                                        'Formula Pedag TX  - ' || ListaCargaCli.ccFORMULAPDTX || chr(10) ||
                                                                                        'Formula Pedag VL  - ' || ListaCargaCli.ccFORMULAPDVL || chr(10) ||
                                                                                        'Formula traduzida - ' || vFormulaTraduzidaP || chr(10);
                                                vAuxiliarchar := fn_InsereLogGeracao;

                                              execute immediate vFormulaTraduzidaF into vAuxiliarnumerico;

                                              tpLogGeracao.Con_Loggeracao_FormulaTRA := null;
                                              tpLogGeracao.Con_Loggeracao_Formula    := null;
                                              tpLogGeracao.Arm_Nota_Peso             := null;
                                              tpLogGeracao.Arm_Nota_PesoTOTAL        := null;
                                              tpLogGeracao.Con_Loggeracao_Fator      := null;



                                           If ListaCargaCli.ccRATEIA = 'S' Then 



                                              select cc.con_calcviagem_desinencia,
                                                     cc.con_calcviagem_valor
                                                into vAuxiliarT2,
                                                     vAuxiliarnumerico2
                                              from TDVADM.T_CON_CALCCONHECIMENTO CC  
                                              WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                                AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                                                AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                                AND trim(CC.SLF_RECCUST_CODIGO) = 'D_FRPSVO';
                                             

                                              UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                                                  SET CC.CON_CALCVIAGEM_VALOR =  vAuxiliarnumerico,
                                                      cc.con_calcviagem_desinencia = ListaVerbas('D_FRPSVO').AsDesinencia
                                                WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                                  AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                                                  AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                                  AND trim(CC.SLF_RECCUST_CODIGO) = 'D_FRPSVO';
                                           Else
                                              UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                                                  SET CC.CON_CALCVIAGEM_VALOR = vAuxiliarnumerico,
                                                      cc.con_calcviagem_desinencia = ListaVerbas('D_FRPSVO').AsDesinencia
                                                WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                                  AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                                                  AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                                  AND trim(CC.SLF_RECCUST_CODIGO) = 'D_FRPSVO';
                                           End If;        

                                              select cc.con_calcviagem_desinencia,
                                                     cc.con_calcviagem_valor
                                                into vAuxiliarT2,
                                                     vAuxiliarnumerico2
                                              from TDVADM.T_CON_CALCCONHECIMENTO CC  
                                              WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                                AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                                                AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                                AND trim(CC.SLF_RECCUST_CODIGO) = 'D_FRPSVO';

                                            
                                            
                                        ElsIF trim(ListaCargaCli.ccTPCARGACLI) = '14' Then
                                           ListaCargaCli.ccPERCTEX := fn_GetPercentExpresso(ListaVaux,ListaNotas);
                                           ListaVaux.cnPercentEx := ListaCargaCli.ccPERCTEX;

/*                                           ListaVaux.cnPercentQP := 1;
                                           ListaVaux.cnPercentEx := 1;
*/                                           vRetBuscaFrete.vFATORRATEIO := 1;

                                           
                                          
                                           vAuxiliarFatorRateio := nvl(vAuxiliarFatorRateio,1);
                                           vAuxiliarPesoRateio  := nvl(vAuxiliarPesoRateio,1);
                                           IF trim(vAuxiliarT) = 'VL' then
                                              vAuxiliarnumerico := round(( (( ( vAuxiliarnumerico * ( vAuxiliarPesoRateio / 1000 )) * ListaVaux.cnKM ) * ListaVaux.cnPercentQP ) * ListaVaux.cnPercentEx ) * ListaCargaCli.ccPERCTREDUTOR ,2);
                                           End If;               
                                                                  
                                           UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                                               SET CC.CON_CALCVIAGEM_VALOR =  vAuxiliarnumerico
                                             WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                               AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                                               AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                               AND trim(CC.SLF_RECCUST_CODIGO) = 'D_FRPSVO';

                                        Elsif trim(vAuxiliarT) = 'VL' Then
                                          
                                            vAuxiliarnumerico := ((( ( round(vAuxiliarnumerico * (vAuxiliarFatorRateio) ,2) * ListaVaux.cnKM ) ) * ListaVaux.cnPercentQP ) * ListaVaux.cnPercentEx );
                                            UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                                               SET CC.CON_CALCVIAGEM_VALOR =  vAuxiliarnumerico
                                                   ,CC.CON_CALCVIAGEM_DESINENCIA = 'VL'
                                             WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                               AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                                               AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                               AND trim(CC.SLF_RECCUST_CODIGO) = 'D_FRPSVO';
                                        End If; 

                                        If nvl(ListaVerbas('D_PD').AsFloat,0) = 0 Then
                                            begin
                                            vAuxiliarnumerico := 0; 
                                            
                                            -- Se Usar Veiculo o Mesmo Nao pode ser do tipo 9 - QUALQUER VEICULO
                                            If ( ListaCargaCli.ccUSAVEICULO = 'S' ) and  ( trim(V_CODIGOVEICULO) = '9')  Then
                                                 SP_TESTA_VEICULOPASSADO(V_GRUPOCARGAS,
                                                                         V_CONTRATOCARGAS,
                                                                         V_SACADOCARGA,
                                                                         vTesteCarga.vTestePeso,
                                                                         V_CIFFOB,
                                                                         ListaNotas.cnTIPOTRANSP,
                                                                         ListaCargaCli.ccTPCARGACLI,
                                                                         ListaCargaCli.ccPESQVEICULO,
                                                                         V_CODIGOVEICULO,
                                                                         vStatus,
                                                                         vMessage);
                                              
                                                If ( ListaCargaCli.ccUSAVEICULO = 'S' ) and  ( trim(V_CODIGOVEICULO) = '9')  Then
                                                   vErroFatal := 'E';
                                                   tpLogGeracaO.Con_Loggeracao_ErroHTML  := fni_retcenario('F-Tipo de Frete Usa VEiculo, o Mesmos Nao pode ser do Codigo 9 - QUALQUER VEICULO ');
                                                   P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                                End If;
                                            End If;
                                            
                                            -- Faz Somente se o Pedagio estiver ZERADO

                                            commit;


                                            Begin
                                               vSql :=         'select cp.slf_clienteped_valor,' || chr(10);
                                               vSql := vSql || '       cp.slf_clienteped_desinencia' || chr(10);
                                               vSql := vSql || 'from TDVADM.T_slf_clienteped cp' || chr(10);
                                               vSql := vSql || '         where cp.glb_grupoeconomico_codigo = ' ||  tdvadm.pkg_glb_common.Fn_QuotedStr(V_GRUPOCARGAS) || chr(10);
                                               
                                               if tdvadm.pkg_glb_common.Fn_QuotedStr(V_SACADOCARGA) <> '99999999999999' then 
                                                   vSql := vSql || '           and cp.glb_cliente_cgccpfcodigo = ' ||  tdvadm.pkg_glb_common.Fn_QuotedStr(V_SACADOCARGA) || chr(10);  
                                               end if;
                                               
                                               vSql := vSql || '           and cp.slf_contrato_codigo = ' ||  tdvadm.pkg_glb_common.Fn_QuotedStr(V_CONTRATOCARGAS) || chr(10);
                                               vSql := vSql || '           and trim(cp.fcf_tpcarga_codigo) = ' ||  tdvadm.pkg_glb_common.Fn_QuotedStr(trim(ListaCargaCli.ccTPCARGACLIPESQ)) || chr(10);
                                               vSql := vSql || '   and trim(cp.fcf_tpveiculo_codigo) = ' ||  tdvadm.pkg_glb_common.Fn_QuotedStr(trim(V_CODIGOVEICULO)) || chr(10);
                                               vSql := vSql || '   and cp.slf_clienteped_ativo = ' ||  tdvadm.pkg_glb_common.Fn_QuotedStr('S') || chr(10);
                                               vSql := vSql || '   and cp.glb_localidade_codigooriib = ' ||  tdvadm.pkg_glb_common.Fn_QuotedStr(RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC'), 8)) || chr(10);
                                               vSql := vSql || '   and cp.glb_localidade_codigodesib = ' ||  tdvadm.pkg_glb_common.Fn_QuotedStr(RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC'), 8)) || chr(10);
                                               select tdvadm.pkg_glb_common.Fn_QuotedStr(RPAD(DECODE(ListaCargaCli.ccTPCODOCOUTRACOL,'NN','99999',tdvadm.fn_busca_codigoibge(ListaNotas.cnOUTRACOLETA, 'IBC')), 8))
                                                 into vAuxiliarT
                                               From dual;
                                               vSql := vSql || '   and cp.glb_localidade_outracoletai = ' || vAuxiliarT || chr(10);
                                               select tdvadm.pkg_glb_common.Fn_QuotedStr(RPAD(DECODE(ListaCargaCli.ccTPCODOCOUTRAENTR,'NN','99999',tdvadm.fn_busca_codigoibge(ListaNotas.cnOUTRAENTREGA, 'IBC')), 8))
                                                 into vAuxiliarT
                                               From dual;
                                               vSql := vSql || '   and cp.glb_localidade_outraentregai = ' ||  vAuxiliarT || chr(10);
                                               vSql := vSql || '   and cp.slf_clienteped_vigencia = (select max(cp1.slf_clienteped_vigencia)' || chr(10);
                                               vSql := vSql || '                                     from TDVADM.T_slf_clienteped cp1' || chr(10);
                                               vSql := vSql || '                                     where cp1.glb_grupoeconomico_codigo = cp.glb_grupoeconomico_codigo' || chr(10);
                                               vSql := vSql || '                                       and cp1.glb_cliente_cgccpfcodigo = cp.glb_cliente_cgccpfcodigo' || chr(10);
                                               vSql := vSql || '                                       and cp1.slf_contrato_codigo = cp.slf_contrato_codigo' || chr(10);
                                               vSql := vSql || '                                       and cp1.fcf_tpcarga_codigo = cp.fcf_tpcarga_codigo' || chr(10);
                                               vSql := vSql || '                                       and cp1.slf_clienteped_ativo = cp.slf_clienteped_ativo' || chr(10);
                                               vSql := vSql || '                                       and trunc(cp1.slf_clienteped_vigencia) <= trunc(sysdate))' || chr(10);
                                               
                                               vAuxiliarnumerico := 0;
                                               vAuxiliarT := '';
                                               
                                               tpLogGeracaO.Con_Loggeracao_ErroHTML  := fni_retcenario('SQL para Buscar Pedagio');
                                               tpLogGeracaO.Con_Loggeracao_Sql := vSql;
                                               P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                               Begin
                                                  execute immediate(vSql) into vAuxiliarnumerico,vAuxiliarT;
                                               Exception
                                                 When OTHERS Then
                                                    vAuxiliarnumerico := 0;
                                                    vAuxiliarT := '';
                                                 End;

                                                select cp.slf_clienteped_valor,
                                                       cp.slf_clienteped_desinencia
                                                  into vAuxiliarnumerico,
                                                       vAuxiliarT
                                                from TDVADM.T_slf_clienteped cp
                                                where cp.glb_grupoeconomico_codigo = V_GRUPOCARGAS
                                                  and cp.glb_cliente_cgccpfcodigo = V_SACADOCARGA
                                                  and cp.slf_contrato_codigo = V_CONTRATOCARGAS
                                                  and trim(cp.fcf_tpcarga_codigo) = trim(ListaCargaCli.ccTPCARGACLIPESQ)
                                                  and trim(cp.fcf_tpveiculo_codigo) = trim(V_CODIGOVEICULO)
                                                  and cp.slf_clienteped_ativo = 'S'
                                                  and cp.glb_localidade_codigooriib = RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC'), 8)
                                                  and cp.glb_localidade_codigodesib = RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC'), 8)
                                                  and cp.glb_localidade_outracoletai = RPAD(DECODE(ListaCargaCli.ccTPCODOCOUTRACOL,'NN','99999',tdvadm.fn_busca_codigoibge(ListaNotas.cnOUTRACOLETA, 'IBC')), 8)
                                                  and cp.glb_localidade_outraentregai = RPAD(DECODE(ListaCargaCli.ccTPCODOCOUTRAENTR,'NN','99999',tdvadm.fn_busca_codigoibge(ListaNotas.cnOUTRAENTREGA, 'IBC')), 8)
                                                  and cp.slf_clienteped_vigencia = (select max(cp1.slf_clienteped_vigencia)
                                                                                    from TDVADM.T_slf_clienteped cp1
                                                                                    where cp1.glb_grupoeconomico_codigo = cp.glb_grupoeconomico_codigo
                                                                                      and cp1.glb_cliente_cgccpfcodigo = cp.glb_cliente_cgccpfcodigo
                                                                                      and cp1.slf_contrato_codigo = cp.slf_contrato_codigo
                                                                                      and cp1.fcf_tpcarga_codigo = cp.fcf_tpcarga_codigo
                                                                                      and cp1.slf_clienteped_ativo = 'S'
                                                                                      and trunc(cp1.slf_clienteped_vigencia) <= trunc(sysdate));

                                              ListaVerbas('D_PD').AsFloat      := vAuxiliarnumerico;                               
                                              ListaVerbas('D_PD').Value        := to_char(vAuxiliarnumerico);
                                              ListaVerbas('D_PD').AsDesinencia := vAuxiliarT;


                                                 
                                            Exception
                                              When NO_DATA_FOUND Then
                                                  vAuxiliarnumerico := 0;
                                                  vAuxiliarT := 'VL';                                      
                                              End ;                                      
                                            if ListaNotas.cnGRUPOECSAC = '0020' and 
                                               nvl(vAuxiliarnumerico,0) = 0 AND
                                               TRUNC(SYSDATE) <= TO_DATE('30/03/2019','DD/MM/YYYY')  Then
                                               if trim(ListaCargaCli.ccTPCARGACLIPESQ) IN ('12') then
                                                     vAuxiliarT := 'TX';
                                                     select DISTINCT x.pedagio
                                                       into vAuxiliarnumerico
                                                     from TDVADM.qqpvale x
                                                     where trim(x.tipo_servico) = 'PEDAGIO-FRACIONADO'
                                                       and x.ibgeo = RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC'), 8)
                                                       and x.ibged = RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC'), 8)
                                                       and instr(x.tipo,decode(ListaNotas.cnEntregaCol,'C','FOB','FCA')) > 0
                                                       and trim(x.veiculo)     = '9' --trim(V_CODIGOVEICULO);
                                                       and x.vigencia = (select max(x1.vigencia)
                                                                         from TDVADM.qqpvale x1
                                                                         where trim(x1.tipo_servico) = trim(x.tipo_servico)
                                                                         GROUP BY x1.tipo_servico );
                                               elsIf trim(ListaCargaCli.ccTPCARGACLIPESQ) = '11' then
                                                     vAuxiliarT := 'VL';
                                                     select DISTINCT x.pedagio
                                                       into vAuxiliarnumerico
                                                     from TDVADM.qqpvale x
                                                    where trim(x.tipo_servico) = 'PEDAGIO-LOTACAO'
                                                       and x.ibgeo = RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC'), 8)
                                                       and x.ibged = RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC'), 8)
                                                       and instr(x.tipo,decode(ListaNotas.cnEntregaCol,'C','FOB','FCA')) > 0
                                                       and trim(x.veiculo)     = trim(V_CODIGOVEICULO)
                                                       and x.vigencia = (select max(x1.vigencia)
                                                                         from TDVADM.qqpvale x1
                                                                         where trim(x1.tipo_servico) = trim(x.tipo_servico)
                                                                         GROUP BY x1.tipo_servico );
                                               elsIf trim(ListaCargaCli.ccTPCARGACLIPESQ) = '10' then
                                                     vAuxiliarT := 'TX';
                                                     select DISTINCT x.pedagio
                                                       into vAuxiliarnumerico
                                                     from TDVADM.qqpvale x
                                                     where trim(x.tipo_servico) = 'PEDAGIO-FRACIONADO'
                                                       and x.ibgeo = RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC'), 8)
                                                       and x.ibged = RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC'), 8)
                                                       and instr(x.tipo,decode(ListaNotas.cnEntregaCol,'C','FOB','FCA')) > 0
                                                       and trim(x.veiculo)     = '9' --trim(V_CODIGOVEICULO);
                                                       and x.vigencia = (select max(x1.vigencia)
                                                                         from TDVADM.qqpvale x1
                                                                         where trim(x1.tipo_servico) = trim(x.tipo_servico)
                                                                         GROUP BY x1.tipo_servico );

                                               End If;
                                            End If;
                                            
                                            exception
                                              when NO_DATA_FOUND Then
                                                 vAuxiliarT := 'VL';
                                                 vAuxiliarnumerico := 0;
                                              when OTHERS Then
                                                 vErroFatal := 'E';
                                                 tpLogGeracaO.Con_Loggeracao_ErroHTML := 'F-Pedagio Com problemas: ' || chr(10) || 
                                                                                     'Origem ' || RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC'), 8) || chr(10) ||
                                                                                     'Destino ' || RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC'), 8) || chr(10) ||
                                                                                     'Ent/Col ' || ListaNotas.cnEntregaCol || chr(10) ||
                                                                                     'erro : ' || sqlerrm;
    --                                             tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Origem  : ' || RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC') || chr(10);
    --                                             tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'Destino : ' || RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC') || chr(10);
    --                                             tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'EntCol  : ' || ListaNotas.cnEntregaCol || chr(10) ;
    --                                             tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'CodVeic : ' || V_CODIGOVEICULO || chr(10);
    --                                             tpLogGeracaO.Con_Loggeracao_ErroHTML := tpLogGeracaO.Con_Loggeracao_ErroHTML || 'TpCarga : ';
                                                 p_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                                 vAuxiliarT := 'VL';
                                                 vAuxiliarnumerico := 0;
                                              End ;  
                                          End If;   
                                           vAuxiliarT := nvl(vAuxiliarT,'VL');                                 

                                        if ListaCargaCli.ccFORMULAPDTX is not null then
                                            if ListaVerbas('D_PD').AsDesinencia = 'TX' Then
                                               vFormulaTraduzidaP := ' SELECT ' || fn_MudaFormula(ListaCargaCli.ccFORMULAPDTX,ListaVerbas) || ' FROM DUAL ';
                                            Else
                                               vFormulaTraduzidaP := ' SELECT ' || fn_MudaFormula(ListaCargaCli.ccFORMULAPDVL,ListaVerbas) || ' FROM DUAL ';
                                            End If;   
                       
                                           execute immediate vFormulaTraduzidaP into vAuxiliarnumerico;
                                           UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                                              SET CC.CON_CALCVIAGEM_VALOR =  vAuxiliarnumerico, 
                                                  CC.CON_CALCVIAGEM_DESINENCIA = ListaVerbas('D_PD').AsDesinencia
                                            WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                              AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                                              AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                            --and nvl(CC.CON_CALCVIAGEM_VALOR,0) = 0 --Foi retirado pelo motivo de ter frmula tendo que mudar o valor! 
                                              AND trim(CC.SLF_RECCUST_CODIGO) = 'D_PD';

                                        Else

                                           UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                                              SET CC.CON_CALCVIAGEM_VALOR =  DECODE(vAuxiliarT,'TX',(ListaVerbas('D_PD').AsFloat * ((/*V_PESOCOBTOTAL*/ V_LOTACAO * vAuxiliarFatorRateio)/1000)),ListaVerbas('D_PD').AsFloat) ,
                                                  CC.CON_CALCVIAGEM_DESINENCIA = 'VL'
                                            WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                              AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                                              AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                              AND trim(CC.SLF_RECCUST_CODIGO) = 'D_PD';
                                          
                                       
                                        End If;

                                       tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML  := 'Cenario para pegar pedagio' || chr(10) ||
                                                                                  'Grupo ' || V_GRUPOCARGAS || chr(10) ||
                                                                                  'Sacado ' || V_SACADOCARGA || chr(10) ||
                                                                                  'Contrato ' || V_CONTRATOCARGAS || chr(10) ||
                                                                                  'Coleta ' || RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC'), 8) || chr(10) ||
                                                                                  'Entrega ' || RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC'), 8) || chr(10) ||
                                                                                  'Carga ' || ListaCargaCli.ccTPCARGACLI || '-' || ListaCargaCli.ccTPCARGACLIDESC || chr(10) ||
                                                                                  'Peso Total  ' || to_char(vBusca_Frete.vPESOTOTAL)  || chr(10) ||
                                                                                  'Peso        ' || to_char(vBusca_Frete.vPESO)  || chr(10) ||
                                                                                  'Km          ' || to_char(ListaVaux.cnKM) || chr(10) ||
                                                                                  'Veiculo     ' || V_CODIGOVEICULO || chr(10) ||
                                                                                  'Valor Pedagio ' || ListaVerbas('D_PD').Value || chr(10) ||
                                                                                  'FatorTransf ' || ListaVerbas('V_PERCTT').Value || chr(10) ||
                                                                                  'PesoRateio  ' || ListaVerbas('V_PSRATEIO').Value || chr(10) ||
                                                                                  'FatorRateio ' || ListaVerbas('V_FTRATEIO').Value || chr(10) ||
                                                                                  'TpCargaNota- ' || ListaNotas.cnTpCarga || chr(10) || 
                                                                                  'Formula Frete TX  - ' || ListaCargaCli.ccFORMULAFRTX || chr(10) ||
                                                                                  'Formula Frete VL  - ' || ListaCargaCli.ccFORMULAFRVL || chr(10) ||
                                                                                  'Formula Frete KM  - ' || ListaCargaCli.ccFORMULAFRKM || chr(10) ||
                                                                                  'Formula traduzida - ' || vFormulaTraduzidaF || chr(10) ||
                                                                                  'Formula Pedag TX  - ' || ListaCargaCli.ccFORMULAPDTX || chr(10) ||
                                                                                  'Formula Pedag VL  - ' || ListaCargaCli.ccFORMULAPDVL || chr(10) ||
                                                                                  'Formula traduzida - ' || vFormulaTraduzidaP || chr(10);
                                          vAuxiliarchar := fn_InsereLogGeracao;


                                           
                                        vAuxiliarnumerico := Sql%Rowcount;
                                         
                                    ElsIF nvl(ListaQuebras.ccTPRATEIO,'02') = '03' THEN   
                                   
                                        if trim(vAuxiliarT) = 'VL' Then
                                            vAuxiliarnumerico := round(vAuxiliarnumerico / ListaVaux.cnContaFornec ,2) ;
                                            UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                                               SET CC.CON_CALCVIAGEM_VALOR =  vAuxiliarnumerico
                                                   ,CC.CON_CALCVIAGEM_DESINENCIA = 'VL'
                                             WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                               AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                                               AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                               AND trim(CC.SLF_RECCUST_CODIGO) = 'D_FRPSVO';
                                            UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                                               SET CC.CON_CALCVIAGEM_VALOR =   round(CC.CON_CALCVIAGEM_VALOR / ListaVaux.cnContaFornec,2) 
                                                   ,CC.CON_CALCVIAGEM_DESINENCIA = 'VL'
                                             WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                               AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                                               AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                               AND trim(CC.SLF_RECCUST_CODIGO) = 'D_PD';
                                        End If; 
                                    Else
                                        vRetBuscaFrete.vFATORRATEIO := nvl(vRetBuscaFrete.vFATORRATEIO,1);
                                        if trim(vAuxiliarT) = 'VL' Then
                                           
                                            UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                                               SET CC.CON_CALCVIAGEM_VALOR = ((( round(CC.CON_CALCVIAGEM_VALOR * (vAuxiliarFatorRateio) ,2) ) * ListaVaux.cnPercentQP ) * ListaVaux.cnPercentEx )
        --                                           ,CC.CON_CALCVIAGEM_DESINENCIA = 'VL'
                                             WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                               AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                                               AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                               AND trim(CC.SLF_RECCUST_CODIGO) = 'D_FRPSVO';
                                        Else
                                            UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                                               SET CC.CON_CALCVIAGEM_VALOR = round( (( (CC.CON_CALCVIAGEM_VALOR /** vAuxiliarFatorRateio*/) * ListaVaux.cnPercentQP ) * ListaVaux.cnPercentEx ) ,2)
        --                                           ,CC.CON_CALCVIAGEM_DESINENCIA = 'VL'
                                             WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                               AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                                               AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                               AND trim(CC.SLF_RECCUST_CODIGO) = 'D_FRPSVO';
                                        End If; 
                                          UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                                             SET CC.CON_CALCVIAGEM_VALOR =  (CC.CON_CALCVIAGEM_VALOR * (/*V_PESOCOBTOTAL*/ V_LOTACAO * vAuxiliarFatorRateio)/1000),
                                                 CC.CON_CALCVIAGEM_DESINENCIA = 'VL'
                                           WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                             AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                                             AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                             AND trim(CC.SLF_RECCUST_CODIGO) = 'D_PD';
                                          vAuxiliarnumerico := Sql%Rowcount;
                                        
                                       
                                     End If;   
                                           
                               End If;
                               vAuxiliarnumerico := Sql%Rowcount;


                               tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML  := 'Carga ' || ListaCargaCli.ccTPCARGACLI || '-' || ListaCargaCli.ccTPCARGACLIDESC || chr(10) ||
                                                                          'Carregamento ' || P_ARM_CARREGAMENTO || chr(10) ||
                                                                          'CTe ' || V_CTRCCODIGO || '-' || ListaNotas.cnROTA || chr(10) ||
                                                                          'Desinencia  ' || vAuxiliarT || chr(10) ||
                                                                          'Valor Frete ' || to_char(vAuxiliarnumerico) || chr(10) ||
                                                                          'Peso Total  ' || to_char(vBusca_Frete.vPESOTOTAL)  || chr(10) ||
                                                                          'Peso        ' || to_char(vBusca_Frete.vPESO)  || chr(10) ||
                                                                          'Km          ' || to_char(ListaVaux.cnKM) || chr(10) ||
                                                                          'Veiculo     ' || vRetBuscaFrete.FCF_TPVEICULO_CODIGO || chr(10) ||
                                                                          'PercentPQ   ' || to_char(ListaVaux.cnPercentQP) || chr(10) ||
                                                                          'PercentEX   ' || to_char(ListaVaux.cnPercentEx) || chr(10) ||
                                                                          'FatorTransf ' || ListaVerbas('V_PERCTT').Value || chr(10) ||
                                                                          'PesoRateio  ' || ListaVerbas('V_PSRATEIO').Value || chr(10) ||
                                                                          'FatorRateio ' || ListaVerbas('V_FTRATEIO').Value || chr(10) ||
                                                                          'PercentOUT  ' || ListaVerbas('V_PERCTO').Value || chr(10) ||
                                                                          'Redutor     ' || ListaVerbas('V_PERCTR').Value || chr(10) || 
                                                                          'FreteVar    ' || ListaVerbas('D_FRPSVO').Value || chr(10) || 
                                                                          'DesVar      ' || ListaVerbas('D_FRPSVO').AsDesinencia || chr(10) || 
                                                                          'TpCargaNota- ' || ListaNotas.cnTpCarga || chr(10) || 
                                                                          'Formula Frete TX  - ' || ListaCargaCli.ccFORMULAFRTX || chr(10) ||
                                                                          'Formula Frete VL  - ' || ListaCargaCli.ccFORMULAFRVL || chr(10) ||
                                                                          'Formula Frete KM  - ' || ListaCargaCli.ccFORMULAFRKM || chr(10) ||
                                                                          'Formula traduzida - ' || vFormulaTraduzidaF || chr(10) ||
                                                                          'Formula Pedag TX  - ' || ListaCargaCli.ccFORMULAPDTX || chr(10) ||
                                                                          'Formula Pedag VL  - ' || ListaCargaCli.ccFORMULAPDVL || chr(10) ||
                                                                        'Formula traduzida - ' || vFormulaTraduzidaP || chr(10);
                                  vAuxiliarchar := fn_InsereLogGeracao;
                               COMMIT;   

                         End If;
                   
--                     End If;
                      V_SOMAPESOCOBRADO := V_SOMAPESOCOBRADO + ListaNotas.CnPESOCOBRADO;
                      if V_SOMAPESOCOBRADO > 999999 Then
                         tpLogGeracaO.Con_Loggeracao_ErroHTML := 'SOMA DOS PESOS COBRADOS ULTRAPASSOU 99.999 Quilos Verifique, Atingiu ' || to_char(V_SOMAPESOCOBRADO,'9,999,999.999'); 
                         P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                      End if;
                      
                              vAuxiliarnumerico := Sql%Rowcount;
                    
                     
                      if ListaCargaCli.ccTPCARGACLI in ('13','14','25','26') Then
                          UPDATE TDVADM.T_ARM_NOTA N
                             SET N.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO,
                                 N.CON_CONHECIMENTO_SERIE  = 'XXX',
                                 N.GLB_ROTA_CODIGO         = ListaNotas.cnROTA
                           WHERE TRIM(N.GLB_CLIENTE_CGCCPFREMETENTE) = TRIM(ListaNotas.cnCLIREM)
                             AND N.ARM_NOTA_NUMERO = TO_NUMBER(ListaNotas.cnNOTA)
                             AND TRIM(N.GLB_CLIENTE_CGCCPFDESTINATARIO) = TRIM(ListaNotas.cnCLIDEST);
                      Else
                         /* tdvadm.pkg_slf_contrato.SP_SETCRIAJANELA(ListaNotas.cnNOTA,
                                                                   ListaNotas.cnCLIREM,
                                                                   ListaNotas.cnSERIENF,
                                                                   ListaNotas.cnSequencia,
                                                                   'C',
                                                                   vStatus,
                                                                   vMessage);*/
                          ---------------------------------------------------------------------
                          -- Comentado dia 20/09 por Rafael e Sirlano, pois criao de janela--
                          ------------no ser mais no fechamento do carregamento.-------------
                          ---------------------------------------------------------------------
                          
                          -- Pesquisa se existe um Registro do CTe Original
                          -- Caso exista Nao deixa atualizar a nota com o CTe criado.
                          select count(*)
                             into vAuxiliarnumerico
                          from tdvadm.t_arm_notacte ancte
                          where ancte.arm_nota_sequencia = ListaNotas.cnSequencia
                            and ancte.arm_notacte_codigo = 'NO';
                           
                          If vAuxiliarnumerico = 0 Then
                             UPDATE TDVADM.T_ARM_NOTA N
                                SET N.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO,
                                    N.CON_CONHECIMENTO_SERIE  = 'XXX',
                                    N.GLB_ROTA_CODIGO         = ListaNotas.cnROTA
                              WHERE n.arm_nota_sequencia = ListaNotas.cnSequencia
                                AND N.CON_CONHECIMENTO_CODIGO IS NULL;
                              vAuxiliarnumerico := sql%rowcount;
                          End If;
                      End IF;   
                      -- Verifica se a NOTA e Nao RATEAVEL e MONTA LISTA
                      IF SQL%ROWCOUNT <> 0 THEN
                         if ListaCargaCli.ccRATEIA = 'N' Then 
                            vLISTADENOTASNRAT := vLISTADENOTASNRAT ||  ',' || ListaNotas.cnCLIREM ||  ListaNotas.cnNOTA;
                         End If;   
                      Else
                        
                         tpLogGeracaO.Con_Loggeracao_ErroHTML := 'NOTA NAO ATUALIZADA COM O NUMERO DE CTRC ' || chr(10) || 
                                                                 'ORIGEM -' || ListaNotas.cnORIGEM || chr(10) ||
                                                                 'DESTINO -' || ListaNotas.cnDESTINO || chr(10) ||
                                                                 'TIPO FRETE-' || V_CIFFOB || chr(10) ||
                                                                 'TPCALCULO-' || vDescCalculo || chr(10) ||
                                                                 'TPCARGA-' || ListaCargaCli.ccTPCARGACLI || chr(10) ||
                                                                 'SACADOBUSCA-' || V_SACADOCARGA || chr(10) ||
                                                                 'GRUPOBUSCA-' || V_GRUPOCARGAS || chr(10) ||
                                                                 'TPVEICULO-' || TDVADM.PKG_FIFO_CARREGCTRC.FN_BUSCA_TPCARGAVEICULO(V_GRUPOCARGAS,
                                                                                     V_CONTRATOCARGAS,
                                                                                     V_SACADOCARGA,
                                                                                     ListaNotas.CnPESOCOBRADO,
                                                                                     V_CIFFOB,
                                                                                     ListaNotas.cnTIPOTRANSP,
                                                                                     ListaCargaCli.ccTPCARGACLI,
                                                                                     ListaCargaCli.ccPESQVEICULO,'TV') || chr(10) ||
                                                                 'teste - ('|| ListaNotas.cnNOTA || '-' || ListaNotas.cnCLIREM || ' - ' || ListaNotas.cnSequencia || ')' || chr(10) ||
                                                                 'KM-' || ListaVaux.cnKM || chr(10) ||
                                                                 'PESOCOB-' || ListaNotas.CnPESOCOBRADO || chr(10) ; 
                         P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                         v_classificaerro       := trim(v_classificaerro) || ';NNA';
                      END IF;
                      
                      begin
                      -- Atualiza a nova tabela TDVADM.T_arm_notacte
                     if trim(ListaCargaCli.ccTPCARGACLI) = '13' Then
                         update TDVADM.T_arm_notacte c
                            set c.con_conhecimento_codigo = V_CTRCCODIGO,
                                c.con_conhecimento_serie = 'XXX',
                                c.glb_rota_codigo = ListaNotas.cnROTA
                         where 0 = 0
--                           and c.arm_notacte_codigo = ListaNotas.cnNOTA
--                           and c.glb_cliente_cgccpfremetente = ListaNotas.cnCLIREM
 --                          and c.arm_nota_serie = ListaNotas.cnSERIENF
                           and c.arm_nota_sequencia  = ListaNotas.cnSequencia
                           and c.arm_notacte_codigo = 'RE';
                      Elsif trim(ListaCargaCli.ccTPCARGACLI) = '14' Then     
                         update TDVADM.T_arm_notacte c
                            set c.con_conhecimento_codigo = V_CTRCCODIGO,
                                c.con_conhecimento_serie = 'XXX',
                                c.glb_rota_codigo = ListaNotas.cnROTA
                         where 0 = 0
--                           and c.arm_notacte_codigo = ListaNotas.cnNOTA
--                           and c.glb_cliente_cgccpfremetente = ListaNotas.cnCLIREM
--                           and c.arm_nota_serie = ListaNotas.cnSERIENF
                           and c.arm_nota_sequencia  = ListaNotas.cnSequencia
                           and c.arm_notacte_codigo = 'DE';
                      Elsif trim(ListaCargaCli.ccTPCARGACLI) = '25' Then     
                         update TDVADM.T_arm_notacte c
                            set c.con_conhecimento_codigo = V_CTRCCODIGO,
                                c.con_conhecimento_serie = 'XXX',
                                c.glb_rota_codigo = ListaNotas.cnROTA
                         where 0 = 0
--                           and c.arm_notacte_codigo = ListaNotas.cnNOTA
--                           and c.glb_cliente_cgccpfremetente = ListaNotas.cnCLIREM
--                           and c.arm_nota_serie = ListaNotas.cnSERIENF
                           and c.arm_nota_sequencia  = ListaNotas.cnSequencia
                           and c.arm_notacte_codigo = 'CC';
                      Elsif trim(ListaCargaCli.ccTPCARGACLI) = '26' Then     
                         update TDVADM.T_arm_notacte c
                            set c.con_conhecimento_codigo = V_CTRCCODIGO,
                                c.con_conhecimento_serie = 'XXX',
                                c.glb_rota_codigo = ListaNotas.cnROTA
                         where 0 = 0
--                           and c.arm_notacte_codigo = ListaNotas.cnNOTA
--                           and c.glb_cliente_cgccpfremetente = ListaNotas.cnCLIREM
--                           and c.arm_nota_serie = ListaNotas.cnSERIENF
                           and c.arm_nota_sequencia  = ListaNotas.cnSequencia
                           and c.arm_notacte_codigo = 'RR';
                      Else
                          insert into TDVADM.T_arm_notacte
                             (arm_notacte_codigo,
                              arm_nota_numero,
                              glb_cliente_cgccpfremetente,
                              arm_nota_serie,
                              arm_nota_sequencia,
                              arm_nota_chavenfe,
                              arm_coleta_ncompra,
                              arm_coleta_ciclo,
                              con_conhecimento_codigo,
                              con_conhecimento_serie,
                              glb_rota_codigo,
                              usu_usuario_codigo,
                              glb_cliente_cgccpfsacado,
                              slf_contrato_codigo,
                              arm_nota_tabsolcod,
                              arm_nota_tabsolsq,
                              arm_nota_tabsol,
                              arm_notacte_dtgravacao,
                              arm_carregamento_codigo)
                           values 
                           ('NO',
                            ListaNotas.cnNOTA,
                            ListaNotas.cnCLIREM,
                            ListaNotas.cnSERIENF,
                            ListaNotas.cnSequencia,
                            ListaNotas.cnCHAVENFE,
                            ListaNotas.cnNrColeta,
                            ListaNotas.cnNrColetaCiclo,
                            V_CTRCCODIGO,
                            'XXX',
                            ListaNotas.cnROTA,
                            P_USU_USUARIOCRIA,
                            ListaNotas.cnCLISAC,
                            ListaQuebras.CONTRATO,
                            ListaNotas.cnTABSOLCOD,
                            lpad(trim(ListaNotas.cnTABSOLSQ),4,'0'),
                            ListaNotas.cnTABSOL,
                            sysdate,
                            P_ARM_CARREGAMENTO);
                         End If;   
                      exception
                        when OTHERS Then 
                           ListaQuebras.CONTRATO := ListaQuebras.CONTRATO;
                        End ;  
                        
                        

                    
                      SELECT COUNT(*)
                        INTO V_CONTAVERBAVLR
                        FROM TDVADM.T_CON_CALCCONHECIMENTO CA
                       WHERE CA.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                         AND CA.CON_CONHECIMENTO_SERIE = 'XXX'
                         AND CA.GLB_ROTA_CODIGO = ListaNotas.cnROTA;
                    
                      IF V_CONTAVERBAVLR < 80 THEN
                         tpLogGeracaO.Con_Loggeracao_ErroHTML := 'NAO CARREGOU TODAS AS VERBAS DO CTRC --- ORIGEM -' ||
                                                             ListaNotas.cnORIGEM || '-DESTINO -' || ListaNotas.cnDESTINO  ||
                                                             ' TABELA - ' || ListaNotas.cnTABSOLCOD || '-' || ListaNotas.cnTABSOLSQ ||
                                                             '-TIPO FRETE-' || V_CIFFOB || '-TPCALCULO-' || vDescCalculo || '-TPCARGA-' ||
                                                             ListaCargaCli.ccTPCARGACLI || '-SACADOBUSCA-' || V_SACADOCARGA ||
                                                             '-GRUPOBUSCA-' || V_GRUPOCARGAS || '-TPVEICULO-' ||
                                                             TDVADM.PKG_FIFO_CARREGCTRC.FN_BUSCA_TPCARGAVEICULO(V_GRUPOCARGAS,
                                                                                     V_CONTRATOCARGAS,
                                                                                     V_SACADOCARGA,
                                                                                     ListaNotas.CnPESOCOBRADO,
                                                                                     V_CIFFOB,
                                                                                     ListaNotas.cnTIPOTRANSP,
                                                                                     ListaCargaCli.ccTPCARGACLI,
                                                                                     ListaCargaCli.ccPESQVEICULO,
                                                                                     'TV') || '-KM-' || ListaVaux.cnKM ||
                                                             '-PESOCOB-' || ListaNotas.CnPESOCOBRADO; 
                         P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                         v_classificaerro       := trim(v_classificaerro) ||
                                                   ';VERBAS';
                      
                      ELSE
                        -- CALCULA O CTRC
                        BEGIN
                        
                        -- antes do calculo verifca se usa lotac?o ou Nao  
                        -- sirlano 20/09
                        -- TRADUZIR O TIPO DE VEICULO PARA IR BUSCAR A LOTACAO REAL
                        
                        
                        IF vRetBuscaFrete.vRetorno = 'MA' THEN

                     tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML  := fni_retcenario('TENDANDO MODO ANTIGO:');
                           vAuxiliarchar := fn_InsereLogGeracao;

                            IF ListaNotas.cnTABSOL = 'T' Then
                               v_vlrlotacao := '0';
                              
                              SELECT nvl(max(tl.glb_tabelalotacao_maxkg), '0')
                                 INTO v_vlrlotacao
                              FROM TDVADM.T_slf_tabelalotacao tl
                              WHERE tl.slf_tabela_codigo = ListaNotas.cnTABSOLCOD
                                AND tl.slf_tabela_saque = ListaNotas.cnTABSOLSQ;
      --                           AND tl.slf_tpveiculo_codigo = ''
      
      
      
                            ELSIF ListaNotas.cnTABSOL = 'S' THEN
                               SELECT nvl( max(sl.slf_solfretelotacao_maxkg), '0')
                                 INTO v_vlrlotacao
                               FROM TDVADM.T_slf_solfretelotacao sl
                               WHERE sl.slf_solfrete_codigo = ListaNotas.cnTABSOLCOD
                                 AND sl.slf_solfrete_saque = ListaNotas.cnTABSOLSQ;
      --                           AND tl.slf_tpveiculo_codigo = ''
      
                            END IF; 
                            
                            
            /********************************************************************************************************/
            /*       VOU INICIAR UM TESTE APENAS COM A ROTA 021 ate o dia 01/10/2011                                */
            /********************************************************************************************************/
                            
                        -- usa o maior entre o peso cobrado e o lotac?o
                        --Estou utilizando o replace para e multiplicac?o para converter o valor da lotac?o para numerico.
                            IF nvl(V_PESOCOBTOTAL,0)  < nvl(replace(v_vlrlotacao, ',', '.') * 1000,0)   THEN
                               vPeso := replace(v_vlrlotacao, ',', '.') * 1000 ;
                            Else
                              vPeso := V_PESOCOBTOTAL;
                            END IF;   

                      -- PEGAR PESO COBRADO
                       UPDATE TDVADM.T_CON_CALCCONHECIMENTO CC
                         SET CC.CON_CALCVIAGEM_VALOR = vPeso / 1000
                       WHERE CC.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                         AND CC.CON_CONHECIMENTO_SERIE = 'XXX'
                         AND CC.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                         AND trim(CC.SLF_RECCUST_CODIGO) = 'I_PSCOBRAD';
                         vDedoDuro := '';
                         
                         vDedoDuro := vDedoDuro  ||'TESTE DE NOVA ROTINA DE PESO ' ||
                                                   ' - nota = '          || ListaNotas.cnNOTA            ||
                                                   ' - CTRC='            || V_CTRCCODIGO      ||
                                                   ' - Rota='            || ListaNotas.cnROTA            ||
                                                   ' - Total Peso Nota= '|| V_PESOCOBTOTAL    || 
                                                   ' - Total Peso Balanca= ' || V_PESOBALTOTAL ||
                                                   ' - Peso Lotacao='    || replace(v_vlrlotacao, ',', '.') * 1000      || 
                                                   ' - Peso Sugerido='   || vPeso             || 
                                                   ' - tab/sol= '        || ListaNotas.cnTABSOLCOD          || 
                                                   ' - saque= '          || ListaNotas.cnTABSOLSQ        || chr(13); 
                  End If;      
                       If TDVADM.PKG_slf_calculos.vDebugCalculoUsuario = P_USU_USUARIOCRIA Then
                          TDVADM.PKG_slf_calculos.vDebugCalculoCTRC :=  V_CTRCCODIGO || ListaNotas.cnROTA;
                       End If; 
                        
                          
                        UPDATE TDVADM.T_CON_CALCCONHECIMENTO C
                          SET C.CON_CONHECIMENTO_ALTALTMAN = NULL
                        WHERE C.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                          AND C.CON_CONHECIMENTO_SERIE = 'XXX'
                          AND C.GLB_ROTA_CODIGO = ListaNotas.cnROTA;
                        COMMIT;

                        TDVADM.PKG_SLF_CALCULOS.SP_MONTA_FORMULA_CNHC(V_TPCALCULO,
                                                                      V_CTRCCODIGO,
                                                                      'XXX',
                                                                      ListaNotas.cnROTA);
                                                               
                    -- INICIO CRITICA DAS JANELA DE CORTE
                        begin

                              --  CARREGANGO TABELA DO " SIMULADOR "
                              
                              tpsimulador.arm_carregamento_codigo       := P_ARM_CARREGAMENTO;
                              tpsimulador.arm_armazem_codigo            := P_ARM_ARMAZEM;
                              tpsimulador.slf_contrato_codigo           := nvl(ListaQuebras.CONTRATO,QualquerContrato);
                              tpsimulador.con_conhecimento_codigoXXX    := V_CTRCCODIGO;
                              tpsimulador.con_conhecimento_codigo       := V_CTRCCODIGO;
                              tpsimulador.con_conhecimento_serie        := 'XXX';
                              tpsimulador.glb_rota_codigo               := ListaNotas.cnROTA;
                              /********** SIRLANO JANELA *************/
                              If P_ARM_ARMAZEM = P_ARM_ARMAZEM Then
                                 If ListaNotas.cnFechamentoCol is not null Then
                                    tpsimulador.arm_coleta_finalizada         := ListaNotas.cnFechamentoCol;
                                 Else
                                    tpsimulador.arm_coleta_finalizada         := sysdate;
                                 End If;   
                              Else
                                 tpsimulador.arm_coleta_finalizada         := sysdate;
                              End If;
                              tpsimulador.cs278_simulador_dtgravacao    := SYSDATE;
                              if vRetBuscaFrete.vRetorno <> 'MA' Then
                                 tpsimulador.arm_carregamento_tpcarga      := ListaCargaCli.ccTPCARGACLI || '-' || ListaCargaCli.ccTPCARGACLIPESQ || '-' || ListaNotas.cnTIPOCARGA;
                              Else  
                                 tpsimulador.arm_carregamento_tpcarga      := 'MA';
                              End If;
                              tpsimulador.arm_carregamento_tpveiculo    := vRetBuscaFrete.FCF_TPVEICULO_CODIGO;
                              tpsimulador.arm_carregamento_pesoconsilid := vBusca_Frete.vPESOTOTAL;
                              tpsimulador.arm_carregamento_peso         := vBusca_Frete.vPESO;
                              tpsimulador.arm_carregamento_km           := ListaVaux.cnKM;
                              tpsimulador.cs278_simulador_origem        :='PKG_FIFO_CARREGCTRC';
                              INSERT INTO TDVSVA.T_CS278_SIMULADOR VALUES tpsimulador;
 
                              
                              vTpCargaJanela := ListaCargaCli.ccTPCARGACLI;
                              -- Retirar na Nova Rotina
--                              if instr(cCargaExpressa || ',' || cCargaPerigosa,pkg_glb_common.Fn_QuotedStr(ListaNotas.cnTIPOCARGA)) > 0 Then
--                                 vTpCargaJanela  := '03';
--                              End If;
                              if TDVADM.PKG_FIFO_CARREGCTRC.fn_EColetaExpressa(ListaNotas.cnNRCOLETA,ListaNotas.cnNrColetaCiclo) = 'S' Then
                                 vTpCargaJanela  := '03';
                              End IF;
                               -- Idependente do Tipo de Rateio
                               tpJanela.Arm_Carregamemcalc_Contaador   := 1;
                               tpJanela.Arm_Carregamemcalc_Crioucarreg := P_USU_USUARIOCRIA;
                               tpJanela.arm_carregamemcalc_memocalc    := P_ARM_CARREGAMENTO;
                               tpJanela.Arm_Armazem_Codigo             := P_ARM_ARMAZEM;
                               tpJanela.Arm_Carregamemcalc_Data        := SYSDATE;
                               tpJanela.Fcf_Tpcarga_Codigo             := vTpCargaJanela ;
                               tpJanela.Arm_Carregamemcalc_Contrato    := nvl(ListaQuebras.CONTRATO,QualquerContrato);
                               tpJanela.Arm_Carregamemcalc_Grupoec     := V_GRUPOCARGAS ; --nvl(ListaNotas.cnGRUPOECSAC,QualquerGrupo);



                               If ( nvl(ListaQuebras.ccTPRATEIO,'02') in ('00') ) or 
                                  ( vRetBuscaFrete.vRetorno ='MA' ) Then
                                  
                                  tpJanela.Arm_Carregamemcalc_Tptabsol    := ListaNotas.cnTABSOL;
                                  tpJanela.Arm_Carregamemcalc_Tabsolcod   := ListaNotas.cnTABSOLCOD;
                                  tpJanela.Arm_Carregamemcalc_Tabsolsq    := ListaNotas.cnTABSOLSQ;

                                  tpJanela.Arm_Carregamemcalc_Clisac      := V_SACADOCARGA;

                                  tpJanela.Arm_Carregamemcalc_Cnpjrem     := QualquerCliente;
                                  tpJanela.Arm_Carregamemcalc_Cliendrem   := 'X';
                                  
                                  tpJanela.Arm_Carregamemcalc_Cnpjdes     := QualquerCliente;
                                  tpJanela.Arm_Carregamemcalc_Clienddes   := 'X';

                                  tpJanela.Arm_Carregamemcalc_Origemnota  := ListaNotas.cnCOLETA;
                                  tpJanela.Arm_Carregamemcalc_Destinonota := ListaNotas.cnENTREGA;
                                  tpJanela.Arm_Carregamemcalc_Entcol      := 'N';
                                  

                               ElsIf nvl(ListaQuebras.ccTPRATEIO,'02') in ('01','03','41') Then

                                  tpJanela.Arm_Carregamemcalc_Tptabsol    := 'T';
                                  tpJanela.Arm_Carregamemcalc_Tabsolcod   := SemTabelaCodigo;
                                  tpJanela.Arm_Carregamemcalc_Tabsolsq    := SemTabelaSaque;

                                  tpJanela.Arm_Carregamemcalc_Clisac      := ListaNotas.cnCLISAC;

                                  tpJanela.Arm_Carregamemcalc_Cnpjrem     := QualquerCliente;
                                  tpJanela.Arm_Carregamemcalc_Cliendrem   := 'X';

                                  tpJanela.Arm_Carregamemcalc_Cnpjdes     := ListaNotas.cnCLIDEST;
                                  tpJanela.Arm_Carregamemcalc_Clienddes   := ListaNotas.cnCLIENDDEST;


                                  tpJanela.Arm_Carregamemcalc_Origemnota  := ListaNotas.cnCOLETA;
                                  tpJanela.Arm_Carregamemcalc_Destinonota := ListaNotas.cnENTREGA;
                                  tpJanela.Arm_Carregamemcalc_Entcol      := ListaNotas.cnEntregaCol;

                               ElsIf nvl(ListaQuebras.ccTPRATEIO,'02') in ('02') Then 

                                  tpJanela.Arm_Carregamemcalc_Tptabsol    := 'T';
                                  tpJanela.Arm_Carregamemcalc_Tabsolcod   := SemTabelaCodigo;
                                  tpJanela.Arm_Carregamemcalc_Tabsolsq    := SemTabelaSaque;

                                  tpJanela.Arm_Carregamemcalc_Clisac      := V_SACADOCARGA;

                                  if ListaNotas.cnEntregaCol = 'E' Then
                                     tpJanela.Arm_Carregamemcalc_Cnpjrem     := ListaVaux.cnArmazem;
                                     tpJanela.Arm_Carregamemcalc_Cliendrem   := 'X';
                                  Else
                                     tpJanela.Arm_Carregamemcalc_Cnpjrem     := ListaNotas.cnCLIREM;
                                     tpJanela.Arm_Carregamemcalc_Cliendrem   := ListaNotas.cnCLIENDREM;
                                  End If;


                                  tpJanela.Arm_Carregamemcalc_Cnpjdes     := QualquerCliente;
                                  tpJanela.Arm_Carregamemcalc_Clienddes   := 'X';

-- Alterado em 09/10/2015 Sirlano
--                                  tpJanela.Arm_Carregamemcalc_Origemnota  := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnORIGEM, 'IBC'), 8);
--                                  tpJanela.Arm_Carregamemcalc_Destinonota := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnDESTINO, 'IBC'), 8);
                                  tpJanela.Arm_Carregamemcalc_Origemnota  := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC'), 8);
                                  tpJanela.Arm_Carregamemcalc_Destinonota := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC'), 8);
                                  tpJanela.Arm_Carregamemcalc_Entcol      := 'N';

                               ElsIf nvl(ListaQuebras.ccTPRATEIO,'02') in ('04') Then 

                                  tpJanela.Arm_Carregamemcalc_Tptabsol    := 'T';
                                  tpJanela.Arm_Carregamemcalc_Tabsolcod   := SemTabelaCodigo;
                                  tpJanela.Arm_Carregamemcalc_Tabsolsq    := SemTabelaSaque;

                                  tpJanela.Arm_Carregamemcalc_Clisac      := V_SACADOCARGA;

                                  tpJanela.Arm_Carregamemcalc_Cnpjrem     := QualquerCliente;
                                  tpJanela.Arm_Carregamemcalc_Cliendrem   := 'X';

                                  tpJanela.Arm_Carregamemcalc_Cnpjdes     := QualquerCliente;
                                  tpJanela.Arm_Carregamemcalc_Clienddes   := 'X';

-- Alterado em 09/10/2015 Sirlano
--                                  tpJanela.Arm_Carregamemcalc_Origemnota  := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnORIGEM, 'IBC'), 8);
--                                  tpJanela.Arm_Carregamemcalc_Destinonota := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnDESTINO, 'IBC'), 8);
                                  tpJanela.Arm_Carregamemcalc_Origemnota  := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC'), 8);
                                  tpJanela.Arm_Carregamemcalc_Destinonota := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC'), 8);
                                  tpJanela.Arm_Carregamemcalc_Entcol      := 'N';

                               ElsIf nvl(ListaQuebras.ccTPRATEIO,'02') in ('05') Then 

                                  tpJanela.Arm_Carregamemcalc_Tptabsol    := 'T';
                                  tpJanela.Arm_Carregamemcalc_Tabsolcod   := SemTabelaCodigo;
                                  tpJanela.Arm_Carregamemcalc_Tabsolsq    := SemTabelaSaque;

                                  tpJanela.Arm_Carregamemcalc_Clisac      := V_SACADOCARGA;


                                  tpJanela.Arm_Carregamemcalc_Cnpjrem     := ListaNotas.cnCLIREM;
--                                  tpJanela.Arm_Carregamemcalc_Cliendrem   := ListaNotas.cnCLIENDREM;
                                  tpJanela.Arm_Carregamemcalc_Cnpjdes     := ListaNotas.cnCLIDEST;


                                  tpJanela.Arm_Carregamemcalc_Cnpjdes     := QualquerCliente;
                                  tpJanela.Arm_Carregamemcalc_Clienddes   := 'X';

-- Alterado em 09/10/2015 Sirlano
--                                  tpJanela.Arm_Carregamemcalc_Origemnota  := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnORIGEM, 'IBC'), 8);
--                                  tpJanela.Arm_Carregamemcalc_Destinonota := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnDESTINO, 'IBC'), 8);
                                  tpJanela.Arm_Carregamemcalc_Origemnota  := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA, 'IBC'), 8);
                                  tpJanela.Arm_Carregamemcalc_Destinonota := RPAD(tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA, 'IBC'), 8);
                                  tpJanela.Arm_Carregamemcalc_Entcol      := 'N';

                               ElsIf nvl(ListaQuebras.ccTPRATEIO,'02') in ('06') Then

                                  tpJanela.Arm_Carregamemcalc_Tptabsol    := 'T';
                                  tpJanela.Arm_Carregamemcalc_Tabsolcod   := SemTabelaCodigo;
                                  tpJanela.Arm_Carregamemcalc_Tabsolsq    := SemTabelaSaque;

                                  tpJanela.Arm_Carregamemcalc_Clisac      := ListaNotas.cnCLISAC;
                                  tpJanela.Arm_Carregamemcalc_Origemnota  := ListaNotas.cnCOLETA;

                                  tpJanela.Arm_Carregamemcalc_Cnpjrem     := QualquerCliente;
                                  tpJanela.Arm_Carregamemcalc_Cliendrem   := 'X';

                                  tpJanela.Arm_Carregamemcalc_Cnpjdes     := QualquerCliente;
                                  tpJanela.Arm_Carregamemcalc_Clienddes   := 'X';


                                  tpJanela.Arm_Carregamemcalc_Destinonota := '99999';
                                  tpJanela.Arm_Carregamemcalc_Entcol      := 'X';
                               End If;

    --                           tpJanela.Arm_Carregamemcalc_Flagpgto    := ListaNotas
    --                           tpJanela.Arm_Carregamemcalc_Cctprateio  := ListaNotas
    --                           tpJanela.Arm_Carregamemcalc_Doccliente  := ListaNotas
    --                           tpJanela.Arm_Carregamemcalc_Finalizou   := ListaNotas
                               
    
                             SELECT count(*),
                                    MAX(CC.ARM_CARREGAMEMCORTE_QTDE),
                                    MAX(calc.arm_armazem_codigo || '-' || calc.arm_carregamemcalc_memocalc || '-' || calc.arm_carregamemcalc_crioucarreg)
                                 INTO vQtdeCorte,
                                      vQtdeLimiteJanela,
                                      vAuxiliarJ1
                             FROM TDVADM.T_Arm_Carregamemcalc calc,
                                  TDVADM.T_arm_carregamemcorte cc
                             WHERE 0 =0 
                               AND calc.arm_carregamemcalc_data IS NOT NULL
                               and calc.arm_carregamemcalc_memocalc <> P_ARM_CARREGAMENTO

--                               AND Calc.ARM_ARMAZEM_CODIGO             = P_ARM_ARMAZEM

-- Inclui em 14/09/2015 (Sirlano)
                               -- Para pegar os Horarios de Corte das Janelas
                               AND TRIM(CC.GLB_GRUPOECONOMICO_CODIGO)     = trim(V_GRUPOCARGAS)
                               AND TRIM(cc.glb_cliente_cgccpfcodigo)      =  trim(V_SACADOCARGA)
                               AND TRIM(CC.SLF_CONTRATO_CODIGO)           =  trim(V_CONTRATOCARGAS)
-- Retirei em 14/09/2015 (Sirlano)
--                               AND TRIM(CC.GLB_GRUPOECONOMICO_CODIGO)     = tpJanela.Arm_Carregamemcalc_Grupoec -- ListaNotas.cnGRUPOECSAC
--                               AND TRIM(cc.glb_cliente_cgccpfcodigo)      = QualquerCliente
--                               AND TRIM(CC.SLF_CONTRATO_CODIGO)           = trim(tpJanela.Arm_Carregamemcalc_Contrato)

                               AND CC.ARM_CARREGAMEMCORTE_ATIVO = 'S'
                               AND TRUNC(CC.ARM_CARREGAMEMCORTE_DATAINICIO) <= TRUNC(SYSDATE)
                               AND TRUNC(CC.ARM_CARREGAMEMCORTE_DATAFIM)    >= TRUNC(SYSDATE)

                               AND CC.FCF_TPCARGA_CODIGO                  = calc.FCF_TPCARGA_CODIGO  


-- Retirei em 14/09/2015 (Sirlano)
--                               and trim(cc.glb_grupoeconomico_codigo) = c.arm_carregamemcalc_grupoec
--                               and trim(cc.slf_contrato_codigo) = c.arm_carregamemcalc_contrato


                             AND TRIM(calc.FCF_TPCARGA_CODIGO)     = trim(tpJanela.Fcf_Tpcarga_Codigo) 
  
                             AND  trim(calc.Arm_Carregamemcalc_Tptabsol) =  trim(tpJanela.Arm_Carregamemcalc_Tptabsol)
--                             AND  trim(calc.Arm_Carregamemcalc_Tabsolcod) =  trim(tpJanela.Arm_Carregamemcalc_Tabsolcod)
--                             AND  trim(calc.Arm_Carregamemcalc_Tabsolsq)  =  trim(tpJanela.Arm_Carregamemcalc_Tabsolsq)
                             AND  trim(calc.Arm_Carregamemcalc_Clisac) =  trim(tpJanela.Arm_Carregamemcalc_Clisac)
                             AND  trim(calc.Arm_Carregamemcalc_Cnpjrem) =  trim(tpJanela.Arm_Carregamemcalc_Cnpjrem)
                             AND  trim(calc.Arm_Carregamemcalc_Cliendrem) =  trim(tpJanela.Arm_Carregamemcalc_Cliendrem)
                             AND  trim(calc.Arm_Carregamemcalc_Cnpjdes) =  trim(tpJanela.Arm_Carregamemcalc_Cnpjdes)
                             AND  trim(calc.Arm_Carregamemcalc_Clienddes) =  trim(tpJanela.Arm_Carregamemcalc_Clienddes)
                             AND  trim(calc.Arm_Carregamemcalc_Origemnota) =  trim(tpJanela.Arm_Carregamemcalc_Origemnota)
                             AND  trim(calc.Arm_Carregamemcalc_Destinonota) =  trim(tpJanela.Arm_Carregamemcalc_Destinonota)
                             AND  trim(calc.Arm_Carregamemcalc_Entcol) =  trim(tpJanela.Arm_Carregamemcalc_Entcol)

--                             AND calc.ARM_ARMAZEM_CODIGO NOT IN ('29','15')


                               AND TO_CHAR(SYSDATE                       ,'YYYYMMDDHH24MI') between TO_CHAR(TO_DATE(to_char(TRUNC(sysdate) + cc.arm_carregamemcorte_diai,'DD/MM/YYYY') || ' ' || trim(cc.arm_carregamemcorte_horai),'DD/MM/YYYY HH24:MI'),'YYYYMMDDHH24MI')
                                                                                                and TO_CHAR(TO_DATE(to_char(TRUNC(sysdate) + cc.arm_carregamemcorte_diaF,'DD/MM/YYYY') || ' ' || trim(cc.arm_carregamemcorte_horaF),'DD/MM/YYYY HH24:MI'),'YYYYMMDDHH24MI')

                               and TO_CHAR(calc.arm_carregamemcalc_data,'YYYYMMDDHH24MI') between TO_CHAR(TO_DATE(to_char(TRUNC(sysdate) + cc.arm_carregamemcorte_diai,'DD/MM/YYYY') || ' ' || trim(cc.arm_carregamemcorte_horai),'DD/MM/YYYY HH24:MI'),'YYYYMMDDHH24MI')
                                                                                                and TO_CHAR(TO_DATE(to_char(TRUNC(sysdate) + cc.arm_carregamemcorte_diaF,'DD/MM/YYYY') || ' ' || trim(cc.arm_carregamemcorte_horaF),'DD/MM/YYYY HH24:MI'),'YYYYMMDDHH24MI');
                             if  ( ListaNotas.cnTpCarga = 'CD') or ( vRetBuscaFrete.vRetorno = 'MA') Then
                                vQtdeLimiteJanela := 10;
                             End If;   
                             If nvl(vQtdeCorte,0) = 0 Then
                                select max(tpJanela.Arm_Carregamemcalc_Seqagrup)
                                  into tpJanela.Arm_Carregamemcalc_Seqagrup
                                from TDVADM.T_Arm_Carregamemcalc calc
                                where calc.arm_carregamemcalc_memocalc = tpJanela.Arm_Carregamemcalc_Memocalc;
                                tpJanela.Arm_Carregamemcalc_Seqagrup := nvl(tpJanela.Arm_Carregamemcalc_Seqagrup,0) + 1;
                                insert into TDVADM.T_Arm_Carregamemcalc values tpJanela; 
                                tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'PASSOU PELA CRITICA DE HORARIO DE CORTE';
                                P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                             Elsif NVL(vQtdeCorte,1) <= NVL(vQtdeLimiteJanela,1) Then

                                -- Verifica se existe algum carregamento com a mesma caracteristica 
                                -- com seus CTe Nao impressos
                                Begin
                                    select max(ca.arm_armazem_codigo || '-' || calc.arm_carregamemcalc_memocalc || '-' || calc.arm_carregamemcalc_crioucarreg),
                                           count(*)
                                       into vAuxiliarJ2,
                                            vAuxiliarnumerico
                                    from TDVADM.T_arm_carregamento ca,
                                         TDVADM.T_Arm_Carregamemcalc calc
                                    where ca.arm_carregamento_codigo        = calc.arm_carregamemcalc_memocalc
                                    
                                      and ca.arm_carregamento_qtdimpctrc < ca.arm_carregamento_qtdctrc
                                      and ca.arm_carregamento_codigo <> P_ARM_CARREGAMENTO

--                                       AND Calc.ARM_ARMAZEM_CODIGO             = P_ARM_ARMAZEM

                                       and nvl(ca.arm_carregamento_qtdctrc,0) > 0
                                       and ca.arm_carregamento_dtfechamento is not null
                                       AND TRUNC(calc.arm_carregamemcalc_data) = TRUNC(SYSDATE)
                                       AND TRIM(calc.FCF_TPCARGA_CODIGO)     = trim(tpJanela.Fcf_Tpcarga_Codigo) 
            
                                       AND  trim(calc.Arm_Carregamemcalc_Tptabsol) =  trim(tpJanela.Arm_Carregamemcalc_Tptabsol)
--                                       AND  trim(calc.Arm_Carregamemcalc_Tabsolcod) =  trim(tpJanela.Arm_Carregamemcalc_Tabsolcod)
--                                       AND  trim(calc.Arm_Carregamemcalc_Tabsolsq)  =  trim(tpJanela.Arm_Carregamemcalc_Tabsolsq)
                                       AND  trim(calc.Arm_Carregamemcalc_Clisac) =  trim(tpJanela.Arm_Carregamemcalc_Clisac)
                                       AND  trim(calc.Arm_Carregamemcalc_Cnpjrem) =  trim(tpJanela.Arm_Carregamemcalc_Cnpjrem)
                                       AND  trim(calc.Arm_Carregamemcalc_Cliendrem) =  trim(tpJanela.Arm_Carregamemcalc_Cliendrem)
                                       AND  trim(calc.Arm_Carregamemcalc_Cnpjdes) =  trim(tpJanela.Arm_Carregamemcalc_Cnpjdes)
                                       AND  trim(calc.Arm_Carregamemcalc_Clienddes) =  trim(tpJanela.Arm_Carregamemcalc_Clienddes)
                                       AND  trim(calc.Arm_Carregamemcalc_Origemnota) =  trim(tpJanela.Arm_Carregamemcalc_Origemnota)
                                       AND  trim(calc.Arm_Carregamemcalc_Destinonota) =  trim(tpJanela.Arm_Carregamemcalc_Destinonota)
                                       AND  trim(calc.Arm_Carregamemcalc_Entcol) =  trim(tpJanela.Arm_Carregamemcalc_Entcol);

--                                       AND calc.ARM_ARMAZEM_CODIGO NOT IN ('29','15');

                                      if vAuxiliarnumerico = 0 Then
                                         vAuxiliarT := vAuxiliarJ1 ;
                                      Else
                                         vAuxiliarT := vAuxiliarJ2;   
                                      End IF;

                                exception
                                  When OTHERS Then
                                     tpLogGeracaO.Con_Loggeracao_Obsgeracaohtml := 'OCORREU ERRO NA VALIDACAO DO HORARIO DE CORTE ' || chr(10) || 'erro-' || SQLERRM ;
                                     P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                  End ;    
                                
                                if ( vAuxiliarT = '000000' )  then 
                                    select max(tpJanela.Arm_Carregamemcalc_Seqagrup)
                                      into tpJanela.Arm_Carregamemcalc_Seqagrup
                                    from TDVADM.T_Arm_Carregamemcalc calc
                                    where calc.arm_carregamemcalc_memocalc = tpJanela.Arm_Carregamemcalc_Memocalc;
                                    tpJanela.Arm_Carregamemcalc_Seqagrup := nvl(tpJanela.Arm_Carregamemcalc_Seqagrup,0) + 1;
                                   insert into TDVADM.T_Arm_Carregamemcalc values tpJanela; 
                                   tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'PASSOU PELA CRITICA DE HORARIO DE CORTE';
                                   P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                Else
                                   IF  ( NVL(vQtdeCorte,1) + vAuxiliarnumerico) < NVL(vQtdeLimiteJanela,1) Then
                                      select max(tpJanela.Arm_Carregamemcalc_Seqagrup)
                                        into tpJanela.Arm_Carregamemcalc_Seqagrup
                                      from TDVADM.T_Arm_Carregamemcalc calc
                                      where calc.arm_carregamemcalc_memocalc = tpJanela.Arm_Carregamemcalc_Memocalc;
                                      tpJanela.Arm_Carregamemcalc_Seqagrup := nvl(tpJanela.Arm_Carregamemcalc_Seqagrup,0) + 1;
                                      insert into TDVADM.T_Arm_Carregamemcalc values tpJanela; 
                                      tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'PASSOU PELA CRITICA DE HORARIO DE CORTE';
                                   Else
--                                      V_NOTASCOMERRO := V_NOTASCOMERRO || ',' || ListaNotas.cnNOTA;
                                      tpLogGeracaO.Con_Loggeracao_Obsgeracaohtml := 'Nao PASSOU PELA CRITICA DE HORARIO DE CORTE. ' || chr(10) || 
                                                                          'EXISTEM CTEs NAO IMPRESSOS DE OUTRO HORARIO DE CORTE' || chr(10) || 
                                                                          'Tipo de CARGA selecionado ' || tpJanela.Fcf_Tpcarga_Codigo || chr(10) ||
                                                                          'Quantidade Usado ' || to_char(vQtdeCorte) || ' Limite ' || to_char(vQtdeLimiteJanela) || chr(10) ||
                                                                          'VOLTE O CARREGAMENTO E FECHE TODAS AS NOTAS JUNTAS ' || chr(10) ||
                                                                          'VERIFIQUE ARMAZEM-CARREGAMENTO-USUARIO QUE ESTA IMPEDINDO ' || vAuxiliarT;
                                   End If;  
                                   P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                                     
                                End If;   
                              Else
--                                V_NOTASCOMERRO := V_NOTASCOMERRO || ',' || ListaNotas.cnNOTA;
                                tpLogGeracaO.Con_Loggeracao_Obsgeracaohtml := 'Nao PASSOU PELA CRITICA DE HORARIO DE CORTE.' || chr(10) || 
                                                                    'Tipo de CARGA selecionado ' || tpJanela.Fcf_Tpcarga_Codigo || chr(10) ||
                                                                    'VERIFIQUE ARMAZEM-CARREGAMENTO-USUARIO QUE ESTA IMPEDINDO ' || vAuxiliarT;
                                P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                             End If;
--                           End If;
                        exception
                          WHEN DUP_VAL_ON_INDEX  THEN 
                            update TDVADM.T_Arm_Carregamemcalc c
                               set c.arm_carregamemcalc_contaador = c.arm_carregamemcalc_contaador + 1
                            WHERE C.ARM_CARREGAMEMCALC_MEMOCALC = P_ARM_CARREGAMENTO
                              AND C.ARM_ARMAZEM_CODIGO = P_ARM_ARMAZEM          
                              and TRIM(C.FCF_TPCARGA_CODIGO)             = ListaCargaCli.ccTPCARGACLI 
                              AND C.ARM_CARREGAMEMCALC_ENTCOL      = tpJanela.ARM_CARREGAMEMCALC_ENTCOL 
                              AND C.ARM_CARREGAMEMCALC_ORIGEMNOTA  = tpJanela.ARM_CARREGAMEMCALC_ORIGEMNOTA
                              AND C.ARM_CARREGAMEMCALC_DESTINONOTA = tpJanela.ARM_CARREGAMEMCALC_DESTINONOTA                               ;
 
                          When OTHERS Then
                              tpLogGeracaO.Con_Loggeracao_Obsgeracaohtml := 'CRITICA DE HORARIO DE CORTE ' || chr(10) || sqlerrm;
                              P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                              tpLogGeracaO.Con_Loggeracao_Obsgeracaohtml := '2CRITICA DE HORARIO DE CORTE ' || chr(10) || sqlerrm;
                              P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                             tpJanela.Arm_Carregamemcalc_Crioucarreg := P_USU_USUARIOCRIA;
                          End; 
                          -- Fim da Janela de Corte  
                          
                          BEGIN
                                    select CALC.*
                                       into tpJanela
                                    from TDVADM.T_Arm_Carregamemcalc calc
                                    where CALC.Arm_Carregamemcalc_Memocalc = P_ARM_CARREGAMENTO
                                       AND TRIM(calc.FCF_TPCARGA_CODIGO)     = trim(tpJanela.Fcf_Tpcarga_Codigo) 
                                       AND  trim(calc.Arm_Carregamemcalc_Tptabsol) =  trim(tpJanela.Arm_Carregamemcalc_Tptabsol)
--                                       AND  trim(calc.Arm_Carregamemcalc_Tabsolcod) =  trim(tpJanela.Arm_Carregamemcalc_Tabsolcod)
--                                       AND  trim(calc.Arm_Carregamemcalc_Tabsolsq)  =  trim(tpJanela.Arm_Carregamemcalc_Tabsolsq)
                                       AND  trim(calc.Arm_Carregamemcalc_Clisac) =  trim(tpJanela.Arm_Carregamemcalc_Clisac)
                                       AND  trim(calc.Arm_Carregamemcalc_Cnpjrem) =  trim(tpJanela.Arm_Carregamemcalc_Cnpjrem)
                                       AND  trim(calc.Arm_Carregamemcalc_Cliendrem) =  trim(tpJanela.Arm_Carregamemcalc_Cliendrem)
                                       AND  trim(calc.Arm_Carregamemcalc_Cnpjdes) =  trim(tpJanela.Arm_Carregamemcalc_Cnpjdes)
                                       AND  trim(calc.Arm_Carregamemcalc_Clienddes) =  trim(tpJanela.Arm_Carregamemcalc_Clienddes)
                                       AND  trim(calc.Arm_Carregamemcalc_Origemnota) =  trim(tpJanela.Arm_Carregamemcalc_Origemnota)
                                       AND  trim(calc.Arm_Carregamemcalc_Destinonota) =  trim(tpJanela.Arm_Carregamemcalc_Destinonota)
                                       AND  trim(calc.Arm_Carregamemcalc_Entcol) =  trim(tpJanela.Arm_Carregamemcalc_Entcol);
                          Exception
                            When OThers Then
                                tpJanela.Arm_Carregamemcalc_Memocalc := P_ARM_CARREGAMENTO;
                                tpJanela.Arm_Carregamemcalc_Seqagrup := 0;
                            End ;                             
                          update TDVADM.T_arm_nota an
                            set an.arm_carregamemcalc_memocalc = tpJanela.Arm_Carregamemcalc_Memocalc,
                                an.arm_carregamemcalc_seqagrup = tpJanela.Arm_Carregamemcalc_Seqagrup
                          where an.arm_nota_sequencia = ListaNotas.cnSequencia; 
                          
                       Exception 
                          When Others Then
                            v_classificaerro       := trim(v_classificaerro) ||
                                                     ';MONTAFORMULA' || Sqlerrm;
                            vError := dbms_utility.format_error_backtrace;
                            tpLogGeracaO.Con_Loggeracao_ErroHTML := 'CTRC COM ERRO NAS VERBAS SP_MONTA_FORMULA_CNHC1 (' ||V_TPCALCULO || '-' || vDescCalculo || ' - ' || V_CTRCCODIGO || ' - ' || ListaNotas.cnROTA ||' ) '|| chr(13) ||
                                                               'CTe          : ' || V_CTRCCODIGO || '-' || ListaNotas.cnROTA || chr(13) ||
                                                               'Peso cobrado : ' || V_SOMAPESOCOBRADO || chr(13) ||
                                                               'Peso Lotac?o : '||v_vlrlotacao || chr(13) ||
                                                               'TABELA       : ' || ListaNotas.cnTABSOLCOD || '-' || ListaNotas.cnTABSOLSQ || chr(13) ||
                                                               'erro         : ' || vError;
                           P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                       End;                       
                      
                      END IF;

                      BEGIN
                        SELECT nvl(CA.CON_CALCVIAGEM_VALOR,0)
                          INTO vAuxiliarnumerico
                          FROM TDVADM.T_CON_CALCCONHECIMENTO CA
                         WHERE CA.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                           AND CA.CON_CONHECIMENTO_SERIE = 'XXX'
                           AND CA.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                           AND CA.SLF_RECCUST_CODIGO = 'I_TTPV';
                         If vAuxiliarnumerico = 0 Then

                            UPDATE TDVADM.T_CON_CALCCONHECIMENTO C
                              SET C.CON_CONHECIMENTO_ALTALTMAN = NULL
                            WHERE C.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                              AND C.CON_CONHECIMENTO_SERIE = 'XXX'
                              AND C.GLB_ROTA_CODIGO = ListaNotas.cnROTA;
                            COMMIT;
                            TDVADM.PKG_SLF_CALCULOS.SP_MONTA_FORMULA_CNHC(V_TPCALCULO,
                                                                          V_CTRCCODIGO,
                                                                          'XXX',
                                                                          ListaNotas.cnROTA);

                            SELECT nvl(CA.CON_CALCVIAGEM_VALOR,0)
                              INTO vAuxiliarnumerico
                              FROM TDVADM.T_CON_CALCCONHECIMENTO CA
                             WHERE CA.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                               AND CA.CON_CONHECIMENTO_SERIE = 'XXX'
                               AND CA.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                               AND CA.SLF_RECCUST_CODIGO = 'I_TTPV';
                         End If;
                      EXCEPTION
                        WHEN NO_DATA_FOUND THEN
                          vAuxiliarnumerico := 0;
                      END;
                      
                      If ( ListaCargaCli.ccLimiteCTe > 0 ) and (  vTipoDocumento = cCTeCTRC  )  Then
                          if vAuxiliarnumerico > ListaCargaCli.ccLimiteCTe Then
                             vErroFatal := 'E';
                             tpLogGeracaO.Con_Loggeracao_ErroHTML := 'F-VALOR DO CTe SUPERA O LIMITE PERMITIDO ' || chr(13) ||
                                                                     'LIMITE  ' ||  f_mascara_valor(ListaCargaCli.ccLimiteCTe,20,2) || chr(13) ||
                                                                     'VLR CTe ' ||  f_mascara_valor(vAuxiliarnumerico,20,2) ;
                                                                 
                             P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                          End If;
                      ElsIf ( ListaCargaCli.ccLimiteNFSe > 0 ) and (  vTipoDocumento = cNFServico  )  Then
                          if vAuxiliarnumerico > ListaCargaCli.ccLimiteNFSe Then
                             vErroFatal := 'E';
                             tpLogGeracaO.Con_Loggeracao_ErroHTML := 'F-VALOR DA NFSe SUPERA O LIMITE PERMITIDO ' || chr(13) ||
                                                                     'LIMITE   ' ||  f_mascara_valor(ListaCargaCli.ccLimiteNFSe,20,2) || chr(13) ||
                                                                     'VLR NFSe ' ||  f_mascara_valor(vAuxiliarnumerico,20,2) ;
                                                                 
                             P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                          End If;
                      End IF;
                     
                    
                      IF nvl(vAuxiliarnumerico,0) <= 0 THEN
                         begin
                           SELECT to_char(CA.CON_CALCVIAGEM_VALOR)  || '-' || ca.con_calcviagem_desinencia
                             INTO vAuxiliarT1
                             FROM TDVADM.T_CON_CALCCONHECIMENTO CA
                            WHERE CA.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                              AND CA.CON_CONHECIMENTO_SERIE = 'XXX'
                              AND CA.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                             AND CA.SLF_RECCUST_CODIGO = 'D_FRPSVO';
                          exception
                            WHEN OTHERS Then
                              vAuxiliarT1 := 'D_FRPSVO Nao Encontrado';
                            End ;    

                          Begin
                            SELECT to_char(CA.CON_CALCVIAGEM_VALOR)  || '-' || ca.con_calcviagem_desinencia
                              INTO vAuxiliarT2
                              FROM TDVADM.T_CON_CALCCONHECIMENTO CA
                             WHERE CA.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                               AND CA.CON_CONHECIMENTO_SERIE = 'XXX'
                               AND CA.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                               AND CA.SLF_RECCUST_CODIGO = 'I_PSCOBRAD';
                          exception
                            WHEN OTHERS Then
                              vAuxiliarT2 := 'I_PSCOBRAD Nao Encontrado';
                            End ;    
                          Begin
                            SELECT to_char(CA.CON_CALCVIAGEM_VALOR)  || '-' || ca.con_calcviagem_desinencia
                              INTO vAuxiliarT3
                              FROM TDVADM.T_CON_CALCCONHECIMENTO CA
                             WHERE CA.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                               AND CA.CON_CONHECIMENTO_SERIE = 'XXX'
                               AND CA.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                               AND CA.SLF_RECCUST_CODIGO in ('S_ALICMS','S_ALISS');
                          exception
                            WHEN OTHERS Then
                              vAuxiliarT3 := 'S_ALICMS/S_ALISS Nao Encontrado';
                            End ;    

                         tpLogGeracaO.Con_Loggeracao_ErroHTML := 'CTRC COM VALOR ZERADO --- ' || chr(10) ||
                                                             'ORIGEM -' || ListaNotas.cnORIGEM || chr(10) ||
                                                             'DESTINO -' || ListaNotas.cnDESTINO || chr(10) ||
                                                             'TIPO FRETE-' || V_CIFFOB || chr(10) ||
                                                             'FRETE ' || vAuxiliarT1 || chr(10) ||
                                                             'PESO COB ' || vAuxiliarT2 || chr(10) ||
                                                             'ALIQUOTA ' || vAuxiliarT3 || chr(10) ||
                                                             'TPCALCULO-' || vDescCalculo || chr(10) ||
                                                             'TPCARGA-' || ListaCargaCli.ccTPCARGACLI || chr(10) ||
                                                             'SACADOBUSCA-' || V_SACADOCARGA || chr(10) ||
                                                             'GRUPOBUSCA-' ||  V_GRUPOCARGAS || chr(10) ||
                                                             'TPVEICULO-' || TDVADM.PKG_FIFO_CARREGCTRC.FN_BUSCA_TPCARGAVEICULO(V_GRUPOCARGAS,
                                                                                                     V_CONTRATOCARGAS,
                                                                                                     V_SACADOCARGA,
                                                                                                     ListaNotas.CnPESOCOBRADO,
                                                                                                     V_CIFFOB,
                                                                                                     ListaNotas.cnTIPOTRANSP,
                                                                                                     ListaCargaCli.ccTPCARGACLI,
                                                                                                     ListaCargaCli.ccPESQVEICULO,
                                                                                                     'TV') ||  chr(10) ||
                                                             'KM-' || ListaVaux.cnKM || chr(10) ||
                                                             'PESOCOB-' || ListaNotas.CnPESOCOBRADO || chr(10) ||
                                                             'rowid -' || vRetBuscaFrete.VROWID || chr(10) ||
                                                             'Formula Frete TX  - ' || ListaCargaCli.ccFORMULAFRTX || chr(10) ||
                                                             'Formula Frete VL  - ' || ListaCargaCli.ccFORMULAFRVL || chr(10) ||
                                                             'Formula Frete KM  - ' || ListaCargaCli.ccFORMULAFRKM || chr(10) ||
                                                             'Formula traduzida - ' || vFormulaTraduzidaF || chr(10) ||
                                                             'Formula Pedag TX  - ' || ListaCargaCli.ccFORMULAPDTX || chr(10) ||
                                                             'Formula Pedag VL  - ' || ListaCargaCli.ccFORMULAPDVL || chr(10) ||
                                                             'Formula traduzida - ' || vFormulaTraduzidaP || chr(10);
                         P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                         v_classificaerro       := trim(v_classificaerro) || ';VZ';
                      
                      END IF;
                    

                      IF ListaNotas.cnNOTADI IS NOT NULL Then
                        V_MSGOBS := V_MSGOBS || ' - D.I. - ' || ListaNotas.cnNOTADI || ' - ' ;
              
                        
                        --Caso tenha uma DI, verifico se tem uma nota referenciada.
                        Begin
                          Select 
                            w.arm_nota_numero,
                            w.arm_nota_serie
                          Into
                            vNotaMae_Numero,
                            vNotaMae_Serie  
                          From 
                            TDVADM.T_arm_notavide w
                           Where
                             lpad(w.arm_notavide_numero, 9, '0') = lpad(ListaNotas.cnNOTA, 9, '0')
                             And Trim(w.glb_cliente_cgccpfremetente) = Trim(ListaNotas.cnCLIREM);
                        
                        Exception
                          --Caso ocorra algum erro, para Nao atrapalhar o fechamento do carregamento,
                          --simplesmente limpo a variavel.
                          When Others Then
                            vNotaMae_Numero := 0;
                        End;    
                        
                        --Caso a variavel tenha algum valor, printo o valor no campo de Observac?o do CTRC
                        If nvl(vNotaMae_Numero, 0) <> 0 Then
                          V_MSGOBS := V_MSGOBS || ' - Nr. Nota M?e: ' || To_char(vNotaMae_Numero) || '-';
                        End If;
                          
                         
                      END IF;
                      
                      IF V_PESOBALTOTAL > 0 THEN
                         V_OBS_PESAGEM := 'PBT: ' || F_MASCARA_VALOR(V_PESOBALTOTAL,10,0);
                      ELSE
                         V_OBS_PESAGEM := '';
                      END IF;
                      
                      IF LENGTH(TRIM(ListaNotas.cnCODCLIDEST)) > 0 THEN
                         ListaNotas.cnCODCLIDEST := 'OI - ' || TRIM(ListaNotas.cnCODCLIDEST) || ' - ';
                      ELSE
                         ListaNotas.cnCODCLIDEST := '';
                      END IF;     
                      
                      
                      V_MSGOBS2 := null;
                      Begin
                         
                         tpLogGeracaO.Con_Loggeracao_Obsgeracaohtml := 'Veiculo da V_CODIGOVEICULO ' || V_CODIGOVEICULO || chr(10) ||  
                                                                       'Veiculo do Busca Frete ' || vRetBuscaFrete.FCF_TPVEICULO_CODIGO;
                         P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;


 
                     select count(*)
                       into vAuxiliar
                     from TDVADM.T_arm_nota an,
                          TDVADM.T_arm_coleta co
                     where an.con_conhecimento_codigo =  V_CTRCCODIGO
                       and an.glb_rota_codigo = ListaNotas.cnROTA
                       and an.con_conhecimento_serie = 'XXX'
                       and an.arm_coleta_ncompra = co.arm_coleta_ncompra
                       and an.arm_coleta_ciclo = co.arm_coleta_ciclo
                       and co.arm_coleta_valor > 0;

                      ListaVerbas('S_QTDECOL').AsFloat      := vAuxiliar;
                      ListaVerbas('S_QTDECOL').Value        := trim(to_char(vAuxiliar));
                      ListaVerbas('S_QTDECOL').AsDesinencia := 'VL';
                            
                              
                              UPDATE tdvadm.t_con_calcconhecimento ca
                                SET CA.CON_CALCVIAGEM_VALOR = vAuxiliar
                              WHERE CA.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                AND CA.CON_CONHECIMENTO_SERIE = 'XXX'
                                AND CA.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                AND CA.SLF_RECCUST_CODIGO = 'S_QTDECOL';
                             
                         ListaNotas.cnConhecimento := V_CTRCCODIGO;
                         ListaNotas.cnRotaConhec := ListaNotas.cnROTA;

                         V_MSGOBS2 := fn_RetornaObservacao(ListaNotas,
                                                           ListaCargaCli,
                                                           vRetBuscaFrete, 
                                                           V_CODIGOVEICULO);

                        if trim(ListaCargaCli.ccTPCARGACLI) = '25' Then  -- COMPLEMENTO   
                           V_MSGOBS2 := 'COMPLEMENTO DO CTRC - ' || tpNotaCte.Con_Conhecimento_Codigoa || ' SERIE ' || tpNotaCte.Glb_Rota_Codigoa;
                        Elsif trim(ListaCargaCli.ccTPCARGACLI) = '26' Then  -- REMOCAO
                           V_MSGOBS2 := V_MSGOBS2;
                        End If;

                         if V_MSGOBS2 is not null Then
                            vAuxiliarMemo := '';
                            V_MSGOBS := '';
                         Else   

                            IF nvl(ListaQuebras.CONTRATO,'X') = 'X' Then
                               vAuxiliarMemo := substr('CODCLI-' || trim(trim(ListaNotas.cnCODCLIDEST) || '-' ||
                                                       trim(V_OBS_PESAGEM)||'-'|| 
                                                       trim(ListaNotas.cnEMBALAGEM1) ),1,1900);
                            Else
                               vAuxiliarMemo := substr('CONTRATO-' || replace(ListaQuebras.CONTRATO,'/','-') || '-CODCLI-' || trim(trim(ListaNotas.cnCODCLIDEST) || '-' ||
                                                       trim(V_OBS_PESAGEM)||'-'|| 
                                                       trim(ListaNotas.cnEMBALAGEM1) ),1,1900);
                            End If;                        

                            V_MSGOBS2 := substr(trim(V_MSGOBS2) || ' CALC - ' || trim(substr(ListaCargaCli.ccTPCARGACLIDESC,1,3)) || ' - ' || trim(ListaNotas.cnTIPOCARGA) || ' - KM-' || ListaVaux.cnKM || ' PESO REAL - <<D_PSREAL>> - PESO COBRADO - <<I_PSCOBRAD>> ' ,1,400); 

                            if ListaNotas.cnNOTARI is not null Then  
                               V_MSGOBS2 := substr(trim(V_MSGOBS2) || ' - RI-NOTA- ' || ListaNotas.cnNOTARI || '-',1,400);
                            End If;   
                            --Adiciono o numero da Nota Fiscal.
                            V_MSGOBS := V_MSGOBS || ListaNotas.cnNOTA || ' '; -- V_LISTANOTASCTRC  ;
 
                            if nvl(V_PESOEXCEDENTE,0) > 0 then  
                               V_MSGOBS := V_MSGOBS  || ' PESO TOTAL - <<I_PSCOBRAD>>  Cobrado Excedente de ' ||  to_char(V_PESOEXCEDENTE) || '-';
--                            ElsIf  ListaNotas.cnPESO < ListaCargaCli.ccPESOMINIMO Then
--                               V_MSGOBS := V_MSGOBS  || ' Cobrado Peso Minimo de - ' || to_char(ListaCargaCli.ccPESOMINIMO) || '-';
                            End If;
                      
                            if ListaNotas.cnASN is NOT null then
                              V_MSGOBS := V_MSGOBS  || ' ASN - ' || ListaNotas.cnASN ;
                            end if;
                      
                  
                            if ListaNotas.cnPO is NOT null then
                              V_MSGOBS := V_MSGOBS  || ' PO/CC - ' || ListaNotas.cnPO ;
                            end if;
                    
                            if ListaNotas.cnNRCOLETA is not null then
                              V_MSGOBS := V_MSGOBS || ' COLETA NR ' || ListaNotas.cnNrColetaCiclo ||'.'|| ListaNotas.cnNRCOLETA;
                            END IF;
                              
                            if ListaNotas.cnGRUPOECSAC <> '0074' Then
                               V_MSGOBS := V_MSGOBS || ' CARREG-' || P_ARM_CARREGAMENTO ;
                            Else
                               V_MSGOBS := V_MSGOBS || 'MEMORIA CALCULO : [' || P_ARM_CARREGAMENTO || ']';
                            End If;

                      
                            if ( ( V_PESOCOBRADOFAIXA <> ListaNotas.CnPESOCOBRADO ) And NVL(ListaNotas.cnTABSOL,'X') = 'X') then
                               V_MSGOBS := V_MSGOBS || ' FAIXA DE PESO COBRADO- ' || TO_CHAR(V_PESOCOBRADOFAIXA) || ' ' ;
                            end if;

                         -- sirlano 2
                            IF V_PRIORIDADE = 4 THEN-- Normal
                               V_MSGOBS := trim(V_MSGOBS);
                            ELSIF V_PRIORIDADE = 3 THEN -- Prioritaria,
                               V_MSGOBS := trim(V_MSGOBS) || ' - Col PRIORITARIA ';
                            ELSIF V_PRIORIDADE = 2 THEN -- Expressa,
                               V_MSGOBS := trim(V_MSGOBS) || ' - Col EXPRESSA ';
                            ELSIF V_PRIORIDADE = 1 THEN -- Urgente
                               V_MSGOBS := trim(V_MSGOBS) || ' - Col URGENTE ';
                            ELSIF V_PRIORIDADE = 0 THEN -- Urgente
                               V_MSGOBS := trim(V_MSGOBS) || ' - Col URGENTE ';
                            ELSE
                              V_MSGOBS := trim(V_MSGOBS);
                            END IF;

                            If nvl(v_FormularioEX,CargaExpressaSemFormulario) <> CargaExpressaSemFormulario Then
                               V_MSGOBS := trim(V_MSGOBS) || ' - For EXPRESSO nr. ' || trim(v_FormularioEX);
                            Elsif nvl(v_FormularioSP,CargaSpotSemFormulario) <> CargaSpotSemFormulario Then
                               V_MSGOBS := trim(V_MSGOBS) || ' - For SPOT nr. ' || trim(v_FormularioSP);
                            Elsif nvl(v_FormularioAH,CargaAHFormulario) <> CargaAHFormulario Then
                               V_MSGOBS := trim(V_MSGOBS) || ' - For AD HOC nr. ' || trim(v_FormularioAH);
                            End If;   

                            If nvl(v_FORMULARIOCLI,ProdutoQuimicoSemFormulario) not in (ProdutoQuimicoSemFormulario,'999999') Then
                               V_MSGOBS := trim(V_MSGOBS) || ' - For PQ nr. ' || trim(v_FORMULARIOCLI);
                            End If;   
                        
                         End If;

                         If ListaNotas.cnContrato in ('C2017070112') Then -- LOT-NESTLE-0319-IMPORTAO&EXPORTAO 
                            If V_CODIGOVEICULO =  TpCarretaLS Then
                               V_MSGOBS := trim(V_MSGOBS) || ' Outros refere-se ao adicional de 6 eixos (LS) ';
                            End If;
                         End If;
                         
                        vMilkRun := tdvadm.fn_cte_getpropred(tpConConhecimento.con_conhecimento_codigo,
                                                     tpConConhecimento.con_conhecimento_serie,
                                                     tpConConhecimento.glb_rota_codigo);

                         IF v_ObsTABSOLImp = 'S' THEN
                           IF substr(vMilkRun,1,8) <> 'MILK RUN' THEN
                            V_MSGOBS := trim(V_MSGOBS) || ' ' || TRIM(v_ObsTABSOL);
                           ELSE
                             V_MSGOBS := TRIM(v_ObsTABSOL) || ' ' || trim(V_MSGOBS);
                           END IF;
                         END IF;


                         tpConConhecimento.Con_Conhecimento_Obs := substr(trim(vAuxiliarMemo) || '-' || 
                                                                   trim(substr(V_MSGOBS2, 1, 1500)) || '-' ||
                                                                   trim(substr(V_MSGOBS, 1, 1500)), 1,1900);
      
                        If instr(tpConConhecimento.Con_Conhecimento_Obs,'<<') > 0 Then
                           ListaVerbas := fn_CarregaVerbas(tpConConhecimento.Con_Conhecimento_Codigo,
                                                           tpConConhecimento.Con_Conhecimento_Serie,
                                                           tpConConhecimento.Glb_Rota_Codigo);
                            
                           tpConConhecimento.Con_Conhecimento_Obs := fn_MudaObservacao(tpConConhecimento.Con_Conhecimento_Obs,
                                                                                       ListaVerbas);
                        End If;

                        UPDATE TDVADM.T_CON_CONHECIMENTO C
                           SET C.CON_CONHECIMENTO_OBS = tpConConhecimento.Con_Conhecimento_Obs
                         WHERE C.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                           AND C.CON_CONHECIMENTO_SERIE = 'XXX'
                           AND C.GLB_ROTA_CODIGO = ListaNotas.cnROTA;
                        commit;
       
                        
                     Exception
                       when others then
                         tpLogGeracaO.Con_Loggeracao_ErroHTML := 'ERRO NA ATULIZAC?O DA OBS DO CTE -> ' || sqlerrm; 
                         P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                     end; 




/*                       SELECT DECODE(ListaCargaCli.ccTPCARGACLI,'01 ','LOTACAO',
                                                  '02 ','FRACIONADO',
                                                  '03 ','EXPRESSA',
                                                  '04 ','PRODUTO QUIMICO',
                                                  '05 ','SPOT',
                                                  '06 ','REPARO',
                                                        'NAO ENCONTRADO')
                           INTO V_MESSAGE
                       FROM DUAL;        
*/                       V_MESSAGE := trim(ListaCargaCli.ccTPCARGACLIDESC); 

                       tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'CTRC EMITIDO USANDO TIPO DE CARGA ' || ListaCargaCli.ccTPCARGACLI || '-' ||
                                                                 V_MESSAGE || ';' || V_CODCLIENTE; 
                       vAuxiliarchar := fn_InsereLogGeracao;
                    END IF;
                  
                    if vTipoDocumento = 'E' Then
                      Begin
                       sp_con_validacte(V_CTRCCODIGO,'XXX',ListaNotas.cnROTA,vErro,vMessage);
                      Exception
                        When Others Then
                          vErro := 'E';
                          vMessage := 'Erro ao executar SP_CON_VALIDACTE ' || chr(13) || 'Erro ora: ' || Sqlerrm;
                      End; 

                       If Trim(vErro) = 'E' THEN
                          tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Checando conhecimento eletronico. Verifique ' || chr(13) || vMessage; 
                          P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                       End If;                        
                            
                    End if;  

                 end IF; 
--             END IF; -- V_CONTADORDENOTAS    
                    

                    IF  ( P_RETORNOPROCESSAMENTO = 'E' ) or ( instr(V_NOTASCOMERRO,ListaNotas.cnNOTA) > 0 ) Then
                      
                      TplogGeracao.Con_Conhecimento_Codigo := null;
                      TplogGeracao.Con_Conhecimento_Serie := null;
                      TplogGeracao.Glb_Rota_Codigo := null;

                      sp_limpa_conhec(V_CTRCCODIGO, ListaNotas.cnROTA);
                      ListaNotas.cnConhecimento := null;
                      ListaNotas.cnRotaConhec   := null;

                      V_CONTADORDENOTAS := 0;
                      V_CTRCCODIGO := null; 


                      tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := substr(v_classificaerro,1,1999);
                      tpLogGeracaO.Con_Loggeracao_ErroHTML := substr('CTRC EX ER NO PROC DAS VERBAS - CALCULO ' ||
                                                                 V_TPCALCULO || '-' || vDescCalculo  || 'CTRC-' || V_CTRCCODIGO || '-' || chr(13) || 
                                                                 trim(V_MENSAGEM) || chr(13) ||
                                                                 'ORIGEM -' || ListaNotas.cnORIGEM || '-DESTINO -' ||
                                                                 ListaNotas.cnDESTINO || '-TIPO FRETE-' || V_CIFFOB || '-TPCALCULO-' || vDescCalculo ||
                                                                 ' TABELA - ' || ListaNotas.cnTABSOLCOD || '-' || ListaNotas.cnTABSOLSQ ||
                                                                 '-TPCARGA-' || ListaCargaCli.ccTPCARGACLIDESC || '-TPVEICULO-' ||
                                                                 V_TIPOVEICULO || '-KM-' || ListaVaux.cnKM ||
                                                                 '-PESOCOB-' || ListaNotas.CnPESOCOBRADO ||
                                                                 '-SACADOBUSCA-' || V_SACADOCARGA ||
                                                                 '-GRUPOBUSCA-' || V_GRUPOCARGAS,1,1999); 
                      P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                      tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Limpei os CTRC deu erro acima' ;

                      P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
                      if ( trim(ListaCargaCli.ccTPCARGACLI) IN ('13','14','25','26') ) Then
                         exit;
                      End If;
                    eLSE
                       IF V_CTRCCODIGO IS NOT NULL THEN
                         /*
                           Incluido o Controle de RATEIO.
                           Este tipo de exclusao de nota e so para cargas que no temos RATEIO.
                           Sirlano
                           04/05/2020
                         */
                         IF ( 
                              ( trim(ListaCargaCli.ccTPCARGACLI) IN ('03', '04') ) or 
                              ( instr(cCargaExpressa,TDVADM.PKG_glb_common.Fn_QuotedStr(ListaNotas.cnTIPOCARGA)) > 0 )
                            ) and 
                            ( ListaCargaCli.ccRATEIA = 'N' ) THEN
                             IF LENGTH(NVL(V_NOTASPROCESSADAS,'')) > 1 THEN
                                ListaSQL.NOTASWHERE := ListaSQL.NOTASWHERE || '      AND N.ARM_NOTA_NUMERO NOT IN (' || TRIM(SUBSTR(V_NOTASPROCESSADAS, 2)) || ')'; 
                             ELSE   
                                V_NOTASPROCESSADAS := V_NOTASPROCESSADAS || ',' || ListaNotas.cnNOTA;
                             END IF;
                         END IF;
                         TplogGeracao.Con_Conhecimento_Codigo := null;
                         TplogGeracao.Con_Conhecimento_Serie := null;
                         TplogGeracao.Glb_Rota_Codigo := null;
                       END IF; 
                    END IF;
                  END IF;
--                   V_CTRCCODIGO := null;  
                  End If; -- Se Nao existir CTE
                  If vErroFatal = 'E' Then
                     exit;
                  End If;   
                END loop; -- Loop do cNOTAS
              END IF;
              tpLogGeracao.Arm_Nota_Numero := null;
              tpLogGeracao.Glb_Cliente_Cgccpfremetente := null;  
              TplogGeracao.Con_Conhecimento_Codigo := null;
              TplogGeracao.Con_Conhecimento_Serie := null;
              TplogGeracao.Glb_Rota_Codigo := null;
-- sirlano 21/02
                 if P_RETORNOPROCESSAMENTO = 'E' Then
                   V_CONTADORDENOTAS := 0;
                   if ( trim(ListaCargaCli.ccTPCARGACLI) in ('13','14','25','26'))  and  
                       ( ( V_CTRCCODIGO is not null )  )  Then
                      exit;
                   End If; 
                 End If;  
                 P_RETORNOPROCESSAMENTO := 'N';
                 If vQtdeNotasCteEmitido >= ListaQuebras.CONTAADOR Then
                    Exit;
                 End If;  
                 If vErroFatal = 'E' Then
                    exit;
                 End If;
              END LOOP; -- loop cCARGAS
              vQtdeNotasCteEmitido := 0;
              If vIdCarga = 0 THEN
                 tpLogGeracaO.Con_Loggeracao_ErroHTML := 'NAO ACHOU TIPO DE CARGAS PARA ESTAS NOTAS '; 
                 P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
              END IF;


              if V_CTRCCODIGO is not null Then
                          select sum(decode(trim(c.slf_reccust_codigo),'D_PSREAL',c.con_calcviagem_valor,0)) PesoReal,
                                 sum(decode(trim(c.slf_reccust_codigo),'I_PSCOBRAD',c.con_calcviagem_valor,0)) PesoCobrado,
                                 count(*) Qtde
                             into vAuxiliarnumerico,
                                  vAuxiliarnumerico2,
                                  vAuxiliarnumerico3
                          from TDVADM.T_con_calcconhecimento c
                          where c.con_conhecimento_codigo =  V_CTRCCODIGO
                            and c.glb_rota_codigo = ListaNotas.cnROTA
                            and c.con_conhecimento_serie = 'XXX'
                            and trim(c.slf_reccust_codigo) in ('D_PSREAL','I_PSCOBRAD');
                       
                        If vAuxiliarnumerico3 > 1 Then
                           Update TDVADM.T_con_calcconhecimento c
                             set c.con_calcviagem_valor = decode(trim(c.slf_reccust_codigo),'D_PSREAL',vAuxiliarnumerico,vAuxiliarnumerico2)
                          where c.con_conhecimento_codigo =  V_CTRCCODIGO
                            and c.glb_rota_codigo = ListaNotas.cnROTA
                            and c.con_conhecimento_serie = 'XXX'
                            and trim(c.slf_reccust_codigo) in ('D_PSREAL','I_PSCOBRAD');
                        End If;

                 If instr(tpConConhecimento.Con_Conhecimento_Obs,'<<') > 0 Then
                     ListaVerbas := fn_CarregaVerbas(tpConConhecimento.Con_Conhecimento_Codigo,
                                                     tpConConhecimento.Con_Conhecimento_Serie,
                                                     tpConConhecimento.Glb_Rota_Codigo);
                     
                     select count(*)
                       into vAuxiliar
                     from TDVADM.T_arm_nota an,
                          TDVADM.T_arm_coleta co
                     where an.con_conhecimento_codigo =  V_CTRCCODIGO
                       and an.glb_rota_codigo = ListaNotas.cnROTA
                       and an.con_conhecimento_serie = 'XXX'
                       and an.arm_coleta_ncompra = co.arm_coleta_ncompra
                       and an.arm_coleta_ciclo = co.arm_coleta_ciclo
                       and co.arm_coleta_valor > 0;

                      ListaVerbas('S_QTDECOL').AsFloat      := vAuxiliar;
                      ListaVerbas('S_QTDECOL').Value        := trim(to_char(vAuxiliar));
                      ListaVerbas('S_QTDECOL').AsDesinencia := 'VL';
                            
                              
                              UPDATE tdvadm.t_con_calcconhecimento ca
                                SET CA.CON_CALCVIAGEM_VALOR = vAuxiliar
                              WHERE CA.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                                AND CA.CON_CONHECIMENTO_SERIE = 'XXX'
                                AND CA.GLB_ROTA_CODIGO = ListaNotas.cnROTA
                                AND CA.SLF_RECCUST_CODIGO = 'S_QTDECOL';

                     tpConConhecimento.Con_Conhecimento_Obs := fn_MudaObservacao(tpConConhecimento.Con_Conhecimento_Obs,
                                                                                 ListaVerbas);
                                                                                      
                     UPDATE TDVADM.T_CON_CONHECIMENTO C
                        SET C.CON_CONHECIMENTO_OBS = tpConConhecimento.Con_Conhecimento_Obs
                      WHERE C.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                        AND C.CON_CONHECIMENTO_SERIE = 'XXX'
                        AND C.GLB_ROTA_CODIGO = ListaNotas.cnROTA;
                     commit;
                 End If;
                        
              end If;
         


           
           if cNOTAS%isopen then
              CLOSE cNOTAS;
           End If;   

            tpLogGeracao.Arm_Nota_Numero             := null;
            tpLogGeracao.Glb_Cliente_Cgccpfremetente := null;            
            tpLogGeracao.Con_Conhecimento_Codigo     := null;
            tpLogGeracao.Con_Conhecimento_Serie      := null;
            tpLogGeracao.Glb_Rota_Codigo             := null;

          end if; 

--          if P_ARM_CARREGAMENTO in ('563339','563511') Then

            select count(*)
              into vAuxiliarnumerico
            from TDVADM.T_arm_carregamentodet d,
                 TDVADM.T_arm_nota n
            where 0 = 0
              and d.arm_carregamento_codigo = P_ARM_CARREGAMENTO     
              and d.arm_embalagem_numero    = n.arm_embalagem_numero
              and d.arm_embalagem_flag      = n.arm_embalagem_flag
              and d.arm_embalagem_sequencia = n.arm_embalagem_sequencia
              and n.con_conhecimento_codigo is null;

/*              select count(*)
                into vAuxiliarnumerico
              from TDVADM.T_con_conhecimento c,
                   TDVADM.T_con_nftransporta nf
              where c.arm_carregamento_codigo = P_ARM_CARREGAMENTO
                and c.con_conhecimento_codigo = nf.con_conhecimento_codigo
                and c.con_conhecimento_serie = nf.con_conhecimento_serie
                and c.glb_rota_codigo = nf.glb_rota_codigo;
*/
              if vAuxiliarnumerico = 0 Then
                 exit;
              End IF;  

--           End If;    

           If vErroFatal = 'E' Then
              exit;
           End If;
        END LOOP; -- loop cSACADO
--      END IF;
    
      -----------------------
      --- SE DEU ERRO NO SACADO OU NAO ACHOU OS TIPOS DE CARGAS LISTA AS NOTAS NO LOG
      --       IF (V_ACHOUSACADO = 'N') OR (V_ACHOUTPCARGA = 'N') THEN 
      -- MONTA WHERE PARA SELECIONAR AS NOTAS
      spi_SqlCliEnvolvidos(ListaQuebras);
      spi_SqlColetaEntrega(ListaQuebras.ORIGEMNOTA,ListaQuebras.DESTINONOTA,ListaCargaCli);
    
      ListaSQL.FINALNOTA := ListaSQL.NOTAS || 
                            ListaSQL.TABWHERE || 
                            ListaSQL.CTNOTAWHERESC || 
                            ListaSQL.NOTASWHERE || 
                            ListaSQL.NOTASORDER;
      -- LISTA AS NOTAS QUE Nao FORAM PROCESSADAS
      -- INICIA AS VARIAVEIS DE REMTENTE DESTINATARIO

      If trim(sys_context('CARREGAMENTO','CODCARREG')) = trim(P_ARM_CARREGAMENTO) Then
         vContextCount := vContextCount + 1; 
         Insert Into TDVADM.T_glb_sql ( glb_sql_instrucao, 
                                 glb_sql_dtgravacao, 
                                 glb_sql_programa) 
                        Values ( ListaSQL.FINALNOTA, 
                                 Sysdate, 
                                 lpad(vContextCount,3,'0') || '-' || P_ARM_CARREGAMENTO || '-Cursor=FinalNotas carregamento=' || P_ARM_CARREGAMENTO || 'TpCarga=' || ListaCargaCli.ccTPCARGACLI  || ' Retorna = ' || vTesteCarga.vRetorna  || ' Vez ' || to_char(tpLogGeracao.Con_Loggeracao_Codigo)); 
         Commit;
      End If;  

    if cSACADO%isopen Then
       CLOSE cSACADO;
    End If;  

    -- Ultima verificac?o se tem veiculo Virtual.
    select nvl(c.FCF_VEICULODISP_CODIGO,0)
      into vCodVeicVirtual
    from TDVADM.T_ARM_CARREGAMENTO c
    WHERE ARM_CARREGAMENTO_CODIGO = P_ARM_CARREGAMENTO;
     
    if vCodVeicVirtual = 0 Then
       tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Final da Rotina Perdeu o Veiculo Virtual, Tente Fechar Novamente';
       P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
    End If;

    
     
      --------------------------------------------------------------------------------------------------------------
    --Rogerio de Paula  - 08/05/2012
    --Nesse momento todos os CTRCs ja foram criados, o cursor esta fechado.
    -- Vou verificar se algum dos CTRCs criados esta com a Prestac?o zerada.
    --------------------------------------------------------------------------------------------------------------
    Begin
      Select 
        Count(*) Into  vControl  
      From 
        TDVADM.T_con_conhecimento  ctrc
      Where
        0=0
        And 0 < ( Select Count(*) From TDVADM.T_arm_carregamento carreg
                  Where carreg.arm_carregamento_codigo = ctrc.arm_carregamento_codigo
                  And carreg.arm_carregamento_codigo = P_ARM_CARREGAMENTO
                )    
        And 0 < ( Select Count(*) From TDVADM.T_con_calcconhecimento calc
                  Where calc.con_conhecimento_codigo = ctrc.con_conhecimento_codigo
                    And calc.con_conhecimento_serie = ctrc.con_conhecimento_serie
                    And calc.glb_rota_codigo = ctrc.glb_rota_codigo
                    And Trim(calc.slf_reccust_codigo) = 'I_TTPV'
                    And Nvl(CALC.CON_CALCVIAGEM_VALOR, 0) < decode(vRetBuscaFrete.vRetorno,'MA',0,0)
                );    
      
      --verifica se a contagem retornou mais de 0, significa que pelo menos um voltou com prestac?o zerada.
      If vControl > 0 Then
        --Insere informac?o na tabela de log. 
         tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Carregamento com ' || Trim(to_char(vControl)) || ' CTRC(s) com valor de prestac?o menor que R$ 1,00' ; 
         P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
      End If;
    Exception
      When Others Then
         tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Erro ao buscar por CTRCs com prestac?o zerada. '; 
         P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
    End;

    V_CONTADORNOTA := 0;
    ListaSQL.FINALNOTA := ListaSQL.CONTANOTA || 
                          ListaSQL.TABWHERE || 
                          ListaSQL.CTNOTAWHERESC;
    
    EXECUTE IMMEDIATE (TRIM(ListaSQL.FINALNOTA))
      INTO V_CONTADORNOTA;
      
      

    IF (V_CONTADORNOTA > 0)  Then
        ListaSQL.FINALNOTA := ListaSQL.NOTAS || 
                              ListaSQL.TABWHERE || 
                              ListaSQL.CTNOTAWHERESC;
                              
        IF (P_ARM_CARREGAMENTO = '692580') THEN
           insert into dropme (a,l) values ('5-Teste28/03',ListaSQL.FINALNOTA); commit;
        END IF;
        
         tpLogGeracaO.Con_Loggeracao_Obsgeracaohtml := 'SQL de verificacao de CTe Nao gerados ';
         tpLogGeracaO.Con_Loggeracao_Sql := ListaSQL.FINALNOTA;  
         P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
        
         commit;
        
        OPEN cNOTAS FOR ListaSQL.FINALNOTA;
          loop
            fetch cNOTAS
              into ListaNotas;
            Exit When cnotas%Notfound;
              
               If ListaNotas.cnNOTA = 3643 Then
                  ListaNotas.cnNOTA := 3643;
               End If;

               vDescOrigem.OrigemCodigo     := ListaNotas.cnORIGEM;
               vDescOrigem.OrigemDescricao  := tdvadm.fn_busca_codigoibge(ListaNotas.cnORIGEM,'LOD');
               vDescOrigem.DestinoCodigo    := ListaNotas.cnDESTINO;
               vDescOrigem.DestinoDescricao := tdvadm.fn_busca_codigoibge(ListaNotas.cnDESTINO,'LOD');

               vDescOrigem.ColLocCodigo     := ListaNotas.cnCOLETA;
               vDescOrigem.ColLocDescri     := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'LOD');
               vDescOrigem.ColIBGECodigo    := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'IBC');
               vDescOrigem.ColIBGEDescri    := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'IBD');
               vDescOrigem.ColCIDescri      := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'CI');
               vDescOrigem.ColCIDescri      := substr(vDescOrigem.ColCIDescri,1,2) || '-' || substr(vDescOrigem.ColCIDescri,3,1);
               vDescOrigem.ColMESOCodigo    := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'MEC');
               vDescOrigem.ColMESODescri    := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'MED');
               vDescOrigem.ColMICROCodigo   := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'MIC');
               vDescOrigem.ColMICRODescri   := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'MID');
               vDescOrigem.ColREGCodigo     := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'IBR');
               select decode(vDescOrigem.ColREGCodigo,1,'Norte',
                                                      2,'Nordeste',
                                                      3,'Sudeste',
                                                      4,'Sul',
                                                      5,'Centro Oeste')
                    into vDescOrigem.ColREGDescri
               From dual;
               vDescOrigem.ColREGVCodigo    := tdvadm.fn_busca_codigoibge(ListaNotas.cnCOLETA,'IBRV');

               select decode(vDescOrigem.ColREGVCodigo,1,'Norte',
                                                       2,'Norte',
                                                       3,'Sul',
                                                       4,'Sul',
                                                       5,'Sul')
                      into vDescOrigem.ColREGVDescri
                from dual;
               

               vDescOrigem.EntLocCodigo     := ListaNotas.cnENTREGA;
               vDescOrigem.EntLocDescri     := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'LOD');
               vDescOrigem.EntIBGECodigo    := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'IBC');
               vDescOrigem.EntIBGEDescri    := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'IBD');
               vDescOrigem.EntCIDescri      := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'CI');
               vDescOrigem.EntCIDescri      := substr(vDescOrigem.EntCIDescri,1,2) || '-' || substr(vDescOrigem.EntCIDescri,3,1);
               vDescOrigem.EntMESOCodigo    := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'MEC');
               vDescOrigem.EntMESODescri    := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'MED');
               vDescOrigem.EntMICROCodigo   := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'MIC');
               vDescOrigem.EntMICRODescri   := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'MID');
               vDescOrigem.EntREGCodigo     := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'IBR');
               select decode(vDescOrigem.EntREGCodigo,1,'Norte',
                                                      2,'Nordeste',
                                                      3,'Sudeste',
                                                      4,'Sul',
                                                      5,'Centro Oeste')
                     into vDescOrigem.EntREGDescri
               From dual;
               vDescOrigem.ColREGVCodigo    := tdvadm.fn_busca_codigoibge(ListaNotas.cnENTREGA,'IBRV');
               select decode(vDescOrigem.EntREGVCodigo,1,'Norte',
                                                       2,'Norte',
                                                       3,'Sul',
                                                       4,'Sul',
                                                       5,'Sul')
                     into vDescOrigem.ColREGVDescri
               From Dual;
               tpLogGeracaO.Con_Loggeracao_ErroHTML := fni_retcenario('NAO FORAM GERADOS TODOS OS CTRC, NOTAS COM PROBLEMAS'); 
               tpLogGeracao.Arm_Nota_Numero :=   ListaNotas.cnNOTA;
               tpLogGeracao.Glb_Cliente_Cgccpfremetente := trim(ListaNotas.cnCLIREM);
               P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
           End Loop; 
           
    Else
      If ( P_RETORNOPROCESSAMENTO = TDVADM.PKG_glb_common.Status_Nomal ) Then
         tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'CHEGUEI NO FINAL DA PROCEDURE  '|| to_char(Sysdate, 'dd/mm/yyyy hh24:mi:ss') ||' - ' ||  TO_CHAR(V_CONTADORNOTA)  ; 
         vAuxiliarchar := fn_InsereLogGeracao;

         if P_RETORNOPROCESSAMENTO <> TDVADM.PKG_glb_common.Status_Erro then
            P_RETORNOPROCESSAMENTO := TDVADM.PKG_glb_common.Status_Nomal;
         end if;
      End If;  
    END IF;
    

    IF ( P_RETORNOPROCESSAMENTO =  TDVADM.PKG_glb_common.Status_Nomal ) and 
       ( nvl(vErroFatal,'E') = 'N' ) THEN

       FOR R_EMBTRANSCTRC IN C_EMBTRANSCTRC
       LOOP
          UPDATE TDVADM.T_CON_CONHECIMENTO CC
            SET CC.ARM_CARREGAMENTO_CODIGO = R_EMBTRANSCTRC.CARN
          WHERE CC.CON_CONHECIMENTO_CODIGO = R_EMBTRANSCTRC.CTRC
            AND CC.CON_CONHECIMENTO_SERIE  = R_EMBTRANSCTRC.SERIE
            AND CC.GLB_ROTA_CODIGO = R_EMBTRANSCTRC.ROTA;
       END LOOP;


      -- Verificar se tem que criar CTe de Cobranca de Coleta.
      vAuxiliarCOBCOL := 0;
      Loop
      
          vAuxiliarCOBCOL := vAuxiliarCOBCOL  + 1;
          Begin
             if vListaCOBCOL(vAuxiliarCOBCOL).pTpCobranca = 'N' Then
                
                Select *
                   into tpConConhecimento
                From TDVADM.T_con_conhecimento c
                where c.con_conhecimento_codigo = vListaCOBCOL(vAuxiliarCOBCOL).pCteCod
                  and c.con_conhecimento_serie = vListaCOBCOL(vAuxiliarCOBCOL).pCteSr
                  and c.glb_rota_codigo = vListaCOBCOL(vAuxiliarCOBCOL).pCteRT;
                
                
                Select *
                  into tpConNftransporta
                From TDVADM.T_con_nftransporta nf
                where nf.con_conhecimento_codigo = vListaCOBCOL(vAuxiliarCOBCOL).pCteCod
                  and nf.con_conhecimento_serie = vListaCOBCOL(vAuxiliarCOBCOL).pCteSr
                  and nf.glb_rota_codigo = vListaCOBCOL(vAuxiliarCOBCOL).pCteRT
                  and nf.con_nftransportada_numnfiscal = vListaCOBCOL(vAuxiliarCOBCOL).pNota
                  and nf.glb_cliente_cgccpfcodigo = rpad(vListaCOBCOL(vAuxiliarCOBCOL).pRemetente,20);

                
                -- Pega um novo numero e Grava
                SELECT CON_SEQCONHECIMENTO_CODIGO.NEXTVAL
                   INTO V_CTRCCODIGO
                FROM DUAL;

                -- Mudo o Tipo de Embalagem para nao cobrar comprovantes.
                tpConConhecimento.Glb_Embalagem_Codigo := 'CC';
                tpConNftransporta.Glb_Embalagem_Codigo := 'CC';


                -- Mudo o Local de entrega e coleta
                tpConConhecimento.Con_Conhecimento_Localcoleta  := vListaCOBCOL(vAuxiliarCOBCOL).pBuscaFrete.vLOCALIDADEORIGEM;
                tpConConhecimento.Con_Conhecimento_Localentrega := vListaCOBCOL(vAuxiliarCOBCOL).pBuscaFrete.vLOCALIDADEDESTINO;
                -- Ate que o Klayton arrume a rotina das notas fiscais 20/07/2016
                tpConConhecimento.Glb_Localidade_Codigoorigem   := vListaCOBCOL(vAuxiliarCOBCOL).pBuscaFrete.vLOCALIDADEORIGEM;
                tpConConhecimento.Glb_Localidade_Codigodestino  := vListaCOBCOL(vAuxiliarCOBCOL).pBuscaFrete.vLOCALIDADEDESTINO;

                -- Verifica se vai ser NFS ou CTe
               IF tdvadm.fn_busca_codigoibge(tpConConhecimento.Con_Conhecimento_Localcoleta, 'IBC') = tdvadm.fn_busca_codigoibge(tpConConhecimento.Con_Conhecimento_Localentrega, 'IBC') THEN
                   V_TPCALCULO := '115';
                   vDescCalculo := 'CALCULO ISS';
                   vTipoDocumento := cNFServico;
                   if ( ListaNotas.cnContrato = 'C2013010022' ) Then -- LOT-VOLKSWAGEN-0113-XXX
                      V_TPCALCULO := '316';
                   end If   ;
                   If ListaNotas.cnGRUPOECSAC = '0020' Then
                      V_TPCALCULO := '316';
                   End If;
                   ListaNotas.cnROTA  := nvl(ListaNotas.cnROTANF, vListaCOBCOL(vAuxiliarCOBCOL).pCteRT);
                Else
                   V_TPCALCULO := '041';
                   vDescCalculo := 'CALCULO ICMS';
                   if ( ListaNotas.cnContrato = 'C2013010022' ) Then -- LOT-VOLKSWAGEN-0113-XXX
                      V_TPCALCULO := '315';
                   end If   ;
                   If ListaNotas.cnGRUPOECSAC = '0020' Then
                      V_TPCALCULO := '315';
                   End If;
                   ListaNotas.cnROTA  := vListaCOBCOL(vAuxiliarCOBCOL).pCteRT;
                END IF;
             
                If ListaNotas.cnContrato = 'C2018010117' Then  --  0541 - MRO-SUZANO IMPERATRIZ-0118-XXX

                   Select an.arm_coleta_centrodecusto,
                          an.arm_coleta_pedido
                     into vDTCol,
                          vPedido
                   From tdvadm.t_arm_coleta an
                   where an.arm_coleta_ncompra = vListaCOBCOL(vAuxiliarCOBCOL).pColeta
                     and an.arm_coleta_ciclo = vListaCOBCOL(vAuxiliarCOBCOL).pCiclo;
         
                   vDTCol := nvl(vDTCol,' ');
                   tpConConhecimento.Con_Conhecimento_Obs := 'COBRANCA DA COLETA ' || vListaCOBCOL(vAuxiliarCOBCOL).pColeta || '-' ||  vListaCOBCOL(vAuxiliarCOBCOL).pCiclo || 
                                                             ' DT - [' || vDTCol || '] Pedido [' || vPedido || ']';

                Else
                   tpConConhecimento.Con_Conhecimento_Obs := 'COBRANCA DA COLETA ' || vListaCOBCOL(vAuxiliarCOBCOL).pColeta || '-' ||  vListaCOBCOL(vAuxiliarCOBCOL).pCiclo || 
                                                             'CODCLI ' ||  vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_CALCFRETEKM_CODCLI;
                End If;


                tpConConhecimento.Con_Conhecimento_Codigo := V_CTRCCODIGO;
                tpConConhecimento.Glb_Rota_Codigo         := ListaNotas.cnROTA;
                tpConConhecimento.Slf_Tabela_Codigo := vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_TABELA_CODIGO;
                tpConConhecimento.Slf_Tabela_Saque := vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_TABELA_SAQUE;

                tpConNftransporta.Con_Conhecimento_Codigo := V_CTRCCODIGO;
                tpConNftransporta.Glb_Rota_Codigo         := ListaNotas.cnROTA;

               Insert into TDVADM.T_con_conhecimento Values tpConConhecimento;
               Insert into TDVADM.T_con_nftransporta Values tpConNftransporta;
                
                
                -- Cria a tipo da calc
                select tpConConhecimento.Con_Conhecimento_Codigo,
                       CON_CONHECIMENTO_SERIE,
                       ListaNotas.cnROTA,
                       SLF_RECCUST_CODIGO,
                       V_TPCALCULO,
                       GLB_MOEDA_CODIGO,
                       CON_CALCVIAGEM_DESINENCIA,
                       CON_CALCVIAGEM_REEMBOLSO,
                       CON_CALCVIAGEM_VALOR,
                       CON_CALCVIAGEM_TPRATEIO,
                       CON_CONHECIMENTO_DTEMBARQUE,
                       CON_CONHECIMENTO_ALTALTMAN,
                       GLB_ROTA_CODIGOGENERICO,
                       CON_CALCCONHECIMENTO_COCLI
                   into tpConCalcConhecimento
                from TDVADM.T_con_calcconhecimento ca
                where ca.con_conhecimento_codigo = vListaCOBCOL(vAuxiliarCOBCOL).pCteCod
                  and ca.con_conhecimento_serie = vListaCOBCOL(vAuxiliarCOBCOL).pCteSr
                  and ca.glb_rota_codigo = vListaCOBCOL(vAuxiliarCOBCOL).pCteRT
                  and ca.slf_reccust_codigo = 'D_FRPSVO';

               -- Inser as Verbas do Cliente
               INSERT INTO TDVADM.T_CON_CALCCONHECIMENTO CC
               SELECT tpConCalcConhecimento.Con_Conhecimento_Codigo,
                      tpConCalcConhecimento.Con_Conhecimento_Serie,
                      tpConCalcConhecimento.Glb_Rota_Codigo,
                      CK.SLF_RECCUST_CODIGO,
                      tpConCalcConhecimento.Slf_Tpcalculo_Codigo,
                      '0001',
                      CK.SLF_CALCFRETEKM_DESINENCIA,
                      NULL,
                      CK.SLF_CALCFRETEKM_VALOR,
                      '*',
                      tpConCalcConhecimento.Con_Conhecimento_Dtembarque,
                      null,
                      tpConCalcConhecimento.Glb_Rota_Codigogenerico,
                      CK.SLF_CALCFRETEKM_CODCLI
               FROM TDVADM.T_SLF_CALCFRETEKM CK,
                    TDVADM.T_SLF_TABELA T
               WHERE T.SLF_TABELA_CODIGO          = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_TABELA_CODIGO
                 and T.SLF_TABELA_SAQUE           = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_TABELA_SAQUE
                 and T.SLF_TABELA_TIPO            = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_TABELA_TIPO
                 AND T.GLB_CLIENTE_CGCCPFCODIGO   = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.GLB_CLIENTE_CGCCPFCODIGO
                 AND T.GLB_GRUPOECONOMICO_CODIGO  = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.GLB_GRUPOECONOMICO_CODIGO
                 AND T.SLF_TABELA_CONTRATO        = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_TABELA_CONTRATO
                 AND T.FCF_TPCARGA_CODIGO         = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.FCF_TPCARGA_CODIGO
                 and nvl(t.slf_tabela_status,'N') = 'N'
                 AND trim(T.FCF_TPVEICULO_CODIGO) = trim(vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.FCF_TPVEICULO_CODIGO)
                 AND T.SLF_TABELA_COLETAENTREGA   = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_TABELA_COLETAENTREGA
                 AND CK.SLF_CALCFRETEKM_KMDE      = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_CALCFRETEKM_KMDE
                 and CK.SLF_CALCFRETEKM_KMATE     = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_CALCFRETEKM_KMATE
                 and CK.SLF_CALCFRETEKM_PESODE    = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_CALCFRETEKM_PESODE
                 and CK.SLF_CALCFRETEKM_ORIGEMI   = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_CALCFRETEKM_ORIGEMI
                 and CK.SLF_CALCFRETEKM_DESTINOI  = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_CALCFRETEKM_DESTINOI
                 and CK.SLF_CALCFRETEKM_ORIGEM    = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_CALCFRETEKM_ORIGEM
                 and CK.SLF_CALCFRETEKM_DESTINO   = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_CALCFRETEKM_DESTINO
                 AND CK.SLF_TABELA_CODIGO         = T.SLF_TABELA_CODIGO
                 AND CK.SLF_TABELA_SAQUE          = T.SLF_TABELA_SAQUE;

                -- Insere as demais verbas do Contrato
                insert into TDVADM.T_con_calcconhecimento x
                select tpConCalcConhecimento.Con_Conhecimento_Codigo,
                       tpConCalcConhecimento.Con_Conhecimento_Serie,
                       tpConCalcConhecimento.Glb_Rota_Codigo,
                       rc.slf_reccust_codigo,
                       tpConCalcConhecimento.Slf_Tpcalculo_Codigo,
                       tpConCalcConhecimento.Glb_Moeda_Codigo,
                       rc.slf_reccust_desinecia,
                       tpConCalcConhecimento.Con_Calcviagem_Reembolso,
                       0,
                       tpConCalcConhecimento.Con_Calcviagem_Tprateio,
                       tpConCalcConhecimento.Con_Conhecimento_Dtembarque,
                       tpConCalcConhecimento.Con_Conhecimento_Altaltman,
                       tpConCalcConhecimento.Glb_Rota_Codigogenerico,
                       tpConCalcConhecimento.Con_Calcconhecimento_Cocli
                from TDVADM.T_SLF_CALCULO ca,
                     TDVADM.T_SLF_RECCUST RC
                WHERE CA.SLF_TPCALCULO_CODIGO = tpConCalcConhecimento.Slf_Tpcalculo_Codigo
                  AND CA.SLF_RECCUST_CODIGO   = RC.SLF_RECCUST_CODIGO
                  AND 0 = (SELECT COUNT(*)
                           FROM TDVADM.T_CON_CALCCONHECIMENTO C
                           WHERE C.CON_CONHECIMENTO_CODIGO = tpConCalcConhecimento.Con_Conhecimento_Codigo
                             AND C.CON_CONHECIMENTO_SERIE  = tpConCalcConhecimento.Con_Conhecimento_Serie
                             AND C.GLB_ROTA_CODIGO         = tpConCalcConhecimento.Glb_Rota_Codigo
                             AND C.SLF_RECCUST_CODIGO      = CA.SLF_RECCUST_CODIGO);

                
                update TDVADM.T_con_calcconhecimento ca
                  set ca.con_calcviagem_valor = vListaCOBCOL(vAuxiliarCOBCOL).pValor,
                      ca.con_calcviagem_desinencia = 'VL',
                      ca.con_calcconhecimento_cocli = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_CALCFRETEKM_CODCLI
                where ca.con_conhecimento_codigo = tpConCalcConhecimento.Con_Conhecimento_Codigo
                  and ca.con_conhecimento_serie = tpConCalcConhecimento.Con_Conhecimento_Serie
                  and ca.glb_rota_codigo = tpConCalcConhecimento.Glb_Rota_Codigo
                  and ca.slf_reccust_codigo = 'D_FRPSVO';

                update TDVADM.T_con_calcconhecimento ca
                  set ca.con_calcviagem_valor = vListaCOBCOL(vAuxiliarCOBCOL).pPesoReal,
                      ca.con_calcviagem_desinencia = 'VL',
                      ca.con_calcconhecimento_cocli = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_CALCFRETEKM_CODCLI
                where ca.con_conhecimento_codigo = tpConCalcConhecimento.Con_Conhecimento_Codigo
                  and ca.con_conhecimento_serie = tpConCalcConhecimento.Con_Conhecimento_Serie
                  and ca.glb_rota_codigo = tpConCalcConhecimento.Glb_Rota_Codigo
                  and ca.slf_reccust_codigo = 'D_PSREAL';

                update TDVADM.T_con_calcconhecimento ca
                  set ca.con_calcviagem_valor = vListaCOBCOL(vAuxiliarCOBCOL).pPesoCobrado,
                      ca.con_calcviagem_desinencia = 'VL',
                      ca.con_calcconhecimento_cocli = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_CALCFRETEKM_CODCLI
                where ca.con_conhecimento_codigo = tpConCalcConhecimento.Con_Conhecimento_Codigo
                  and ca.con_conhecimento_serie = tpConCalcConhecimento.Con_Conhecimento_Serie
                  and ca.glb_rota_codigo = tpConCalcConhecimento.Glb_Rota_Codigo
                  and ca.slf_reccust_codigo = 'I_PSCOBRAD';

                update TDVADM.T_con_calcconhecimento ca
                  set ca.con_calcviagem_valor = vListaCOBCOL(vAuxiliarCOBCOL).pValorMerc,
                      ca.con_calcviagem_desinencia = 'VL',
                      ca.con_calcconhecimento_cocli = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_CALCFRETEKM_CODCLI
                where ca.con_conhecimento_codigo = tpConCalcConhecimento.Con_Conhecimento_Codigo
                  and ca.con_conhecimento_serie = tpConCalcConhecimento.Con_Conhecimento_Serie
                  and ca.glb_rota_codigo = tpConCalcConhecimento.Glb_Rota_Codigo
                  and ca.slf_reccust_codigo = 'I_VLMR';

                update TDVADM.T_con_calcconhecimento ca
                  set ca.con_calcviagem_valor = vListaCOBCOL(vAuxiliarCOBCOL).pValorMercSeg,
                      ca.con_calcviagem_desinencia = 'VL',
                      ca.con_calcconhecimento_cocli = vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_CALCFRETEKM_CODCLI
                where ca.con_conhecimento_codigo = tpConCalcConhecimento.Con_Conhecimento_Codigo
                  and ca.con_conhecimento_serie = tpConCalcConhecimento.Con_Conhecimento_Serie
                  and ca.glb_rota_codigo = tpConCalcConhecimento.Glb_Rota_Codigo
                  and ca.slf_reccust_codigo = 'D_VLRSEGUR';
                  

                  

                SELECT TDVADM.FN_GET_ALIQUOTA(tpConConhecimento.Con_Conhecimento_Localcoleta,
                                       tpConConhecimento.Con_Conhecimento_Localentrega,
                                       tpConConhecimento.Con_Conhecimento_Dtembarque,
                                       tpConConhecimento.Glb_Rota_Codigo)
                   INTO V_ALIQUOTA
                FROM DUAL;
                
                update TDVADM.T_con_calcconhecimento ca
                  set ca.con_calcviagem_valor = V_ALIQUOTA
                where ca.con_conhecimento_codigo = tpConNftransporta.Con_Conhecimento_Codigo
                  and ca.con_conhecimento_serie = tpConNftransporta.Con_Conhecimento_Serie
                  and ca.glb_rota_codigo = tpConNftransporta.Glb_Rota_Codigo
                  and ca.slf_reccust_codigo in ('S_ALICMS','S_ALISS');


                UPDATE TDVADM.T_CON_CALCCONHECIMENTO C
                  SET C.CON_CONHECIMENTO_ALTALTMAN = NULL
                WHERE C.CON_CONHECIMENTO_CODIGO = V_CTRCCODIGO
                  AND C.CON_CONHECIMENTO_SERIE = 'XXX'
                  AND C.GLB_ROTA_CODIGO = ListaNotas.cnROTA;
                COMMIT;
                TDVADM.PKG_SLF_CALCULOS.SP_MONTA_FORMULA_CNHC(V_TPCALCULO,
                                                              tpConNftransporta.Con_Conhecimento_Codigo,
                                                              'XXX',
                                                              tpConNftransporta.Glb_Rota_Codigo);

               tpConRedespacho.Con_Conhecimento_Codigo := tpConNftransporta.Con_Conhecimento_Codigo;
               tpConRedespacho.Con_Conhecimento_Serie := 'XXX';
               tpConRedespacho.Glb_Rota_Codigo := tpConNftransporta.Glb_Rota_Codigo;
               tpConRedespacho.Con_Consigredespacho_Flagcr := 'R';
               tpConRedespacho.Con_Tpdoc_Codigo := '00';
               tpConRedespacho.Con_Consigredespacho_Cgccpf := fn_RetCNPJArmazem(P_ARM_ARMAZEM);
               tpConRedespacho.Glb_Tpcliend_Codigo := 'E';

               select ce.glb_cliend_ie
                  into tpConRedespacho.Con_Consigredespacho_Ie
               from tdvadm.t_glb_cliend ce
               where ce.glb_cliente_cgccpfcodigo = tpConRedespacho.Con_Consigredespacho_Cgccpf
                 and ce.glb_tpcliend_codigo = tpConRedespacho.Glb_Tpcliend_Codigo;
               
               insert into TDVADM.T_con_consigredespacho values tpConRedespacho;
               
               
               Select *
                 into tpNotaCte
               from TDVADM.T_arm_notacte nc
               where nc.arm_notacte_codigo = 'NO'
                 and nc.con_conhecimento_codigo = vListaCOBCOL(vAuxiliarCOBCOL).pCteCod
                 and nc.con_conhecimento_serie = vListaCOBCOL(vAuxiliarCOBCOL).pCteSr
                 and nc.glb_rota_codigo = vListaCOBCOL(vAuxiliarCOBCOL).pCteRT
                 and nc.arm_nota_numero = vListaCOBCOL(vAuxiliarCOBCOL).pNota
                 and nc.glb_cliente_cgccpfremetente = vListaCOBCOL(vAuxiliarCOBCOL).pRemetente
                 and nc.arm_nota_sequencia = vListaCOBCOL(vAuxiliarCOBCOL).psequencia;
                 

               tpNotaCte.Arm_Notacte_Codigo       := 'CO';
               tpNotaCte.Con_Conhecimento_Codigo  := tpConNftransporta.Con_Conhecimento_Codigo;
               tpNotaCte.Glb_Rota_Codigo          := tpConNftransporta.Glb_Rota_Codigo; 
                
               tpNotaCte.Con_Conhecimento_Codigoa := tpNotaCte.Con_Conhecimento_Codigo;
               tpNotaCte.Con_Conhecimento_Seriea  := tpNotaCte.Con_Conhecimento_Serie;
               tpNotaCte.Glb_Rota_Codigoa         := tpNotaCte.Glb_Rota_Codigo;
               
               tpNotaCte.arm_nota_tabsolcod       := vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_TABELA_CODIGO;
               tpNotaCte.arm_nota_tabsolsq        := vListaCOBCOL(vAuxiliarCOBCOL).pRetFrete.SLF_TABELA_SAQUE;
               tpNotaCte.arm_nota_tabsol          := 'T';
               tpNotaCte.Arm_Notacte_Dtgravacao   := sysdate;
     
               insert into TDVADM.T_arm_notacte Values tpNotaCte;
               
               commit;
               V_CONTADORCTRC := V_CONTADORCTRC + 1;
                


              End If; 

          Exception
            When NO_DATA_FOUND Then
              exit;
            End;

      End Loop;

     -- VERIFICAR SE TEM CTRC AGRUPANDO NOTAS TRANSFERIDAS
     -- SIRLANO *** verificar ***

      select *
        into tpCarregamento
      from TDVADM.T_arm_carregamento ca
       WHERE CA.ARM_CARREGAMENTO_CODIGO = P_ARM_CARREGAMENTO
         AND CA.ARM_ARMAZEM_CODIGO = P_ARM_ARMAZEM;
        
      tpCarregamento.ARM_CARREGAMENTO_QTDCTRC      := nvl(V_CONTADORCTRC,0) + nvl(v_CTRCIMPRESSO,0);
      tpCarregamento.ARM_CARREGAMENTO_QTDIMPCTRC   := nvl(V_TOTNOTCOMCTRC,0) + nvl(v_CTRCIMPRESSO,0); 
      tpCarregamento.ARM_CARREGAMENTO_PESOCOBRADO  := nvl(V_SOMAPESOCOBRADO,0);
      tpCarregamento.ARM_CARREGAMENTO_PESOREAL     := nvl(V_SOMAPESOREAL,0);
      tpCarregamento.ARM_CARREGAMENTO_PESOBALANCA  := nvl(V_SOMAPESOBALANCA,0); 
      tpCarregamento.USU_USUARIO_FECHOUCARREG      := substr(P_USU_USUARIOCRIA,1,10); 
      tpCarregamento.ARM_CARREGAMENTO_DTFECHAMENTO := SYSDATE;
      tpCarregamento.ARM_ESTAGIOCARREGMOB_CODIGO   := 'F';
      
      UPDATE TDVADM.T_ARM_CARREGAMENTO CA
         SET CA.ARM_CARREGAMENTO_QTDCTRC      = tpCarregamento.ARM_CARREGAMENTO_QTDCTRC,
             CA.ARM_CARREGAMENTO_QTDIMPCTRC   = tpCarregamento.ARM_CARREGAMENTO_QTDIMPCTRC,
             CA.ARM_CARREGAMENTO_PESOCOBRADO  = tpCarregamento.ARM_CARREGAMENTO_PESOCOBRADO,
             CA.ARM_CARREGAMENTO_PESOREAL     = tpCarregamento.ARM_CARREGAMENTO_PESOREAL,
             CA.ARM_CARREGAMENTO_PESOBALANCA  = tpCarregamento.ARM_CARREGAMENTO_PESOBALANCA,
             CA.USU_USUARIO_FECHOUCARREG      = tpCarregamento.USU_USUARIO_FECHOUCARREG,
             CA.ARM_CARREGAMENTO_DTFECHAMENTO = tpCarregamento.ARM_CARREGAMENTO_DTFECHAMENTO,
             CA.ARM_ESTAGIOCARREGMOB_CODIGO   = tpCarregamento.ARM_ESTAGIOCARREGMOB_CODIGO,
             ca.arm_carregamemcalc_codigo     = P_ARM_CARREGAMENTO
       WHERE CA.ARM_CARREGAMENTO_CODIGO = P_ARM_CARREGAMENTO
         AND CA.ARM_ARMAZEM_CODIGO = P_ARM_ARMAZEM;
       
       vAuxiliarD := sysdate;
       update TDVADM.T_Arm_Carregamemcalc c
         set c.arm_carregamemcalc_finalizou = vAuxiliarD,
             c.arm_carregamemcalc_data = vAuxiliarD,
             c.arm_carregamemcalc_crioucarreg = tpCarregamento.USU_USUARIO_FECHOUCARREG
       WHERE C.ARM_CARREGAMEMCALC_MEMOCALC = P_ARM_CARREGAMENTO
         AND C.ARM_ARMAZEM_CODIGO = P_ARM_ARMAZEM;           
    

      /********** SIRLANO JANELA *************/
      If P_ARM_ARMAZEM <> P_ARM_ARMAZEM then
         update TDVSVA.T_CS278_SIMULADOR s
           set s.arm_coleta_finalizada = vAuxiliarD
         where s.arm_carregamento_codigo = P_ARM_CARREGAMENTO
           and s.arm_armazem_codigo = P_ARM_ARMAZEM;                                              
      End If;

         tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Iniciando Simulador  '|| to_char(Sysdate, 'dd/mm/yyyy hh24:mi:ss') ; 
         vAuxiliarchar := fn_InsereLogGeracao;
--         tdvsva.pkg_sva_cs278_on.SP_SIMULA(p_arm_carregamento);
--         sp_sva_simula_cs278(p_arm_carregamento,P_ARM_ARMAZEM,NULL,NULL,'S');
         tpLogGeracao.Con_Loggeracao_ObsgeracaoHTML := 'Fim do Simulador  '|| to_char(Sysdate, 'dd/mm/yyyy hh24:mi:ss') ; 
         vAuxiliarchar := fn_InsereLogGeracao;

      Begin
      -- Pega Valor de Mercadoria de Conhecimento Ja impressos No Carregamento.
      select sum(nvl(NF.CON_NFTRANSPORTADA_VALORSEG,0))
         INTO V_SOMAMERCADORIACC
      from TDVADM.T_con_conhecimento c,
           TDVADM.T_con_NFTRANSPORTA NF
      where c.con_conhecimento_codigo = NF.con_conhecimento_codigo
        and c.con_conhecimento_serie = NF.con_conhecimento_serie
        and c.glb_rota_codigo = NF.glb_rota_codigo
        AND C.CON_CONHECIMENTO_SERIE <> 'XXX'
        and c.con_conhecimento_digitado = 'I'
        and c.arm_carregamento_codigo = P_ARM_CARREGAMENTO; 
       
      V_SOMAMERCADORIACC := nvl(V_SOMAMERCADORIACC,0); 
               
      select sum(nvl(an.arm_nota_valornfseguro,an.arm_nota_valormerc))
        into vAuxiliar
      from TDVADM.T_arm_nota an,
           TDVADM.T_glb_cliente cl,
           TDVADM.T_ARM_CARREGAMENTODET CD
      where an.glb_cliente_cgccpfsacado = cl.glb_cliente_cgccpfcodigo (+)
        AND AN.ARM_EMBALAGEM_NUMERO = CD.ARM_EMBALAGEM_NUMERO
        AND AN.ARM_EMBALAGEM_FLAG = CD.ARM_EMBALAGEM_FLAG
        AND AN.ARM_EMBALAGEM_SEQUENCIA = CD.ARM_EMBALAGEM_SEQUENCIA
        and CD.arm_carregamento_codigo = P_ARM_CARREGAMENTO
        and an.slf_contrato_codigo = 'C2015120024'; -- LOT-VOTORANTIM-1215-CIMENTOS
      
      if ( nvl(V_SOMAMERCADORIA,0) + nvl(V_SOMAMERCADORIACC,0) > 1500000 ) or
         ( nvl(vAuxiliar,0) >= 200000 )  Then
         vAuxiliarnumerico := 0;
         for c_msg in ( select trim(lpad(an.arm_nota_numero,10,'0') || '-' || an.glb_cliente_cgccpfremetente)  nota,
                               an.arm_nota_chavenfe chave,
                               an.slf_contrato_codigo contrato,
                               nvl(an.arm_nota_valornfseguro,an.arm_nota_valormerc)  valor,
                               an.arm_nota_mercadoria mercadoria
                        from TDVADM.T_arm_nota an,
                             TDVADM.T_glb_cliente cl,
                             TDVADM.T_ARM_CARREGAMENTODET CD
                        where an.glb_cliente_cgccpfsacado = cl.glb_cliente_cgccpfcodigo (+)
                          AND AN.ARM_EMBALAGEM_NUMERO = CD.ARM_EMBALAGEM_NUMERO
                          AND AN.ARM_EMBALAGEM_FLAG = CD.ARM_EMBALAGEM_FLAG
                          AND AN.ARM_EMBALAGEM_SEQUENCIA = CD.ARM_EMBALAGEM_SEQUENCIA
                          and CD.arm_carregamento_codigo = P_ARM_CARREGAMENTO
                        UNION
                        select trim(lpad(NF.CON_NFTRANSPORTADA_NUMNFISCAL,10,'0') || '-' || NF.GLB_CLIENTE_CGCCPFCODIGO) NOTA,
                               NF.CON_NFTRANSPORTADA_CHAVENFE CHAVE,
                               TDVADM.PKG_SLF_UTILITARIOS.fn_retorna_contratoCC(C.CON_CONHECIMENTO_CODIGO,C.CON_CONHECIMENTO_SERIE,C.GLB_ROTA_CODIGO) CONTRATO,
                               Nvl(NF.CON_NFTRANSPORTADA_VALORSEG,0) valor,
                               nf.con_nfttransporta_mercadoria mercadoria
                        from TDVADM.T_con_conhecimento c,
                             TDVADM.T_con_NFTRANSPORTA NF
                        where c.con_conhecimento_codigo = NF.con_conhecimento_codigo
                          and c.con_conhecimento_serie = NF.con_conhecimento_serie
                          and c.glb_rota_codigo = NF.glb_rota_codigo
                          AND C.CON_CONHECIMENTO_SERIE <> 'XXX'
                          and c.con_conhecimento_digitado = 'I'
                          and c.arm_carregamento_codigo = P_ARM_CARREGAMENTO )
            loop
             vAuxiliarnumerico := vAuxiliarnumerico + 1;
             If vAuxiliarnumerico = 1 then
--                vCorpoEmail := 'FAVOR VERIFICAR O CARREGAMENTO ' || P_ARM_CARREGAMENTO || chr(10) ;
                If vAuxiliar >= 200000 Then
                   vCorpoEmail := vCorpoEmail || chr(10) || 'TOTAL DA MERCADORIA NO CARREGAMENTO R$ ' || f_mascara_valor(vAuxiliar,20);
                Else
                   vCorpoEmail := vCorpoEmail || chr(10) || 'TOTAL DA MERCADORIA NO CARREGAMENTO R$ ' || f_mascara_valor(nvl(V_SOMAMERCADORIA,0) + nvl(V_SOMAMERCADORIACC,0),20);
                End If; 
                vCorpoEmail := vCorpoEmail || chr(10) || 'CONTRATO  - ' || c_msg.contrato || '-' || tdvadm.pkg_slf_utilitarios.fn_retorna_contrato(c_msg.contrato) ||
                                              chr(10) || 'ARMAZEM   - ' || P_ARM_ARMAZEM || '-' || trim(ListaVaux.cnArmazemNome) ||
                                              chr(10) || 'ORIGEM    - ' || vDescOrigem.ColLocDescri || --TDVADM.FN_BUSCA_CODIGOIBGE(ListaVaux.cnCODIGOORI,'LOD') ||
                                              chr(10) || 'DESTINO   - ' || vDescOrigem.EntLocDescri || --TDVADM.FN_BUSCA_CODIGOIBGE(ListaVaux.cnCODIGODES,'LOD') ||
                                              chr(10) || 'KM        - ' || ListaVaux.cnKM ||  
                                              chr(10) || 'USUARIO   - ' || P_USU_USUARIOCRIA || 
                                              chr(10) || 'DATA HORA - ' || TO_CHAR(SYSDATE, 'DD/MM/YYYY HH24:MI:SS') || chr(10); 
             End If;
             vCorpoEmail := vCorpoEmail ||  'NOTA/CNPJ ' ||  c_msg.nota || ' Valor ' || trim(tdvadm.f_mascara_valor(c_msg.valor,20,2)) || chr(10) || '      CHAVE [' || c_msg.Chave || '] -' || c_msg.Mercadoria || chr(10) || chr(10);
            
          End Loop;


          If nvl(vAuxiliar,0) >= 200000 Then
             wservice.pkg_glb_email.SP_ENVIAEMAIL('VALOR DE MERCADORIA ACIMA DE R$ 200.000,00',
                                                  vCorpoEmail,
                                                  'aut-e@dellavolpe.com.br',
                                                  'alertavcimentos@dellavolpe.com.br');
          ElsIf ( nvl(V_SOMAMERCADORIA,0) + nvl(V_SOMAMERCADORIACC,0) > 1500000 ) Then
             wservice.pkg_glb_email.SP_ENVIAEMAIL('VALOR DE MERCADORIA ACIMA DE R$ 1.500.000,00 CARREGAMENTO - ' || P_ARM_CARREGAMENTO,
                                                  vCorpoEmail,
                                                  'aut-e@dellavolpe.com.br',
                                                  'grp.valormercalto@dellavolpe.com.br;sdrumond@dellavolpe.com.br',
                                                  'rcarvalho@dellavolpe.com.br');
          End If;
      
       End If;      
      
      exception
        when others then
          raise_application_error(-20801, ListaNotas.cnMERCADORIA || V_SOMAMERCADORIA || '-' || sqlerrm);
      end;
  --    DELETE TDVADM.T_CON_LOGGERACAO LG
  --    WHERE LG.ARM_CARREGAMENTO_CODIGO = P_ARM_CARREGAMENTO;

    ELSE
        if vErroFatal = 'E' Then
           tpLogGeracaO.Con_Loggeracao_ErroHTML := 'Carregamento COM ERRO FATAL' ; 
           P_RETORNOPROCESSAMENTO := fn_InsereLogGeracao;
        end If;
        P_RETORNOPROCESSAMENTO := 'E';
  --    INSERT INTO TDVADM.T_CON_LOGGERACAO l
  --    SELECT * FROM TDVADM.T_CON_LOGGERACAO x 
  --    where x.con_loggeracao_codigo <> '0'; 
         tdvadm.SP_CON_VOLTACARREG(P_ARM_CARREGAMENTO);
         select count(*)
           into vAuxiliar
         from tdvadm.t_con_conhecimento c
         where c.arm_carregamento_codigo = P_ARM_CARREGAMENTO;
         If vAuxiliar > 0 Then
            tdvadm.SP_CON_VOLTACARREG(P_ARM_CARREGAMENTO);
         End If;   
         vAuxiliarchar := TDVADM.PKG_fifo_carregamento.fn_carreg_atualiza_pesos(P_ARM_CARREGAMENTO);
         delete TDVADM.T_arm_carregamemcalc cc
         where cc.arm_carregamemcalc_memocalc = P_ARM_CARREGAMENTO;
         commit;
    END IF;
    COMMIT;
  END SP_CON_CRIACTRCCARREG;


  procedure SP_ARM_RODASEPARA
    As
      vStatus char;
      vMessage varchar2(200);
      vUsuarios  varchar2(100);
      vDtInicio char(10);
      vAuxiliar number;

  Begin
    vUsuarios     := ',ssjunior,apmsilva';
    vDtInicio := to_char(sysdate-10,'dd/mm/yyyy');

                   FOR R_CURSORCarreg In (select c.arm_carregamento_codigo
                                          from TDVADM.T_arm_carregamento c
                                          where 0 = 0
--                                            AND c.arm_armazem_codigo in (select a.arm_armazem_codigo 
--                                                                         from TDVADM.T_arm_armazem a 
--                                                                         where a.arm_armazem_ativo = 'S' 
--                                                                           and a.arm_armazem_divcarreg = 'S')
                                            and nvl(c.arm_carregamento_dtfechamento,'01/01/2010') >= vDtInicio
                                            and c.arm_carregamento_codigo = c.arm_carregamemcalc_codigo
                                            AND c.arm_carregamento_dtfechamento is not null
                                            and 1 = (select count(*)
                                                     from TDVADM.T_arm_carregamento c2
                                                     where c2.arm_carregamemcalc_codigo = c.arm_carregamento_codigo))
                 Loop


                    update TDVADM.T_arm_carregamento c
                       set c.arm_carregamento_qtdctrc = ( select count(*)
                                                          from TDVADM.T_con_conhecimento ct
                                                          where ct.arm_carregamento_codigo = c.arm_carregamento_codigo),
                           c.arm_carregamento_qtdimpctrc = ( select count(*)
                                                             from TDVADM.T_con_conhecimento ct
                                                             where ct.arm_carregamento_codigo = c.arm_carregamento_codigo
                                                               and ct.con_conhecimento_digitado = 'I')

                    where 0 = 0
                      and c.arm_carregamento_codigo = R_CURSORCarreg.Arm_Carregamento_Codigo;
                      
                      
               select count (*)
                 into vAuxiliar
                 from tdvadm.t_arm_carregamemcalc ca
                where ca.arm_carregamemcalc_memocalc = R_CURSORCarreg.Arm_Carregamento_Codigo;
                
               if vAuxiliar = 0 then
                 
                 insert into tdvadm.t_arm_carregamemcalc 
                 select distinct ca.arm_carregamemcalc_codigo,
                        ca.arm_armazem_codigo,
                        ca.arm_carregamento_dtcria,
                        ja.fcf_tpcarga_codigo,
                        ja.glb_cliente_cgccpfsac,
                        ja.glb_cliente_cgccpfrem,
                        ja.glb_tpcliend_codigorem,
                        ja.arm_janelacons_coleta,
                        ja.glb_cliente_cgccpfdes,
                        ja.glb_tpcliend_codigodes,
                        ja.arm_janelacons_entrega,
                        ja.arm_janelacons_entcol,
                        ja.slf_contrato_codigo,
                        an.arm_nota_flagpgto,
                        ja.glb_grupoeconomico_codigo,
                        decode(nvl(co.slf_tabela_codigo,'S'),'S','S','T'),
                        nvl(co.slf_tabela_codigo,co.slf_solfrete_codigo),
                        nvl(co.slf_tabela_saque,co.slf_solfrete_saque),
                        ja.slf_tpagrupa_codigo,
                        0,
                        'codcli',
                        an.usu_usuario_codigo,
                        ca.arm_carregamento_dtfechamento,
                        0
                   from tdvadm.t_arm_janelacons ja,
                        tdvadm.t_arm_nota an,
                        tdvadm.t_arm_carregamentodet cd,
                        tdvadm.t_arm_carregamento ca,
                        tdvadm.t_con_conhecimento co
                  where ca.arm_carregamento_codigo  = R_CURSORCarreg.Arm_Carregamento_Codigo
                    and ja.arm_janelacons_sequencia = an.arm_janelacons_sequencia  
                    and cd.arm_carregamento_codigo  = ca.arm_carregamento_codigo
                    and an.arm_embalagem_numero     = cd.arm_embalagem_numero
                    and an.arm_embalagem_flag       = cd.arm_embalagem_flag
                    and an.arm_embalagem_sequencia  = cd.arm_embalagem_sequencia
                    and an.con_conhecimento_codigo  = co.con_conhecimento_codigo
                    and an.con_conhecimento_serie   = co.con_conhecimento_serie
                    and an.glb_rota_codigo          = co.glb_rota_codigo
                    and rownum = 1;
               
               end if; 
                      
                    commit;         
                End Loop;     

                SP_CON_SEPARACARREG(null,null,null,vStatus,vMessage) ;
                SP_CON_SEPARACARREG(null,null,vUsuarios,vStatus,vMessage) ;
--      SP_CON_SEPARACARREG(vCarregamento,null,null,vStatus,vMessage) ;
  
  
  End;



  PROCEDURE SP_CON_SEPARACARREG(pCarregamento in tdvadm.t_arm_carregamento.arm_carregamento_codigo%type,
                                pArmazem      in varchar2,
                                pUsuario      in varchar2,
                                pStatus       out char,
                                pMessage      out varchar2)
  AS
    tpCarreg   tdvadm.t_arm_carregamento%rowtype;
    vAuxiliar  number;
    vMSg       clob;
    vSql       clob;
    vArmazem   varchar2(100);
    vLibSefaz  varchar2(100);
    vUsuarios  varchar2(100);
    vCarregamento tdvadm.t_arm_carregamento.arm_carregamento_codigo%type;
    R_CURSOR   tpCurosr;
    vEmail     TDVADM.T_arm_armazem.arm_armazem_infomail%type;
    vNomeArmazem varchar2(50);
    vCarreg    TDVADM.T_arm_carregamento.arm_carregamento_codigo%type;
    vDtInicio  char(10);
    vCodCTe    TDVADM.T_con_conhecimento.con_conhecimento_codigo%type;
    vCodCarreg TDVADM.T_arm_carregamento.arm_carregamento_codigo%type;
    vTpcarregamemcalc tdvadm.t_arm_carregamemcalc%rowtype;
  BEGIN

     Begin
         
         If nvl(SYS_CONTEXT('PROCESSOUNICO','SP_CON_SEPARACARREG'),'N') = 'S'   Then
            Return;
         End If;    
          
         system.pkg_glb_context.sp_set_vlr_PROCESSOUNICO('SP_CON_SEPARACARREG','S');
         system.pkg_glb_context.sp_set_vlr_PROCESSOUNICO('SP_CON_SEPARACARREGINI',to_char(sysdate,'dd/mm/yyyy hh24:mi:ss'));
      
          vLibSefaz := ',100,';
          vDtInicio := '15/04/2014';
          pStatus := TDVADM.PKG_glb_common.Status_Nomal;

          pMessage := '';

          vCarregamento := null;
          if nvl(pCarregamento,'x') <> 'x' Then
             vCarregamento := pCarregamento;
          End If;

          vArmazem := null;
          if nvl(pArmazem,'x') <> 'x' Then
             vArmazem := pArmazem;
          End If;

          vUsuarios := null;
          If nvl(pUsuario,'x') <> 'x' Then
             vUsuarios := pUsuario;
          End If;         
          
                        
          If vCarregamento is not null Then
            
              update TDVADM.T_arm_carregamento c
                set c.arm_carregamento_qtdctrc = ( select count(*)
                                                   from TDVADM.T_con_conhecimento ct
                                                   where ct.arm_carregamento_codigo = c.arm_carregamento_codigo),
                    c.arm_carregamento_qtdimpctrc = ( select count(*)
                                                      from TDVADM.T_con_conhecimento ct
                                                      where ct.arm_carregamento_codigo = c.arm_carregamento_codigo
                                                        and ct.con_conhecimento_digitado = 'I')

              where 0 = 0
                and c.arm_carregamemcalc_codigo = vCarregamento
                and c.arm_carregamento_codigo = c.arm_carregamemcalc_codigo
                and nvl(c.arm_carregamento_dtfechamento,'01/01/2010') >= vDtInicio
                and c.arm_carregamento_codigo = c.arm_carregamemcalc_codigo
                and 1 = (select count(*)
                         from TDVADM.T_arm_carregamento c2
                         where c2.arm_carregamemcalc_codigo = c.arm_carregamento_codigo);
                commit;         

          End If;
     

        For c_msg in (select distinct ca.arm_carregamemcalc_codigo,
                             ca.arm_armazem_codigo,
                             ca.arm_carregamento_dtcria,
                             ja.fcf_tpcarga_codigo,
                             ja.glb_cliente_cgccpfsac,
                             ja.glb_cliente_cgccpfrem,
                             ja.glb_tpcliend_codigorem,
                             ja.arm_janelacons_coleta,
                             ja.glb_cliente_cgccpfdes,
                             ja.glb_tpcliend_codigodes,
                             ja.arm_janelacons_entrega,
                             ja.arm_janelacons_entcol,
                             ja.slf_contrato_codigo,
                             an.arm_nota_flagpgto,
                             ja.glb_grupoeconomico_codigo,
                             decode(nvl(co.slf_tabela_codigo,'S'),'S','S','T') tabsol,
                             nvl(co.slf_tabela_codigo,co.slf_solfrete_codigo) codtabsol,
                             nvl(co.slf_tabela_saque,co.slf_solfrete_saque) saque,
                             ja.slf_tpagrupa_codigo,
                             0 Contaador,
                             'codcli' doccli,
                             an.usu_usuario_codigo,
                             ca.arm_carregamento_dtfechamento,
                             0 Seqagrup
                      from tdvadm.t_arm_janelacons ja,
                           tdvadm.t_arm_nota an,
                           tdvadm.t_arm_carregamentodet cd,
                           tdvadm.t_arm_carregamento ca,
                           tdvadm.t_con_conhecimento co
                      where ca.arm_carregamento_codigo  = 'CARREGAMENTO' 
                        and ja.arm_janelacons_sequencia = an.arm_janelacons_sequencia  
                        and cd.arm_carregamento_codigo  = ca.arm_carregamento_codigo
                        and an.arm_embalagem_numero     = cd.arm_embalagem_numero
                        and an.arm_embalagem_flag       = cd.arm_embalagem_flag
                        and an.arm_embalagem_sequencia  = cd.arm_embalagem_sequencia
                        and an.con_conhecimento_codigo  = co.con_conhecimento_codigo
                        and an.con_conhecimento_serie   = co.con_conhecimento_serie
                        and an.glb_rota_codigo          = co.glb_rota_codigo)
        Loop
          
           vTpcarregamemcalc.Arm_Carregamemcalc_Memocalc    := c_msg.arm_carregamemcalc_codigo; 
           vTpcarregamemcalc.Arm_Armazem_Codigo             := c_msg.arm_armazem_codigo;
           vTpcarregamemcalc.Arm_Carregamemcalc_Data        := c_msg.arm_carregamento_dtcria;
           vTpcarregamemcalc.Fcf_Tpcarga_Codigo             := c_msg.fcf_tpcarga_codigo;
           vTpcarregamemcalc.Arm_Carregamemcalc_Clisac      := c_msg.glb_cliente_cgccpfsac;
           vTpcarregamemcalc.Arm_Carregamemcalc_Cnpjrem     := c_msg.glb_cliente_cgccpfrem;
           vTpcarregamemcalc.Arm_Carregamemcalc_Cliendrem   := c_msg.glb_tpcliend_codigorem;
           vTpcarregamemcalc.Arm_Carregamemcalc_Origemnota  := c_msg.arm_janelacons_coleta;
           vTpcarregamemcalc.Arm_Carregamemcalc_Cnpjdes     := c_msg.glb_cliente_cgccpfdes;
           vTpcarregamemcalc.Arm_Carregamemcalc_Clienddes   := c_msg.glb_tpcliend_codigodes;
           vTpcarregamemcalc.Arm_Carregamemcalc_Destinonota := c_msg.arm_janelacons_entrega;
           vTpcarregamemcalc.Arm_Carregamemcalc_Entcol      := c_msg.arm_janelacons_entcol;
           vTpcarregamemcalc.Arm_Carregamemcalc_Contrato    := c_msg.slf_contrato_codigo;
           vTpcarregamemcalc.Arm_Carregamemcalc_Flagpgto    := c_msg.arm_nota_flagpgto;
           vTpcarregamemcalc.Arm_Carregamemcalc_Grupoec     := c_msg.glb_grupoeconomico_codigo;
           vTpcarregamemcalc.Arm_Carregamemcalc_Tptabsol    := c_msg.tabsol;
           vTpcarregamemcalc.Arm_Carregamemcalc_Tabsolcod   := c_msg.codtabsol;
           vTpcarregamemcalc.Arm_Carregamemcalc_Tabsolsq    := c_msg.saque;
           vTpcarregamemcalc.Arm_Carregamemcalc_Cctprateio  := c_msg.slf_tpagrupa_codigo;
           vTpcarregamemcalc.Arm_Carregamemcalc_Contaador   := c_msg.contaador;
           vTpcarregamemcalc.Arm_Carregamemcalc_Doccliente  := c_msg.doccli;
           vTpcarregamemcalc.Arm_Carregamemcalc_Crioucarreg := c_msg.usu_usuario_codigo;
           vTpcarregamemcalc.Arm_Carregamemcalc_Finalizou   := c_msg.arm_carregamento_dtfechamento;
           vTpcarregamemcalc.Arm_Carregamemcalc_Seqagrup    := c_msg.seqagrup;
           Begin
              insert into tdvadm.t_arm_carregamemcalc values vTpcarregamemcalc; 
           Exception
             When OTHERS Then
               vTpcarregamemcalc.Arm_Carregamemcalc_Memocalc := vTpcarregamemcalc.Arm_Carregamemcalc_Memocalc; 
             End;
                
        End Loop;
        Commit;      
          
           vSql := empty_clob;
           vSql := vSql || 'Select Distinct a.arm_armazem_infomail, ';
           vSql := vSql || '       car.arm_carregamento_codigo, ';
           vSql := vSql || '       a.arm_armazem_codigo || ' || TDVADM.PKG_glb_common.fn_QuotedStr('-') || ' || a.arm_armazem_descricao ';
           vSql := vSql || 'from TDVADM.T_arm_carregamemcalc calc, ';
           vSql := vSql || '     TDVADM.T_arm_carregamento car, ';
           vSql := vSql || '     TDVADM.T_fcf_veiculodisp vd, ';
           vSql := vSql || '     TDVADM.T_arm_armazem a ';
           vSql := vSql || 'where 0 = 0 ';
           if nvl(vArmazem,'x') <> 'x' Then
              vSql := vSql || '  and trunc(calc.arm_carregamemcalc_finalizou) >= ' || TDVADM.PKG_glb_common.fn_QuotedStr(vDtInicio) ;
              vSql := vSql || '  and instr(' || TDVADM.PKG_glb_common.fn_QuotedStr(vArmazem) || ',trim(calc.arm_armazem_codigo)) > 0';
           End If;   
           if nvl(vCarregamento,'x') <> 'x' Then
              vSql := vSql || '  and calc.arm_carregamemcalc_memocalc = ' || TDVADM.PKG_glb_common.fn_QuotedStr(vCarregamento) ;
           End If;   
           if nvl(vUsuarios,'x') <> 'x' Then
              vSql := vSql || '  and calc.arm_carregamemcalc_finalizou >= ' || TDVADM.PKG_glb_common.fn_QuotedStr(vDtInicio) ;
              vSql := vSql || '  and instr(' || TDVADM.PKG_glb_common.fn_QuotedStr(vUsuarios) || ',trim(car.usu_usuario_fechoucarreg)) > 0 ';
           End If;  
           if ( nvl(vArmazem,'x') = 'x' ) and 
              ( nvl(vCarregamento,'x') = 'x' ) and 
              ( nvl(vUsuarios,'x') = 'x' ) Then
              vSql := vSql || '  and trunc(calc.arm_carregamemcalc_finalizou) >= ' || TDVADM.PKG_glb_common.fn_QuotedStr(vDtInicio) ;
              vSql := vSql || '  and calc.arm_armazem_codigo in (select a.arm_armazem_codigo from TDVADM.T_arm_armazem a where a.arm_armazem_ativo = ''S'' and a.arm_armazem_divcarreg = ''S'')';
           End If;   
           vSql := vSql || '  and vd.car_veiculo_placa is null ';
           vSql := vSql || '  and car.fcf_veiculodisp_codigo = vd.fcf_veiculodisp_codigo ';
           vSql := vSql || '  and car.fcf_veiculodisp_sequencia = vd.fcf_veiculodisp_sequencia ';
           vSql := vSql || '  and calc.arm_carregamemcalc_memocalc = car.arm_carregamemcalc_codigo ';
           vSql := vSql || '  and car.arm_carregamento_codigo = car.arm_carregamemcalc_codigo ';
           vSql := vSql || '  and calc.arm_armazem_codigo = a.arm_armazem_codigo ';
           if vCarregamento not in ('817461',
                                    '849855',
                                    '854570',
                                    '871193',
                                    '864452',
                                    '869410',
                                    '871194',
                                    '871197', 
                                    '872081', 
                                    '872082') Then
           vSql := vSql || '  and 0 = (Select Count(*) ';
           vSql := vSql || '           From TDVADM.T_con_docmdfe m ';
           vSql := vSql || '           Where m.arm_carregamento_codigo = car.arm_carregamento_codigo) ';
           End If;
           vSql := vSql || '  and car.arm_carregamento_qtdctrc > 1 ';
           vSql := vSql || '  and car.arm_carregamento_qtdctrc = (select count(*) ';
           vSql := vSql || '                                      from TDVADM.T_con_conhecimento ct, ';
           vSql := vSql || '                                           TDVADM.T_con_controlectrce cte ';
           vSql := vSql || '                                      where  0 = 0      ';
           vSql := vSql || '                                        and ct.arm_carregamento_codigo = calc.arm_carregamemcalc_memocalc ';
           vSql := vSql || '                                        and ct.con_conhecimento_codigo = cte.con_conhecimento_codigo (+) ';
           vSql := vSql || '                                        and ct.con_conhecimento_serie  = cte.con_conhecimento_serie (+) ';
           vSql := vSql || '                                        and ct.glb_rota_codigo         = cte.glb_rota_codigo (+) ';
           vSql := vSql || '                                        and ct.con_conhecimento_digitado = ''I''';
           vSql := vSql || '                                        and ct.con_conhecimento_serie <> ''XXX''';
           vSql := vSql || '                                        and ( instr(' || TDVADM.PKG_glb_common.fn_QuotedStr(vLibSefaz) || ',trim(cte.con_controlectrce_codstenv)) > 0 ';
           vSql := vSql || '                                         OR TDVADM.PKG_SLF_CALCULOS.F_BUSCA_CONHEC_TPFORMULARIO(CT.CON_CONHECIMENTO_CODIGO,CT.CON_CONHECIMENTO_SERIE,CT.GLB_ROTA_CODIGO) = ''NF'') ';
           if vCarregamento not in ('817461',
                                    '849855',
                                    '854570',
                                    '871193',
                                    '864452',
                                    '869410',
                                    '871194',
                                    '871197', 
                                    '872081', 
                                    '872082') Then
           vSql := vSql || '                                        and 0 = (select count(*) ';
           vSql := vSql || '                                                 from TDVADM.T_con_vfreteconhec vfc ';
           vSql := vSql || '                                                 where vfc.con_conhecimento_codigo = ct.con_conhecimento_codigo ';
           vSql := vSql || '                                                   and vfc.con_conhecimento_serie  = ct.con_conhecimento_serie ';
           vSql := vSql || '                                                   and vfc.glb_rota_codigo = ct.glb_rota_codigo)) ';
           Else
           vSql := vSql || ')';
           End If;
             
   --  insert into TDVADM.T_glb_sql (glb_sql_dtgravacao,glb_sql_instrucao,glb_sql_programa) values (sysdate, vSql,'SEPARA ' || vCarregamento);
       
      OPEN R_CURSOR FOR TRIM(vSql);
          
             loop
               fetch R_CURSOR
                  into vEmail,vCarreg,vNomeArmazem;
                exit when R_CURSOR%notfound;


                If vEmail is null Then
                  
                   wservice.pkg_glb_email.SP_ENVIAEMAIL('ARMAZEM SEM EMAIL -  CARREGAMENTO ' || vCarreg,
                                                        'O Armazem abaixo Nao dividou o Carregamento' || chr(10) ||
                                                        vNomeArmazem,
                                                        'aut-e@dellavolpe.com.br',
                                                        'grp.hd@dellavolpe.com.br;sdrumond@dellavolpe.com.br');
                Else
                
                   Begin  
                
                      if vCarreg <> '806615' Then 

                       select c.*
                          into tpCarreg
                       from TDVADM.T_arm_carregamento c
                       where c.arm_carregamento_codigo = vCarreg;   
                       
                       vAuxiliar := 0 ;
                       vMSg := empty_clob; 
      --                 vCodCTe := '000000';
      --                 vCodCarreg := vCarreg;
                       
                       -- So para pegar o primeiro Carregamento
                       FOR R_CURSORCTE In (select an.arm_nota_numero,
                                                  an.glb_cliente_cgccpfremetente,
                                                  an.arm_nota_sequencia,
                                                  an.con_conhecimento_codigo,
                                                  an.con_conhecimento_serie,
                                                  an.glb_rota_codigo,
                                                  an.arm_embalagem_numero,
                                                  an.arm_embalagem_flag,
                                                  an.arm_embalagem_sequencia
                                           from TDVADM.T_arm_nota an,
                                                TDVADM.T_con_conhecimento c
                                           where c.arm_carregamento_codigo = vCarreg
                                             and an.con_conhecimento_codigo = c.con_conhecimento_codigo
                                             and an.con_conhecimento_serie = c.con_conhecimento_serie
                                             and an.glb_rota_codigo = c .glb_rota_codigo
                                           order by an.con_conhecimento_codigo,
                                                    an.con_conhecimento_serie,
                                                    an.glb_rota_codigo,
                                                    an.arm_carregamento_codigo,
                                                    an.glb_cliente_cgccpfremetente,
                                                    an.arm_nota_numero)                              
                       Loop
                         vCodCTe := R_CURSORCTE.CON_CONHECIMENTO_CODIGO;
                         vCodCarreg := tpCarreg.arm_carregamento_codigo;
                         exit;
                       End Loop;
                                         
                       FOR R_CURSORCTE In (select an.arm_nota_numero,
                                                  an.glb_cliente_cgccpfremetente,
                                                  an.arm_nota_sequencia,
                                                  an.con_conhecimento_codigo,
                                                  an.con_conhecimento_serie,
                                                  an.glb_rota_codigo,
                                                  an.arm_embalagem_numero,
                                                  an.arm_embalagem_flag,
                                                  an.arm_embalagem_sequencia
                                           from TDVADM.T_arm_nota an,
                                                TDVADM.T_con_conhecimento c
                                           where c.arm_carregamento_codigo = vCarreg
                                             and an.con_conhecimento_codigo = c.con_conhecimento_codigo
                                             and an.con_conhecimento_serie = c.con_conhecimento_serie
                                             and an.glb_rota_codigo = c.glb_rota_codigo
                                           order by an.con_conhecimento_codigo,
                                                    an.con_conhecimento_serie,
                                                    an.glb_rota_codigo,
                                                    an.arm_carregamento_codigo,
                                                    an.glb_cliente_cgccpfremetente,
                                                    an.arm_nota_numero)                              
                       Loop
                         -- isto foi para pular o primeiro CTe
      --                   if vAuxiliar <> 0 then
              --             tpCarreg.arm_carregamento_pesocobrado
              --             tpCarreg.arm_carregamento_pesoreal
              --             tpCarreg.arm_carregamento_pesobalanca
              --             tpCarreg.arm_carregamento_pesocubado
                           if vCodCTe <> R_CURSORCTE.CON_CONHECIMENTO_CODIGO Then

                              vCodCTe := R_CURSORCTE.CON_CONHECIMENTO_CODIGO;

                              select max(to_number(c.arm_carregamento_codigo)) + 1 
                                 into tpCarreg.arm_carregamento_codigo
                              from TDVADM.T_arm_carregamento c;

                              tpCarreg.arm_carregamento_qtdctrc := 1;
                              tpCarreg.arm_carregamento_qtdimpctrc := 1;
                              tpCarreg.Arm_Carregamemcalc_Codigo := vCarreg;


                               Begin
                               insert into TDVADM.T_arm_carregamento values tpCarreg;
                               commit;
                               Exception
                                  WHEN DUP_VAL_ON_INDEX  THEN
                                    
                                      select max(to_number(c.arm_carregamento_codigo)) + 1 
                                         into tpCarreg.arm_carregamento_codigo
                                      from TDVADM.T_arm_carregamento c;

                                      insert into TDVADM.T_arm_carregamento values tpCarreg;
                                      commit;

                                  End ;

                           End If;   

                           if vCodCarreg <> tpCarreg.arm_carregamento_codigo Then 
                               vMsg := vMSg || 'Novo Carregamento ' || tpCarreg.arm_carregamento_codigo || ' Embalagem ' || R_CURSORCTE.Arm_Embalagem_Numero || ' Flag ' || R_CURSORCTE.Arm_Embalagem_Flag || ' Sequencia ' || R_CURSORCTE.Arm_Embalagem_Sequencia || chr(10);
                           End If;



                               update TDVADM.T_arm_carregamentodet cd 
                                 set cd.arm_carregamento_codigo = tpCarreg.arm_carregamento_codigo
                               where 0=0
                                 and cd.arm_carregamento_codigo = vCarreg
                                 and cd.arm_embalagem_numero = R_CURSORCTE.Arm_Embalagem_Numero
                                 and cd.arm_embalagem_flag = R_CURSORCTE.Arm_Embalagem_Flag
                                 and cd.arm_embalagem_sequencia = R_CURSORCTE.Arm_Embalagem_Sequencia;
                           
                               update TDVADM.T_arm_nota n  
                                 set n.arm_carregamento_codigo = tpCarreg.arm_carregamento_codigo
                               where 0 = 0
          --                       and n.arm_carregamento_codigo = vCarreg
                                 and n.arm_nota_numero = R_CURSORCTE.Arm_Nota_Numero
                                 and n.glb_cliente_cgccpfremetente = R_CURSORCTE.Glb_Cliente_Cgccpfremetente
                                 and n.arm_nota_sequencia = R_CURSORCTE.Arm_Nota_Sequencia;
                                 
                               update TDVADM.T_arm_embalagem n  
                                 set n.arm_carregamento_codigo = tpCarreg.arm_carregamento_codigo
                               where 0 = 0
          --                       and n.arm_carregamento_codigo = vCarreg
                                 and n.arm_embalagem_numero = R_CURSORCTE.Arm_Embalagem_Numero
                                 and n.arm_embalagem_flag = R_CURSORCTE.Arm_Embalagem_Flag
                                 and n.arm_embalagem_sequencia = R_CURSORCTE.Arm_Embalagem_Sequencia;

                               update TDVADM.T_con_conhecimento c
                                 set c.arm_carregamento_codigo = tpCarreg.arm_carregamento_codigo                  
                               where 0 = 0
          --                       and c.arm_carregamento_codigo = vCarreg
                                 and c.con_conhecimento_codigo = R_CURSORCTE.Con_Conhecimento_Codigo
                                 and c.con_conhecimento_serie = R_CURSORCTE.Con_Conhecimento_Serie
                                 and c.glb_rota_codigo = R_CURSORCTE.Glb_Rota_Codigo;

                               if vCodCarreg <> tpCarreg.arm_carregamento_codigo Then 
                                   vCodCarreg := tpCarreg.arm_carregamento_codigo;
                                   Begin
                                      tpCarreg.Fcf_Veiculodisp_Codigo := tdvadm.pkg_fifo.fn_CriaVeicVirtual(tpCarreg.Arm_Carregamento_Codigo);
                                   Exception
                                     When OTHERS Then
                                         tpCarreg.Fcf_Veiculodisp_Codigo := tdvadm.pkg_fifo.fn_CriaVeicVirtual(tpCarreg.Arm_Carregamento_Codigo);
                                     End ;
                                   tpCarreg.Fcf_Veiculodisp_Sequencia := '0';
                               End If;

                               update TDVADM.T_arm_carregamento ca
                               set ca.fcf_veiculodisp_codigo =  tpCarreg.Fcf_Veiculodisp_Codigo,
                                   ca.fcf_veiculodisp_sequencia = tpCarreg.Fcf_Veiculodisp_Sequencia
                               where ca.arm_carregamento_codigo = tpCarreg.Arm_Carregamento_Codigo;

                              -- Atualiza os Pesos
                               pStatus :=  TDVADM.PKG_fifo_carregamento.FN_CARREG_ATUALIZA_PESOS(tpCarreg.arm_carregamento_codigo );
      --                       End If;
      --                    Else
      --                       vCodCTe    := R_CURSORCTE.CON_CONHECIMENTO_CODIGO;
      --                       vCodCarreg := tpCarreg.arm_carregamento_codigo;
      --                    End If;
                          vMSg := vMSg || 'Carreg ' || tpCarreg.arm_carregamento_codigo  || ' Cte ' || R_CURSORCTE.Con_Conhecimento_Codigo || '-' || R_CURSORCTE.Con_Conhecimento_Serie || '-' || R_CURSORCTE.Glb_Rota_Codigo || chr(10);
      --                    vAuxiliar := vAuxiliar + 1;   
                       End Loop;       

--                 wservice.pkg_glb_email.SP_ENVIAEMAIL('SEPARACAO DE CARREGAMENTO MEMORIA DE CALCULO ' || vCarreg ,
--                                                      vMSg,
--                                                      'aut-e@dellavolpe.com.br',
      --                                                'sdrumond@dellavolpe.com.br',
--                                                      vEmail);
                   
                   update TDVADM.T_arm_carregamento c
                     set c.arm_carregamento_qtdctrc = 1,
                         c.arm_carregamento_qtdimpctrc = 1
          --             c.arm_carregamento_pesocobrado
          --             c.arm_carregamento_pesoreal
          --             c.arm_carregamento_pesobalanca
          --             c.arm_carregamento_pesocubado
                   where c.arm_carregamento_codigo = vCarreg;   
                   pStatus :=  TDVADM.PKG_fifo_carregamento.FN_CARREG_ATUALIZA_PESOS(vCarreg);
      --             commit;
                  End If;
             exception
               WHEN OTHERS Then
                   -- Caso aconteca algum erro
                   wservice.pkg_glb_email.SP_ENVIAEMAIL('ERRO AO DIVIDIR CARREGAMENTO [' || vCarreg || ']',
                                                        vMSg || chr(10) || to_char(sysdate,'dd/mm/yyyy hh24:mi:ss') || ' - ' || trim(sqlerrm),
                                                        'aut-e@dellavolpe.com.br',
                                                        'sdrumond@dellavolpe.com.br;bbernardo@dellavolpe.com.br');
               End;
           End If;
         End Loop;                          
         commit;
     exception
       WHEN OTHERS Then
           -- Caso aconteca algum erro
           wservice.pkg_glb_email.SP_ENVIAEMAIL('ERRO AO DIVIDIR CARREGAMENTO [' || vCarreg || ']',
                                                vMSg || chr(10) || to_char(sysdate,'dd/mm/yyyy hh24:mi:ss') || ' - ' || trim(sqlerrm),
                                                'aut-e@dellavolpe.com.br',
                                                'sdrumond@dellavolpe.com.br;bbernardo@dellavolpe.com.br');
           system.pkg_glb_context.sp_set_vlr_PROCESSOUNICO('SP_CON_SEPARACARREG','N');
           system.pkg_glb_context.sp_set_vlr_PROCESSOUNICO('SP_CON_SEPARACARREGFIM',to_char(sysdate,'dd/mm/yyyy hh24:mi:ss'));
       End;                   

       system.pkg_glb_context.sp_set_vlr_PROCESSOUNICO('SP_CON_SEPARACARREG','N');
       system.pkg_glb_context.sp_set_vlr_PROCESSOUNICO('SP_CON_SEPARACARREGFIM',to_char(sysdate,'dd/mm/yyyy hh24mi:ss'));

    
  END SP_CON_SEPARACARREG;


  PROCEDURE SP_CON_JUNTACARREG(pCarregamento in tdvadm.t_arm_carregamento.arm_carregamento_codigo%type,
                               pTipo         in char default 'XXX',
                               pStatus       out char,
                               pMessage      out varchar2)
  AS
    tpCarreg tdvadm.t_arm_carregamento%rowtype;
    
    vAuxiliar    number;
    vContaPtipo  number;
    vContaCanc   number;
    vContaCarreg number;
    vJunta       char(1);
    vCursorJunta TpJunta;
    vSql       clob;
    R_CURSOR   tpCurosr;
    vCodCTe    TDVADM.T_con_conhecimento.con_conhecimento_codigo%type;
    vCodMDFE   varchar2(15);
    vMSg       clob;
    vDataJuntou date := sysdate;
    tpLogJunta  tdvadm.T_ARM_CARREGAMENTOJUNTA%rowtype;
/*
    vArmazem   varchar2(100);
    vLibSefaz  varchar2(100);
    vUsuarios  varchar2(100);
    vCarregamento tdvadm.t_arm_carregamento.arm_carregamento_codigo%type;
    vEmail     TDVADM.T_arm_armazem.arm_armazem_infomail%type;
    vCarreg    TDVADM.T_arm_carregamento.arm_carregamento_codigo%type;
    vDtInicio  char(10);
*/
   
  BEGIN
    
    pStatus := TDVADM.PKG_GLB_COMMON.Status_Nomal;
    pMessage := ''; 

   
     Begin
         If nvl(SYS_CONTEXT('PROCESSOUNICO','SP_CON_JUNTACARREG'),'N') = 'S' Then
            pStatus := TDVADM.PKG_GLB_COMMON.Status_Warning;
            pMessage := 'Processo esta em execuc?o. desde [' || SYS_CONTEXT('PROCESSOUNICO','SP_CON_JUNTACARREGINI') || '] TENTE DAQUI ALGUNS MINUTOS' || chr(10);
            Return;
         End If;    
          
         system.pkg_glb_context.sp_set_vlr_PROCESSOUNICO('SP_CON_JUNTACARREG','S');
         system.pkg_glb_context.sp_set_vlr_PROCESSOUNICO('SP_CON_JUNTACARREGINI',to_char(sysdate,'dd/mm/yyyy hh24:mi:ss'));
      

         Select count(*)
           into vContaCarreg
         From TDVADM.T_arm_carregamento ca
         Where ca.arm_carregamemcalc_codigo = pCarregamento;
         
         If vContaCarreg = 1 Then
            pStatus := TDVADM.PKG_glb_common.Status_Warning;
            pMessage := 'Carregamento Nao dividido' || chr(10);
         End If;   

         if pStatus = TDVADM.PKG_glb_common.Status_Nomal Then
              SELECT max(m.con_manifesto_codigo || '-' || m.con_manifesto_serie || '-' || m.con_manifesto_rota),
                     COUNT(*)
                 INTO vCodMDFE,
                      vAuxiliar
              FROM TDVADM.T_CON_DOCMDFE C,
                  TDVADM.T_CON_MANIFESTO M
              WHERE C.CON_MANIFESTO_CODIGO = M.CON_MANIFESTO_CODIGO
                AND C.CON_MANIFESTO_SERIE = M.CON_MANIFESTO_SERIE
                AND C.CON_MANIFESTO_ROTA = M.CON_MANIFESTO_ROTA
                AND NVL(M.CON_MANIFESTO_STATUS,'N') <> 'C'
                AND C.ARM_CARREGAMENTO_CODIGO = VCURSORJUNTA.RCARREGAMENTO;

              -- Se achar algum manifesto Nao cancelado
              IF vAuxiliar > 0 THEN
                pStatus := TDVADM.PKG_GLB_COMMON.Status_Erro;
                pMessage := pMessage || 'Carregamento [' || VCURSORJUNTA.RCARREGAMENTO || '] contas em ' || vAuxiliar || ' Manifestos vide Codigo ' || vCodMDFE || chr(10);
              End If;


            if pStatus = TDVADM.PKG_glb_common.Status_Nomal Then

              -- se maior que 1
              -- verifica se todos s?o da Serie XXX
                vJunta := 'N';
             
                Select count(*)
               into vContapTipo
             From TDVADM.T_arm_carregamento ca,
                  TDVADM.T_con_conhecimento c
             Where ca.arm_carregamento_codigo = c.arm_carregamento_codigo
--               and c.con_conhecimento_serie = nvl(pTipo,'XXX')
               and ca.arm_carregamemcalc_codigo = pCarregamento;

                vContaPtipo := nvl(vContaPtipo,0);

              if nvl(pTipo,'XXX') <> 'XXX' then
                vContaPtipo := vContaCarreg;
              End If;
             
--             if ( vContaPtipo <> 0 )  and ( vContaCarreg <> vContaPtipo )  Then
--
--                pStatus := TDVADM.PKG_glb_common.Status_Erro;
--                pMessage := pMessage || 'Falta ' || to_char( vContaCarreg - vContaPtipo )  || ' Conhecimentos para serem Cancelados ' || chr(10);
--             End If;
             
               if pStatus = TDVADM.PKG_glb_common.Status_Nomal Then
             
             
             
--                   if vContaCarreg = vContaPtipo Then
--                      vJunta := 'S';
--                   End If;   
                   vJunta := 'S';

                   if vJunta = 'N' Then
                   -- Se Nao verifica se todos est?o cancelados
                      select count(*)
                        into vContaCanc
                      from TDVADM.T_arm_carregamento ca,
                           TDVADM.T_con_conhecimento c
                      where ca.arm_carregamento_codigo = c.arm_carregamento_codigo
                        and nvl(c.con_conhecimento_flagcancelado,'N') = 'S'
                        and ca.arm_carregamemcalc_codigo = pCarregamento;
                
                      vContaCanc := nvl(vContaCanc,0); 
                       
                      if ( vContaCanc <> 0 )  and ( vContaCarreg <> vContaCanc )  Then
                         pStatus := TDVADM.PKG_glb_common.Status_Erro;
                         pMessage := pMessage || 'Falta ' || to_char( vContaCarreg - vContaCanc )  || ' Conhecimentos para serem Cancelados ' || chr(10);
                      End If;

                      if vContaCarreg = vContaCanc Then
                         vJunta := 'S';
                      End If;   
             
                   End If; 

            
                   if vJunta = 'S' Then
                      vSql := empty_clob;
                      vSql := Vsql || 'SELECT CA.ARM_CARREGAMENTO_CODIGO, ';
                      vSql := Vsql || '       CA.ARM_CARREGAMEMCALC_CODIGO, ';
                      vSql := Vsql || '       C.CON_CONHECIMENTO_CODIGO, ';
                      vSql := Vsql || '       C.CON_CONHECIMENTO_SERIE, ';
                      vSql := Vsql || '       C.GLB_ROTA_CODIGO, ';
                      vSql := Vsql || '       CDET.ARM_EMBALAGEM_NUMERO, ';
                      vSql := Vsql || '       CDET.ARM_EMBALAGEM_FLAG, ';
                      vSql := Vsql || '       CDET.ARM_EMBALAGEM_SEQUENCIA, ';
                      vSql := Vsql || '       N.ARM_NOTA_NUMERO,';
                      vSql := Vsql || '       N.ARM_CARGA_CODIGO,';
                      vSql := Vsql || '       N.ARM_NOTA_SEQUENCIA, ';
                      vSql := Vsql || '       N.ARM_COLETA_NCOMPRA, ';
                      vSql := Vsql || '       N.ARM_COLETA_CICLO, ';
                      vSql := Vsql || '       CA.ARM_CARREGAMENTO_DTFECHAMENTO, ';
                      vSql := Vsql || '       CA.ARM_ARMAZEM_CODIGO, ';
                      vSql := Vsql || '       CA.USU_USUARIO_CRIOUCARREG, ';
                      vSql := Vsql || '       CA.USU_USUARIO_FECHOUCARREG, ';
                      vSql := Vsql || '       CA.ARM_CARREGAMENTO_MOBILE, ';
                      vSql := Vsql || '       CA.ARM_CARREGAMENTO_DTCRIA, ';
                      vSql := Vsql || '       CA.USU_USUARIO_CONFERIUCARREG, ';
                      vSql := Vsql || '       CA.ARM_CARREGAMENTO_DTCONFERENCIA, ';
                      vSql := Vsql || '       C.GLB_CLIENTE_CGCCPFSACADO ';
                      vSql := Vsql || 'FROM TDVADM.T_ARM_CARREGAMENTO CA, ';
                      vSql := Vsql || '     TDVADM.T_CON_CONHECIMENTO C, ';
                      vSql := Vsql || '     TDVADM.T_ARM_CARREGAMENTODET CDET, ';
                      vSql := Vsql || '     TDVADM.T_ARM_NOTA N ';            
                      vSql := Vsql || 'WHERE CA.ARM_CARREGAMENTO_CODIGO = C.ARM_CARREGAMENTO_CODIGO ';
                      vSql := Vsql || '  AND CA.ARM_CARREGAMENTO_CODIGO = CDET.ARM_CARREGAMENTO_CODIGO ';
                      vSql := Vsql || '  AND C.CON_CONHECIMENTO_CODIGO = N.CON_CONHECIMENTO_CODIGO ';
                      vSql := Vsql || '  AND C.CON_CONHECIMENTO_SERIE = N.CON_CONHECIMENTO_SERIE ';
                      vSql := Vsql || '  AND C.GLB_ROTA_CODIGO = N.GLB_ROTA_CODIGO ';
                      vSql := Vsql || '  AND CDET.ARM_EMBALAGEM_NUMERO = N.ARM_EMBALAGEM_NUMERO ';
                      vSql := Vsql || '  AND CDET.ARM_EMBALAGEM_FLAG = N.ARM_EMBALAGEM_FLAG ';
                      vSql := Vsql || '  AND CDET.ARM_EMBALAGEM_SEQUENCIA = N.ARM_EMBALAGEM_SEQUENCIA ';
                      if vContaPtipo = vContaCarreg  Then 
                         if nvl(pTipo,'XXX') = 'XXX' then
                            vSql := Vsql || '  AND C.CON_CONHECIMENTO_SERIE = ' || TDVADM.PKG_glb_common.fn_QuotedStr('XXX'); 
                         Else
                            vSql := Vsql || '  AND C.CON_CONHECIMENTO_SERIE <> ' || TDVADM.PKG_glb_common.fn_QuotedStr('XXX'); 
                         End If;
                      End If ;
                        
                      if vContaCanc = vContaCarreg Then 
                         vSql := Vsql || '  AND NVL(C.CON_CONHECIMENTO_FLAGCANCELADO,''N'') = ''S'' ';
                      End If;   
                      vSql := Vsql || '  AND CA.ARM_CARREGAMEMCALC_CODIGO = ' ||  TDVADM.PKG_glb_common.Fn_QuotedStr(pCarregamento);


                     
                      vAuxiliar := 0;
                      
                      OPEN R_CURSOR FOR TRIM(vSql);
                    
                       loop
                         fetch R_CURSOR
                            into vCursorJunta;
                          exit when R_CURSOR%notfound;

                             -- isto foi para pular o primeiro CTe
--                             if vCursorJunta.rCarregamento <> pCarregamento then

                               update TDVADM.T_arm_carregamentodet cd 
                                 set cd.arm_carregamento_codigo = pCarregamento
                               where 0 = 0
                                 and cd.arm_carregamento_codigo = vCursorJunta.rCarregamento
                                 and cd.arm_embalagem_numero    = vCursorJunta.rEmbalagemCodigo
                                 and cd.arm_embalagem_flag      = vCursorJunta.rEmbalagemFlag
                                 and cd.arm_embalagem_sequencia = vCursorJunta.rEmbalagemSeq;

                               update TDVADM.T_arm_nota n  
                                 set n.arm_carregamento_codigo = pCarregamento
                               where 0 = 0
                                 and n.arm_carregamento_codigo     = vCursorJunta.rCarregamento
                                 and n.arm_nota_numero             = vCursorJunta.rNota
                                 and n.glb_cliente_cgccpfremetente = vCursorJunta.rRemetente
                                 and n.arm_nota_sequencia          = vCursorJunta.rNotaSequencia;

                               update TDVADM.T_arm_embalagem n  
                                 set n.arm_carregamento_codigo = pCarregamento
                               where 0 = 0
                                 and n.arm_carregamento_codigo = vCursorJunta.rCarregamento
                                 and n.arm_embalagem_numero    = vCursorJunta.rEmbalagemCodigo
                                 and n.arm_embalagem_flag      = vCursorJunta.rEmbalagemFlag
                                 and n.arm_embalagem_sequencia = vCursorJunta.rEmbalagemSeq;

                               update TDVADM.T_con_conhecimento c
                                 set c.arm_carregamento_codigo = pCarregamento
                               where 0 = 0
                                 and c.arm_carregamento_codigo = vCursorJunta.rCarregamento
                                 and c.con_conhecimento_codigo = vCursorJunta.rConhecimento
                                 and c.con_conhecimento_serie  = vCursorJunta.rSerie
                                 and c.glb_rota_codigo         = vCursorJunta.rRota;

                               -- Reabre a Coleta
                               -- Retirado em 25/07/2016
/*                               -- se juntar Nao mexo na coleta 
                               if nvl(pTipo,'XXX') <> 'A1' Then
                                   TDVADM.PKG_arm_coleta.vSistemaPoderetirarOcorCol := 'S';
                                   update TDVADM.T_arm_coleta c
                                      set c.arm_coletaocor_codigo = null,
                                          c.arm_coleta_dtfechamento = null
                                   Where c.arm_coleta_ncompra = vCursorJunta.rColeta
                                     and c.arm_coleta_ciclo = vCursorJunta.rColetaCiclo;       
                                   TDVADM.PKG_arm_coleta.vSistemaPoderetirarOcorCol := 'N';
                               End If;    
*/

                               IF pCarregamento <> vCursorJunta.rCarregamento Then

                                  -- Retira o Veiculo Disponivel do Carregamento Anterior 
                                  update TDVADM.T_arm_carregamento c
                                    set c.fcf_veiculodisp_codigo = null,
                                        c.fcf_veiculodisp_sequencia = null
                                   where c.arm_carregamento_codigo = vCursorJunta.rCarregamento;     

                                  UPDATE TDVADM.T_FCF_VEICULODISPDEST D
                                     SET D.ARM_CARREGAMENTO_CODIGO = NULL
                                  WHERE D.ARM_CARREGAMENTO_CODIGO = VCURSORJUNTA.RCARREGAMENTO;
                               
                                  -- Volta a Situac?o do Veiculo Disponivel 
                                  UPDATE TDVADM.T_FCF_VEICULODISP D
                                     SET D.ARM_CARREGAMENTO_CODIGO = NULL,
                                         D.FCF_VEICULODISP_DTUTILIZADO = NULL,
                                         D.USU_USUARIO_UTILIZOU = NULL,
                                         D.FCF_VEICULODISP_FLAGVALEFRETE = 'N'
                                  WHERE D.ARM_CARREGAMENTO_CODIGO = VCURSORJUNTA.RCARREGAMENTO;
                                  vAuxiliar := sql%rowcount;
                               End If;

                               UPDATE TDVADM.T_CON_DOCMDFE M
                                 SET M.ARM_CARREGAMENTO_CODIGO = NULL
                               WHERE M.ARM_CARREGAMENTO_CODIGO = VCURSORJUNTA.RCARREGAMENTO;  
                    

                               tpLogJunta.ARM_CARREGAMEMCALC_CODIGO      := VCURSORJUNTA.rMemoCalc; 
                               tpLogJunta.ARM_CARREGAMENTO_CODIGO        := VCURSORJUNTA.rCarregamento;
                               tpLogJunta.ARM_CARREGAMENTO_DTFECHAMENTO  := VCURSORJUNTA.rDtFechamento; 
                               tpLogJunta.ARM_ARMAZEM_CODIGO             := VCURSORJUNTA.rArmazem;
                               tpLogJunta.USU_USUARIO_CRIOUCARREG        := VCURSORJUNTA.rUsuCriou;
                               tpLogJunta.USU_USUARIO_FECHOUCARREG       := VCURSORJUNTA.rUsuFechou;
                               tpLogJunta.ARM_CARREGAMENTO_MOBILE        := VCURSORJUNTA.rMobile;
                               tpLogJunta.ARM_CARREGAMENTO_DTCRIA        := VCURSORJUNTA.rDtCriacao;
                               tpLogJunta.USU_USUARIO_CONFERIUCARREG     := VCURSORJUNTA.rUsuConferiu;
                               tpLogJunta.ARM_CARREGAMENTO_DTCONFERENCIA := VCURSORJUNTA.rDtConferencia;
                               tpLogJunta.GLB_CLIENTE_CGCCPFCODIGO       := VCURSORJUNTA.rSacado;
                               tpLogJunta.ARM_CARREGAMENTOJUNTA_DOC      := VCURSORJUNTA.rConhecimento ||'-' || VCURSORJUNTA.rSerie || '-' || VCURSORJUNTA.rRota;
                               tpLogJunta.ARM_CARREGAMENTOJUNTA_COLETA   := VCURSORJUNTA.rColeta || '-' || VCURSORJUNTA.rColetaCiclo;
                               tpLogJunta.ARM_CARREGAMENTOJUNTA_DATA     := vDataJuntou;
                               tpLogJunta.ARM_CARREGAMENTOJUNTA_OBS      := null;
                               tpLogJunta.ARM_CARREGAMENTOJUNTA_DTENDP   := null;
                               INSERT INTO TDVADM.T_ARM_CARREGAMENTOJUNTA
                               values tpLogJunta;
                               
                               if pStatus <> TDVADM.PKG_GLB_COMMON.Status_Erro Then

          --                        delete TDVADM.T_fcf_veiculodisp d where d.arm_carregamento_codigo = vCursorJunta.rCarregamento;

                                  delete TDVADM.T_arm_carregamento_hist h where h.arm_carregamento_codigo = vCursorJunta.rCarregamento;
                                  delete TDVADM.T_ARM_CARREGAMENTOVEIC v WHERE v.ARM_CARREGAMENTO_CODIGO = VCURSORJUNTA.RCARREGAMENTO;
                                  select count(*)
                                    into vAuxiliar
                                  from TDVADM.T_arm_carregamentodet cd
                                  where cd.arm_carregamento_codigo = vCursorJunta.rCarregamento;
                                  If vAuxiliar = 0 Then
                                     delete TDVADM.T_arm_carregamento c where c.arm_carregamento_codigo = vCursorJunta.rCarregamento;
                                  End If;
                               End If; 



--                              End If;
                              vAuxiliar := vAuxiliar + 1;   
                           End Loop;       
                          
                       If pStatus <> TDVADM.PKG_GLB_COMMON.Status_Erro Then
                   
                          update TDVADM.T_arm_carregamento c
                            set c.arm_carregamento_qtdctrc = vAuxiliar,
                                c.arm_carregamento_qtdimpctrc = 0
                          where c.arm_carregamento_codigo = pCarregamento;   

                          pStatus :=  TDVADM.PKG_fifo_carregamento.FN_CARREG_ATUALIZA_PESOS(pCarregamento);
          --                commit;
                       End If;
                    End If;

               End If;
            End If;
         End IF;
         exception
           WHEN OTHERS Then
               -- Caso aconteca algum erro
               rollback;
               pStatus  := TDVADM.PKG_glb_common.Status_Erro;
--               pMessage := vSql || chr(10) ;
               pMessage := pMessage ||  'Ocorreu um erro '  || chr(10) || sqlerrm; 
               system.pkg_glb_context.sp_set_vlr_PROCESSOUNICO('SP_CON_JUNTACARREG','N');
               system.pkg_glb_context.sp_set_vlr_PROCESSOUNICO('SP_CON_JUNTACARREGFIM',to_char(sysdate,'dd/mm/yyyy hh24:mi:ss'));
           End;                   
--       End If; 
       If pStatus = TDVADM.PKG_GLB_COMMON.Status_Erro Then
          rollback;
       End If;

       pMessage := pMessage ||  'Final da Rotina '  || chr(10) ; 
       system.pkg_glb_context.sp_set_vlr_PROCESSOUNICO('SP_CON_JUNTACARREG','N');
       system.pkg_glb_context.sp_set_vlr_PROCESSOUNICO('SP_CON_JUNTACARREGFIM',to_char(sysdate,'dd/mm/yyyy hh24:mi:ss'));

    
  END SP_CON_JUNTACARREG;



/*

-- gera uma lista dos carregamentos com seus ctes
-- cancelados ou com serie XXX



                     update t_arm_carregamentodet cd 
                       set cd.arm_carregamento_codigo = tpCarreg.arm_carregamento_codigo
                     where cd.arm_carregamento_codigo = vCarreg
                       and cd.arm_embalagem_numero = R_CURSORCTE.Arm_Embalagem_Numero
                       and cd.arm_embalagem_flag = R_CURSORCTE.Arm_Embalagem_Flag
                       and cd.arm_embalagem_sequencia = R_CURSORCTE.Arm_Embalagem_Sequencia;
                 
                     update t_arm_nota n  
                       set n.arm_carregamento_codigo = tpCarreg.arm_carregamento_codigo
                     where n.arm_carregamento_codigo = vCarreg
                       and n.arm_nota_numero = R_CURSORCTE.Arm_Nota_Numero
                       and n.glb_cliente_cgccpfremetente = R_CURSORCTE.Glb_Cliente_Cgccpfremetente
                       and n.arm_nota_sequencia = R_CURSORCTE.Arm_Nota_Sequencia;
                       
                     update t_arm_embalagem n  
                       set n.arm_carregamento_codigo = tpCarreg.arm_carregamento_codigo
                     where n.arm_carregamento_codigo = vCarreg
                       and n.arm_embalagem_numero = R_CURSORCTE.Arm_Embalagem_Numero
                       and n.arm_embalagem_flag = R_CURSORCTE.Arm_Embalagem_Flag
                       and n.arm_embalagem_sequencia = R_CURSORCTE.Arm_Embalagem_Sequencia;

                     update t_con_conhecimento c
                       set c.arm_carregamento_codigo = tpCarreg.arm_carregamento_codigo                  
                     where c.arm_carregamento_codigo = vCarreg
                       and c.con_conhecimento_codigo = R_CURSORCTE.Con_Conhecimento_Codigo
                       and c.con_conhecimento_serie = R_CURSORCTE.Con_Conhecimento_Serie
                       and c.glb_rota_codigo = R_CURSORCTE.Glb_Rota_Codigo;

                     tpCarreg.Fcf_Veiculodisp_Codigo := tdvadm.pkg_fifo.fn_CriaVeicVirtual(tpCarreg.Arm_Carregamento_Codigo);
                     tpCarreg.Fcf_Veiculodisp_Sequencia := '0';

                     update t_arm_carregamento ca
                     set ca.fcf_veiculodisp_codigo =  tpCarreg.Fcf_Veiculodisp_Codigo,
                         ca.fcf_veiculodisp_sequencia = tpCarreg.Fcf_Veiculodisp_Sequencia
                     where ca.arm_carregamento_codigo = tpCarreg.Arm_Carregamento_Codigo;

                     pStatus :=  TDVADM.PKG_fifo_carregamento.FN_CARREG_ATUALIZA_PESOS(tpCarreg.arm_carregamento_codigo );


*/

  procedure SP_SIMULADOR2(pOrigem   in tdvadm.t_glb_localidade.glb_localidade_codigoibge%type,
                         pDestino  in tdvadm.t_glb_localidade.glb_localidade_codigoibge%type,
                         pPeso     in number,
                         pCliente  in tdvadm.t_glb_cliente.glb_cliente_cgccpfcodigo%type,
                         pGrupo    in tdvadm.t_glb_cliente.glb_grupoeconomico_codigo%type,
                         pContrato in tdvadm.t_slf_contrato.slf_contrato_codigo%type,
                         pCarga    in tdvadm.t_fcf_tpcarga.fcf_tpcarga_codigo%type,
                         pVeiculo  in tdvadm.t_fcf_tpveiculo.fcf_tpveiculo_codigo%type,
                         pXML      out clob,
                         pCursor   out tpCurosr,
                         pStatus   out char,
                         pMessage  out varchar2,
                         pSql      out CLOB)
  is
    vLocalidadeOri   tdvadm.t_Glb_Localidade.glb_localidade_codigo%type;
    vIBGEOri         tdvadm.t_Glb_Localidade.glb_localidade_codigoibge%type;
    vLocalidadeDes   tdvadm.t_Glb_Localidade.glb_localidade_codigo%type;
    vIBGEDes         tdvadm.t_Glb_Localidade.glb_localidade_codigoibge%type;
    vKm              number;
    vCliente         tdvadm.t_glb_cliente.glb_cliente_cgccpfcodigo%type;
    vGrupo           tdvadm.t_glb_grupoeconomico.glb_grupoeconomico_codigo%type;
    VContrato        tdvadm.t_slf_contrato.slf_contrato_codigo%type;
    vSQL             clob;
    vVERTPCARGAS        CHAR(3);
    vSACADOCARGA     TDVADM.T_GLB_CLIENTE.GLB_CLIENTE_CGCCPFCODIGO%TYPE;
    vGRUPOCARGAS     TDVADM.T_GLB_GRUPOECONOMICO.GLB_GRUPOECONOMICO_CODIGO%TYPE;
    vCONTRATOCARGAS  TDVADM.T_ARM_NOTA.SLF_CONTRATO_CODIGO%TYPE;
--  vPeso            number;
    vBusca_Frete        TpParamBuscaVerba;
    vRetBuscaFrete      TpBuscaVerba;
    vListaSIMcabecalho  tListaSIMcabecalho;
    vListaSIMsimulado   tListaSIMsimulado;
    vMessage        clob;
    cCARGAS tpCurosr;
    i integer := 0;
    
Begin
  
     -- TDVADM.PKG_Col_Coleta.Sp_Get_SimulaValorColeta
       
  
    pStatus  := TDVADM.PKG_glb_common.Status_Nomal;
    pMessage := '';
     
    vSQL  := empty_clob;
    vLocalidadeOri := tdvadm.fn_busca_codigoibge(trim(pOrigem),'LOC');
    vLocalidadeDes := tdvadm.fn_busca_codigoibge(trim(pDestino),'LOC');
    vIBGEOri := tdvadm.fn_busca_codigoibge(vLocalidadeOri,'IBC');
    vIBGEDes := tdvadm.fn_busca_codigoibge(vLocalidadeDes,'IBC');
     
    ListaQuebras.CLISAC   := pCliente;
    ListaQuebras.GRUPOEC  := pGrupo;
    ListaQuebras.CONTRATO := pContrato;

    select c.slf_contrato_descricao
      into ListaQuebras.CONTRATODESC
    from TDVADM.T_slf_contrato c
    where c.slf_contrato_codigo = ListaQuebras.CONTRATO  ;

    ListaQuebras.CNPJREM  := '12563794000180';
    ListaQuebras.CNPJDES  := '12563794000180';

    ListaQuebras.CLIENDREM   :='X';
    ListaQuebras.ORIGEMNOTA  := tdvadm.fn_busca_codigoibge(pOrigem,'LOC');
    ListaQuebras.CLIENDDES   := 'X';
    ListaQuebras.DESTINONOTA := tdvadm.fn_busca_codigoibge(pDestino,'LOC');
    ListaQuebras.ENTCOL      := 'E';
    ListaQuebras.FLAGPGTO    := 'S';
    ListaQuebras.TPTABSOL    := null;
    ListaQuebras.TABSOLCOD   := null;
    ListaQuebras.TABSOLSQ    := null;
    ListaQuebras.ccTPRATEIO  := '02';                          
    ListaQuebras.CONTAADOR   := 0;
     

    
    
    vVERTPCARGAS := TDVADM.PKG_slf_contrato.FN_SLF_CLIENTEREGRACARGA(ListaQuebras.CLISAC,ListaQuebras.CONTRATO,ListaQuebras.GRUPOEC);
        IF vVERTPCARGAS = 'GCT' THEN -- ACHOU POR GRUPO/CNPJ/CONTRADO
          VSACADOCARGA    := ListaQuebras.CLISAC;
          VGRUPOCARGAS    := ListaQuebras.GRUPOEC;
          VCONTRATOCARGAS := ListaQuebras.CONTRATO;
        ELSIF vVERTPCARGAS = 'GC' THEN -- ACHOU POR GRUPO/CNPJ
          VSACADOCARGA    := ListaQuebras.CLISAC;
          VGRUPOCARGAS    := ListaQuebras.GRUPOEC;
          VCONTRATOCARGAS := QualquerContrato;
        ELSIF vVERTPCARGAS = 'GT' THEN -- ACHOU GRUPO/CONTRATO
          VSACADOCARGA    := QualquerCliente;
          VGRUPOCARGAS    := ListaQuebras.GRUPOEC;
          VCONTRATOCARGAS := ListaQuebras.CONTRATO;
        ELSIF vVERTPCARGAS = 'G' THEN --ACHOU POR GRUPO
          VSACADOCARGA    := QualquerCliente;
          VGRUPOCARGAS    := ListaQuebras.GRUPOEC;
          VCONTRATOCARGAS := QualquerContrato;
        ELSIF vVERTPCARGAS = 'C' THEN --ACHOU POR CLIENTE
          VSACADOCARGA    := ListaQuebras.CLISAC;
          VGRUPOCARGAS    := QualquerGrupo;
          VCONTRATOCARGAS := QualquerContrato;
        ELSIF vVERTPCARGAS = 'T' THEN --ACHOU POR CONTRATO
          VSACADOCARGA    := QualquerCliente;
          VGRUPOCARGAS    := QualquerGrupo;
          VCONTRATOCARGAS := ListaQuebras.CONTRATO;
        ELSIF vVERTPCARGAS = 'QQQ' THEN --POR QUALQUER COISA
          VSACADOCARGA    := QualquerCliente;
          VGRUPOCARGAS    := QualquerGrupo;
          VCONTRATOCARGAS := QualquerContrato;
        ELSE
          VSACADOCARGA    := QualquerCliente;
          VGRUPOCARGAS    := QualquerGrupo;
          VCONTRATOCARGAS := QualquerContrato;
        END IF;


    spi_SqlSacGrupoContrato(vSACADOCARGA,vGRUPOCARGAS,vCONTRATOCARGAS);
   
     -- Montando o Cabecalho
     -- Montado o Simulado


    vBusca_Frete.vLOCALIDADEORIGEM  := ListaQuebras.ORIGEMNOTA;  -- ListaNotas.cnORIGEM
    vBusca_Frete.vLOCALIDADEDESTINO := ListaQuebras.DESTINONOTA; -- ListaNotas.cnDESTINO

    vBusca_Frete.vTIPOFRETE         := 'CIF'; -- Ver Depois
    vBusca_Frete.vTPCARGA           := ListaCargaCli.ccTPCARGACLI;
    vBusca_Frete.vRATEIA            := ListaCargaCli.ccRATEIA;
    vBusca_Frete.vPESOMINIMO        := ListaCargaCli.ccPESOMINIMO;
    vBusca_Frete.vCLIENTE           := vSACADOCARGA;
    vBusca_Frete.vGRUPO             := vGRUPOCARGAS; --NO CASO DE LOTACAO PARA PEGAR O TIPO DE VEICULO USANDO O PESO TOTAL DA CARGA
    vBusca_Frete.vCONTRATO          := vCONTRATOCARGAS;
    vBusca_Frete.vTPVEICULO         := pVeiculo; --V_CODIGOVEICULO;
    vBusca_Frete.vKM                := fni_ConsultaKM(vBusca_Frete.vLOCALIDADEORIGEM,vBusca_Frete.vLOCALIDADEDESTINO);
    vBusca_Frete.vPESO              := pPeso;
    vBusca_Frete.vPESOTOTAL         := pPeso;
    vBusca_Frete.vEntCol            := ListaQuebras.ENTCOL;
    ListaVaux.cnColetaValor     := 0;
    ListaVaux.cnSomaPesoQP      := 0;

    vListaSIMcabecalho(1).titulo           := 'LOCALIDADE';
    vListaSIMcabecalho(1).codigoOrigem     := vBusca_Frete.vLOCALIDADEORIGEM;
    vListaSIMcabecalho(1).descricaoOrigem  := tdvadm.fn_busca_codigoibge(vBusca_Frete.vLOCALIDADEORIGEM,'IBD');
    vListaSIMcabecalho(1).codigoDestino    := vBusca_Frete.vLOCALIDADEDESTINO;
    vListaSIMcabecalho(1).descricaoDestino := tdvadm.fn_busca_codigoibge(vBusca_Frete.vLOCALIDADEDESTINO,'IBD');
    vListaSIMcabecalho(1).km               := '';
    vListaSIMcabecalho(1).peso             := '';

    vListaSIMcabecalho(2).titulo           := 'IBGE';
    vListaSIMcabecalho(2).codigoOrigem     := tdvadm.fn_busca_codigoibge(vBusca_Frete.vLOCALIDADEORIGEM,'IBC');
    vListaSIMcabecalho(2).descricaoOrigem  := tdvadm.fn_busca_codigoibge(vBusca_Frete.vLOCALIDADEORIGEM,'IBD');
    vListaSIMcabecalho(2).codigoDestino    := tdvadm.fn_busca_codigoibge(vBusca_Frete.vLOCALIDADEDESTINO,'IBC');
    vListaSIMcabecalho(2).descricaoDestino := tdvadm.fn_busca_codigoibge(vBusca_Frete.vLOCALIDADEDESTINO,'IBD');
    vListaSIMcabecalho(2).km               := '';
    vListaSIMcabecalho(2).peso             := ''; 

    vListaSIMcabecalho(3).titulo           := 'KM:';
    vListaSIMcabecalho(3).codigoOrigem     := vBusca_Frete.vKM;
    vListaSIMcabecalho(3).descricaoOrigem  := 'PESO :';
    vListaSIMcabecalho(3).codigoDestino    := '';
    vListaSIMcabecalho(3).descricaoDestino := '';
    vListaSIMcabecalho(3).km               := '';
    vListaSIMcabecalho(3).peso             := ''; 
     
    OPEN cCARGAS FOR ListaSQL.FINALCARG;
    pCursor := cCARGAS;
    i := 1;            
    LOOP
       FETCH cCARGAS
          into ListaCargaCli;
       exit when cCARGAS%notfound;


           vBusca_Frete.vOrigem := 'SP_SIMULADOR2'; 
           vBusca_Frete.vPesqFRETECOLETA := 'F';
           SP_BUSCA_FRETEEMPRESA(vBusca_Frete,
                                 ListaCargaCli,
                                 vRetBuscaFrete,
                                 vMessage);


                    if nvl(vBusca_Frete.vPESOTOTAL,-1) = -1 Then
                       pMessage := pMessage || chr(10) || 'Peso Total Nao Apurado SIMULADOR ';
                       pStatus := TDVADM.PKG_glb_common.Status_Erro;
                    End If;
                    
                    
--                    ListaNotas.cnTABSOLCOD := vRetBuscaFrete.SLF_TABELA_CODIGO;
--                    ListaNotas.cnTABSOLSQ  := vRetBuscaFrete.SLF_TABELA_SAQUE;
--                    ListaNotas.cnTABSOL    := 'T';  
                    
                    pMessage := pMessage || chr(10) || 'Retorno ' || vRetBuscaFrete.vRetorno || ' Carga ' || ListaCargaCli.ccTPCARGACLIPESQ || '-' || vMessage;


                    if vRetBuscaFrete.vRetorno <>  'NE' Then
                        vListaSIMsimulado(i).titulo         := ListaCargaCli.ccTPCARGACLIDESC;
                        vListaSIMsimulado(i).kmDe           := vRetBuscaFrete.SLF_CALCFRETEKM_KMDE;
                        vListaSIMsimulado(i).kmAte          := vRetBuscaFrete.SLF_CALCFRETEKM_KMATE;
                        vListaSIMsimulado(i).pesoDe         := vRetBuscaFrete.SLF_CALCFRETEKM_PESODE;
                        vListaSIMsimulado(i).pesoAte        := vRetBuscaFrete.SLF_CALCFRETEKM_PESOATE;
                        vListaSIMsimulado(i).tabTdv         := vRetBuscaFrete.SLF_TABELA_CODIGO;
                        vListaSIMsimulado(i).saqTdv         := vRetBuscaFrete.SLF_TABELA_SAQUE;
                        vListaSIMsimulado(i).tipo           := vRetBuscaFrete.SLF_TABELA_TIPO;
                        vListaSIMsimulado(i).veiculo        := vRetBuscaFrete.FCF_TPVEICULO_CODIGO;
                        vListaSIMsimulado(i).tipoCarga      := vRetBuscaFrete.FCF_TPCARGA_CODIGO;
                        vListaSIMsimulado(i).valor          := vRetBuscaFrete.SLF_CALCFRETEKM_VALOR;
                        vListaSIMsimulado(i).Desinencia     := vRetBuscaFrete.SLF_CALCFRETEKM_DESINENCIA;
                        vListaSIMsimulado(i).limite         := vRetBuscaFrete.SLF_CALCFRETEKM_LIMITE;
                        vListaSIMsimulado(i).valorExcedente := vRetBuscaFrete.SLF_CALCFRETEKM_VALORE;
                        vListaSIMsimulado(i).valorFixo      := vRetBuscaFrete.SLF_CALCFRETEKM_VALORF;
                        vListaSIMsimulado(i).valorCalculado := 0;
                        vListaSIMsimulado(i).codigoCliente  := vRetBuscaFrete.SLF_CALCFRETEKM_CODCLI;
                        vListaSIMsimulado(i).perctEx        := ListaCargaCli.ccPERCTEX;
                        vListaSIMsimulado(i).perctQM        := ListaCargaCli.ccPERCTQM;
                        vListaSIMsimulado(i).perctOutb      := ListaCargaCli.ccPERCTOUT;
                        vListaSIMsimulado(i).perctTrans     := ListaCargaCli.ccPERCTRA;
                        vListaSIMsimulado(i).soTransf       := ListaCargaCli.ccSOTRANSF;

                        i := i + 1;
                   End If;
                           
     
    End Loop;

    pxml :=         '<simulador>';
    pxml := pxml || '   <cabecalhos>';
    i := 1;            
    loop
      Begin
      If nvl(vListaSIMcabecalho(i).titulo,'X') <> 'X' Then
          pxml := pxml || '<cabecalho>';
          pxml := pxml || '  <titulo>'           || vListaSIMcabecalho(i).titulo           || '</titulo>';
          pxml := pxml || '  <codigoOrigem>'     || vListaSIMcabecalho(i).codigoOrigem     || '</codigoOrigem>';
          pxml := pxml || '  <descricaoOrigem>'  || vListaSIMcabecalho(i).descricaoOrigem  || '</descricaoOrigem>';
          pxml := pxml || '  <codigoDestino>'    || vListaSIMcabecalho(i).codigoDestino    || '</codigoDestino>';
          pxml := pxml || '  <descricaoDestino>' || vListaSIMcabecalho(i).descricaoDestino || '</descricaoDestino>';
          pxml := pxml || '  <km>'               || vListaSIMcabecalho(i).km               || '</km>';
          pxml := pxml || '  <peso>'             || vListaSIMcabecalho(i).peso             || '</peso>';
          pxml := pxml || '</cabecalho>';  
      End If;
      i := i + 1;
      exception
        When NO_DATA_FOUND Then
            exit;
        End ;
    end loop;                

    pxml := pxml || '   </cabecalhos>';


    pxml := pxml || '   <simulados>';
    i := 1;            
    loop
      Begin
         If nvl(vListaSIMsimulado(i).titulo,'X') <> 'X' Then
             pxml := pxml || '<simulado>';
             pxml := pxml || '   <titulo>'         || vListaSIMsimulado(i).titulo         || '</titulo>';
             pxml := pxml || '   <kmDe>'           || vListaSIMsimulado(i).kmDe           || '</kmDe>';
             pxml := pxml || '   <kmAte>'          || vListaSIMsimulado(i).kmAte          || '</kmAte>';
             pxml := pxml || '   <pesoDe>'         || vListaSIMsimulado(i).pesoDe         || '</pesoDe>';
             pxml := pxml || '   <pesoAte>'        || vListaSIMsimulado(i).pesoAte        || '</pesoAte>';
             pxml := pxml || '   <tabTdv>'         || vListaSIMsimulado(i).tabTdv         || '</tabTdv>';
             pxml := pxml || '   <saqTdv>'         || vListaSIMsimulado(i).saqTdv         || '</saqTdv>';
             pxml := pxml || '   <tipo>'           || vListaSIMsimulado(i).tipo           || '</tipo>';
             pxml := pxml || '   <veiculo>'        || vListaSIMsimulado(i).veiculo        || '</veiculo>';
             pxml := pxml || '   <tipoCarga>'      || vListaSIMsimulado(i).tipoCarga      || '</tipoCarga>';
             If trim(vListaSIMsimulado(i).Desinencia) = 'TX' Then
                pxml := pxml || '   <valor>'          || vListaSIMsimulado(i).valor * nvl(pPeso,1)         || '</valor>';
             Else
                pxml := pxml || '   <valor>'          || vListaSIMsimulado(i).valor          || '</valor>';
             End If; 
             pxml := pxml || '   <limite>'         || vListaSIMsimulado(i).limite         || '</limite>';
             pxml := pxml || '   <valorExcedente>' || vListaSIMsimulado(i).valorExcedente || '</valorExcedente>';
             pxml := pxml || '   <valorFixo>'      || vListaSIMsimulado(i).valorFixo      || '</valorFixo>';
             pxml := pxml || '   <valorCalculado>' || vListaSIMsimulado(i).valorCalculado || '</valorCalculado>';
             pxml := pxml || '   <codigoCliente>'  || vListaSIMsimulado(i).codigoCliente  || '</codigoCliente>';
             pxml := pxml || '   <perctEx>'        || vListaSIMsimulado(i).perctEx        || '</perctEx>';
             pxml := pxml || '   <perctQM>'        || vListaSIMsimulado(i).perctQM        || '</perctQM>';    
             pxml := pxml || '   <perctOutb>'      || vListaSIMsimulado(i).perctOutb      || '</perctOutb>'; 
             pxml := pxml || '   <perctTrans>'     || vListaSIMsimulado(i).perctTrans     || '</perctTrans>';    
             pxml := pxml || '   <soTransf>'       || vListaSIMsimulado(i).soTransf       || '</soTransf>';
             pxml := pxml || '</simulado>';
         End If;
      i := i + 1;

      exception
        When NO_DATA_FOUND Then
            exit;
        End ;
    end loop;                
    pxml := pxml || '   </simulados>';
    pxml := pxml || '</simulador>';

    pSql := ListaSQL.FINALCARG;
  
  End SP_SIMULADOR2;                         

  procedure SP_SIMULADOR(pXMLin    in varchar2,
                         pXML      out clob,
--                         pCursor   out tpCurosr,
                         pStatus   out char,
                         pMessage  out varchar2)                         
  is
    vPula            char(1);
    vLocalidadeOri   tdvadm.t_Glb_Localidade.glb_localidade_codigo%type;
    vIBGEOri         tdvadm.t_Glb_Localidade.glb_localidade_codigoibge%type;
    vLocalidadeDes   tdvadm.t_Glb_Localidade.glb_localidade_codigo%type;
    vIBGEDes         tdvadm.t_Glb_Localidade.glb_localidade_codigoibge%type;
    vKm              number;
    vClienteREM      tdvadm.t_glb_cliente.glb_cliente_cgccpfcodigo%type;
    vClienteREMTE    tdvadm.t_glb_cliend.glb_tpcliend_codigo%type;
    vGrupoREM        tdvadm.t_glb_grupoeconomico.glb_grupoeconomico_codigo%type;
    vClienteDES      tdvadm.t_glb_cliente.glb_cliente_cgccpfcodigo%type;
    vClienteDESTE    tdvadm.t_glb_cliend.glb_tpcliend_codigo%type;
    vGrupoDES        tdvadm.t_glb_grupoeconomico.glb_grupoeconomico_codigo%type;

    vCliente         tdvadm.t_glb_cliente.glb_cliente_cgccpfcodigo%type;
    vGrupo           tdvadm.t_glb_grupoeconomico.glb_grupoeconomico_codigo%type;
    vGrupoUsu        tdvadm.t_glb_grupoeconomico.glb_grupoeconomico_codigo%type;
    VContrato        tdvadm.t_slf_contrato.slf_contrato_codigo%type;
    vSQL             clob;
    vVERTPCARGAS        CHAR(3);
    vSACADOCARGA     TDVADM.T_GLB_CLIENTE.GLB_CLIENTE_CGCCPFCODIGO%TYPE;
    vGRUPOCARGAS     TDVADM.T_GLB_GRUPOECONOMICO.GLB_GRUPOECONOMICO_CODIGO%TYPE;
    vCONTRATOCARGAS  TDVADM.T_ARM_NOTA.SLF_CONTRATO_CODIGO%TYPE;
    vBusca_Frete        TpParamBuscaVerba;
    vRetBuscaFrete      TpBuscaVerba;
    vListaSIMcabecalho  tListaSIMcabecalho;
    vListaSIMsimulado   tListaSIMsimulado;
    vMessage          clob;
    vColetas          varchar2(200);
    vColeta           char(10);
    vVeiculo          tdvadm.t_arm_coleta.fcf_tpveiculo_codigo%type;
    vUsuario          TDVADM.T_usu_usuario.usu_usuario_codigo%type;
    vPeso             number;
    vMercadoria       number;
    vQuimico          char(1);
    vOnu              varchar2(30);
    vExpresso         char(1);
    vAuxiliarPesoRateio  number;
    vAuxiliarFatorRateio number;
    vFormulaTraduzidaF tdvadm.v_slf_clientecargas2.slf_clientecargas_formulafrtx%type;
    vFormulaTraduzidaP tdvadm.v_slf_clientecargas2.slf_clientecargas_formulafrtx%type;
    cCARGAS   tpCurosr;
    cSIMULADO tpCurosr;
    vPrClausula  char(1);
    vTpCalculo   tdvadm.t_slf_tpcalculo.slf_tpcalculo_codigo%type;
    
    vXMLin  varchar2(2000);
    t integer := 0;  -- Origens e Destinos
    i integer := 0;  -- Itens de Precos
    ia Integer := 0; -- Ultimo Item do Destino Anterior
    
    vListaColetas glbadm.pkg_listas.tListaColetas;
    
Begin
    -- Variavel para controlar as clausulas do Where
    -- Quando Nao temos Coletas
    vPrClausula := 'S';

    vXMLin := pXMLin;
    
    
    
    if vXMLin is null Then

         vXMLin := vXMLin || '<Parametros> ';
         vXMLin := vXMLin || '   <Inputs> ';
         vXMLin := vXMLin || '      <Input> ';
         vXMLin := vXMLin || '         <usuario>sdrumond</usuario>'; /*obrigatorio*/
         vXMLin := vXMLin || '         <cnpj>12563794000180</cnpj>'; /*obrigatorio*/
         vXMLin := vXMLin || '         <grupo>0074</grupo>';
         vXMLin := vXMLin || '         <contrato>82795</contrato>';
         vXMLin := vXMLin || '         <origem>35500</origem>';
         vXMLin := vXMLin || '         <destino>30000</destino>';
         vXMLin := vXMLin || '         <veiculo>3</veiculo>';
         vXMLin := vXMLin || '         <peso>1000</peso>';
         vXMLin := vXMLin || '         <mercadoria>1000.98</mercadoria>';
         vXMLin := vXMLin || '         <onu>3241</onu>';
         vXMLin := vXMLin || '         <expresso>S</expresso>';
         vXMLin := vXMLin || '      </Input> ';
         vXMLin := vXMLin || '      <Tables>'; 
         vXMLin := vXMLin || '         <table name="listaColetas" tipo="P">';
         vXMLin := vXMLin || '            <Rowset>';
         vXMLin := vXMLin || '               <row num="1">';
         vXMLin := vXMLin || '                  <arm_coleta_ncompra>845604</arm_coleta_ncompra>';
         vXMLin := vXMLin || '                  <arm_coleta_ciclo>001</arm_coleta_ciclo>';
         vXMLin := vXMLin || '               </row>';
         vXMLin := vXMLin || '               <row num="2">';
         vXMLin := vXMLin || '                  <arm_coleta_ncompra>845323</arm_coleta_ncompra>';
         vXMLin := vXMLin || '                  <arm_coleta_ciclo>001</arm_coleta_ciclo>';
         vXMLin := vXMLin || '               </row>';
         vXMLin := vXMLin || '            </Rowset>';
         vXMLin := vXMLin || '         </table>';
         vXMLin := vXMLin || '      </Tables>';
         vXMLin := vXMLin || '   </Inputs> ';
         vXMLin := vXMLin || '</Parametros> ';
--         insert into TDVADM.T_glb_sql values (vXMLin,sysdate,'SIMULADOR','SIMULADORFX');
--         commit;
    Else
--      insert into TDVADM.T_glb_sql values (vXMLin,sysdate,'SIMULADOR','SIMULADORIN');
--      commit;
      pMessage := pMessage;
    End If;
    
    if not glbadm.pkg_listas.FN_Get_ListaColetas(vXMLin,vListaColetas,pMessage) Then
       pMessage := pMessage; 
    End If;

    if vListaColetas.count = 0 Then
       vColetas := '';
    Else
        i:= 1;
        vColetas := '';
        loop
           Begin
              vColetas := vColetas || vListaColetas(i).arm_coleta_ciclo || vListaColetas(i).arm_coleta_ncompra || ',';
              i := i + 1;
           exception
             When NO_DATA_FOUND Then
                exit;
             End;
             
        end loop;
       
        /*select * 
        from t_arm_coleta co
        where co.arm_coleta_ciclo || co.arm_coleta_ncompra in (vColetas);*/

        ListaQuebras.CONTAADOR   := 0;
      
    End If;
  
         -- Pkg_Col_Coleta.Sp_Get_SimulaValorColeta
        pStatus  := TDVADM.PKG_glb_common.Status_Nomal;
        pMessage := '';

        vUsuario       := substr(trim(Glbadm.pkg_glb_WsInterfaceDB.Fn_GetParam( vXMLin,'usuario' )),1,10);

        vLocalidadeOri := trim(Glbadm.pkg_glb_WsInterfaceDB.Fn_GetParam( vXMLin,'origem' ));
        vLocalidadeDes := trim(Glbadm.pkg_glb_WsInterfaceDB.Fn_GetParam( vXMLin,'destino' ));
        vCliente       := trim(Glbadm.pkg_glb_WsInterfaceDB.Fn_GetParam( vXMLin,'cnpj' ));
        vGrupo         := trim(Glbadm.pkg_glb_WsInterfaceDB.Fn_GetParam( vXMLin,'grupo' ));
        VContrato      := trim(Glbadm.pkg_glb_WsInterfaceDB.Fn_GetParam( vXMLin,'contrato' ));
        vVeiculo       := trim(Glbadm.pkg_glb_WsInterfaceDB.Fn_GetParam( vXMLin,'veiculo' ));
        vPeso          := trim(Glbadm.pkg_glb_WsInterfaceDB.Fn_GetParam( vXMLin,'peso' ));
        vMercadoria    := trim(Glbadm.pkg_glb_WsInterfaceDB.Fn_GetParam( vXMLin,'mercadoria' ));
        vExpresso      := Trim(Glbadm.pkg_glb_WsInterfaceDB.Fn_GetParam( vXMLin,'expressa' ));
        vQuimico := 'N';
        vOnu :=  nvl(trim(Glbadm.pkg_glb_WsInterfaceDB.Fn_GetParam( vXMLin,'onu' )),'9999-SE');
        if vOnu in ('9999-SE','0-SE') Then
           vQuimico := 'N';
        Else   
           vQuimico := 'S';
        End If;   

        VContrato := nvl(VContrato,QualquerContrato);
        vCliente  := nvl(vCliente ,QualquerCliente);

        -- Pega o Grupo Do Usuario
        begin 
           select cl.glb_grupoeconomico_codigo
             into vGrupoUsu
           from TDVADM.T_glb_cliente cl
           where cl.glb_cliente_cgccpfcodigo =  rpad(vCliente,20);
        exception
          When NO_DATA_FOUND Then
              vGrupoUsu:= QualquerGrupo;
          End ;      

        if vUsuario = 'sdrumond' Then   
           vGrupoUsu := QualquerGrupo;
        End If;   

        If vGrupo is null Then
           vGrupo := vGrupoUsu;
        End If;
          
        vSQL  := empty_clob;
        if vColetas is not null Then
            vSQL := vSQL || 'select ';
--            vSQL := vSQL || '       ca.arm_coleta_ciclo || ' ||  TDVADM.PKG_glb_common.Fn_QuotedStr('-')  || ' || ca.arm_coleta_ncompra COLETA, ';
            vSQL := vSQL || '       co.glb_localidade_codigo origem, ';
            vSQL := vSQL || '       cd.glb_localidade_codigo destino, ';
--            vSQL := vSQL || '       substr(cl.glb_cliente_cgccpfcodigo,1,8) sacado, ';
--            vSQL := vSQL || '       co.glb_cliente_cgccpfcodigo remetente, ';
--            vSQL := vSQL || '       co.glb_tpcliend_codigo tpcliendrem, ';
--            vSQL := vSQL || '       cd.glb_cliente_cgccpfcodigo destinatario, ';
--            vSQL := vSQL || '       cd.glb_tpcliend_codigo tpclienddes, ';
            vSQL := vSQL || '       cl.glb_cliente_cgccpfcodigo sacado, ';
            vSQL := vSQL || '       cl.glb_grupoeconomico_codigo grupo, ';
            vSQL := vSQL || '       ct.slf_contrato_codigo contrato, ';
            vSQL := vSQL || '       ca.fcf_tpveiculo_codigo veiculo, ';
            vSQL := vSQL || '       sum(ca.arm_coleta_peso) peso, ';
            vSQL := vSQL || '       sum(ca.Arm_Coleta_Vlmercadoria) mercadoria, ';
            vSQL := vSQL || '       ca.arm_coleta_flagquimico quimico, ';
            vSQL := vSQL || '       ca.arm_coleta_tpcoleta expresso '  ;          
            vSQL := vSQL || 'from TDVADM.T_arm_coleta ca, ';
            vSQL := vSQL || '     TDVADM.T_glb_cliend co, ';
            vSQL := vSQL || '     TDVADM.T_glb_cliend cd, ';
            vSQL := vSQL || '     TDVADM.T_glb_cliente cl, ';
            vSQL := vSQL || '     TDVADM.T_slf_contrato ct ';
            vSQL := vSQL || 'where 0 = 0 ';
            vSQL := vSQL || '  and instr(' || TDVADM.PKG_glb_common.Fn_QuotedStr(vColetas) || ',ca.arm_coleta_ciclo || ca.arm_coleta_ncompra) > 0 ';
            vSQL := vSQL || '  and ca.arm_coleta_cnpjsolicitante is not null ';
            vSQL := vSQL || '  and CT.SLF_CONTRATO_DTFINAL IS NULL ';
            vSQL := vSQL || '  and ca.glb_cliente_cgccpfcodigocoleta = co.glb_cliente_cgccpfcodigo ';
            vSQL := vSQL || '  and ca.glb_tpcliend_codigocoleta      = co.glb_tpcliend_codigo ';
            vSQL := vSQL || '  and ca.glb_cliente_cgccpfcodigoentreg = cd.glb_cliente_cgccpfcodigo ';
            vSQL := vSQL || '  and ca.glb_tpcliend_codigoentrega     = cd.glb_tpcliend_codigo ';
--            vSQL := vSQL || '  and ( cl.glb_cliente_cgccpfcodigo = co.glb_cliente_cgccpfcodigo or cl.glb_cliente_cgccpfcodigo = cd.glb_cliente_cgccpfcodigo ) ';
--            if vGrupoUsu is null Then
               vSQL := vSQL || '  and cl.glb_cliente_cgccpfcodigo = decode(ca.arm_coleta_pagadorfrete,''R'',ca.glb_cliente_cgccpfcodigocoleta,
                                                                                                      ''D'',ca.glb_cliente_cgccpfcodigoentreg,
                                                                                                            ca.arm_coleta_solicitante) ';
--               vSQL := vSQL || '  and ca.arm_coleta_cnpjsolicitante     = cl.glb_cliente_cgccpfcodigo ';
--            Else
--               vSQL := vSQL || '  and ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vGrupoUsu) || ' = cl.glb_grupoeconomico_codigo ';
--            End If;
            vSQL := vSQL || '  and cl.glb_grupoeconomico_codigo      = ct.glb_grupoeconomico_codigo ';
            vSQL := vSQL || '  and trunc(ct.slf_contrato_dtinicio) <= trunc(sysdate) ';
            vSQL := vSQL || '  and ct.slf_contrato_dtfinal is null ';
            vSQL := vSQL || 'group by ';
--            vSQL := vSQL || '         ca.arm_coleta_ciclo || ca.arm_coleta_ncompra, ';
            vSQL := vSQL || '         co.glb_localidade_codigo, ';
            vSQL := vSQL || '         cd.glb_localidade_codigo, ';
--            vSQL := vSQL || '         substr(cl.glb_cliente_cgccpfcodigo,1,8) , ';
            vSQL := vSQL || '         cl.glb_cliente_cgccpfcodigo, ';
            vSQL := vSQL || '         cl.glb_grupoeconomico_codigo, ';
            vSQL := vSQL || '         ct.slf_contrato_codigo, ';
            vSQL := vSQL || '         ca.fcf_tpveiculo_codigo, ';
            vSQL := vSQL || '         ca.arm_coleta_flagquimico, ';
            vSQL := vSQL || '         ca.arm_coleta_tpcoleta ';
--            vSQL := vSQL || 'order by 1,2,3 ';         
       End IF;
       if ( vLocalidadeOri is not null ) and ( vColetas is not null ) Then
            vSQL := vSQL || 'union ';
       End If;
        
       if ( vLocalidadeOri is not null ) Then
/*         
            vSQL := vSQL || 'select ' ;
--            vSQL := vSQL ||        || TDVADM.PKG_glb_common.Fn_QuotedStr('000-000000') || ' COLETA, ';
            vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vLocalidadeOri) || ' origem, ';
            vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vLocalidadeDes) || ' destino, ';
--            vSQL := vSQL || '       substr(' || TDVADM.PKG_glb_common.Fn_QuotedStr(vCliente) || ',1,8) sacado, ';
--            vSQL := vSQL || '       null remetente, ';
--            vSQL := vSQL || '       null destinatario, ';
            vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vCliente) || ' sacado, ';
            vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vGrupo) || ' grupo, ';
            vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(VContrato) || ' contrato, ';
            vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vVeiculo) || ' veiculo, ';
            vSQL := vSQL || '       ' || to_char(vPeso) || ' peso, ';
            vSQL := vSQL || '       ' || nvl(to_char(vMercadoria),0) || ' mercadoria, ';
            vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vQuimico) || ' Quimico ';
            vSQL := vSQL || 'From Dual ';         

             if ( vCliente <> QualquerCliente ) and ( vGrupo <> QualquerGrupo ) Then
                  vSQL := vSQL || 'Union ';
                  vSQL := vSQL || 'select ' ;
      --            vSQL := vSQL ||        || TDVADM.PKG_glb_common.Fn_QuotedStr('000-000000') || ' COLETA, ';
                  vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vLocalidadeOri) || ' origem, ';
                  vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vLocalidadeDes) || ' destino, ';
      --            vSQL := vSQL || '       substr(' || TDVADM.PKG_glb_common.Fn_QuotedStr(vCliente) || ',1,8) sacado, ';
      --            vSQL := vSQL || '       null remetente, ';
      --            vSQL := vSQL || '       null destinatario, ';
                  vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(QualquerCliente) || ' sacado, ';
                  vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vGrupo) || ' grupo, ';
                  vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(VContrato) || ' contrato, ';
                  vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vVeiculo) || ' veiculo, ';
                  vSQL := vSQL || '       ' || to_char(vPeso) || ' peso, ';
                  vSQL := vSQL || '       ' || nvl(to_char(vMercadoria),0) || ' mercadoria, ';
                  vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vQuimico) || ' Quimico ';
                  vSQL := vSQL || 'From Dual ';         
             End If;
             vSQL := vSQL || 'order by 1,2,3 ';         
       End If;
*/       
           if ( vGrupo <> QualquerGrupo or 
                VContrato <> QualquerContrato or  
                vCliente <> QualquerCliente ) Then
              vSQL := vSQL || 'select distinct ' ;
      --        vSQL := vSQL ||        || TDVADM.PKG_glb_common.Fn_QuotedStr('000-000000') || ' COLETA, ';
              vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vLocalidadeOri) || ' origem, ';
              vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vLocalidadeDes) || ' destino, ';
      --        vSQL := vSQL || '       substr(' || TDVADM.PKG_glb_common.Fn_QuotedStr(vCliente) || ',1,8) sacado, ';
      --        vSQL := vSQL || '       null remetente, ';
      --        vSQL := vSQL || '       null destinatario, ';
              vSQL := vSQL || '         ce.glb_cliente_cgccpfcodigo  sacado, ';
              vSQL := vSQL || '         ce.glb_grupoeconomico_codigo grupo, ';
              vSQL := vSQL || '         ce.slf_contrato_codigo       contrato, ';
              vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vVeiculo) || ' veiculo, ';
              vSQL := vSQL || '       ' || to_char(vPeso) || ' peso, ';
              vSQL := vSQL || '       ' || nvl(to_char(vMercadoria),0) || ' mercadoria, ';
              vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vQuimico) || ' Quimico, ';
              vSQL := vSQL || '       ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vExpresso) || ' Expresso ';
              vSQL := vSQL || 'From TDVADM.T_slf_clientecargas ce ';         
              vSQL := vSQL || 'Where ce.SLF_CLIENTECARGAS_ATIVO = ''S''';
              vSQL := vSQL || '  and ce.SLF_CLIENTECARGAS_VIGENCIA = (SELECT MAX(CC1.SLF_CLIENTECARGAS_VIGENCIA) ';
              vSQL := vSQL || '                                       FROM TDVADM.T_SLF_CLIENTECARGAS CC1 ';
              vSQL := vSQL || '                                       WHERE CC1.GLB_GRUPOECONOMICO_CODIGO     = ce.GLB_GRUPOECONOMICO_CODIGO ';
              vSQL := vSQL || '                                         AND CC1.GLB_CLIENTE_CGCCPFCODIGO      = ce.glb_cliente_cgccpfcodigo ';
              vSQL := vSQL || '                                         AND CC1.FCF_TPCARGA_CODIGO            = ce.FCF_TPCARGA_CODIGO ';
              vSQL := vSQL || '                                         AND CC1.SLF_CONTRATO_CODIGO           = ce.SLF_CONTRATO_CODIGO ';
              vSQL := vSQL || '                                         AND CC1.SLF_TPFRETE_CODIGO            = ce.SLF_TPFRETE_CODIGO ';
              vSQL := vSQL || '                                         AND CC1.FCF_TPCARGA_CODIGOPESQ        = ce.FCF_TPCARGA_CODIGOPESQ ';
              vSQL := vSQL || '                                         AND CC1.SLF_CLIENTECARGAS_PCOBRANCA   = ce.SLF_CLIENTECARGAS_PCOBRANCA ';
--              vSQL := vSQL || '                                         AND CC1.SLF_CLIENTECARGAS_FIXAORIGEM  = ce.SLF_CLIENTECARGAS_FIXAORIGEM ';
--              vSQL := vSQL || '                                         AND CC1.SLF_CLIENTECARGAS_FIXADESTINO = ce.SLF_CLIENTECARGAS_FIXADESTINO ';
              vSQL := vSQL || '              ) and (';
--              vSQL := vSQL || '  AND ce.FCF_TPCARGA_CODIGO = TC.FCF_TPCARGA_CODIGO ';
--              vSQL := vSQL || '  AND ce.SLF_TPFRETE_CODIGO = TF.SLF_TPFRETE_CODIGO and (';
              if  vCliente <> QualquerCliente AND  vGrupo <> QualquerGrupo Then 
                 if vPrClausula = 'N' Then
                    vSQL := vSQL || ' or ';
                 Else
                    vPrClausula := 'N';
                 End If;                    
                 vSQL := vSQL || ' ( ce.glb_cliente_cgccpfcodigo = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vCliente) || ' and ce.glb_grupoeconomico_codigo = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vGrupo) || ' ) ';              
              End If; 
              if  vCliente <> QualquerCliente AND  VContrato <> QualquerContrato Then                
                 if vPrClausula = 'N' Then
                    vSQL := vSQL || ' or ';
                 Else
                    vPrClausula := 'N';
                 End If;                    
                 vSQL := vSQL || ' ( ce.glb_cliente_cgccpfcodigo = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vCliente) || ' and ce.slf_contrato_codigo = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(VContrato) || ' )';              
              End If; 
              if  vGrupo <> QualquerGrupo AND  VContrato <> QualquerContrato  Then                
                 if vPrClausula = 'N' Then
                    vSQL := vSQL || ' or ';
                 Else
                    vPrClausula := 'N';
                 End If;                    
                 vSQL := vSQL || ' ( ce.glb_grupoeconomico_codigo = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vGrupo) || ' and ce.slf_contrato_codigo = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(VContrato) || ' )';              
              End If;


              if  vCliente = QualquerCliente or vGrupo <> QualquerGrupo Then                
                 if vPrClausula = 'N' Then
                    vSQL := vSQL || ' or ';
                 Else
                    vPrClausula := 'N';
                 End If;                    
                 vSQL := vSQL || ' ( ce.glb_cliente_cgccpfcodigo = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(QualquerCliente) || ' and ce.glb_grupoeconomico_codigo = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vGrupo) || ' ) ';  
              End If; 
              if  vCliente <> QualquerCliente or  vGrupo = QualquerGrupo Then                
                 if vPrClausula = 'N' Then
                    vSQL := vSQL || ' or ';
                 Else
                    vPrClausula := 'N';
                 End If;                    
                 vSQL := vSQL || ' ( ce.glb_cliente_cgccpfcodigo = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vCliente) || ' and ce.glb_grupoeconomico_codigo = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(QualquerGrupo) || ' )  ';              
              End If; 

              if  vCliente = QualquerCliente or  VContrato <> QualquerContrato Then                
                 if vPrClausula = 'N' Then
                    vSQL := vSQL || ' or ';
                 Else
                    vPrClausula := 'N';
                 End If;                    
                 vSQL := vSQL || ' ( ce.glb_cliente_cgccpfcodigo = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(QualquerCliente) || ' and ce.slf_contrato_codigo = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(VContrato) || ' ) ';              
              End If; 
              if  vCliente <> QualquerCliente or  VContrato = QualquerContrato Then                
                 if vPrClausula = 'N' Then
                    vSQL := vSQL || ' or ';
                 Else
                    vPrClausula := 'N';
                 End If;                    
                 vSQL := vSQL || ' ( ce.glb_cliente_cgccpfcodigo = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vCliente) || ' and ce.slf_contrato_codigo = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(QualquerContrato) || ' )';              
              End If; 

              if  vGrupo = QualquerGrupo or  VContrato <> QualquerContrato  Then                
                 if vPrClausula = 'N' Then
                    vSQL := vSQL || ' or ';
                 Else
                    vPrClausula := 'N';
                 End If;                    
                 vSQL := vSQL || ' ( ce.glb_grupoeconomico_codigo = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(QualquerGrupo) || ' and ce.slf_contrato_codigo = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(VContrato) || ' )';
              End If;
              if  vGrupo <> QualquerGrupo or  VContrato = QualquerContrato  Then                
                 if vPrClausula = 'N' Then
                    vSQL := vSQL || ' or ';
                 Else
                    vPrClausula := 'N';
                 End If;                    
                 vSQL := vSQL || ' ( ce.glb_grupoeconomico_codigo = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(vGrupo) || ' and ce.slf_contrato_codigo = ' || TDVADM.PKG_glb_common.Fn_QuotedStr(QualquerContrato) || ' )';              
              End If;
              vSQL := vSQL || ') ';
--              vSQL := vSQL || 'ORDER BY CE.SLF_CLIENTECARGAS_SEQEXEC ';
          End If;
       End If; 

      if instr(vColetas,'845604') > 0 then
          insert into TDVADM.T_glb_sql values (vSQL,sysdate,'SIMULADOR','SIMULADOSQL');
          commit;
       end if;
       t := 1;
       i := 1;
       ia := 1;
       vPula := 'N';
       
       OPEN cSIMULADO FOR vSQL;
       loop
         fetch cSIMULADO
           into /*vColeta,*/ 
                vLocalidadeOri,
                vLocalidadeDes,
--                vClienteREM,
--                vClienteREMTE,
--                vClienteDES,
--                vClienteDESTE,
                vCliente,
                vGrupo,
                vContrato,
                vVeiculo,
                vPeso,
                vMercadoria,
                vQuimico,
                vExpresso;
         Exit When cSIMULADO%Notfound;


          vIBGEOri := tdvadm.fn_busca_codigoibge(vLocalidadeOri,'IBC');
          vIBGEDes := tdvadm.fn_busca_codigoibge(vLocalidadeDes,'IBC');
          vKM      := fni_ConsultaKM(vLocalidadeOri,vLocalidadeDes);

          if t > 1 Then 
            if ( vListaSIMcabecalho(t-1).codigoOrigem  = lpad(trim(vIBGEOri),8,'0')      ) and 
               ( vListaSIMcabecalho(t-1).codigoDestino = lpad(trim(vIBGEDes),8,'0')     ) and 
               ( vListaSIMcabecalho(t-1).km            = 'KM: ' ||  f_mascara_valor(vKM,10,0)     ) and 
               ( vListaSIMcabecalho(t-1).peso          = 'PESO : ' || f_mascara_valor(vPeso,10,0) ) Then
                vPula := 'S';
             End If; 


          End If;
       
          if vPula = 'N' Then
       
            ListaQuebras.CLISAC   := vCliente;
            ListaQuebras.GRUPOEC  := vGrupo;
            ListaQuebras.CONTRATO := nvl(VContrato,QualquerContrato);

            begin 
            select c.slf_contrato_descricao
               into ListaQuebras.CONTRATODESC
            from TDVADM.T_slf_contrato c
            where c.slf_contrato_codigo = ListaQuebras.CONTRATO  ;
            exception
              When NO_DATA_FOUND Then
                  ListaQuebras.CONTRATODESC := 'SEM CONTRATO';
              end;
                 
            if vClienteREM is null Then 
               ListaQuebras.CNPJREM   := ListaQuebras.CLISAC;
               ListaQuebras.CLIENDREM := 'X';
            Else
               ListaQuebras.CNPJREM   := vClienteREM;
               ListaQuebras.CLIENDREM := vClienteREMTE;
            End If;   
           
            if vClienteDES is null Then 
               ListaQuebras.CNPJDES   := ListaQuebras.CLISAC;
               ListaQuebras.CLIENDDES := 'X';
            Else
               ListaQuebras.CNPJDES   := vClienteREM;
               ListaQuebras.CLIENDDES := vClienteREMTE;
            End If;   

            ListaQuebras.ORIGEMNOTA  := trim(vLocalidadeOri);
            ListaQuebras.DESTINONOTA := trim(vLocalidadeDes);
            ListaQuebras.ENTCOL      := 'C';
            ListaQuebras.FLAGPGTO    := 'S';
            ListaQuebras.TPTABSOL    := null;
            ListaQuebras.TABSOLCOD   := null;
            ListaQuebras.TABSOLSQ    := null;
            ListaQuebras.ccTPRATEIO  := '02';                          
            ListaQuebras.CONTAADOR   := 0;
       

      
      
        vVERTPCARGAS := TDVADM.PKG_slf_contrato.FN_SLF_CLIENTEREGRACARGA(ListaQuebras.CLISAC,ListaQuebras.CONTRATO,ListaQuebras.GRUPOEC);
        IF vVERTPCARGAS = 'GCT' THEN -- ACHOU POR GRUPO/CNPJ/CONTRADO
          vSACADOCARGA    := ListaQuebras.CLISAC;
          vGRUPOCARGAS    := ListaQuebras.GRUPOEC;
          vCONTRATOCARGAS := ListaQuebras.CONTRATO;
        ELSIF vVERTPCARGAS = 'GC' THEN -- ACHOU POR GRUPO/CNPJ
          vSACADOCARGA    := ListaQuebras.CLISAC;
          vGRUPOCARGAS    := ListaQuebras.GRUPOEC;
          vCONTRATOCARGAS := QualquerContrato;
        ELSIF vVERTPCARGAS = 'GT' THEN -- ACHOU GRUPO/CONTRATO
          vSACADOCARGA    := QualquerCliente;
          vGRUPOCARGAS    := ListaQuebras.GRUPOEC;
          vCONTRATOCARGAS := ListaQuebras.CONTRATO;
        ELSIF vVERTPCARGAS = 'G' THEN --ACHOU POR GRUPO
          vSACADOCARGA    := QualquerCliente;
          vGRUPOCARGAS    := ListaQuebras.GRUPOEC;
          vCONTRATOCARGAS := QualquerContrato;
        ELSIF vVERTPCARGAS = 'C' THEN --ACHOU POR CLIENTE
          vSACADOCARGA    := ListaQuebras.CLISAC;
          vGRUPOCARGAS    := QualquerGrupo;
          vCONTRATOCARGAS := QualquerContrato;
        ELSIF vVERTPCARGAS = 'T' THEN --ACHOU POR CONTRATO
          vSACADOCARGA    := QualquerCliente;
          vGRUPOCARGAS    := QualquerGrupo;
          vCONTRATOCARGAS := ListaQuebras.CONTRATO;
        ELSIF vVERTPCARGAS = 'QQQ' THEN --POR QUALQUER COISA
          vSACADOCARGA    := QualquerCliente;
          vGRUPOCARGAS    := QualquerGrupo;
          vCONTRATOCARGAS := QualquerContrato;
        ELSE
          vSACADOCARGA    := QualquerCliente;
          vGRUPOCARGAS    := QualquerGrupo;
          vCONTRATOCARGAS := QualquerContrato;
        END IF;


            spi_SqlSacGrupoContrato(vSACADOCARGA,vGRUPOCARGAS,vCONTRATOCARGAS);
     
            -- Montando o Cabecalho
            -- Montado o Simulado
            vBusca_Frete := null;
            vBusca_Frete.vLOCALIDADEORIGEM  := ListaQuebras.ORIGEMNOTA;  -- ListaNotas.cnORIGEM
            vBusca_Frete.vLOCALIDADEDESTINO := ListaQuebras.DESTINONOTA; -- ListaNotas.cnDESTINO
            vBusca_Frete.vTIPOFRETE         := 'CIF'; -- Ver Depois
            vBusca_Frete.vTPCARGA           := ListaCargaCli.ccTPCARGACLI;
            vBusca_Frete.vRATEIA            := ListaCargaCli.ccRATEIA;
            vBusca_Frete.vPESOMINIMO        := ListaCargaCli.ccPESOMINIMO;
            vBusca_Frete.vCLIENTE           := vSACADOCARGA;
            vBusca_Frete.vGRUPO             := vGRUPOCARGAS; --NO CASO DE LOTACAO PARA PEGAR O TIPO DE VEICULO USANDO O PESO TOTAL DA CARGA
            vBusca_Frete.vCONTRATO          := vCONTRATOCARGAS;
            vBusca_Frete.vTPVEICULO         := vVeiculo;
            vBusca_Frete.vKM                := vKm; 
            vBusca_Frete.vPESO              := vPeso;
            vBusca_Frete.vPESOTOTAL         := vPeso;
            vBusca_Frete.vEntCol            := ListaQuebras.ENTCOL;

            ListaVaux.cnColetaValor     := 0;
            vListaSIMcabecalho(t).titulo           := to_char(t) || ' - ' || VContrato;
            vListaSIMcabecalho(t).codigoOrigem     := lpad(trim(vBusca_Frete.vLOCALIDADEORIGEM),8,'0');
            vListaSIMcabecalho(t).descricaoOrigem  := tdvadm.fn_busca_codigoibge(vBusca_Frete.vLOCALIDADEORIGEM,'IBD');
            vListaSIMcabecalho(t).codigoDestino    := lpad(trim(vBusca_Frete.vLOCALIDADEDESTINO),8,'0');
            vListaSIMcabecalho(t).descricaoDestino := tdvadm.fn_busca_codigoibge(vBusca_Frete.vLOCALIDADEDESTINO,'IBD');
            vListaSIMcabecalho(t).km               := 'KM: ' ||  lpad(trim(f_mascara_valor(vBusca_Frete.vKM,10,0)),10) || ' - PESO : ' || lpad(f_mascara_valor(vBusca_Frete.vPESO,10,0),10,'.');
            vListaSIMcabecalho(t).peso             := 'KM: ' ||  lpad(f_mascara_valor(vBusca_Frete.vKM,10,0),10) || ' - PESO : ' || lpad(f_mascara_valor(vBusca_Frete.vPESO,10,0),10);
  /*
            vListaSIMcabecalho(2).titulo           := '2 - PERCURSO';
            vListaSIMcabecalho(2).codigoOrigem     := lpad(tdvadm.fn_busca_codigoibge(vBusca_Frete.vLOCALIDADEORIGEM,'IBC'),8,'0');
            vListaSIMcabecalho(2).descricaoOrigem  := tdvadm.fn_busca_codigoibge(vBusca_Frete.vLOCALIDADEORIGEM,'IBD');
            vListaSIMcabecalho(2).codigoDestino    := lpad(tdvadm.fn_busca_codigoibge(vBusca_Frete.vLOCALIDADEDESTINO,'IBC'),8,'0');
            vListaSIMcabecalho(2).descricaoDestino := tdvadm.fn_busca_codigoibge(vBusca_Frete.vLOCALIDADEDESTINO,'IBD');
            vListaSIMcabecalho(2).km               := 'KM: ' ||  f_mascara_valor(vBusca_Frete.vKM,10,0) ;
            vListaSIMcabecalho(2).peso             := 'PESO : ' || f_mascara_valor(vBusca_Frete.vPESO,10,0) ;
  */
             
            OPEN cCARGAS FOR ListaSQL.FINALCARG;
        --    pCursor := cCARGAS;
            LOOP
               FETCH cCARGAS
                  into ListaCargaCli;
               exit when cCARGAS%notfound;


                  vKM      := fni_ConsultaKM(vLocalidadeOri,vLocalidadeDes);
                  vListaSIMcabecalho(t).km               := 'KM: ' ||  lpad(trim(f_mascara_valor(vBusca_Frete.vKM,10,0)),10) || ' - PESO : ' || lpad(f_mascara_valor(vBusca_Frete.vPESO,10,0),10,'.');                  vBusca_Frete := null;
                  vListaSIMcabecalho(t).peso             := 'Quimico: ' ||  vQuimico || ' - Expresso: ' || vExpresso;
--                  vListaSIMcabecalho(t).peso             := 'KM: ' ||  lpad(f_mascara_valor(vBusca_Frete.vKM,10,0),10) || ' - PESO : ' || lpad(f_mascara_valor(vBusca_Frete.vPESO,10,0),10);
                  vBusca_Frete.vLOCALIDADEORIGEM  := ListaQuebras.ORIGEMNOTA;  -- ListaNotas.cnORIGEM
                  vBusca_Frete.vLOCALIDADEDESTINO := ListaQuebras.DESTINONOTA; -- ListaNotas.cnDESTINO
                  vBusca_Frete.vTIPOFRETE         := 'CIF'; -- Ver Depois
                  vBusca_Frete.vTPCARGA           := ListaCargaCli.ccTPCARGACLI;
                  vBusca_Frete.vRATEIA            := ListaCargaCli.ccRATEIA;
                  vBusca_Frete.vPESOMINIMO        := ListaCargaCli.ccPESOMINIMO;
                  vBusca_Frete.vCLIENTE           := vSACADOCARGA;
                  vBusca_Frete.vGRUPO             := vGRUPOCARGAS; --NO CASO DE LOTACAO PARA PEGAR O TIPO DE VEICULO USANDO O PESO TOTAL DA CARGA
                  vBusca_Frete.vCONTRATO          := vCONTRATOCARGAS;
                  vBusca_Frete.vTPVEICULO         := vVeiculo;
                  vBusca_Frete.vKM                := vKm; 
                  vBusca_Frete.vPESO              := vPeso;
                  vBusca_Frete.vPESOTOTAL         := vPeso;
                  vBusca_Frete.vEntCol            := ListaQuebras.ENTCOL;
                  vBusca_Frete.vOrigem := 'SP_SIMULADOR'; 
                  
                  if  vBusca_Frete.vTPVEICULO is null Then
                     vBusca_Frete.vTPVEICULO := trim(TDVADM.PKG_FIFO_CARREGCTRC.FN_BUSCA_TPCARGAVEICULO(vBusca_Frete.vGRUPO,
                                                                             vBusca_Frete.vCONTRATO,
                                                                             vBusca_Frete.vCLIENTE,
                                                                             vBusca_Frete.vPESOTOTAL,
                                                                             vBusca_Frete.vTIPOFRETE,
                                                                             null, -- Tipo Transporte
                                                                             vBusca_Frete.vTPCARGA,
                                                                             ListaCargaCli.ccPESQVEICULO,
                                                                             'TV'));
                  End If;
                  
                  vRetBuscaFrete := null;
                  vBusca_Frete.vPesqFRETECOLETA := 'F';
                  SP_BUSCA_FRETEEMPRESA(vBusca_Frete,
                                        ListaCargaCli,
                                        vRetBuscaFrete,
                                        vMessage);


                  if nvl(vBusca_Frete.vPESOTOTAL,-1) = -1 Then
                     pMessage := pMessage || chr(10) || 'Peso Total Nao Apurado SIMULADOR';
                     pStatus := TDVADM.PKG_glb_common.Status_Erro;
                  End If;
                  
--                  if ListaCargaCli.ccSOTRANSF = 'S'
--                     select count(*)
                     
--                  End If;    
                      
  --                    ListaNotas.cnTABSOLCOD := vRetBuscaFrete.SLF_TABELA_CODIGO;
  --                    ListaNotas.cnTABSOLSQ  := vRetBuscaFrete.SLF_TABELA_SAQUE;
  --                    ListaNotas.cnTABSOL    := 'T';  
                      
                  If vRetBuscaFrete.vRetorno <> 'NE' Then
                     pMessage := trim(substr( trim(substr(pMessage,1,30000)) || chr(10) || 'Retorno ' || vRetBuscaFrete.vRetorno || ' Carga ' || ListaCargaCli.ccTPCARGACLIPESQ || '-' || vMessage,1,30000));
                  End If;

--********************************************************************************************

                      -- Carrega a Lista

                   vTpCalculo := '041';
                   if ( ListaNotas.cnContrato = 'C2013010022' ) Then -- LOT-VOLKSWAGEN-0113-XXX
                      vTpCalculo := '315';
                   end If   ;
                   If ListaNotas.cnGRUPOECSAC = '0020' Then
                      vTpCalculo := '315';
                   End If;

                   glbadm.pkg_listas.sp_Get_VerbasCalculo(vTpCalculo,
                                                          ListaVerbas);


/* 
                      -- pegando Aliquota
                      ListaVerbas('S_ALICMS').AsFloat := V_ALIQUOTA;
                      ListaVerbas('S_ALICMS').Value := trim(to_char(V_ALIQUOTA));
--                      ListaVerbas('S_ALICMS').AsDesinencia := 'VL';
                      ListaVerbas('S_ALISS').AsFloat := V_ALIQUOTA;
                      ListaVerbas('S_ALISS').Value := trim(to_char(V_ALIQUOTA));

*/
                      -- Valor da Mercadoria                     
                      ListaVerbas('I_VLMR').AsFloat := vMercadoria;
                      ListaVerbas('I_VLMR').Value := trim(to_char(vMercadoria));

--                      ListaVerbas('I_VLMR').AsDesinencia := 'VL';
                      ListaVerbas('D_VLRSEGUR').AsFloat := vMercadoria;
                      ListaVerbas('D_VLRSEGUR').Value := trim(to_char(vMercadoria));
--                      ListaVerbas('D_VLRSEGUR').AsDesinencia := 'VL';

                      ListaVerbas('D_PSREAL').AsFloat := vBusca_Frete.vPESO/1000 / 1000;
                      ListaVerbas('D_PSREAL').Value := trim(to_char((vBusca_Frete.vPESO/1000 / 1000)));
--                      ListaVerbas('D_PSREAL').AsDesinencia := 'VL';

                      ListaVerbas('I_PSCOBRAD').AsFloat := vBusca_Frete.vPESO/1000 / 1000;
                      ListaVerbas('I_PSCOBRAD').Value := trim(to_char((vBusca_Frete.vPESO/1000 / 1000)));
--                      ListaVerbas('I_PSCOBRAD').AsDesinencia := 'VL';


                     ListaVerbas('S_KMPER').AsFloat := vKm;
                     ListaVerbas('S_KMPER').Value := trim(to_char(vKm));
                     ListaVerbas('S_KMPER').AsDesinencia := 'VL';

--                      Frete                     
                     ListaVerbas('D_FRPSVO').AsFloat := vRetBuscaFrete.SLF_CALCFRETEKM_VALOR;
                     ListaVerbas('D_FRPSVO').Value := trim(to_char(vRetBuscaFrete.SLF_CALCFRETEKM_VALOR));
                     ListaVerbas('D_FRPSVO').AsDesinencia := vRetBuscaFrete.SLF_CALCFRETEKM_DESINENCIA;


                     -- Verifica se e OUTBOUND 
                     if ( trim(vGrupoREM) = trim(vGRUPOCARGAS) ) AND 
                        ( trim(vGrupoDES) <>  trim(vGRUPOCARGAS) ) Then
                        ListaVerbas('V_PERCTO').AsFloat := ListaCargaCli.ccPERCTOUT;
                        ListaVerbas('V_PERCTO').Value := trim(to_char(ListaCargaCli.ccPERCTOUT));
                        ListaVerbas('V_PERCTO').AsDesinencia := '%';
                     Else --Nao e outbound
                        ListaVerbas('V_PERCTO').AsFloat := 1;
                        ListaVerbas('V_PERCTO').Value := '1';
                        ListaVerbas('V_PERCTO').AsDesinencia := '%';
                     End If;

                      -- Nao e transferencia
                      if trim(vGrupoREM) = trim(vGrupoDES) Then
                         ListaVerbas('V_PERCTT').AsFloat := ListaCargaCli.ccPERCTRA;
                         ListaVerbas('V_PERCTT').Value := trim(to_char(ListaCargaCli.ccPERCTRA));
                         ListaVerbas('V_PERCTT').AsDesinencia := '%';
                      Else  
                         ListaVerbas('V_PERCTT').AsFloat := 1;
                         ListaVerbas('V_PERCTT').Value := '1';
                         ListaVerbas('V_PERCTT').AsDesinencia := '%';
                      End If;   
                      
                      

/*                  
                   if instr(cCargaExpressa,pkg_glb_common.Fn_QuotedStr(ListaNotas.cnTIPOCARGA)) > 0 Then
                       ListaVaux.cnPercentEx := ListaCargaCli.ccPERCTEX;
                       ListaVerbas('V_PERCTE').AsFloat := ListaCargaCli.ccPERCTEX;
                       ListaVerbas('V_PERCTE').Value := trim(to_char(ListaCargaCli.ccPERCTEX));
                       ListaVerbas('V_PERCTE').AsDesinencia := '%';
                    Else  
                       ListaVaux.cnPercentEx := 1;
                       ListaVerbas('V_PERCTE').AsFloat := 1;
                       ListaVerbas('V_PERCTE').Value := '1';
                       ListaVerbas('V_PERCTE').AsDesinencia := '%';
                    End If;    
*/
                  if ( nvl(vQuimico,'N') = 'N' )  Then 
                   -- Nao e quimico
                      ListaVaux.cnPercentQP := 1;
                      ListaVerbas('V_PERCTQ').AsFloat := 1;
                      ListaVerbas('V_PERCTQ').Value := '1';
                      ListaVerbas('V_PERCTQ').AsDesinencia := '%';
                  Else
                      ListaVaux.cnPercentQP := ListaCargaCli.ccPERCTQM;
                      ListaVerbas('V_PERCTQ').AsFloat := ListaCargaCli.ccPERCTQM;
                      ListaVerbas('V_PERCTQ').Value := trim(to_char(ListaCargaCli.ccPERCTQM));
                      ListaVerbas('V_PERCTQ').AsDesinencia := '%';
                  End If;    

                  If nvl(trim(vExpresso),'N') = 'N' Then
                     ListaVaux.cnPercentEx := 1;
                     ListaVerbas('V_PERCTE').AsFloat := 1;
                     ListaVerbas('V_PERCTE').Value := '1';
                     ListaVerbas('V_PERCTE').AsDesinencia := '%';
                  Else
                     ListaVaux.cnPercentEx := ListaCargaCli.ccPERCTEX;
                     ListaVerbas('V_PERCTE').AsFloat := ListaCargaCli.ccPERCTEX;
                     ListaVerbas('V_PERCTE').Value := to_char(ListaCargaCli.ccPERCTEX);
                     ListaVerbas('V_PERCTE').AsDesinencia := '%';
                  End If; 


                  ListaVerbas('V_VLRFIXO').AsFloat := nvl(vRetBuscaFrete.SLF_CALCFRETEKM_VALORF,0);
                  ListaVerbas('V_VLRFIXO').Value := trim(to_char(nvl(vRetBuscaFrete.SLF_CALCFRETEKM_VALORF,0)));
                  ListaVerbas('V_VLRFIXO').AsDesinencia := vRetBuscaFrete.SLF_CALCFRETEKM_DESINENCIAF;

                  vAuxiliarPesoRateio  := nvl(vBusca_Frete.vPESO/1000,1);
                  ListaVerbas('V_PSRATEIO').AsFloat := vAuxiliarPesoRateio;
                  ListaVerbas('V_PSRATEIO').Value := trim(to_char(vAuxiliarPesoRateio));
                  ListaVerbas('V_PSRATEIO').AsDesinencia := '%';

                  vAuxiliarFatorRateio := nvl(vAuxiliarFatorRateio,1);
                  ListaVerbas('V_FTRATEIO').AsFloat := vAuxiliarFatorRateio;
                  ListaVerbas('V_FTRATEIO').Value := trim(to_char(vAuxiliarFatorRateio));
                  ListaVerbas('V_FTRATEIO').AsDesinencia := '%';

                  ListaVerbas('V_PERCTR').AsFloat := ListaCargaCli.ccPERCTREDUTOR;
                  ListaVerbas('V_PERCTR').Value := trim(to_char(ListaCargaCli.ccPERCTREDUTOR));
                  ListaVerbas('V_PERCTR').AsDesinencia := '%';


                 if ( ListaCargaCli.ccFORMULAFRTX is not null ) OR 
                    ( ListaCargaCli.ccFORMULAFRVL IS NOT NULL ) OR 
                    ( ListaCargaCli.ccFORMULAFRKM IS NOT NULL ) then
                     if ListaVerbas('D_FRPSVO').AsDesinencia = 'TX' Then
                        vFormulaTraduzidaF := ' SELECT ' || fn_MudaFormula(ListaCargaCli.ccFORMULAFRTX,ListaVerbas) || ' FROM DUAL ';
                     Elsif ListaVerbas('D_FRPSVO').AsDesinencia = 'KM' Then
                        vFormulaTraduzidaF := ' SELECT ' || fn_MudaFormula(ListaCargaCli.ccFORMULAFRKM,ListaVerbas) || ' FROM DUAL ';
                     Else
                        vFormulaTraduzidaF := ' SELECT ' || fn_MudaFormula(ListaCargaCli.ccFORMULAFRVL,ListaVerbas) || ' FROM DUAL ';
                     End If;   
                     execute immediate vFormulaTraduzidaF into vListaSIMsimulado(i).valorCalculado;
                  Else
                     if ListaVerbas('D_FRPSVO').AsDesinencia = 'TX' Then
                        vListaSIMsimulado(i).valorCalculado := ListaVerbas('D_FRPSVO').AsFloat * ListaVerbas('V_PSRATEIO').AsFloat;
                     Else
                        vListaSIMsimulado(i).valorCalculado := ListaVerbas('D_FRPSVO').AsFloat ;
                     End If;   
                  End If;   
                  
                  If ListaNotas.cnContrato = 'C2016080027' Then
                     If vListaSIMsimulado(i).valorCalculado = 0 Then
                        vListaSIMsimulado(i).valorCalculado := 0.01;
                     End If;
                  End If;
                                         
    
--********************************************************************************************


--                  if vRetBuscaFrete.vRetorno <>  'NE' Then
                     vListaSIMsimulado(i).titulo         := to_char(t) || ' - ' || ListaCargaCli.ccTPCARGACLIDESC;
                     vListaSIMsimulado(i).kmDe           := vRetBuscaFrete.SLF_CALCFRETEKM_KMDE;
                     vListaSIMsimulado(i).kmAte          := vRetBuscaFrete.SLF_CALCFRETEKM_KMATE;
                     vListaSIMsimulado(i).pesoDe         := vRetBuscaFrete.SLF_CALCFRETEKM_PESODE;
                     vListaSIMsimulado(i).pesoAte        := vRetBuscaFrete.SLF_CALCFRETEKM_PESOATE;
                     vListaSIMsimulado(i).tabTdv         := vRetBuscaFrete.SLF_TABELA_CODIGO;
                     vListaSIMsimulado(i).saqTdv         := vRetBuscaFrete.SLF_TABELA_SAQUE;
                     vListaSIMsimulado(i).tipo           := vRetBuscaFrete.SLF_TABELA_TIPO;
                     vListaSIMsimulado(i).veiculo        := vRetBuscaFrete.FCF_TPVEICULO_CODIGO;
                     vListaSIMsimulado(i).tipoCarga      := vRetBuscaFrete.FCF_TPCARGA_CODIGO;
                     vListaSIMsimulado(i).valor          := vRetBuscaFrete.SLF_CALCFRETEKM_VALOR;
                     vListaSIMsimulado(i).Desinencia     := vRetBuscaFrete.SLF_CALCFRETEKM_DESINENCIA;
                     vListaSIMsimulado(i).limite         := vRetBuscaFrete.SLF_CALCFRETEKM_LIMITE;
                     vListaSIMsimulado(i).valorExcedente := vRetBuscaFrete.SLF_CALCFRETEKM_VALORE;
                     vListaSIMsimulado(i).valorFixo      := vRetBuscaFrete.SLF_CALCFRETEKM_VALORF;
                     vListaSIMsimulado(i).codigoCliente  := vRetBuscaFrete.SLF_CALCFRETEKM_CODCLI;
                     ListaCargaCli.ccPERCTEX             := fn_GetPercentExpresso(ListaVaux,ListaNotas);
                     vListaSIMsimulado(i).perctEx        := ListaCargaCli.ccPERCTEX;
                     vListaSIMsimulado(i).perctQM        := ListaCargaCli.ccPERCTQM;
                     vListaSIMsimulado(i).perctOutb      := ListaCargaCli.ccPERCTOUT;
                     vListaSIMsimulado(i).perctTrans     := ListaCargaCli.ccPERCTRA;
                     vListaSIMsimulado(i).soTransf       := ListaCargaCli.ccSOTRANSF;
                     i := i + 1;
--                  End If;
                             
       
            End Loop;
            If i > ia Then
               t  := t + 1;
               ia := i;
            Else
              if vColeta is null Then
                 t  := t + 1;
                 ia := i;
              End If;
            End If; 
          Else
            vPula := 'N';     
          End If;
    end Loop;
    If i = ia Then
       vListaSIMcabecalho.delete(t);
    End If;   
       

    pxml :=         '<simulador>';
    pxml := pxml || '   <cabecalhos>';
    i := 1;            
    loop
      Begin
      vListaSIMcabecalho(i).titulo  := vListaSIMcabecalho(i).titulo ;
      pxml := pxml || '<cabecalho>';
      pxml := pxml || '  <titulo>'           || vListaSIMcabecalho(i).titulo           || '</titulo>';
      pxml := pxml || '  <codigoOrigem>'     || vListaSIMcabecalho(i).codigoOrigem     || '</codigoOrigem>';
      pxml := pxml || '  <descricaoOrigem>'  || vListaSIMcabecalho(i).descricaoOrigem  || '</descricaoOrigem>';
      pxml := pxml || '  <codigoDestino>'    || vListaSIMcabecalho(i).codigoDestino    || '</codigoDestino>';
      pxml := pxml || '  <descricaoDestino>' || vListaSIMcabecalho(i).descricaoDestino || '</descricaoDestino>';
      pxml := pxml || '  <km>'               || vListaSIMcabecalho(i).km               || '</km>';
      pxml := pxml || '  <peso>'             || vListaSIMcabecalho(i).peso             || '</peso>';
      pxml := pxml || '</cabecalho>';  
      i := i + 1;
      exception
        When NO_DATA_FOUND Then
            exit;
        End ;
    end loop;                

    if vUsuario = 'sdrumondx' Then   
        pxml := pxml || '<cabecalho>';
        pxml := pxml || '  <titulo>'           || 'T' || '1234567890123456789012345678' || '</titulo>';
        pxml := pxml || '  <codigoOrigem>'     || 'O' || '12345678901234567890' || '</codigoOrigem>';
        pxml := pxml || '  <descricaoOrigem>'  || 'o' || '1234567890123456789' || '</descricaoOrigem>';
        pxml := pxml || '  <codigoDestino>'    || 'D' || '1234567890123456789' || '</codigoDestino>';
        pxml := pxml || '  <descricaoDestino>' || 'd' || '12345678901234567890' || '</descricaoDestino>';
        pxml := pxml || '  <km>'               || 'K' || '1234567890123456789012345678' || '</km>';
        pxml := pxml || '  <peso>'             || 'P' || '12345678901234567890123456789' || '</peso>';
        pxml := pxml || '</cabecalho>';  

        pxml := pxml || '<cabecalho>';
        pxml := pxml || '  <titulo>'           || 'T' || '1234       23456789012345678' || '</titulo>';
        pxml := pxml || '  <codigoOrigem>'     || 'O' || '12bbBBBBB01234567890' || '</codigoOrigem>';
        pxml := pxml || '  <descricaoOrigem>'  || 'o' || '12IIiiiii0123456789' || '</descricaoOrigem>';
        pxml := pxml || '  <codigoDestino>'    || 'D' || '1234567890123456789' || '</codigoDestino>';
        pxml := pxml || '  <descricaoDestino>' || 'd' || '12345678901234567890' || '</descricaoDestino>';
        pxml := pxml || '  <km>'               || 'K' || '1               789012345678' || '</km>';
        pxml := pxml || '  <peso>'             || 'P' || '1234567890123456   0123456789' || '</peso>';
        pxml := pxml || '</cabecalho>';  
    End If;
    
    pxml := pxml || '   </cabecalhos>';


    pxml := pxml || '   <simulados>';
    i := 1;            
    loop
      Begin
         if ( i = 1 ) and ( vListaSIMsimulado(i).titulo is null ) Then 
            vListaSIMsimulado(i).titulo := 'FRETE NAO ENCONTRADO PARA O PERCURSO';
         End If;
         vListaSIMsimulado(i).titulo := vListaSIMsimulado(i).titulo ;
         pxml := pxml || '<simulado>';
         pxml := pxml || '   <titulo>'         || vListaSIMsimulado(i).titulo         || '</titulo>';
         pxml := pxml || '   <kmDe>'           || vListaSIMsimulado(i).kmDe           || '</kmDe>';
         pxml := pxml || '   <kmAte>'          || vListaSIMsimulado(i).kmAte          || '</kmAte>';
         pxml := pxml || '   <pesoDe>'         || vListaSIMsimulado(i).pesoDe         || '</pesoDe>';
         pxml := pxml || '   <pesoAte>'        || vListaSIMsimulado(i).pesoAte        || '</pesoAte>';
         pxml := pxml || '   <tabTdv>'         || vListaSIMsimulado(i).tabTdv         || '</tabTdv>';
         pxml := pxml || '   <saqTdv>'         || vListaSIMsimulado(i).saqTdv         || '</saqTdv>';
         pxml := pxml || '   <tipo>'           || vListaSIMsimulado(i).tipo           || '</tipo>';
         pxml := pxml || '   <veiculo>'        || vListaSIMsimulado(i).veiculo        || '</veiculo>';
         pxml := pxml || '   <tipoCarga>'      || vListaSIMsimulado(i).tipoCarga      || '</tipoCarga>';
         If trim(vListaSIMsimulado(i).Desinencia) = 'TX' Then
            pxml := pxml || '   <valor>'          || vListaSIMsimulado(i).valor * nvl(vPeso,1) || '</valor>';
         Else        
            pxml := pxml || '   <valor>'          || vListaSIMsimulado(i).valor          || '</valor>';
         End If;
         pxml := pxml || '   <limite>'         || vListaSIMsimulado(i).limite         || '</limite>';
         pxml := pxml || '   <valorExcedente>' || vListaSIMsimulado(i).valorExcedente || '</valorExcedente>';
         pxml := pxml || '   <valorFixo>'      || vListaSIMsimulado(i).valorFixo      || '</valorFixo>';
         pxml := pxml || '   <valorCalculado>' || vListaSIMsimulado(i).valorCalculado || '</valorCalculado>';
         pxml := pxml || '   <codigoCliente>'  || vListaSIMsimulado(i).codigoCliente  || '</codigoCliente>';
         pxml := pxml || '   <perctEx>'        || vListaSIMsimulado(i).perctEx        || '</perctEx>';
         pxml := pxml || '   <perctQM>'        || vListaSIMsimulado(i).perctQM        || '</perctQM>';    
         pxml := pxml || '   <perctOutb>'      || vListaSIMsimulado(i).perctOutb      || '</perctOutb>'; 
         pxml := pxml || '   <perctTrans>'     || vListaSIMsimulado(i).perctTrans     || '</perctTrans>';    
         pxml := pxml || '   <soTransf>'       || vListaSIMsimulado(i).soTransf       || '</soTransf>';
         pxml := pxml || '</simulado>';
      i := i + 1;

      exception
        When NO_DATA_FOUND Then
            exit;
        End ;
    end loop;                
    pxml := pxml || '   </simulados>';
    pxml := pxml || '</simulador>';

    if vUsuario = 'sdrumond' Then 
      if vColetas is null Then
         insert into TDVADM.T_glb_sql values (pxml,sysdate,'SIMULADOR','COLETA');
      Else
         insert into TDVADM.T_glb_sql values (pxml,sysdate,'SIMULADOR','DIRETO');
      End If;  
    End If;
  
  End SP_SIMULADOR;                         


  function fn_testacarga(pConhec in tdvadm.t_con_conhecimento.con_conhecimento_codigo%type,
                         pSerie in tdvadm.t_con_conhecimento.con_conhecimento_serie%type,
                         pRota in tdvadm.t_con_conhecimento.glb_rota_codigo%type)
    return varchar2
  is
     vListaRecalc TpRecalculo;
     vStatus      char(1);
     vAuxiliar    Number;
     vAuxiliarCargas char(2);

  Begin
     vStatus := TDVADM.PKG_glb_common.Status_Nomal;
     Begin
         select c.con_conhecimento_dtembarque,
                c.glb_cliente_cgccpfremetente,
                c.glb_tpcliend_codigoremetente,
                CR.glb_grupoeconomico_codigo,
                CR.glb_cliente_nacional,
                c.glb_cliente_cgccpfdestinatario,
                c.glb_tpcliend_codigodestinatari,
                cd.glb_grupoeconomico_codigo,
                c.glb_cliente_cgccpfsacado,
                'C',
                CS.glb_grupoeconomico_codigo,
                decode(nvl(c.slf_solfrete_codigo,'X'),'X','T','S'),
                decode(nvl(c.slf_solfrete_codigo,'X'),'X',c.slf_tabela_codigo,c.slf_solfrete_codigo),
                decode(nvl(c.slf_solfrete_codigo,'X'),'X',c.slf_tabela_Saque,c.slf_solfrete_Saque),
                c.arm_coleta_ncompra,
                c.arm_coleta_ciclo,
                c.con_conhecimento_localcoleta,
                c.con_conhecimento_localentrega,
                co.glb_tpcarga_codigo,
                co.arm_coleta_entcoleta,
                c.arm_carregamento_codigo
           into vListaRecalc.rDataColeta,-- Utilizando a Data de Emissao do CTe/NFSe
                vListaRecalc.rRemetente,
                vListaRecalc.rTpEndRemet,
                vListaRecalc.rGrupoRemet,
                vListaRecalc.rChines,
                vListaRecalc.rDestinatario,
                vListaRecalc.rTpEndDest,
                vListaRecalc.rGrupoDest,
                vListaRecalc.rSacado,
                vListaRecalc.rTpEndSacado,
                vListaRecalc.rGrupoSacado,
                vListaRecalc.rTpTabSol,
                vListaRecalc.rTabSolCodigo,
                vListaRecalc.rTabSolSaque,
                vListaRecalc.rNrColeta,
                vListaRecalc.rNrColetaCiclo,
                vListaRecalc.rColeta,
                vListaRecalc.rEntrega,
                vListaRecalc.rTpCargaC,
                vListaRecalc.rEntrColeta,
                vListaRecalc.rCarregamento
         from TDVADM.T_con_conhecimento c,
              TDVADM.T_arm_coleta co,
              TDVADM.T_glb_cliente cr,
              TDVADM.T_glb_cliente cd,
              TDVADM.T_glb_cliente cs
         where c.con_conhecimento_codigo = pConhec
           and c.con_conhecimento_serie  = pSerie
           and c.glb_rota_codigo         = pRota
           and c.arm_coleta_ncompra = co.arm_coleta_ncompra (+)
           and c.arm_coleta_ciclo   = co.arm_coleta_ciclo (+)
           and c.glb_cliente_cgccpfremetente    = CR.glb_cliente_cgccpfcodigo
           and c.glb_cliente_cgccpfdestinatario = cd.glb_cliente_cgccpfcodigo
           and c.glb_cliente_cgccpfsacado       = CS.glb_cliente_cgccpfcodigo;
     Exception
       When NO_DATA_FOUND Then
          vStatus := TDVADM.PKG_glb_common.Status_Erro;
       End;  
     Begin  
     if vListaRecalc.rTpTabSol = 'T' Then
        Select ta.slf_tabela_contrato
          into vListaRecalc.rContrato 
        From TDVADM.T_slf_tabela ta
        where ta.slf_tabela_codigo = vListaRecalc.rTabSolCodigo
          and ta.slf_tabela_saque = vListaRecalc.rTabSolSaque;
     Else
        Select ta.slf_solfrete_contrato
          into vListaRecalc.rContrato 
        From TDVADM.T_slf_solfrete ta
        where ta.slf_solfrete_codigo = vListaRecalc.rTabSolCodigo
          and ta.slf_solfrete_saque = vListaRecalc.rTabSolSaque;
     End If;     
     exception
       When NO_DATA_FOUND Then
          vStatus := TDVADM.PKG_glb_common.Status_Erro;
       End;       
  
     vListaRecalc.rColetai      := trim(tdvadm.fn_busca_codigoibge(vListaRecalc.rColeta,'IBC'));
     vListaRecalc.rColetaR      := trim(tdvadm.fn_busca_codigoibge(vListaRecalc.rColeta,'IBR'));
     vListaRecalc.rColetaRV     := trim(tdvadm.fn_busca_codigoibge(vListaRecalc.rColeta,'IBRV'));
     vListaRecalc.rEntregai     := trim(tdvadm.fn_busca_codigoibge(vListaRecalc.rEntrega,'IBC'));
     vListaRecalc.rEntregaR     := trim(tdvadm.fn_busca_codigoibge(vListaRecalc.rEntrega,'IBR'));
     vListaRecalc.rEntregaRV    := trim(tdvadm.fn_busca_codigoibge(vListaRecalc.rEntrega,'IBRV'));
     vListaRecalc.rKm           := fnI_ConsultaKM(vListaRecalc.rColeta,vListaRecalc.rEntrega);
     vListaRecalc.rPesoMinimo   := 1;

     Begin
         select sum(ne.con_nftransporta_number1)
           into vListaRecalc.rLotacao
         from TDVADM.T_con_nftransportaextra ne
         where ne.con_conhecimento_codigo = pConhec
           and ne.con_conhecimento_serie  = pSerie
           and ne.glb_rota_codigo         = pRota;
     Exception
       when NO_DATA_FOUND then
           vListaRecalc.rLotacao := 0;
       End;      

     Begin
         select co.xml_coleta_tipotransporte,
                co.xml_coleta_tipocarga
           into vListaRecalc.rTpVeicXML,
                vListaRecalc.rTpCargaXML
         from TDVADM.T_xml_coleta co
         where co.arm_coleta_ncompra = vListaRecalc.rNrColeta
           and co.arm_coleta_ciclo   = vListaRecalc.rNrColetaCiclo
           and co.xml_coleta_status = 'OK';       
     Exception
       when NO_DATA_FOUND then
           vListaRecalc.rTpVeicXML  := '';
           vListaRecalc.rTpCargaXML := '';
       End;      


     Begin
         select ca.con_calcviagem_valor
           into vListaRecalc.rPeso
         from TDVADM.T_con_calcconhecimento ca
         where ca.con_conhecimento_codigo = pConhec
           and ca.con_conhecimento_serie  = pSerie
           and ca.glb_rota_codigo         = pRota
           and ca.slf_reccust_codigo = 'D_PSREAL';
     exception
       When NO_DATA_FOUND Then
           vListaRecalc.rPeso := 0;
       End;
     Begin
         select ca.con_calcviagem_valor
           into vListaRecalc.rPesoCobrad
         from TDVADM.T_con_calcconhecimento ca
         where ca.con_conhecimento_codigo = pConhec
           and ca.con_conhecimento_serie  = pSerie
           and ca.glb_rota_codigo         = pRota
           and ca.slf_reccust_codigo = 'I_PSCOBRAD';
     exception
       When NO_DATA_FOUND Then
           vListaRecalc.rPesoCobrad := 0;
       End;
     

     if vListaRecalc.rRemetente = vListaRecalc.rSacado Then
        vListaRecalc.rTipoFrete    := 'CIF';
     ElsIf vListaRecalc.rDestinatario = vListaRecalc.rSacado Then   
        vListaRecalc.rTipoFrete    := 'FOB';
     Else
        vListaRecalc.rTipoFrete    := 'FOC'; -- Nao e assim mais vai ficar por enquanto
     End if;         

     vListaRecalc.rRateia       := 'S';

     
     begin
         select cl.xml_clientelib_flaggf
           into vListaRecalc.rGrandeFluxo
         from TDVADM.T_xml_clientelib cl
         where cl.glb_cliente_cgccpfcodigo = vListaRecalc.rRemetente
           and cl.xml_clientelib_ativo = 'S'
           and cl.xml_clientelib_flaggf = 'S';
     exception
       When NO_DATA_FOUND Then
          vListaRecalc.rGrandeFluxo := 'N';
       End;    

     begin
         select cl.xml_clientelib_flagporto
           into vListaRecalc.rPorto
         from TDVADM.T_xml_clientelib cl
         where cl.glb_cliente_cgccpfcodigo = vListaRecalc.rRemetente
           and cl.xml_clientelib_ativo = 'S'
           and cl.xml_clientelib_flagporto = 'S';
     exception
       When NO_DATA_FOUND Then
          vListaRecalc.rPorto := 'N';
       End;    

      vListaRecalc.rVeiculo := TDVADM.PKG_FIFO_CARREGCTRC.fn_verifica_Veiculo(vListaRecalc.rTpVeicXML,vListaRecalc.rTpCargaC,'',vListaRecalc.rCarregamento);
      vListaRecalc.rCarga   := TDVADM.PKG_FIFO_CARREGCTRC.FN_VERIFICA_CARGA(vListaRecalc.rTpCargaXML,vListaRecalc.rTpCargaC);


        vAuxiliarCargas := TDVADM.PKG_slf_contrato.FN_SLF_CLIENTEREGRACARGA(vListaRecalc.rSacado, vListaRecalc.rContrato);
        -- GCC - ACHOU POR GRUPO/CNPJ/CONTRADO
        -- GC  - ACHOU POR GRUPO/CNPJ
        -- G   - ACHOU POR GRUPO
        -- N   - NAO ACHOU RECGRA ESPECIFICA
        IF vAuxiliarCargas = 'GCC' THEN
          vListaRecalc.rSacadoP      := vListaRecalc.rSacado;
          vListaRecalc.rGrupoSacadoP := vListaRecalc.rGrupoSacado;
          vListaRecalc.rContratoP    := vListaRecalc.rContrato;
        ELSIF vAuxiliarCargas = 'GC ' THEN
          vListaRecalc.rSacadoP      := vListaRecalc.rSacado;
          vListaRecalc.rGrupoSacadoP := vListaRecalc.rGrupoSacado;
          vListaRecalc.rContratoP    := QualquerContrato;
        ELSIF vAuxiliarCargas = 'CG ' THEN -- cONTRATO gRUPO
          vListaRecalc.rSacadoP      := QualquerCliente;
          vListaRecalc.rGrupoSacadoP := vListaRecalc.rGrupoSacado;
          vListaRecalc.rContratoP    := vListaRecalc.rContrato;
        ELSIF vAuxiliarCargas = 'G  ' THEN
          vListaRecalc.rSacadoP      := QualquerCliente;
          vListaRecalc.rGrupoSacadoP := vListaRecalc.rGrupoSacado;
          vListaRecalc.rContratoP    := QualquerContrato;
        ELSE
          vListaRecalc.rSacadoP      := QualquerCliente;
          vListaRecalc.rGrupoSacadoP := QualquerGrupo;
          vListaRecalc.rContratoP    := QualquerContrato;
        END IF;





      vListaRecalc.rTpVeiculo := TDVADM.PKG_FIFO_CARREGCTRC.FN_BUSCA_TPCARGAVEICULO(vListaRecalc.rGrupoSacadoP,
                                                                                   vListaRecalc.rContratoP,
                                                                                   vListaRecalc.rSacadoP,
                                                                                   (vListaRecalc.rPeso * 1000), -- Volta o Peso para Quilos.
                                                                                   vListaRecalc.rTipoFrete,
                                                                                   vListaRecalc.rVeiculo,
                                                                                   ListaCargaCli.ccTPCARGACLI,
                                                                                   ListaCargaCli.ccPESQVEICULO,
                                                                                   'TV');
                                                                                   
     Begin
       select distinct fe.glb_onuclascli_codigo ||'-'|| fe.arm_notafichaemerg_codcli
         into vListaRecalc.rFormularioQ
         from TDVADM.T_arm_notafichaemerg fe,
              TDVADM.T_arm_nota an
       where 0 = 0
         and fe.arm_nota_numero             = an.arm_nota_numero
         and fe.glb_onu_codigo              <> 9999
         and fe.glb_cliente_cgccpfremetente = an.glb_cliente_cgccpfremetente            
         and fe.arm_nota_sequencia          = an.arm_nota_sequencia
         and an.arm_carregamento_codigo     = vListaRecalc.rCarregamento
         and fe.glb_onuclascli_codigo = ProdutoQuimicoPerigoso;
     Exception
       When NO_DATA_FOUND Then
           vListaRecalc.rFormularioQ := null;
     End;         



     vListaRecalc.rFormularioE := '';

  
     vAuxiliar := 0;

 loop
     if vAuxiliar = 0 Then
       vListaRecalc.rTpCarga := '10'; -- Rota Mestre
     Elsif vAuxiliar = 1 Then
       vListaRecalc.rTpCarga := '11'; -- Lotacao
     ElsIf vAuxiliar = 2 Then  
       vListaRecalc.rTpCarga := '12'; -- Fracionado
     Else
        exit;
     End if;  
     if vListaRecalc.rTpCarga = '11' Then
        if not ( vListaRecalc.rChines = 'S' or 
                 vListaRecalc.rGrandeFluxo =  'S' ) Then
           vAuxiliar := vAuxiliar + 1;  
           vListaRecalc.rTpCarga := '12';
        End If;
     End If;      
/*    PKG_FIFO_CARREGCTRC.SP_BUSCA_FRETEEMPRESA2(vListaRecalc.rColeta,
                                                     vListaRecalc.rEntrega,
                                                     vListaRecalc.rTipoFrete,
                                                     vListaRecalc.rTpCarga,
                                                     vListaRecalc.rRateia,
                                                     vListaRecalc.rPesoMinimo,
                                                     vListaRecalc.rSacado,
                                                     vListaRecalc.rGrupoSacado,
                                                     vListaRecalc.rContrato,
                                                     vListaRecalc.rTpVeiculo,
                                                     vListaRecalc.rKm,
                                                     vListaRecalc.rPeso,
                                                     vListaRecalc.rLotacao,
                                            \*out*\  vListaRecalc.rEntrColeta,
                                            \*out*\  vListaRecalc.rTpRetorno,
                                            \*out*\  vListaRecalc.rCodOriCob,
                                            \*out*\  vListaRecalc.rCodDesCob,
                                            \*out*\  vListaRecalc.rFreteEmpresa,
                                            \*out*\  vListaRecalc.rDesinenciaFr,
                                            \*out*\  vListaRecalc.rTabSolCodigo,
                                            \*out*\  vListaRecalc.rTabSolSaque,
                                            \*out*\  vListaRecalc.rTpcalculo,
                                            \*out*\  vListaRecalc.rMercadoria,
                                            \*out*\  vListaRecalc.rFatorRateio,
                                            \*out*\  vListaRecalc.rPesoCobradC,
                                            \*out*\  vListaRecalc.rPesoFaixa,
                                            \*out*\  vListaRecalc.rCodCli,
                                            \*out*\  vListaRecalc.rMensagem);
*/    vAuxiliar := vAuxiliar + 1;
    exit when nvl(vListaRecalc.rFreteEmpresa,0) > 0;
 end loop;

      vListaRecalc.rMensagem := vListaRecalc.rMensagem;
      return vListaRecalc.rCodCli       ||';'|| 
          
         vListaRecalc.rLotacao      ||';'|| 
             vListaRecalc.rPeso         ||';'|| 
             vListaRecalc.rFatorRateio  ||';'|| 
             vListaRecalc.rFreteEmpresa ||';'|| 
             vListaRecalc.rDesinenciaFr ||';'|| 
             vListaRecalc.rTpCarga      ||';'|| 
             vListaRecalc.rTabSolCodigo ||';'|| 
             vListaRecalc.rTabSolSaque  ||';'|| 
             vListaRecalc.rFormularioQ  ||';'|| 
             vListaRecalc.rFormularioE  ||';'|| 
             '';
  End fn_testacarga;    


  Procedure SP_LIBERACARREG
  As
    vAuxiliar number;
  Begin

     for c_msg in (  select cs.glb_procssodet_id CodId,
                            cs.glb_processo_codigo processo,
                            cs.arm_armazem_codigo arm,
                            cs.arm_carregamento_codigo carreg,
                            s.glb_status_descricao status,
                            cs.arm_carregstatus_dtreg dtreg,
                            sysdate horaatual,
                            (select max(lg.con_loggeracao_dtgeracao)
                             from tdvadm.t_con_loggeracao lg
                             where lg.arm_carregamento_codigo = cs.arm_carregamento_codigo) DTLOG,
                            to_number(tdvadm.FN_CALCULA_TEMPODECORRIDO((select max(lg.con_loggeracao_dtgeracao)
                                                                        from tdvadm.t_con_loggeracao lg
                                                                        where lg.arm_carregamento_codigo = cs.arm_carregamento_codigo),
                                                                        sysdate,'M')) tempo,
                            (select count(*)
                             from tdvadm.t_con_loggeracao lg
                             where lg.arm_carregamento_codigo = cs.arm_carregamento_codigo) QTDELOG,
                            (select count(*)
                             from tdvadm.t_arm_carregamentodet cd
                             where cd.arm_carregamento_codigo = cs.arm_carregamento_codigo) qtdenota
                     from tdvadm.t_arm_carregstatus cs,
                          tdvadm.t_glb_processodet det,
                          tdvadm.t_glb_status s
                     where cs.glb_processo_codigo = det.glb_processo_codigo
                       and cs.glb_procssodet_id = det.glb_processodet_id
                       and cs.glb_processo_codigo = '005'   
                       and det.glb_status_codigo = s.glb_status_codigo
                       and nvl(s.glb_status_flagfinal,'N') <> 'S'
                     order by cs.arm_carregstatus_dtreg)
      Loop
       
         If c_msg.tempo > 10 Then
            -- Muda o processo para 21 CARREG LIBERADO PELO SISTEMA
            tdvadm.sp_con_voltacarreg(c_msg.carreg);
            select count(*)
              into vAuxiliar
            from tdvadm.t_con_conhecimento c
            where c.arm_carregamento_codigo = c_msg.carreg
              and c.con_conhecimento_serie = 'XXX';
              
            If vAuxiliar = 0 Then   
               update tdvadm.t_arm_carregstatus cs
                  set cs.glb_status_codigoproc = 21
               where cs.glb_procssodet_id = c_msg.codid;
               update tdvadm.t_glb_processodet det
                 set det.glb_status_codigo = 21
               where det.glb_processo_codigo = c_msg.processo
                 and det.glb_processodet_id = c_msg.codid;
            End If;
            commit;
         End If;   
               
          
        
      End Loop;


    
  End SP_LIBERACARREG;

  Procedure sp_Partilha(pCte   in tdvadm.t_con_conhecimento.con_conhecimento_codigo%type,
                        pSerie in tdvadm.t_con_conhecimento.con_conhecimento_serie%type,
                        pRota  in tdvadm.t_con_conhecimento.glb_rota_codigo%type,
                        pStatus out char,
                        pMessage out varchar2)
  As
   vI_BSCLICMS number; -- Base de Calculo do ICMS
   vI_VLICMS   number; -- ICMS recolhido
   vS_ALICMS   number; -- Aliquota interestadual da viagem
   vS_ALINTUFF number; -- Aliquota interna do estado de Destino
   vS_BSPAICMS number; -- Base do Icms para a Partilha
   vS_PERUFINI number; -- 20% Aliquota da Partilha UF Origem
   vS_PARUFINI number; -- Valor da Partilha UF Origem
   vS_PERUFFIM number; -- 80% Aliquota da Partilha UF Destino
   vS_PARUFFIM number; -- Valor da Partilha UF Fim
   vS_PERPROB  number; -- Percentual da Pobreza por estado
   vS_PARPROB  number; -- Valor da Partilha da Pobreza
   vCalcula    char(1); -- Se Calcula a Partilha
   vUFINI      tdvadm.t_glb_estado.glb_estado_codigo%type;
   vUFFIM      tdvadm.t_glb_estado.glb_estado_codigo%type;
   vDest       tdvadm.t_con_conhecimento.glb_cliente_cgccpfdestinatario%type; 
   vIsncricao  tdvadm.t_glb_cliend.glb_cliend_ie%type;
   vTpCalc     tdvadm.t_con_calcconhecimento%rowtype;
   vAuxiliar   number;
   vNaoContrib tdvadm.t_glb_cliente.glb_cliente_naocont%type;
  Begin

   If to_char(sysdate,'YYYY') = '2018' Then
      vS_PERUFINI := 20;
      vS_PERUFFIM := 80;
   Else
      vS_PERUFINI := 0;
      vS_PERUFFIM := 100;
   End If;
   
   Begin
       Select lo.glb_estado_codigo,
              ld.glb_estado_codigo,
              c.glb_cliente_cgccpfdestinatario,
              ce.glb_cliend_ie,
              nvl(cl.glb_cliente_naocont,'N')
         into vUFINI,
              vUFFIM,
              vDest,
              vIsncricao,
              vNaoContrib
       from tdvadm.t_con_conhecimento c,
            tdvadm.t_glb_localidade lo,
            tdvadm.t_glb_localidade ld,
            tdvadm.t_glb_cliend ce,
            tdvadm.t_glb_cliente cld,
            tdvadm.t_glb_cliente cl
       where c.con_conhecimento_codigo = pCte
         and c.con_conhecimento_serie = pSerie
         and c.glb_rota_codigo = pRota
         and c.con_conhecimento_localcoleta = lo.glb_localidade_codigo
         and c.con_conhecimento_localentrega = ld.glb_localidade_codigo
         and c.glb_cliente_cgccpfdestinatario = ce.glb_cliente_cgccpfcodigo
         and c.glb_tpcliend_codigodestinatari = ce.glb_tpcliend_codigo
         and c.glb_cliente_cgccpfdestinatario = cld.glb_cliente_cgccpfcodigo
         and c.glb_cliente_cgccpfsacado = cl.glb_cliente_cgccpfcodigo
         and (( cl.glb_grupoeconomico_codigo = '0642' ) or (instr(tdvadm.pkg_slf_calculos.vListaCNPJDIFAL,trim(c.glb_cliente_cgccpfsacado)) > 0));
   Exception
     When NO_DATA_FOUND Then
        pMessage := '';
        pStatus := 'N';
        Return;
     When OTHERS Then
        pMessage := 'Problemas na Busca de Dados do CTe - erro ' || sqlerrm;
        pStatus := 'E';
        Return;
     End;     
     
   vCalcula := 'N';  
--   If nvl(vIsncricao,'ISENTO') = rpad('ISENTO',20) Then
   If vNaoContrib = 'S' Then
      vCalcula := 'S';
   Else
       select count(*) 
         into vAuxiliar
       from tdvadm.t_glb_cliente cl
       where cl.glb_cliente_cgccpfcodigo = vDest
         and nvl(cl.glb_cliente_naocont,'N') = 'S';
       If vAuxiliar <> 0 Then
          vCalcula := 'S';
       Else
           select count(*) 
             into vAuxiliar
           from tdvadm.t_glb_cliente cl
           where cl.glb_cliente_cgccpfcodigo = vDest
             and nvl(cl.glb_cliente_optsimples,'N') = 'S';
           If vAuxiliar <> 0 Then
              vCalcula := 'S';
           End If;           
       End If;
   End If;
   
   
   -- Pega um modelo e a Base do Cte
   Select *
     into vTpCalc
   from tdvadm.t_con_calcconhecimento ca
   where ca.con_conhecimento_codigo = pCte
     and ca.con_conhecimento_serie = pSerie
     and ca.glb_rota_codigo = pRota
     and ca.slf_reccust_codigo = 'I_BSCLICMS';

   If ( vCalcula = 'S' and vTpCalc.Con_Calcviagem_Valor <> 0 ) Then
   
   select ca.con_calcviagem_valor
     into vI_VLICMS
   from tdvadm.t_con_calcconhecimento ca
   where ca.con_conhecimento_codigo = pCte
     and ca.con_conhecimento_serie = pSerie
     and ca.glb_rota_codigo = pRota
     and ca.slf_reccust_codigo = 'I_VLICMS';
   
   
   Select i.slf_icms_aliquota
     into vS_ALINTUFF 
   From tdvadm.t_slf_icms i
   where i.glb_estado_codigoorigem = vUFFIM
     and i.glb_estado_codigodestino = vUFFIM
     and i.slf_icms_dataefetiva = (select max(i1.slf_icms_dataefetiva)
                                    from tdvadm.t_slf_icms i1
                                    where i1.glb_estado_codigoorigem = i.glb_estado_codigoorigem
                                      and i1.glb_estado_codigodestino = i.glb_estado_codigodestino);

   Select i.slf_icms_aliquota
     into vS_ALICMS 
   From tdvadm.t_slf_icms i
   where i.glb_estado_codigoorigem = vUFINI
     and i.glb_estado_codigodestino = vUFFIM
     and i.slf_icms_dataefetiva = (select max(i1.slf_icms_dataefetiva)
                                    from tdvadm.t_slf_icms i1
                                    where i1.glb_estado_codigoorigem = i.glb_estado_codigoorigem
                                      and i1.glb_estado_codigodestino = i.glb_estado_codigodestino);


   Select nvl(e.glb_estado_perctpobreza,0)
     into vS_PERPROB
   from tdvadm.t_glb_estado e
   where e.glb_estado_codigo = vUFFIM;
  
   
   vI_BSCLICMS := vTpCalc.Con_Calcviagem_Valor;
     
   vS_BSPAICMS := vTpCalc.Con_Calcviagem_Valor;   --vI_VLICMS - round(vI_BSCLICMS * ( vS_ALINTUFF / 100),2) ;
   vS_PARUFINI := round(vS_BSPAICMS * ( vS_PERUFINI / 100),2);
   vS_PARUFFIM := round(vS_BSPAICMS * ( abs( vS_ALINTUFF - vS_ALICMS - vS_PERPROB ) / 100),2); -- round(vS_BSPAICMS * ( vS_PERUFFIM / 100),2);
   vS_PARPROB  := round(vI_BSCLICMS * ( vS_PERPROB  / 100),2);
   vS_ALINTUFF := vS_ALINTUFF -  vS_PERPROB;

   Else
       vI_BSCLICMS := 0;
       vS_ALICMS   := 0;
       vS_ALINTUFF := 0;
       vS_BSPAICMS := 0;
       vS_PERUFINI := 0;
       vS_PARUFINI := 0;
       vS_PERUFFIM := 0;
       vS_PARUFFIM := 0;
       vS_PERPROB  := 0;
       vS_PARPROB  := 0;
   End If;


   -- Aliquota interna do estado de Destino
   select count(*)
     into vAuxiliar
   from tdvadm.t_con_calcconhecimento ca 
   where ca.con_conhecimento_codigo = pCte
     and ca.con_conhecimento_serie = pSerie
     and ca.glb_rota_codigo = pRota
     and ca.slf_reccust_codigo = 'S_ALINTUFF';
 
    
   If vAuxiliar <> 0 Then
      update tdvadm.t_con_calcconhecimento ca 
        set ca.con_calcviagem_valor = vS_ALINTUFF
      where ca.con_conhecimento_codigo = pCte
        and ca.con_conhecimento_serie = pSerie
        and ca.glb_rota_codigo = pRota
        and ca.slf_reccust_codigo = 'S_ALINTUFF';
   Else
      
      vTpCalc.Slf_Reccust_Codigo := 'S_ALINTUFF';
      vTpCalc.Con_Calcviagem_Valor := vS_ALINTUFF;
      vTpCalc.Con_Calcviagem_Desinencia := '%';
      insert into tdvadm.t_con_calcconhecimento values vTpCalc;
   End If;

 -- Base do Icms para a Partilha
   select count(*)
     into vAuxiliar
   from tdvadm.t_con_calcconhecimento ca 
   where ca.con_conhecimento_codigo = pCte
     and ca.con_conhecimento_serie = pSerie
     and ca.glb_rota_codigo = pRota
     and ca.slf_reccust_codigo = 'S_BSPAICMS';
 
    
   If vAuxiliar <> 0 Then
      update tdvadm.t_con_calcconhecimento ca 
        set ca.con_calcviagem_valor = vS_BSPAICMS
      where ca.con_conhecimento_codigo = pCte
        and ca.con_conhecimento_serie = pSerie
        and ca.glb_rota_codigo = pRota
        and ca.slf_reccust_codigo = 'S_BSPAICMS';
   Else
      vTpCalc.Slf_Reccust_Codigo := 'S_BSPAICMS';
      vTpCalc.Con_Calcviagem_Valor := vS_BSPAICMS;
      vTpCalc.Con_Calcviagem_Desinencia := 'VL';
      insert into tdvadm.t_con_calcconhecimento values vTpCalc;
   End If;



 -- 20% Aliquota da Partilha UF Origem
   select count(*)
     into vAuxiliar
   from tdvadm.t_con_calcconhecimento ca 
   where ca.con_conhecimento_codigo = pCte
     and ca.con_conhecimento_serie = pSerie
     and ca.glb_rota_codigo = pRota
     and ca.slf_reccust_codigo = 'S_PERUFINI';
 
    
   If vAuxiliar <> 0 Then
      update tdvadm.t_con_calcconhecimento ca 
        set ca.con_calcviagem_valor = vS_PERUFINI
      where ca.con_conhecimento_codigo = pCte
        and ca.con_conhecimento_serie = pSerie
        and ca.glb_rota_codigo = pRota
        and ca.slf_reccust_codigo = 'S_PERUFINI';
   Else
      vTpCalc.Slf_Reccust_Codigo := 'S_PERUFINI';
      vTpCalc.Con_Calcviagem_Valor := vS_PERUFINI;
      vTpCalc.Con_Calcviagem_Desinencia := '%';
      insert into tdvadm.t_con_calcconhecimento values vTpCalc;
   End If;

 -- Valor da Partilha UF Origem
   select count(*)
     into vAuxiliar
   from tdvadm.t_con_calcconhecimento ca 
   where ca.con_conhecimento_codigo = pCte
     and ca.con_conhecimento_serie = pSerie
     and ca.glb_rota_codigo = pRota
     and ca.slf_reccust_codigo = 'S_PARUFINI';
 
    
   If vAuxiliar <> 0 Then
      update tdvadm.t_con_calcconhecimento ca 
        set ca.con_calcviagem_valor = vS_PARUFINI
      where ca.con_conhecimento_codigo = pCte
        and ca.con_conhecimento_serie = pSerie
        and ca.glb_rota_codigo = pRota
        and ca.slf_reccust_codigo = 'S_PARUFINI';
   Else
      vTpCalc.Slf_Reccust_Codigo := 'S_PARUFINI';
      vTpCalc.Con_Calcviagem_Valor := vS_PARUFINI;
      vTpCalc.Con_Calcviagem_Desinencia := 'VL';
      insert into tdvadm.t_con_calcconhecimento values vTpCalc;
   End If;

 -- 80% Aliquota da Partilha UF Destino
   select count(*)
     into vAuxiliar
   from tdvadm.t_con_calcconhecimento ca 
   where ca.con_conhecimento_codigo = pCte
     and ca.con_conhecimento_serie = pSerie
     and ca.glb_rota_codigo = pRota
     and ca.slf_reccust_codigo = 'S_PERUFFIM';
 
    
   If vAuxiliar <> 0 Then
      update tdvadm.t_con_calcconhecimento ca 
        set ca.con_calcviagem_valor = vS_PERUFFIM
      where ca.con_conhecimento_codigo = pCte
        and ca.con_conhecimento_serie = pSerie
        and ca.glb_rota_codigo = pRota
        and ca.slf_reccust_codigo = 'S_PERUFFIM';
   Else
      vTpCalc.Slf_Reccust_Codigo := 'S_PERUFFIM';
      vTpCalc.Con_Calcviagem_Valor := vS_PERUFFIM;
      vTpCalc.Con_Calcviagem_Desinencia := '%';
      insert into tdvadm.t_con_calcconhecimento values vTpCalc;
   End If;

 -- Valor da Partilha UF Fim
   select count(*)
     into vAuxiliar
   from tdvadm.t_con_calcconhecimento ca 
   where ca.con_conhecimento_codigo = pCte
     and ca.con_conhecimento_serie = pSerie
     and ca.glb_rota_codigo = pRota
     and ca.slf_reccust_codigo = 'S_PARUFFIM';
 
    
   If vAuxiliar <> 0 Then
      update tdvadm.t_con_calcconhecimento ca 
        set ca.con_calcviagem_valor = vS_PARUFFIM
      where ca.con_conhecimento_codigo = pCte
        and ca.con_conhecimento_serie = pSerie
        and ca.glb_rota_codigo = pRota
        and ca.slf_reccust_codigo = 'S_PARUFFIM';
   Else
      vTpCalc.Slf_Reccust_Codigo := 'S_PARUFFIM';
      vTpCalc.Con_Calcviagem_Valor := vS_PARUFFIM;
      vTpCalc.Con_Calcviagem_Desinencia := 'VL';
      insert into tdvadm.t_con_calcconhecimento values vTpCalc;
   End If;

  -- Percentual da Pobreza por estado
   select count(*)
     into vAuxiliar
   from tdvadm.t_con_calcconhecimento ca 
   where ca.con_conhecimento_codigo = pCte
     and ca.con_conhecimento_serie = pSerie
     and ca.glb_rota_codigo = pRota
     and ca.slf_reccust_codigo = 'S_PERPROB';
 
    
   If vAuxiliar <> 0 Then
      update tdvadm.t_con_calcconhecimento ca 
        set ca.con_calcviagem_valor = vS_PERPROB
      where ca.con_conhecimento_codigo = pCte
        and ca.con_conhecimento_serie = pSerie
        and ca.glb_rota_codigo = pRota
        and ca.slf_reccust_codigo = 'S_PERPROB';
   Else
      vTpCalc.Slf_Reccust_Codigo := 'S_PERPROB';
      vTpCalc.Con_Calcviagem_Valor := vS_PERPROB;
      vTpCalc.Con_Calcviagem_Desinencia := '%';
      insert into tdvadm.t_con_calcconhecimento values vTpCalc;
   End If;

  -- Valor da Partilha da Pobreza
   select count(*)
     into vAuxiliar
   from tdvadm.t_con_calcconhecimento ca 
   where ca.con_conhecimento_codigo = pCte
     and ca.con_conhecimento_serie = pSerie
     and ca.glb_rota_codigo = pRota
     and ca.slf_reccust_codigo = 'S_PARPROB';
 
    
   If vAuxiliar <> 0 Then
      update tdvadm.t_con_calcconhecimento ca 
        set ca.con_calcviagem_valor = vS_PARPROB
      where ca.con_conhecimento_codigo = pCte
        and ca.con_conhecimento_serie = pSerie
        and ca.glb_rota_codigo = pRota
        and ca.slf_reccust_codigo = 'S_PARPROB';
   Else
      vTpCalc.Slf_Reccust_Codigo := 'S_PARPROB';
      vTpCalc.Con_Calcviagem_Valor := vS_PARPROB;
      vTpCalc.Con_Calcviagem_Desinencia := 'VL';
      insert into tdvadm.t_con_calcconhecimento values vTpCalc;
   End If;
   Commit;

  End sp_Partilha;                        



/*
SELECT CC.FCF_TPCARGA_CODIGO             ccTPCARGACLI,       
       TC.fcf_tpcargadescricao           ccTPCARGACLIDESC,   
       CC.FCF_TPCARGA_CODIGOPESQ         ccTPCARGACLIPESQ,  
       CC.SLF_CLIENTECARGAS_AGCTRC       ccTPCARGAAGRUPACTRC,
       CC.SLF_CLIENTECARGAS_QTDECTRC     ccTPCARGAQTDEAGCTRC,
       CC.SLF_CLIENTECARGAS_AGNF         ccTPCARGAAGRUPANF,  
       CC.SLF_CLIENTECARGAS_QTDENF       ccTPCARGAQTDEAGNF,  
       CC.SLF_CLIENTECARGAS_PCOBRANCA    ccPCOBRANCA,        
       CC.SLF_CLIENTECARGAS_BASEOCUPACAO ccBASEOCUPACAO,     
       CC.SLF_CLIENTECARGAS_VALORBASE    ccVALORBASE,        
       CC.SLF_CLIENTECARGAS_PMINIMO      ccPESOMINIMO,       
       CC.SLF_CLIENTECARGAS_PROCEDURE    ccPROCEDURE,        
       CC.SLF_CLIENTECARGAS_RATEIA       ccRATEIA,           
       CC.SLF_TPRATEIO_CODIGO            ccTPRATEIO,         
       CC.SLF_CLIENTECARGAS_QPCOLCTRC    ccTPCARGAQPCOLCTRC, 
       CC.SLF_CLIENTECARGAS_QPCOLNF      ccTPCARGAQPCOLNF,   
       CC.SLF_CLIENTECARGAS_PRIOREXQM    ccPRIOREXQM,        
       CC.SLF_CLIENTECARGAS_PERCNTEX     ccPERCTEX,          
       CC.SLF_CLIENTECARGAS_PERCNTQM     ccPRECQM,           
       CC.SLF_CLIENTECARGAS_PERCNTOUT    ccPERCOUT,          
       CC.SLF_CLIENTECARGAS_PERCNTTRA    ccPERCTRA,          
       CC.SLF_CLIENTECARGAS_REDUTOR      ccPERCTREDUTOR,     
       CC.SLF_CLIENTECARGAS_FORMULAFRTX  ccFORMULAFRTX,      
       CC.SLF_CLIENTECARGAS_FORMULAFRTVL ccFORMULAFRVL,      
       CC.SLF_CLIENTECARGAS_FORMULAFRTKM ccFORMULAFRKM,      
       CC.SLF_CLIENTECARGAS_FORMULAPDTX  ccFORMULAPDTX,      
       CC.SLF_CLIENTECARGAS_FORMULAPDVL  ccFORMULAPDVL,      
       CC.SLF_TPFRETE_CODIGO             ccTPFRETE,          
       CC.SLF_CLIENTECARGAS_FIXAORIGEM   ccORIGEMFIXA,      
       CC.SLF_CLIENTECARGAS_FIXADESTINO  ccDESTINOFIXO,      
       CC.SLF_CLIENTECARGAS_FORMULARIOQM ccEXIGEFORMQM,      
       CC.SLF_CLIENTECARGAS_FORMULARIOEX ccEXIGEFORMEX,      
       TC.FCF_TPCARGA_CODIGO             ccTPCARGA,          
       TF.SLF_TPFRETE_DESCRICAO          ccTPCARGADESC,      
       TF.SLF_TPFRETE_TPCODORIGEM        ccTPCODORIGEM,     
       TF.SLF_TPFRETE_TPCODDESTINO       ccTPCODDESTINO,     
       CC.SLF_CLIENTECARGAS_USAFAIXAKM   ccUSAFAIXAKM,       
       CC.SLF_CLIENTECARGAS_USAFAIXAPESO ccUSAFAIXAPS,       
       CC.SLF_CLIENTECARGAS_USAFAIXAVG   ccUSAFAIXAVG,       
       TF.SLF_TPFRETE_TPUSAVEICULO       ccUSAVEICULO,       
       TF.SLF_TPFRETE_OBS                ccTPFRETEOBS       
FROM TDVADM.T_SLF_CLIENTECARGAS CC,
     TDVADM.T_FCF_TPCARGA TC,
     TDVADM.T_SLF_TPFRETE TF
WHERE 0 = 0
  AND CC.GLB_GRUPOECONOMICO_CODIGO  = '0074' 
  AND    = QualquerCliente
  AND CC.SLF_CONTRATO_CODIGO        = '72061'
  AND CC.SLF_CONTRATO_ATIVO         = 'S'
  AND CC.SLF_CLIENTECARGAS_VIGENCIA = (SELECT MAX(CC1.SLF_CLIENTECARGAS_VIGENCIA)
                                       FROM TDVADM.T_SLF_CLIENTECARGAS CC1
                                       WHERE CC1.GLB_GRUPOECONOMICO_CODIGO = CC.GLB_GRUPOECONOMICO_CODIGO 
                                         AND CC1.GLB_CLIENTE_CGCCPFCODIGO  =  
                                         AND CC1.SLF_CONTRATO_CODIGO       = CC.SLF_CONTRATO_CODIGO 
                                         AND CC1.FCF_TPCARGA_CODIGO        = CC.FCF_TPCARGA_CODIGO
                                         AND CC1.SLF_CONTRATO_ATIVO        = 'S')
  AND CC.FCF_TPCARGA_CODIGO = TC.FCF_TPCARGA_CODIGO
  AND CC.SLF_TPFRETE_CODIGO = TF.SLF_TPFRETE_CODIGO
ORDER BY CC.SLF_CLIENTECARGAS_SEQEXEC

-- tabela de Grande fluxo
INSERT INTO T_XML_CLIENTELIB
SELECT CL.GLB_CLIENTE_CGCCPFCODIGO,
       '17/11/2014',
       CL.XML_CLIENTELIB_ATIVO,
       CL.XML_CLIENTELIB_FLAGPORTO,
       CL.XML_CLIENTELIB_FLAGGF,
       CL.USU_USUARIO_CODIGO,
       CL.XML_CLIENTELIB_FLAGAEROPORTO,
       CL.GLB_LOCALIDADE_CODIGOORI,
       CL.GLB_LOCALIDADE_CODIGODES,
       CL.XML_CLIENTELIB_TPCODORI,
       CL.XML_CLIENTELIB_TPCODDES,
       CL.XML_CLIENTELIB_DESCORIG,
       CL.XML_CLIENTELIB_DESCDEST,
       CL.XML_CLIENTELIB_DESCCLI,
       '11' FCF_TPCARGA_CODIGO
FROM T_TMP_CLIENTELIB CL
UNION
SELECT CL.GLB_CLIENTE_CGCCPFCODIGO,
       '17/11/2014',
       CL.XML_CLIENTELIB_ATIVO,
       CL.XML_CLIENTELIB_FLAGPORTO,
       CL.XML_CLIENTELIB_FLAGGF,
       CL.USU_USUARIO_CODIGO,
       CL.XML_CLIENTELIB_FLAGAEROPORTO,
       CL.GLB_LOCALIDADE_CODIGOORI,
       CL.GLB_LOCALIDADE_CODIGODES,
       CL.XML_CLIENTELIB_TPCODORI,
       CL.XML_CLIENTELIB_TPCODDES,
       CL.XML_CLIENTELIB_DESCORIG,
       CL.XML_CLIENTELIB_DESCDEST,
       CL.XML_CLIENTELIB_DESCCLI,
       '12' FCF_TPCARGA_CODIGO
FROM T_TMP_CLIENTELIB CL
WHERE CL.XML_CLIENTELIB_TPCARGA = 'A';

SELECT * FROM T_XML_CLIENTELIB L
--update T_XML_CLIENTELIB L
--  set l.xml_clientelib_ativo = 'N'
WHERE L.XML_CLIENTELIB_DTVIGENCIA = (SELECT MAX(L1.XML_CLIENTELIB_DTVIGENCIA)
                                     FROM T_XML_CLIENTELIB L1
                                     WHERE L1.GLB_CLIENTE_CGCCPFCODIGO = L.GLB_CLIENTE_CGCCPFCODIGO
                                       and l1.xml_clientelib_ativo = 'S'
                                       AND L1.GLB_LOCALIDADE_CODIGOORI = L.GLB_LOCALIDADE_CODIGOORI
                                       AND L1.GLB_LOCALIDADE_CODIGODES = L.GLB_LOCALIDADE_CODIGODES
                                       AND L1.FCF_TPCARGA_CODIGO       = L.FCF_TPCARGA_CODIGO)
  and l.xml_clientelib_ativo = 'S'
  AND  L.XML_CLIENTELIB_DTVIGENCIA <>  '17/11/2014';
  



*/



END PKG_FIFO_CARREGCTRC;
/
